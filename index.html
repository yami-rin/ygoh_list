<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>カード管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; }
        [data-bs-theme="dark"] body { background-color: #212529; }
        .container-fluid { max-width: 1400px; }
        .card { margin-bottom: 1.5rem; }
        .table-responsive { max-height: 500px; }
        #loading-overlay, #app-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1060;
            color: white;
        }
        .set-choice-btn { cursor: pointer; }
        #main-app { display: none; } /* Hide app until logged in */
    </style>
</head>
<body>
    <!-- Full screen loader -->
    <div id="app-loader">
        <div class="spinner-border" style="width: 3rem; height: 3rem;" role="status"><span class="visually-hidden">Loading...</span></div>
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="auth-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">ログインまたは新規登録</h5></div>
            <div class="modal-body">
                <div id="auth-error" class="alert alert-danger" style="display: none;"></div>
                <form id="auth-form">
                    <div class="mb-3"><label for="email" class="form-label">メールアドレス</label><input type="email" class="form-control" id="email" required></div>
                    <div class="mb-3"><label for="password" class="form-label">パスワード</label><input type="password" class="form-control" id="password" required></div>
                    <div class="d-grid gap-2">
                        <button type="button" id="login-btn" class="btn btn-primary">ログイン</button>
                        <button type="button" id="signup-btn" class="btn btn-secondary">新規登録</button>
                    </div>
                </form>
            </div>
        </div></div>
    </div>

    <!-- Edit Card Modal -->
    <div class="modal fade" id="edit-card-modal" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">カード情報の編集</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="edit-form">
                    <input type="hidden" id="edit-card-id">
                    <div class="mb-3"><label class="form-label">名前</label><input type="text" id="edit-name" class="form-control" readonly disabled></div>
                    <div class="mb-3"><label class="form-label">型番</label><input type="text" id="edit-set-code" class="form-control" readonly disabled></div>
                    <div class="mb-3"><label class="form-label">レアリティ</label><input type="text" id="edit-rarity" class="form-control" readonly disabled></div>
                    <div class="mb-3"><label for="edit-quantity" class="form-label">枚数</label><input type="number" id="edit-quantity" class="form-control" min="1" required></div>
                    <div class="mb-3">
                        <label class="form-label">タグ</label>
                        <div id="edit-card-tags-container" class="mb-2"></div>
                        <div id="edit-tag-choices-container"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" id="save-edit-btn" class="btn btn-primary">変更を保存</button>
            </div>
        </div></div>
    </div>

    <!-- How to Use Modal -->
    <div class="modal fade" id="how-to-use-modal" tabindex="-1">
        <div class="modal-dialog modal-lg"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">使い方ガイド</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <h6><i class="bi bi-person-plus"></i> アカウント</h6>
                <p>最初にメールアドレスとパスワードで新規登録します。登録したアカウントでログインすると、あなたのカードデータがクラウドに保存され、どの端末からでもアクセスできます。</p>
                <h6><i class="bi bi-search"></i> カードのURL読込</h6>
                <p>データベースのカードページのURLをコピーし、入力欄に貼り付けて「読込」ボタンを押すと、カード名や型番、レアリティの候補が自動で入力されます。</p>
                <h6><i class="bi bi-card-list"></i> カードの登録と管理</h6>
                <p>読み込んだ情報や手入力した情報を確認し、「カードを追加」ボタンでコレクションに登録します。一覧の「編集」ボタンで枚数や備考を、「削除」ボタンでカードそのものを削除できます。</p>
                <h6><i class="bi bi-files"></i> データのインポート・エクスポート</h6>
                <p>「データ管理」メニューから、コレクション全体のバックアップをJSON形式やCSV形式（Excelで表示可能）でダウンロードできます。また、JSON/CSVファイルからデータを一括でインポートすることも可能です。</p>
                <h6><i class="bi bi-gear"></i> 設定</h6>
                <p>「設定」メニューから、画面の見た目をダークモードに切り替えることができます。また、アカウントが不要になった場合は、ここからアカウントと全てのカードデータを完全に削除することができます。この操作は元に戻せないのでご注意ください。</p>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button></div>
        </div></div>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settings-modal" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">設定</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="dark-mode-toggle">
                    <label class="form-check-label" for="dark-mode-toggle">ダークモード</label>
                </div>
                <hr>
                <h6>アカウント削除</h6>
                <p class="text-muted small">この操作は元に戻せません。アカウントに紐づく全てのカードデータが完全に削除されます。</p>
                <button class="btn btn-danger" id="delete-account-btn">アカウントを削除する</button>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button></div>
        </div></div>
    </div>

    <!-- Tag Management Modal -->
    <div class="modal fade" id="tag-management-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">タグ管理</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>新しいタグを追加</h6>
                    <form id="add-tag-form" class="input-group mb-3">
                        <input type="text" id="new-tag-name" class="form-control" placeholder="新しいタグ名（カンマ区切りで複数入力可）" required>
                        <button class="btn btn-primary" type="submit">追加</button>
                    </form>
                    <hr>
                    <h6>登録済みタグ一覧</h6>
                    <div id="existing-tags-list"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app">
        <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4" data-bs-theme="light">
            <div class="container-fluid">
                <span class="navbar-brand"><i class="bi bi-layers-fill"></i> カード管理</span>
                <div class="d-flex align-items-center">
                    <button class="btn btn-outline-info me-2" id="how-to-use-btn"><i class="bi bi-question-circle"></i> 使い方</button>
                    <div class="dropdown me-2">
                        <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"><i class="bi bi-database"></i> データ管理</button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><button class="dropdown-item" id="import-json-btn">JSONからインポート</button></li>
                            <li><button class="dropdown-item" id="import-csv-btn">CSVからインポート</button></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><button class="dropdown-item" id="export-json-btn">JSON形式でエクスポート</button></li>
                            <li><button class="dropdown-item" id="export-csv-btn">CSV形式でエクスポート</button></li>
                        </ul>
                        <input type="file" id="import-file-input" accept=".json,.csv" style="display: none;">
                    </div>
                    <button class="btn btn-outline-secondary me-2" id="tag-management-btn"><i class="bi bi-tags"></i> タグ管理</button>
                    <button class="btn btn-outline-secondary me-3" id="settings-btn"><i class="bi bi-gear"></i> 設定</button>
                    <span class="navbar-text me-3" id="user-email"></span>
                    <button id="logout-btn" class="btn btn-danger"><i class="bi bi-box-arrow-right"></i> ログアウト</button>
                </div>
            </div>
        </nav>

        <div class="container-fluid">
             <div id="loading-overlay" style="display: none;"><div class="spinner-border" role="status"></div></div>
            <div class="row">
                <!-- Left Column: Add Card -->
                <div class="col-lg-5">
                    <div class="card">
                        <div class="card-header">カード登録</div>
                        <div class="card-body">
                            <form id="add-form">
                                <div class="mb-3">
                                    <label for="url" class="form-label">公式DB URL</label>
                                    <div class="input-group">
                                        <input type="url" class="form-control" id="url" placeholder="URLをペースト (Ctrl+V)...">
                                        <button class="btn btn-primary" type="button" id="fetch-btn">読込</button>
                                    </div>
                                </div>
                                <div class="mb-3"><label for="name" class="form-label">名前</label><input type="text" class="form-control" id="name" name="name" required></div>
                                <div class="mb-3">
                                    <label for="set_code" class="form-label">型番</label>
                                    <input type="text" class="form-control" id="set_code" name="set_code" required>
                                    <div id="set-rarity-choices" class="mt-2"></div>
                                </div>
                                <div class="mb-3"><label for="rarity" class="form-label">レアリティ</label><input type="text" class="form-control" id="rarity" name="rarity"></div>
                                <div class="mb-3"><label for="quantity" class="form-label">枚数</label><input type="number" class="form-control" id="quantity" name="quantity" value="1" min="1" required></div>
                                <div class="mb-3">
                                    <label class="form-label">登録先</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="add-type" id="add-to-collection" value="collection" checked>
                                        <label class="btn btn-outline-primary" for="add-to-collection">所持カード</label>
                                        <input type="radio" class="btn-check" name="add-type" id="add-to-wishlist" value="wishlist">
                                        <label class="btn btn-outline-warning" for="add-to-wishlist">ウィッシュリスト</label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">タグ</label>
                                    <div id="card-tags-container" class="mb-2"></div>
                                    <div id="tag-choices-container"></div>
                                </div>
                                <button type="submit" class="btn btn-success w-100">カードを追加</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Search and List -->
                <div class="col-lg-7">
                    <div class="card">
                        <div class="card-header">
                            <ul class="nav nav-tabs card-header-tabs">
                                <li class="nav-item">
                                    <a class="nav-link active" id="collection-tab" data-list-type="collection" href="#">所持カード (<span id="total-collection">0</span>)</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="wishlist-tab" data-list-type="wishlist" href="#">ウィッシュリスト (<span id="total-wishlist">0</span>)</a>
                                </li>
                            </ul>
                        </div>
                        <div class="card-body">
                            <form id="search-form" class="row g-3 mb-4">
                                <div class="col-md-6"><input type="text" name="search_name" class="form-control" placeholder="名前..."></div>
                                <div class="col-md-6"><input type="text" name="search_set_code" class="form-control" placeholder="型番..."></div>
                                <div class="col-md-6"><input type="text" name="search_rarity" class="form-control" placeholder="レアリティ..."></div>
                                <div class="col-md-6"><input type="text" name="search_tags" class="form-control" placeholder="タグ..."></div>
                                <div class="col-12 d-grid"><button type="submit" class="btn btn-info">検索</button></div>
                            </form>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="input-group w-auto">
                                    <label class="input-group-text" for="items-per-page">表示件数</label>
                                    <select class="form-select" id="items-per-page">
                                        <option value="10">10</option>
                                        <option value="20">20</option>
                                        <option value="50" selected>50</option>
                                        <option value="100">100</option>
                                    </select>
                                </div>
                                <div id="pagination-controls"></div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th scope="col" data-sort="名前" class="sortable">名前 <i class="bi bi-arrow-down-up"></i></th>
                                            <th scope="col" data-sort="型番" class="sortable">型番 <i class="bi bi-arrow-down-up"></i></th>
                                            <th scope="col" data-sort="レアリティ" class="sortable">レアリティ <i class="bi bi-arrow-down-up"></i></th>
                                            <th scope="col" data-sort="枚数" class="sortable">枚数 <i class="bi bi-arrow-down-up"></i></th>
                                            <th scope="col" data-sort="tags">タグ</th>
                                            <th scope="col">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="card-table-body"></tbody>
                                </table>
                            </div>
                            <div class="d-flex justify-content-center mt-2">
                                <div id="pagination-controls-bottom"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, query, where, updateDoc, increment, writeBatch } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // User's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAOYKalLUb2hbghrjQUS8AWzxpLExBT7aU",
            authDomain: "ygoh-9bcf6.firebaseapp.com",
            projectId: "ygoh-9bcf6",
            storageBucket: "ygoh-9bcf6.firebasestorage.app",
            messagingSenderId: "1058357616781",
            appId: "1:1058357616781:web:f25db127e2824226d942c4",
            measurementId: "G-S4CCJC3HW9"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State ---
        let cardCollection = [];
        let wishlistCollection = [];
        let currentListType = 'collection'; // 'collection' or 'wishlist'
        let currentUser = null;
        let sortConfig = { key: '名前', direction: 'ascending' };
        let currentPage = 1;
        let itemsPerPage = 50;
        let filteredCardCollection = [];
        let allTags = [];
        let currentCardTags = [];

        // --- DOM Elements ---
        const mainApp = document.getElementById('main-app');
        const appLoader = document.getElementById('app-loader');
        const authModal = new bootstrap.Modal(document.getElementById('auth-modal'));
        const editCardModal = new bootstrap.Modal(document.getElementById('edit-card-modal'));
        const howToUseModal = new bootstrap.Modal(document.getElementById('how-to-use-modal'));
        const settingsModal = new bootstrap.Modal(document.getElementById('settings-modal'));
        const tagManagementModal = new bootstrap.Modal(document.getElementById('tag-management-modal'));
        const authError = document.getElementById('auth-error');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailSpan = document.getElementById('user-email');
        const cardTableBody = document.getElementById('card-table-body');
        const totalCollectionSpan = document.getElementById('total-collection');
        const totalWishlistSpan = document.getElementById('total-wishlist');
        const loadingOverlay = document.getElementById('loading-overlay');
        const addForm = document.getElementById('add-form');
        const searchForm = document.getElementById('search-form');
        const importFileInput = document.getElementById('import-file-input');
        const darkModeToggle = document.getElementById('dark-mode-toggle');

        // --- Utility & UI Functions ---
        const showLoading = (show) => { loadingOverlay.style.display = show ? 'flex' : 'none'; };
        
        const getCurrentCollection = () => {
            return currentListType === 'collection' ? cardCollection : wishlistCollection;
        };
        
        const renderTable = () => {
            // 1. ソート
            const currentData = getCurrentCollection();
            filteredCardCollection.sort((a, b) => {
                let valA = a.data[sortConfig.key];
                let valB = b.data[sortConfig.key];

                // 数値と文字列の比較を考慮
                if (sortConfig.key === '枚数') {
                    valA = parseInt(valA, 10) || 0;
                    valB = parseInt(valB, 10) || 0;
                } else {
                    valA = String(valA || '').toLowerCase();
                    valB = String(valB || '').toLowerCase();
                }

                if (valA < valB) return sortConfig.direction === 'ascending' ? -1 : 1;
                if (valA > valB) return sortConfig.direction === 'ascending' ? 1 : -1;
                return 0;
            });

            // 2. ページネーション
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedItems = filteredCardCollection.slice(startIndex, endIndex);

            // 3. テーブル描画
            cardTableBody.innerHTML = '';
            if (paginatedItems.length === 0) {
                cardTableBody.innerHTML = '<tr><td colspan="6" class="text-center">該当するカードはありません。</td></tr>';
            } else {
                paginatedItems.forEach(card => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${card.data['名前'] || ''}</td>
                        <td>${card.data['型番'] || ''}</td>
                        <td>${card.data['レアリティ'] || ''}</td>
                        <td>${card.data['枚数'] || ''}</td>
                        <td>${(card.data.tags || []).join(', ')}</td>
                        <td>
                            <button class="btn btn-primary btn-sm edit-btn" data-id="${card.id}"><i class="bi bi-pencil"></i></button>
                            ${currentListType === 'wishlist' ? `<button class="btn btn-success btn-sm move-to-collection-btn" data-id="${card.id}" title="所持カードへ移動"><i class="bi bi-check-circle"></i></button>` : ''}
                            <button class="btn btn-danger btn-sm delete-btn" data-id="${card.id}"><i class="bi bi-trash"></i></button>
                        </td>
                    `;
                    cardTableBody.appendChild(tr);
                });
            }

            updatePaginationControls();
            updateSortIcons();
            updateTotalCounts();
        };

        const updatePaginationControls = () => {
            const totalPages = Math.ceil(filteredCardCollection.length / itemsPerPage);
            const controlsHtml = `
                <span class="me-2">${totalPages > 0 ? currentPage : 0} / ${totalPages} ページ (${filteredCardCollection.length} 件)</span>
                <button class="btn btn-outline-secondary btn-sm" ${currentPage <= 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">前へ</button>
                <button class="btn btn-outline-secondary btn-sm ms-1" ${currentPage >= totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">次へ</button>
            `;
            document.getElementById('pagination-controls').innerHTML = controlsHtml;
            document.getElementById('pagination-controls-bottom').innerHTML = controlsHtml;
        };

        window.changePage = (page) => {
            currentPage = page;
            renderTable();
        };

        const renderTagChoices = (containerId, selectedTags) => {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            allTags.forEach(tag => {
                const isSelected = selectedTags.includes(tag.name);
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = `btn btn-sm ${isSelected ? 'btn-primary' : 'btn-outline-secondary'} me-1 mb-1`;
                btn.textContent = tag.name;
                btn.onclick = () => toggleTag(tag.name, containerId.startsWith('edit'));
                container.appendChild(btn);
            });
        };

        const renderSelectedTags = (containerId, tags) => {
            const container = document.getElementById(containerId);
            container.innerHTML = tags.map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join(' ');
        };

        window.toggleTag = (tagName, isEdit) => {
            const index = currentCardTags.indexOf(tagName);
            if (index > -1) {
                currentCardTags.splice(index, 1);
            } else {
                currentCardTags.push(tagName);
            }
            if (isEdit) {
                renderTagChoices('edit-tag-choices-container', currentCardTags);
                renderSelectedTags('edit-card-tags-container', currentCardTags);
            } else {
                renderTagChoices('tag-choices-container', currentCardTags);
                renderSelectedTags('card-tags-container', currentCardTags);
            }
        };

        const updateSortIcons = () => {
            document.querySelectorAll('th.sortable').forEach(th => {
                const icon = th.querySelector('i');
                if (th.dataset.sort === sortConfig.key) {
                    icon.className = sortConfig.direction === 'ascending' ? 'bi bi-sort-down' : 'bi bi-sort-up';
                } else {
                    icon.className = 'bi bi-arrow-down-up';
                }
            });
        };

        const updateTotalCounts = () => {
            const totalCollection = cardCollection.reduce((sum, card) => sum + (card.data['枚数'] || 0), 0);
            const totalWishlist = wishlistCollection.reduce((sum, card) => sum + (card.data['枚数'] || 0), 0);
            totalCollectionSpan.textContent = totalCollection;
            totalWishlistSpan.textContent = totalWishlist;
        };
        
        const applySearchAndFilter = () => {
            const searchName = document.querySelector('[name="search_name"]').value.toLowerCase();
            const searchSetCode = document.querySelector('[name="search_set_code"]').value.toLowerCase();
            const searchRarity = document.querySelector('[name="search_rarity"]').value.toLowerCase();
            const searchTags = document.querySelector('[name="search_tags"]').value.toLowerCase();

            const currentData = getCurrentCollection();
            filteredCardCollection = currentData.filter(card => {
                const cardName = (card.data['名前'] || '').toLowerCase();
                const cardSetCode = (card.data['型番'] || '').toLowerCase();
                const cardRarity = (card.data['レアリティ'] || '').toLowerCase();
                const cardTags = (card.data.tags || []).join(', ').toLowerCase();

                return (
                    (searchName === '' || cardName.includes(searchName)) &&
                    (searchSetCode === '' || cardSetCode.includes(searchSetCode)) &&
                    (searchRarity === '' || cardRarity.includes(searchRarity)) &&
                    (searchTags === '' || cardTags.includes(searchTags))
                );
            });
            currentPage = 1; // 検索実行時は1ページ目に戻る
            renderTable();
        };

        const getTagsCollectionRef = () => {
            if (currentUser && currentUser.uid !== 'local_user') {
                return collection(db, "users", currentUser.uid, "tags");
            }
            return null;
        };

        const loadAllTags = async () => {
            const tagsCollRef = getTagsCollectionRef();
            if (tagsCollRef) {
                const snapshot = await getDocs(query(tagsCollRef));
                allTags = snapshot.docs.map(doc => ({ id: doc.id, name: doc.data().name })).sort((a, b) => a.name.localeCompare(b.name));
            } else {
                // ローカルモード用のダミータグ
                if (allTags.length === 0) {
                    allTags = [{ id: 'local1', name: 'デッキパーツ' }, { id: 'local2', name: 'コレクション' }];
                }
            }
            renderTagManagementList();
            // 現在開いているフォームのタグ選択肢も更新
            if (addForm.offsetParent !== null) renderTagChoices('tag-choices-container', currentCardTags);
            if (editCardModal._element.classList.contains('show')) renderTagChoices('edit-tag-choices-container', currentCardTags);
        };

        const renderTagManagementList = () => {
            const container = document.getElementById('existing-tags-list');
            container.innerHTML = '';
            allTags.forEach(tag => {
                const div = document.createElement('div');
                div.className = 'd-flex justify-content-between align-items-center mb-2';
                div.innerHTML = `
                    <span>${tag.name}</span>
                    <button class="btn btn-outline-danger btn-sm delete-tag-btn" data-id="${tag.id}" data-name="${tag.name}">削除</button>
                `;
                container.appendChild(div);
            });
        };

        document.getElementById('add-tag-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const inputValue = document.getElementById('new-tag-name').value.trim();
            if (!inputValue) return;
            
            // カンマで分割してタグの配列を作成
            const newTagNames = inputValue.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
            
            if (newTagNames.length === 0) {
                alert('有効なタグ名を入力してください。');
                return;
            }
            
            const tagsCollRef = getTagsCollectionRef();
            const addedTags = [];
            const duplicateTags = [];
            
            for (const newTagName of newTagNames) {
                if (allTags.some(tag => tag.name === newTagName)) {
                    duplicateTags.push(newTagName);
                } else {
                    if (tagsCollRef) {
                        await addDoc(tagsCollRef, { name: newTagName });
                    } else {
                        allTags.push({ id: `local_${Date.now()}_${Math.random()}`, name: newTagName });
                    }
                    addedTags.push(newTagName);
                }
            }
            
            if (duplicateTags.length > 0) {
                alert(`以下のタグは既に存在するためスキップされました: ${duplicateTags.join(', ')}`);
            }
            
            if (addedTags.length > 0) {
                document.getElementById('new-tag-name').value = '';
                await loadAllTags();
            }
        });

        document.getElementById('existing-tags-list').addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-tag-btn')) {
                const tagId = e.target.dataset.id;
                const tagName = e.target.dataset.name;
                if (!confirm(`タグ「${tagName}」を削除しますか？
このタグは全てのカードからも削除されます。`)) return;

                const tagsCollRef = getTagsCollectionRef();
                if (tagsCollRef) {
                    await deleteDoc(doc(tagsCollRef, tagId));
                    // TODO: 全カードからこのタグを削除するバッチ処理
                } 
                allTags = allTags.filter(t => t.id !== tagId);
                // TODO: ローカルの全カードからこのタグを削除
                
                await loadAllTags();
            }
        });

        // --- Firestore Functions ---
        const getCollectionRef = (listType = 'collection') => {
            if (currentUser && currentUser.uid !== 'local_user') {
                const collectionName = listType === 'collection' ? "cards" : "wishlist";
                return collection(db, "users", currentUser.uid, collectionName);
            }
            return null;
        };

        const loadCollectionFromFirestore = async () => {
            if (!currentUser) return;
            showLoading(true);
            
            // Load both collections
            const cardSnapshot = await getDocs(query(getCollectionRef('collection')));
            cardCollection = cardSnapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
            
            const wishlistSnapshot = await getDocs(query(getCollectionRef('wishlist')));
            wishlistCollection = wishlistSnapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
            
            applySearchAndFilter();
            showLoading(false);
        };

        // --- Main Auth Logic ---
        const handleUserLogin = (user) => {
            currentUser = user;
            userEmailSpan.textContent = user.email;
            mainApp.style.display = 'block';
            appLoader.style.display = 'none';
            authModal.hide();
            // ローカルモードではFirestoreから読み込まない
            if (user.uid !== 'local_user') {
                loadCollectionFromFirestore();
                loadAllTags();
            } else {
                cardCollection = [];
                wishlistCollection = [];
                applySearchAndFilter();
                loadAllTags(); // ローカルモードでもタグをロード・初期化
                document.getElementById('delete-account-btn').style.display = 'none';
            }
            applyTheme();
        };

        const handleUserLogout = () => {
            currentUser = null;
            mainApp.style.display = 'none';
            appLoader.style.display = 'none';
            authModal.show();
            cardCollection = [];
            wishlistCollection = [];
            renderTable([]);
            document.getElementById('delete-account-btn').style.display = 'block';
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                handleUserLogin(user);
            } else {
                handleUserLogout();
            }
        });

        // --- Event Listeners ---
        document.getElementById('tag-management-btn').addEventListener('click', () => tagManagementModal.show());
        
        // Tab switching
        document.getElementById('collection-tab').addEventListener('click', (e) => {
            e.preventDefault();
            currentListType = 'collection';
            document.getElementById('collection-tab').classList.add('active');
            document.getElementById('wishlist-tab').classList.remove('active');
            applySearchAndFilter();
        });
        
        document.getElementById('wishlist-tab').addEventListener('click', (e) => {
            e.preventDefault();
            currentListType = 'wishlist';
            document.getElementById('wishlist-tab').classList.add('active');
            document.getElementById('collection-tab').classList.remove('active');
            applySearchAndFilter();
        });
        
        document.getElementById('login-btn').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (email === 'local') {
                // ローカルモード用のダミーユーザーを設定
                currentUser = { uid: 'local_user', email: 'local@example.com' };
                // onAuthStateChangedを手動で呼び出すか、同等の処理を行う
                handleUserLogin(currentUser);
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                authError.style.display = 'none';
            } catch (error) { authError.textContent = `ログインエラー: ${error.message}`; authError.style.display = 'block'; }
        });

        document.getElementById('signup-btn').addEventListener('click', async () => {
            try {
                await createUserWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value);
                authError.style.display = 'none';
            } catch (error) { authError.textContent = `新規登録エラー: ${error.message}`; authError.style.display = 'block'; }
        });

        logoutBtn.addEventListener('click', () => {
            if (currentUser && currentUser.uid === 'local_user') {
                window.location.reload();
            } else {
                signOut(auth);
            }
        });

        addForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading(true);
            const formData = new FormData(addForm);
            const addType = document.querySelector('input[name="add-type"]:checked').value;
            const newCard = {
                '名前': formData.get('name'),
                '型番': formData.get('set_code'),
                'レアリティ': formData.get('rarity'),
                '枚数': parseInt(formData.get('quantity'), 10),
                'tags': [...currentCardTags] // タグを追加
            };

            const targetCollection = addType === 'collection' ? cardCollection : wishlistCollection;
            const collRef = getCollectionRef(addType);
            if (collRef) { // Firebaseモード
                const q = query(collRef, 
                    where("名前", "==", newCard.名前),
                    where("型番", "==", newCard.型番),
                    where("レアリティ", "==", newCard.レアリティ)
                );
                const existingDocs = await getDocs(q);

                if (existingDocs.empty) {
                    const docRef = await addDoc(collRef, newCard);
                    targetCollection.push({ id: docRef.id, data: newCard });
                } else {
                    const existingDoc = existingDocs.docs[0];
                    await updateDoc(existingDoc.ref, { 枚数: increment(newCard.枚数) });
                    const localCard = targetCollection.find(c => c.id === existingDoc.id);
                    if(localCard) localCard.data.枚数 += newCard.枚数;
                }
            } else { // ローカルモード
                const existingCard = targetCollection.find(c => 
                    c.data.名前 === newCard.名前 && 
                    c.data.型番 === newCard.型番 && 
                    c.data.レアリティ === newCard.レアリティ
                );
                if (existingCard) {
                    existingCard.data.枚数 += newCard.枚数;
                } else {
                    targetCollection.push({ id: `local_${Date.now()}`, data: newCard });
                }
            }
            
            applySearchAndFilter();
            addForm.reset();
            currentCardTags = [];
            renderTagChoices('tag-choices-container', currentCardTags);
            renderSelectedTags('card-tags-container', currentCardTags);
            document.getElementById('set-rarity-choices').innerHTML = '';
            showLoading(false);
        });

        cardTableBody.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            if (target.classList.contains('delete-btn')) {
                const cardId = target.dataset.id;
                const cardName = target.closest('tr').querySelector('td').textContent;
                const listName = currentListType === 'collection' ? '所持カード' : 'ウィッシュリスト';
                if (confirm(`「${cardName}」を${listName}から削除しますか？`)) {
                    const collRef = getCollectionRef(currentListType);
                    if (collRef) { // Firebaseモード
                        deleteDoc(doc(collRef, cardId));
                    }
                    if (currentListType === 'collection') {
                        cardCollection = cardCollection.filter(c => c.id !== cardId);
                    } else {
                        wishlistCollection = wishlistCollection.filter(c => c.id !== cardId);
                    }
                    applySearchAndFilter();
                }
            } else if (target.classList.contains('edit-btn')) {
                const cardId = target.dataset.id;
                const currentData = getCurrentCollection();
                const card = currentData.find(c => c.id === cardId);
                if (card) {
                    document.getElementById('edit-card-id').value = card.id;
                    document.getElementById('edit-name').value = card.data.名前;
                    document.getElementById('edit-set-code').value = card.data.型番;
                    document.getElementById('edit-rarity').value = card.data.レアリティ;
                    document.getElementById('edit-quantity').value = card.data.枚数;
                    
                    currentCardTags = [...(card.data.tags || [])]; // 既存タグをセット
                    renderTagChoices('edit-tag-choices-container', currentCardTags);
                    renderSelectedTags('edit-card-tags-container', currentCardTags);

                    editCardModal.show();
                }
            } else if (target.classList.contains('move-to-collection-btn')) {
                const cardId = target.dataset.id;
                const card = wishlistCollection.find(c => c.id === cardId);
                if (card && confirm(`「${card.data.名前}」を所持カードに移動しますか？`)) {
                    // Move from wishlist to collection
                    const wishlistRef = getCollectionRef('wishlist');
                    const collectionRef = getCollectionRef('collection');
                    
                    if (collectionRef && wishlistRef) {
                        // Add to collection
                        const docRef = await addDoc(collectionRef, card.data);
                        cardCollection.push({ id: docRef.id, data: card.data });
                        
                        // Remove from wishlist
                        await deleteDoc(doc(wishlistRef, cardId));
                        wishlistCollection = wishlistCollection.filter(c => c.id !== cardId);
                    } else {
                        // Local mode
                        cardCollection.push({ id: `local_${Date.now()}`, data: card.data });
                        wishlistCollection = wishlistCollection.filter(c => c.id !== cardId);
                    }
                    
                    applySearchAndFilter();
                }
            }
        });

        document.getElementById('save-edit-btn').addEventListener('click', async () => {
            const cardId = document.getElementById('edit-card-id').value;
            const updatedData = {
                枚数: parseInt(document.getElementById('edit-quantity').value, 10),
                tags: [...currentCardTags]
            };

            const collRef = getCollectionRef(currentListType);
            if (collRef) { // Firebaseモード
                await updateDoc(doc(collRef, cardId), updatedData);
            }

            const targetCollection = currentListType === 'collection' ? cardCollection : wishlistCollection;
            const localCard = targetCollection.find(c => c.id === cardId);
            if(localCard) {
                localCard.data.枚数 = updatedData.枚数;
                localCard.data.tags = updatedData.tags;
            }
            applySearchAndFilter();
            editCardModal.hide();
        });

        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            applySearchAndFilter();
        });

        document.getElementById('items-per-page').addEventListener('change', (e) => {
            itemsPerPage = parseInt(e.target.value, 10);
            currentPage = 1; // 表示件数変更時は1ページ目に戻る
            renderTable();
        });

        document.querySelectorAll('th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const key = th.dataset.sort;
                if (sortConfig.key === key) {
                    sortConfig.direction = sortConfig.direction === 'ascending' ? 'descending' : 'ascending';
                } else {
                    sortConfig.key = key;
                    sortConfig.direction = 'ascending';
                }
                renderTable();
            });
        });

        // --- Data Import / Export ---
        const exportAllData = () => {
            return {
                collection: cardCollection.map(c => c.data),
                wishlist: wishlistCollection.map(c => c.data)
            };
        };
        
        const parseCsv = (text) => {
            const lines = text.trim().replace(/\r/g, '').split('\n');
            const header = lines[0].split(',').map(h => h.trim());
            const cards = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                const values = lines[i].split(',');
                const card = {};
                header.forEach((col, index) => {
                    const value = values[index]?.trim() || '';
                    if (col === '枚数') {
                        card[col] = parseInt(value, 10) || 1;
                    } else {
                        card[col] = value.replace(/^"|"$/g, '');
                    }
                });
                cards.push(card);
            }
            return cards;
        };

        const handleImport = async (text, format) => {
            let importedCards;
            try {
                if (format === 'json') importedCards = JSON.parse(text);
                else if (format === 'csv') importedCards = parseCsv(text);
                if (!Array.isArray(importedCards)) throw new Error('Invalid file format');

                if (!confirm(`${importedCards.length}枚のカードをインポートしますか？\n(重複するカードは枚数が加算されます)`)) return;
                
                showLoading(true);
                const collRef = getCollectionRef();

                if (collRef) { // Firebaseモード
                    const batch = writeBatch(db);
                    for (const card of importedCards) {
                        const q = query(collRef, where("名前", "==", card.名前), where("型番", "==", card.型番), where("レアリティ", "==", card.レアリティ));
                        const existingDocs = await getDocs(q);
                        if (existingDocs.empty) {
                            batch.set(doc(collRef), card);
                        } else {
                            batch.update(existingDocs.docs[0].ref, { 枚数: increment(card.枚数 || 1) });
                        }
                    }
                    await batch.commit();
                    await loadCollectionFromFirestore(); // ここで applySearchAndFilter が呼ばれる
                } else { // ローカルモード
                    for (const card of importedCards) {
                        const existingCard = cardCollection.find(c => 
                            c.data.名前 === card.名前 && 
                            c.data.型番 === card.型番 && 
                            c.data.レアリティ === card.レアリティ
                        );
                        if (existingCard) {
                            existingCard.data.枚数 += (card.枚数 || 1);
                        } else {
                            cardCollection.push({ id: `local_${Date.now()}`, data: card });
                        }
                    }
                    applySearchAndFilter();
                }

                showLoading(false);
                alert('インポートが完了しました。');
            } catch (err) { showLoading(false); alert(`インポート中にエラーが発生しました: ${err.message}`); console.error(err); }
        };

        document.getElementById('import-json-btn').addEventListener('click', () => importFileInput.click());
        document.getElementById('import-csv-btn').addEventListener('click', () => importFileInput.click());
        importFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            const format = file.name.endsWith('.csv') ? 'csv' : 'json';
            reader.onload = (event) => handleImport(event.target.result, format);
            reader.readAsText(file);
            e.target.value = '';
        });

        document.getElementById('export-json-btn').addEventListener('click', () => {
            const exportData = exportAllData();
            const dataStr = JSON.stringify(exportData, null, 4);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'yugioh_collection.json'; a.click(); URL.revokeObjectURL(url);
        });

        document.getElementById('export-csv-btn').addEventListener('click', () => {
            const header = ['リスト種別', '名前', '型番', 'レアリティ', '枚数', 'タグ'];
            const collectionRows = cardCollection.map(c => {
                const row = ['所持カード', c.data['名前'], c.data['型番'], c.data['レアリティ'], c.data['枚数'], (c.data.tags || []).join(';')];
                return row.map(value => {
                    const strValue = String(value || '');
                    return strValue.includes(',') ? `"${strValue}"` : strValue;
                }).join(',');
            });
            const wishlistRows = wishlistCollection.map(c => {
                const row = ['ウィッシュリスト', c.data['名前'], c.data['型番'], c.data['レアリティ'], c.data['枚数'], (c.data.tags || []).join(';')];
                return row.map(value => {
                    const strValue = String(value || '');
                    return strValue.includes(',') ? `"${strValue}"` : strValue;
                }).join(',');
            });
            const csvContent = [header.join(','), ...collectionRows, ...wishlistRows].join('\r\n');
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'yugioh_collection.csv'; a.click(); URL.revokeObjectURL(url);
        });

        // --- Settings ---
        document.getElementById('how-to-use-btn').addEventListener('click', () => howToUseModal.show());
        document.getElementById('settings-btn').addEventListener('click', () => settingsModal.show());

        darkModeToggle.addEventListener('change', (e) => {
            const theme = e.target.checked ? 'dark' : 'light';
            document.documentElement.setAttribute('data-bs-theme', theme);
            localStorage.setItem('theme', theme);
            applyTheme(); // 設定変更時に即時反映
        });

        const applyTheme = () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-bs-theme', savedTheme);
            darkModeToggle.checked = savedTheme === 'dark';

            const nav = document.querySelector('.navbar');
            if (nav) {
                if (savedTheme === 'dark') {
                    nav.classList.remove('navbar-light', 'bg-light');
                    nav.classList.add('navbar-dark', 'bg-dark');
                } else {
                    nav.classList.remove('navbar-dark', 'bg-dark');
                    nav.classList.add('navbar-light', 'bg-light');
                }
            }
        };
        applyTheme(); // Apply theme on initial load

        document.getElementById('delete-account-btn').addEventListener('click', async () => {
            if (!currentUser) return;
            if (!confirm('本当にアカウントを削除しますか？この操作は元に戻せません。')) return;
            if (!confirm('最終確認です。アカウントに紐づく全てのカードデータが永久に削除されます。よろしいですか？')) return;
            
            showLoading(true);
            try {
                // 1. Delete all card data from Firestore
                const userCardCollectionRef = getCollectionRef();
                const snapshot = await getDocs(query(userCardCollectionRef));
                const batch = writeBatch(db);
                snapshot.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();

                // 2. Delete the user account
                await deleteUser(currentUser);
                await signOut(auth);
                alert('正常に削除されました。');
                settingsModal.hide();
            } catch (error) {
                showLoading(false);
                if (error.code === 'auth/requires-recent-login') {
                    alert('アカウント削除の前に、再ログインが必要です。一度ログアウトしてから、再度ログインし直した上でもう一度お試しください。');
                } else {
                    alert(`アカウントの削除中にエラーが発生しました: ${error.message}`);
                }
                console.error(error);
            }
        });

        // --- Fetch from URL ---
        document.getElementById('fetch-btn').addEventListener('click', async () => {
            let url = document.getElementById('url').value;
            if (!url) { alert('URLを入力してください。'); return; }
            if (!url.includes('request_locale=ja')) { url += url.includes('?') ? '&request_locale=ja' : '?request_locale=ja'; }
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
            showLoading(true);
            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const text = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const cardName = doc.querySelector('#card_image_1')?.alt || '';
                if (!cardName) throw new Error("カード名が見つかりません。サイトの構造が変更された可能性があります。");
                document.getElementById('name').value = cardName;
                const setCodes = Array.from(doc.querySelectorAll('div.card_number')).map(div => div.textContent.trim());
                const rarities = Array.from(doc.querySelectorAll('div.rarity p')).map(p => p.textContent.trim());
                const choicesEl = document.getElementById('set-rarity-choices');
                choicesEl.innerHTML = '';
                if (setCodes.length > 0) {
                    setCodes.map((code, i) => ({ set_code: code, rarity: rarities[i] || '' })).forEach(data => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'btn btn-outline-primary btn-sm me-1 mb-1 set-choice-btn';
                        btn.dataset.setCode = data.set_code; btn.dataset.rarity = data.rarity;
                        btn.textContent = `${data.set_code} (${data.rarity})`;
                        choicesEl.appendChild(btn);
                    });
                } else { choicesEl.textContent = '収録情報が見つかりません。'; }
                document.getElementById('url').value = '';
            } catch (err) { alert(`エラー: ${err.message}`); console.error(err); } finally { showLoading(false); }
        });
        document.getElementById('set-rarity-choices').addEventListener('click', (e) => {
            if (e.target.classList.contains('set-choice-btn')) {
                document.getElementById('set_code').value = e.target.dataset.setCode;
                document.getElementById('rarity').value = e.target.dataset.rarity;
            }
        });
    </script>
</body>
</html>

<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>カード管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; }
        [data-bs-theme="dark"] body { background-color: #212529; }
        .container-fluid { max-width: 1400px; }
        .card { margin-bottom: 1.5rem; }
        .table-responsive { max-height: 500px; }
        #loading-overlay, #app-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1060;
            color: white;
        }
        .set-choice-btn { cursor: pointer; }
        #main-app { display: none; } /* Hide app until logged in */
    </style>
</head>
<body>
    <!-- Full screen loader -->
    <div id="app-loader">
        <div class="spinner-border" style="width: 3rem; height: 3rem;" role="status"><span class="visually-hidden">Loading...</span></div>
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="auth-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">ログインまたは新規登録</h5></div>
            <div class="modal-body">
                <div id="auth-error" class="alert alert-danger" style="display: none;"></div>
                <form id="auth-form">
                    <div class="mb-3"><label for="email" class="form-label">メールアドレス</label><input type="email" class="form-control" id="email" required></div>
                    <div class="mb-3"><label for="password" class="form-label">パスワード</label><input type="password" class="form-control" id="password" required></div>
                    <div class="d-grid gap-2">
                        <button type="button" id="login-btn" class="btn btn-primary">ログイン</button>
                        <button type="button" id="signup-btn" class="btn btn-secondary">新規登録</button>
                    </div>
                </form>
            </div>
        </div></div>
    </div>

    <!-- Edit Card Modal -->
    <div class="modal fade" id="edit-card-modal" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">カード情報の編集</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="edit-form">
                    <input type="hidden" id="edit-card-id">
                    <div class="mb-3"><label class="form-label">名前</label><input type="text" id="edit-name" class="form-control" readonly disabled></div>
                    <div class="mb-3"><label class="form-label">型番</label><input type="text" id="edit-set-code" class="form-control" readonly disabled></div>
                    <div class="mb-3"><label class="form-label">レアリティ</label><input type="text" id="edit-rarity" class="form-control" readonly disabled></div>
                    <div class="mb-3"><label for="edit-quantity" class="form-label">枚数</label><input type="number" id="edit-quantity" class="form-control" min="1" required></div>
                    <div class="mb-3"><label for="edit-memo" class="form-label">備考</label><input type="text" id="edit-memo" class="form-control"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" id="save-edit-btn" class="btn btn-primary">変更を保存</button>
            </div>
        </div></div>
    </div>

    <!-- How to Use Modal -->
    <div class="modal fade" id="how-to-use-modal" tabindex="-1">
        <div class="modal-dialog modal-lg"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">使い方ガイド</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <h6><i class="bi bi-person-plus"></i> アカウント</h6>
                <p>最初にメールアドレスとパスワードで新規登録します。登録したアカウントでログインすると、あなたのカードデータがクラウドに保存され、どの端末からでもアクセスできます。</p>
                <h6><i class="bi bi-search"></i> カードのURL読込</h6>
                <p>データベースのカードページのURLをコピーし、入力欄に貼り付けて「読込」ボタンを押すと、カード名や型番、レアリティの候補が自動で入力されます。</p>
                <h6><i class="bi bi-card-list"></i> カードの登録と管理</h6>
                <p>読み込んだ情報や手入力した情報を確認し、「カードを追加」ボタンでコレクションに登録します。一覧の「編集」ボタンで枚数や備考を、「削除」ボタンでカードそのものを削除できます。</p>
                <h6><i class="bi bi-files"></i> データのインポート・エクスポート</h6>
                <p>「データ管理」メニューから、コレクション全体のバックアップをJSON形式やCSV形式（Excelで表示可能）でダウンロードできます。また、JSON/CSVファイルからデータを一括でインポートすることも可能です。</p>
                <h6><i class="bi bi-gear"></i> 設定</h6>
                <p>「設定」メニューから、画面の見た目をダークモードに切り替えることができます。また、アカウントが不要になった場合は、ここからアカウントと全てのカードデータを完全に削除することができます。この操作は元に戻せないのでご注意ください。</p>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button></div>
        </div></div>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settings-modal" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">設定</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="dark-mode-toggle">
                    <label class="form-check-label" for="dark-mode-toggle">ダークモード</label>
                </div>
                <hr>
                <h6>アカウント削除</h6>
                <p class="text-muted small">この操作は元に戻せません。アカウントに紐づく全てのカードデータが完全に削除されます。</p>
                <button class="btn btn-danger" id="delete-account-btn">アカウントを削除する</button>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button></div>
        </div></div>
    </div>

    <!-- Main App -->
    <div id="main-app">
        <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4" data-bs-theme="light">
            <div class="container-fluid">
                <span class="navbar-brand"><i class="bi bi-layers-fill"></i> カード管理</span>
                <div class="d-flex align-items-center">
                    <button class="btn btn-outline-info me-2" id="how-to-use-btn"><i class="bi bi-question-circle"></i> 使い方</button>
                    <div class="dropdown me-2">
                        <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"><i class="bi bi-database"></i> データ管理</button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><button class="dropdown-item" id="import-json-btn">JSONからインポート</button></li>
                            <li><button class="dropdown-item" id="import-csv-btn">CSVからインポート</button></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><button class="dropdown-item" id="export-json-btn">JSON形式でエクスポート</button></li>
                            <li><button class="dropdown-item" id="export-csv-btn">CSV形式でエクスポート</button></li>
                        </ul>
                        <input type="file" id="import-file-input" accept=".json,.csv" style="display: none;">
                    </div>
                    <button class="btn btn-outline-secondary me-3" id="settings-btn"><i class="bi bi-gear"></i> 設定</button>
                    <span class="navbar-text me-3" id="user-email"></span>
                    <button id="logout-btn" class="btn btn-danger"><i class="bi bi-box-arrow-right"></i> ログアウト</button>
                </div>
            </div>
        </nav>

        <div class="container-fluid">
             <div id="loading-overlay" style="display: none;"><div class="spinner-border" role="status"></div></div>
            <div class="row">
                <!-- Left Column: Add Card -->
                <div class="col-lg-5">
                    <div class="card">
                        <div class="card-header">カード登録</div>
                        <div class="card-body">
                            <form id="add-form">
                                <div class="mb-3">
                                    <label for="url" class="form-label">公式DB URL</label>
                                    <div class="input-group">
                                        <input type="url" class="form-control" id="url" placeholder="URLをペースト (Ctrl+V)...">
                                        <button class="btn btn-primary" type="button" id="fetch-btn">読込</button>
                                    </div>
                                </div>
                                <div class="mb-3"><label for="name" class="form-label">名前</label><input type="text" class="form-control" id="name" name="name" required></div>
                                <div class="mb-3">
                                    <label for="set_code" class="form-label">型番</label>
                                    <input type="text" class="form-control" id="set_code" name="set_code" required>
                                    <div id="set-rarity-choices" class="mt-2"></div>
                                </div>
                                <div class="mb-3"><label for="rarity" class="form-label">レアリティ</label><input type="text" class="form-control" id="rarity" name="rarity"></div>
                                <div class="mb-3"><label for="quantity" class="form-label">枚数</label><input type="number" class="form-control" id="quantity" name="quantity" value="1" min="1" required></div>
                                <div class="mb-3"><label for="memo" class="form-label">備考</label><input type="text" class="form-control" id="memo" name="memo">
                                </div>
                                <button type="submit" class="btn btn-success w-100">カードを追加</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Search and List -->
                <div class="col-lg-7">
                    <div class="card">
                        <div class="card-header">カード検索 (総枚数: <span id="total-cards">0</span>)</div>
                        <div class="card-body">
                            <form id="search-form" class="row g-3 mb-4">
                                <div class="col-md-6"><input type="text" name="search_name" class="form-control" placeholder="名前..."></div>
                                <div class="col-md-6"><input type="text" name="search_set_code" class="form-control" placeholder="型番..."></div>
                                <div class="col-md-6"><input type="text" name="search_rarity" class="form-control" placeholder="レアリティ..."></div>
                                <div class="col-md-6"><input type="text" name="search_memo" class="form-control" placeholder="備考..."></div>
                                <div class="col-12 d-grid"><button type="submit" class="btn btn-info">検索</button></div>
                            </form>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead><tr><th>名前</th><th>型番</th><th>レアリティ</th><th>枚数</th><th>備考</th><th>操作</th></tr></thead>
                                    <tbody id="card-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, query, where, updateDoc, increment, writeBatch } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // User's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAOYKalLUb2hbghrjQUS8AWzxpLExBT7aU",
            authDomain: "ygoh-9bcf6.firebaseapp.com",
            projectId: "ygoh-9bcf6",
            storageBucket: "ygoh-9bcf6.firebasestorage.app",
            messagingSenderId: "1058357616781",
            appId: "1:1058357616781:web:f25db127e2824226d942c4",
            measurementId: "G-S4CCJC3HW9"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State ---
        let cardCollection = [];
        let currentUser = null;

        // --- DOM Elements ---
        const mainApp = document.getElementById('main-app');
        const appLoader = document.getElementById('app-loader');
        const authModal = new bootstrap.Modal(document.getElementById('auth-modal'));
        const editCardModal = new bootstrap.Modal(document.getElementById('edit-card-modal'));
        const howToUseModal = new bootstrap.Modal(document.getElementById('how-to-use-modal'));
        const settingsModal = new bootstrap.Modal(document.getElementById('settings-modal'));
        const authError = document.getElementById('auth-error');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailSpan = document.getElementById('user-email');
        const cardTableBody = document.getElementById('card-table-body');
        const totalCardsSpan = document.getElementById('total-cards');
        const loadingOverlay = document.getElementById('loading-overlay');
        const addForm = document.getElementById('add-form');
        const searchForm = document.getElementById('search-form');
        const importFileInput = document.getElementById('import-file-input');
        const darkModeToggle = document.getElementById('dark-mode-toggle');

        // --- Utility & UI Functions ---
        const showLoading = (show) => { loadingOverlay.style.display = show ? 'flex' : 'none'; };
        
        const renderTable = (cards) => {
            cardTableBody.innerHTML = '';
            if (!cards || cards.length === 0) {
                cardTableBody.innerHTML = '<tr><td colspan="6" class="text-center">該当するカードはありません。</td></tr>';
            }
            cards.sort((a, b) => a.data['名前'].localeCompare(b.data['名前'])).forEach(card => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${card.data['名前'] || ''}</td>
                    <td>${card.data['型番'] || ''}</td>
                    <td>${card.data['レアリティ'] || ''}</td>
                    <td>${card.data['枚数'] || ''}</td>
                    <td>${card.data['備考'] || ''}</td>
                    <td>
                        <button class="btn btn-primary btn-sm edit-btn" data-id="${card.id}"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-danger btn-sm delete-btn" data-id="${card.id}"><i class="bi bi-trash"></i></button>
                    </td>
                `;
                cardTableBody.appendChild(tr);
            });
            totalCardsSpan.textContent = cardCollection.reduce((sum, card) => sum + (card.data['枚数'] || 0), 0);
        };

        // --- Firestore Functions ---
        const getCollectionRef = () => {
            if (currentUser && currentUser.uid !== 'local_user') {
                return collection(db, "users", currentUser.uid, "cards");
            }
            return null;
        };

        const loadCollectionFromFirestore = async () => {
            if (!currentUser) return;
            showLoading(true);
            const querySnapshot = await getDocs(query(getCollectionRef()));
            cardCollection = querySnapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
            renderTable(cardCollection);
            showLoading(false);
        };

        // --- Main Auth Logic ---
        const handleUserLogin = (user) => {
            currentUser = user;
            userEmailSpan.textContent = user.email;
            mainApp.style.display = 'block';
            appLoader.style.display = 'none';
            authModal.hide();
            // ローカルモードではFirestoreから読み込まない
            if (user.uid !== 'local_user') {
                loadCollectionFromFirestore();
            } else {
                cardCollection = [];
                renderTable(cardCollection);
                document.getElementById('delete-account-btn').style.display = 'none';
            }
            applyTheme();
        };

        const handleUserLogout = () => {
            currentUser = null;
            mainApp.style.display = 'none';
            appLoader.style.display = 'none';
            authModal.show();
            cardCollection = [];
            renderTable([]);
            document.getElementById('delete-account-btn').style.display = 'block';
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                handleUserLogin(user);
            } else {
                handleUserLogout();
            }
        });

        // --- Event Listeners ---
        document.getElementById('login-btn').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (email === 'local') {
                // ローカルモード用のダミーユーザーを設定
                currentUser = { uid: 'local_user', email: 'local@example.com' };
                // onAuthStateChangedを手動で呼び出すか、同等の処理を行う
                handleUserLogin(currentUser);
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                authError.style.display = 'none';
            } catch (error) { authError.textContent = `ログインエラー: ${error.message}`; authError.style.display = 'block'; }
        });

        document.getElementById('signup-btn').addEventListener('click', async () => {
            try {
                await createUserWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value);
                authError.style.display = 'none';
            } catch (error) { authError.textContent = `新規登録エラー: ${error.message}`; authError.style.display = 'block'; }
        });

        logoutBtn.addEventListener('click', () => {
            if (currentUser && currentUser.uid === 'local_user') {
                window.location.reload();
            } else {
                signOut(auth);
            }
        });

        addForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading(true);
            const formData = new FormData(addForm);
            const newCard = {
                '名前': formData.get('name'),
                '型番': formData.get('set_code'),
                'レアリティ': formData.get('rarity'),
                '枚数': parseInt(formData.get('quantity'), 10),
                '備考': formData.get('memo')
            };

            const collRef = getCollectionRef();
            if (collRef) { // Firebaseモード
                const q = query(collRef, 
                    where("名前", "==", newCard.名前),
                    where("型番", "==", newCard.型番),
                    where("レアリティ", "==", newCard.レアリティ)
                );
                const existingDocs = await getDocs(q);

                if (existingDocs.empty) {
                    const docRef = await addDoc(collRef, newCard);
                    cardCollection.push({ id: docRef.id, data: newCard });
                } else {
                    const existingDoc = existingDocs.docs[0];
                    await updateDoc(existingDoc.ref, { 枚数: increment(newCard.枚数) });
                    const localCard = cardCollection.find(c => c.id === existingDoc.id);
                    if(localCard) localCard.data.枚数 += newCard.枚数;
                }
            } else { // ローカルモード
                const existingCard = cardCollection.find(c => 
                    c.data.名前 === newCard.名前 && 
                    c.data.型番 === newCard.型番 && 
                    c.data.レアリティ === newCard.レアリティ
                );
                if (existingCard) {
                    existingCard.data.枚数 += newCard.枚数;
                } else {
                    cardCollection.push({ id: `local_${Date.now()}`, data: newCard });
                }
            }
            
            renderTable(cardCollection);
            addForm.reset();
            document.getElementById('set-rarity-choices').innerHTML = '';
            showLoading(false);
        });

        cardTableBody.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            if (target.classList.contains('delete-btn')) {
                const cardId = target.dataset.id;
                const cardName = target.closest('tr').querySelector('td').textContent;
                if (confirm(`「${cardName}」をコレクションから削除しますか？`)) {
                    const collRef = getCollectionRef();
                    if (collRef) { // Firebaseモード
                        deleteDoc(doc(collRef, cardId));
                    }
                    cardCollection = cardCollection.filter(c => c.id !== cardId);
                    renderTable(cardCollection);
                }
            } else if (target.classList.contains('edit-btn')) {
                const cardId = target.dataset.id;
                const card = cardCollection.find(c => c.id === cardId);
                if (card) {
                    document.getElementById('edit-card-id').value = card.id;
                    document.getElementById('edit-name').value = card.data.名前;
                    document.getElementById('edit-set-code').value = card.data.型番;
                    document.getElementById('edit-rarity').value = card.data.レアリティ;
                    document.getElementById('edit-quantity').value = card.data.枚数;
                    document.getElementById('edit-memo').value = card.data.備考;
                    editCardModal.show();
                }
            }
        });

        document.getElementById('save-edit-btn').addEventListener('click', async () => {
            const cardId = document.getElementById('edit-card-id').value;
            const updatedData = {
                枚数: parseInt(document.getElementById('edit-quantity').value, 10),
                備考: document.getElementById('edit-memo').value
            };

            const collRef = getCollectionRef();
            if (collRef) { // Firebaseモード
                await updateDoc(doc(collRef, cardId), updatedData);
            }

            const localCard = cardCollection.find(c => c.id === cardId);
            if(localCard) {
                localCard.data.枚数 = updatedData.枚数;
                localCard.data.備考 = updatedData.備考;
            }
            renderTable(cardCollection);
            editCardModal.hide();
        });

        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const filteredCards = cardCollection.filter(card => {
                return ( (searchForm.search_name.value === '' || String(card.data['名前']||'').toLowerCase().includes(searchForm.search_name.value.toLowerCase()))
                      && (searchForm.search_set_code.value === '' || String(card.data['型番']||'').toLowerCase().includes(searchForm.search_set_code.value.toLowerCase()))
                      && (searchForm.search_rarity.value === '' || String(card.data['レアリティ']||'').toLowerCase().includes(searchForm.search_rarity.value.toLowerCase()))
                      && (searchForm.search_memo.value === '' || String(card.data['備考']||'').toLowerCase().includes(searchForm.search_memo.value.toLowerCase()))
                );
            });
            renderTable(filteredCards);
        });

        // --- Data Import / Export ---
        const parseCsv = (text) => {
            const lines = text.trim().replace(/\r/g, '').split('\n');
            const header = lines[0].split(',').map(h => h.trim());
            const cards = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                const values = lines[i].split(',');
                const card = {};
                header.forEach((col, index) => {
                    const value = values[index]?.trim() || '';
                    if (col === '枚数') {
                        card[col] = parseInt(value, 10) || 1;
                    } else {
                        card[col] = value.replace(/^"|"$/g, '');
                    }
                });
                cards.push(card);
            }
            return cards;
        };

        const handleImport = async (text, format) => {
            let importedCards;
            try {
                if (format === 'json') importedCards = JSON.parse(text);
                else if (format === 'csv') importedCards = parseCsv(text);
                if (!Array.isArray(importedCards)) throw new Error('Invalid file format');

                if (!confirm(`${importedCards.length}枚のカードをインポートしますか？\n(重複するカードは枚数が加算されます)`)) return;
                
                showLoading(true);
                const collRef = getCollectionRef();

                if (collRef) { // Firebaseモード
                    const batch = writeBatch(db);
                    for (const card of importedCards) {
                        const q = query(collRef, where("名前", "==", card.名前), where("型番", "==", card.型番), where("レアリティ", "==", card.レアリティ));
                        const existingDocs = await getDocs(q);
                        if (existingDocs.empty) {
                            batch.set(doc(collRef), card);
                        } else {
                            batch.update(existingDocs.docs[0].ref, { 枚数: increment(card.枚数 || 1) });
                        }
                    }
                    await batch.commit();
                    await loadCollectionFromFirestore();
                } else { // ローカルモード
                    for (const card of importedCards) {
                        const existingCard = cardCollection.find(c => 
                            c.data.名前 === card.名前 && 
                            c.data.型番 === card.型番 && 
                            c.data.レアリティ === card.レアリティ
                        );
                        if (existingCard) {
                            existingCard.data.枚数 += (card.枚数 || 1);
                        } else {
                            cardCollection.push({ id: `local_${Date.now()}`, data: card });
                        }
                    }
                    renderTable(cardCollection);
                }

                showLoading(false);
                alert('インポートが完了しました。');
            } catch (err) { showLoading(false); alert(`インポート中にエラーが発生しました: ${err.message}`); console.error(err); }
        };

        document.getElementById('import-json-btn').addEventListener('click', () => importFileInput.click());
        document.getElementById('import-csv-btn').addEventListener('click', () => importFileInput.click());
        importFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            const format = file.name.endsWith('.csv') ? 'csv' : 'json';
            reader.onload = (event) => handleImport(event.target.result, format);
            reader.readAsText(file);
            e.target.value = '';
        });

        document.getElementById('export-json-btn').addEventListener('click', () => {
            const dataStr = JSON.stringify(cardCollection.map(c => c.data), null, 4);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'yugioh_collection.json'; a.click(); URL.revokeObjectURL(url);
        });

        document.getElementById('export-csv-btn').addEventListener('click', () => {
            const header = ['名前', '型番', 'レアリティ', '枚数', '備考'];
            const rows = cardCollection.map(c => header.map(field => {
                const value = c.data[field] || '';
                const strValue = String(value);
                return strValue.includes(',') ? `"${strValue}"` : strValue;
            }).join(','));
            const csvContent = [header.join(','), ...rows].join('\r\n');
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'yugioh_collection.csv'; a.click(); URL.revokeObjectURL(url);
        });

        // --- Settings ---
        document.getElementById('how-to-use-btn').addEventListener('click', () => howToUseModal.show());
        document.getElementById('settings-btn').addEventListener('click', () => settingsModal.show());

        darkModeToggle.addEventListener('change', (e) => {
            const theme = e.target.checked ? 'dark' : 'light';
            document.documentElement.setAttribute('data-bs-theme', theme);
            localStorage.setItem('theme', theme);
            applyTheme(); // 設定変更時に即時反映
        });

        const applyTheme = () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-bs-theme', savedTheme);
            darkModeToggle.checked = savedTheme === 'dark';

            const nav = document.querySelector('.navbar');
            if (nav) {
                if (savedTheme === 'dark') {
                    nav.classList.remove('navbar-light', 'bg-light');
                    nav.classList.add('navbar-dark', 'bg-dark');
                } else {
                    nav.classList.remove('navbar-dark', 'bg-dark');
                    nav.classList.add('navbar-light', 'bg-light');
                }
            }
        };
        applyTheme(); // Apply theme on initial load

        document.getElementById('delete-account-btn').addEventListener('click', async () => {
            if (!currentUser) return;
            if (!confirm('本当にアカウントを削除しますか？この操作は元に戻せません。')) return;
            if (!confirm('最終確認です。アカウントに紐づく全てのカードデータが永久に削除されます。よろしいですか？')) return;
            
            showLoading(true);
            try {
                // 1. Delete all card data from Firestore
                const userCardCollectionRef = getCollectionRef();
                const snapshot = await getDocs(query(userCardCollectionRef));
                const batch = writeBatch(db);
                snapshot.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();

                // 2. Delete the user account
                await deleteUser(currentUser);
                await signOut(auth);
                alert('正常に削除されました。');
                settingsModal.hide();
            } catch (error) {
                showLoading(false);
                if (error.code === 'auth/requires-recent-login') {
                    alert('アカウント削除の前に、再ログインが必要です。一度ログアウトしてから、再度ログインし直した上でもう一度お試しください。');
                } else {
                    alert(`アカウントの削除中にエラーが発生しました: ${error.message}`);
                }
                console.error(error);
            }
        });

        // --- Fetch from URL ---
        document.getElementById('fetch-btn').addEventListener('click', async () => {
            let url = document.getElementById('url').value;
            if (!url) { alert('URLを入力してください。'); return; }
            if (!url.includes('request_locale=ja')) { url += url.includes('?') ? '&request_locale=ja' : '?request_locale=ja'; }
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
            showLoading(true);
            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const text = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const cardName = doc.querySelector('#card_image_1')?.alt || '';
                if (!cardName) throw new Error("カード名が見つかりません。サイトの構造が変更された可能性があります。");
                document.getElementById('name').value = cardName;
                const setCodes = Array.from(doc.querySelectorAll('div.card_number')).map(div => div.textContent.trim());
                const rarities = Array.from(doc.querySelectorAll('div.rarity p')).map(p => p.textContent.trim());
                const choicesEl = document.getElementById('set-rarity-choices');
                choicesEl.innerHTML = '';
                if (setCodes.length > 0) {
                    setCodes.map((code, i) => ({ set_code: code, rarity: rarities[i] || '' })).forEach(data => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'btn btn-outline-primary btn-sm me-1 mb-1 set-choice-btn';
                        btn.dataset.setCode = data.set_code; btn.dataset.rarity = data.rarity;
                        btn.textContent = `${data.set_code} (${data.rarity})`;
                        choicesEl.appendChild(btn);
                    });
                } else { choicesEl.textContent = '収録情報が見つかりません。'; }
                document.getElementById('url').value = '';
            } catch (err) { alert(`エラー: ${err.message}`); console.error(err); } finally { showLoading(false); }
        });
        document.getElementById('set-rarity-choices').addEventListener('click', (e) => {
            if (e.target.classList.contains('set-choice-btn')) {
                document.getElementById('set_code').value = e.target.dataset.setCode;
                document.getElementById('rarity').value = e.target.dataset.rarity;
            }
        });
    </script>
</body>
</html>

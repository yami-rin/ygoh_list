<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>遊戯王画像API テスト</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-result {
            margin: 1rem 0;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-result img {
            max-width: 300px;
            height: auto;
            border: 2px solid #007bff;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        .loading {
            background-color: #fff3cd;
            border-color: #ffeaa7;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">遊戯王画像API テスト</h1>

        <div class="card mb-4">
            <div class="card-header">
                <h5>テストケース</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="card-id" class="form-label">カードID (cid)</label>
                    <input type="number" class="form-control" id="card-id" value="21967">
                </div>
                <button class="btn btn-primary" onclick="testAllAPIs()">全APIテスト</button>
            </div>
        </div>

        <h3>テスト結果</h3>
        <div id="results"></div>
    </div>

    <script>
        const testAPIs = [
            {
                name: '元のURL (encパラメータ付き)',
                getUrl: (cid) => `https://www.db.yugioh-card.com/yugiohdb/get_image.action?type=2&cid=${cid}&ciid=1&enc=4CGllVHuyOJeD-vrlwoqmA`
            },
            {
                name: 'get_image.action (encなし)',
                getUrl: (cid) => `https://www.db.yugioh-card.com/yugiohdb/get_image.action?type=2&cid=${cid}&ciid=1`
            },
            {
                name: 'card_image.action (現在使用中)',
                getUrl: (cid) => `https://www.db.yugioh-card.com/yugiohdb/card_image.action?cid=${cid}&request_locale=ja`
            },
            {
                name: 'card_image.action (type=1)',
                getUrl: (cid) => `https://www.db.yugioh-card.com/yugiohdb/card_image.action?cid=${cid}&type=1`
            },
            {
                name: 'get_image.action type=1',
                getUrl: (cid) => `https://www.db.yugioh-card.com/yugiohdb/get_image.action?type=1&cid=${cid}&ciid=1`
            }
        ];

        async function testImageURL(url, name) {
            return new Promise((resolve) => {
                const img = new Image();
                const startTime = Date.now();

                img.onload = () => {
                    const loadTime = Date.now() - startTime;
                    resolve({
                        success: true,
                        width: img.naturalWidth,
                        height: img.naturalHeight,
                        loadTime: loadTime,
                        url: url,
                        name: name
                    });
                };

                img.onerror = () => {
                    resolve({
                        success: false,
                        error: 'Failed to load image',
                        url: url,
                        name: name
                    });
                };

                img.src = url;
            });
        }

        async function testAllAPIs() {
            const cardId = document.getElementById('card-id').value;
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="alert alert-info">テスト実行中...</div>';

            const results = [];

            for (const api of testAPIs) {
                const url = api.getUrl(cardId);
                const result = await testImageURL(url, api.name);
                results.push(result);
            }

            displayResults(results);
        }

        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            results.forEach((result, index) => {
                const div = document.createElement('div');
                div.className = `test-result ${result.success ? 'success' : 'error'}`;

                if (result.success) {
                    div.innerHTML = `
                        <h5>✅ ${result.name}</h5>
                        <p><strong>URL:</strong> <code>${result.url}</code></p>
                        <p><strong>画像サイズ:</strong> ${result.width} x ${result.height}px</p>
                        <p><strong>読み込み時間:</strong> ${result.loadTime}ms</p>
                        <img src="${result.url}" alt="${result.name}" class="mt-2">
                    `;
                } else {
                    div.innerHTML = `
                        <h5>❌ ${result.name}</h5>
                        <p><strong>URL:</strong> <code>${result.url}</code></p>
                        <p><strong>エラー:</strong> ${result.error}</p>
                    `;
                }

                resultsDiv.appendChild(div);
            });

            // サマリーを追加
            const successCount = results.filter(r => r.success).length;
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'alert alert-primary mt-3';
            summaryDiv.innerHTML = `
                <h5>テスト結果サマリー</h5>
                <p>成功: ${successCount} / ${results.length}</p>
            `;
            resultsDiv.insertBefore(summaryDiv, resultsDiv.firstChild);
        }

        // ページロード時に自動テスト
        window.addEventListener('load', () => {
            testAllAPIs();
        });

        // よく使われるカードIDのクイックテスト
        const commonCardIds = [
            { id: 21967, name: 'テストカード1' },
            { id: 4001, name: 'ブラック・マジシャン' },
            { id: 5318, name: '青眼の白龍' },
            { id: 12206, name: '死者蘇生' }
        ];

        // クイックテストボタンを追加
        window.addEventListener('load', () => {
            const cardBody = document.querySelector('.card-body');
            const quickTestDiv = document.createElement('div');
            quickTestDiv.className = 'mt-3';
            quickTestDiv.innerHTML = '<h6>クイックテスト (有名カード)</h6>';

            commonCardIds.forEach(card => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-sm btn-outline-secondary me-2 mb-2';
                btn.textContent = `${card.name} (${card.id})`;
                btn.onclick = () => {
                    document.getElementById('card-id').value = card.id;
                    testAllAPIs();
                };
                quickTestDiv.appendChild(btn);
            });

            cardBody.appendChild(quickTestDiv);
        });
    </script>
</body>
</html>

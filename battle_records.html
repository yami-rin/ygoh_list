<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>戦績管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body{background-color:#f8f9fa}[data-bs-theme="dark"] body{background-color:#212529}.container-fluid{max-width:1400px}.card{margin-bottom:1.5rem}#loading-overlay,#app-loader{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.6);display:flex;justify-content:center;align-items:center;z-index:1060;color:white}#main-app{display:none}.stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border-radius:10px;padding:1.5rem;margin-bottom:1rem}.stat-card.win{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%)}.stat-card.lose{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%)}.record-row.win{background-color:rgba(40,167,69,0.1)}.record-row.lose{background-color:rgba(220,53,69,0.1)}.record-row.draw{background-color:rgba(255,193,7,0.1)}[data-bs-theme="dark"] .record-row.win{background-color:rgba(40,167,69,0.2)}[data-bs-theme="dark"] .record-row.lose{background-color:rgba(220,53,69,0.2)}[data-bs-theme="dark"] .record-row.draw{background-color:rgba(255,193,7,0.2)}@media(max-width:768px){.navbar-brand{font-size:1rem}.table{font-size:0.875rem}.stat-card{padding:1rem}}
    </style>
</head>
<body>
    <!-- App Loader -->
    <div id="app-loader">
        <div class="spinner-border" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="auth-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ログインまたは新規登録</h5>
                </div>
                <div class="modal-body">
                    <div id="auth-error" class="alert alert-danger" style="display: none;"></div>
                    <form id="auth-form">
                        <div class="mb-3">
                            <label for="email" class="form-label">メールアドレス</label>
                            <input type="email" class="form-control" id="email" required>
                            <small class="text-muted">ローカルモードの場合は「local」と入力</small>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">パスワード</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="button" id="login-btn" class="btn btn-primary">ログイン</button>
                            <button type="button" id="signup-btn" class="btn btn-secondary">新規登録</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Record Modal -->
    <div class="modal fade" id="record-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="record-modal-title">戦績を追加</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="record-form">
                        <input type="hidden" id="record-id">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="battle-date" class="form-label">対戦日 <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="battle-date" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="battle-format" class="form-label">対戦形式 <span class="text-danger">*</span></label>
                                <select class="form-select" id="battle-format" required>
                                    <option value="">選択してください</option>
                                    <option value="シングル">シングル</option>
                                    <option value="マッチ">マッチ（2本先取）</option>
                                    <option value="スイスドロー">スイスドロー</option>
                                    <option value="トーナメント">トーナメント</option>
                                    <option value="フリー対戦">フリー対戦</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="tournament-name" class="form-label">大会名</label>
                                <input type="text" class="form-control" id="tournament-name" placeholder="例: 週末大会">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="store-name" class="form-label">店舗名</label>
                                <input type="text" class="form-control" id="store-name" placeholder="例: カードショップ○○">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="my-deck" class="form-label">使用デッキ <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="my-deck" required placeholder="例: ブルーアイズ">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="opponent-deck" class="form-label">相手デッキ</label>
                                <input type="text" class="form-control" id="opponent-deck" placeholder="例: エルドリッチ">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="opponent-name" class="form-label">対戦相手</label>
                            <input type="text" class="form-control" id="opponent-name" placeholder="相手の名前（任意）">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">先攻後攻選択権</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="first-turn-choice" id="choice-me" value="me">
                                <label class="btn btn-outline-primary" for="choice-me">自分が選択</label>
                                <input type="radio" class="btn-check" name="first-turn-choice" id="choice-opponent" value="opponent">
                                <label class="btn btn-outline-secondary" for="choice-opponent">相手が選択</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">対戦結果 <span class="text-danger">*</span></label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="result" id="result-win" value="win" required>
                                <label class="btn btn-outline-success" for="result-win">
                                    <i class="bi bi-trophy"></i> 勝利
                                </label>
                                <input type="radio" class="btn-check" name="result" id="result-lose" value="lose">
                                <label class="btn btn-outline-danger" for="result-lose">
                                    <i class="bi bi-x-circle"></i> 敗北
                                </label>
                                <input type="radio" class="btn-check" name="result" id="result-draw" value="draw">
                                <label class="btn btn-outline-warning" for="result-draw">
                                    <i class="bi bi-pause-circle"></i> 引き分け
                                </label>
                            </div>
                        </div>
                        <div id="match-details-section" style="display: none;">
                            <h6 class="mb-3">各ゲーム詳細</h6>
                            <div class="card mb-2">
                                <div class="card-body p-2">
                                    <div class="row align-items-center">
                                        <div class="col-2"><strong>1戦目</strong></div>
                                        <div class="col-5">
                                            <select class="form-select form-select-sm" id="game1-first">
                                                <option value="">先攻/後攻</option>
                                                <option value="me">自分先攻</option>
                                                <option value="opponent">相手先攻</option>
                                            </select>
                                        </div>
                                        <div class="col-5">
                                            <select class="form-select form-select-sm" id="game1-result">
                                                <option value="">結果</option>
                                                <option value="win">勝利</option>
                                                <option value="lose">敗北</option>
                                                <option value="draw">引分</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card mb-2">
                                <div class="card-body p-2">
                                    <div class="row align-items-center">
                                        <div class="col-2"><strong>2戦目</strong></div>
                                        <div class="col-5">
                                            <select class="form-select form-select-sm" id="game2-first">
                                                <option value="">先攻/後攻</option>
                                                <option value="me">自分先攻</option>
                                                <option value="opponent">相手先攻</option>
                                            </select>
                                        </div>
                                        <div class="col-5">
                                            <select class="form-select form-select-sm" id="game2-result">
                                                <option value="">結果</option>
                                                <option value="win">勝利</option>
                                                <option value="lose">敗北</option>
                                                <option value="draw">引分</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card mb-2">
                                <div class="card-body p-2">
                                    <div class="row align-items-center">
                                        <div class="col-2"><strong>3戦目</strong></div>
                                        <div class="col-5">
                                            <select class="form-select form-select-sm" id="game3-first">
                                                <option value="">先攻/後攻</option>
                                                <option value="me">自分先攻</option>
                                                <option value="opponent">相手先攻</option>
                                            </select>
                                        </div>
                                        <div class="col-5">
                                            <select class="form-select form-select-sm" id="game3-result">
                                                <option value="">結果</option>
                                                <option value="win">勝利</option>
                                                <option value="lose">敗北</option>
                                                <option value="draw">引分</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="match-notes" class="form-label">試合内容・メモ</label>
                            <textarea class="form-control" id="match-notes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" id="save-record-btn" class="btn btn-primary">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app">
        <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4" data-bs-theme="light">
            <div class="container-fluid">
                <span class="navbar-brand">
                    <i class="bi bi-graph-up"></i> 戦績管理
                </span>
                <span id="firebase-status" class="badge bg-warning text-dark ms-2">接続中...</span>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarContent">
                    <div class="navbar-nav ms-auto d-flex flex-row flex-wrap gap-2 mt-2 mt-lg-0">
                        <a href="index.html" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-layers"></i> カード管理
                        </a>
                        <span class="navbar-text" id="user-email"></span>
                        <button id="logout-btn" class="btn btn-danger btn-sm">
                            <i class="bi bi-box-arrow-right"></i> ログアウト
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="container-fluid">
            <div id="loading-overlay" style="display: none;">
                <div class="spinner-border" role="status"></div>
            </div>

            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <h6>総対戦数</h6>
                        <h2 id="total-battles">0</h2>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card win">
                        <h6>勝利数</h6>
                        <h2 id="total-wins">0</h2>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card lose">
                        <h6>敗北数</h6>
                        <h2 id="total-loses">0</h2>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <h6>勝率</h6>
                        <h2 id="win-rate">0%</h2>
                    </div>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <form id="filter-form" class="row g-2">
                                <div class="col-md-3">
                                    <input type="text" class="form-control form-control-sm" id="filter-deck" placeholder="デッキ名で検索">
                                </div>
                                <div class="col-md-3">
                                    <input type="text" class="form-control form-control-sm" id="filter-opponent" placeholder="相手で検索">
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select form-select-sm" id="filter-result">
                                        <option value="">全ての結果</option>
                                        <option value="win">勝利のみ</option>
                                        <option value="lose">敗北のみ</option>
                                        <option value="draw">引き分けのみ</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <button type="submit" class="btn btn-info btn-sm w-100">
                                        <i class="bi bi-search"></i> 検索
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div class="col-md-4 text-end mt-3 mt-md-0">
                            <button class="btn btn-success" id="add-record-btn">
                                <i class="bi bi-plus-circle"></i> 戦績を追加
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Records Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">戦績一覧</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>日付</th>
                                    <th>大会/店舗</th>
                                    <th>使用デッキ</th>
                                    <th>相手デッキ</th>
                                    <th>形式</th>
                                    <th>結果</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="records-tbody">
                            </tbody>
                        </table>
                    </div>
                    <div id="no-records-message" class="text-center py-5" style="display: none;">
                        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                        <p class="mt-3">戦績がありません</p>
                        <button class="btn btn-primary" onclick="document.getElementById('add-record-btn').click()">
                            最初の戦績を追加
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, query, where, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAOYKalLUb2hbghrjQUS8AWzxpLExBT7aU",
            authDomain: "card-manager-4c86c.firebaseapp.com",
            projectId: "card-manager-4c86c",
            storageBucket: "card-manager-4c86c.firebasestorage.app",
            messagingSenderId: "1058357616781",
            appId: "1:1058357616781:web:f25db127e2824226d942c4",
            measurementId: "G-S4CCJC3HW9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setPersistence(auth, browserLocalPersistence);

        let currentUser = null;
        let battleRecords = [];
        let filteredRecords = [];
        let isLocalMode = false;

        const authModal = new bootstrap.Modal(document.getElementById('auth-modal'));
        const recordModal = new bootstrap.Modal(document.getElementById('record-modal'));

        const showLoading = (show) => document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            
            if (localStorage.getItem('isLocalMode') === 'true') {
                handleLocalMode();
                return;
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    handleUserLogin(user);
                } else if (isLocalMode) {
                    handleLocalMode();
                } else {
                    showAuthModal();
                }
            }, (error) => {
                console.error('Auth error:', error);
                const statusBadge = document.getElementById('firebase-status');
                if (statusBadge) {
                    statusBadge.textContent = `認証エラー: ${error.code}`;
                    statusBadge.className = 'badge bg-danger ms-2';
                }
            });
        });

        function setupEventListeners() {
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('signup-btn').addEventListener('click', handleSignup);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('add-record-btn').addEventListener('click', () => showRecordModal());
            document.getElementById('save-record-btn').addEventListener('click', saveRecord);
            document.getElementById('battle-format').addEventListener('change', (e) => {
                document.getElementById('match-details-section').style.display = 
                    (e.target.value === 'マッチ' || e.target.value === 'スイスドロー') ? 'block' : 'none';
            });
            document.getElementById('filter-form').addEventListener('submit', (e) => {
                e.preventDefault();
                applyFilters();
            });
        }

        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (email.toLowerCase() === 'local') {
                isLocalMode = true;
                localStorage.setItem('isLocalMode', 'true');
                handleLocalMode();
                return;
            }
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                document.getElementById('auth-error').style.display = 'none';
            } catch (error) {
                document.getElementById('auth-error').textContent = `ログインエラー: ${error.message}`;
                document.getElementById('auth-error').style.display = 'block';
            }
        }

        async function handleSignup() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                document.getElementById('auth-error').style.display = 'none';
            } catch (error) {
                document.getElementById('auth-error').textContent = `登録エラー: ${error.message}`;
                document.getElementById('auth-error').style.display = 'block';
            }
        }

        function handleLogout() {
            if (confirm('ログアウトしますか？')) {
                if (isLocalMode) {
                    isLocalMode = false;
                    localStorage.removeItem('isLocalMode');
                    currentUser = null;
                    battleRecords = [];
                    showAuthModal();
                } else {
                    signOut(auth);
                }
            }
        }

        function handleUserLogin(user) {
            currentUser = user;
            document.getElementById('user-email').textContent = user.email;
            authModal.hide();
            document.getElementById('app-loader').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            
            const statusBadge = document.getElementById('firebase-status');
            statusBadge.textContent = 'Firebase接続OK';
            statusBadge.className = 'badge bg-success ms-2';
            
            loadRecords();
        }

        function handleLocalMode() {
            isLocalMode = true;
            currentUser = { uid: 'local_user', email: 'ローカルモード' };
            document.getElementById('user-email').textContent = 'ローカルモード';
            authModal.hide();
            document.getElementById('app-loader').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            
            const statusBadge = document.getElementById('firebase-status');
            statusBadge.textContent = 'ローカルモード';
            statusBadge.className = 'badge bg-info ms-2';
            
            loadRecords();
        }

        function showAuthModal() {
            document.getElementById('app-loader').style.display = 'none';
            authModal.show();
        }

        function showRecordModal(record = null) {
            document.getElementById('record-modal-title').textContent = record ? '戦績を編集' : '戦績を追加';
            
            if (record) {
                document.getElementById('record-id').value = record.id;
                document.getElementById('battle-date').value = record.date;
                document.getElementById('battle-format').value = record.format;
                document.getElementById('tournament-name').value = record.tournament || '';
                document.getElementById('store-name').value = record.store || '';
                document.getElementById('my-deck').value = record.myDeck;
                document.getElementById('opponent-deck').value = record.opponentDeck || '';
                document.getElementById('opponent-name').value = record.opponent || '';
                
                if (record.firstTurnChoice) {
                    document.querySelector(`input[name="first-turn-choice"][value="${record.firstTurnChoice}"]`).checked = true;
                }
                document.querySelector(`input[name="result"][value="${record.result}"]`).checked = true;
                document.getElementById('match-notes').value = record.notes || '';
                
                if (record.format === 'マッチ' || record.format === 'スイスドロー') {
                    document.getElementById('match-details-section').style.display = 'block';
                    if (record.games) {
                        record.games.forEach(game => {
                            if (game.gameNumber && game.first) {
                                document.getElementById(`game${game.gameNumber}-first`).value = game.first;
                            }
                            if (game.gameNumber && game.result) {
                                document.getElementById(`game${game.gameNumber}-result`).value = game.result;
                            }
                        });
                    }
                }
            } else {
                document.getElementById('record-form').reset();
                document.getElementById('record-id').value = '';
                document.getElementById('battle-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('match-details-section').style.display = 'none';
            }
            
            recordModal.show();
        }

        async function saveRecord() {
            const recordId = document.getElementById('record-id').value;
            const format = document.getElementById('battle-format').value;
            
            const recordData = {
                date: document.getElementById('battle-date').value,
                format: format,
                myDeck: document.getElementById('my-deck').value,
                result: document.querySelector('input[name="result"]:checked')?.value,
                tournament: document.getElementById('tournament-name').value || null,
                store: document.getElementById('store-name').value || null,
                opponentDeck: document.getElementById('opponent-deck').value || null,
                opponent: document.getElementById('opponent-name').value || null,
                firstTurnChoice: document.querySelector('input[name="first-turn-choice"]:checked')?.value || null,
                notes: document.getElementById('match-notes').value || null,
                updatedAt: new Date().toISOString()
            };
            
            // マッチ戦の詳細
            if (format === 'マッチ' || format === 'スイスドロー') {
                const games = [];
                for (let i = 1; i <= 3; i++) {
                    const first = document.getElementById(`game${i}-first`).value;
                    const result = document.getElementById(`game${i}-result`).value;
                    if (first || result) {
                        games.push({
                            gameNumber: i,
                            first: first || null,
                            result: result || null
                        });
                    }
                }
                if (games.length > 0) {
                    recordData.games = games;
                }
            }
            
            // Validation
            if (!recordData.date || !recordData.format || !recordData.myDeck || !recordData.result) {
                alert('必須項目を入力してください');
                return;
            }
            
            showLoading(true);
            
            try {
                if (isLocalMode) {
                    let records = JSON.parse(localStorage.getItem('battleRecords') || '[]');
                    if (recordId) {
                        const index = records.findIndex(r => r.id === recordId);
                        if (index !== -1) {
                            records[index] = { ...records[index], ...recordData };
                        }
                    } else {
                        recordData.id = Date.now().toString();
                        recordData.createdAt = new Date().toISOString();
                        records.push(recordData);
                    }
                    localStorage.setItem('battleRecords', JSON.stringify(records));
                } else {
                    // Remove null values for Firestore
                    const cleanData = Object.fromEntries(
                        Object.entries(recordData).filter(([_, v]) => v != null)
                    );
                    cleanData.userId = currentUser.uid;
                    
                    if (recordId) {
                        await updateDoc(doc(db, 'battleRecords', recordId), cleanData);
                    } else {
                        cleanData.createdAt = new Date().toISOString();
                        await addDoc(collection(db, 'battleRecords'), cleanData);
                    }
                }
                
                recordModal.hide();
                await loadRecords();
            } catch (error) {
                console.error('Error saving record:', error);
                alert('保存中にエラーが発生しました: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function loadRecords() {
            showLoading(true);
            
            try {
                if (isLocalMode) {
                    battleRecords = JSON.parse(localStorage.getItem('battleRecords') || '[]');
                } else {
                    const q = query(collection(db, 'battleRecords'), where('userId', '==', currentUser.uid));
                    const snapshot = await getDocs(q);
                    battleRecords = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                }
                
                battleRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
                applyFilters();
                updateStatistics();
            } catch (error) {
                console.error('Error loading records:', error);
                battleRecords = [];
                applyFilters();
                updateStatistics();
            } finally {
                showLoading(false);
            }
        }

        async function deleteRecord(recordId) {
            if (!confirm('この戦績を削除しますか？')) return;
            
            showLoading(true);
            
            try {
                if (isLocalMode) {
                    let records = JSON.parse(localStorage.getItem('battleRecords') || '[]');
                    records = records.filter(r => r.id !== recordId);
                    localStorage.setItem('battleRecords', JSON.stringify(records));
                } else {
                    await deleteDoc(doc(db, 'battleRecords', recordId));
                }
                
                loadRecords();
            } catch (error) {
                console.error('Error deleting record:', error);
                alert('削除中にエラーが発生しました');
            } finally {
                showLoading(false);
            }
        }

        function applyFilters() {
            const deck = document.getElementById('filter-deck').value.toLowerCase();
            const opponent = document.getElementById('filter-opponent').value.toLowerCase();
            const result = document.getElementById('filter-result').value;
            
            filteredRecords = battleRecords.filter(record => {
                if (deck && !record.myDeck.toLowerCase().includes(deck) && 
                    !(record.opponentDeck && record.opponentDeck.toLowerCase().includes(deck))) {
                    return false;
                }
                if (opponent && !(record.opponent && record.opponent.toLowerCase().includes(opponent)) &&
                    !(record.opponentDeck && record.opponentDeck.toLowerCase().includes(opponent))) {
                    return false;
                }
                if (result && record.result !== result) {
                    return false;
                }
                return true;
            });
            
            displayRecords();
        }

        function displayRecords() {
            const tbody = document.getElementById('records-tbody');
            const noRecordsMsg = document.getElementById('no-records-message');
            
            if (filteredRecords.length === 0) {
                tbody.innerHTML = '';
                noRecordsMsg.style.display = 'block';
                return;
            }
            
            noRecordsMsg.style.display = 'none';
            
            tbody.innerHTML = filteredRecords.map(record => {
                const resultBadge = {
                    win: '<span class="badge bg-success">勝</span>',
                    lose: '<span class="badge bg-danger">負</span>',
                    draw: '<span class="badge bg-warning">引</span>'
                };
                
                return `
                    <tr class="record-row ${record.result}">
                        <td>${record.date}</td>
                        <td>${record.tournament || record.store || '-'}</td>
                        <td><strong>${record.myDeck}</strong></td>
                        <td>${record.opponentDeck || '-'}</td>
                        <td>${record.format}</td>
                        <td>${resultBadge[record.result]}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="showRecordModal(battleRecords.find(r => r.id === '${record.id}'))">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRecord('${record.id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateStatistics() {
            const total = battleRecords.length;
            const wins = battleRecords.filter(r => r.result === 'win').length;
            const loses = battleRecords.filter(r => r.result === 'lose').length;
            const winRate = total > 0 ? ((wins / (wins + loses)) * 100).toFixed(1) : 0;
            
            document.getElementById('total-battles').textContent = total;
            document.getElementById('total-wins').textContent = wins;
            document.getElementById('total-loses').textContent = loses;
            document.getElementById('win-rate').textContent = `${winRate}%`;
        }

        // Make functions globally accessible
        window.showRecordModal = showRecordModal;
        window.deleteRecord = deleteRecord;
        window.battleRecords = battleRecords;
    </script>
</body>
</html>
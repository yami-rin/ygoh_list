<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>„Ç´„Éº„ÉâÁÆ°ÁêÜ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="mobile-responsive.css">
    <style>
        body { background-color: #f8f9fa; }
        [data-bs-theme="dark"] body { background-color: #212529; }
        .container-fluid { max-width: 1400px; }
        .card { margin-bottom: 1.5rem; }
        .table-responsive { max-height: 500px; }
        #loading-overlay, #app-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1060;
            color: white;
        }
        .set-choice-btn { cursor: pointer; }
        #main-app { display: none; } /* Hide app until logged in */
        
        /* Tag display optimization */
        .tag-cell {
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
        }
        .tag-cell:hover {
            white-space: normal;
            word-wrap: break-word;
        }
        .tag-cell:hover .edit-tags-btn {
            display: inline-block !important;
        }

        /* Fix for mobile tag/rarity suggestions - Remove problematic CSS */
        
        /* Draggable tags styles */
        .draggable-tag {
            cursor: move;
            transition: background-color 0.2s;
        }
        .draggable-tag:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }
        .draggable-tag.dragging {
            opacity: 0.5;
        }
        .drag-over {
            border-top: 2px solid #007bff;
        }
        
        /* Achievement badge styles */
        .achievement-summary {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .achievement-summary:hover {
            background: rgba(0, 123, 255, 0.1);
            transform: translateX(5px);
        }
        .achievement-progress {
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }
        .achievement-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #dee2e6;
            transition: all 0.3s;
        }
        .achievement-dot.unlocked {
            background: #28a745;
            box-shadow: 0 0 4px rgba(40, 167, 69, 0.5);
        }
        .achievement-details {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
        }
        .achievement-details.show {
            display: block;
            animation: slideDown 0.3s;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .achievement-badge {
            position: relative;
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 500;
            margin: 0.25rem;
            cursor: help;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .achievement-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .achievement-badge.locked {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: #adb5bd;
            opacity: 0.6;
        }
        .achievement-badge.bronze {
            background: linear-gradient(135deg, #cd7f32 0%, #a0522d 100%);
            color: white;
        }
        .achievement-badge.silver {
            background: linear-gradient(135deg, #c0c0c0 0%, #808080 100%);
            color: white;
        }
        .achievement-badge.gold {
            background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%);
            color: #333;
            animation: shine 3s infinite;
        }
        .achievement-badge.platinum {
            background: linear-gradient(135deg, #e5e4e2 0%, #bbb 100%);
            color: #333;
            animation: shine 2s infinite;
        }
        .achievement-badge.diamond {
            background: linear-gradient(135deg, #b9f2ff 0%, #00d4ff 100%);
            color: white;
            animation: sparkle 2s infinite;
        }
        .achievement-badge.mythic {
            background: linear-gradient(135deg, #ff00ff 0%, #00ffff 50%, #ffff00 100%);
            color: white;
            animation: rainbow 3s infinite;
        }
        @keyframes rainbow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
        @keyframes sparkle {
            0%, 100% { box-shadow: 0 0 10px rgba(185, 242, 255, 0.8); }
            50% { box-shadow: 0 0 20px rgba(0, 212, 255, 1); }
        }
        @keyframes shine {
            0% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
            100% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
        }
        
        /* Rarity bar styles */
        .rarity-bar {
            height: 100px;
            flex: 0 0 auto;
            min-width: 40px;
            background: linear-gradient(to top, var(--bar-color) 0%, var(--bar-color) var(--bar-height), transparent var(--bar-height));
            position: relative;
            border-radius: 4px 4px 0 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding: 4px;
        }
        .rarity-bar-label {
            font-size: 0.7rem;
            margin-top: 4px;
            text-align: center;
        }
        .rarity-bar-count {
            font-weight: bold;
            font-size: 0.9rem;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        /* Rarity bars container */
        #rarity-bars {
            display: flex;
            gap: 0.25rem;
            align-items: flex-end;
            justify-content: flex-start;
            min-height: 120px;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 5px;
            width: 100%;
            max-width: 100%;
        }
        
        /* Rarity chart container */
        #rarity-chart-container {
            width: 100%;
            overflow: hidden;
            position: relative;
        }
        
        /* Custom scrollbar for rarity bars */
        #rarity-bars::-webkit-scrollbar {
            height: 6px;
        }
        
        #rarity-bars::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }
        
        #rarity-bars::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
        }
        
        #rarity-bars::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.5);
        }
        
        /* Performance optimizations for mobile */
        @media (max-width: 768px) {
            /* Optimize animations for mobile */
            * {
                -webkit-animation-duration: 0.2s !important;
                animation-duration: 0.2s !important;
                -webkit-transform: translateZ(0);
                transform: translateZ(0);
            }

            /* Reduce shadow complexity on mobile */
            .card, .modal-content, .btn {
                box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important;
            }

            /* Simplify table for performance */
            .table-responsive {
                -webkit-overflow-scrolling: touch;
            }

            .table td {
                padding: 0.25rem !important;
                font-size: 0.875rem;
            }

            /* Hide non-essential columns on mobile */
            .tag-cell {
                display: none !important;
            }
        }

        /* Mobile responsive for rarity bars */
        @media (max-width: 768px) {
            #rarity-bars {
                gap: 0.15rem;
                -webkit-overflow-scrolling: touch;
                justify-content: flex-start;
                flex-wrap: nowrap;
            }
            
            .rarity-bar {
                min-width: 35px;
                height: 80px;
                padding: 2px;
            }
            
            .rarity-bar-label {
                font-size: 0.6rem;
                margin-top: 2px;
            }
            
            .rarity-bar-count {
                font-size: 0.75rem;
            }
        }
        
        @media (max-width: 576px) {
            #rarity-chart-container {
                margin-top: 0.5rem !important;
                padding: 0 5px;
                max-width: 100%;
            }
            
            #rarity-bars {
                gap: 0.1rem;
                min-height: 100px;
                padding: 0 2px 5px 2px;
                max-width: calc(100vw - 40px);
                margin: 0 auto;
            }
            
            .rarity-bar {
                min-width: 30px;
                height: 70px;
                padding: 1px;
                border-radius: 3px 3px 0 0;
            }
            
            .rarity-bar-label {
                font-size: 0.55rem;
                margin-top: 1px;
                line-height: 1;
            }
            
            .rarity-bar-count {
                font-size: 0.65rem;
                line-height: 1;
            }
        }
        
        @media (max-width: 400px) {
            #rarity-chart-container {
                padding: 0 3px;
            }
            
            #rarity-bars {
                gap: 2px;
                min-height: 90px;
                max-width: calc(100vw - 30px);
            }
            
            .rarity-bar {
                min-width: 25px;
                height: 60px;
            }
            
            .rarity-bar-label {
                font-size: 0.5rem;
                word-break: break-all;
            }
            
            .rarity-bar-count {
                font-size: 0.6rem;
            }
        }
        
        /* Milestone notification styles */
        .milestone-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1070;
            animation: slideIn 0.5s, slideOut 0.5s 4.5s;
            animation-fill-mode: forwards;
        }
        @keyframes slideIn {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }
        @keyframes slideOut {
            from { transform: translateX(0); }
            to { transform: translateX(400px); }
        }
        
        /* Fun dashboard styles */
        .mission-item {
            transition: all 0.3s;
            cursor: pointer;
        }
        .mission-item:hover {
            background: rgba(0, 123, 255, 0.1);
        }
        .mission-item.completed {
            background: rgba(40, 167, 69, 0.1);
            text-decoration: line-through;
        }
        .mission-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        /* Custom theme styles */
        body.theme-light-blue {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }
        body.theme-mint {
            background: linear-gradient(135deg, #c8e6c9 0%, #81c784 100%);
        }
        body.theme-peach {
            background: linear-gradient(135deg, #ffccbc 0%, #ffab91 100%);
        }
        body.theme-ocean {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        body.theme-forest {
            background: linear-gradient(135deg, #0ba360 0%, #3cba92 100%);
        }
        body.theme-sunset {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        body.theme-galaxy {
            background: linear-gradient(135deg, #4776E6 0%, #8E54E9 100%);
        }
        body.theme-cherry {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }
        body.theme-midnight {
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: #e0e0e0;
        }
        body.theme-sakura {
            background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);
        }
        body.theme-fire {
            background: linear-gradient(135deg, #ff9a56 0%, #ff6a88 50%, #ff2d55 100%);
        }
        body.theme-aurora {
            background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 50%, #00d2ff 100%);
        }
        body.theme-neon {
            background: linear-gradient(135deg, #f953c6 0%, #b91d73 100%);
            color: #fff;
        }
        body.theme-cosmic {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f953c6 100%);
        }
        body.theme-rainbow {
            background: linear-gradient(135deg, #ff0000 0%, #ff7f00 17%, #ffff00 33%, #00ff00 50%, #0000ff 67%, #4b0082 83%, #9400d3 100%);
        }
        body.theme-holographic {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 25%, #ffeaa7 50%, #dfe6e9 75%, #a8edea 100%);
            background-size: 400% 400%;
            animation: holographic-shift 8s ease infinite;
        }
        body.theme-dragon-soul {
            background: linear-gradient(135deg, #f83600 0%, #f9d423 50%, #f83600 100%);
            background-size: 200% 200%;
            animation: dragon-pulse 5s ease infinite;
        }
        body.theme-legendary {
            background: linear-gradient(135deg, #ffd700 0%, #ff6347 25%, #ff1493 50%, #00ced1 75%, #ffd700 100%);
            background-size: 300% 300%;
            animation: legendary-shift 10s ease infinite;
        }
        
        @keyframes holographic-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes dragon-pulse {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes legendary-shift {
            0% { background-position: 0% 50%; }
            33% { background-position: 100% 50%; }
            66% { background-position: 50% 100%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Frame Effects */
        body.frame-gold .card {
            border: 3px solid gold !important;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }
        body.frame-rainbow .card {
            border: 3px solid transparent !important;
            background: linear-gradient(white, white) padding-box,
                       linear-gradient(45deg, red, orange, yellow, green, blue, indigo, violet) border-box;
            animation: rainbow-border 3s linear infinite;
        }
        body.frame-diamond .card {
            border: 3px solid silver !important;
            box-shadow: 0 0 20px rgba(192, 192, 192, 0.8);
            position: relative;
        }
        body.frame-fire .card {
            border: 3px solid #ff4500 !important;
            box-shadow: 0 0 20px rgba(255, 69, 0, 0.6);
            animation: fire-glow 2s ease-in-out infinite;
        }
        body.frame-ice .card {
            border: 3px solid #00bfff !important;
            box-shadow: 0 0 20px rgba(0, 191, 255, 0.6);
        }
        body.frame-electric .card {
            border: 3px solid #ffff00 !important;
            box-shadow: 0 0 15px rgba(255, 255, 0, 0.8);
            animation: electric-pulse 1s linear infinite;
        }
        
        /* Additional Frame Styles */
        body.frame-simple .card {
            border: 2px solid #333 !important;
        }
        body.frame-bold .card {
            border: 4px solid #000 !important;
        }
        body.frame-dotted .card {
            border: 3px dotted #666 !important;
        }
        body.frame-silver .card {
            border: 3px solid #C0C0C0 !important;
            box-shadow: 0 0 10px rgba(192, 192, 192, 0.5);
        }
        body.frame-nature .card {
            border: 3px solid #228B22 !important;
            box-shadow: 0 0 15px rgba(34, 139, 34, 0.4);
        }
        body.frame-plasma .card {
            border: 3px solid #8A2BE2 !important;
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.6);
            animation: plasma-glow 2s ease-in-out infinite;
        }
        body.frame-crystal .card {
            border: 3px solid #87CEEB !important;
            box-shadow: 0 0 25px rgba(135, 206, 235, 0.7), inset 0 0 10px rgba(255, 255, 255, 0.3);
        }
        body.frame-legendary .card {
            border: 4px solid transparent !important;
            background: linear-gradient(white, white) padding-box,
                       linear-gradient(45deg, gold, #ff6347, #ff1493, gold) border-box;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            animation: legendary-shimmer 3s linear infinite;
        }
        body.frame-mythic .card {
            border: 4px solid transparent !important;
            background: linear-gradient(white, white) padding-box,
                       linear-gradient(90deg, #9400D3, #4B0082, #0000FF, #00FFFF, #0000FF, #4B0082, #9400D3) border-box;
            box-shadow: 0 0 35px rgba(148, 0, 211, 0.8);
            animation: mythic-pulse 4s ease-in-out infinite;
        }
        
        /* Background Patterns */
        body.bg-stars::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="10" cy="10" r="1" fill="white" opacity="0.5"/><circle cx="30" cy="20" r="1" fill="white" opacity="0.7"/><circle cx="50" cy="15" r="1.5" fill="white" opacity="0.6"/><circle cx="70" cy="25" r="1" fill="white" opacity="0.8"/><circle cx="90" cy="10" r="1" fill="white" opacity="0.5"/></svg>');
            background-repeat: repeat;
            pointer-events: none;
            z-index: -1;
            opacity: 0.3;
        }
        body.bg-clouds {
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 100"><ellipse cx="50" cy="50" rx="40" ry="20" fill="white" opacity="0.2"/><ellipse cx="150" cy="30" rx="50" ry="25" fill="white" opacity="0.15"/></svg>');
            background-size: 200px 100px;
            background-repeat: repeat;
        }
        body.bg-geometric::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255,255,255,.1) 35px, rgba(255,255,255,.1) 70px);
            pointer-events: none;
            z-index: -1;
        }
        body.bg-gradient {
            background: linear-gradient(270deg, #a8edea, #fed6e3, #ffd3b6, #ffaaa5);
            background-size: 800% 800%;
            animation: gradient-shift 15s ease infinite;
        }
        body.bg-particles {
            position: relative;
            overflow: hidden;
        }
        body.bg-waves::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%230099ff" fill-opacity="0.1" d="M0,32L48,53.3C96,75,192,117,288,122.7C384,128,480,96,576,90.7C672,85,768,107,864,128C960,149,1056,171,1152,165.3C1248,160,1344,128,1392,112L1440,96L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>');
            background-repeat: repeat-x;
            background-position: bottom;
            pointer-events: none;
            z-index: -1;
        }
        
        /* Animations */
        @keyframes rainbow-border {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
        @keyframes fire-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 69, 0, 0.6); }
            50% { box-shadow: 0 0 30px rgba(255, 140, 0, 0.8); }
        }
        @keyframes electric-pulse {
            0%, 100% { box-shadow: 0 0 15px rgba(255, 255, 0, 0.8); }
            50% { box-shadow: 0 0 25px rgba(255, 255, 0, 1); }
        }
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Additional Background Styles */
        body.bg-dots {
            background-image: radial-gradient(circle, #333 1px, transparent 1px);
            background-size: 20px 20px;
        }
        body.bg-stripes {
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255, 255, 255, 0.1) 10px,
                rgba(255, 255, 255, 0.1) 20px
            );
        }
        body.bg-checker {
            background-image: 
                linear-gradient(45deg, #ccc 25%, transparent 25%), 
                linear-gradient(-45deg, #ccc 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #ccc 75%), 
                linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        body.bg-hexagon {
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><polygon points="50,10 90,30 90,70 50,90 10,70 10,30" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></svg>');
            background-size: 100px 100px;
        }
        body.bg-circuit {
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M10,10 L30,10 L30,30 L50,30 M70,30 L90,30 L90,50 M10,70 L30,70 L30,90 L50,90" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/><circle cx="50" cy="30" r="3" fill="rgba(255,255,255,0.2)"/><circle cx="50" cy="90" r="3" fill="rgba(255,255,255,0.2)"/></svg>');
            background-size: 100px 100px;
        }
        body.bg-galaxy {
            background: radial-gradient(ellipse at center, #1e3c72 0%, #2a5298 50%, #0e1538 100%);
        }
        body.bg-aurora {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #667eea 75%, #764ba2 100%);
            background-size: 400% 400%;
            animation: aurora-shift 10s ease infinite;
        }
        body.bg-crystal {
            background: linear-gradient(135deg, #667eea 0%, rgba(118, 75, 162, 0.5) 50%, #667eea 100%),
                        repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255,255,255,.05) 35px, rgba(255,255,255,.05) 70px);
        }
        body.bg-matrix {
            background: #000;
            background-image: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                #0F0 2px,
                #0F0 3px
            );
            background-size: 100% 20px;
            animation: matrix-rain 5s linear infinite;
        }
        body.bg-nebula {
            background: radial-gradient(ellipse at top left, #ff00ff 0%, transparent 50%),
                        radial-gradient(ellipse at bottom right, #00ffff 0%, transparent 50%),
                        radial-gradient(ellipse at center, #1e3c72 0%, #0e1538 100%);
        }
        body.bg-dimension {
            background: linear-gradient(45deg, #1e3c72, #2a5298, #7e8aa2, #2a5298, #1e3c72);
            background-size: 500% 500%;
            animation: dimension-shift 20s ease infinite;
        }
        body.bg-void {
            background: radial-gradient(circle at center, #0a0a0a 0%, #000 50%, #000 100%);
        }
        body.bg-infinity {
            background: conic-gradient(from 0deg at 50% 50%, #667eea, #764ba2, #f093fb, #f5576c, #667eea);
            animation: infinity-rotate 10s linear infinite;
        }
        
        /* Additional animations for backgrounds and frames */
        @keyframes aurora-shift {
            0% { background-position: 0% 0%; }
            50% { background-position: 100% 100%; }
            100% { background-position: 0% 0%; }
        }
        @keyframes matrix-rain {
            0% { background-position: 0 0; }
            100% { background-position: 0 20px; }
        }
        @keyframes dimension-shift {
            0% { background-position: 0% 50%; }
            25% { background-position: 100% 50%; }
            50% { background-position: 100% 100%; }
            75% { background-position: 0% 100%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes infinity-rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes plasma-glow {
            0% { box-shadow: 0 0 20px rgba(138, 43, 226, 0.6); }
            50% { box-shadow: 0 0 30px rgba(138, 43, 226, 0.9), 0 0 50px rgba(138, 43, 226, 0.4); }
            100% { box-shadow: 0 0 20px rgba(138, 43, 226, 0.6); }
        }
        @keyframes legendary-shimmer {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }
        @keyframes mythic-pulse {
            0% { box-shadow: 0 0 35px rgba(148, 0, 211, 0.8); }
            50% { box-shadow: 0 0 50px rgba(148, 0, 211, 1), 0 0 70px rgba(0, 255, 255, 0.5); }
            100% { box-shadow: 0 0 35px rgba(148, 0, 211, 0.8); }
        }
        
        /* Icon Styles */
        body.icon-crown .collector-rank::after {
            content: 'üëë';
            margin-left: 5px;
        }
        body.icon-star .collector-rank::after {
            content: '‚≠ê';
            margin-left: 5px;
        }
        body.icon-dragon .collector-rank::after {
            content: 'üêâ';
            margin-left: 5px;
        }
        body.icon-phoenix .collector-rank::after {
            content: 'üî•ü¶Ö';
            margin-left: 5px;
        }
        body.icon-sword .collector-rank::after {
            content: '‚öîÔ∏è';
            margin-left: 5px;
        }
        
        /* Shop modal styles */
        .shop-item {
            border: 2px solid transparent;
            transition: all 0.3s;
            cursor: pointer;
        }
        .shop-item:hover {
            border-color: #ffc107;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .shop-item.purchased {
            background: #e8f5e9;
            border-color: #4caf50;
        }
        .shop-item.active {
            border-color: #007bff;
            background: #e3f2fd;
        }
        .shop-item.locked {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .shop-item.locked:hover {
            transform: none;
            border-color: transparent;
        }
        
        /* Point animation */
        @keyframes pointGain {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-30px) scale(1.5); opacity: 0; }
        }
        .point-animation {
            position: fixed;
            color: #ffc107;
            font-weight: bold;
            font-size: 1.5rem;
            z-index: 9999;
            pointer-events: none;
            animation: pointGain 1s ease-out;
        }
        
        /* Table header responsive styles */
        .table th {
            white-space: nowrap;
            min-width: fit-content;
        }
        
        /* Ensure navbar buttons have consistent height */
        .navbar-nav .btn,
        .navbar-nav .dropdown > .btn {
            height: 38px;
            display: inline-flex;
            align-items: center;
        }
        
        /* Pagination controls responsive */
        #pagination-controls,
        #pagination-controls-bottom {
            font-size: 0.9rem;
        }

        /* Tap quantity input styles */
        .tap-quantity-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .tap-quantity-display {
            font-size: 1.5rem;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
            padding: 0.5rem;
            border: 2px solid #dee2e6;
            border-radius: 0.375rem;
            background: white;
        }
        [data-bs-theme="dark"] .tap-quantity-display {
            background: var(--bs-dark);
            border-color: var(--bs-gray-700);
        }
        .tap-quantity-btn {
            width: 44px;
            height: 44px;
            font-size: 1.25rem;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Mobile responsive styles */
        @media (max-width: 768px) {
            .navbar-brand { font-size: 1rem; }
            .navbar-text { display: none !important; }
            .btn-group-mobile {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }
            .table { font-size: 0.875rem; }

            /* Fix modal positioning on mobile - Always in viewport */
            .modal-dialog {
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                margin: 0 !important;
                max-width: calc(100% - 2rem);
                max-height: calc(100vh - 2rem);
                width: calc(100% - 2rem);
            }
            .modal-dialog-centered {
                min-height: auto !important;
                align-items: center !important;
            }
            .modal-dialog-centered::before {
                display: none !important;
            }
            .modal-dialog-scrollable {
                height: auto !important;
                max-height: calc(100vh - 2rem);
            }
            .modal-content {
                max-height: calc(100vh - 2rem);
                overflow-y: auto;
            }
            .modal {
                overflow-y: auto !important;
            }
            /* Ensure modals are visible */
            .modal.show {
                padding-right: 0 !important;
            }
            .modal-backdrop {
                position: fixed;
            }
            body.modal-open {
                position: fixed;
                width: 100%;
                overflow-y: scroll;
            }
            .table th {
                padding: 0.5rem 0.25rem;
                font-size: 0.8rem;
            }
            .table th i {
                font-size: 0.7rem;
            }
            .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
            .modal-dialog { margin: 0.5rem; }
            .nav-tabs .nav-link { padding: 0.5rem 0.75rem; font-size: 0.875rem; }
            .dropdown-menu { font-size: 0.875rem; }
        }
        
        @media (max-width: 576px) {
            .container-fluid { padding: 0.5rem; }
            .card-body { padding: 1rem; }
            .table-responsive { 
                max-height: 400px;
                overflow-x: auto;
            }
            .table th {
                padding: 0.4rem 0.2rem;
                font-size: 0.75rem;
            }
            .table td {
                padding: 0.4rem 0.2rem;
                font-size: 0.8rem;
            }
            
            /* Mobile card list improvements */
            /* Card name column - allow wrapping */
            .table tbody td:nth-child(2) {
                max-width: 100px;
                word-wrap: break-word;
                word-break: break-word;
                white-space: normal;
                line-height: 1.3;
                font-size: 0.75rem;
            }
            
            /* Set code column */
            .table tbody td:nth-child(3) {
                font-size: 0.7rem;
                max-width: 70px;
                word-break: break-all;
            }
            
            /* Show rarity on mobile */
            .table thead th:nth-child(4),
            .table tbody td:nth-child(4) {
                display: table-cell !important;
                font-size: 0.65rem;
                max-width: 50px;
            }
            
            /* Quantity column */
            .table tbody td:nth-child(5) {
                font-size: 0.8rem;
                font-weight: bold;
                text-align: center;
                min-width: 30px;
            }
            
            /* Hide tags column on mobile */
            .table thead th:nth-child(6),
            .table tbody td:nth-child(6) {
                display: none !important;
            }
            
            /* Action buttons column */
            .table tbody td:last-child {
                min-width: 60px;
            }
            
            /* Make action buttons smaller */
            .table .btn-sm {
                font-size: 0.6rem;
                padding: 0.2rem 0.25rem;
                margin: 0 1px;
            }
            
            .table .btn-sm i {
                font-size: 0.7rem;
            }
            
            .navbar-toggler { padding: 0.25rem 0.5rem; }
            
            /* Pagination controls on small screens */
            #pagination-controls span,
            #pagination-controls-bottom span {
                font-size: 0.8rem;
            }
            #pagination-controls .btn-group,
            #pagination-controls-bottom .btn-group {
                flex-wrap: nowrap;
            }
            .d-flex.justify-content-between.align-items-center.mb-2 {
                flex-direction: column;
                gap: 0.5rem;
            }
            .d-flex.justify-content-between.align-items-center.mb-2 > * {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* Profile modal styles */
        .icon-select {
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            padding: 0;
            transition: all 0.2s;
        }
        
        .icon-select.active {
            background-color: var(--bs-primary);
            color: white;
            border-color: var(--bs-primary);
            transform: scale(1.1);
        }
        
        #profile-icon {
            font-size: 4rem;
            animation: bounce 2s ease-in-out infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Card type selector styles */
        .card-type-selector {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 8px;
        }

        .main-type-tab {
            font-size: 0.85rem;
            font-weight: 500;
            border-radius: 20px !important;
            transition: all 0.3s ease;
        }

        .main-type-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .main-type-tab[data-category="monster"] {
            color: #6c757d;
        }

        .main-type-tab[data-category="monster"].active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
        }

        .main-type-tab[data-category="spell"] {
            color: #28a745;
        }

        .main-type-tab[data-category="spell"].active {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border-color: #28a745;
        }

        .main-type-tab[data-category="trap"] {
            color: #dc3545;
        }

        .main-type-tab[data-category="trap"].active {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            border-color: #fa709a;
        }

        .sub-type-container {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 6px;
            margin-top: 8px;
        }

        .sub-type-btn {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 15px;
            transition: all 0.2s ease;
        }

        .sub-type-btn:hover {
            transform: scale(1.05);
        }

        .sub-type-btn.active {
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .btn-outline-purple {
            color: #8b5cf6;
            border-color: #8b5cf6;
        }

        .btn-outline-purple:hover {
            color: #fff;
            background-color: #8b5cf6;
            border-color: #8b5cf6;
        }

        .btn-outline-purple.active {
            color: #fff;
            background-color: #8b5cf6;
            border-color: #8b5cf6;
        }

        /* Additional button styles for card types */
        .sub-type-btn.btn-outline-info.active {
            background-color: #17a2b8;
            border-color: #17a2b8;
            color: #fff;
        }

        .sub-type-btn.btn-outline-success.active {
            background-color: #28a745;
            border-color: #28a745;
            color: #fff;
        }

        .sub-type-btn.btn-outline-primary.active {
            background-color: #007bff;
            border-color: #007bff;
            color: #fff;
        }

        .sub-type-btn.btn-outline-dark.active {
            background-color: #343a40;
            border-color: #343a40;
            color: #fff;
        }

        .sub-type-btn.btn-outline-secondary.active {
            background-color: #6c757d;
            border-color: #6c757d;
            color: #fff;
        }

        .sub-type-btn.btn-outline-warning.active {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #212529;
        }

        .sub-type-btn.btn-outline-danger.active {
            background-color: #dc3545;
            border-color: #dc3545;
            color: #fff;
        }

        .sub-type-group {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Race selector styles */
        .race-selector {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 8px;
            margin-top: 5px;
        }

        .race-btn {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .race-btn:hover {
            transform: scale(1.05);
        }

        .race-btn.active {
            font-weight: bold;
            background-color: #007bff;
            border-color: #007bff;
            color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .clear-race-btn {
            margin-bottom: 5px;
        }

        /* Search mode (AND/OR) toggle styles */
        .btn-check:checked + .btn-outline-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
            color: #fff;
        }

        .btn-check:checked + .btn-outline-success {
            background-color: #198754;
            border-color: #198754;
            color: #fff;
        }

        /* Smooth transition for search mode buttons */
        .btn-group .btn-outline-primary,
        .btn-group .btn-outline-success {
            transition: all 0.2s ease-in-out;
        }

        /* Mobile responsive adjustments for search mode */
        @media (max-width: 768px) {
            #advanced-search .btn-group {
                width: 100%;
            }

            #advanced-search .btn-group .btn {
                flex: 1;
                font-size: 0.875rem;
            }

            #search-mode-description {
                display: block;
                margin-top: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Full screen loader -->
    <div id="app-loader">
        <div class="spinner-border" style="width: 3rem; height: 3rem;" role="status"><span class="visually-hidden">Loading...</span></div>
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="auth-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">„É≠„Ç∞„Ç§„É≥„Åæ„Åü„ÅØÊñ∞Ë¶èÁôªÈå≤</h5></div>
            <div class="modal-body">
                <div id="auth-error" class="alert alert-danger" style="display: none;"></div>
                <form id="auth-form">
                    <div class="mb-3"><label for="email" class="form-label">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label><input type="email" class="form-control" id="email" required></div>
                    <div class="mb-3"><label for="password" class="form-label">„Éë„Çπ„ÉØ„Éº„Éâ</label><input type="password" class="form-control" id="password" required></div>
                    <div class="alert alert-info small">
                        <i class="bi bi-info-circle"></i> <strong>Êñ∞Ë¶èÁôªÈå≤„Å´„Å§„ÅÑ„Å¶</strong><br>
                        „Éª„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅÆÁ¢∫Ë™ç„ÅåÂøÖË¶Å„Åß„Åô<br>
                        „ÉªÁ¢∫Ë™ç„É°„Éº„É´„ÅØ<strong>Ëø∑ÊÉë„É°„Éº„É´</strong>„Å´ÂàÜÈ°û„Åï„Çå„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô<br>
                        „ÉªÈÄÅ‰ø°ÂÖÉ: <code>noreply@ygoh-9bcf6.firebaseapp.com</code>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="button" id="login-btn" class="btn btn-primary">„É≠„Ç∞„Ç§„É≥</button>
                        <button type="button" id="signup-btn" class="btn btn-secondary">Êñ∞Ë¶èÁôªÈå≤</button>
                    </div>
                </form>
            </div>
        </div></div>
    </div>

    <!-- Edit Card Modal -->
    <div class="modal fade" id="edit-card-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">„Ç´„Éº„ÉâÊÉÖÂ†±„ÅÆÁ∑®ÈõÜ</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="edit-form">
                    <input type="hidden" id="edit-card-id">
                    <div class="mb-3"><label class="form-label">ÂêçÂâç</label><input type="text" id="edit-name" class="form-control" readonly disabled></div>
                    <div class="mb-3"><label class="form-label">ÂûãÁï™</label><input type="text" id="edit-set-code" class="form-control" readonly disabled></div>
                    <div class="mb-3"><label class="form-label">„É¨„Ç¢„É™„ÉÜ„Ç£</label><input type="text" id="edit-rarity" class="form-control" readonly disabled></div>
                    <div class="mb-3">
                        <label for="edit-quantity" class="form-label">ÊûöÊï∞</label>
                        <div id="edit-quantity-input-container">
                            <input type="number" id="edit-quantity" class="form-control" min="1" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">„Çø„Ç∞</label>
                        <div id="edit-card-tags-container" class="mb-2"></div>
                        <div id="edit-tag-choices-container"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">„Ç≠„É£„É≥„Çª„É´</button>
                <button type="button" id="save-edit-btn" class="btn btn-primary">Â§âÊõ¥„Çí‰øùÂ≠ò</button>
            </div>
        </div></div>
    </div>

    <!-- Card Detail Modal -->
    <div class="modal fade" id="card-detail-modal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-info-circle"></i> „Ç´„Éº„ÉâË©≥Á¥∞ÊÉÖÂ†±</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="card-detail-content">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Èñâ„Åò„Çã</button>
                </div>
            </div>
        </div>
    </div>

    <!-- How to Use Modal -->
    <div class="modal fade" id="how-to-use-modal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">‰Ωø„ÅÑÊñπ„Ç¨„Ç§„Éâ</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> <strong>ÂÖ¨Âºè„Éá„Éº„Çø„Éô„Éº„Çπ</strong>Ôºö
                    <a href="https://www.db.yugioh-card.com/yugiohdb/card_search.action" target="_blank" class="alert-link">
                        ÈÅäÊàØÁéã„Ç™„Éï„Ç£„Ç∑„É£„É´„Ç´„Éº„Éâ„Éá„Éº„Çø„Éô„Éº„Çπ„ÇíÈñã„Åè <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                </div>

                <!-- „ÇØ„Ç§„ÉÉ„ÇØ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
                <div class="alert alert-light">
                    <h6 class="alert-heading"><i class="bi bi-compass"></i> „ÇØ„Ç§„ÉÉ„ÇØ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥</h6>
                    <div class="d-flex flex-wrap gap-2">
                        <a href="#guide-start" class="btn btn-sm btn-outline-primary">Âàù„ÇÅ„Å¶„ÅÆÊñπ„Å∏</a>
                        <a href="#guide-register" class="btn btn-sm btn-outline-primary">„Ç´„Éº„ÉâÁôªÈå≤</a>
                        <a href="#guide-lists" class="btn btn-sm btn-outline-primary">„É™„Çπ„ÉàÁÆ°ÁêÜ</a>
                        <a href="#guide-tags" class="btn btn-sm btn-outline-primary">„Çø„Ç∞Ê©üËÉΩ</a>
                        <a href="#guide-gamification" class="btn btn-sm btn-outline-primary">„Ç≤„Éº„Éü„Éï„Ç£„Ç±„Éº„Ç∑„Éß„É≥</a>
                        <a href="#guide-data" class="btn btn-sm btn-outline-primary">„Éá„Éº„ÇøÁÆ°ÁêÜ</a>
                        <a href="#guide-advanced" class="btn btn-sm btn-outline-primary">‰æøÂà©Ê©üËÉΩ</a>
                        <a href="#guide-mobile" class="btn btn-sm btn-outline-primary">„É¢„Éê„Ç§„É´</a>
                    </div>
                </div>

                <h5 class="mt-4 mb-3" id="guide-start"><i class="bi bi-1-circle-fill text-primary"></i> Âàù„ÇÅ„Å¶„ÅÆÊñπ„Å∏</h5>
                <div class="ms-3">
                    <h6><i class="bi bi-person-plus"></i> „Ç¢„Ç´„Ç¶„É≥„Éà‰ΩúÊàê</h6>
                    <ol>
                        <li>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„ÄåÊñ∞Ë¶èÁôªÈå≤„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ</li>
                        <li>„Ç¢„Ç´„Ç¶„É≥„Éà„Åå‰ΩúÊàê„Åï„Çå„ÄÅËá™Âãï„Åß„É≠„Ç∞„Ç§„É≥„Åï„Çå„Åæ„Åô</li>
                        <li>„Éá„Éº„Çø„ÅØ„ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò„Åï„Çå„ÄÅ„Å©„ÅÆÁ´ØÊú´„Åã„Çâ„Åß„ÇÇ„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩ„Åß„Åô</li>
                    </ol>
                    <div class="alert alert-warning">
                        <small><i class="bi bi-exclamation-triangle"></i> <strong>„É≠„Éº„Ç´„É´„É¢„Éº„Éâ</strong>Ôºö„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Å´„Äålocal„Äç„Å®ÂÖ•Âäõ„Åô„Çã„Å®„ÄÅ„Éá„Éº„Çø„Çí„ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò„Åõ„Åö„Éñ„É©„Ç¶„Ç∂ÂÜÖ„Åß„ÅÆ„ÅøÁÆ°ÁêÜ„Åß„Åç„Åæ„Åô</small>
                    </div>
                </div>

                <h5 class="mt-4 mb-3" id="guide-register"><i class="bi bi-2-circle-fill text-primary"></i> „Ç´„Éº„Éâ„ÅÆÁôªÈå≤ÊñπÊ≥ï</h5>
                <div class="ms-3">
                    <h6><i class="bi bi-search"></i> ÊñπÊ≥ï1ÔºöÂÖ¨ÂºèDB„Åã„ÇâÊ§úÁ¥¢</h6>
                    <ol>
                        <li>„Äå„Ç´„Éº„ÉâÂêç„ÅßÊ§úÁ¥¢„ÄçÊ¨Ñ„Å´„Ç´„Éº„ÉâÂêç„ÇíÂÖ•ÂäõÔºà‰æãÔºö„Äå„Ç´„É°„É™„Ç¢„ÄçÔºâ</li>
                        <li>„ÄåÊ§úÁ¥¢„Äç„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØÔºà<i class="bi bi-clock-history"></i>„Éú„Çø„É≥„ÅßÂâçÂõû„ÅÆÊ§úÁ¥¢„ÇÇÂèØËÉΩÔºâ</li>
                        <li>Ê§úÁ¥¢ÁµêÊûú„Åã„ÇâÁõÆÁöÑ„ÅÆ„Ç´„Éº„Éâ„ÇíÈÅ∏Êäû</li>
                        <li>„Ç´„Éº„ÉâÊÉÖÂ†±„ÅåËá™Âãï„ÅßÂÖ•Âäõ„Åï„Çå„Åæ„Åô</li>
                        <li>ÊûöÊï∞„ÇíË®≠ÂÆöÔºà„É¢„Éê„Ç§„É´„Åß„ÅØ„Çø„ÉÉ„ÉóÂºèÂÖ•Âäõ„ÇÇÂèØËÉΩÔºâ</li>
                        <li>„Çø„Ç∞„ÇíÈÅ∏ÊäûÔºà‰ªªÊÑèÔºâ</li>
                        <li>„Äå„Ç´„Éº„Éâ„ÇíËøΩÂä†„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ</li>
                    </ol>

                    <h6><i class="bi bi-link-45deg"></i> ÊñπÊ≥ï2ÔºöURL„Åã„ÇâË™≠„ÅøËæº„Åø</h6>
                    <ol>
                        <li>ÂÖ¨ÂºèDB„Åß„Ç´„Éº„Éâ„ÇíÊ§úÁ¥¢„Åó„ÄÅ„Ç´„Éº„ÉâË©≥Á¥∞„Éö„Éº„Ç∏„ÇíÈñã„Åè</li>
                        <li>URL„Çí„Ç≥„Éî„ÉºÔºà‰æãÔºöhttps://www.db.yugioh-card.com/yugiohdb/...)</li>
                        <li>„ÄåÂÖ¨ÂºèDB URL„ÄçÊ¨Ñ„Å´Ë≤º„Çä‰ªò„Åë„Å¶„ÄåË™≠Ëæº„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ</li>
                        <li>Ë§áÊï∞„ÅÆÂûãÁï™„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„ÄÅË°®Á§∫„Åï„Çå„Çã„Éú„Çø„É≥„Åã„ÇâÈÅ∏Êäû</li>
                    </ol>

                    <h6><i class="bi bi-pencil"></i> ÊñπÊ≥ï3ÔºöÊâãÂãïÂÖ•Âäõ</h6>
                    <p>„Ç´„Éº„ÉâÂêç„ÄÅÂûãÁï™„ÄÅ„É¨„Ç¢„É™„ÉÜ„Ç£„ÇíÁõ¥Êé•ÂÖ•Âäõ„Åó„Å¶ÁôªÈå≤„Åß„Åç„Åæ„Åô</p>

                    <div class="alert alert-success">
                        <small><i class="bi bi-lightbulb"></i> <strong>„Éí„É≥„Éà</strong>Ôºö„Äå<i class="bi bi-arrow-counterclockwise"></i>„Äç„Éú„Çø„É≥„ÅßÂâçÂõû„ÅÆÁôªÈå≤ÂÜÖÂÆπ„ÇíÂæ©ÂÖÉ„Åß„Åç„Åæ„Åô</small>
                    </div>
                </div>

                <h5 class="mt-4 mb-3" id="guide-lists"><i class="bi bi-3-circle-fill text-primary"></i> „É™„Çπ„Éà„ÅÆÁ®ÆÈ°û</h5>
                <div class="ms-3">
                    <h6><i class="bi bi-collection"></i> ÊâÄÊåÅ„Ç´„Éº„Éâ</h6>
                    <ul>
                        <li>ÂÆüÈöõ„Å´ÊâÄÊåÅ„Åó„Å¶„ÅÑ„Çã„Ç´„Éº„Éâ„ÇíÁÆ°ÁêÜ</li>
                        <li>ÊûöÊï∞„ÇíË®òÈå≤„Åó„ÄÅ„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥ÂÖ®‰Ωì„ÇíÊääÊè°</li>
                        <li>Áµ±Ë®àÊÉÖÂ†±ÔºàÂêàË®àÊûöÊï∞„ÄÅÁ®ÆÈ°ûÊï∞„ÄÅ„É¨„Ç¢„É™„ÉÜ„Ç£ÂàÜÂ∏ÉÔºâ„ÇíË°®Á§∫</li>
                    </ul>

                    <h6><i class="bi bi-star"></i> „Ç¶„Ç£„ÉÉ„Ç∑„É•„É™„Çπ„Éà</h6>
                    <ul>
                        <li>‰ªäÂæåÂÖ•Êâã„Åó„Åü„ÅÑ„Ç´„Éº„Éâ„ÇíÁÆ°ÁêÜ</li>
                        <li>ÂÖ•Êâã„Åó„Åü„Çâ„Äå<i class="bi bi-check-circle"></i>„Äç„Éú„Çø„É≥„ÅßÊâÄÊåÅ„Ç´„Éº„Éâ„Å∏ÁßªÂãï</li>
                        <li>Ê¨≤„Åó„ÅÑ„Ç´„Éº„Éâ„É™„Çπ„Éà„Çí‰ΩúÊàê„Åó„Å¶ÂÖ±Êúâ„ÇÇÂèØËÉΩ</li>
                    </ul>

                    <h6><i class="bi bi-arrow-left-right"></i> „É™„Çπ„Éà„ÅÆÂàá„ÇäÊõø„Åà</h6>
                    <p>ÁîªÈù¢‰∏äÈÉ®„ÅÆ„Çø„Éñ„Åß„ÄåÊâÄÊåÅ„Ç´„Éº„Éâ„Äç„Å®„Äå„Ç¶„Ç£„ÉÉ„Ç∑„É•„É™„Çπ„Éà„Äç„ÇíÁ∞°Âçò„Å´Âàá„ÇäÊõø„Åà„Çâ„Çå„Åæ„Åô</p>
                </div>

                <h5 class="mt-4 mb-3" id="guide-tags"><i class="bi bi-4-circle-fill text-primary"></i> „Çø„Ç∞Ê©üËÉΩ</h5>
                <div class="ms-3">
                    <h6><i class="bi bi-tags"></i> „Çø„Ç∞„ÅÆ‰ΩúÊàê„ÉªÁÆ°ÁêÜ</h6>
                    <ul>
                        <li>„Äå„Çø„Ç∞„Äç„Éú„Çø„É≥„Åã„Çâ„Çø„Ç∞ÁÆ°ÁêÜÁîªÈù¢„ÇíÈñã„Åè</li>
                        <li>„Ç´„É≥„ÉûÂå∫Âàá„Çä„ÅßË§áÊï∞„ÅÆ„Çø„Ç∞„ÇíÂêåÊôÇ‰ΩúÊàêÂèØËÉΩ</li>
                        <li>„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„Åß„Çø„Ç∞„ÅÆÈ†ÜÁï™„ÇíÂ§âÊõ¥ÂèØËÉΩ</li>
                        <li>„Éö„É≥„Ç¢„Ç§„Ç≥„É≥„Åß„Çø„Ç∞Âêç„ÇíÁ∑®ÈõÜÂèØËÉΩ</li>
                    </ul>

                    <h6><i class="bi bi-bookmark-plus"></i> „Çø„Ç∞„ÅÆ‰Ωø„ÅÑÊñπ</h6>
                    <ul>
                        <li>„Ç´„Éº„ÉâÁôªÈå≤„ÉªÁ∑®ÈõÜÊôÇ„Å´„Çø„Ç∞„ÇíÈÅ∏Êäû</li>
                        <li>„Ç´„Éº„Éâ‰∏ÄË¶ß„Åß„Çø„Ç∞„Çí„Éõ„Éê„Éº„Åô„Çã„Å®„Éö„É≥„Ç¢„Ç§„Ç≥„É≥„ÅåË°®Á§∫„Åï„Çå„ÄÅ„ÇØ„É™„ÉÉ„ÇØ„ÅßÁ∑®ÈõÜ</li>
                        <li>Ë§áÊï∞„Ç´„Éº„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Çø„Ç∞„Çí‰∏ÄÊã¨ËøΩÂä†„ÉªÂâäÈô§</li>
                        <li>Ê§úÁ¥¢„Éï„Ç©„Éº„É†„Åß„Çø„Ç∞„ÇíÊåáÂÆö„Åó„Å¶Áµû„ÇäËæº„Åø</li>
                    </ul>

                    <div class="alert alert-info">
                        <small><i class="bi bi-info-circle"></i> ‰æãÔºö„Äå„Éá„ÉÉ„Ç≠Áî®„Äç„Äå„Éà„É¨„Éº„ÉâÁî®„Äç„Äå‰øùÁÆ°Áî®„Äç„ÄåÈ´òÈ°ç„Ç´„Éº„Éâ„Äç„Å™„Å©</small>
                    </div>
                </div>

                <h5 class="mt-4 mb-3" id="guide-gamification"><i class="bi bi-5-circle-fill text-primary"></i> „Ç≤„Éº„Éü„Éï„Ç£„Ç±„Éº„Ç∑„Éß„É≥Ê©üËÉΩ</h5>
                <div class="ms-3">
                    <h6><i class="bi bi-stars"></i> ‰ªäÊó•„ÅÆ„ÉÅ„É£„É¨„É≥„Ç∏</h6>
                    <ul>
                        <li><strong>„Éá„Ç§„É™„Éº„Éü„ÉÉ„Ç∑„Éß„É≥</strong>ÔºöÊØéÊó•Êõ¥Êñ∞„Åï„Çå„Çã„Éü„ÉÉ„Ç∑„Éß„É≥„Çí„ÇØ„É™„Ç¢„Åó„Å¶„Éù„Ç§„É≥„ÉàÁç≤Âæó</li>
                        <li><strong>ÈÄ£Á∂öÁôªÈå≤</strong>ÔºöÊØéÊó•„Ç´„Éº„Éâ„ÇíÁôªÈå≤„Åó„Å¶ÈÄ£Á∂öË®òÈå≤„Çí‰º∏„Å∞„Åù„ÅÜ</li>
                        <li><strong>ÈÄ±ÈñìÁõÆÊ®ô</strong>ÔºöÁõÆÊ®ôÊûöÊï∞„ÇíË®≠ÂÆö„Åó„Å¶ÈÅîÊàê„ÇíÁõÆÊåá„Åù„ÅÜÔºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÂ§âÊõ¥ÂèØÔºâ</li>
                    </ul>

                    <h6><i class="bi bi-trophy"></i> „É©„É≥„Ç≠„É≥„Ç∞„Ç∑„Çπ„ÉÜ„É†</h6>
                    <ul>
                        <li>ÊâÄÊåÅ„Ç´„Éº„ÉâÊï∞„Åß‰ªñ„ÅÆ„É¶„Éº„Ç∂„Éº„Å®Á´∂‰∫â</li>
                        <li>„É™„Ç¢„É´„Çø„Ç§„É†„É©„É≥„Ç≠„É≥„Ç∞Êõ¥Êñ∞</li>
                        <li>TOP10„É¶„Éº„Ç∂„Éº„ÅÆË°®Á§∫</li>
                    </ul>

                    <h6><i class="bi bi-award"></i> ÂÆüÁ∏æ„Ç∑„Çπ„ÉÜ„É†</h6>
                    <ul>
                        <li>Êßò„ÄÖ„Å™Êù°‰ª∂„ÇíÈÅîÊàê„Åó„Å¶„Éê„ÉÉ„Ç∏„ÇíÁç≤Âæó</li>
                        <li>„Éñ„É≠„É≥„Ç∫„Åã„Çâ„Éü„Ç∑„ÉÉ„ÇØ„Åæ„Åß„ÅÆ„É¨„Ç¢Â∫¶</li>
                        <li>„Éó„É≠„Éï„Ç£„Éº„É´„ÅßÂÆüÁ∏æ„ÇíÂÖ¨Èñã</li>
                    </ul>

                    <h6><i class="bi bi-shop"></i> „Éù„Ç§„É≥„Éà„Ç∑„Éß„ÉÉ„Éó</h6>
                    <ul>
                        <li>Áç≤Âæó„Åó„Åü„Éù„Ç§„É≥„Éà„Åß„ÉÜ„Éº„Éû„ÇÑ„Éï„É¨„Éº„É†„ÇíË≥ºÂÖ•</li>
                        <li>ÁîªÈù¢„ÅÆ„Ç´„Çπ„Çø„Éû„Ç§„Ç∫„ÅåÂèØËÉΩ</li>
                        <li>ÁâπÊÆä„Ç®„Éï„Çß„ÇØ„Éà„ÇÑËÉåÊôØ„ÇíÈÅ©Áî®</li>
                    </ul>
                </div>

                <h5 class="mt-4 mb-3" id="guide-data"><i class="bi bi-6-circle-fill text-primary"></i> „Éá„Éº„ÇøÁÆ°ÁêÜ</h5>
                <div class="ms-3">
                    <h6><i class="bi bi-download"></i> „Ç®„ÇØ„Çπ„Éù„Éº„Éà</h6>
                    <ul>
                        <li><strong>JSONÂΩ¢Âºè</strong>ÔºöÂÖ®„Éá„Éº„Çø„ÇíÂÆåÂÖ®„Å´„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÔºà„Çø„Ç∞ÊÉÖÂ†±„ÇÇÂê´„ÇÄÔºâ</li>
                        <li><strong>CSVÂΩ¢Âºè</strong>ÔºöExcel„ÅßÁ∑®ÈõÜ„ÉªÈñ≤Ë¶ßÂèØËÉΩ</li>
                        <li>„Äå„Éá„Éº„ÇøÁÆ°ÁêÜ„Äç„Éú„Çø„É≥„Åã„ÇâÂÆüË°å</li>
                    </ul>

                    <h6><i class="bi bi-upload"></i> „Ç§„É≥„Éù„Éº„Éà</h6>
                    <ul>
                        <li>JSON/CSV„Éï„Ç°„Ç§„É´„Åã„Çâ„Éá„Éº„Çø„Çí‰∏ÄÊã¨ÁôªÈå≤</li>
                        <li>ÈáçË§á„Åô„Çã„Ç´„Éº„Éâ„ÅØÊûöÊï∞„ÅåËá™Âãï„ÅßÂä†ÁÆó</li>
                        <li>‰ªñ„ÅÆ„Ç¢„Éó„É™„Åã„Çâ„ÅÆÁßªË°å„ÇÇÁ∞°Âçò</li>
                    </ul>

                    <h6><i class="bi bi-shield-check"></i> „Éá„Éº„Çø„ÅÆÂÆâÂÖ®ÊÄß</h6>
                    <ul>
                        <li>Firebase„Å´„Çà„Çã„Çª„Ç≠„É•„Ç¢„Å™„ÇØ„É©„Ç¶„Éâ‰øùÂ≠ò</li>
                        <li>ÂÆöÊúüÁöÑ„Å™„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÇíÊé®Â•®</li>
                        <li>„Ç¢„Ç´„Ç¶„É≥„ÉàÂâäÈô§ÊôÇ„ÅØÂÖ®„Éá„Éº„Çø„ÅåÂâäÈô§„Åï„Çå„Çã„ÅÆ„ÅßÊ≥®ÊÑè</li>
                    </ul>
                </div>

                <h5 class="mt-4 mb-3" id="guide-advanced"><i class="bi bi-7-circle-fill text-primary"></i> ‰æøÂà©„Å™Ê©üËÉΩ</h5>
                <div class="ms-3">
                    <h6><i class="bi bi-sort-down"></i> ‰∏¶„Å≥Êõø„Åà„ÉªÊ§úÁ¥¢</h6>
                    <ul>
                        <li>„Ç´„Éº„Éâ‰∏ÄË¶ß„ÅÆ„Éò„ÉÉ„ÉÄ„Éº„Çí„ÇØ„É™„ÉÉ„ÇØ„Åß‰∏¶„Å≥Êõø„Åà</li>
                        <li>ÂêçÂâç„ÄÅÂûãÁï™„ÄÅ„É¨„Ç¢„É™„ÉÜ„Ç£„ÄÅ„Çø„Ç∞„ÅßÊ§úÁ¥¢</li>
                        <li>Ë§áÊï∞Êù°‰ª∂„Åß„ÅÆÁµû„ÇäËæº„Åø„ÅåÂèØËÉΩ</li>
                    </ul>

                    <h6><i class="bi bi-check2-square"></i> ‰∏ÄÊã¨Á∑®ÈõÜ</h6>
                    <ul>
                        <li>„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅßË§áÊï∞„Ç´„Éº„Éâ„ÇíÈÅ∏Êäû</li>
                        <li>„ÄåÂÖ®„Å¶ÈÅ∏Êäû„Äç„Éú„Çø„É≥„Åß‰∏ÄÊã¨ÈÅ∏Êäû„ÇÇÂèØËÉΩ</li>
                        <li>„Çø„Ç∞„ÅÆ‰∏ÄÊã¨ËøΩÂä†„ÉªÂâäÈô§</li>
                        <li>Ë§áÊï∞„Ç´„Éº„Éâ„ÅÆ‰∏ÄÊã¨ÂâäÈô§</li>
                    </ul>

                    <h6><i class="bi bi-clock-history"></i> Â±•Ê≠¥Ê©üËÉΩ</h6>
                    <ul>
                        <li>ÂâçÂõû„ÅÆÊ§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíË®òÊÜ∂</li>
                        <li>ÂâçÂõû„ÅÆÁôªÈå≤ÂÜÖÂÆπ„ÇíÂæ©ÂÖÉ</li>
                        <li>Ë®≠ÂÆö„ÅßË°®Á§∫/ÈùûË°®Á§∫„ÇíÂàá„ÇäÊõø„Åà</li>
                    </ul>

                    <h6><i class="bi bi-bar-chart"></i> Áµ±Ë®àÊÉÖÂ†±</h6>
                    <ul>
                        <li>„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„ÅÆÁ∑èÊûöÊï∞„Å®Á®ÆÈ°ûÊï∞</li>
                        <li>„É¨„Ç¢„É™„ÉÜ„Ç£Âà•„ÅÆÂàÜÂ∏É„Ç∞„É©„Éï</li>
                        <li>‰ªäÊó•„ÅÆËøΩÂä†ÊûöÊï∞</li>
                        <li>„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥ÈÄ≤ÊçóÁéá</li>
                    </ul>

                    <h6><i class="bi bi-moon-stars"></i> „Ç´„Çπ„Çø„Éû„Ç§„Ç∫</h6>
                    <ul>
                        <li>„ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÂØæÂøú</li>
                        <li>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅÆË°®Á§∫/ÈùûË°®Á§∫</li>
                        <li>Áµ±Ë®àÊÉÖÂ†±„ÅÆË°®Á§∫/ÈùûË°®Á§∫</li>
                        <li>„ÉÜ„Éº„Éû„ÇÑ„Éï„É¨„Éº„É†„ÅÆ„Ç´„Çπ„Çø„Éû„Ç§„Ç∫Ôºà„Éù„Ç§„É≥„Éà„Ç∑„Éß„ÉÉ„ÉóÔºâ</li>
                    </ul>
                </div>

                <h5 class="mt-4 mb-3" id="guide-mobile"><i class="bi bi-8-circle-fill text-primary"></i> „É¢„Éê„Ç§„É´ÂØæÂøú</h5>
                <div class="ms-3">
                    <h6><i class="bi bi-phone"></i> „Çπ„Éû„Éº„Éà„Éï„Ç©„É≥ÊúÄÈÅ©Âåñ</h6>
                    <ul>
                        <li>„É¨„Çπ„Éù„É≥„Ç∑„Éñ„Éá„Ç∂„Ç§„É≥„Åß„Å©„ÅÆÁ´ØÊú´„Åß„ÇÇÂø´ÈÅ©</li>
                        <li>„Çø„ÉÉ„ÉÅÊìç‰Ωú„Å´ÊúÄÈÅ©Âåñ„Åï„Çå„Åü„Éú„Çø„É≥„Çµ„Ç§„Ç∫</li>
                        <li>„Çπ„ÉØ„Ç§„Éó„Åß„Çπ„ÇØ„É≠„Éº„É´ÂèØËÉΩ„Å™„ÉÜ„Éº„Éñ„É´</li>
                    </ul>

                    <h6><i class="bi bi-hand-index"></i> „Çø„ÉÉ„ÉóÂºèÊûöÊï∞ÂÖ•Âäõ</h6>
                    <ul>
                        <li>Ë®≠ÂÆö„Åß„ÄåÊûöÊï∞ÂÖ•Âäõ„Çí„Çø„ÉÉ„ÉóÂºè„Å´„Åô„Çã„Äç„ÇíON</li>
                        <li>„Ç≠„Éº„Éú„Éº„Éâ„Çí‰Ωø„Çè„Åö„Å´ÊûöÊï∞„ÇíË®≠ÂÆö</li>
                        <li>„Éû„Ç§„Éä„Çπ/„Éó„É©„Çπ„Éú„Çø„É≥„ÅßÁ∞°ÂçòË™øÊï¥</li>
                        <li>„É™„Çª„ÉÉ„Éà„Éú„Çø„É≥„Åß1Êûö„Å´Êàª„Çã</li>
                    </ul>

                    <h6><i class="bi bi-tablet"></i> „Çø„Éñ„É¨„ÉÉ„ÉàÂØæÂøú</h6>
                    <ul>
                        <li>iPad„ÇÑAndroid„Çø„Éñ„É¨„ÉÉ„Éà„Å´ÊúÄÈÅ©Âåñ</li>
                        <li>ÁîªÈù¢„Çµ„Ç§„Ç∫„Å´Âøú„Åò„Åü„É¨„Ç§„Ç¢„Ç¶„ÉàË™øÊï¥</li>
                        <li>Ê®™Âêë„Åç„É¢„Éº„Éâ„Åß„ÇÇÂø´ÈÅ©„Å´Âà©Áî®ÂèØËÉΩ</li>
                    </ul>

                    <div class="alert alert-success">
                        <small><i class="bi bi-check-circle"></i> <strong>PWAÂØæÂøú</strong>Ôºö„Éõ„Éº„É†ÁîªÈù¢„Å´ËøΩÂä†„Åó„Å¶„Ç¢„Éó„É™„ÅÆ„Çà„ÅÜ„Å´‰ΩøÁî®ÂèØËÉΩ</small>
                    </div>
                </div>

                <div class="alert alert-primary mt-4">
                    <h6 class="alert-heading"><i class="bi bi-question-circle"></i> „ÅäÂõ∞„Çä„ÅÆÂ†¥Âêà</h6>
                    <ul class="mb-0">
                        <li>„É≠„Ç∞„Ç§„É≥„Åß„Åç„Å™„ÅÑ ‚Üí „Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂøò„Çå„ÅüÂ†¥Âêà„ÅØÂÜçÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ</li>
                        <li>„Éá„Éº„Çø„ÅåÊ∂à„Åà„Åü ‚Üí ÂÆöÊúüÁöÑ„Å´„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åß„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÇíÂèñ„Çã„Åì„Å®„ÇíÊé®Â•®</li>
                        <li>„Ç´„Éº„Éâ„ÅåÊ§úÁ¥¢„Åß„Åç„Å™„ÅÑ ‚Üí ÂÖ¨ÂºèDB„ÅÆURL„ÇíÁõ¥Êé•ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</li>
                        <li>„Ç®„É©„Éº„ÅåÁô∫Áîü„Åô„Çã ‚Üí „Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <a href="https://www.db.yugioh-card.com/yugiohdb/card_search.action" target="_blank" class="btn btn-primary">
                    <i class="bi bi-box-arrow-up-right"></i> ÂÖ¨ÂºèDB„ÇíÈñã„Åè
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Èñâ„Åò„Çã</button>
            </div>
        </div></div>
    </div>

    <!-- Ranking Modal -->
    <div class="modal fade" id="ranking-modal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-trophy"></i> „É©„É≥„Ç≠„É≥„Ç∞</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Ranking Tabs -->
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#total-cards-ranking" type="button">
                                <i class="bi bi-stack"></i> Á∑è„Ç´„Éº„ÉâÊûöÊï∞
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#unique-cards-ranking" type="button">
                                <i class="bi bi-collection"></i> Á®ÆÈ°ûÊï∞
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#streak-ranking" type="button">
                                <i class="bi bi-fire"></i> „Çπ„Éà„É™„Éº„ÇØ
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#points-ranking" type="button">
                                <i class="bi bi-coin"></i> Áç≤Âæó„Éù„Ç§„É≥„Éà
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Ranking Tab Content -->
                    <div class="tab-content">
                        <!-- Total Cards Ranking -->
                        <div class="tab-pane fade show active" id="total-cards-ranking" role="tabpanel">
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle"></i> Á∑è„Ç´„Éº„ÉâÊûöÊï∞„ÅÆ„É©„É≥„Ç≠„É≥„Ç∞
                            </div>
                            <div class="list-group" id="total-cards-ranking-list">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Ë™≠„ÅøËæº„Åø‰∏≠...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Unique Cards Ranking -->
                        <div class="tab-pane fade" id="unique-cards-ranking" role="tabpanel">
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle"></i> „Ç´„Éº„ÉâÁ®ÆÈ°ûÊï∞„ÅÆ„É©„É≥„Ç≠„É≥„Ç∞
                            </div>
                            <div class="list-group" id="unique-cards-ranking-list">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Ë™≠„ÅøËæº„Åø‰∏≠...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Streak Ranking -->
                        <div class="tab-pane fade" id="streak-ranking" role="tabpanel">
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle"></i> ÈÄ£Á∂öÁôªÈå≤Êó•Êï∞„ÅÆ„É©„É≥„Ç≠„É≥„Ç∞
                            </div>
                            <div class="list-group" id="streak-ranking-list">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Ë™≠„ÅøËæº„Åø‰∏≠...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Points Ranking -->
                        <div class="tab-pane fade" id="points-ranking" role="tabpanel">
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle"></i> Á¥ØË®àÁç≤Âæó„Éù„Ç§„É≥„Éà„ÅÆ„É©„É≥„Ç≠„É≥„Ç∞
                            </div>
                            <div class="list-group" id="points-ranking-list">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Ë™≠„ÅøËæº„Åø‰∏≠...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3 text-center">
                        <small class="text-muted">„É©„É≥„Ç≠„É≥„Ç∞„ÅØ1ÊôÇÈñì„Åî„Å®„Å´Êõ¥Êñ∞„Åï„Çå„Åæ„Åô</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Profile Modal -->
    <div class="modal fade" id="profile-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="bi bi-person-circle"></i> „Éó„É≠„Éï„Ç£„Éº„É´</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="profile-view" style="display: block;">
                        <div class="text-center mb-3">
                            <div class="display-1 mb-2" id="profile-icon">üë§</div>
                            <h4>
                                <span id="profile-nickname">Êú™Ë®≠ÂÆö</span>
                                <span id="profile-vip-badge" class="badge bg-warning text-dark ms-2" style="display: none; font-size: 0.6em; vertical-align: middle;">
                                    <i class="bi bi-star-fill"></i> VIP
                                </span>
                            </h4>
                            <p class="text-muted" id="profile-user-id"></p>
                        </div>
                        
                        <div class="list-group">
                            <div class="list-group-item d-flex justify-content-between">
                                <span><i class="bi bi-calendar-check"></i> Á∑èÂà©Áî®Êó•Êï∞</span>
                                <strong id="profile-total-days">0Êó•</strong>
                            </div>
                            <div class="list-group-item d-flex justify-content-between">
                                <span><i class="bi bi-clock-history"></i> ÂàùÂõûÂà©Áî®Êó•</span>
                                <strong id="profile-first-use">-</strong>
                            </div>
                            <div class="list-group-item d-flex justify-content-between">
                                <span><i class="bi bi-clock"></i> ÊúÄÁµÇÂà©Áî®Êó•</span>
                                <strong id="profile-last-use">-</strong>
                            </div>
                            <div class="list-group-item d-flex justify-content-between">
                                <span><i class="bi bi-collection"></i> Á∑è„Ç´„Éº„ÉâÊûöÊï∞</span>
                                <strong id="profile-total-cards">0Êûö</strong>
                            </div>
                            <div class="list-group-item d-flex justify-content-between">
                                <span><i class="bi bi-fire"></i> ÁèæÂú®„ÅÆ„Çπ„Éà„É™„Éº„ÇØ</span>
                                <strong id="profile-streak">0Êó•</strong>
                            </div>
                            <div class="list-group-item d-flex justify-content-between">
                                <span><i class="bi bi-trophy"></i> ÊúÄÈï∑„Çπ„Éà„É™„Éº„ÇØ</span>
                                <strong id="profile-max-streak">0Êó•</strong>
                            </div>
                            <div class="list-group-item d-flex justify-content-between">
                                <span><i class="bi bi-coin"></i> Á¥ØË®àÁç≤Âæó„Éù„Ç§„É≥„Éà</span>
                                <strong id="profile-total-points">0pt</strong>
                            </div>
                        </div>
                        
                        <div class="mt-3 text-center">
                            <button class="btn btn-primary" id="edit-profile-btn">
                                <i class="bi bi-pencil"></i> „Éó„É≠„Éï„Ç£„Éº„É´Á∑®ÈõÜ
                            </button>
                        </div>
                    </div>
                    
                    <div id="profile-edit" style="display: none;">
                        <form id="profile-edit-form">
                            <div class="mb-3">
                                <label for="edit-nickname" class="form-label">„Éã„ÉÉ„ÇØ„Éç„Éº„É†</label>
                                <input type="text" class="form-control" id="edit-nickname" maxlength="20" required>
                                <small class="text-muted">ÊúÄÂ§ß20ÊñáÂ≠ó„Åæ„Åß</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">„Ç¢„Ç§„Ç≥„É≥ÈÅ∏Êäû</label>
                                <div class="d-flex flex-wrap gap-2" id="profile-icon-selector">
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="üë§">üë§</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="üòä">üòä</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="üòé">üòé</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="üéÆ">üéÆ</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="üéØ">üéØ</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="‚≠ê">‚≠ê</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="üèÜ">üèÜ</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="üíé">üíé</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="üî•">üî•</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="‚ö°">‚ö°</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="üåü">üåü</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="üé®">üé®</button>
                                </div>
                            </div>
                            
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-success flex-grow-1">
                                    <i class="bi bi-check-circle"></i> ‰øùÂ≠ò
                                </button>
                                <button type="button" class="btn btn-secondary" id="cancel-edit-btn">
                                    <i class="bi bi-x-circle"></i> „Ç≠„É£„É≥„Çª„É´
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Point Shop Modal -->
    <div class="modal fade" id="point-shop-modal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="bi bi-palette"></i> „ÉÜ„Éº„Éû„Ç∑„Éß„ÉÉ„Éó</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-coin"></i> ÁèæÂú®„ÅÆ„Éù„Ç§„É≥„Éà: <strong id="shop-current-points">0</strong> pt
                    </div>
                    
                    <!-- Shop Tabs -->
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#themes-tab" type="button">
                                <i class="bi bi-palette"></i> „ÉÜ„Éº„Éû
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#frames-tab" type="button">
                                <i class="bi bi-border-all"></i> „Éï„É¨„Éº„É†
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#backgrounds-tab" type="button">
                                <i class="bi bi-image"></i> ËÉåÊôØ
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#icons-tab" type="button">
                                <i class="bi bi-award"></i> „Ç¢„Ç§„Ç≥„É≥
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#gacha-tab" type="button">
                                <i class="bi bi-gift"></i> „Ç¨„ÉÅ„É£
                                <span class="badge bg-danger">NEW</span>
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Shop Tab Content -->
                    <div class="tab-content">
                        <!-- Themes Tab -->
                        <div class="tab-pane fade show active" id="themes-tab" role="tabpanel">
                            <div class="row g-3" id="theme-shop-items">
                                <!-- Theme items will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Frames Tab -->
                        <div class="tab-pane fade" id="frames-tab" role="tabpanel">
                            <div class="row g-3" id="frame-shop-items">
                                <!-- Frame items will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Backgrounds Tab -->
                        <div class="tab-pane fade" id="backgrounds-tab" role="tabpanel">
                            <div class="row g-3" id="background-shop-items">
                                <!-- Background items will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Icons Tab -->
                        <div class="tab-pane fade" id="icons-tab" role="tabpanel">
                            <div class="row g-3" id="icon-shop-items">
                                <!-- Icon items will be populated here -->
                            </div>
                        </div>

                        <!-- Gacha Tab -->
                        <div class="tab-pane fade" id="gacha-tab" role="tabpanel">
                            <div class="alert alert-warning">
                                <h5><i class="bi bi-gift"></i> „Ç¨„ÉÅ„É£„ÅßÈôêÂÆö„Ç¢„Ç§„Ç≥„É≥„ÇíÊâã„Å´ÂÖ•„Çå„Çà„ÅÜÔºÅ</h5>
                                <p>„Ç∑„Éß„ÉÉ„Éó„ÅßË≥ºÂÖ•ÂèØËÉΩ„Å™„Ç¢„Ç§„ÉÜ„É†„ÇÑ„ÄÅ<strong>„Ç¨„ÉÅ„É£ÈôêÂÆö„ÅÆ„É¨„Ç¢„Ç¢„Ç§„Ç≥„É≥</strong>„ÅåÊâã„Å´ÂÖ•„Çã„ÉÅ„É£„É≥„ÇπÔºÅ</p>
                                <p class="mb-0"><small><i class="bi bi-info-circle"></i> Êó¢„Å´ÊåÅ„Å£„Å¶„ÅÑ„Çã„Ç¢„Ç§„ÉÜ„É†„ÅåÂá∫„ÅüÂ†¥Âêà„ÅØ„Éù„Ç§„É≥„Éà„Å´Â§âÊèõ„Åï„Çå„Åæ„Åô</small></p>
                            </div>

                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h4>ÂçòÁô∫„Ç¨„ÉÅ„É£</h4>
                                            <p class="text-muted">‰∏ÄÂõû„ÅÆ„Ç¨„ÉÅ„É£„ÇíÂºï„Åè</p>
                                            <div class="mb-3">
                                                <i class="bi bi-gift" style="font-size: 3rem; color: #ffa500;"></i>
                                            </div>
                                            <button class="btn btn-primary btn-lg" onclick="window.drawGacha(1)">
                                                <i class="bi bi-coin"></i> 100pt „Åß„Ç¨„ÉÅ„É£„ÇíÂºï„Åè
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h4>11ÈÄ£„Ç¨„ÉÅ„É£</h4>
                                            <p class="text-muted">11ÂõûÂàÜ„Ç¨„ÉÅ„É£„ÇíÂºï„ÅèÔºà1ÂõûÂàÜÁÑ°ÊñôÔºÅÔºâ</p>
                                            <div class="mb-3">
                                                <i class="bi bi-gift-fill" style="font-size: 3rem; color: #ff6347;"></i>
                                            </div>
                                            <button class="btn btn-warning btn-lg" onclick="window.drawGacha(11)">
                                                <i class="bi bi-coin"></i> 1000pt „Åß11Âõû„Ç¨„ÉÅ„É£
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion" id="gacha-info-accordion">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#gacha-rates">
                                            <i class="bi bi-info-circle me-2"></i> ÊéíÂá∫Áéá
                                        </button>
                                    </h2>
                                    <div id="gacha-rates" class="accordion-collapse collapse">
                                        <div class="accordion-body">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>„É¨„Ç¢„É™„ÉÜ„Ç£</th>
                                                        <th>ÊéíÂá∫Áéá</th>
                                                        <th>Ë™¨Êòé</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td><span class="badge bg-secondary">Common</span></td>
                                                        <td>60%</td>
                                                        <td>50-200pt „Ç¢„Ç§„ÉÜ„É†</td>
                                                    </tr>
                                                    <tr>
                                                        <td><span class="badge bg-primary">Uncommon</span></td>
                                                        <td>25%</td>
                                                        <td>250-500pt „Ç¢„Ç§„ÉÜ„É†</td>
                                                    </tr>
                                                    <tr>
                                                        <td><span class="badge bg-success">Rare</span></td>
                                                        <td>10%</td>
                                                        <td>600-1000pt „Ç¢„Ç§„ÉÜ„É†</td>
                                                    </tr>
                                                    <tr>
                                                        <td><span class="badge bg-warning">Ultra Rare</span></td>
                                                        <td>4%</td>
                                                        <td>„Ç¨„ÉÅ„É£ÈôêÂÆö„Ç¢„Ç§„Ç≥„É≥</td>
                                                    </tr>
                                                    <tr>
                                                        <td><span class="badge bg-danger">Legendary</span></td>
                                                        <td>1%</td>
                                                        <td>„Ç¨„ÉÅ„É£ÈôêÂÆö„É¨„Ç∏„Çß„É≥„ÉÄ„É™„Éº</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#gacha-exclusive-icons">
                                            <i class="bi bi-star-fill me-2"></i> „Ç¨„ÉÅ„É£ÈôêÂÆö„Ç¢„Ç§„Ç≥„É≥
                                        </button>
                                    </h2>
                                    <div id="gacha-exclusive-icons" class="accordion-collapse collapse">
                                        <div class="accordion-body">
                                            <div id="exclusive-icons-display">
                                                <!-- Will be populated by JavaScript -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Gacha Result Modal -->
                            <div class="modal fade" id="gacha-result-modal" tabindex="-1" data-bs-backdrop="static">
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                        <div class="modal-body text-center text-white p-4">
                                            <div id="gacha-animation" style="min-height: 200px;">
                                                <!-- Animation will be shown here -->
                                            </div>
                                            <div id="gacha-results" class="mt-3" style="display: none;">
                                                <!-- Results will be shown here -->
                                            </div>
                                            <button type="button" class="btn btn-light mt-3" onclick="window.closeGachaResult()" style="display: none;" id="gacha-close-btn">
                                                Èñâ„Åò„Çã
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Èñâ„Åò„Çã</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Stats Info Modal -->
    <div class="modal fade" id="stats-info-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥Áµ±Ë®à„ÅÆË™¨Êòé</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6><i class="bi bi-trophy"></i> „Ç≥„É¨„ÇØ„Çø„Éº„É©„É≥„ÇØ</h6>
                    <ul>
                        <li><span class="badge bg-secondary">Ë¶ãÁøí„ÅÑ</span> 0-9Êûö</li>
                        <li><span class="badge bg-secondary">ÂàùÁ¥ö</span> 10-49Êûö</li>
                        <li><span class="badge bg-primary">‰∏≠Á¥ö</span> 50-99Êûö</li>
                        <li><span class="badge bg-success">‰∏äÁ¥ö</span> 100-299Êûö</li>
                        <li><span class="badge bg-info">„Ç®„Ç≠„Çπ„Éë„Éº„Éà</span> 300-499Êûö</li>
                        <li><span class="badge bg-warning">„Éû„Çπ„Çø„Éº</span> 500-999Êûö</li>
                        <li><span class="badge bg-danger">‰ºùË™¨</span> 1000-2499Êûö</li>
                        <li><span class="badge" style="background: linear-gradient(45deg, #51cf66, #12b886); color: white;">Ë≥¢ËÄÖ</span> 2500-4999Êûö</li>
                        <li><span class="badge" style="background: linear-gradient(45deg, #ff6b6b, #ffd43b); color: white;">Ëã±ÈõÑ</span> 5000-9999Êûö</li>
                        <li><span class="badge" style="background: linear-gradient(45deg, #845ef7, #5c7cfa); color: white;">Ë¶áÁéã</span> 10000-24999Êûö</li>
                        <li><span class="badge" style="background: linear-gradient(45deg, #b9f2ff, #00d4ff); color: white;">Â§©Â∏ù</span> 25000-49999Êûö</li>
                        <li><span class="badge" style="background: linear-gradient(45deg, #ffd700, #ff6b6b); color: white;">Á•ûË©±</span> 50000-99999Êûö</li>
                        <li><span class="badge" style="background: linear-gradient(45deg, #ff00ff, #00ffff, #ffff00); color: white;">Ââµ‰∏ñÁ•û</span> 100000Êûö‰ª•‰∏ä</li>
                    </ul>
                    
                    <h6><i class="bi bi-award"></i> ÂÆüÁ∏æ„Éê„ÉÉ„Ç∏</h6>
                    <p>„Ç´„Éº„Éâ„ÅÆÂèéÈõÜÁä∂Ê≥Å„Å´Âøú„Åò„Å¶Êßò„ÄÖ„Å™ÂÆüÁ∏æ„ÅåËß£Èô§„Åï„Çå„Åæ„ÅôÔºö</p>
                    <ul>
                        <li><strong>ÊûöÊï∞ÂÆüÁ∏æ</strong>: 10ÊûöÔΩû100,000Êûö„Åæ„Åß13ÊÆµÈöé</li>
                        <li><strong>Á®ÆÈ°ûÂÆüÁ∏æ</strong>: 5Á®ÆÈ°ûÔΩû1,000Á®ÆÈ°û„Åæ„Åß8ÊÆµÈöé</li>
                        <li><strong>„É¨„Ç¢„É™„ÉÜ„Ç£ÂÆüÁ∏æ</strong>: R„ÄÅSR„ÄÅUR„ÄÅSE„ÄÅ„Éó„É¨„Éü„Ç¢„É†„ÄÅUL„ÄÅQCSEÂà•</li>
                        <li><strong>Á∂ôÁ∂öÂÆüÁ∏æ</strong>: 3Êó•ÔΩû730Êó•„Åæ„Åß7ÊÆµÈöé</li>
                        <li><strong>ÁâπÊÆäÂÆüÁ∏æ</strong>: ‰∏ÄÊó•„ÅÆËøΩÂä†ÊûöÊï∞„ÄÅÈÄ±ÈñìËøΩÂä†„ÄÅ„Çø„Ç∞ÁÆ°ÁêÜ„Å™„Å©</li>
                    </ul>
                    <p class="text-muted small">„Ç´„ÉÜ„Ç¥„É™„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®Ë©≥Á¥∞„Å™ÂÆüÁ∏æ„É™„Çπ„Éà„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ</p>
                    
                    <h6><i class="bi bi-bar-chart"></i> Áµ±Ë®àÈ†ÖÁõÆ</h6>
                    <ul>
                        <li><strong>Á∑è„Ç´„Éº„ÉâÊûöÊï∞</strong>: ÊâÄÊåÅ„Åó„Å¶„ÅÑ„ÇãÂÖ®„Ç´„Éº„Éâ„ÅÆÂêàË®àÊûöÊï∞</li>
                        <li><strong>Á®ÆÈ°ûÊï∞</strong>: „É¶„Éã„Éº„ÇØ„Å™„Ç´„Éº„Éâ„ÅÆÁ®ÆÈ°ûÊï∞</li>
                        <li><strong>ÂèéÈõÜÊó•Êï∞</strong>: ÊúÄÂàù„ÅÆ„Ç´„Éº„ÉâÁôªÈå≤„Åã„Çâ„ÅÆÁµåÈÅéÊó•Êï∞</li>
                        <li><strong>‰ªäÈÄ±ËøΩÂä†</strong>: ÈÅéÂéª7Êó•Èñì„Å´ËøΩÂä†„Åó„Åü„Ç´„Éº„ÉâÊûöÊï∞</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Èñâ„Åò„Çã</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Settings Modal -->
    <div class="modal fade" id="settings-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Ë®≠ÂÆö</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <h6 class="mb-3"><i class="bi bi-display"></i> Ë°®Á§∫Ë®≠ÂÆö</h6>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="dark-mode-toggle">
                    <label class="form-check-label" for="dark-mode-toggle">„ÉÄ„Éº„ÇØ„É¢„Éº„Éâ</label>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="hide-email-toggle">
                    <label class="form-check-label" for="hide-email-toggle">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÈùûË°®Á§∫</label>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="hide-stats-toggle">
                    <label class="form-check-label" for="hide-stats-toggle">„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥Áµ±Ë®à„ÇíÈùûË°®Á§∫</label>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="show-daily-challenges-toggle">
                    <label class="form-check-label" for="show-daily-challenges-toggle">‰ªäÊó•„ÅÆ„ÉÅ„É£„É¨„É≥„Ç∏„ÇíË°®Á§∫</label>
                </div>

                <hr>
                <h6 class="mb-3"><i class="bi bi-clock-history"></i> Â±•Ê≠¥„ÉªÊìç‰ΩúË®≠ÂÆö</h6>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="show-search-history-toggle">
                    <label class="form-check-label" for="show-search-history-toggle">ÂâçÂõû„ÅÆÊ§úÁ¥¢Â±•Ê≠¥„Éú„Çø„É≥„ÇíË°®Á§∫</label>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="show-registration-history-toggle">
                    <label class="form-check-label" for="show-registration-history-toggle">ÂâçÂõû„ÅÆÁôªÈå≤Â±•Ê≠¥„Éú„Çø„É≥„ÇíË°®Á§∫</label>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="use-tap-quantity-toggle">
                    <label class="form-check-label" for="use-tap-quantity-toggle">ÊûöÊï∞ÂÖ•Âäõ„Çí„Çø„ÉÉ„ÉóÂºè„Å´„Åô„Çã</label>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="auto-save-toggle">
                    <label class="form-check-label" for="auto-save-toggle">„Éá„Éº„Çø„ÇíËá™Âãï‰øùÂ≠ò„Åô„ÇãÔºà5ÂàÜ„Åî„Å®Ôºâ</label>
                </div>

                <hr>
                <h6 class="mb-3"><i class="bi bi-speedometer2"></i> „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπË®≠ÂÆö</h6>
                <div class="mb-3">
                    <label for="table-rows-per-page" class="form-label">„ÉÜ„Éº„Éñ„É´„ÅÆË°®Á§∫Ë°åÊï∞</label>
                    <select class="form-select form-select-sm" id="table-rows-per-page">
                        <option value="50">50Ë°å</option>
                        <option value="100" selected>100Ë°åÔºà„Éá„Éï„Ç©„É´„ÉàÔºâ</option>
                        <option value="200">200Ë°å</option>
                        <option value="500">500Ë°å</option>
                        <option value="all">ÂÖ®„Å¶Ë°®Á§∫</option>
                    </select>
                </div>

                <hr>
                <!-- Serial Number Section -->
                <div class="mb-4" id="serial-number-section" style="display: none;">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <h6 class="mb-0 small"><i class="bi bi-key-fill"></i> „Ç∑„É™„Ç¢„É´Áï™Âè∑</h6>
                        <span id="vip-status-badge" class="badge bg-secondary small" style="display: none;">Ë™çË®ºÊ∏à</span>
                    </div>
                    <div id="vip-serial-input-section">
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control form-control-sm" id="vip-serial-input"
                                   placeholder="„Ç∑„É™„Ç¢„É´Áï™Âè∑„ÇíÂÖ•Âäõ" style="font-size: 0.8rem;" maxlength="20">
                            <button class="btn btn-outline-secondary btn-sm" type="button" id="vip-activate-btn">
                                <i class="bi bi-check-circle"></i> Ë™çË®º
                            </button>
                        </div>
                        <p class="text-muted mt-1 mb-0" style="font-size: 0.7rem;" id="serial-attempts-text">
                            <i class="bi bi-info-circle"></i> ÊÆã„ÇäË©¶Ë°åÂõûÊï∞: 3Âõû
                        </p>
                    </div>
                    <div id="vip-active-section" style="display: none;">
                        <p class="text-success mb-2" style="font-size: 0.85rem;">
                            <i class="bi bi-check-circle-fill"></i> Ë™çË®ºÊ∏à„Åø
                        </p>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-secondary btn-sm" type="button" id="vip-features-btn">
                                <i class="bi bi-star"></i> ÁâπÂÖ∏„ÇíË¶ã„Çã
                            </button>
                            <button class="btn btn-outline-danger btn-sm" type="button" id="vip-deactivate-btn">
                                <i class="bi bi-x-circle"></i> Ëß£Èô§
                            </button>
                        </div>
                    </div>
                </div>

                <hr>
                <h6>„Ç¢„Ç´„Ç¶„É≥„ÉàÂâäÈô§</h6>
                <p class="text-muted small">„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ„Ç¢„Ç´„Ç¶„É≥„Éà„Å´Á¥ê„Å•„ÅèÂÖ®„Å¶„ÅÆ„Ç´„Éº„Éâ„Éá„Éº„Çø„ÅåÂÆåÂÖ®„Å´ÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ</p>
                <button class="btn btn-danger" id="delete-account-btn">„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíÂâäÈô§„Åô„Çã</button>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Èñâ„Åò„Çã</button></div>
        </div></div>
    </div>

    <!-- Tag Management Modal -->
    <div class="modal fade" id="tag-management-modal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">„Çø„Ç∞ÁÆ°ÁêÜ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>Êñ∞„Åó„ÅÑ„Çø„Ç∞„ÇíËøΩÂä†</h6>
                    <form id="add-tag-form" class="input-group mb-3">
                        <input type="text" id="new-tag-name" class="form-control" placeholder="Êñ∞„Åó„ÅÑ„Çø„Ç∞ÂêçÔºà„Ç´„É≥„ÉûÂå∫Âàá„Çä„ÅßË§áÊï∞ÂÖ•ÂäõÂèØÔºâ" required>
                        <button class="btn btn-primary" type="submit">ËøΩÂä†</button>
                    </form>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <h6>ÁôªÈå≤Ê∏à„Åø„Çø„Ç∞‰∏ÄË¶ß</h6>
                            <small class="text-muted">‚Äª„Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó„ÅßÈ†ÜÁï™„ÇíÂ§âÊõ¥„Åß„Åç„Åæ„Åô</small>
                        </div>
                        <button class="btn btn-warning btn-sm" id="cleanup-tags-btn">
                            <i class="bi bi-recycle"></i> Êú™‰ΩøÁî®„Çø„Ç∞„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
                        </button>
                    </div>
                    <div id="existing-tags-list" class="mt-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Èñâ„Åò„Çã</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bulk Tag Edit Modal -->
    <!-- Bulk Import Modal -->
    <div class="modal fade" id="bulk-import-modal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-plus-square"></i> ‰∏ÄÊã¨ÁôªÈå≤</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="bulk-import-url" class="form-label">
                            <i class="bi bi-link-45deg"></i> ÈÅäÊàØÁéãDB„ÅÆÊ§úÁ¥¢ÁµêÊûúURL
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="bulk-import-url"
                                placeholder="https://www.db.yugioh-card.com/yugiohdb/card_search.action?ope=1&...">
                            <button class="btn btn-primary" type="button" id="fetch-cards-btn">
                                <i class="bi bi-download"></i> „Ç´„Éº„ÉâÂèñÂæó
                            </button>
                        </div>
                        <small class="text-muted">
                            ÈÅäÊàØÁéãÂÖ¨ÂºèDB„ÅßÊ§úÁ¥¢ÁµêÊûú„ÅÆURL„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                        </small>
                    </div>

                    <div id="bulk-import-loading" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Ë™≠„ÅøËæº„Åø‰∏≠...</span>
                        </div>
                        <p class="mt-2">„Ç´„Éº„ÉâÊÉÖÂ†±„ÇíÂèñÂæó‰∏≠...</p>
                    </div>

                    <div id="bulk-import-results" style="display: none;">
                        <div class="mb-3">
                            <h6 class="mb-0">
                                <span id="bulk-import-count">0</span>‰ª∂„ÅÆ„Ç´„Éº„Éâ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü
                            </h6>
                        </div>

                        <div id="bulk-import-card-grid" style="max-height: 600px; overflow-y: auto;">
                            <!-- Cards will be inserted here as grid -->
                        </div>
                    </div>

                    <style>
                        #bulk-import-card-grid {
                            display: grid;
                            grid-template-columns: repeat(4, 1fr);
                            gap: 1rem;
                            padding: 0.5rem;
                        }

                        .bulk-card-item {
                            display: flex;
                            flex-direction: column;
                            border: 1px solid #ddd;
                            border-radius: 8px;
                            padding: 0.75rem;
                            background: white;
                        }

                        .bulk-card-image {
                            width: 100%;
                            aspect-ratio: 59/86;
                            object-fit: contain;
                            border-radius: 4px;
                            margin-bottom: 0.5rem;
                            background: #f8f9fa;
                        }

                        .bulk-card-name {
                            font-size: 0.85rem;
                            font-weight: 600;
                            margin-bottom: 0.25rem;
                            min-height: 2.5rem;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            display: -webkit-box;
                            -webkit-line-clamp: 2;
                            -webkit-box-orient: vertical;
                        }

                        .bulk-card-number {
                            font-size: 0.75rem;
                            color: #6c757d;
                            margin-bottom: 0.5rem;
                        }

                        .bulk-card-controls {
                            display: flex;
                            flex-direction: column;
                            gap: 0.5rem;
                        }

                        .bulk-card-controls label {
                            font-size: 0.75rem;
                            margin-bottom: 0.1rem;
                            font-weight: 500;
                        }

                        .bulk-card-controls input,
                        .bulk-card-controls select {
                            font-size: 0.85rem;
                        }

                        @media (max-width: 768px) {
                            #bulk-import-card-grid {
                                grid-template-columns: repeat(2, 1fr);
                                gap: 0.5rem;
                            }
                        }
                    </style>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">„Ç≠„É£„É≥„Çª„É´</button>
                    <button type="button" class="btn btn-primary" id="bulk-register-btn" disabled>
                        <i class="bi bi-save"></i> ÁôªÈå≤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="bulk-tag-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bulk-tag-modal-title">„Çø„Ç∞‰∏ÄÊã¨Á∑®ÈõÜ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="bulk-tag-modal-desc"></p>
                    <div id="bulk-tag-choices-container"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">„Ç≠„É£„É≥„Çª„É´</button>
                    <button type="button" class="btn btn-primary" id="bulk-tag-save-btn">ÈÅ©Áî®</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Modal -->
    <div class="modal fade" id="analysis-modal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-graph-up"></i> „Ç≥„É¨„ÇØ„Ç∑„Éß„É≥ÂàÜÊûê</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Analysis Tabs -->
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#overview-analysis" type="button">
                                <i class="bi bi-grid"></i> Ê¶ÇË¶Å
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#recent-history" type="button">
                                <i class="bi bi-clock-history"></i> ËøΩÂä†Â±•Ê≠¥
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#calendar-heatmap" type="button">
                                <i class="bi bi-calendar3"></i> „Ç´„É¨„É≥„ÉÄ„Éº
                            </button>
                        </li>
                    </ul>

                    <!-- Tab Contents -->
                    <div class="tab-content">
                        <!-- Overview Tab -->
                        <div class="tab-pane fade show active" id="overview-analysis">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="card-title">Á∑è„Ç´„Éº„ÉâÊï∞</h5>
                                            <p class="card-text display-6" id="analysis-total-cards">0</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="card-title">„É¶„Éã„Éº„ÇØÊï∞</h5>
                                            <p class="card-text display-6" id="analysis-unique-cards">0</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="card-title">Âπ≥ÂùáÊûöÊï∞</h5>
                                            <p class="card-text display-6" id="analysis-avg-cards">0</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="card-title">Êé®ÂÆö‰æ°ÂÄ§</h5>
                                            <p class="card-text display-6" id="analysis-estimated-value">¬•0</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6><i class="bi bi-trophy"></i> ÊûöÊï∞„Éà„ÉÉ„Éó5</h6>
                                            <div class="list-group list-group-flush" id="analysis-top-cards">
                                                <p class="text-muted">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6><i class="bi bi-gem"></i> „É¨„Ç¢„É™„ÉÜ„Ç£ÂàÜÂ∏É</h6>
                                            <div class="list-group list-group-flush" id="analysis-rarity-ranking">
                                                <p class="text-muted">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent History Tab -->
                        <div class="tab-pane fade" id="recent-history">
                            <div class="card">
                                <div class="card-body">
                                    <h6><i class="bi bi-clock-history"></i> Áõ¥Ëøë„ÅßËøΩÂä†„Åó„Åü„Ç´„Éº„ÉâÔºàÊúÄÊñ∞50‰ª∂Ôºâ</h6>
                                    <div id="recent-cards-list" class="list-group">
                                        <p class="text-muted">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Calendar Heatmap Tab -->
                        <div class="tab-pane fade" id="calendar-heatmap">
                            <div class="p-3">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6><i class="bi bi-calendar3"></i> „Ç´„Éº„ÉâËøΩÂä†„Ç´„É¨„É≥„ÉÄ„Éº</h6>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="changeCalendarMonth(-1)">
                                            <i class="bi bi-chevron-left"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="calendar-month-label">
                                            2024Âπ¥12Êúà
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="changeCalendarMonth(1)">
                                            <i class="bi bi-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>
                                <div id="calendar-container" style="background: var(--bs-body-bg); padding: 15px; border-radius: 10px;">
                                    <!-- Calendar will be generated here -->
                                </div>
                                <div class="mt-3">
                                    <small class="text-muted">*Ëâ≤„ÅÆÊøÉ„Åï„ÅßËøΩÂä†ÊûöÊï∞„ÇíË°®Áèæ</small>
                                    <div class="d-flex gap-2 mt-2">
                                        <span class="badge" style="background-color: #e0e0e0;">0Êûö</span>
                                        <span class="badge" style="background-color: #c6e48b;">1-5Êûö</span>
                                        <span class="badge" style="background-color: #7bc96f;">6-10Êûö</span>
                                        <span class="badge" style="background-color: #239a3b;">11-20Êûö</span>
                                        <span class="badge" style="background-color: #196127;">21Êûö‰ª•‰∏ä</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="refresh-analysis-btn">
                        <i class="bi bi-arrow-clockwise"></i> „Éá„Éº„Çø„ÇíÊõ¥Êñ∞
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Èñâ„Åò„Çã</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app">
        <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4" data-bs-theme="light">
            <div class="container-fluid">
                <span class="navbar-brand"><i class="bi bi-layers-fill"></i> „Ç´„Éº„ÉâÁÆ°ÁêÜ</span>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarContent">
                    <div class="navbar-nav ms-auto d-flex flex-row flex-wrap gap-2 mt-2 mt-lg-0">
                        <div class="d-inline-block">
                            <button class="btn btn-outline-info btn-sm" id="how-to-use-btn">
                                <i class="bi bi-question-circle"></i>
                                <span class="d-none d-sm-inline"> ‰Ωø„ÅÑÊñπ</span>
                            </button>
                        </div>
                        <div class="d-inline-block" id="vip-gallery-btn-container" style="display: none;">
                            <button class="btn btn-warning btn-sm" onclick="window.location.href='card_gallery.html'">
                                <i class="bi bi-grid-3x3-gap"></i>
                                <span class="d-none d-sm-inline"> „ÇÆ„É£„É©„É™„Éº</span>
                                <i class="bi bi-star-fill ms-1"></i>
                            </button>
                        </div>
                        <div class="dropdown d-inline-block">
                            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-database"></i>
                                <span class="d-none d-sm-inline"> „Éá„Éº„ÇøÁÆ°ÁêÜ</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><button class="dropdown-item" id="import-json-btn">JSON„Åã„Çâ„Ç§„É≥„Éù„Éº„Éà</button></li>
                                <li><button class="dropdown-item" id="import-csv-btn">CSV„Åã„Çâ„Ç§„É≥„Éù„Éº„Éà</button></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><button class="dropdown-item" id="export-json-btn">JSONÂΩ¢Âºè„Åß„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button></li>
                                <li><button class="dropdown-item" id="export-csv-btn">CSVÂΩ¢Âºè„Åß„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button></li>
                                <li id="vip-export-option" style="display: none;">
                                    <button class="dropdown-item text-warning" id="export-premium-csv-btn">
                                        <i class="bi bi-star-fill"></i> „Éó„É¨„Éü„Ç¢„É†„Ç®„ÇØ„Çπ„Éù„Éº„Éà (VIP)
                                    </button>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li><button class="dropdown-item" id="link-master-data-btn"><i class="bi bi-link-45deg"></i> „Éû„Çπ„Çø„Éº„Éá„Éº„Çø„Å®ÈÄ£Êê∫</button></li>
                                <li><button class="dropdown-item" id="bulk-import-btn"><i class="bi bi-plus-square"></i> ‰∏ÄÊã¨ÁôªÈå≤</button></li>
                            </ul>
                        </div>
                        <input type="file" id="import-file-input" accept=".json,.csv" style="display: none;">
                        <div class="d-inline-block">
                            <button class="btn btn-outline-secondary btn-sm" id="tag-management-btn">
                                <i class="bi bi-tags"></i>
                                <span class="d-none d-sm-inline"> „Çø„Ç∞</span>
                            </button>
                        </div>
                        <div class="d-inline-block">
                            <button class="btn btn-outline-primary btn-sm" id="ranking-btn">
                                <i class="bi bi-trophy"></i>
                                <span class="d-none d-sm-inline"> „É©„É≥„Ç≠„É≥„Ç∞</span>
                            </button>
                        </div>
                        <div class="d-inline-block">
                            <button class="btn btn-outline-warning btn-sm" id="analysis-btn">
                                <i class="bi bi-graph-up"></i>
                                <span class="d-none d-sm-inline"> ÂàÜÊûê</span>
                            </button>
                        </div>
                        <div class="d-inline-block">
                            <button class="btn btn-outline-info btn-sm" id="profile-btn">
                                <i class="bi bi-person-circle"></i>
                                <span class="d-none d-sm-inline"> „Éó„É≠„Éï„Ç£„Éº„É´</span>
                            </button>
                        </div>
                        <div class="d-inline-block">
                            <button class="btn btn-outline-secondary btn-sm" id="settings-btn">
                                <i class="bi bi-gear"></i>
                                <span class="d-none d-sm-inline"> Ë®≠ÂÆö</span>
                            </button>
                        </div>
                        <span class="navbar-text d-none d-md-inline mx-2" id="user-email"></span>
                        <div class="d-inline-block">
                            <button id="logout-btn" class="btn btn-danger btn-sm">
                                <i class="bi bi-box-arrow-right"></i>
                                <span class="d-none d-sm-inline"> „É≠„Ç∞„Ç¢„Ç¶„Éà</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <div class="container-fluid">
             <div id="loading-overlay" style="display: none;"><div class="spinner-border" role="status"></div></div>
            <div class="row">
                <!-- Left Column: Add Card -->
                <div class="col-lg-5">
                    <div class="card">
                        <div class="card-header">„Ç´„Éº„ÉâÁôªÈå≤</div>
                        <div class="card-body">
                            <form id="add-form">
                                <div class="mb-3">
                                    <label for="card-search" class="form-label">„Ç´„Éº„ÉâÂêç„ÅßÊ§úÁ¥¢</label>
                                    <div class="d-flex gap-2">
                                        <div class="input-group flex-grow-1">
                                            <input type="text" class="form-control" id="card-search" placeholder="„Ç´„Éº„ÉâÂêç„ÇíÂÖ•Âäõ">
                                            <button class="btn btn-success" type="button" id="search-db-btn">Ê§úÁ¥¢</button>
                                        </div>
                                        <button class="btn btn-outline-secondary" type="button" id="prev-search-btn" style="display: none; min-width: 44px;" title="ÂâçÂõû„ÅÆÊ§úÁ¥¢">
                                            <i class="bi bi-clock-history"></i>
                                        </button>
                                    </div>
                                    <div id="search-results" class="mt-2"></div>
                                </div>
                                <div class="mb-3">
                                    <label for="url" class="form-label">ÂÖ¨ÂºèDB URL</label>
                                    <div class="input-group">
                                        <input type="url" class="form-control" id="url" placeholder="URL„Çí„Éö„Éº„Çπ„Éà (Ctrl+V)...">
                                        <button class="btn btn-primary" type="button" id="fetch-btn">Ë™≠Ëæº</button>
                                    </div>
                                </div>
                                <div class="mb-3"><label for="name" class="form-label">ÂêçÂâç</label><input type="text" class="form-control" id="name" name="name" required></div>
                                <div class="mb-3">
                                    <label for="set_code" class="form-label">ÂûãÁï™ <small class="text-muted">(‰ªªÊÑè)</small></label>
                                    <input type="text" class="form-control" id="set_code" name="set_code">
                                    <div id="set-rarity-choices" class="mt-2"></div>
                                </div>
                                <div class="mb-3"><label for="rarity" class="form-label">„É¨„Ç¢„É™„ÉÜ„Ç£</label><input type="text" class="form-control" id="rarity" name="rarity"></div>
                                <div class="mb-3">
                                    <label for="quantity" class="form-label">ÊûöÊï∞</label>
                                    <div id="quantity-input-container">
                                        <input type="number" class="form-control" id="quantity" name="quantity" value="1" min="1" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">ÁôªÈå≤ÂÖà</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="add-type" id="add-to-collection" value="collection" checked>
                                        <label class="btn btn-outline-primary" for="add-to-collection">ÊâÄÊåÅ„Ç´„Éº„Éâ</label>
                                        <input type="radio" class="btn-check" name="add-type" id="add-to-wishlist" value="wishlist">
                                        <label class="btn btn-outline-warning" for="add-to-wishlist">„Ç¶„Ç£„ÉÉ„Ç∑„É•„É™„Çπ„Éà</label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">„Çø„Ç∞</label>
                                    <div id="card-tags-container" class="mb-2"></div>
                                    <div id="tag-choices-container"></div>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-success flex-grow-1">„Ç´„Éº„Éâ„ÇíËøΩÂä†</button>
                                    <button type="button" class="btn btn-outline-secondary" id="prev-registration-btn" style="display: none;" title="ÂâçÂõû„ÅÆÁôªÈå≤ÂÜÖÂÆπ">
                                        <i class="bi bi-arrow-counterclockwise"></i>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Fun Dashboard -->
                    <div class="card mt-3" id="daily-challenges-card">
                        <div class="card-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-stars"></i> ‰ªäÊó•„ÅÆ„ÉÅ„É£„É¨„É≥„Ç∏
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <button class="btn btn-sm btn-light" onclick="toggleDailyChallenges()" title="Ë°®Á§∫/ÈùûË°®Á§∫">
                                        <i class="bi bi-eye-slash" id="daily-challenges-toggle-icon"></i>
                                    </button>
                                    <div id="current-time" class="small"></div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body" id="daily-challenges-body">
                            <!-- Daily Missions -->
                            <div class="mb-3">
                                <h6 class="d-flex align-items-center mb-2">
                                    <i class="bi bi-flag-fill text-primary me-2"></i>
                                    „Éá„Ç§„É™„Éº„Éü„ÉÉ„Ç∑„Éß„É≥
                                </h6>
                                <div id="daily-missions" class="list-group list-group-flush">
                                    <!-- Missions will be populated here -->
                                </div>
                            </div>
                            
                            <!-- Registration Streak -->
                            <div class="mb-3">
                                <h6 class="d-flex align-items-center mb-2">
                                    <i class="bi bi-fire text-danger me-2"></i>
                                    ÁôªÈå≤„Çπ„Éà„É™„Éº„ÇØ
                                </h6>
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-baseline">
                                            <span class="fs-2 fw-bold text-warning" id="streak-count">0</span>
                                            <span class="ms-2 text-muted">Êó•ÈÄ£Á∂ö</span>
                                        </div>
                                        <div class="progress mt-2" style="height: 10px;">
                                            <div class="progress-bar bg-warning" id="streak-progress" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted" id="streak-message"></small>
                                    </div>
                                    <div class="ms-3" id="streak-badge" style="font-size: 3rem;"></div>
                                </div>
                            </div>
                            
                            <!-- Quick Stats -->
                            <div class="row g-2 text-center">
                                <div class="col-6">
                                    <div class="p-2 bg-light rounded">
                                        <div class="fs-4 fw-bold text-primary" id="today-added">0</div>
                                        <small class="text-muted">‰ªäÊó•ËøΩÂä†</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-2 bg-light rounded" style="cursor: pointer;" onclick="showWeeklyGoalSetting()" title="„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÁõÆÊ®ô„ÇíÂ§âÊõ¥">
                                        <div class="fs-4 fw-bold text-success" id="week-goal-progress">0%</div>
                                        <small class="text-muted">ÈÄ±ÈñìÁõÆÊ®ô (<span id="week-goal-target">50</span>Êûö)</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Search/List and Stats -->
                <div class="col-lg-7">
                    <!-- Card List -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <ul class="nav nav-tabs card-header-tabs">
                                <li class="nav-item">
                                    <a class="nav-link active" id="collection-tab" data-list-type="collection" href="#">ÊâÄÊåÅ„Ç´„Éº„Éâ (<span id="total-collection">0</span>)</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="wishlist-tab" data-list-type="wishlist" href="#">„Ç¶„Ç£„ÉÉ„Ç∑„É•„É™„Çπ„Éà (<span id="total-wishlist">0</span>)</a>
                                </li>
                            </ul>
                        </div>
                        <div class="card-body">
                            <form id="search-form" class="row g-3 mb-4">
                                <div class="col-md-6"><input type="text" name="search_name" class="form-control" placeholder="ÂêçÂâç..."></div>
                                <div class="col-md-6"><input type="text" name="search_set_code" class="form-control" placeholder="ÂûãÁï™..."></div>
                                <div class="col-md-6"><input type="text" name="search_rarity" class="form-control" placeholder="„É¨„Ç¢„É™„ÉÜ„Ç£..."></div>
                                <div class="col-md-6"><input type="text" name="search_tags" class="form-control" placeholder="„Çø„Ç∞..."></div>

                                <!-- Advanced Search Section -->
                                <div class="col-12">
                                    <button type="button" class="btn btn-sm btn-secondary" id="advanced-search-btn" data-bs-toggle="collapse" data-bs-target="#advanced-search" aria-expanded="false">
                                        <i class="bi bi-funnel"></i> Ë©≥Á¥∞Ê§úÁ¥¢
                                    </button>
                                </div>
                                <div class="collapse col-12 mt-2" id="advanced-search">
                                    <div class="card card-body bg-light">
                                        <!-- AND/OR Search Mode Selector -->
                                        <div class="row g-2 mb-3">
                                            <div class="col-12">
                                                <div class="d-flex align-items-center gap-2 flex-wrap">
                                                    <label class="form-label small mb-0 me-2">Ê§úÁ¥¢„É¢„Éº„Éâ:</label>
                                                    <div class="btn-group btn-group-sm" role="group" aria-label="Ê§úÁ¥¢„É¢„Éº„Éâ">
                                                        <input type="radio" class="btn-check" name="search_mode" id="search-mode-and" value="and" checked autocomplete="off">
                                                        <label class="btn btn-outline-primary" for="search-mode-and">
                                                            <i class="bi bi-intersect"></i> ANDÊ§úÁ¥¢
                                                        </label>
                                                        <input type="radio" class="btn-check" name="search_mode" id="search-mode-or" value="or" autocomplete="off">
                                                        <label class="btn btn-outline-success" for="search-mode-or">
                                                            <i class="bi bi-union"></i> ORÊ§úÁ¥¢
                                                        </label>
                                                    </div>
                                                    <small class="text-muted ms-2">
                                                        <i class="bi bi-info-circle"></i>
                                                        <span id="search-mode-description">„Åô„Åπ„Å¶„ÅÆÊù°‰ª∂„ÇíÊ∫Ä„Åü„Åô„Ç´„Éº„Éâ„ÇíÊ§úÁ¥¢</span>
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row g-2">
                                            <div class="col-md-3">
                                                <label class="form-label small">„É¨„Éô„É´</label>
                                                <input type="text" name="search_level" class="form-control form-control-sm">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small">Â±ûÊÄß</label>
                                                <select name="search_attribute" class="form-select form-select-sm">
                                                    <option value="">„Åô„Åπ„Å¶</option>
                                                    <option value="Èóá">Èóá</option>
                                                    <option value="ÂÖâ">ÂÖâ</option>
                                                    <option value="Âú∞">Âú∞</option>
                                                    <option value="Ê∞¥">Ê∞¥</option>
                                                    <option value="ÁÇé">ÁÇé</option>
                                                    <option value="È¢®">È¢®</option>
                                                    <option value="Á•û">Á•û</option>
                                                </select>
                                            </div>
                                            <div class="col-md-12">
                                                <label class="form-label small">„Ç´„Éº„Éâ„Çø„Ç§„Éó</label>
                                                <div class="card-type-selector">
                                                    <!-- „É°„Ç§„É≥„Ç´„ÉÜ„Ç¥„É™„Éº„Çø„Éñ -->
                                                    <ul class="nav nav-pills nav-fill mb-2" role="tablist">
                                                        <li class="nav-item" role="presentation">
                                                            <button class="nav-link active py-1 px-2 main-type-tab" data-category="all" type="button">
                                                                <i class="bi bi-grid-3x3-gap"></i> „Åô„Åπ„Å¶
                                                            </button>
                                                        </li>
                                                        <li class="nav-item" role="presentation">
                                                            <button class="nav-link py-1 px-2 main-type-tab" data-category="monster" type="button">
                                                                <i class="bi bi-shield-fill"></i> „É¢„É≥„Çπ„Çø„Éº
                                                            </button>
                                                        </li>
                                                        <li class="nav-item" role="presentation">
                                                            <button class="nav-link py-1 px-2 main-type-tab" data-category="spell" type="button">
                                                                <i class="bi bi-book-fill"></i> È≠îÊ≥ï
                                                            </button>
                                                        </li>
                                                        <li class="nav-item" role="presentation">
                                                            <button class="nav-link py-1 px-2 main-type-tab" data-category="trap" type="button">
                                                                <i class="bi bi-exclamation-triangle-fill"></i> ÁΩ†
                                                            </button>
                                                        </li>
                                                    </ul>
                                                    <!-- „Çµ„Éñ„Ç´„ÉÜ„Ç¥„É™„ÉºÈÅ∏Êäû -->
                                                    <div class="sub-type-container" style="min-height: 38px;">
                                                        <div class="sub-type-group" data-category="monster" style="display: none;">
                                                            <div class="d-flex flex-wrap gap-1">
                                                                <button type="button" class="btn btn-sm btn-outline-secondary sub-type-btn active" data-type="all-monster">
                                                                    ÂÖ®„É¢„É≥„Çπ„Çø„Éº
                                                                </button>
                                                                <button type="button" class="btn btn-sm btn-outline-info sub-type-btn" data-type="ÈÄöÂ∏∏">
                                                                    <small>ÈÄöÂ∏∏</small>
                                                                </button>
                                                                <button type="button" class="btn btn-sm btn-outline-success sub-type-btn" data-type="ÂäπÊûú">
                                                                    <small>ÂäπÊûú</small>
                                                                </button>
                                                                <button type="button" class="btn btn-sm btn-outline-purple sub-type-btn" data-type="ËûçÂêà">
                                                                    <small>ËûçÂêà</small>
                                                                </button>
                                                                <button type="button" class="btn btn-sm btn-outline-primary sub-type-btn" data-type="„Ç∑„É≥„ÇØ„É≠">
                                                                    <small>„Ç∑„É≥„ÇØ„É≠</small>
                                                                </button>
                                                                <button type="button" class="btn btn-sm btn-outline-dark sub-type-btn" data-type="„Ç®„ÇØ„Ç∑„Éº„Ç∫">
                                                                    <small>„Ç®„ÇØ„Ç∑„Éº„Ç∫</small>
                                                                </button>
                                                                <button type="button" class="btn btn-sm btn-outline-primary sub-type-btn" data-type="„É™„É≥„ÇØ">
                                                                    <small>„É™„É≥„ÇØ</small>
                                                                </button>
                                                                <button type="button" class="btn btn-sm btn-outline-secondary sub-type-btn" data-type="„Éö„É≥„Éá„É•„É©„É†">
                                                                    <small>„Éö„É≥„Éá„É•„É©„É†</small>
                                                                </button>
                                                                <button type="button" class="btn btn-sm btn-outline-info sub-type-btn" data-type="ÂÑÄÂºè">
                                                                    <small>ÂÑÄÂºè</small>
                                                                </button>
                                                                <button type="button" class="btn btn-sm btn-outline-warning sub-type-btn" data-type="„ÉÅ„É•„Éº„Éä„Éº">
                                                                    <small>„ÉÅ„É•„Éº„Éä„Éº</small>
                                                                </button>
                                                                <button type="button" class="btn btn-sm btn-outline-danger sub-type-btn" data-type="„É™„Éê„Éº„Çπ">
                                                                    <small>„É™„Éê„Éº„Çπ</small>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div class="sub-type-group" data-category="spell" style="display: none;">
                                                            <button type="button" class="btn btn-sm btn-success sub-type-btn" data-type="È≠îÊ≥ï">
                                                                <i class="bi bi-book"></i> È≠îÊ≥ï„Ç´„Éº„Éâ
                                                            </button>
                                                        </div>
                                                        <div class="sub-type-group" data-category="trap" style="display: none;">
                                                            <button type="button" class="btn btn-sm btn-danger sub-type-btn" data-type="ÁΩ†">
                                                                <i class="bi bi-exclamation-triangle"></i> ÁΩ†„Ç´„Éº„Éâ
                                                            </button>
                                                        </div>
                                                        <div class="sub-type-group" data-category="all">
                                                            <span class="text-muted small">„Åô„Åπ„Å¶„ÅÆ„Ç´„Éº„Éâ„ÇíË°®Á§∫</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row g-2 mb-2">
                                            <div class="col-md-12">
                                                <label class="form-label small">Á®ÆÊóè</label>
                                                <div class="race-selector">
                                                    <div class="mb-2">
                                                        <button type="button" class="btn btn-sm btn-outline-secondary clear-race-btn">
                                                            <i class="bi bi-x-circle"></i> „Åô„Åπ„Å¶„ÇØ„É™„Ç¢
                                                        </button>
                                                    </div>
                                                    <div class="d-flex flex-wrap gap-1">
                                                        <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="„Éâ„É©„Ç¥„É≥Êóè">
                                                            <small>„Éâ„É©„Ç¥„É≥</small>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="Êà¶Â£´Êóè">
                                                            <small>Êà¶Â£´</small>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="Áç£Êà¶Â£´Êóè">
                                                            <small>Áç£Êà¶Â£´</small>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="È≠îÊ≥ï‰Ωø„ÅÑÊóè">
                                                            <small>È≠îÊ≥ï‰Ωø„ÅÑ</small>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="Â§©‰ΩøÊóè">
                                                            <small>Â§©‰Ωø</small>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="ÊÇ™È≠îÊóè">
                                                            <small>ÊÇ™È≠î</small>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="„Ç¢„É≥„Éá„ÉÉ„ÉàÊóè">
                                                            <small>„Ç¢„É≥„Éá„ÉÉ„Éà</small>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="Ê©üÊ¢∞Êóè">
                                                            <small>Ê©üÊ¢∞</small>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="Áç£Êóè">
                                                            <small>Áç£</small>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="È≥•Áç£Êóè">
                                                            <small>È≥•Áç£</small>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="Ê§çÁâ©Êóè">
                                                            <small>Ê§çÁâ©</small>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="ÊòÜËô´Êóè">
                                                            <small>ÊòÜËô´</small>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="Ê∞¥Êóè">
                                                            <small>Ê∞¥</small>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="Â≤©Áü≥Êóè">
                                                            <small>Â≤©Áü≥</small>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="ÁÇéÊóè">
                                                            <small>ÁÇé</small>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="Èõ∑Êóè">
                                                            <small>Èõ∑</small>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="ÊÅêÁ´úÊóè">
                                                            <small>ÊÅêÁ´ú</small>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="È≠öÊóè">
                                                            <small>È≠ö</small>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="Êµ∑Á´úÊóè">
                                                            <small>Êµ∑Á´ú</small>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="Áà¨Ëô´È°ûÊóè">
                                                            <small>Áà¨Ëô´È°û</small>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="„Çµ„Ç§„Ç≠„ÉÉ„ÇØÊóè">
                                                            <small>„Çµ„Ç§„Ç≠„ÉÉ„ÇØ</small>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="ÂπªÁ´úÊóè">
                                                            <small>ÂπªÁ´ú</small>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="„Çµ„Ç§„Éê„Éº„ÇπÊóè">
                                                            <small>„Çµ„Ç§„Éê„Éº„Çπ</small>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="ÂπªÁ•ûÁç£Êóè">
                                                            <small>ÂπªÁ•ûÁç£</small>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="ÂâµÈÄ†Á•ûÊóè">
                                                            <small>ÂâµÈÄ†Á•û</small>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="ÂπªÊÉ≥È≠îÊóè">
                                                            <small>ÂπªÊÉ≥È≠î</small>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row g-2 mb-2">
                                            <div class="col-md-3">
                                                <label class="form-label small">ÊîªÊíÉÂäõ</label>
                                                <input type="text" name="search_attack" class="form-control form-control-sm">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small">ÂÆàÂÇôÂäõ</label>
                                                <input type="text" name="search_defense" class="form-control form-control-sm">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-12 d-grid"><button type="submit" class="btn btn-info">Ê§úÁ¥¢</button></div>
                            </form>
                            
                            <!-- Bulk edit controls -->
                            <div id="bulk-edit-controls" class="alert alert-info mb-2" style="display: none;">
                                <div class="d-flex flex-wrap align-items-center gap-2">
                                    <span id="selected-count">0‰ª∂ÈÅ∏Êäû</span>
                                    <button class="btn btn-sm btn-outline-primary" id="bulk-add-tags-btn">
                                        <i class="bi bi-tags"></i> „Çø„Ç∞ËøΩÂä†
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning" id="bulk-remove-tags-btn">
                                        <i class="bi bi-tags"></i> „Çø„Ç∞ÂâäÈô§
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" id="bulk-delete-btn">
                                        <i class="bi bi-trash"></i> ‰∏ÄÊã¨ÂâäÈô§
                                    </button>
                                    <button class="btn btn-sm btn-secondary" id="clear-selection-btn">
                                        <i class="bi bi-x-circle"></i> ÈÅ∏ÊäûËß£Èô§
                                    </button>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="input-group w-auto">
                                    <label class="input-group-text" for="items-per-page">Ë°®Á§∫‰ª∂Êï∞</label>
                                    <select class="form-select" id="items-per-page">
                                        <option value="10">10</option>
                                        <option value="20">20</option>
                                        <option value="50" selected>50</option>
                                        <option value="100">100</option>
                                    </select>
                                </div>
                                <div id="pagination-controls"></div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th scope="col" style="width: 30px; min-width: 30px;">
                                                <input type="checkbox" id="select-all-checkbox" class="form-check-input">
                                            </th>
                                            <th scope="col" data-sort="ÂêçÂâç" class="sortable">ÂêçÂâç<i class="bi bi-arrow-down-up ms-1"></i></th>
                                            <th scope="col" data-sort="ÂûãÁï™" class="sortable">ÂûãÁï™<i class="bi bi-arrow-down-up ms-1"></i></th>
                                            <th scope="col" data-sort="„É¨„Ç¢„É™„ÉÜ„Ç£" class="sortable">„É¨„Ç¢<i class="bi bi-arrow-down-up ms-1"></i></th>
                                            <th scope="col" data-sort="ÊûöÊï∞" class="sortable" style="min-width: 50px;">ÊûöÊï∞<i class="bi bi-arrow-down-up ms-1"></i></th>
                                            <th scope="col" data-sort="tags" class="d-none d-sm-table-cell">„Çø„Ç∞</th>
                                            <th scope="col" style="min-width: 80px;">Êìç‰Ωú</th>
                                        </tr>
                                    </thead>
                                    <tbody id="card-table-body"></tbody>
                                </table>
                            </div>
                            <div class="d-flex justify-content-center mt-2">
                                <div id="pagination-controls-bottom"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Points System -->
                    <div class="card mt-3">
                        <div class="card-body">
                            <div class="alert alert-light border-start border-5 border-warning mb-0" role="alert">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-coin text-warning me-2" style="font-size: 1.5rem;"></i>
                                        <div>
                                            <strong>„Éù„Ç§„É≥„Éà</strong>
                                            <div class="d-flex align-items-baseline">
                                                <span class="fs-3 fw-bold text-warning" id="user-points">0</span>
                                                <span class="ms-2 text-muted">pt</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-warning btn-sm" id="point-shop-btn">
                                            <i class="bi bi-palette"></i> „ÉÜ„Éº„Éû
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Collection Stats Dashboard -->
                    <div class="card mt-3" id="stats-dashboard">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-graph-up"></i> „Ç≥„É¨„ÇØ„Ç∑„Éß„É≥Áµ±Ë®à <span id="collector-rank" class="badge bg-warning ms-2"></span>
                            </div>
                            <button class="btn btn-sm btn-light" id="stats-info-btn" title="Áµ±Ë®à„ÅÆË™¨Êòé">
                                <i class="bi bi-info-circle"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-6 col-md-3">
                                    <div class="text-center">
                                        <div class="fs-2 fw-bold text-primary" id="total-cards">0</div>
                                        <small class="text-muted">Á∑è„Ç´„Éº„ÉâÊûöÊï∞</small>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="text-center">
                                        <div class="fs-2 fw-bold text-success" id="unique-cards">0</div>
                                        <small class="text-muted">Á®ÆÈ°ûÊï∞</small>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="text-center">
                                        <div class="fs-2 fw-bold text-warning" id="collection-days">0</div>
                                        <small class="text-muted">ÂèéÈõÜÊó•Êï∞</small>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="text-center">
                                        <div class="fs-2 fw-bold text-info" id="recent-cards">0</div>
                                        <small class="text-muted">‰ªäÈÄ±ËøΩÂä†</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Progress to next milestone -->
                            <div class="mt-3" id="milestone-progress" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="text-muted">Ê¨°„ÅÆ„Éû„Ç§„É´„Çπ„Éà„Éº„É≥„Åæ„Åß</small>
                                    <small class="text-primary fw-bold" id="milestone-text"></small>
                                </div>
                                <div class="progress" style="height: 25px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" id="milestone-bar" role="progressbar" style="width: 0%">
                                        <span id="milestone-percent">0%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Achievements Section -->
                            <div class="mt-3">
                                <div class="d-flex align-items-center justify-content-between mb-2" style="cursor: pointer;" id="achievement-toggle">
                                    <strong>ÂÆüÁ∏æ‰∏ÄË¶ß</strong>
                                    <i class="bi bi-chevron-down" id="achievement-toggle-icon"></i>
                                </div>
                                <div id="achievement-section" style="display: none;">
                                    <div id="achievement-summary-container"></div>
                                    <div id="achievement-details" class="achievement-details"></div>
                                </div>
                            </div>
                            
                            <!-- Rarity Distribution Chart -->
                            <div class="mt-3" id="rarity-chart-container" style="display: none;">
                                <small class="text-muted d-block mb-2">„É¨„Ç¢„É™„ÉÜ„Ç£ÂàÜÂ∏É</small>
                                <div class="d-flex gap-1" id="rarity-bars"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, deleteUser, setPersistence, browserLocalPersistence, sendEmailVerification, applyActionCode } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, query, where, updateDoc, increment, writeBatch, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAOYKalLUb2hbghrjQUS8AWzxpLExBT7aU",
            authDomain: "ygoh-9bcf6.firebaseapp.com",
            projectId: "ygoh-9bcf6",
            storageBucket: "ygoh-9bcf6.firebasestorage.app",
            messagingSenderId: "515041224138",
            appId: "1:515041224138:web:8de47b38ed9cc1bb8afd37",
            measurementId: "G-ZGSRE8MHZ2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        setPersistence(auth, browserLocalPersistence).catch((error) => {
        });

        let cardCollection = [];
        let wishlistCollection = [];
        let currentListType = 'collection'; // 'collection' or 'wishlist'
        let currentUser = null;
        let sortConfig = { key: 'ÂêçÂâç', direction: 'ascending' };
        let currentPage = 1;
        let cardReadingMap = new Map(); // Map for hiragana -> card names
        let cardDetailsMap = new Map(); // Map for card details (level, attribute, etc.)
        // Set smaller initial page size for mobile devices
        let itemsPerPage = window.innerWidth <= 768 ? 20 : 50;
        let filteredCardCollection = [];
        let allTags = [];
        
        // Gamification data - will be synced with Firebase
        let gamificationData = {
            userPoints: 0,
            purchasedItems: {},
            activeTheme: 'default',
            activeFrame: '',
            activeBackground: '',
            activeIcon: '',
            registrationStreak: { count: 0, lastDate: null },
            weeklyGoalData: { weekStart: null, count: 0, goal: 50 },
            todayAdditions: { date: null, count: 0 },
            dailyMissionProgress: {},
            firstCollectionDate: null,
            lastMilestoneReached: 0,
            cardAdditionDates: {},
            hasReceivedFirstLoginBonus: false, // Track first login bonus in Firebase
            // Profile data
            profile: {
                nickname: '',
                icon: 'üë§',
                firstUseDate: null,
                lastUseDate: null,
                usageDays: new Set(),
                maxStreak: 0,
                totalPointsEarned: 0
            }
        };
        
        // Save gamification data to Firebase
        const saveGamificationData = async () => {
            if (!currentUser) return;
            
            try {
                const userDocRef = doc(db, 'userGamification', currentUser.uid);
                // Convert Set to Array for Firebase storage
                const dataToSave = {
                    ...gamificationData,
                    profile: {
                        ...gamificationData.profile,
                        usageDays: gamificationData.profile?.usageDays ? Array.from(gamificationData.profile.usageDays) : []
                    }
                };
                await setDoc(userDocRef, dataToSave, { merge: true });
            } catch (error) {
                console.error('Error saving gamification data:', error);
            }
        };
        
        // Load gamification data from Firebase
        const loadGamificationData = async () => {
            if (!currentUser) return;
            
            try {
                const userDocRef = doc(db, 'userGamification', currentUser.uid);
                const docSnap = await getDoc(userDocRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Convert Array back to Set for usageDays
                    if (data.profile?.usageDays) {
                        data.profile.usageDays = new Set(data.profile.usageDays);
                    }
                    // Merge with default values to ensure all properties exist
                    gamificationData = {
                        ...gamificationData,
                        ...data,
                        profile: {
                            ...gamificationData.profile,
                            ...data.profile
                        }
                    };
                } else {
                    // Initialize new user data
                    await saveGamificationData();
                }
                
                // Track today's usage
                trackDailyUsage();
            } catch (error) {
                console.error('Error loading gamification data:', error);
            }
        };
        let currentCardTags = [];
        let selectedCardIds = new Set();

        // Load Yu-Gi-Oh card reading data from CSV
        const loadCardReadingData = async () => {
            try {
                // Try loading master CSV file first, then fall back to the old file
                let response = await fetch('yugioh_cards_master.csv');
                if (!response.ok) {
                    response = await fetch('yugioh_cards_all_20250914_104808.csv');
                }
                let csvText = await response.text();

                // Remove BOM if present
                if (csvText.charCodeAt(0) === 0xFEFF) {
                    csvText = csvText.substring(1);
                }

                // Parse CSV
                const lines = csvText.split('\n');

                // Check if first column is „Ç´„Éº„ÉâID (new format) or ÂêçÂâç (old format)
                const headers = lines[0].split(',');
                const hasCardId = headers[0].includes('„Ç´„Éº„ÉâID') || headers[0].includes('ID');

                // CSV columns: [„Ç´„Éº„ÉâID,]ÂêçÂâç,Ë™≠„ÅøÊñπ,„É¨„Éô„É´,Â±ûÊÄß,Á®ÆÊóè,„Ç´„Éº„Éâ„Çø„Ç§„Éó,ÊîªÊíÉÂäõ,ÂÆàÂÇôÂäõ,„Ç´„Éº„Éâ„ÉÜ„Ç≠„Çπ„Éà

                // Process each line (skip header)
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    // Parse CSV line (handle commas in quotes)
                    const values = [];
                    let current = '';
                    let inQuotes = false;

                    for (let j = 0; j < line.length; j++) {
                        const char = line[j];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            values.push(current);
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    values.push(current);

                    // Get card data
                    // Handle both formats (with and without „Ç´„Éº„ÉâID)
                    let cardId, cardName, cardReading, level, attribute, race, cardType, attack, defense, cardText;

                    if (hasCardId) {
                        cardId = values[0]?.replace(/^"|"$/g, '').trim();
                        cardName = values[1]?.replace(/^"|"$/g, '').trim();
                        cardReading = values[2]?.replace(/^"|"$/g, '').trim();
                        level = values[3]?.replace(/^"|"$/g, '').trim();
                        attribute = values[4]?.replace(/^"|"$/g, '').trim();
                        race = values[5]?.replace(/^"|"$/g, '').trim();
                        cardType = values[6]?.replace(/^"|"$/g, '').trim();
                        attack = values[7]?.replace(/^"|"$/g, '').trim();
                        defense = values[8]?.replace(/^"|"$/g, '').trim();
                        cardText = values[9]?.replace(/^"|"$/g, '').trim();
                    } else {
                        cardName = values[0]?.replace(/^"|"$/g, '').trim();
                        cardReading = values[1]?.replace(/^"|"$/g, '').trim();
                        level = values[2]?.replace(/^"|"$/g, '').trim();
                        attribute = values[3]?.replace(/^"|"$/g, '').trim();
                        race = values[4]?.replace(/^"|"$/g, '').trim();
                        cardType = values[5]?.replace(/^"|"$/g, '').trim();
                        attack = values[6]?.replace(/^"|"$/g, '').trim();
                        defense = values[7]?.replace(/^"|"$/g, '').trim();
                        cardText = values[8]?.replace(/^"|"$/g, '').trim();
                    }

                    if (cardName) {
                        // Store card details
                        cardDetailsMap.set(cardName, {
                            cardId: cardId || '',
                            reading: cardReading,
                            level: level,
                            attribute: attribute,
                            race: race,
                            cardType: cardType,
                            attack: attack,
                            defense: defense,
                            cardText: cardText
                        });

                        // Store reading mappings
                        if (cardReading) {
                            // Store the reading in lowercase for case-insensitive search
                            const readingKey = cardReading.toLowerCase();

                            // Store multiple cards with same reading
                            if (!cardReadingMap.has(readingKey)) {
                                cardReadingMap.set(readingKey, []);
                            }
                            cardReadingMap.get(readingKey).push(cardName);

                            // Also store hiragana version of the reading if it's in katakana
                            const hiraganaReading = readingKey.replace(/[\u30A1-\u30F6]/g, function(match) {
                                const code = match.charCodeAt(0) - 0x60;
                                return String.fromCharCode(code);
                            });

                            if (hiraganaReading !== readingKey) {
                                if (!cardReadingMap.has(hiraganaReading)) {
                                    cardReadingMap.set(hiraganaReading, []);
                                }
                                cardReadingMap.get(hiraganaReading).push(cardName);
                            }
                        }
                    }
                }

                console.log(`Loaded ${cardReadingMap.size} card readings and ${cardDetailsMap.size} card details from CSV`);

                // Debug: Show first few entries
                let count = 0;
                for (const [name, details] of cardDetailsMap) {
                    if (count++ < 5) {
                        console.log('Sample card in master data:', name);
                    } else {
                        break;
                    }
                }
            } catch (error) {
                console.error('Failed to load card reading data:', error);
            }
        };

        // Load card reading data on page load
        loadCardReadingData();

        const mainApp = document.getElementById('main-app');
        const appLoader = document.getElementById('app-loader');
        const authModal = new bootstrap.Modal(document.getElementById('auth-modal'));
        const editCardModal = new bootstrap.Modal(document.getElementById('edit-card-modal'));
        const cardDetailModal = new bootstrap.Modal(document.getElementById('card-detail-modal'));
        const howToUseModal = new bootstrap.Modal(document.getElementById('how-to-use-modal'));
        const settingsModal = new bootstrap.Modal(document.getElementById('settings-modal'));
        const tagManagementModal = new bootstrap.Modal(document.getElementById('tag-management-modal'));
        const bulkTagModal = new bootstrap.Modal(document.getElementById('bulk-tag-modal'));
        const analysisModal = new bootstrap.Modal(document.getElementById('analysis-modal'));

        // Ensure modals are always visible when opened
        const ensureModalVisible = (modalElement) => {
            if (!modalElement) return;

            // For mobile devices, scroll to top and reset any scroll position
            if (window.innerWidth <= 768) {
                // Reset scroll position to top
                window.scrollTo(0, 0);
                document.body.scrollTop = 0;
                document.documentElement.scrollTop = 0;

                // Ensure modal dialog is properly positioned
                const modalDialog = modalElement.querySelector('.modal-dialog');
                if (modalDialog) {
                    modalDialog.scrollIntoView({ behavior: 'instant', block: 'center' });
                }
            }
        };

        // „É¢„Éº„ÉÄ„É´Ë°®Á§∫ÊôÇ„ÅÆËÉåÊôØ„Çπ„ÇØ„É≠„Éº„É´Âà∂Âæ°
        const disableBodyScroll = () => {
            // „Çπ„Éû„Éº„Éà„Éï„Ç©„É≥„Åß„ÅÆ„Çπ„ÇØ„É≠„Éº„É´„ÇíÁÑ°ÂäπÂåñ
            document.body.style.overflow = 'hidden';
            document.body.style.position = 'fixed';
            document.body.style.width = '100%';
            // ÁèæÂú®„ÅÆ„Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ„Çí‰øùÂ≠ò
            document.body.dataset.scrollY = window.scrollY.toString();
            document.body.style.top = `-${window.scrollY}px`;
        };

        const enableBodyScroll = () => {
            // „Çπ„ÇØ„É≠„Éº„É´„ÇíÂÜçÂ∫¶ÊúâÂäπÂåñ
            const scrollY = document.body.dataset.scrollY || '0';
            document.body.style.overflow = '';
            document.body.style.position = '';
            document.body.style.width = '';
            document.body.style.top = '';
            // ‰øùÂ≠ò„Åó„Å¶„ÅÑ„Åü„Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ„Å´Êàª„Åô
            window.scrollTo(0, parseInt(scrollY));
            delete document.body.dataset.scrollY;
        };

        // Add show event listeners for all modals
        const modalElements = [
            'auth-modal', 'edit-card-modal', 'card-detail-modal',
            'how-to-use-modal', 'settings-modal', 'tag-management-modal',
            'bulk-tag-modal', 'analysis-modal', 'point-shop-modal',
            'profile-modal', 'ranking-modal', 'stats-info-modal',
            'gacha-result-modal'
        ];

        modalElements.forEach(modalId => {
            const modalEl = document.getElementById(modalId);
            if (modalEl) {
                modalEl.addEventListener('show.bs.modal', () => {
                    ensureModalVisible(modalEl);
                    // „É¢„Éê„Ç§„É´„Éá„Éê„Ç§„Çπ„Åß„ÅÆ„ÅøËÉåÊôØ„Çπ„ÇØ„É≠„Éº„É´„ÇíÁÑ°ÂäπÂåñ
                    if (window.innerWidth <= 768) {
                        disableBodyScroll();
                    }
                });

                // Also ensure visibility after modal is fully shown
                modalEl.addEventListener('shown.bs.modal', () => {
                    ensureModalVisible(modalEl);
                });

                // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„ÇãÊôÇ„Å´„Çπ„ÇØ„É≠„Éº„É´„ÇíÂÜçÂ∫¶ÊúâÂäπÂåñ
                modalEl.addEventListener('hidden.bs.modal', () => {
                    // „É¢„Éê„Ç§„É´„Éá„Éê„Ç§„Çπ„Åß„ÅÆ„Åø
                    if (window.innerWidth <= 768) {
                        enableBodyScroll();
                    }
                });
            }
        });
        const authError = document.getElementById('auth-error');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailSpan = document.getElementById('user-email');
        const cardTableBody = document.getElementById('card-table-body');
        const totalCollectionSpan = document.getElementById('total-collection');
        const totalWishlistSpan = document.getElementById('total-wishlist');
        const loadingOverlay = document.getElementById('loading-overlay');
        const addForm = document.getElementById('add-form');
        const searchForm = document.getElementById('search-form');
        const importFileInput = document.getElementById('import-file-input');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const hideEmailToggle = document.getElementById('hide-email-toggle');
        const showSearchHistoryToggle = document.getElementById('show-search-history-toggle');
        const showRegistrationHistoryToggle = document.getElementById('show-registration-history-toggle');
        const useTapQuantityToggle = document.getElementById('use-tap-quantity-toggle');

        const showLoading = (show) => { loadingOverlay.style.display = show ? 'flex' : 'none'; };
        
        const updateHistoryButton = (btnId, storageKey, data, titlePrefix) => {
            const btn = document.getElementById(btnId);
            const show = localStorage.getItem(storageKey) === 'true' && data;
            btn.style.display = show ? 'inline-block' : 'none';
            if (show) btn.title = `${titlePrefix}: ${typeof data === 'object' ? data.name : data}`;
        };
        const updateSearchHistoryButton = () => updateHistoryButton('prev-search-btn', 'showSearchHistory', lastSearchKeyword, 'ÂâçÂõû„ÅÆÊ§úÁ¥¢');
        const updateRegistrationHistoryButton = () => updateHistoryButton('prev-registration-btn', 'showRegistrationHistory', lastRegistrationData, 'ÂâçÂõû„ÅÆÁôªÈå≤');
        
        const escapeHtml = (str) => str == null ? '' : String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
        
        const getCurrentCollection = () => currentListType === 'collection' ? cardCollection : wishlistCollection;
        
        const renderTable = () => {
            const currentData = getCurrentCollection();
            filteredCardCollection.sort((a, b) => {
                let [vA, vB] = [a.data[sortConfig.key], b.data[sortConfig.key]];
                if (sortConfig.key === 'ÊûöÊï∞') {
                    [vA, vB] = [parseInt(vA, 10) || 0, parseInt(vB, 10) || 0];
                } else {
                    [vA, vB] = [String(vA || '').toLowerCase(), String(vB || '').toLowerCase()];
                }
                return vA === vB ? 0 : (vA < vB ? -1 : 1) * (sortConfig.direction === 'ascending' ? 1 : -1);
            });

            // Get table rows setting
            const rowsPerPage = localStorage.getItem('tableRowsPerPage') || '100';
            const actualItemsPerPage = rowsPerPage === 'all' ? filteredCardCollection.length : parseInt(rowsPerPage, 10);

            const startIndex = (currentPage - 1) * actualItemsPerPage;
            const endIndex = startIndex + actualItemsPerPage;
            const paginatedItems = filteredCardCollection.slice(startIndex, endIndex);

            // Use DocumentFragment for better performance
            const fragment = document.createDocumentFragment();

            if (paginatedItems.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="6" class="text-center">Ë©≤ÂΩì„Åô„Çã„Ç´„Éº„Éâ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</td>';
                fragment.appendChild(tr);
            } else {
                // Check if mobile for simplified view
                const isMobile = window.innerWidth <= 768;

                paginatedItems.forEach(card => {
                    const tr = document.createElement('tr');
                    const tags = (card.data.tags || []).map(tag => escapeHtml(tag)).join(', ');
                    const isChecked = selectedCardIds.has(card.id) ? 'checked' : '';

                    if (isMobile) {
                        // Simplified mobile view without tags column
                        tr.innerHTML = `
                            <td>
                                <input type="checkbox" class="form-check-input card-checkbox" data-id="${escapeHtml(card.id)}" ${isChecked}>
                            </td>
                            <td>${escapeHtml(card.data['ÂêçÂâç'])}</td>
                            <td>${escapeHtml(card.data['ÂûãÁï™'])}</td>
                            <td>${escapeHtml(card.data['„É¨„Ç¢„É™„ÉÜ„Ç£'])}</td>
                            <td>${escapeHtml(card.data['ÊûöÊï∞'])}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-info view-detail-btn" data-id="${escapeHtml(card.id)}" data-card-data='${JSON.stringify(card.data).replace(/'/g, "&#39;")}'>Ë©≥Á¥∞</button>
                                <button class="btn btn-sm btn-outline-secondary edit-tags-btn" data-id="${escapeHtml(card.id)}" data-current-tags='${JSON.stringify(card.data.tags || []).replace(/'/g, "&#39;")}'>„Çø„Ç∞</button>
                            </td>
                        `;
                    } else {
                        tr.innerHTML = `
                            <td>
                                <input type="checkbox" class="form-check-input card-checkbox" data-id="${escapeHtml(card.id)}" ${isChecked}>
                            </td>
                            <td>${escapeHtml(card.data['ÂêçÂâç'])}</td>
                            <td>${escapeHtml(card.data['ÂûãÁï™'])}</td>
                            <td>${escapeHtml(card.data['„É¨„Ç¢„É™„ÉÜ„Ç£'])}</td>
                            <td>${escapeHtml(card.data['ÊûöÊï∞'])}</td>
                            <td class="tag-cell d-none d-sm-table-cell" title="${escapeHtml(tags)}">
                                <span class="tags-display" data-card-id="${escapeHtml(card.id)}">${tags}</span>
                                <button class="btn btn-sm btn-link edit-tags-btn" data-id="${escapeHtml(card.id)}" style="padding: 0 0.25rem; display: none;" title="„Çø„Ç∞„ÇíÁ∑®ÈõÜ"><i class="bi bi-pencil-square"></i></button>
                            </td>
                            <td>
                                <button class="btn btn-info btn-sm view-detail-btn" data-name="${escapeHtml(card.data['ÂêçÂâç'])}" title="Ë©≥Á¥∞Ë°®Á§∫"><i class="bi bi-eye"></i></button>
                                <button class="btn btn-primary btn-sm edit-btn" data-id="${escapeHtml(card.id)}"><i class="bi bi-pencil"></i></button>
                                ${currentListType === 'wishlist' ? `<button class="btn btn-success btn-sm move-to-collection-btn" data-id="${escapeHtml(card.id)}" title="ÊâÄÊåÅ„Ç´„Éº„Éâ„Å∏ÁßªÂãï"><i class="bi bi-check-circle"></i></button>` : ''}
                                <button class="btn btn-danger btn-sm delete-btn" data-id="${escapeHtml(card.id)}"><i class="bi bi-trash"></i></button>
                            </td>
                        `;
                    }
                    fragment.appendChild(tr);
                });
            }

            // Clear and append all at once for better performance
            cardTableBody.innerHTML = '';
            cardTableBody.appendChild(fragment);

            updatePaginationControls();
            updateSortIcons();
            updateTotalCounts();
            
            // Update ranking data when collection changes
            if (currentUser) {
                updateUserRankingData();
            }
        };

        const updatePaginationControls = () => {
            const rowsPerPage = localStorage.getItem('tableRowsPerPage') || '100';
            const actualItemsPerPage = rowsPerPage === 'all' ? filteredCardCollection.length : parseInt(rowsPerPage, 10);
            const totalPages = Math.ceil(filteredCardCollection.length / actualItemsPerPage);
            const controlsHtml = `
                <div class="d-flex flex-wrap align-items-center gap-1 gap-sm-2">
                    <span class="text-nowrap">${totalPages > 0 ? currentPage : 0}/${totalPages}„Éö„Éº„Ç∏</span>
                    <span class="text-nowrap">(${filteredCardCollection.length}‰ª∂)</span>
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-secondary" ${currentPage <= 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">Ââç„Å∏</button>
                        <button class="btn btn-outline-secondary" ${currentPage >= totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">Ê¨°„Å∏</button>
                    </div>
                </div>
            `;
            document.getElementById('pagination-controls').innerHTML = controlsHtml;
            document.getElementById('pagination-controls-bottom').innerHTML = controlsHtml;
        };

        window.changePage = (page) => {
            currentPage = page;
            renderTable();
        };

        const renderTagChoices = (containerId, selectedTags) => {
            const container = document.getElementById(containerId);
            container.innerHTML = allTags.map(tag =>
                `<button type="button" class="btn btn-sm ${selectedTags.includes(tag.name) ? 'btn-primary' : 'btn-outline-secondary'} m-1" onclick="toggleTag('${escapeHtml(tag.name)}', ${containerId.startsWith('edit')})">${escapeHtml(tag.name)}</button>`
            ).join('');
        };

        const renderSelectedTags = (containerId, tags) => document.getElementById(containerId).innerHTML = tags.map(tag => `<span class="badge bg-secondary me-1">${escapeHtml(tag)}</span>`).join(' ');

        window.toggleTag = (tagName, isEdit) => {
            const i = currentCardTags.indexOf(tagName);
            i > -1 ? currentCardTags.splice(i, 1) : currentCardTags.push(tagName);
            const [choices, tags] = isEdit ? ['edit-tag-choices-container', 'edit-card-tags-container'] : ['tag-choices-container', 'card-tags-container'];
            renderTagChoices(choices, currentCardTags);
            renderSelectedTags(tags, currentCardTags);
        };

        // Card detail view functionality
        const showCardDetail = (cardName) => {
            const detailContent = document.getElementById('card-detail-content');

            // Check if we have the card details
            if (!cardDetailsMap.has(cardName)) {
                detailContent.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> „Ç´„Éº„Éâ„Äå${escapeHtml(cardName)}„Äç„ÅÆË©≥Á¥∞ÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ
                    </div>
                `;
                return;
            }

            const details = cardDetailsMap.get(cardName);

            // Create detailed card view
            detailContent.innerHTML = `
                <div class="card">
                    <div class="card-header bg-light">
                        <h4 class="mb-0">${escapeHtml(cardName)}</h4>
                        ${details.reading ? `<small class="text-muted">${escapeHtml(details.reading)}</small>` : ''}
                    </div>
                    <div class="card-body">
                        <div class="row">
                            ${details.cardId ? `
                            <div class="col-md-6 mb-3">
                                <strong>„Ç´„Éº„ÉâID:</strong> ${escapeHtml(details.cardId)}
                            </div>` : ''}
                            ${details.cardType ? `
                            <div class="col-md-6 mb-3">
                                <strong>„Ç´„Éº„Éâ„Çø„Ç§„Éó:</strong> ${escapeHtml(details.cardType)}
                            </div>` : ''}
                            ${details.level ? `
                            <div class="col-md-6 mb-3">
                                <strong>„É¨„Éô„É´/„É©„É≥„ÇØ/„É™„É≥„ÇØ:</strong> ${escapeHtml(details.level)}
                            </div>` : ''}
                            ${details.attribute ? `
                            <div class="col-md-6 mb-3">
                                <strong>Â±ûÊÄß:</strong> ${escapeHtml(details.attribute)}
                            </div>` : ''}
                            ${details.race ? `
                            <div class="col-md-6 mb-3">
                                <strong>Á®ÆÊóè:</strong> ${escapeHtml(details.race)}
                            </div>` : ''}
                            ${details.attack ? `
                            <div class="col-md-6 mb-3">
                                <strong>ÊîªÊíÉÂäõ:</strong> ${escapeHtml(details.attack)}
                            </div>` : ''}
                            ${details.defense ? `
                            <div class="col-md-6 mb-3">
                                <strong>ÂÆàÂÇôÂäõ:</strong> ${escapeHtml(details.defense)}
                            </div>` : ''}
                        </div>
                        ${details.cardText ? `
                        <div class="mt-3">
                            <strong>„Ç´„Éº„Éâ„ÉÜ„Ç≠„Çπ„Éà:</strong>
                            <div class="card bg-light p-3 mt-2">
                                <p class="mb-0" style="white-space: pre-line;">${escapeHtml(details.cardText)}</p>
                            </div>
                        </div>` : ''}
                        ${details.cardId ? `
                        <div class="mt-3">
                            <a href="https://www.db.yugioh-card.com/yugiohdb/card_search.action?ope=2&cid=${escapeHtml(details.cardId)}"
                               target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-box-arrow-up-right"></i> ÂÖ¨Âºè„Éá„Éº„Çø„Éô„Éº„Çπ„ÅßË¶ã„Çã
                            </a>
                        </div>` : ''}
                    </div>
                </div>
            `;
        };

        // Quick tag edit functionality
        document.addEventListener('click', async (e) => {
            // Handle view detail button
            if (e.target.closest('.view-detail-btn')) {
                e.preventDefault();
                const btn = e.target.closest('.view-detail-btn');
                const cardName = btn.dataset.name;
                if (cardName) {
                    showCardDetail(cardName);
                    cardDetailModal.show();
                }
            }

            if (e.target.closest('.edit-tags-btn')) {
                e.preventDefault();
                e.stopPropagation();
                const cardId = e.target.closest('.edit-tags-btn').dataset.id;
                const card = getCurrentCollection().find(c => c.id === cardId);
                if (!card) return;

                // Show edit modal with tags focused
                currentCardTags = [...(card.data.tags || [])];
                document.getElementById('edit-card-id').value = cardId;
                document.getElementById('edit-name').value = card.data['ÂêçÂâç'];
                document.getElementById('edit-set-code').value = card.data['ÂûãÁï™'] || '';
                document.getElementById('edit-rarity').value = card.data['„É¨„Ç¢„É™„ÉÜ„Ç£'] || '';
                document.getElementById('edit-quantity').value = card.data['ÊûöÊï∞'];

                renderTagChoices('edit-tag-choices-container', currentCardTags);
                renderSelectedTags('edit-card-tags-container', currentCardTags);

                editCardModal.show();

                // Focus on tags section
                setTimeout(() => {
                    const tagsContainer = document.getElementById('edit-tag-choices-container');
                    if (tagsContainer) {
                        tagsContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 300);
            }
        });

        const updateSortIcons = () => {
            document.querySelectorAll('th.sortable').forEach(th => {
                const icon = th.querySelector('i');
                if (th.dataset.sort === sortConfig.key) {
                    icon.className = sortConfig.direction === 'ascending' ? 'bi bi-sort-down' : 'bi bi-sort-up';
                } else {
                    icon.className = 'bi bi-arrow-down-up';
                }
            });
        };

        const updateTotalCounts = () => {
            const totalCollection = cardCollection.reduce((sum, card) => sum + (card.data['ÊûöÊï∞'] || 0), 0);
            const totalWishlist = wishlistCollection.reduce((sum, card) => sum + (card.data['ÊûöÊï∞'] || 0), 0);
            totalCollectionSpan.textContent = totalCollection;
            totalWishlistSpan.textContent = totalWishlist;
            updateCollectionStats(); // Update gamification stats
        };
        
        // Gamification features - now loaded from Firebase
        
        // Achievement categories with expanded variety
        const ACHIEVEMENT_CATEGORIES = {
            'ÊûöÊï∞': [
                { id: 'cards10', name: '„Éï„Ç°„Éº„Çπ„Éà„Çπ„ÉÜ„ÉÉ„Éó', desc: '10Êûö', threshold: 10, class: 'bronze' },
                { id: 'cards25', name: '„Ç≥„É¨„ÇØ„Çø„Éº', desc: '25Êûö', threshold: 25, class: 'bronze' },
                { id: 'cards50', name: 'ÁÜüÁ∑¥ËÄÖ', desc: '50Êûö', threshold: 50, class: 'silver' },
                { id: 'cards100', name: '„Ç®„Ç≠„Çπ„Éë„Éº„Éà', desc: '100Êûö', threshold: 100, class: 'silver' },
                { id: 'cards250', name: '„Éô„ÉÜ„É©„É≥', desc: '250Êûö', threshold: 250, class: 'gold' },
                { id: 'cards500', name: '„Éû„Çπ„Çø„Éº', desc: '500Êûö', threshold: 500, class: 'gold' },
                { id: 'cards1000', name: '„Ç∞„É©„É≥„Éâ„Éû„Çπ„Çø„Éº', desc: '1000Êûö', threshold: 1000, class: 'platinum' },
                { id: 'cards2500', name: '„ÉÅ„É£„É≥„Éî„Ç™„É≥', desc: '2500Êûö', threshold: 2500, class: 'platinum' },
                { id: 'cards5000', name: '„É¨„Ç∏„Çß„É≥„Éâ', desc: '5000Êûö', threshold: 5000, class: 'diamond' },
                { id: 'cards10000', name: '„Éü„Ç∑„ÉÉ„ÇØ', desc: '10000Êûö', threshold: 10000, class: 'diamond' },
                { id: 'cards25000', name: '„Ç§„É¢„Éº„Çø„É´', desc: '25000Êûö', threshold: 25000, class: 'mythic' },
                { id: 'cards50000', name: '„Ç®„Çø„Éº„Éä„É´', desc: '50000Êûö', threshold: 50000, class: 'mythic' },
                { id: 'cards100000', name: '„Ç™„É†„Éã', desc: '100000Êûö', threshold: 100000, class: 'mythic' }
            ],
            'Á®ÆÈ°û': [
                { id: 'unique5', name: '„Éê„É©„Ç®„ÉÜ„Ç£', desc: '5Á®ÆÈ°û', threshold: 5, class: 'bronze', type: 'unique' },
                { id: 'unique10', name: '„Ç≥„É¨„ÇØ„Çø„Éº', desc: '10Á®ÆÈ°û', threshold: 10, class: 'bronze', type: 'unique' },
                { id: 'unique25', name: 'Êé¢Ê±ÇËÄÖ', desc: '25Á®ÆÈ°û', threshold: 25, class: 'silver', type: 'unique' },
                { id: 'unique50', name: 'Á†îÁ©∂ËÄÖ', desc: '50Á®ÆÈ°û', threshold: 50, class: 'silver', type: 'unique' },
                { id: 'unique100', name: 'Â≠¶ËÄÖ', desc: '100Á®ÆÈ°û', threshold: 100, class: 'gold', type: 'unique' },
                { id: 'unique200', name: 'ÂçöÂ£´', desc: '200Á®ÆÈ°û', threshold: 200, class: 'gold', type: 'unique' },
                { id: 'unique500', name: 'ÁôæÁßë‰∫ãÂÖ∏', desc: '500Á®ÆÈ°û', threshold: 500, class: 'platinum', type: 'unique' },
                { id: 'unique1000', name: '„Ç¢„Éº„Ç´„Ç§„Éñ', desc: '1000Á®ÆÈ°û', threshold: 1000, class: 'diamond', type: 'unique' }
            ],
            '„É¨„Ç¢„É™„ÉÜ„Ç£': [
                { id: 'rare5', name: 'R„Éè„É≥„Çø„Éº', desc: 'R‰ª•‰∏ä5Êûö', threshold: 5, class: 'bronze', type: 'rarity' },
                { id: 'rare25', name: 'SR„Éè„É≥„Çø„Éº', desc: 'SR‰ª•‰∏ä25Êûö', threshold: 25, class: 'silver', type: 'sr' },
                { id: 'rare50', name: 'UR„Éè„É≥„Çø„Éº', desc: 'UR‰ª•‰∏ä50Êûö', threshold: 50, class: 'gold', type: 'ur' },
                { id: 'rare100', name: 'SE„Éè„É≥„Çø„Éº', desc: 'SEÁ≥ª100Êûö', threshold: 100, class: 'platinum', type: 'se' },
                { id: 'premium10', name: '„Éó„É¨„Éü„Ç¢„É†', desc: 'PÁ≥ª10Êûö', threshold: 10, class: 'gold', type: 'premium' },
                { id: 'ul5', name: 'UL„Ç≥„É¨„ÇØ„Çø„Éº', desc: 'UL5Êûö', threshold: 5, class: 'platinum', type: 'ul' },
                { id: 'qcse1', name: 'QCSEÊâÄÊåÅËÄÖ', desc: 'QCSE1Êûö', threshold: 1, class: 'mythic', type: 'qcse' }
            ],
            'Á∂ôÁ∂ö': [
                { id: 'days3', name: '„Éì„ÇÆ„Éä„Éº', desc: '3Êó•Èñì', threshold: 3, class: 'bronze', type: 'days' },
                { id: 'days7', name: 'ÈÄ±Èñì„Éó„É¨„Ç§„É§„Éº', desc: '7Êó•Èñì', threshold: 7, class: 'bronze', type: 'days' },
                { id: 'days30', name: 'ÊúàÈñì„Éó„É¨„Ç§„É§„Éº', desc: '30Êó•Èñì', threshold: 30, class: 'silver', type: 'days' },
                { id: 'days90', name: '„Ç∑„Éº„Ç∫„É≥„Éó„É¨„Ç§„É§„Éº', desc: '90Êó•Èñì', threshold: 90, class: 'gold', type: 'days' },
                { id: 'days180', name: 'ÂçäÂπ¥„Éó„É¨„Ç§„É§„Éº', desc: '180Êó•Èñì', threshold: 180, class: 'platinum', type: 'days' },
                { id: 'days365', name: 'Âπ¥Èñì„Éó„É¨„Ç§„É§„Éº', desc: '365Êó•Èñì', threshold: 365, class: 'diamond', type: 'days' },
                { id: 'days730', name: '„Éô„ÉÜ„É©„É≥', desc: '730Êó•Èñì', threshold: 730, class: 'mythic', type: 'days' }
            ],
            'ÁâπÊÆä': [
                { id: 'speed10', name: '„Çπ„Éî„Éº„Éâ„É©„É≥', desc: '‰∏ÄÊó•„Åß10ÊûöËøΩÂä†', threshold: 10, class: 'silver', type: 'daily' },
                { id: 'speed50', name: '„Éû„É©„ÇΩ„É≥„É©„É≥„Éä„Éº', desc: '‰∏ÄÊó•„Åß50ÊûöËøΩÂä†', threshold: 50, class: 'gold', type: 'daily' },
                { id: 'weekend100', name: 'ÈÄ±Êú´„Éè„É≥„Çø„Éº', desc: '‰∏ÄÈÄ±Èñì„Åß100Êûö', threshold: 100, class: 'gold', type: 'weekly' },
                { id: 'completionist', name: '„Ç≥„É≥„Éó„É™„Éº„Éà', desc: '„Çø„Ç∞10ÂÄã‰ª•‰∏ä‰ΩøÁî®', threshold: 10, class: 'platinum', type: 'tags' },
                { id: 'organizer', name: 'Êï¥ÁêÜÈÅî‰∫∫', desc: '„Çø„Ç∞20ÂÄã‰ª•‰∏ä‰ΩúÊàê', threshold: 20, class: 'diamond', type: 'tags' }
            ]
        };
        
        // Flatten achievements for backward compatibility
        const ACHIEVEMENTS = Object.values(ACHIEVEMENT_CATEGORIES).flat();
        
        const MILESTONES = [10, 25, 50, 75, 100, 150, 200, 300, 500, 1000, 1500, 2000, 3000, 5000, 7500, 10000, 15000, 20000, 30000, 50000, 75000, 100000];
        
        const getRarityScore = (rarity) => {
            if (!rarity) return 1;
            const rarityLower = rarity.toLowerCase();
            if (rarityLower.includes('„Ç¶„É´„Éà„É©') || rarityLower.includes('ultra')) return 5;
            if (rarityLower.includes('„Çπ„Éº„Éë„Éº') || rarityLower.includes('super')) return 4;
            if (rarityLower.includes('„É¨„Ç¢') || rarityLower.includes('rare')) return 3;
            if (rarityLower.includes('„Éé„Éº„Éû„É´') || rarityLower.includes('normal')) return 2;
            return 1;
        };
        
        // Track card addition dates - now in gamificationData
        
        // Fun Dashboard Features
        const DAILY_MISSIONS = [
            { id: 'add3', text: '3Êûö„ÅÆ„Ç´„Éº„Éâ„ÇíËøΩÂä†', target: 3, type: 'add' },
            { id: 'addRare', text: '„É¨„Ç¢‰ª•‰∏ä„ÅÆ„Ç´„Éº„Éâ„Çí1ÊûöËøΩÂä†', target: 1, type: 'rare' },
            { id: 'addTag', text: '„Çø„Ç∞‰ªò„Åç„Ç´„Éº„Éâ„ÇíËøΩÂä†', target: 1, type: 'tag' },
            { id: 'search5', text: '5ÂõûÊ§úÁ¥¢„ÇíÂÆüË°å', target: 5, type: 'search' },
            { id: 'unique2', text: '2Á®ÆÈ°û„ÅÆÁï∞„Å™„Çã„Ç´„Éº„Éâ„ÇíËøΩÂä†', target: 2, type: 'unique' }
        ];
        
        // Point System - now in gamificationData
        
        const POINT_REWARDS = {
            addCard: 5,          // „Ç´„Éº„ÉâËøΩÂä†
            addRareCard: 10,     // „É¨„Ç¢„Ç´„Éº„ÉâËøΩÂä†
            completeMission: 20, // „Éü„ÉÉ„Ç∑„Éß„É≥ÂÆå‰∫Ü
            dailyLogin: 10,      // „Éá„Ç§„É™„Éº„É≠„Ç∞„Ç§„É≥
            weekStreak: 50,      // ÈÄ±Èñì„Çπ„Éà„É™„Éº„ÇØ
        };
        
        const SHOP_ITEMS = {
            themes: [
                // Basic themes (50-100pt)
                { id: 'theme-light-blue', name: '„É©„Ç§„Éà„Éñ„É´„Éº', class: 'theme-light-blue', cost: 50, preview: 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)' },
                { id: 'theme-mint', name: '„Éü„É≥„Éà', class: 'theme-mint', cost: 80, preview: 'linear-gradient(135deg, #c8e6c9 0%, #81c784 100%)' },
                { id: 'theme-peach', name: '„Éî„Éº„ÉÅ', class: 'theme-peach', cost: 80, preview: 'linear-gradient(135deg, #ffccbc 0%, #ffab91 100%)' },
                
                // Mid-tier themes (100-200pt)
                { id: 'theme-ocean', name: '„Ç™„Éº„Ç∑„É£„É≥', class: 'theme-ocean', cost: 150, preview: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
                { id: 'theme-forest', name: '„Éï„Ç©„É¨„Çπ„Éà', class: 'theme-forest', cost: 120, preview: 'linear-gradient(135deg, #0ba360 0%, #3cba92 100%)' },
                { id: 'theme-sunset', name: '„Çµ„É≥„Çª„ÉÉ„Éà', class: 'theme-sunset', cost: 180, preview: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' },
                { id: 'theme-cherry', name: '„ÉÅ„Çß„É™„Éº', class: 'theme-cherry', cost: 150, preview: 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)' },
                { id: 'theme-sakura', name: 'Ê°ú', class: 'theme-sakura', cost: 200, preview: 'linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%)' },
                
                // Premium themes (250-500pt)
                { id: 'theme-galaxy', name: '„ÇÆ„É£„É©„ÇØ„Ç∑„Éº', class: 'theme-galaxy', cost: 300, preview: 'linear-gradient(135deg, #4776E6 0%, #8E54E9 100%)' },
                { id: 'theme-midnight', name: '„Éü„ÉÉ„Éâ„Éä„Ç§„Éà', class: 'theme-midnight', cost: 350, preview: 'linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%)' },
                { id: 'theme-fire', name: '„Éï„Ç°„Ç§„Ç¢', class: 'theme-fire', cost: 400, preview: 'linear-gradient(135deg, #ff9a56 0%, #ff6a88 50%, #ff2d55 100%)' },
                { id: 'theme-aurora', name: '„Ç™„Éº„É≠„É©', class: 'theme-aurora', cost: 450, preview: 'linear-gradient(135deg, #00d2ff 0%, #3a7bd5 50%, #00d2ff 100%)' },
                { id: 'theme-neon', name: '„Éç„Ç™„É≥', class: 'theme-neon', cost: 500, preview: 'linear-gradient(135deg, #f953c6 0%, #b91d73 100%)' },
                
                // Ultra premium themes (600-1000pt)
                { id: 'theme-cosmic', name: '„Ç≥„Ç∫„Éü„ÉÉ„ÇØ', class: 'theme-cosmic', cost: 600, preview: 'linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f953c6 100%)' },
                { id: 'theme-rainbow', name: '„É¨„Ç§„É≥„Éú„Éº', class: 'theme-rainbow', cost: 800, preview: 'linear-gradient(135deg, #ff0000 0%, #ff7f00 17%, #ffff00 33%, #00ff00 50%, #0000ff 67%, #4b0082 83%, #9400d3 100%)' },
                { id: 'theme-holographic', name: '„Éõ„É≠„Ç∞„É©„Éï„Ç£„ÉÉ„ÇØ', class: 'theme-holographic', cost: 900, preview: 'linear-gradient(135deg, #a8edea 0%, #fed6e3 25%, #ffeaa7 50%, #dfe6e9 75%, #a8edea 100%)' },
                { id: 'theme-dragon-soul', name: '„Éâ„É©„Ç¥„É≥„ÇΩ„Ç¶„É´', class: 'theme-dragon-soul', cost: 1200, preview: 'linear-gradient(135deg, #f83600 0%, #f9d423 50%, #f83600 100%)' },
                { id: 'theme-legendary', name: '„É¨„Ç∏„Çß„É≥„ÉÄ„É™„Éº', class: 'theme-legendary', cost: 1500, preview: 'linear-gradient(135deg, #ffd700 0%, #ff6347 25%, #ff1493 50%, #00ced1 75%, #ffd700 100%)' },
            ],
            frames: [
                // Basic frames (50-100pt)
                { id: 'frame-simple', name: '„Ç∑„É≥„Éó„É´', cost: 50, description: '„Ç∑„É≥„Éó„É´„Å™Êû†Á∑ö', class: 'frame-simple' },
                { id: 'frame-bold', name: '„Éú„Éº„É´„Éâ', cost: 80, description: 'Â§™„ÅÑÊû†Á∑ö', class: 'frame-bold' },
                { id: 'frame-dotted', name: '„Éâ„ÉÉ„Éà', cost: 60, description: 'ÁÇπÁ∑ö„ÅÆÊû†', class: 'frame-dotted' },
                
                // Mid-tier frames (120-250pt)
                { id: 'frame-silver', name: '„Ç∑„É´„Éê„Éº', cost: 120, description: 'ÈäÄËâ≤„ÅÆÊû†Á∑ö', class: 'frame-silver' },
                { id: 'frame-gold', name: '„Ç¥„Éº„É´„Éâ', cost: 200, description: '„Ç´„Éº„Éâ„Å´ÈáëËâ≤„ÅÆÊû†Á∑ö', class: 'frame-gold' },
                { id: 'frame-fire', name: 'ÁÇé', cost: 250, description: 'ÁáÉ„Åà‰∏ä„Åå„Çã„Éï„É¨„Éº„É†', class: 'frame-fire' },
                { id: 'frame-ice', name: 'Ê∞∑', cost: 250, description: 'ÂÜ∑„Åü„ÅèËºù„Åè„Éï„É¨„Éº„É†', class: 'frame-ice' },
                { id: 'frame-nature', name: 'Ëá™ÁÑ∂', cost: 180, description: 'Ëëâ„Å£„Å±„ÅßÈ£æ„Çâ„Çå„ÅüÊû†', class: 'frame-nature' },
                
                // Premium frames (300-500pt)
                { id: 'frame-rainbow', name: '„É¨„Ç§„É≥„Éú„Éº', cost: 350, description: 'ËôπËâ≤„Å´Ëºù„ÅèÊû†Á∑ö', class: 'frame-rainbow' },
                { id: 'frame-electric', name: 'ÈõªÊ∞ó', cost: 320, description: 'ÈõªÊíÉ„ÅåËµ∞„Çã„Éï„É¨„Éº„É†', class: 'frame-electric' },
                { id: 'frame-diamond', name: '„ÉÄ„Ç§„É§„É¢„É≥„Éâ', cost: 400, description: '„Ç≠„É©„Ç≠„É©ÂÖâ„ÇãÈ´òÁ¥ö„Éï„É¨„Éº„É†', class: 'frame-diamond' },
                { id: 'frame-plasma', name: '„Éó„É©„Ç∫„Éû', cost: 450, description: '„Éó„É©„Ç∫„Éû„ÅåÊµÅ„Çå„ÇãÊû†', class: 'frame-plasma' },
                { id: 'frame-crystal', name: '„ÇØ„É™„Çπ„Çø„É´', cost: 500, description: 'Ê∞¥Êô∂„ÅÆ„Çà„ÅÜ„Å™ÈÄèÊòéÊÑü', class: 'frame-crystal' },
                
                // Ultra premium frames (600-1500pt)
                { id: 'frame-legendary', name: '„É¨„Ç∏„Çß„É≥„ÉÄ„É™„Éº', cost: 700, description: '‰ºùË™¨Á¥ö„ÅÆË±™ËèØ„Å™Êû†', class: 'frame-legendary' },
                { id: 'frame-mythic', name: '„Éü„Ç∑„ÉÉ„ÇØ', cost: 900, description: 'Á•ûË©±Á¥ö„ÅÆÁ•ûÁßòÁöÑ„Å™Êû†', class: 'frame-mythic' },
                { id: 'frame-ultimate', name: '„Ç¢„É´„ÉÜ„Ç£„É°„ÉÉ„Éà', cost: 1100, description: 'Á©∂Ê•µ„ÅÆË£ÖÈ£æÊû†', class: 'frame-ultimate' },
                { id: 'frame-god', name: '„Ç¥„ÉÉ„Éâ', cost: 1500, description: 'Á•û„ÄÖ„Åó„ÅÑÂÖâ„ÅÆÊû†', class: 'frame-god' },
            ],
            backgrounds: [
                // Basic backgrounds (50-100pt)
                { id: 'bg-gradient', name: '„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥', cost: 50, description: 'Áæé„Åó„ÅÑËâ≤„ÅÆÂ§âÂåñ', class: 'bg-gradient' },
                { id: 'bg-dots', name: '„Éâ„ÉÉ„Éà', cost: 60, description: '„Åã„Çè„ÅÑ„ÅÑ„Éâ„ÉÉ„Éà„Éë„Çø„Éº„É≥', class: 'bg-dots' },
                { id: 'bg-stripes', name: '„Çπ„Éà„É©„Ç§„Éó', cost: 60, description: 'Á∏ûÊ®°Êßò„ÅÆËÉåÊôØ', class: 'bg-stripes' },
                { id: 'bg-checker', name: '„ÉÅ„Çß„ÉÉ„Ç´„Éº', cost: 80, description: 'Â∏ÇÊùæÊ®°Êßò', class: 'bg-checker' },
                
                // Mid-tier backgrounds (120-250pt)
                { id: 'bg-clouds', name: 'Èõ≤', cost: 120, description: '„Åµ„Çè„Åµ„ÇèÈõ≤', class: 'bg-clouds' },
                { id: 'bg-waves', name: 'Ê≥¢', cost: 150, description: 'ÂÑ™ÈõÖ„Å™Ê≥¢„ÅÆ„Éë„Çø„Éº„É≥', class: 'bg-waves' },
                { id: 'bg-geometric', name: 'Âπæ‰ΩïÂ≠¶', cost: 180, description: '„É¢„ÉÄ„É≥„Å™Âπæ‰ΩïÂ≠¶„Éë„Çø„Éº„É≥', class: 'bg-geometric' },
                { id: 'bg-hexagon', name: '„Éò„Ç≠„Çµ„Ç¥„É≥', cost: 200, description: 'ÂÖ≠ËßíÂΩ¢„Éë„Çø„Éº„É≥', class: 'bg-hexagon' },
                { id: 'bg-circuit', name: 'ÂõûË∑Ø', cost: 220, description: '„Çµ„Ç§„Éê„ÉºÂõûË∑Ø„Éë„Çø„Éº„É≥', class: 'bg-circuit' },
                
                // Premium backgrounds (250-500pt)
                { id: 'bg-stars', name: 'ÊòüÁ©∫', cost: 300, description: '„Åç„Çâ„ÇÅ„ÅèÊòüÁ©∫', class: 'bg-stars' },
                { id: 'bg-particles', name: '„Éë„Éº„ÉÜ„Ç£„ÇØ„É´', cost: 350, description: 'Âãï„ÅèÁ≤íÂ≠ê„Ç®„Éï„Çß„ÇØ„Éà', class: 'bg-particles' },
                { id: 'bg-galaxy', name: 'ÈäÄÊ≤≥', cost: 400, description: 'Â£ÆÂ§ß„Å™ÈäÄÊ≤≥„ÅÆËÉåÊôØ', class: 'bg-galaxy' },
                { id: 'bg-aurora', name: '„Ç™„Éº„É≠„É©', cost: 450, description: 'Áæé„Åó„ÅÑ„Ç™„Éº„É≠„É©„ÅÆËÉåÊôØ', class: 'bg-aurora' },
                { id: 'bg-crystal', name: '„ÇØ„É™„Çπ„Çø„É´', cost: 500, description: '„ÇØ„É™„Çπ„Çø„É´„ÅÆËºù„Åç', class: 'bg-crystal' },
                
                // Ultra premium backgrounds (600-1500pt)
                { id: 'bg-matrix', name: '„Éû„Éà„É™„ÉÉ„ÇØ„Çπ', cost: 600, description: '„Éá„Ç∏„Çø„É´„Éû„Éà„É™„ÉÉ„ÇØ„Çπ', class: 'bg-matrix' },
                { id: 'bg-nebula', name: '„Éç„Éì„É•„É©', cost: 800, description: 'ÂÆáÂÆô„ÅÆÊòüÈõ≤', class: 'bg-nebula' },
                { id: 'bg-dimension', name: 'Ê¨°ÂÖÉ', cost: 1000, description: 'Â§öÊ¨°ÂÖÉÁ©∫Èñì„ÅÆËÉåÊôØ', class: 'bg-dimension' },
                { id: 'bg-void', name: '„É¥„Ç©„Ç§„Éâ', cost: 1200, description: 'ËôöÁ©∫„ÅÆÊ∑±Ê∑µ', class: 'bg-void' },
                { id: 'bg-infinity', name: '„Ç§„É≥„Éï„Ç£„Éã„ÉÜ„Ç£', cost: 1500, description: 'ÁÑ°Èôê„ÅÆÂΩºÊñπ', class: 'bg-infinity' },
            ],
            icons: [
                // Basic icons (50-150pt)
                { id: 'icon-star', name: '„Çπ„Çø„Éº', cost: 50, class: 'icon-star', emoji: '‚ú®' },
                { id: 'icon-heart', name: '„Éè„Éº„Éà', cost: 60, class: 'icon-heart', emoji: '‚ù§Ô∏è' },
                { id: 'icon-ghost', name: '„Ç¥„Éº„Çπ„Éà', cost: 80, class: 'icon-ghost', emoji: 'üëª' },
                { id: 'icon-crown', name: 'ÁéãÂÜ†', cost: 100, class: 'icon-crown', emoji: 'üëë' },
                { id: 'icon-robot', name: '„É≠„Éú„ÉÉ„Éà', cost: 120, class: 'icon-robot', emoji: 'ü§ñ' },
                { id: 'icon-alien', name: '„Ç®„Ç§„É™„Ç¢„É≥', cost: 150, class: 'icon-alien', emoji: 'üëΩ' },
                { id: 'icon-devil', name: '„Éá„Éì„É´', cost: 180, class: 'icon-devil', emoji: 'üòà' },
                { id: 'icon-sword', name: 'Ââ£', cost: 200, class: 'icon-sword', emoji: '‚öîÔ∏è' },
                { id: 'icon-wizard', name: 'È≠îÊ≥ï‰Ωø„ÅÑ', cost: 250, class: 'icon-wizard', emoji: 'üßô' },
                { id: 'icon-dragon', name: '„Éâ„É©„Ç¥„É≥', cost: 300, class: 'icon-dragon', emoji: 'üêâ' },
                { id: 'icon-phoenix', name: '‰∏çÊ≠ªÈ≥•', cost: 350, class: 'icon-phoenix', emoji: 'ü¶Ö' },
                { id: 'icon-unicorn', name: '„É¶„Éã„Ç≥„Éº„É≥', cost: 400, class: 'icon-unicorn', emoji: 'ü¶Ñ' },
                { id: 'icon-ninja', name: 'ÂøçËÄÖ', cost: 450, class: 'icon-ninja', emoji: 'ü•∑' },
                { id: 'icon-monster', name: '„É¢„É≥„Çπ„Çø„Éº', cost: 600, class: 'icon-monster', emoji: 'üëπ' },
                { id: 'icon-legendary', name: '„É¨„Ç∏„Çß„É≥„ÉÄ„É™„Éº', cost: 700, class: 'icon-legendary', emoji: 'üí´' },
                { id: 'icon-infinity', name: '„Ç§„É≥„Éï„Ç£„Éã„ÉÜ„Ç£', cost: 800, class: 'icon-infinity', emoji: '‚ôæÔ∏è' },
                
                // New emoji icons (300-800pt)
                { id: 'icon-fire', name: 'ÁÇé', cost: 350, class: 'icon-fire', emoji: 'üî•' },
                { id: 'icon-skull', name: '„Éâ„ÇØ„É≠', cost: 450, class: 'icon-skull', emoji: 'üíÄ' },
                { id: 'icon-newmoon', name: 'Êñ∞Êúà', cost: 300, class: 'icon-newmoon', emoji: 'üåë' },
                { id: 'icon-moon', name: 'Êúà', cost: 350, class: 'icon-moon', emoji: 'üåô' },
                { id: 'icon-tornado', name: 'Á´úÂ∑ª', cost: 500, class: 'icon-tornado', emoji: 'üå™Ô∏è' },
                { id: 'icon-star2', name: 'Êòü', cost: 300, class: 'icon-star2', emoji: 'üåü' },
                { id: 'icon-swords', name: '‰∫§Â∑ÆÂâ£', cost: 400, class: 'icon-swords', emoji: '‚öîÔ∏è' },
                { id: 'icon-dagger', name: 'Áü≠Ââ£', cost: 350, class: 'icon-dagger', emoji: 'üó°Ô∏è' },
                { id: 'icon-bat', name: '„Ç≥„Ç¶„É¢„É™', cost: 400, class: 'icon-bat', emoji: 'ü¶á' },
                { id: 'icon-bone', name: 'È™®', cost: 300, class: 'icon-bone', emoji: 'ü¶¥' },
                { id: 'icon-fox', name: 'Áãê', cost: 550, class: 'icon-fox', emoji: 'ü¶ä' },
                
                // Special symbols (300-800pt)
                { id: 'icon-cross', name: '„ÇØ„É≠„Çπ', cost: 450, class: 'icon-cross', emoji: '‚Ä†' },
                { id: 'icon-star3', name: '„Çπ„Çø„Éº‚ú™', cost: 350, class: 'icon-star3', emoji: '‚ú™' },
                { id: 'icon-star4', name: '„Çπ„Çø„Éº‚úß', cost: 400, class: 'icon-star4', emoji: '‚úß' },
                { id: 'icon-star5', name: '„Çπ„Çø„Éº‚úµ', cost: 450, class: 'icon-star5', emoji: '‚úµ' },
                { id: 'icon-star6', name: '„Çπ„Çø„Éº‚úØ', cost: 500, class: 'icon-star6', emoji: '‚úØ' },
                { id: 'icon-star7', name: '„Çπ„Çø„Éº‚úπ', cost: 550, class: 'icon-star7', emoji: '‚úπ' },
                { id: 'icon-star8', name: '„Çπ„Çø„Éº‚ùÇ', cost: 600, class: 'icon-star8', emoji: '‚ùÇ' },
                { id: 'icon-star9', name: '„Çπ„Çø„Éº‚ùâ', cost: 650, class: 'icon-star9', emoji: '‚ùâ' },
                { id: 'icon-cross2', name: 'ÂçÅÂ≠óÊû∂', cost: 700, class: 'icon-cross2', emoji: '‚ò©' },
                { id: 'icon-star10', name: '„Çπ„Çø„Éº‚ú¶', cost: 350, class: 'icon-star10', emoji: '‚ú¶' },
                { id: 'icon-star11', name: '„Çπ„Çø„Éº‚ú∂', cost: 400, class: 'icon-star11', emoji: '‚ú∂' },
                { id: 'icon-star12', name: '„Çπ„Çø„Éº‚ú∏', cost: 450, class: 'icon-star12', emoji: '‚ú∏' },
                { id: 'icon-star13', name: '„Çπ„Çø„Éº‚ú∫', cost: 500, class: 'icon-star13', emoji: '‚ú∫' },
                { id: 'icon-star14', name: '„Çπ„Çø„Éº‚úÆ', cost: 550, class: 'icon-star14', emoji: '‚úÆ' },
                
                // Chess pieces (400-700pt)
                { id: 'icon-queen', name: '„ÇØ„Ç§„Éº„É≥', cost: 700, class: 'icon-queen', emoji: '‚ôõ' },
                { id: 'icon-knight', name: '„Éä„Ç§„Éà', cost: 550, class: 'icon-knight', emoji: '‚ôû' },
                { id: 'icon-pawn', name: '„Éù„Éº„É≥', cost: 400, class: 'icon-pawn', emoji: '‚ôü' },
                { id: 'icon-spade', name: '„Çπ„Éö„Éº„Éâ', cost: 450, class: 'icon-spade', emoji: '‚ô§' },
                { id: 'icon-club', name: '„ÇØ„É©„Éñ', cost: 450, class: 'icon-club', emoji: '‚ôß' },
                { id: 'icon-king', name: '„Ç≠„É≥„Ç∞', cost: 750, class: 'icon-king', emoji: '‚ôö' },
                { id: 'icon-queen2', name: '„ÇØ„Ç§„Éº„É≥‚ôï', cost: 700, class: 'icon-queen2', emoji: '‚ôï' },
                { id: 'icon-rook', name: '„É´„Éº„ÇØ', cost: 600, class: 'icon-rook', emoji: '‚ôñ' },
                { id: 'icon-rookb', name: '„É´„Éº„ÇØ‚ôú', cost: 600, class: 'icon-rookb', emoji: '‚ôú' },
                { id: 'icon-bishop', name: '„Éì„Ç∑„Éß„ÉÉ„Éó', cost: 550, class: 'icon-bishop', emoji: '‚ôó' },
                { id: 'icon-bishopb', name: '„Éì„Ç∑„Éß„ÉÉ„Éó‚ôù', cost: 550, class: 'icon-bishopb', emoji: '‚ôù' },
                
                // Mystical symbols (500-800pt)
                { id: 'icon-ankh', name: '„Ç¢„É≥„ÇØ', cost: 650, class: 'icon-ankh', emoji: '‚ò•' },
                { id: 'icon-mercury', name: 'Ê∞¥Êòü', cost: 500, class: 'icon-mercury', emoji: '‚òø' },
                { id: 'icon-jupiter', name: 'Êú®Êòü', cost: 550, class: 'icon-jupiter', emoji: '‚ôÉ' },
                { id: 'icon-saturn', name: 'ÂúüÊòü', cost: 600, class: 'icon-saturn', emoji: '‚ôÑ' },
                { id: 'icon-uranus', name: 'Â§©ÁéãÊòü', cost: 650, class: 'icon-uranus', emoji: '‚ôÖ' },
                { id: 'icon-neptune', name: 'Êµ∑ÁéãÊòü', cost: 700, class: 'icon-neptune', emoji: '‚ôÜ' },
                { id: 'icon-pluto', name: 'ÂÜ•ÁéãÊòü', cost: 750, class: 'icon-pluto', emoji: '‚ôá' },
                { id: 'icon-sun', name: 'Â§™ÈôΩ', cost: 800, class: 'icon-sun', emoji: '‚òº' },
                { id: 'icon-moon2', name: 'Êúà‚òΩ', cost: 400, class: 'icon-moon2', emoji: '‚òΩ' },
                { id: 'icon-constellation', name: 'ÊòüÂ∫ß', cost: 450, class: 'icon-constellation', emoji: '‚òæ' },
                { id: 'icon-cross3', name: 'ÂçÅÂ≠ó‚úû', cost: 500, class: 'icon-cross3', emoji: '‚úû' },
                { id: 'icon-cross4', name: 'ÂçÅÂ≠ó‚úü', cost: 550, class: 'icon-cross4', emoji: '‚úü' },
            ],
            // „Ç¨„ÉÅ„É£ÈôêÂÆö„Ç¢„Ç§„Ç≥„É≥ (ÂÖ•Êâã‰∏çÂèØËÉΩ)
            exclusiveIcons: [
                // Ultra Rare „Ç¢„Ç§„Ç≥„É≥
                { id: 'icon-shield', name: 'Áõæ', class: 'icon-shield', emoji: 'üõ°Ô∏è', rarity: 'ultra-rare', type: 'icon' },
                { id: 'icon-dragon-face', name: '„Éâ„É©„Ç¥„É≥', class: 'icon-dragon-face', emoji: 'üê≤', rarity: 'ultra-rare', type: 'icon' },
                { id: 'icon-parrot', name: '„Ç™„Ç¶„É†', class: 'icon-parrot', emoji: 'ü¶ú', rarity: 'ultra-rare', type: 'icon' },
                { id: 'icon-detective', name: 'Êé¢ÂÅµ', class: 'icon-detective', emoji: 'üï¥Ô∏è', rarity: 'ultra-rare', type: 'icon' },
                { id: 'icon-lightning', name: 'Èõ∑', class: 'icon-lightning', emoji: '‚ö°', rarity: 'ultra-rare', type: 'icon' },
                { id: 'icon-ice-cube', name: 'Ê∞∑', class: 'icon-ice-cube', emoji: 'üßä', rarity: 'ultra-rare', type: 'icon' },
                { id: 'icon-ogre', name: 'È¨º', class: 'icon-ogre', emoji: 'üë∫', rarity: 'ultra-rare', type: 'icon' },
                { id: 'icon-ambulance', name: 'ÊïëÊÄ•Ëªä', class: 'icon-ambulance', emoji: 'üöë', rarity: 'ultra-rare', type: 'icon' },
                { id: 'icon-cherry-blossom', name: 'Ê°ú', class: 'icon-cherry-blossom', emoji: 'üå∏', rarity: 'ultra-rare', type: 'icon' },
                { id: 'icon-angel-face', name: 'Â§©‰Ωø', class: 'icon-angel-face', emoji: 'üòá', rarity: 'ultra-rare', type: 'icon' },
                { id: 'icon-rabbit', name: '„ÅÜ„Åï„Åé', class: 'icon-rabbit', emoji: 'üê∞', rarity: 'ultra-rare', type: 'icon' },
                { id: 'icon-fairy', name: 'Â¶ñÁ≤æ', class: 'icon-fairy', emoji: 'üßö', rarity: 'ultra-rare', type: 'icon' },
                { id: 'icon-blue-heart', name: 'Èùí„ÅÑ„Éè„Éº„Éà', class: 'icon-blue-heart', emoji: 'üíô', rarity: 'ultra-rare', type: 'icon' },
                { id: 'icon-princess', name: '„Éó„É™„É≥„Çª„Çπ', class: 'icon-princess', emoji: 'üë∏', rarity: 'ultra-rare', type: 'icon' },
                { id: 'icon-cat-face', name: '„Éç„Ç≥', class: 'icon-cat-face', emoji: 'üê±', rarity: 'ultra-rare', type: 'icon' },
                { id: 'icon-hibiscus', name: '„Éè„Ç§„Éì„Çπ„Ç´„Çπ', class: 'icon-hibiscus', emoji: 'üå∫', rarity: 'ultra-rare', type: 'icon' },

                // Legendary „Ç¢„Ç§„Ç≥„É≥
                { id: 'icon-cyclone', name: '„Çµ„Ç§„ÇØ„É≠„É≥', class: 'icon-cyclone', emoji: 'üåÄ', rarity: 'legendary', type: 'icon' },
                { id: 'icon-milky-way', name: 'Â§©„ÅÆÂ∑ù', class: 'icon-milky-way', emoji: 'üåå', rarity: 'legendary', type: 'icon' },
                { id: 'icon-flamingo', name: '„Éï„É©„Éü„É≥„Ç¥', class: 'icon-flamingo', emoji: 'ü¶©', rarity: 'legendary', type: 'icon' },
                { id: 'icon-crocodile', name: '„ÉØ„Éã', class: 'icon-crocodile', emoji: 'üêä', rarity: 'legendary', type: 'icon' },
                { id: 'icon-butterfly-ex', name: 'Ëù∂', class: 'icon-butterfly-ex', emoji: 'ü¶ã', rarity: 'legendary', type: 'icon' },
                { id: 'icon-sparkle-heart', name: '„Ç≠„É©„Ç≠„É©„Éè„Éº„Éà', class: 'icon-sparkle-heart', emoji: 'üíñ', rarity: 'legendary', type: 'icon' }
            ]
        };
        
        // „Ç¨„ÉÅ„É£„Ç∑„Çπ„ÉÜ„É†„ÅÆÂÆöÁæ©
        const GACHA_COST = 100; // „Ç¨„ÉÅ„É£1Âõû„ÅÆ„Ç≥„Çπ„Éà
        const GACHA_10X_COST = 1000; // 11ÈÄ£„Ç¨„ÉÅ„É£„ÅÆ„Ç≥„Çπ„ÉàÔºà1ÂõûÂàÜ„Åä„Åæ„ÅëÔºâ

        // „Ç¨„ÉÅ„É£„ÅÆÊéíÂá∫ÁéáË®≠ÂÆö
        const GACHA_RATES = {
            common: 60,      // 60% - ÂÆâ„ÅÑ„Ç¢„Ç§„ÉÜ„É† (50-200pt)
            uncommon: 25,    // 25% - ‰∏≠‰æ°Ê†º„Ç¢„Ç§„ÉÜ„É† (250-500pt)
            rare: 10,        // 10% - È´ò‰æ°Ê†º„Ç¢„Ç§„ÉÜ„É† (600-1000pt)
            ultraRare: 4,    // 4% - „Ç¶„É´„Éà„É©„É¨„Ç¢Ôºà„Ç¨„ÉÅ„É£ÈôêÂÆöÔºâ
            legendary: 1     // 1% - „É¨„Ç∏„Çß„É≥„ÉÄ„É™„ÉºÔºà„Ç¨„ÉÅ„É£ÈôêÂÆöÔºâ
        };

        // Initialize daily mission progress
        const initializeDailyMissions = () => {
            const today = new Date().toDateString();
            
            // Reset missions if it's a new day
            if (!gamificationData.dailyMissionProgress || gamificationData.dailyMissionProgress.date !== today) {
                gamificationData.dailyMissionProgress = {
                    date: today,
                    missions: {},
                    searchCount: 0,
                    addedCards: [],
                    addedRare: 0,
                    addedWithTag: 0
                };
                saveGamificationData();
            }
        };
        
        // Update time display
        const updateTimeDisplay = () => {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            const dateStr = now.toLocaleDateString('ja-JP', { month: 'long', day: 'numeric', weekday: 'long' });
            const timeEl = document.getElementById('current-time');
            if (timeEl) {
                timeEl.textContent = `${dateStr} ${timeStr}`;
            }
        };
        
        // Update daily missions display
        const updateDailyMissions = () => {
            const container = document.getElementById('daily-missions');
            if (!container) return;
            
            container.innerHTML = '';
            DAILY_MISSIONS.forEach(mission => {
                const completed = gamificationData.dailyMissionProgress.missions[mission.id] || false;
                let progress = 0;
                
                switch (mission.type) {
                    case 'add':
                        progress = gamificationData.dailyMissionProgress.addedCards.length;
                        break;
                    case 'rare':
                        progress = gamificationData.dailyMissionProgress.addedRare;
                        break;
                    case 'tag':
                        progress = gamificationData.dailyMissionProgress.addedWithTag;
                        break;
                    case 'search':
                        progress = gamificationData.dailyMissionProgress.searchCount;
                        break;
                    case 'unique':
                        progress = new Set(gamificationData.dailyMissionProgress.addedCards.map(c => c.name)).size;
                        break;
                }
                
                const missionEl = document.createElement('div');
                missionEl.className = `list-group-item d-flex align-items-center mission-item ${completed ? 'completed' : ''}`;
                missionEl.innerHTML = `
                    <input type="checkbox" class="mission-checkbox me-3" ${completed ? 'checked' : ''} disabled>
                    <div class="flex-grow-1">
                        <div>${mission.text}</div>
                        <small class="text-muted">ÈÄ≤Êçó: ${Math.min(progress, mission.target)}/${mission.target}</small>
                    </div>
                    ${completed ? '<span class="badge bg-success">ÂÆå‰∫Ü!</span>' : '<span class="badge bg-secondary">Êú™ÂÆå‰∫Ü</span>'}
                `;
                container.appendChild(missionEl);
                
                // Auto complete mission when target reached
                if (!completed && progress >= mission.target) {
                    gamificationData.dailyMissionProgress.missions[mission.id] = true;
                    saveGamificationData();
                    showMissionCompleteNotification(mission.text);
                    addPoints(POINT_REWARDS.completeMission, '„Éü„ÉÉ„Ç∑„Éß„É≥ÂÆå‰∫Ü');
                }
            });
        };
        
        // Show mission complete notification
        const showMissionCompleteNotification = (missionText) => {
            const notification = document.createElement('div');
            notification.className = 'position-fixed top-0 start-50 translate-middle-x mt-3';
            notification.style.zIndex = '9999';
            notification.innerHTML = `
                <div class="alert alert-success shadow-lg">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <strong>„Éü„ÉÉ„Ç∑„Éß„É≥ÈÅîÊàêÔºÅ</strong> ${missionText}
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        };
        
        // Update registration streak
        const updateRegistrationStreak = () => {
            const streakData = gamificationData.registrationStreak;
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            
            const streakEl = document.getElementById('streak-count');
            const progressEl = document.getElementById('streak-progress');
            const messageEl = document.getElementById('streak-message');
            const badgeEl = document.getElementById('streak-badge');
            
            if (!streakEl) return;
            
            // Update streak display
            streakEl.textContent = streakData.count;
            
            // Calculate progress to next milestone (every 7 days)
            const progressPercent = ((streakData.count % 7) / 7) * 100;
            if (progressEl) progressEl.style.width = `${progressPercent}%`;
            
            // Set streak badge
            if (badgeEl) {
                if (streakData.count >= 30) badgeEl.textContent = 'üî•';
                else if (streakData.count >= 14) badgeEl.textContent = '‚≠ê';
                else if (streakData.count >= 7) badgeEl.textContent = '‚ú®';
                else if (streakData.count >= 3) badgeEl.textContent = 'üëç';
                else badgeEl.textContent = '';
            }
            
            // Set message
            if (messageEl) {
                if (streakData.count === 0) {
                    messageEl.textContent = '‰ªäÊó•„Åã„ÇâÂßã„ÇÅ„Åæ„Åó„Çá„ÅÜÔºÅ';
                } else if (streakData.count % 7 === 0) {
                    messageEl.textContent = `${streakData.count / 7}ÈÄ±ÈñìÈÅîÊàêÔºÅÁ¥†Êô¥„Çâ„Åó„ÅÑÔºÅ`;
                } else {
                    const nextMilestone = Math.ceil(streakData.count / 7) * 7;
                    messageEl.textContent = `Ê¨°„ÅÆÁõÆÊ®ô„Åæ„Åß„ÅÇ„Å®${nextMilestone - streakData.count}Êó•`;
                }
            }
        };
        
        // Update today's stats
        const updateTodayStats = () => {
            const today = new Date().toDateString();
            
            // Load today's additions from gamificationData
            let todayAdditions = gamificationData.todayAdditions;
            
            // Reset if it's a new day
            if (todayAdditions.date !== today) {
                todayAdditions = {
                    date: today,
                    count: 0
                };
                gamificationData.todayAdditions = todayAdditions;
                saveGamificationData();
            }
            
            const todayAddedEl = document.getElementById('today-added');
            if (todayAddedEl) todayAddedEl.textContent = todayAdditions.count;
            
            // Load and update weekly goal
            let weeklyGoalData = gamificationData.weeklyGoalData;
            const weekStart = getWeekStart();
            
            // Reset if it's a new week
            if (weeklyGoalData.weekStart !== weekStart) {
                weeklyGoalData = {
                    weekStart: weekStart,
                    count: 0,
                    goal: 50
                };
                gamificationData.weeklyGoalData = weeklyGoalData;
                saveGamificationData();
            }
            
            const weekProgress = Math.min(100, Math.round((weeklyGoalData.count / weeklyGoalData.goal) * 100));
            const weekGoalEl = document.getElementById('week-goal-progress');
            if (weekGoalEl) weekGoalEl.textContent = `${weekProgress}%`;
            const weekGoalTargetEl = document.getElementById('week-goal-target');
            if (weekGoalTargetEl) weekGoalTargetEl.textContent = weeklyGoalData.goal;
            
        };
        
        // Get start of current week (Monday)
        const getWeekStart = () => {
            const date = new Date();
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            date.setDate(diff);
            return date.toDateString();
        };
        
        // Update points display
        const updatePointsDisplay = () => {
            const pointsEl = document.getElementById('user-points');
            const shopPointsEl = document.getElementById('shop-current-points');
            if (pointsEl) pointsEl.textContent = gamificationData.userPoints.toLocaleString();
            if (shopPointsEl) shopPointsEl.textContent = gamificationData.userPoints.toLocaleString();
        };
        
        // Add points with animation
        const addPoints = (amount, reason) => {
            gamificationData.userPoints += amount;
            
            // Track total points earned
            if (!gamificationData.profile) {
                gamificationData.profile = {
                    nickname: '',
                    icon: 'üë§',
                    firstUseDate: null,
                    lastUseDate: null,
                    usageDays: new Set(),
                    maxStreak: 0,
                    totalPointsEarned: 0
                };
            }
            gamificationData.profile.totalPointsEarned = (gamificationData.profile.totalPointsEarned || 0) + amount;
            
            saveGamificationData();
            updatePointsDisplay();
            
            // Show point animation
            const animation = document.createElement('div');
            animation.className = 'point-animation';
            animation.textContent = `+${amount} pt`;
            animation.style.left = '50%';
            animation.style.top = '50%';
            document.body.appendChild(animation);
            
            setTimeout(() => animation.remove(), 1000);
            
            // Show notification
            if (reason) {
                const notification = document.createElement('div');
                notification.className = 'position-fixed bottom-0 end-0 p-3';
                notification.style.zIndex = '9999';
                notification.innerHTML = `
                    <div class="toast show" role="alert">
                        <div class="toast-body">
                            <i class="bi bi-coin text-warning me-2"></i>
                            <strong>+${amount} pt</strong> ${reason}
                        </div>
                    </div>
                `;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
            }
        };
        
        // Initialize shop
        const initializeShop = () => {
            // Display exclusive icons in gacha info
            const exclusiveIconsDisplay = document.getElementById('exclusive-icons-display');
            if (exclusiveIconsDisplay) {
                let html = '<h6><span class="badge bg-warning">Ultra Rare (4%)</span></h6><div class="row g-2 mb-3">';

                SHOP_ITEMS.exclusiveIcons.filter(i => i.rarity === 'ultra-rare').forEach(icon => {
                    html += `
                        <div class="col-4 col-md-3 text-center">
                            <div class="card">
                                <div class="card-body p-2">
                                    <div style="font-size: 2rem;">${icon.emoji}</div>
                                    <small>${icon.name}</small>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div><h6><span class="badge bg-danger">Legendary (1%)</span></h6><div class="row g-2">';

                SHOP_ITEMS.exclusiveIcons.filter(i => i.rarity === 'legendary').forEach(icon => {
                    html += `
                        <div class="col-4 col-md-3 text-center">
                            <div class="card" style="background: linear-gradient(135deg, #ffd700, #ff6347);">
                                <div class="card-body p-2 text-white">
                                    <div style="font-size: 2rem;">${icon.emoji}</div>
                                    <small>${icon.name}</small>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                exclusiveIconsDisplay.innerHTML = html;
            }
            // Populate themes
            const themeContainer = document.getElementById('theme-shop-items');
            if (themeContainer) {
                themeContainer.innerHTML = '';
                SHOP_ITEMS.themes.forEach(theme => {
                    const isPurchased = gamificationData.purchasedItems[theme.id];
                    const isActive = gamificationData.activeTheme === theme.class;
                    
                    const itemEl = document.createElement('div');
                    itemEl.className = 'col-md-6';
                    itemEl.innerHTML = `
                        <div class="card shop-item ${isPurchased ? 'purchased' : ''} ${isActive ? 'active' : ''} ${!isPurchased && gamificationData.userPoints < theme.cost ? 'locked' : ''}">
                            <div class="card-body">
                                <div style="height: 60px; background: ${theme.preview}; border-radius: 5px; margin-bottom: 10px;"></div>
                                <h6>${theme.name}</h6>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-warning">${theme.cost} pt</span>
                                    ${isPurchased ? 
                                        (isActive ? 
                                            '<div class="btn-group btn-group-sm">' +
                                            '<button class="btn btn-primary" disabled>ÈÅ©Áî®‰∏≠</button>' +
                                            '<button class="btn btn-outline-secondary" onclick="applyTheme(\'default\')" title="Â§ñ„Åô"><i class="bi bi-x"></i></button>' +
                                            '</div>' : 
                                            `<button class="btn btn-sm btn-success" onclick="applyTheme('${theme.class}')">ÈÅ©Áî®</button>`) :
                                        `<button class="btn btn-sm btn-warning" onclick="purchaseItem('${theme.id}', ${theme.cost}, 'theme')">Ë≥ºÂÖ•</button>`
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                    themeContainer.appendChild(itemEl);
                });
            }
            
            // Populate frames
            const frameContainer = document.getElementById('frame-shop-items');
            if (frameContainer) {
                frameContainer.innerHTML = '';
                SHOP_ITEMS.frames.forEach(frame => {
                    const isPurchased = gamificationData.purchasedItems[frame.id];
                    const isActive = gamificationData.activeFrame === frame.class;
                    
                    const itemEl = document.createElement('div');
                    itemEl.className = 'col-md-6';
                    itemEl.innerHTML = `
                        <div class="card shop-item ${isPurchased ? 'purchased' : ''} ${isActive ? 'active' : ''} ${!isPurchased && gamificationData.userPoints < frame.cost ? 'locked' : ''}">
                            <div class="card-body">
                                <h6><i class="bi bi-border-all"></i> ${frame.name}</h6>
                                <p class="small text-muted">${frame.description}</p>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <span class="badge bg-warning">${frame.cost} pt</span>
                                    <div>
                                        ${!isPurchased && !isActive ? 
                                            `<button class="btn btn-sm btn-outline-info me-1" onclick="previewFrame('${frame.class}')" title="„Éó„É¨„Éì„É•„Éº">
                                                <i class="bi bi-eye"></i> Ë©¶„Åô
                                            </button>` : ''
                                        }
                                        ${isPurchased ? 
                                            (isActive ? 
                                                '<div class="btn-group btn-group-sm">' +
                                                '<button class="btn btn-primary" disabled>ÈÅ©Áî®‰∏≠</button>' +
                                                '<button class="btn btn-outline-secondary" onclick="applyFrame(\'\')" title="Â§ñ„Åô"><i class="bi bi-x"></i></button>' +
                                                '</div>' : 
                                                `<button class="btn btn-sm btn-success" onclick="applyFrame('${frame.class}')">ÈÅ©Áî®</button>`) :
                                            `<button class="btn btn-sm btn-warning" onclick="purchaseItem('${frame.id}', ${frame.cost}, 'frame')">Ë≥ºÂÖ•</button>`
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    frameContainer.appendChild(itemEl);
                });
            }
            
            // Populate backgrounds
            const bgContainer = document.getElementById('background-shop-items');
            if (bgContainer) {
                bgContainer.innerHTML = '';
                SHOP_ITEMS.backgrounds.forEach(bg => {
                    const isPurchased = gamificationData.purchasedItems[bg.id];
                    const isActive = gamificationData.activeBackground === bg.class;
                    
                    const itemEl = document.createElement('div');
                    itemEl.className = 'col-md-6';
                    itemEl.innerHTML = `
                        <div class="card shop-item ${isPurchased ? 'purchased' : ''} ${isActive ? 'active' : ''} ${!isPurchased && gamificationData.userPoints < bg.cost ? 'locked' : ''}">
                            <div class="card-body">
                                <h6><i class="bi bi-image"></i> ${bg.name}</h6>
                                <p class="small text-muted">${bg.description}</p>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <span class="badge bg-warning">${bg.cost} pt</span>
                                    <div>
                                        ${!isPurchased && !isActive ? 
                                            `<button class="btn btn-sm btn-outline-info me-1" onclick="previewBackground('${bg.class}')" title="„Éó„É¨„Éì„É•„Éº">
                                                <i class="bi bi-eye"></i> Ë©¶„Åô
                                            </button>` : ''
                                        }
                                        ${isPurchased ? 
                                            (isActive ? 
                                                '<div class="btn-group btn-group-sm">' +
                                                '<button class="btn btn-primary" disabled>ÈÅ©Áî®‰∏≠</button>' +
                                                '<button class="btn btn-outline-secondary" onclick="applyBackground(\'\')" title="Â§ñ„Åô"><i class="bi bi-x"></i></button>' +
                                                '</div>' : 
                                                `<button class="btn btn-sm btn-success" onclick="applyBackground('${bg.class}')">ÈÅ©Áî®</button>`) :
                                            `<button class="btn btn-sm btn-warning" onclick="purchaseItem('${bg.id}', ${bg.cost}, 'background')">Ë≥ºÂÖ•</button>`
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    bgContainer.appendChild(itemEl);
                });
            }
            
            // Populate icons
            const iconContainer = document.getElementById('icon-shop-items');
            if (iconContainer) {
                iconContainer.innerHTML = '';
                SHOP_ITEMS.icons.forEach(icon => {
                    const isPurchased = gamificationData.purchasedItems[icon.id];
                    
                    const itemEl = document.createElement('div');
                    itemEl.className = 'col-md-6';
                    itemEl.innerHTML = `
                        <div class="card shop-item ${isPurchased ? 'purchased' : ''} ${!isPurchased && gamificationData.userPoints < icon.cost ? 'locked' : ''}">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="fs-2 me-2">${icon.emoji}</span>
                                    <h6 class="mb-0">${icon.name}</h6>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-warning">${icon.cost} pt</span>
                                    ${isPurchased ? 
                                        '<span class="badge bg-success">Ë≥ºÂÖ•Ê∏à„Åø</span>' :
                                        `<button class="btn btn-sm btn-warning" onclick="purchaseItem('${icon.id}', ${icon.cost}, 'icon')">Ë≥ºÂÖ•</button>`
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                    iconContainer.appendChild(itemEl);
                });
            }
            
        };
        
        // Purchase item
        // Toggle daily challenges visibility
        // Show weekly goal setting dialog
        window.showWeeklyGoalSetting = () => {
            const currentGoal = gamificationData.weeklyGoalData.goal || 50;
            const newGoal = prompt(`ÈÄ±ÈñìÁõÆÊ®ô„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ (ÁèæÂú®: ${currentGoal}Êûö)\n\n‰ΩïÊûö„ÅÆ„Ç´„Éº„Éâ„ÇíÈÄ±„Å´ËøΩÂä†„Åó„Åü„ÅÑ„Åß„Åô„ÅãÔºü`, currentGoal);

            if (newGoal !== null) {
                const goalNumber = parseInt(newGoal, 10);
                if (!isNaN(goalNumber) && goalNumber > 0 && goalNumber <= 1000) {
                    gamificationData.weeklyGoalData.goal = goalNumber;
                    saveGamificationData();
                    updateTodayStats();
                    alert(`ÈÄ±ÈñìÁõÆÊ®ô„Çí${goalNumber}Êûö„Å´Ë®≠ÂÆö„Åó„Åæ„Åó„ÅüÔºÅ`);
                } else {
                    alert('ÊúâÂäπ„Å™Êï∞ÂÄ§„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà1„Äú1000Ôºâ');
                }
            }
        };

        window.toggleDailyChallenges = () => {
            const body = document.getElementById('daily-challenges-body');
            const icon = document.getElementById('daily-challenges-toggle-icon');
            const isHidden = body.style.display === 'none';
            
            if (isHidden) {
                body.style.display = '';
                icon.className = 'bi bi-eye-slash';
                localStorage.setItem('hideDailyChallenges', 'false');
            } else {
                body.style.display = 'none';
                icon.className = 'bi bi-eye';
                localStorage.setItem('hideDailyChallenges', 'true');
            }
        };
        
        // Undo recent card addition
        window.undoRecentAddition = async (name, setCode, rarity, quantity, listType, timestamp) => {
            if (!confirm(`„Äå${name}„Äç„ÅÆËøΩÂä†„ÇíÂèñ„ÇäÊ∂à„Åó„Åæ„Åô„ÅãÔºü\n\nÊ≥®ÊÑè: „Åì„ÅÆÊìç‰Ωú„Å´„Çà„Çä„ÄÅË©≤ÂΩì„Åô„Çã„Ç´„Éº„Éâ„Åå„É™„Çπ„Éà„Åã„ÇâÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ`)) {
                return;
            }

            showLoading(true);
            try {
                const collection = listType === 'wishlist' ? wishlistCollection : cardCollection;
                const collRef = getCollectionRef(listType);

                // Find the matching card(s) to remove
                let removedCount = 0;
                const cardsToRemove = [];

                // Find cards that match the criteria
                for (const card of collection) {
                    if (card.data['ÂêçÂâç'] === name &&
                        (!setCode || card.data['ÂûãÁï™'] === setCode) &&
                        (!rarity || card.data['„É¨„Ç¢„É™„ÉÜ„Ç£'] === rarity)) {

                        const cardQuantity = parseInt(card.data['ÊûöÊï∞']) || 0;

                        if (cardQuantity > quantity) {
                            // Reduce quantity
                            card.data['ÊûöÊï∞'] = cardQuantity - quantity;

                            if (collRef) {
                                await updateDoc(doc(collRef, card.id), { 'ÊûöÊï∞': card.data['ÊûöÊï∞'] });
                            }
                            removedCount = quantity;
                            break;
                        } else if (cardQuantity === quantity) {
                            // Remove the card entirely
                            cardsToRemove.push(card);
                            removedCount = quantity;
                            break;
                        } else {
                            // Card has less quantity than we're trying to remove
                            cardsToRemove.push(card);
                            removedCount += cardQuantity;
                            quantity -= cardQuantity;

                            if (removedCount >= quantity) {
                                break;
                            }
                        }
                    }
                }

                // Remove cards that need to be deleted
                for (const card of cardsToRemove) {
                    if (collRef) {
                        await deleteDoc(doc(collRef, card.id));
                    }

                    // Remove from local collection
                    const index = collection.indexOf(card);
                    if (index > -1) {
                        collection.splice(index, 1);
                    }
                }

                // Update recent history in localStorage
                let recentHistory = [];
                const recentCardsHistory = localStorage.getItem('recentCardsHistory');
                if (recentCardsHistory) {
                    try {
                        recentHistory = JSON.parse(recentCardsHistory);
                        // Remove the item from history
                        recentHistory = recentHistory.filter(item =>
                            !(item.timestamp === timestamp &&
                              item.name === name &&
                              item.listType === listType));
                        localStorage.setItem('recentCardsHistory', JSON.stringify(recentHistory));
                    } catch(e) {
                        console.error('Error updating recent history:', e);
                    }
                }

                // Save to localStorage if local user
                if (!currentUser || currentUser.uid === 'local_user') {
                    if (listType === 'wishlist') {
                        localStorage.setItem('wishlistCollection', JSON.stringify(wishlistCollection.map(c => c.data)));
                    } else {
                        localStorage.setItem('cardCollection', JSON.stringify(cardCollection.map(c => c.data)));
                    }
                }

                // Refresh the display
                updateTotalCounts();
                applySearchAndFilter();

                // Refresh analysis modal if it's open
                const analysisModal = bootstrap.Modal.getInstance(document.getElementById('analysis-modal'));
                if (analysisModal && analysisModal._isShown) {
                    updateAnalysisData();
                }

                showLoading(false);
                alert(`„Äå${name}„Äç„ÅÆËøΩÂä†„ÇíÂèñ„ÇäÊ∂à„Åó„Åæ„Åó„ÅüÔºà${removedCount}ÊûöÂâäÈô§Ôºâ`);

            } catch (error) {
                showLoading(false);
                console.error('Error undoing addition:', error);
                alert('Âèñ„ÇäÊ∂à„Åó‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        };

        window.purchaseItem = (itemId, cost, type) => {
            if (gamificationData.userPoints < cost) {
                alert('„Éù„Ç§„É≥„Éà„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºÅ');
                return;
            }
            
            if (confirm(`${cost}pt„Çí‰Ωø„Å£„Å¶Ë≥ºÂÖ•„Åó„Åæ„Åô„ÅãÔºü`)) {
                gamificationData.userPoints -= cost;
                
                if (type === 'theme' || type === 'frame' || type === 'background' || type === 'icon' || type === 'effect') {
                    gamificationData.purchasedItems[itemId] = true;
                    saveGamificationData();
                    
                    // Apply effect immediately if it's an effect
                    if (type === 'effect') {
                        document.body.classList.add(itemId);
                    }
                }
                
                updatePointsDisplay();
                initializeShop();
                alert('Ë≥ºÂÖ•„Åó„Åæ„Åó„ÅüÔºÅ');
            }
        };

        // „É°„Éº„É´Á¢∫Ë™ç„É°„Éº„É´„ÇíÂÜçÈÄÅ‰ø°
        window.resendVerificationEmail = async () => {
            if (currentUser && !currentUser.emailVerified) {
                try {
                    await sendEmailVerification(currentUser);
                    alert('Á¢∫Ë™ç„É°„Éº„É´„ÇíÂÜçÈÄÅ‰ø°„Åó„Åæ„Åó„ÅüÔºÅ\n\n„ÄêÁ¢∫Ë™ç‰∫ãÈ†Ö„Äë\n‚úÖ Âèó‰ø°„Éú„ÉÉ„ÇØ„Çπ„ÇíÁ¢∫Ë™ç\n‚úÖ Ëø∑ÊÉë„É°„Éº„É´„Éï„Ç©„É´„ÉÄ„ÇíÁ¢∫Ë™ç\n‚úÖ „Éó„É≠„É¢„Éº„Ç∑„Éß„É≥/„ÇΩ„Éº„Ç∑„É£„É´„Éï„Ç©„É´„ÉÄ„ÇÇÁ¢∫Ë™ç\n\nÈÄÅ‰ø°ÂÖÉ: noreply@ygoh-9bcf6.firebaseapp.com\n\n‚Äª„É™„É≥„ÇØ„ÅÆÊúâÂäπÊúüÈôê„ÅØ1ÊôÇÈñì„Åß„Åô');
                } catch (error) {
                    if (error.code === 'auth/too-many-requests') {
                        alert('ÈÄÅ‰ø°ÂõûÊï∞„ÅÆ‰∏äÈôê„Å´ÈÅî„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    } else {
                        alert('„É°„Éº„É´ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                    }
                }
            }
        };

        // „Ç¨„ÉÅ„É£„Ç∑„Çπ„ÉÜ„É†„ÅÆÂÆüË£Ö
        window.drawGacha = async (count) => {
            const cost = count === 1 ? GACHA_COST : GACHA_10X_COST;

            if (gamificationData.userPoints < cost) {
                alert('„Éù„Ç§„É≥„Éà„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºÅ');
                return;
            }

            if (!confirm(`${cost}pt„Çí‰Ωø„Å£„Å¶${count}Âõû„Ç¨„ÉÅ„É£„ÇíÂºï„Åç„Åæ„Åô„ÅãÔºü`)) {
                return;
            }

            // „Éù„Ç§„É≥„Éà„ÇíÊ∏õ„Çâ„Åô
            gamificationData.userPoints -= cost;
            saveGamificationData();
            updatePointsDisplay();

            // „Ç¨„ÉÅ„É£ÁµêÊûú„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
            const gachaResultModal = new bootstrap.Modal(document.getElementById('gacha-result-modal'));
            gachaResultModal.show();

            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíË°®Á§∫
            const animationEl = document.getElementById('gacha-animation');
            const resultsEl = document.getElementById('gacha-results');
            const closeBtn = document.getElementById('gacha-close-btn');

            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíË°®Á§∫Áä∂ÊÖã„Å´„É™„Çª„ÉÉ„Éà
            animationEl.style.display = 'block';
            animationEl.innerHTML = '<div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status"></div><h3 class="mt-3">„Ç¨„ÉÅ„É£„ÇíÂõû„Åó„Å¶„ÅÑ„Åæ„Åô...</h3>';
            resultsEl.style.display = 'none';
            closeBtn.style.display = 'none';

            // „Ç¨„ÉÅ„É£„ÇíÂºï„Åè
            const results = [];
            for (let i = 0; i < count; i++) {
                results.push(performGachaDraw());
            }

            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Âæå„Å´ÁµêÊûú„ÇíË°®Á§∫
            setTimeout(() => {
                animationEl.style.display = 'none';
                resultsEl.style.display = 'block';
                closeBtn.style.display = 'inline-block';

                let resultsHTML = '<h3>„Ç¨„ÉÅ„É£ÁµêÊûú</h3><div class="row g-2">';
                let hasNewItem = false;
                let duplicatePoints = 0;

                // ÈáçË§á„Ç¢„Ç§„ÉÜ„É†„ÅÆ„Éù„Ç§„É≥„ÉàÂ§âÊèõÁéá
                const duplicateConversion = {
                    'common': 10,
                    'uncommon': 15,
                    'rare': 20,
                    'ultra-rare': 0,  // Ultra Rare„ÅØÈáçË§á„Åó„Å¶„ÇÇ„Éù„Ç§„É≥„ÉàÂ§âÊèõ„Å™„ÅóÔºà„Åù„ÅÆ„Åæ„ÅæÁç≤ÂæóÔºâ
                    'legendary': 0     // Legendary„ÇÇÈáçË§á„Åó„Å¶„ÇÇ„Éù„Ç§„É≥„ÉàÂ§âÊèõ„Å™„ÅóÔºà„Åù„ÅÆ„Åæ„ÅæÁç≤ÂæóÔºâ
                };

                results.forEach(result => {
                    const isNew = !gamificationData.purchasedItems[result.id];
                    let convertedToPoints = false;
                    let pointsAwarded = 0;

                    if (isNew) {
                        hasNewItem = true;
                        gamificationData.purchasedItems[result.id] = true;
                    } else if (duplicateConversion[result.rarity] > 0) {
                        // ÈÄöÂ∏∏„É¨„Ç¢„É™„ÉÜ„Ç£„ÅÆÈáçË§á„Ç¢„Ç§„ÉÜ„É†„ÅØ„Éù„Ç§„É≥„Éà„Å´Â§âÊèõ
                        convertedToPoints = true;
                        pointsAwarded = duplicateConversion[result.rarity];
                        duplicatePoints += pointsAwarded;
                    }

                    const rarityBadge = getRarityBadge(result.rarity);

                    // „Ç¢„Ç§„ÉÜ„É†„Çø„Ç§„Éó„Å´Âøú„Åò„ÅüÁµµÊñáÂ≠ó„ÇíË®≠ÂÆö
                    let displayEmoji = result.emoji;
                    if (!displayEmoji) {
                        switch(result.type) {
                            case 'theme':
                                displayEmoji = 'üé®'; // „Éë„É¨„ÉÉ„Éà
                                break;
                            case 'frame':
                                displayEmoji = 'üñºÔ∏è'; // „Éï„É¨„Éº„É†
                                break;
                            case 'background':
                                displayEmoji = 'üåÑ'; // ËÉåÊôØ
                                break;
                            case 'icon':
                                displayEmoji = 'üéÜ'; // „Ç¢„Ç§„Ç≥„É≥„ÅÆ„Éá„Éï„Ç©„É´„Éà
                                break;
                            default:
                                displayEmoji = 'üéÜ';
                        }
                    }

                    // ÁâπÊÆä„É¨„Ç¢„É™„ÉÜ„Ç£„ÅÆÂ†¥Âêà„ÅÆ„ÉÜ„Ç≠„Çπ„ÉàËâ≤
                    const textColorClass = (result.rarity === 'legendary' || result.rarity === 'ultra-rare') ? 'text-white' : '';

                    // „Ç¢„Ç§„ÉÜ„É†„Çø„Ç§„Éó„ÅÆË°®Á§∫Âêç„ÇíÂèñÂæó
                    const getItemTypeLabel = (type) => {
                        switch(type) {
                            case 'theme': return '„ÉÜ„Éº„Éû';
                            case 'frame': return '„Éï„É¨„Éº„É†';
                            case 'background': return 'ËÉåÊôØ';
                            case 'icon': return '„Ç¢„Ç§„Ç≥„É≥';
                            default: return '„Ç¢„Ç§„ÉÜ„É†';
                        }
                    };

                    resultsHTML += `
                        <div class="col-6 col-md-4">
                            <div class="card ${isNew ? 'border-warning' : convertedToPoints ? 'border-info' : ''}" style="${result.rarity === 'legendary' ? 'background: linear-gradient(135deg, #ffd700, #ff6347);' : result.rarity === 'ultra-rare' ? 'background: linear-gradient(135deg, #f093fb, #f5576c);' : ''}">
                                <div class="card-body text-center p-2 ${textColorClass}">
                                    ${isNew ? '<span class="badge bg-warning position-absolute top-0 start-0">NEW!</span>' :
                                      convertedToPoints ? `<span class="badge bg-info position-absolute top-0 start-0">+${pointsAwarded}pt</span>` : ''}
                                    <div style="font-size: 2rem;">${displayEmoji}</div>
                                    <small class="d-block">${result.name}</small>
                                    <small class="d-block text-muted" style="opacity: 0.8;">${getItemTypeLabel(result.type)}</small>
                                    ${rarityBadge}
                                    ${convertedToPoints ? '<small class="d-block mt-1" style="opacity: 0.8;">ÈáçË§á‚Üí„Éù„Ç§„É≥„ÉàÂ§âÊèõ</small>' : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });

                resultsHTML += '</div>';

                if (hasNewItem) {
                    resultsHTML += '<div class="alert alert-success mt-3"><i class="bi bi-check-circle"></i> Êñ∞„Åó„ÅÑ„Ç¢„Ç§„ÉÜ„É†„ÇíÁç≤Âæó„Åó„Åæ„Åó„ÅüÔºÅ</div>';
                }

                if (duplicatePoints > 0) {
                    // ÈáçË§á„Éù„Ç§„É≥„Éà„ÇíËøΩÂä†
                    gamificationData.userPoints += duplicatePoints;
                    resultsHTML += `<div class="alert alert-info mt-3"><i class="bi bi-coin"></i> ÈáçË§á„Ç¢„Ç§„ÉÜ„É†„Åå <strong>${duplicatePoints}pt</strong> „Å´Â§âÊèõ„Åï„Çå„Åæ„Åó„ÅüÔºÅ</div>`;
                }

                // „Éá„Éº„Çø„Çí‰øùÂ≠ò
                saveGamificationData();
                updatePointsDisplay();

                resultsEl.innerHTML = resultsHTML;
            }, 2000);
        };

        // „Ç¨„ÉÅ„É£„ÇíÂÆüË°å
        const performGachaDraw = () => {
            const random = Math.random() * 100;
            let accumulated = 0;
            let rarity = 'common';

            // „É¨„Ç¢„É™„ÉÜ„Ç£„ÇíÊ±∫ÂÆö
            if (random < GACHA_RATES.legendary) {
                rarity = 'legendary';
            } else if (random < GACHA_RATES.legendary + GACHA_RATES.ultraRare) {
                rarity = 'ultra-rare';
            } else if (random < GACHA_RATES.legendary + GACHA_RATES.ultraRare + GACHA_RATES.rare) {
                rarity = 'rare';
            } else if (random < GACHA_RATES.legendary + GACHA_RATES.ultraRare + GACHA_RATES.rare + GACHA_RATES.uncommon) {
                rarity = 'uncommon';
            } else {
                rarity = 'common';
            }

            // „É¨„Ç¢„É™„ÉÜ„Ç£„Å´Âü∫„Å•„ÅÑ„Å¶„Ç¢„Ç§„ÉÜ„É†„ÇíÈÅ∏Êäû
            let item;
            if (rarity === 'legendary' || rarity === 'ultra-rare') {
                // „Ç¨„ÉÅ„É£ÈôêÂÆö„Ç¢„Ç§„Ç≥„É≥„Åã„ÇâÈÅ∏Êäû
                const exclusiveItems = SHOP_ITEMS.exclusiveIcons.filter(i => i.rarity === rarity);
                item = exclusiveItems[Math.floor(Math.random() * exclusiveItems.length)];
            } else {
                // ÈÄöÂ∏∏„Ç¢„Ç§„ÉÜ„É†„Åã„ÇâÈÅ∏Êäû
                const allItems = [];

                // „Ç≥„Çπ„Éà„Å´Âü∫„Å•„ÅÑ„Å¶„Ç¢„Ç§„ÉÜ„É†„Çí„Éï„Ç£„É´„Çø
                const costRange = {
                    common: [50, 200],
                    uncommon: [250, 500],
                    rare: [600, 1500]
                };

                const range = costRange[rarity];

                // ÂÖ®„Ç´„ÉÜ„Ç¥„É™„Åã„Çâ„Ç¢„Ç§„ÉÜ„É†„ÇíÂèéÈõÜ
                SHOP_ITEMS.themes.forEach(t => {
                    if (t.cost >= range[0] && t.cost <= range[1]) {
                        allItems.push({...t, type: 'theme', rarity});
                    }
                });
                SHOP_ITEMS.frames.forEach(f => {
                    if (f.cost >= range[0] && f.cost <= range[1]) {
                        allItems.push({...f, type: 'frame', rarity});
                    }
                });
                SHOP_ITEMS.backgrounds.forEach(b => {
                    if (b.cost >= range[0] && b.cost <= range[1]) {
                        allItems.push({...b, type: 'background', rarity});
                    }
                });
                SHOP_ITEMS.icons.forEach(i => {
                    if (i.cost >= range[0] && i.cost <= range[1]) {
                        allItems.push({...i, type: 'icon', rarity});
                    }
                });

                item = allItems[Math.floor(Math.random() * allItems.length)];
            }

            return item;
        };

        // „É¨„Ç¢„É™„ÉÜ„Ç£„Éê„ÉÉ„Ç∏„ÇíÂèñÂæó
        const getRarityBadge = (rarity) => {
            switch(rarity) {
                case 'legendary':
                    return '<span class="badge bg-danger">„É¨„Ç∏„Çß„É≥„ÉÄ„É™„Éº</span>';
                case 'ultra-rare':
                    return '<span class="badge bg-warning">„Ç¶„É´„Éà„É©„É¨„Ç¢</span>';
                case 'rare':
                    return '<span class="badge bg-success">„É¨„Ç¢</span>';
                case 'uncommon':
                    return '<span class="badge bg-primary">„Ç¢„É≥„Ç≥„É¢„É≥</span>';
                default:
                    return '<span class="badge bg-secondary">„Ç≥„É¢„É≥</span>';
            }
        };

        // „Ç¨„ÉÅ„É£ÁµêÊûú„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        window.closeGachaResult = () => {
            const modal = bootstrap.Modal.getInstance(document.getElementById('gacha-result-modal'));
            if (modal) {
                modal.hide();
            }
            initializeShop();
        };

        // Apply theme
        window.applyTheme = (themeClass) => {
            // Remove all theme classes
            const allThemeClasses = SHOP_ITEMS.themes.map(t => t.class);
            document.body.classList.remove(...allThemeClasses);
            
            if (themeClass !== 'default') {
                document.body.classList.add(themeClass);
            }
            
            gamificationData.activeTheme = themeClass;
            saveGamificationData();
            initializeShop();
        };
        
        // Apply frame
        window.applyFrame = (frameClass) => {
            // Remove all frame classes
            const allFrameClasses = SHOP_ITEMS.frames.map(f => f.class);
            document.body.classList.remove(...allFrameClasses);
            
            if (frameClass && frameClass !== 'none') {
                document.body.classList.add(frameClass);
            }
            
            gamificationData.activeFrame = frameClass;
            saveGamificationData();
            initializeShop();
        };
        
        // Apply background
        window.applyBackground = (bgClass) => {
            // Remove all background classes
            const allBgClasses = SHOP_ITEMS.backgrounds.map(b => b.class);
            document.body.classList.remove(...allBgClasses);
            
            if (bgClass && bgClass !== 'none') {
                document.body.classList.add(bgClass);
            }
            
            gamificationData.activeBackground = bgClass;
            saveGamificationData();
            initializeShop();
        };
        
        // Apply icon
        window.applyIcon = (iconClass) => {
            // Remove all icon classes
            const allIconClasses = SHOP_ITEMS.icons.map(i => i.class);
            document.body.classList.remove(...allIconClasses);
            
            if (iconClass && iconClass !== 'none') {
                document.body.classList.add(iconClass);
            }
            
            gamificationData.activeIcon = iconClass;
            saveGamificationData();
            initializeShop();
        };
        
        // Apply effect (effects are permanent once purchased)
        window.applyEffect = (effectId) => {
            if (gamificationData.purchasedItems[effectId]) {
                document.body.classList.add(effectId);
            }
        };
        
        // Show notification function
        const showNotification = (message, type = 'info') => {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} position-fixed top-0 start-50 translate-middle-x mt-3`;
            notification.style.zIndex = '9999';
            notification.style.minWidth = '300px';
            notification.textContent = message;
            
            // Add to body
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        };
        
        // Preview frame (temporary application)
        window.previewFrame = (frameClass) => {
            // First store the current frame
            const currentFrame = gamificationData.activeFrame;
            
            // Apply the preview frame
            const allFrameClasses = SHOP_ITEMS.frames.map(f => f.class);
            document.body.classList.remove(...allFrameClasses);
            
            if (frameClass && frameClass !== 'none') {
                document.body.classList.add(frameClass);
            }
            
            // Show a notification
            showNotification('„Éó„É¨„Éì„É•„Éº‰∏≠... 5ÁßíÂæå„Å´ÂÖÉ„Å´Êàª„Çä„Åæ„Åô', 'info');
            
            // Revert after 5 seconds
            setTimeout(() => {
                document.body.classList.remove(...allFrameClasses);
                if (currentFrame && currentFrame !== 'none') {
                    document.body.classList.add(currentFrame);
                }
                showNotification('„Éó„É¨„Éì„É•„ÉºÁµÇ‰∫Ü', 'secondary');
            }, 5000);
        };
        
        // Preview background (temporary application)
        window.previewBackground = (bgClass) => {
            // First store the current background
            const currentBg = gamificationData.activeBackground;
            
            // Apply the preview background
            const allBgClasses = SHOP_ITEMS.backgrounds.map(b => b.class);
            document.body.classList.remove(...allBgClasses);
            
            if (bgClass && bgClass !== 'none') {
                document.body.classList.add(bgClass);
            }
            
            // Show a notification
            showNotification('„Éó„É¨„Éì„É•„Éº‰∏≠... 5ÁßíÂæå„Å´ÂÖÉ„Å´Êàª„Çä„Åæ„Åô', 'info');
            
            // Revert after 5 seconds
            setTimeout(() => {
                document.body.classList.remove(...allBgClasses);
                if (currentBg && currentBg !== 'none') {
                    document.body.classList.add(currentBg);
                }
                showNotification('„Éó„É¨„Éì„É•„ÉºÁµÇ‰∫Ü', 'secondary');
            }, 5000);
        };
        
        // Initialize fun dashboard
        const initializeFunDashboard = () => {
            updateTimeDisplay();
            updateDailyMissions();
            updateRegistrationStreak();
            updateTodayStats();
            updatePointsDisplay();
            
            // Update time every minute
            setInterval(updateTimeDisplay, 60000);
        };
        
        // Track when card is added
        const trackCardAddition = (cardData, hasTag, isRare) => {
            const today = new Date().toDateString();
            const cardCount = cardData.ÊûöÊï∞ || 1;
            
            // Update daily mission progress
            gamificationData.dailyMissionProgress.addedCards.push({ name: cardData.ÂêçÂâç, time: Date.now() });
            if (hasTag) gamificationData.dailyMissionProgress.addedWithTag++;
            if (isRare) gamificationData.dailyMissionProgress.addedRare++;
            
            saveGamificationData();
            
            // Update today's additions
            if (gamificationData.todayAdditions.date !== today) {
                gamificationData.todayAdditions = { date: today, count: 0 };
            }
            gamificationData.todayAdditions.count += cardCount;
            
            // Update weekly goal
            const weekStart = getWeekStart();
            if (gamificationData.weeklyGoalData.weekStart !== weekStart) {
                gamificationData.weeklyGoalData = { weekStart: weekStart, count: 0, goal: 50 };
            }
            gamificationData.weeklyGoalData.count += cardCount;
            
            // Update registration streak
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            
            if (gamificationData.registrationStreak.lastDate === today) {
                // Already added today, no change
            } else if (gamificationData.registrationStreak.lastDate === yesterday) {
                // Continue streak
                gamificationData.registrationStreak.count++;
                gamificationData.registrationStreak.lastDate = today;
            } else {
                // Start new streak
                gamificationData.registrationStreak.count = 1;
                gamificationData.registrationStreak.lastDate = today;
            }
            
            saveGamificationData();
            
            // Update displays
            updateDailyMissions();
            updateRegistrationStreak();
            updateTodayStats();
        };
        
        // Track search action
        const trackSearchAction = () => {
            gamificationData.dailyMissionProgress.searchCount++;
            saveGamificationData();
            updateDailyMissions();
        };
        
        // Reset first login bonus (for testing or special cases)
        window.resetFirstLoginBonus = async () => {
            gamificationData.hasReceivedFirstLoginBonus = false;
            await saveGamificationData();
            console.log('ÂàùÂõû„É≠„Ç∞„Ç§„É≥„Éú„Éº„Éä„Çπ„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü„ÄÇÊ¨°Âõû„É≠„Ç∞„Ç§„É≥ÊôÇ„Å´ÂÜçÂ∫¶Âèó„ÅëÂèñ„Çå„Åæ„Åô„ÄÇ');
        };
        
        // Check and grant first login bonus
        const checkFirstLoginBonus = (user) => {
            // Check if user has already received the bonus (using Firebase data)
            if (!gamificationData.hasReceivedFirstLoginBonus) {
                // First time login - grant 50 points
                addPoints(50, 'ÂàùÂõû„É≠„Ç∞„Ç§„É≥„Éú„Éº„Éä„ÇπÔºÅ');
                
                // Mark as received in Firebase
                gamificationData.hasReceivedFirstLoginBonus = true;
                saveGamificationData();
                
                // Check if user already has cards and grant retroactive points
                setTimeout(() => {
                    let totalCards = 0;
                    cardCollection.forEach(card => {
                        totalCards += card.data.ÊûöÊï∞ || 0;
                    });
                    
                    if (totalCards > 0) {
                        const retroactivePoints = totalCards * 5;
                        addPoints(retroactivePoints, `Êó¢Â≠ò„Ç´„Éº„Éâ ${totalCards}ÊûöÂàÜ„ÅÆ„Éù„Ç§„É≥„Éà`);
                        
                        // Show special notification
                        const notification = document.createElement('div');
                        notification.className = 'position-fixed top-50 start-50 translate-middle';
                        notification.style.zIndex = '10000';
                        notification.innerHTML = `
                            <div class="card shadow-lg border-warning" style="min-width: 300px;">
                                <div class="card-body text-center">
                                    <h5 class="card-title text-warning">
                                        <i class="bi bi-gift-fill"></i> ÁâπÂà•„Éú„Éº„Éä„ÇπÔºÅ
                                    </h5>
                                    <p class="card-text">
                                        ÂàùÂõû„É≠„Ç∞„Ç§„É≥„Éú„Éº„Éä„Çπ: 50pt<br>
                                        Êó¢Â≠ò„Ç´„Éº„Éâ„Éú„Éº„Éä„Çπ: ${retroactivePoints}pt<br>
                                        <strong>ÂêàË®à: ${50 + retroactivePoints}pt Áç≤ÂæóÔºÅ</strong>
                                    </p>
                                    <button class="btn btn-warning" onclick="this.closest('.position-fixed').remove()">
                                        „ÅÇ„Çä„Åå„Å®„ÅÜÔºÅ
                                    </button>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(notification);
                    } else {
                        // Show welcome notification for new users
                        const notification = document.createElement('div');
                        notification.className = 'position-fixed top-50 start-50 translate-middle';
                        notification.style.zIndex = '10000';
                        notification.innerHTML = `
                            <div class="card shadow-lg border-success" style="min-width: 300px;">
                                <div class="card-body text-center">
                                    <h5 class="card-title text-success">
                                        <i class="bi bi-star-fill"></i> „Çà„ÅÜ„Åì„ÅùÔºÅ
                                    </h5>
                                    <p class="card-text">
                                        ÂàùÂõû„É≠„Ç∞„Ç§„É≥„Éú„Éº„Éä„Çπ„Å®„Åó„Å¶<br>
                                        <strong>50„Éù„Ç§„É≥„Éà</strong>„Çí„Éó„É¨„Çº„É≥„ÉàÔºÅ
                                    </p>
                                    <button class="btn btn-success" onclick="this.closest('.position-fixed').remove()">
                                        Âßã„ÇÅ„ÇãÔºÅ
                                    </button>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(notification);
                    }
                }, 1000); // Wait for cards to load
            }
        };
        
        const updateCollectionStats = () => {
            // Check if stats should be hidden
            const hideStats = localStorage.getItem('hideStats') === 'true';
            const statsDiv = document.getElementById('stats-dashboard');
            if (hideStats) {
                statsDiv.style.display = 'none';
                return;
            } else {
                statsDiv.style.display = 'block';
            }
            
            const totalCards = cardCollection.reduce((sum, card) => sum + (card.data['ÊûöÊï∞'] || 0), 0);
            const uniqueCards = cardCollection.length;
            
            // Set first collection date if not set
            if (totalCards > 0 && !gamificationData.firstCollectionDate) {
                gamificationData.firstCollectionDate = new Date().toISOString();
                saveGamificationData();
            }
            
            // Calculate collection days
            const collectionDays = gamificationData.firstCollectionDate ? 
                Math.floor((new Date() - new Date(gamificationData.firstCollectionDate)) / (1000 * 60 * 60 * 24)) + 1 : 0;
            
            // Calculate cards added this week
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            let recentCards = 0;
            
            Object.entries(gamificationData.cardAdditionDates).forEach(([cardId, dateAdded]) => {
                if (new Date(dateAdded) >= oneWeekAgo) {
                    const card = cardCollection.find(c => c.id === cardId);
                    if (card) {
                        recentCards += card.data['ÊûöÊï∞'] || 0;
                    }
                }
            });
            
            // Build rarity distribution
            let rarityDistribution = {};
            
            cardCollection.forEach(card => {
                const rarity = card.data['„É¨„Ç¢„É™„ÉÜ„Ç£'] || 'N';
                const quantity = card.data['ÊûöÊï∞'] || 0;
                
                if (!rarityDistribution[rarity]) {
                    rarityDistribution[rarity] = 0;
                }
                rarityDistribution[rarity] += quantity;
            });
            
            // Update display
            document.getElementById('total-cards').textContent = totalCards.toLocaleString();
            document.getElementById('unique-cards').textContent = uniqueCards.toLocaleString();
            document.getElementById('collection-days').textContent = collectionDays.toLocaleString();
            document.getElementById('recent-cards').textContent = recentCards.toLocaleString();
            
            // Update collector rank
            updateCollectorRank(totalCards);
            
            // Update milestone progress
            updateMilestoneProgress(totalCards);
            
            // Update achievements
            updateAchievements(totalCards, uniqueCards, collectionDays, rarityDistribution);
            
            // Update rarity chart
            updateRarityChart(rarityDistribution, totalCards);
            
            // Check for new milestones
            checkMilestone(totalCards);
        };
        
        const updateCollectorRank = (totalCards) => {
            const rankEl = document.getElementById('collector-rank');
            let rank = '';
            let rankClass = '';
            let rankStyle = '';
            
            if (totalCards >= 100000) {
                rank = 'Ââµ‰∏ñÁ•û';
                rankClass = 'badge ms-2';
                rankStyle = 'background: linear-gradient(45deg, #ff00ff, #00ffff, #ffff00, #ff00ff); background-size: 400% 400%; animation: rainbow 3s ease infinite; color: white; font-weight: bold;';
            } else if (totalCards >= 50000) {
                rank = 'Á•ûË©±';
                rankClass = 'badge ms-2';
                rankStyle = 'background: linear-gradient(45deg, #ffd700, #ff6b6b, #ffd700); animation: shine 2s infinite; color: white;';
            } else if (totalCards >= 25000) {
                rank = 'Â§©Â∏ù';
                rankClass = 'badge ms-2';
                rankStyle = 'background: linear-gradient(45deg, #b9f2ff, #00d4ff); animation: sparkle 2s infinite; color: white;';
            } else if (totalCards >= 10000) {
                rank = 'Ë¶áÁéã';
                rankClass = 'badge ms-2';
                rankStyle = 'background: linear-gradient(45deg, #845ef7, #5c7cfa); color: white;';
            } else if (totalCards >= 5000) {
                rank = 'Ëã±ÈõÑ';
                rankClass = 'badge ms-2';
                rankStyle = 'background: linear-gradient(45deg, #ff6b6b, #ffd43b); color: white;';
            } else if (totalCards >= 2500) {
                rank = 'Ë≥¢ËÄÖ';
                rankClass = 'badge ms-2';
                rankStyle = 'background: linear-gradient(45deg, #51cf66, #12b886); color: white;';
            } else if (totalCards >= 1000) {
                rank = '‰ºùË™¨';
                rankClass = 'bg-danger';
            } else if (totalCards >= 500) {
                rank = '„Éû„Çπ„Çø„Éº';
                rankClass = 'bg-warning';
            } else if (totalCards >= 300) {
                rank = '„Ç®„Ç≠„Çπ„Éë„Éº„Éà';
                rankClass = 'bg-info';
            } else if (totalCards >= 100) {
                rank = '‰∏äÁ¥ö';
                rankClass = 'bg-success';
            } else if (totalCards >= 50) {
                rank = '‰∏≠Á¥ö';
                rankClass = 'bg-primary';
            } else if (totalCards >= 10) {
                rank = 'ÂàùÁ¥ö';
                rankClass = 'bg-secondary';
            } else {
                rank = 'Ë¶ãÁøí„ÅÑ';
                rankClass = 'bg-secondary';
            }
            
            rankEl.textContent = rank;
            rankEl.className = `badge ${rankClass} ms-2`;
            if (rankStyle) {
                rankEl.style = rankStyle;
            } else {
                rankEl.style = '';
            }
        };
        
        const updateMilestoneProgress = (totalCards) => {
            const progressContainer = document.getElementById('milestone-progress');
            const nextMilestone = MILESTONES.find(m => m > totalCards);
            
            if (nextMilestone) {
                const prevMilestone = MILESTONES[MILESTONES.indexOf(nextMilestone) - 1] || 0;
                const progress = ((totalCards - prevMilestone) / (nextMilestone - prevMilestone)) * 100;
                
                document.getElementById('milestone-text').textContent = `${nextMilestone}Êûö (ÊÆã„Çä${nextMilestone - totalCards}Êûö)`;
                document.getElementById('milestone-bar').style.width = `${progress}%`;
                document.getElementById('milestone-percent').textContent = `${Math.floor(progress)}%`;
                progressContainer.style.display = 'block';
            } else {
                progressContainer.style.display = 'none';
            }
        };
        
        const updateAchievements = (totalCards, uniqueCards, collectionDays, rarityDistribution) => {
            const summaryContainer = document.getElementById('achievement-summary-container');
            const detailsContainer = document.getElementById('achievement-details');
            
            summaryContainer.innerHTML = '';
            detailsContainer.innerHTML = '';
            
            // Calculate special counts
            const rareCount = Object.entries(rarityDistribution)
                .filter(([rarity]) => rarity.toLowerCase().includes('„É¨„Ç¢') || rarity.toLowerCase().includes('r'))
                .reduce((sum, [, count]) => sum + count, 0);
            
            const srCount = Object.entries(rarityDistribution)
                .filter(([rarity]) => rarity.toUpperCase().includes('SR'))
                .reduce((sum, [, count]) => sum + count, 0);
            
            const urCount = Object.entries(rarityDistribution)
                .filter(([rarity]) => rarity.toUpperCase().includes('UR'))
                .reduce((sum, [, count]) => sum + count, 0);
            
            const seCount = Object.entries(rarityDistribution)
                .filter(([rarity]) => rarity.toUpperCase().includes('SE'))
                .reduce((sum, [, count]) => sum + count, 0);
            
            const premiumCount = Object.entries(rarityDistribution)
                .filter(([rarity]) => rarity.toUpperCase().includes('P'))
                .reduce((sum, [, count]) => sum + count, 0);
            
            const ulCount = Object.entries(rarityDistribution)
                .filter(([rarity]) => rarity.toUpperCase().includes('UL'))
                .reduce((sum, [, count]) => sum + count, 0);
            
            const qcseCount = Object.entries(rarityDistribution)
                .filter(([rarity]) => rarity.toUpperCase().includes('QCSE'))
                .reduce((sum, [, count]) => sum + count, 0);
            
            // Track daily/weekly additions
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const weekAgo = new Date(today - 7 * 24 * 60 * 60 * 1000);
            
            let dailyAdditions = 0;
            let weeklyAdditions = 0;
            Object.entries(gamificationData.cardAdditionDates).forEach(([cardId, dateStr]) => {
                const date = new Date(dateStr);
                const dateOnly = dateStr.split('T')[0];
                if (dateOnly === todayStr) {
                    const card = cardCollection.find(c => c.id === cardId);
                    if (card) dailyAdditions += card.data['ÊûöÊï∞'] || 0;
                }
                if (date >= weekAgo) {
                    const card = cardCollection.find(c => c.id === cardId);
                    if (card) weeklyAdditions += card.data['ÊûöÊï∞'] || 0;
                }
            });
            
            // Count tags
            const allTags = new Set();
            cardCollection.forEach(card => {
                if (card.data.tags) {
                    card.data.tags.forEach(tag => allTags.add(tag));
                }
            });
            const tagCount = allTags.size;
            
            // Create summary for each category
            Object.entries(ACHIEVEMENT_CATEGORIES).forEach(([category, achievements]) => {
                const summary = document.createElement('div');
                summary.className = 'achievement-summary';
                
                // Calculate progress for this category
                let unlockedCount = 0;
                achievements.forEach(ach => {
                    let progress = 0;
                    if (ach.type === 'unique') progress = uniqueCards;
                    else if (ach.type === 'days') progress = collectionDays;
                    else if (ach.type === 'rarity') progress = rareCount;
                    else if (ach.type === 'sr') progress = srCount;
                    else if (ach.type === 'ur') progress = urCount;
                    else if (ach.type === 'se') progress = seCount;
                    else if (ach.type === 'premium') progress = premiumCount;
                    else if (ach.type === 'ul') progress = ulCount;
                    else if (ach.type === 'qcse') progress = qcseCount;
                    else if (ach.type === 'daily') progress = dailyAdditions;
                    else if (ach.type === 'weekly') progress = weeklyAdditions;
                    else if (ach.type === 'tags') progress = tagCount;
                    else progress = totalCards;
                    
                    if (progress >= ach.threshold) unlockedCount++;
                });
                
                const totalInCategory = achievements.length;
                const percentage = Math.round((unlockedCount / totalInCategory) * 100);
                
                summary.innerHTML = `
                    <div style="flex: 1;">
                        <strong>${category}</strong>
                        <small class="text-muted ms-2">${unlockedCount}/${totalInCategory} (${percentage}%)</small>
                    </div>
                    <div class="achievement-progress">
                        ${achievements.slice(0, 8).map(ach => {
                            let progress = 0;
                            if (ach.type === 'unique') progress = uniqueCards;
                            else if (ach.type === 'days') progress = collectionDays;
                            else if (ach.type === 'rarity') progress = rareCount;
                            else if (ach.type === 'sr') progress = srCount;
                            else if (ach.type === 'ur') progress = urCount;
                            else if (ach.type === 'se') progress = seCount;
                            else if (ach.type === 'premium') progress = premiumCount;
                            else if (ach.type === 'ul') progress = ulCount;
                            else if (ach.type === 'qcse') progress = qcseCount;
                            else if (ach.type === 'daily') progress = dailyAdditions;
                            else if (ach.type === 'weekly') progress = weeklyAdditions;
                            else if (ach.type === 'tags') progress = tagCount;
                            else progress = totalCards;
                            
                            const unlocked = progress >= ach.threshold;
                            return `<div class="achievement-dot ${unlocked ? 'unlocked' : ''}" title="${ach.desc}"></div>`;
                        }).join('')}
                        ${achievements.length > 8 ? `<small class="text-muted">+${achievements.length - 8}</small>` : ''}
                    </div>
                    <i class="bi bi-chevron-down"></i>
                `;
                
                // Add click handler
                summary.addEventListener('click', () => {
                    const isOpen = detailsContainer.classList.contains('show');
                    
                    if (isOpen && detailsContainer.dataset.category === category) {
                        detailsContainer.classList.remove('show');
                        detailsContainer.innerHTML = '';
                        summary.querySelector('i').className = 'bi bi-chevron-down';
                    } else {
                        // Close other categories
                        document.querySelectorAll('.achievement-summary i').forEach(icon => {
                            icon.className = 'bi bi-chevron-down';
                        });
                        
                        // Show details for this category
                        detailsContainer.innerHTML = `
                            <h6>${category} ÂÆüÁ∏æË©≥Á¥∞</h6>
                            <div class="d-flex flex-wrap gap-1">
                                ${achievements.map(ach => {
                                    let progress = 0;
                                    if (ach.type === 'unique') progress = uniqueCards;
                                    else if (ach.type === 'days') progress = collectionDays;
                                    else if (ach.type === 'rarity') progress = rareCount;
                                    else if (ach.type === 'sr') progress = srCount;
                                    else if (ach.type === 'ur') progress = urCount;
                                    else if (ach.type === 'se') progress = seCount;
                                    else if (ach.type === 'premium') progress = premiumCount;
                                    else if (ach.type === 'ul') progress = ulCount;
                                    else if (ach.type === 'qcse') progress = qcseCount;
                                    else if (ach.type === 'daily') progress = dailyAdditions;
                                    else if (ach.type === 'weekly') progress = weeklyAdditions;
                                    else if (ach.type === 'tags') progress = tagCount;
                                    else progress = totalCards;
                                    
                                    const unlocked = progress >= ach.threshold;
                                    return `
                                        <div class="achievement-badge ${unlocked ? ach.class : 'locked'}" 
                                             title="${ach.desc}${unlocked ? ' ‚úì' : ` (${progress}/${ach.threshold})`}">
                                            ${unlocked ? 'üèÜ' : 'üîí'} ${ach.name}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `;
                        detailsContainer.classList.add('show');
                        detailsContainer.dataset.category = category;
                        summary.querySelector('i').className = 'bi bi-chevron-up';
                    }
                });
                
                summaryContainer.appendChild(summary);
            });
        };
        
        const updateRarityChart = (distribution, total) => {
            const container = document.getElementById('rarity-chart-container');
            const barsContainer = document.getElementById('rarity-bars');
            
            if (Object.keys(distribution).length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            barsContainer.innerHTML = '';
            
            // Define rarity order and colors (Êã°ÂºµÂèØËÉΩ)
            const rarityOrder = ['N', 'NR', 'P', 'R', 'SR', 'P+SR', 'UR', 'P+UR', 'UL', 'GR', 'CR', 'HR', 'SE', 'EXSE', 'GSE', 'PSE', 'QCSE', '20SE', '25SE'];
            const rarityColors = {
                'N': '#868e96',
                'NR': '#95a8b1',
                'P': '#339af0',
                'R': '#51cf66',
                'SR': '#ffd43b',
                'P+SR': '#ff922b',
                'UR': '#ff6b6b',
                'P+UR': '#f06595',
                'UL': '#cc5de8',
                'GR': '#845ef7',
                'CR': '#5c7cfa',
                'HR': '#4c6ef5',
                'SE': '#748ffc',
                'EXSE': '#91a7ff',
                'GSE': '#dbe4ff',
                'PSE': '#e7f5ff',
                'QCSE': '#a5d8ff',
                '20SE': '#b197fc',  // 20Âë®Âπ¥SE
                '25SE': '#ffa94d',  // 25Âë®Âπ¥SE
                'default': '#868e96'
            };
            
            // Get max count for percentage calculation
            const maxCount = Math.max(...Object.values(distribution));

            // Track which rarities have been displayed
            const displayedRarities = new Set();

            // Display in defined order (Êó¢Áü•„ÅÆ„É¨„Ç¢„É™„ÉÜ„Ç£)
            rarityOrder.forEach(rarityKey => {
                // Check if this rarity exists in distribution
                Object.entries(distribution).forEach(([rarity, count]) => {
                    if (!displayedRarities.has(rarity) &&
                        (rarity === rarityKey || rarity.toUpperCase() === rarityKey.toUpperCase())) {

                        displayedRarities.add(rarity);
                        const percentage = (count / maxCount) * 100;
                        const color = rarityColors[rarityKey] || rarityColors.default;

                        const bar = document.createElement('div');
                        bar.className = 'rarity-bar';
                        bar.style.setProperty('--bar-height', `${percentage}%`);
                        bar.style.setProperty('--bar-color', color);
                        bar.innerHTML = `
                            <span class="rarity-bar-count">${count}</span>
                            <span class="rarity-bar-label" title="${escapeHtml(rarity)}">${escapeHtml(rarity)}</span>
                        `;
                        barsContainer.appendChild(bar);
                    }
                });
            });
            
            // Add any rarities not in the defined order
            const newRarityColors = [
                '#22b8cf', // „Ç∑„Ç¢„É≥
                '#15aabf', // „ÉÄ„Éº„ÇØ„Ç∑„Ç¢„É≥
                '#1098ad', // „Éá„Ç£„Éº„Éó„Ç∑„Ç¢„É≥
                '#0c8599', // „Éç„Ç§„Éì„Éº„Ç∑„Ç¢„É≥
                '#94d82d', // „É©„Ç§„É†
                '#82c91e', // „Ç∞„É™„Éº„É≥„É©„Ç§„É†
                '#74b816', // „ÉÄ„Éº„ÇØ„É©„Ç§„É†
                '#66a80f', // „Éá„Ç£„Éº„Éó„É©„Ç§„É†
                '#fab005', // „Ç¥„Éº„É´„Éâ
                '#fd7e14', // „Ç™„É¨„É≥„Ç∏
                '#f76707', // „ÉÄ„Éº„ÇØ„Ç™„É¨„É≥„Ç∏
                '#e8590c', // „Éá„Ç£„Éº„Éó„Ç™„É¨„É≥„Ç∏
            ];
            let newColorIndex = 0;
            const assignedColors = {};  // Êñ∞Ë¶è„É¨„Ç¢„É™„ÉÜ„Ç£„ÅÆËâ≤„ÇíË®òÊÜ∂

            Object.entries(distribution).forEach(([rarity, count]) => {
                // Êó¢„Å´Ë°®Á§∫Ê∏à„Åø„ÅÆ„É¨„Ç¢„É™„ÉÜ„Ç£„ÅØ„Çπ„Ç≠„ÉÉ„Éó
                if (displayedRarities.has(rarity)) {
                    return;
                }

                if (count > 0) {
                    // Êñ∞Ë¶è„É¨„Ç¢„É™„ÉÜ„Ç£„Å´Ëâ≤„ÇíÂâ≤„ÇäÂΩì„Å¶Ôºà‰∏ÄÂ∫¶Ââ≤„ÇäÂΩì„Å¶„Åü„ÇâÂêå„ÅòËâ≤„Çí‰Ωø„ÅÜÔºâ
                    if (!assignedColors[rarity]) {
                        assignedColors[rarity] = newRarityColors[newColorIndex % newRarityColors.length];
                        newColorIndex++;
                    }

                    const percentage = (count / maxCount) * 100;
                    const bar = document.createElement('div');
                    bar.className = 'rarity-bar';
                    bar.style.setProperty('--bar-height', `${percentage}%`);
                    bar.style.setProperty('--bar-color', assignedColors[rarity]);
                    bar.innerHTML = `
                        <span class="rarity-bar-count">${count}</span>
                        <span class="rarity-bar-label" title="${escapeHtml(rarity)}">${escapeHtml(rarity.substring(0, 4))}</span>
                    `;
                    barsContainer.appendChild(bar);

                    // Êñ∞Ë¶è„É¨„Ç¢„É™„ÉÜ„Ç£„Çí„Ç≥„É≥„ÇΩ„Éº„É´„Å´Ë®òÈå≤Ôºà„Éá„Éê„ÉÉ„Ç∞Áî®Ôºâ
                    console.log(`Êñ∞Ë¶è„É¨„Ç¢„É™„ÉÜ„Ç£Ê§úÂá∫: ${rarity} (${count}Êûö)`);
                }
            });
        };
        
        const checkMilestone = (totalCards) => {
            const milestone = MILESTONES.find(m => m === totalCards);
            if (milestone && milestone > gamificationData.lastMilestoneReached) {
                gamificationData.lastMilestoneReached = milestone;
                saveGamificationData();
                showMilestoneNotification(milestone);
            }
        };
        
        const showMilestoneNotification = (milestone) => {
            const notification = document.createElement('div');
            notification.className = 'milestone-notification';
            notification.innerHTML = `
                <div class="alert alert-success shadow-lg">
                    <h5 class="alert-heading">üéâ „Éû„Ç§„É´„Çπ„Éà„Éº„É≥ÈÅîÊàêÔºÅ</h5>
                    <p class="mb-0"><strong>${milestone}Êûö</strong>„ÅÆ„Ç´„Éº„Éâ„ÇíÂèéÈõÜ„Åó„Åæ„Åó„ÅüÔºÅ</p>
                    <hr>
                    <p class="mb-0 small">Á¥†Êô¥„Çâ„Åó„ÅÑÊàêÊûú„Åß„ÅôÔºÅÊ¨°„ÅÆÁõÆÊ®ô„Å´Âêë„Åã„Å£„Å¶È†ëÂºµ„Çä„Åæ„Åó„Çá„ÅÜÔºÅ</p>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        };
        
        // Helper function to normalize text for search
        const normalizeForSearch = (text) => {
            if (!text) return '';
            
            // Convert to lowercase
            text = text.toLowerCase();
            
            // Convert katakana to hiragana
            text = text.replace(/[„Ç°-„É∂]/g, (match) => {
                const code = match.charCodeAt(0) - 0x60;
                return String.fromCharCode(code);
            });
            
            // Convert full-width alphanumeric to half-width
            text = text.replace(/[Ôº°-Ôº∫ÔΩÅ-ÔΩöÔºê-Ôºô]/g, (match) => {
                return String.fromCharCode(match.charCodeAt(0) - 0xFEE0);
            });
            
            // Convert full-width space to half-width
            text = text.replace(/„ÄÄ/g, ' ');
            
            return text;
        };
        
        const applySearchAndFilter = () => {
            // Get basic search parameters
            const [sN,sC,sR,sT] = ['search_name','search_set_code','search_rarity','search_tags'].map(n=>normalizeForSearch(document.querySelector(`[name="${n}"]`).value));

            // Get search mode (AND/OR)
            const searchMode = document.querySelector('input[name="search_mode"]:checked')?.value || 'and';

            // Get advanced search parameters
            const sLevel = document.querySelector('[name="search_level"]')?.value?.trim();
            const sAttribute = document.querySelector('[name="search_attribute"]')?.value;
            // Get selected races from active race buttons
            const sRaces = Array.from(document.querySelectorAll('.race-btn.active'))
                .map(btn => btn.dataset.race); // Êóè„ÇíÂê´„ÇÄÂÆåÂÖ®„Å™ÂêçÂâç„Çí‰ΩøÁî®ÔºàÂ∞èÊñáÂ≠óÂåñ„Åó„Å™„ÅÑÔºâ

            // Get selected card types from active sub-type buttons
            const sCardTypes = Array.from(document.querySelectorAll('.sub-type-btn.active'))
                .filter(btn => btn.dataset.type !== 'all-monster')
                .map(btn => btn.dataset.type);

            const sAttack = document.querySelector('[name="search_attack"]')?.value?.trim();
            const sDefense = document.querySelector('[name="search_defense"]')?.value?.trim();

            // Debug logging
            console.log('=== Search Debug ===');
            console.log('Search Mode:', searchMode);
            console.log('Advanced Criteria:', {
                level: sLevel,
                attribute: sAttribute,
                races: sRaces,
                cardTypes: sCardTypes,
                attack: sAttack,
                defense: sDefense
            });

            // Get possible card names from hiragana reading
            let possibleCardNames = [];
            if (sN) {
                // Check if the search term matches any reading in our map
                const searchKey = sN.toLowerCase();
                if (cardReadingMap.has(searchKey)) {
                    possibleCardNames = cardReadingMap.get(searchKey);
                }

                // Also check for partial matches
                for (const [reading, cards] of cardReadingMap) {
                    if (reading.includes(searchKey)) {
                        possibleCardNames.push(...cards);
                    }
                }
            }

            // Helper function to check range values (e.g., "2000-3000" or "2500")
            const checkRange = (value, rangeStr) => {
                // Ê§úÁ¥¢Êù°‰ª∂„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÂ∏∏„Å´true
                if (!rangeStr) return true;

                // „Ç´„Éº„Éâ„Å´„Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥ÂêàÔºàÊ§úÁ¥¢Êù°‰ª∂„Åå„ÅÇ„Çã„ÅÆ„Å´„Ç´„Éº„Éâ„Å´„Éá„Éº„Çø„Åå„Å™„ÅÑÔºâ
                if (value === null || value === undefined || value === '') return false;

                // Handle range (e.g., "2000-3000")
                if (rangeStr.includes('-')) {
                    const [min, max] = rangeStr.split('-').map(v => parseInt(v.trim()));
                    const numValue = parseInt(value);
                    return !isNaN(numValue) && numValue >= min && numValue <= max;
                }

                // Handle single value
                return value.toString() === rangeStr;
            };

            let matchCount = 0;
            let totalCards = getCurrentCollection().length;
            let matchedCards = [];
            let debugLogCount = 0;
            const MAX_DEBUG_LOGS = 10;

            filteredCardCollection = getCurrentCollection().filter(c => {
                const d = c.data;
                const cardName = d['ÂêçÂâç'] || '';

                // Check name with both direct match and reading-based match
                let nameMatch = false;
                if (sN) {
                    // Direct match
                    nameMatch = normalizeForSearch(cardName).includes(sN);

                    // Reading-based match
                    if (!nameMatch && possibleCardNames.length > 0) {
                        const normalizedCardName = normalizeForSearch(cardName);
                        for (const possibleName of possibleCardNames) {
                            if (normalizedCardName.includes(normalizeForSearch(possibleName)) ||
                                normalizeForSearch(possibleName).includes(normalizedCardName)) {
                                nameMatch = true;
                                break;
                            }
                        }
                    }
                } else {
                    nameMatch = true;
                }

                // Check against card details from CSV or linked details
                let advancedMatch = true;
                let details = null;

                // First check if card has linked details
                if (d.linkedDetails) {
                    details = d.linkedDetails;
                } else if (cardDetailsMap.has(cardName)) {
                    // Otherwise check master data
                    details = cardDetailsMap.get(cardName);
                }

                if (details) {
                    // Check if any advanced search criteria is specified
                    const hasAdvancedCriteria = sLevel || sAttribute || sRaces.length > 0 || sCardTypes.length > 0 || sAttack || sDefense;

                    // Only apply advanced filtering if criteria is specified
                    if (hasAdvancedCriteria) {
                        if (searchMode === 'or') {
                            // ORÊ§úÁ¥¢Ôºö„ÅÑ„Åö„Çå„Åã„ÅÆÊù°‰ª∂„ÇíÊ∫Ä„Åü„Åõ„Å∞OK
                            let orMatch = false;
                            const debugChecks = [];

                            // Check level
                            if (sLevel) {
                                const levelCheck = checkRange(details.level, sLevel);
                                debugChecks.push(`Level: ${details.level} vs ${sLevel} = ${levelCheck}`);
                                if (levelCheck) orMatch = true;
                            }

                            // Check attribute
                            if (sAttribute) {
                                const attrCheck = details.attribute === sAttribute;
                                debugChecks.push(`Attribute: ${details.attribute} vs ${sAttribute} = ${attrCheck}`);
                                if (attrCheck) orMatch = true;
                            }

                            // Check races (multiple selection)
                            if (sRaces.length > 0) {
                                const hasMatchingRace = sRaces.some(race => {
                                    if (!race) return false;
                                    return details.race === race;
                                });
                                debugChecks.push(`Race: ${details.race} in [${sRaces.join(',')}] = ${hasMatchingRace}`);
                                if (hasMatchingRace) orMatch = true;
                            }

                            // Check card types - OR: match ANY of the selected types
                            if (sCardTypes.length > 0) {
                                // ORÊ§úÁ¥¢Ôºö„ÅÑ„Åö„Çå„Åã„ÅÆ„Ç´„Éº„Éâ„Çø„Ç§„Éó„ÇíÂê´„ÇÅ„Å∞OK
                                const hasMatchingType = sCardTypes.some(type => {
                                    // For spell/trap cards, check race field (CSV„Åß„ÅØÈ≠îÊ≥ï„ÉªÁΩ†„ÅØÁ®ÆÊóèÂàó„Å´Ê†ºÁ¥ç)
                                    if (type === 'È≠îÊ≥ï') {
                                        return details.race === 'È≠îÊ≥ï' || details.cardType === 'È≠îÊ≥ï';
                                    } else if (type === 'ÁΩ†') {
                                        return details.race === 'ÁΩ†' || details.cardType === 'ÁΩ†';
                                    } else {
                                        return details.cardType && details.cardType.includes(type);
                                    }
                                });
                                debugChecks.push(`CardType: ${details.cardType} matches ANY [${sCardTypes.join(',')}] = ${hasMatchingType}`);
                                if (hasMatchingType) orMatch = true;
                            }

                            // Check attack
                            if (sAttack) {
                                const atkCheck = checkRange(details.attack, sAttack);
                                debugChecks.push(`Attack: ${details.attack} vs ${sAttack} = ${atkCheck}`);
                                if (atkCheck) orMatch = true;
                            }

                            // Check defense
                            if (sDefense) {
                                const defCheck = checkRange(details.defense, sDefense);
                                debugChecks.push(`Defense: ${details.defense} vs ${sDefense} = ${defCheck}`);
                                if (defCheck) orMatch = true;
                            }

                            if (debugChecks.length > 0 && !orMatch && debugLogCount < MAX_DEBUG_LOGS) {
                                console.log(`[OR] Card: ${cardName} FAILED - ${debugChecks.join(', ')}`);
                                debugLogCount++;
                            }

                            advancedMatch = orMatch;
                        } else {
                            // ANDÊ§úÁ¥¢Ôºö„Åô„Åπ„Å¶„ÅÆÊù°‰ª∂„ÇíÊ∫Ä„Åü„ÅôÂøÖË¶Å„Åå„ÅÇ„ÇãÔºà„Éá„Éï„Ç©„É´„ÉàÔºâ
                            const debugChecks = [];

                            // Check level
                            if (sLevel) {
                                const levelCheck = checkRange(details.level, sLevel);
                                debugChecks.push(`Level: ${details.level} vs ${sLevel} = ${levelCheck}`);
                                advancedMatch = advancedMatch && levelCheck;
                            }

                            // Check attribute
                            if (sAttribute) {
                                const attrCheck = details.attribute === sAttribute;
                                debugChecks.push(`Attribute: ${details.attribute} vs ${sAttribute} = ${attrCheck}`);
                                advancedMatch = advancedMatch && attrCheck;
                            }

                            // Check races (multiple selection)
                            // Note: „Ç´„Éº„Éâ„ÅØ1„Å§„ÅÆÁ®ÆÊóè„Åó„ÅãÊåÅ„Åü„Å™„ÅÑ„Åü„ÇÅ„ÄÅÈÅ∏Êäû„Åó„ÅüÁ®ÆÊóè„ÅÆ„ÅÑ„Åö„Çå„Åã„Å´‰∏ÄËá¥„Åô„Çå„Å∞OK
                            if (sRaces.length > 0) {
                                const hasMatchingRace = sRaces.some(race => {
                                    if (!race) return false;
                                    return details.race === race;
                                });
                                debugChecks.push(`Race: ${details.race} in [${sRaces.join(',')}] = ${hasMatchingRace}`);
                                advancedMatch = advancedMatch && hasMatchingRace;
                            }

                            // Check card types - AND: must contain ALL selected types
                            if (sCardTypes.length > 0) {
                                // ANDÊ§úÁ¥¢Ôºö„Åô„Åπ„Å¶„ÅÆ„Ç´„Éº„Éâ„Çø„Ç§„Éó„ÇíÂê´„ÇÄÂøÖË¶Å„Åå„ÅÇ„Çã
                                const hasAllTypes = sCardTypes.every(type => {
                                    // For spell/trap cards, check race field (CSV„Åß„ÅØÈ≠îÊ≥ï„ÉªÁΩ†„ÅØÁ®ÆÊóèÂàó„Å´Ê†ºÁ¥ç)
                                    if (type === 'È≠îÊ≥ï') {
                                        return details.race === 'È≠îÊ≥ï' || details.cardType === 'È≠îÊ≥ï';
                                    } else if (type === 'ÁΩ†') {
                                        return details.race === 'ÁΩ†' || details.cardType === 'ÁΩ†';
                                    } else {
                                        return details.cardType && details.cardType.includes(type);
                                    }
                                });
                                debugChecks.push(`CardType: ${details.cardType} contains ALL [${sCardTypes.join(',')}] = ${hasAllTypes}`);
                                advancedMatch = advancedMatch && hasAllTypes;
                            }

                            // Check attack
                            if (sAttack) {
                                const atkCheck = checkRange(details.attack, sAttack);
                                debugChecks.push(`Attack: ${details.attack} vs ${sAttack} = ${atkCheck}`);
                                advancedMatch = advancedMatch && atkCheck;
                            }

                            // Check defense
                            if (sDefense) {
                                const defCheck = checkRange(details.defense, sDefense);
                                debugChecks.push(`Defense: ${details.defense} vs ${sDefense} = ${defCheck}`);
                                advancedMatch = advancedMatch && defCheck;
                            }

                            if (debugChecks.length > 0 && !advancedMatch && debugLogCount < MAX_DEBUG_LOGS) {
                                console.log(`[AND] Card: ${cardName} FAILED - ${debugChecks.join(', ')}`);
                                debugLogCount++;
                            }
                        }
                    }

                } else if (sLevel || sAttribute || sRaces.length > 0 || sCardTypes.length > 0 || sAttack || sDefense) {
                    // If advanced search is used but no details available, don't show it
                    advancedMatch = false;
                }

                const finalMatch = nameMatch &&
                       (!sC || normalizeForSearch(d['ÂûãÁï™']||'').includes(sC)) &&
                       (!sR || normalizeForSearch(d['„É¨„Ç¢„É™„ÉÜ„Ç£']||'').includes(sR)) &&
                       (!sT || normalizeForSearch((d.tags||[]).join(',')).includes(sT)) &&
                       advancedMatch;

                if (finalMatch) {
                    matchCount++;
                    if (matchedCards.length < 5) {
                        matchedCards.push(cardName);
                    }
                }

                return finalMatch;
            });

            console.log(`Search Results: ${matchCount}/${totalCards} cards matched`);
            if (matchedCards.length > 0) {
                console.log('First matched cards:', matchedCards.join(', '));
            }
            console.log('===================');

            currentPage = 1;
            renderTable();
        };

        const getTagsCollectionRef = () => currentUser?.uid !== 'local_user' ? collection(db, "users", currentUser.uid, "tags") : null;

        const loadAllTags = async () => {
            const tagsCollRef = getTagsCollectionRef();
            if (tagsCollRef) {
                const snapshot = await getDocs(query(tagsCollRef));
                allTags = snapshot.docs.map((doc, index) => ({ 
                    id: doc.id, 
                    name: doc.data().name,
                    order: doc.data().order !== undefined ? doc.data().order : index
                }));
                
                let needsOrderUpdate = false;
                allTags.forEach((tag, index) => {
                    if (tag.order === undefined || tag.order === 999) {
                        tag.order = index;
                        needsOrderUpdate = true;
                    }
                });
                
                if (needsOrderUpdate) {
                    await saveTagsOrder();
                }
            } else {
                const savedTagsOrder = localStorage.getItem('tagsOrder');
                if (savedTagsOrder) {
                    try {
                        allTags = JSON.parse(savedTagsOrder);
                    } catch (e) {
                        if (allTags.length === 0) {
                            allTags = [
                                { id: 'local1', name: '„Éá„ÉÉ„Ç≠„Éë„Éº„ÉÑ', order: 0 }, 
                                { id: 'local2', name: '„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥', order: 1 }
                            ];
                        }
                    }
                } else if (allTags.length === 0) {
                    allTags = [
                        { id: 'local1', name: '„Éá„ÉÉ„Ç≠„Éë„Éº„ÉÑ', order: 0 }, 
                        { id: 'local2', name: '„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥', order: 1 }
                    ];
                }
            }
            allTags.sort((a, b) => (a.order !== undefined ? a.order : 999) - (b.order !== undefined ? b.order : 999));
            renderTagManagementList();
            if (addForm.offsetParent !== null) renderTagChoices('tag-choices-container', currentCardTags);
            if (editCardModal._element.classList.contains('show')) renderTagChoices('edit-tag-choices-container', currentCardTags);
        };

        const renderTagManagementList = () => {
            const container = document.getElementById('existing-tags-list');
            container.innerHTML = '';
            allTags.forEach((tag, index) => {
                const div = document.createElement('div');
                div.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border rounded draggable-tag';
                div.draggable = true;
                div.dataset.tagId = tag.id;
                div.dataset.tagIndex = index;
                div.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="bi bi-grip-vertical me-2"></i>
                        <span class="tag-name-display" data-tag-id="${escapeHtml(tag.id)}">${escapeHtml(tag.name)}</span>
                        <button class="btn btn-sm btn-link edit-tag-name-btn ms-2" data-id="${escapeHtml(tag.id)}" data-name="${escapeHtml(tag.name)}" title="„Çø„Ç∞Âêç„ÇíÁ∑®ÈõÜ">
                            <i class="bi bi-pencil-square"></i>
                        </button>
                    </div>
                    <button class="btn btn-outline-danger btn-sm delete-tag-btn" data-id="${escapeHtml(tag.id)}" data-name="${escapeHtml(tag.name)}">ÂâäÈô§</button>
                `;
                
                div.addEventListener('dragstart', handleTagDragStart);
                div.addEventListener('dragend', handleTagDragEnd);
                div.addEventListener('dragover', handleTagDragOver);
                div.addEventListener('drop', handleTagDrop);
                div.addEventListener('dragenter', handleTagDragEnter);
                div.addEventListener('dragleave', handleTagDragLeave);
                
                container.appendChild(div);
            });
        };
        
        let draggedTag = null;
        
        const handleTagDragStart = (e) => {
            draggedTag = e.currentTarget;
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        };
        
        const handleTagDragEnd = (e) => {
            e.currentTarget.classList.remove('dragging');
            document.querySelectorAll('.draggable-tag').forEach(tag => {
                tag.classList.remove('drag-over');
            });
        };
        
        const handleTagDragOver = (e) => {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        };
        
        const handleTagDragEnter = (e) => {
            if (draggedTag && e.currentTarget !== draggedTag) {
                e.currentTarget.classList.add('drag-over');
            }
        };
        
        const handleTagDragLeave = (e) => {
            e.currentTarget.classList.remove('drag-over');
        };
        
        const handleTagDrop = async (e) => {
            if (e.stopPropagation) e.stopPropagation();
            e.currentTarget.classList.remove('drag-over');
            
            if (draggedTag && e.currentTarget !== draggedTag) {
                const draggedIndex = parseInt(draggedTag.dataset.tagIndex);
                const targetIndex = parseInt(e.currentTarget.dataset.tagIndex);
                
                const draggedItem = allTags[draggedIndex];
                allTags.splice(draggedIndex, 1);
                allTags.splice(targetIndex, 0, draggedItem);
                
                allTags.forEach((tag, index) => {
                    tag.order = index;
                });
                
                await saveTagsOrder();
                
                renderTagManagementList();
                renderTagChoices('tag-choices-container', currentCardTags);
                renderTagChoices('edit-tag-choices-container', currentCardTags);
            }
            
            return false;
        };
        
        const saveTagsOrder = async () => {
            const tagsCollRef = getTagsCollectionRef();
            if (tagsCollRef) {
                try {
                    const batch = writeBatch(db);
                    for (const tag of allTags) {
                        const tagDoc = doc(tagsCollRef, tag.id);
                        batch.set(tagDoc, { 
                            name: tag.name,
                            order: tag.order 
                        }, { merge: true });
                    }
                    await batch.commit();
                } catch (error) {
                }
            } else {
                localStorage.setItem('tagsOrder', JSON.stringify(allTags));
            }
        };

        document.getElementById('add-tag-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const inputValue = document.getElementById('new-tag-name').value.trim();
            if (!inputValue) return;
            
            const newTagNames = inputValue.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
            
            if (newTagNames.length === 0) {
                alert('ÊúâÂäπ„Å™„Çø„Ç∞Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            const tagsCollRef = getTagsCollectionRef();
            const addedTags = [];
            const duplicateTags = [];
            
            for (const newTagName of newTagNames) {
                if (allTags.some(tag => tag.name === newTagName)) {
                    duplicateTags.push(newTagName);
                } else {
                    const maxOrder = allTags.reduce((max, tag) => Math.max(max, tag.order || 0), -1);
                    const newOrder = maxOrder + 1;
                    
                    if (tagsCollRef) {
                        const docRef = await addDoc(tagsCollRef, { name: newTagName, order: newOrder });
                        allTags.push({ id: docRef.id, name: newTagName, order: newOrder });
                    } else {
                        allTags.push({ id: `local_${Date.now()}_${Math.random()}`, name: newTagName, order: newOrder });
                    }
                    addedTags.push(newTagName);
                }
            }
            
            if (duplicateTags.length > 0) {
                alert(`‰ª•‰∏ã„ÅÆ„Çø„Ç∞„ÅØÊó¢„Å´Â≠òÂú®„Åô„Çã„Åü„ÇÅ„Çπ„Ç≠„ÉÉ„Éó„Åï„Çå„Åæ„Åó„Åü: ${duplicateTags.join(', ')}`);
            }
            
            if (addedTags.length > 0) {
                document.getElementById('new-tag-name').value = '';
                if (!tagsCollRef) {
                    localStorage.setItem('tagsOrder', JSON.stringify(allTags));
                }
                allTags.sort((a, b) => (a.order !== undefined ? a.order : 999) - (b.order !== undefined ? b.order : 999));
                renderTagManagementList();
                renderTagChoices('tag-choices-container', currentCardTags);
                renderTagChoices('edit-tag-choices-container', currentCardTags);
            }
        });

        document.getElementById('existing-tags-list').addEventListener('click', async (e) => {
            // Edit tag name
            if (e.target.closest('.edit-tag-name-btn')) {
                const btn = e.target.closest('.edit-tag-name-btn');
                const tagId = btn.dataset.id;
                const oldName = btn.dataset.name;
                const newName = prompt('Êñ∞„Åó„ÅÑ„Çø„Ç∞Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', oldName);

                if (newName && newName.trim() && newName !== oldName) {
                    const trimmedName = newName.trim();

                    // Check for duplicates
                    if (allTags.some(t => t.name === trimmedName && t.id !== tagId)) {
                        alert('„Åì„ÅÆ„Çø„Ç∞Âêç„ÅØÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô„ÄÇ');
                        return;
                    }

                    // Update tag name
                    const tagIndex = allTags.findIndex(t => t.id === tagId);
                    if (tagIndex !== -1) {
                        allTags[tagIndex].name = trimmedName;

                        // Save to Firebase or localStorage
                        const tagsCollRef = getTagsCollectionRef();
                        if (tagsCollRef) {
                            await updateDoc(doc(tagsCollRef, tagId), { name: trimmedName });
                        } else {
                            localStorage.setItem('tagsOrder', JSON.stringify(allTags));
                        }

                        // Update all cards with this tag
                        const collection = getCurrentCollection();
                        for (const card of collection) {
                            if (card.data.tags && card.data.tags.includes(oldName)) {
                                const tagIndex = card.data.tags.indexOf(oldName);
                                card.data.tags[tagIndex] = trimmedName;

                                // Save card update
                                const collRef = getCollectionRef(currentListType);
                                if (collRef) {
                                    await updateDoc(doc(collRef, card.id), { tags: card.data.tags });
                                }
                            }
                        }

                        // Refresh UI
                        renderTagManagementList();
                        renderTagChoices('tag-choices-container', currentCardTags);
                        renderTagChoices('edit-tag-choices-container', currentCardTags);
                        renderTable();
                    }
                }
                return;
            }

            if (e.target.classList.contains('delete-tag-btn')) {
                const tagId = e.target.dataset.id;
                const tagName = e.target.dataset.name;
                if (!confirm(`„Çø„Ç∞„Äå${escapeHtml(tagName)}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü
„Åì„ÅÆ„Çø„Ç∞„ÅØÂÖ®„Å¶„ÅÆ„Ç´„Éº„Éâ„Åã„Çâ„ÇÇÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ`)) return;

                showLoading(true);
                try {
                    // Delete tag from all cards
                    const collectionRef = getCollectionRef('collection');
                    const wishlistRef = getCollectionRef('wishlist');

                    // Update collection cards
                    for (const card of cardCollection) {
                        if (card.data.tags && card.data.tags.includes(tagName)) {
                            const updatedTags = card.data.tags.filter(t => t !== tagName);
                            card.data.tags = updatedTags;

                            if (collectionRef) {
                                await updateDoc(doc(collectionRef, card.id), { tags: updatedTags });
                            } else {
                                localStorage.setItem('cardCollection', JSON.stringify(cardCollection));
                            }
                        }
                    }

                    // Update wishlist cards
                    for (const card of wishlistCollection) {
                        if (card.data.tags && card.data.tags.includes(tagName)) {
                            const updatedTags = card.data.tags.filter(t => t !== tagName);
                            card.data.tags = updatedTags;

                            if (wishlistRef) {
                                await updateDoc(doc(wishlistRef, card.id), { tags: updatedTags });
                            } else {
                                localStorage.setItem('wishlistCollection', JSON.stringify(wishlistCollection));
                            }
                        }
                    }

                    // Delete tag from tags collection
                    const tagsCollRef = getTagsCollectionRef();
                    if (tagsCollRef) {
                        await deleteDoc(doc(tagsCollRef, tagId));
                    }

                    allTags = allTags.filter(t => t.id !== tagId);
                    allTags.forEach((tag, index) => {
                        tag.order = index;
                    });

                    await saveTagsOrder();

                    renderTagManagementList();
                    renderTagChoices('tag-choices-container', currentCardTags);
                    renderTagChoices('edit-tag-choices-container', currentCardTags);

                    // Re-render the table if tag filter is active
                    if (document.querySelector('[name="search_tags"]').value) {
                        applySearchAndFilter();
                    }

                    alert(`„Çø„Ç∞„Äå${tagName}„Äç„ÇíÂâäÈô§„Åó„ÄÅÂÖ®„Å¶„ÅÆ„Ç´„Éº„Éâ„Åã„ÇâÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ`);
                } catch (error) {
                    console.error('Error deleting tag:', error);
                    alert('„Çø„Ç∞„ÅÆÂâäÈô§‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
                } finally {
                    showLoading(false);
                }
            }
        });

        const getCollectionRef = (listType = 'collection') => {
            if (currentUser && currentUser.uid !== 'local_user') {
                const collectionName = listType === 'collection' ? "cards" : "wishlist";
                return collection(db, "users", currentUser.uid, collectionName);
            }
            return null;
        };

        const loadCollectionFromFirestore = async () => {
            if (!currentUser) return;
            showLoading(true);
            
            const cardSnapshot = await getDocs(query(getCollectionRef('collection')));
            cardCollection = cardSnapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
            
            const wishlistSnapshot = await getDocs(query(getCollectionRef('wishlist')));
            wishlistCollection = wishlistSnapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
            
            updateTotalCounts(); // Update stats
            applySearchAndFilter();
            showLoading(false);
        };

        const handleUserLogin = async (user) => {
            currentUser = user;
            const hideEmail = localStorage.getItem('hideEmail') === 'true';

            // „É°„Éº„É´Ë™çË®ºÁä∂ÊÖã„ÇíÁ¢∫Ë™ç
            if (user.uid !== 'local_user' && !user.emailVerified) {
                const verificationWarning = `
                    <span class="text-warning">
                        <i class="bi bi-exclamation-triangle"></i> „É°„Éº„É´Êú™Á¢∫Ë™ç
                        <button class="btn btn-sm btn-outline-warning ms-2" onclick="resendVerificationEmail()">
                            Á¢∫Ë™ç„É°„Éº„É´„ÇíÂÜçÈÄÅ‰ø°
                        </button>
                    </span>
                `;
                userEmailSpan.innerHTML = hideEmail ? verificationWarning : escapeHtml(user.email) + ' ' + verificationWarning;
            } else {
                userEmailSpan.textContent = hideEmail ? '' : escapeHtml(user.email);
            }

            mainApp.style.display = 'block';
            appLoader.style.display = 'none';
            authModal.hide();
            
            // Load gamification data from Firebase
            await loadGamificationData();
            
            if (user.uid !== 'local_user') {
                loadCollectionFromFirestore();
                loadAllTags();
            } else {
                cardCollection = [];
                wishlistCollection = [];
                updateTotalCounts(); // Update stats for local mode
                applySearchAndFilter();
                loadAllTags(); // „É≠„Éº„Ç´„É´„É¢„Éº„Éâ„Åß„ÇÇ„Çø„Ç∞„Çí„É≠„Éº„Éâ„ÉªÂàùÊúüÂåñ
                document.getElementById('delete-account-btn').style.display = 'none';
            }
            applyTheme();
            
            // Initialize gamification features with loaded data
            initializeDailyMissions();
            initializeFunDashboard(); // Initialize fun features
            initializeShop(); // Initialize shop
            updatePointsDisplay();
            updateRegistrationStreak();
            updateTodayStats();
            updateDailyMissions();
            
            // Apply saved daily challenges visibility preference
            const hideDailyChallenges = localStorage.getItem('hideDailyChallenges') === 'true';
            if (hideDailyChallenges) {
                document.getElementById('daily-challenges-body').style.display = 'none';
                document.getElementById('daily-challenges-toggle-icon').className = 'bi bi-eye';
            }
            
            // Apply saved customizations from Firebase data
            if (gamificationData.activeTheme && gamificationData.activeTheme !== 'default') {
                window.applyTheme(gamificationData.activeTheme);
            }
            
            if (gamificationData.activeFrame) {
                window.applyFrame(gamificationData.activeFrame);
            }
            
            if (gamificationData.activeBackground) {
                window.applyBackground(gamificationData.activeBackground);
            }
            
            if (gamificationData.activeIcon) {
                window.applyIcon(gamificationData.activeIcon);
            }
            
            // Apply all purchased effects
            if (gamificationData.purchasedItems) {
                Object.keys(gamificationData.purchasedItems).forEach(itemId => {
                    if (itemId.startsWith('effect-') && gamificationData.purchasedItems[itemId]) {
                        document.body.classList.add(itemId);
                    }
                });
            }
            
            // Check for first login bonus
            checkFirstLoginBonus(user);
            
            // Add shop button event listener
            document.getElementById('point-shop-btn').addEventListener('click', () => {
                const shopModal = new bootstrap.Modal(document.getElementById('point-shop-modal'));
                shopModal.show();
            });
            
            // Add profile functionality
            initializeProfile();

            // Add ranking functionality
            initializeRanking();

            // Add analysis functionality
            initializeAnalysis();

            // Check VIP status after login
            checkVipStatus();
        };

        // Track daily usage
        const trackDailyUsage = () => {
            const today = new Date().toISOString().split('T')[0];
            
            if (!gamificationData.profile) {
                gamificationData.profile = {
                    nickname: '',
                    icon: 'üë§',
                    firstUseDate: null,
                    lastUseDate: null,
                    usageDays: new Set(),
                    maxStreak: 0,
                    totalPointsEarned: 0
                };
            }
            
            // Initialize as Set if it's not
            if (!(gamificationData.profile.usageDays instanceof Set)) {
                gamificationData.profile.usageDays = new Set(gamificationData.profile.usageDays || []);
            }
            
            // Track first use date
            if (!gamificationData.profile.firstUseDate) {
                gamificationData.profile.firstUseDate = today;
            }
            
            // Add today to usage days
            gamificationData.profile.usageDays.add(today);
            
            // Update last use date
            gamificationData.profile.lastUseDate = today;
            
            // Update max streak
            if (gamificationData.registrationStreak.count > (gamificationData.profile.maxStreak || 0)) {
                gamificationData.profile.maxStreak = gamificationData.registrationStreak.count;
            }
            
            saveGamificationData();
        };
        
        // Variable to store selected icon
        let selectedIcon = 'üë§';
        
        // Update icon selector with all available icons
        const updateIconSelector = () => {
            const selectorContainer = document.getElementById('profile-icon-selector');
            selectorContainer.innerHTML = '';
            
            // Default icons (always available)
            const defaultIcons = [
                'üë§', 'üòä', 'üòé', 'üéÆ', 'üéØ', '‚≠ê', 'üèÜ', 'üíé', 'üî•', '‚ö°', 'üåü', 'üé®'
            ];
            
            // Add default icons
            defaultIcons.forEach(icon => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn btn-outline-secondary icon-select';
                btn.dataset.icon = icon;
                btn.textContent = icon;
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.icon-select').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedIcon = icon;
                });
                selectorContainer.appendChild(btn);
            });
            
            // Add purchased shop icons
            SHOP_ITEMS.icons.forEach(shopIcon => {
                if (gamificationData.purchasedItems[shopIcon.id]) {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'btn btn-outline-secondary icon-select';
                    btn.dataset.icon = shopIcon.emoji;
                    btn.innerHTML = `${shopIcon.emoji} <small class="d-block" style="font-size: 0.6rem;">Ë≥ºÂÖ•Ê∏à„Åø</small>`;
                    btn.style.position = 'relative';
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.icon-select').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        selectedIcon = shopIcon.emoji;
                    });
                    selectorContainer.appendChild(btn);
                }
            });

            // Add gacha exclusive icons that have been obtained
            SHOP_ITEMS.exclusiveIcons.forEach(exclusiveIcon => {
                if (gamificationData.purchasedItems[exclusiveIcon.id]) {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'btn btn-outline-secondary icon-select';
                    btn.dataset.icon = exclusiveIcon.emoji;

                    // Add special badge based on rarity
                    const rarityLabel = exclusiveIcon.rarity === 'legendary' ?
                        '<span class="badge bg-danger" style="font-size: 0.5rem;">LEGENDARY</span>' :
                        '<span class="badge bg-warning" style="font-size: 0.5rem;">ULTRA RARE</span>';

                    btn.innerHTML = `${exclusiveIcon.emoji} <small class="d-block" style="font-size: 0.6rem;">${rarityLabel}</small>`;
                    btn.style.position = 'relative';

                    // Add special border for legendary items
                    if (exclusiveIcon.rarity === 'legendary') {
                        btn.style.border = '2px solid #ffd700';
                        btn.style.boxShadow = '0 0 10px rgba(255, 215, 0, 0.3)';
                    }

                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.icon-select').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        selectedIcon = exclusiveIcon.emoji;
                    });
                    selectorContainer.appendChild(btn);
                }
            });
        };
        
        // Initialize profile functionality
        const initializeProfile = () => {
            const profileBtn = document.getElementById('profile-btn');
            const profileModal = new bootstrap.Modal(document.getElementById('profile-modal'));
            const editProfileBtn = document.getElementById('edit-profile-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const profileEditForm = document.getElementById('profile-edit-form');
            const profileView = document.getElementById('profile-view');
            const profileEdit = document.getElementById('profile-edit');
            
            // Profile button click
            profileBtn.addEventListener('click', () => {
                updateProfileDisplay();
                profileModal.show();
            });
            
            // Edit profile button
            editProfileBtn.addEventListener('click', () => {
                profileView.style.display = 'none';
                profileEdit.style.display = 'block';
                
                // Pre-fill edit form
                document.getElementById('edit-nickname').value = gamificationData.profile?.nickname || '';
                
                // Update icon selector with purchased icons
                updateIconSelector();
                
                // Set active icon
                document.querySelectorAll('.icon-select').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.icon === (gamificationData.profile?.icon || 'üë§'));
                });
            });
            
            // Cancel edit button
            cancelEditBtn.addEventListener('click', () => {
                profileView.style.display = 'block';
                profileEdit.style.display = 'none';
            });
            
            // Initialize selectedIcon with current profile icon
            selectedIcon = gamificationData.profile?.icon || 'üë§';
            
            // Save profile form
            profileEditForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const nickname = document.getElementById('edit-nickname').value.trim();
                
                if (!gamificationData.profile) {
                    gamificationData.profile = {
                        nickname: '',
                        icon: 'üë§',
                        firstUseDate: null,
                        lastUseDate: null,
                        usageDays: new Set(),
                        maxStreak: 0,
                        totalPointsEarned: 0
                    };
                }
                
                gamificationData.profile.nickname = nickname;
                gamificationData.profile.icon = selectedIcon;
                
                await saveGamificationData();
                
                profileView.style.display = 'block';
                profileEdit.style.display = 'none';
                
                updateProfileDisplay();
                
                // Update ranking data with new profile info
                await updateUserRankingData();
                
                showNotification('„Éó„É≠„Éï„Ç£„Éº„É´„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
            });
        };
        
        // Initialize ranking functionality
        const initializeRanking = () => {
            const rankingBtn = document.getElementById('ranking-btn');
            const rankingModal = new bootstrap.Modal(document.getElementById('ranking-modal'));

            rankingBtn.addEventListener('click', async () => {
                rankingModal.show();
                await loadRankings();
            });

            // Update user's ranking data when cards change
            updateUserRankingData();
        };

        // Initialize analysis functionality
        const initializeAnalysis = () => {
            const analysisBtn = document.getElementById('analysis-btn');
            const refreshBtn = document.getElementById('refresh-analysis-btn');

            analysisBtn.addEventListener('click', async () => {
                analysisModal.show();
                await buildCardAdditionHistory();
                updateAnalysisData();
                updateCalendarDisplay();
            });

            // Add refresh button handler
            refreshBtn.addEventListener('click', async () => {
                await buildCardAdditionHistory();
                updateAnalysisData();
                updateCalendarDisplay();
            });
        };

        // Calendar heatmap functionality
        let currentCalendarDate = new Date();
        let cardAdditionHistory = {}; // Store as { 'YYYY-MM-DD': count }

        // Generate calendar heatmap
        const generateCalendarHeatmap = (year, month) => {
            const container = document.getElementById('calendar-container');
            if (!container) return;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startPadding = firstDay.getDay();
            const daysInMonth = lastDay.getDate();

            // Days of week header
            const weekDays = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
            let html = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; max-width: 400px; margin: 0 auto;">';

            // Add weekday headers
            weekDays.forEach(day => {
                html += `<div style="text-align: center; font-size: 0.8rem; font-weight: bold; padding: 5px;">${day}</div>`;
            });

            // Add empty cells for padding
            for (let i = 0; i < startPadding; i++) {
                html += '<div></div>';
            }

            // Add days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const count = cardAdditionHistory[dateStr] || 0;
                const color = getHeatmapColor(count);
                const isToday = dateStr === new Date().toISOString().split('T')[0];

                html += `
                    <div style="
                        background-color: ${color};
                        aspect-ratio: 1;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 4px;
                        cursor: pointer;
                        position: relative;
                        border: ${isToday ? '2px solid #007bff' : 'none'};
                    "
                    data-bs-toggle="tooltip"
                    title="${year}Âπ¥${month + 1}Êúà${day}Êó•: ${count}ÊûöËøΩÂä†">
                        <span style="font-size: 0.75rem; font-weight: ${count > 0 ? 'bold' : 'normal'};">${day}</span>
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;

            // Initialize tooltips
            const tooltipTriggerList = container.querySelectorAll('[data-bs-toggle="tooltip"]');
            tooltipTriggerList.forEach(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
        };

        // Get color based on card count
        const getHeatmapColor = (count) => {
            if (count === 0) return '#e0e0e0';
            if (count <= 5) return '#c6e48b';
            if (count <= 10) return '#7bc96f';
            if (count <= 20) return '#239a3b';
            return '#196127';
        };

        // Change calendar month
        window.changeCalendarMonth = (direction) => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            updateCalendarDisplay();
        };

        // Update calendar display
        const updateCalendarDisplay = () => {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const label = document.getElementById('calendar-month-label');
            if (label) {
                label.textContent = `${year}Âπ¥${month + 1}Êúà`;
            }
            generateCalendarHeatmap(year, month);
        };

        // Build card addition history from localStorage and Firebase
        const buildCardAdditionHistory = async () => {
            cardAdditionHistory = {};

            // Get recent history from localStorage
            const recentCardsHistory = localStorage.getItem('recentCardsHistory');
            if (recentCardsHistory) {
                try {
                    const history = JSON.parse(recentCardsHistory);
                    history.forEach(item => {
                        if (item.timestamp) {
                            const date = new Date(item.timestamp).toISOString().split('T')[0];
                            const quantity = parseInt(item.quantity) || 1;
                            cardAdditionHistory[date] = (cardAdditionHistory[date] || 0) + quantity;
                        }
                    });
                } catch (e) {
                    console.error('Error parsing recent history:', e);
                }
            }

            // Also check current collection for created timestamps if available
            const collection = getCurrentCollection();
            collection.forEach(card => {
                if (card.createdAt) {
                    const date = new Date(card.createdAt).toISOString().split('T')[0];
                    const quantity = parseInt(card.data['ÊûöÊï∞']) || 1;
                    cardAdditionHistory[date] = (cardAdditionHistory[date] || 0) + quantity;
                }
            });
        };

        // Get estimated price for rarity
        const getRarityPrice = (rarity) => {
            if (!rarity) return 0.1;

            // Define rarity prices based on provided list
            const rarityPrices = {
                'N': 0.1,
                'P': 0.1,
                'R': 0.5,
                'SR': 1,
                'P+SR': 1,
                'UR': 10,
                'P+UR': 10,
                'UL': 10,
                'GR': 1,
                'CR': 10,
                'HR': 100,
                'SE': 30,
                'P+SE': 100,
                'EXSE': 100,
                'GSE': 100,
                'PSE': 300,
                '20th': 500,
                'QCSE': 500
            };

            // Check exact match first
            if (rarityPrices[rarity]) {
                return rarityPrices[rarity];
            }

            // Check partial matches
            const rarityUpper = rarity.toUpperCase();
            for (const [key, value] of Object.entries(rarityPrices)) {
                if (rarityUpper.includes(key)) {
                    return value;
                }
            }

            // Default values for common patterns
            if (rarityUpper.includes('QCSE')) return 500;
            if (rarityUpper.includes('20TH') || rarityUpper.includes('20„Ç∑„ÇØ')) return 500;
            if (rarityUpper.includes('PSE')) return 300;
            if (rarityUpper.includes('GSE') || rarityUpper.includes('EXSE')) return 100;
            if (rarityUpper.includes('P+SE')) return 100;
            if (rarityUpper.includes('HR')) return 100;
            if (rarityUpper.includes('SE')) return 30;
            if (rarityUpper.includes('P+UR')) return 10;
            if (rarityUpper.includes('UR') || rarityUpper.includes('UL') || rarityUpper.includes('CR')) return 10;
            if (rarityUpper.includes('P+SR')) return 1;
            if (rarityUpper.includes('SR') || rarityUpper.includes('GR')) return 1;
            if (rarityUpper.includes('R')) return 0.5;
            if (rarityUpper.includes('P')) return 0.1;
            if (rarityUpper.includes('N')) return 0.1;

            // Default for unknown
            return 0.1;
        };

        // Update analysis data
        const updateAnalysisData = () => {
            const collection = getCurrentCollection();
            const totalCards = collection.reduce((sum, card) => sum + (parseInt(card.data['ÊûöÊï∞']) || 0), 0);
            const uniqueCards = collection.length;

            // Update overview
            document.getElementById('analysis-total-cards').textContent = totalCards.toLocaleString();
            document.getElementById('analysis-unique-cards').textContent = uniqueCards.toLocaleString();
            document.getElementById('analysis-avg-cards').textContent = uniqueCards > 0 ? (totalCards / uniqueCards).toFixed(1) : '0';

            // Calculate rarity distribution
            const rarityDistribution = {};
            const attributeDistribution = {};
            const raceDistribution = {};
            const levelDistribution = {};
            const typeDistribution = {};
            let totalValue = 0;

            collection.forEach(card => {
                const quantity = parseInt(card.data['ÊûöÊï∞']) || 0;
                const rarity = card.data['„É¨„Ç¢„É™„ÉÜ„Ç£'] || '‰∏çÊòé';

                // Rarity distribution
                rarityDistribution[rarity] = (rarityDistribution[rarity] || 0) + quantity;

                // Get card details for attribute, race, level, type
                const cardName = card.data['ÂêçÂâç'];
                let details = null;

                // First check if card has linkedDetails
                if (card.data.linkedDetails) {
                    details = card.data.linkedDetails;
                } else if (cardDetailsMap.has(cardName)) {
                    // Otherwise check master data
                    details = cardDetailsMap.get(cardName);
                }

                if (details) {
                    // Attribute distribution
                    if (details.attribute) {
                        attributeDistribution[details.attribute] = (attributeDistribution[details.attribute] || 0) + quantity;
                    }

                    // Race distribution
                    if (details.race) {
                        raceDistribution[details.race] = (raceDistribution[details.race] || 0) + quantity;
                    }

                    // Level distribution
                    if (details.level) {
                        const levelKey = `„É¨„Éô„É´${details.level}`;
                        levelDistribution[levelKey] = (levelDistribution[levelKey] || 0) + quantity;
                    }

                    // Type distribution
                    if (details.cardType) {
                        typeDistribution[details.cardType] = (typeDistribution[details.cardType] || 0) + quantity;
                    }
                }

                // Calculate estimated value based on rarity
                totalValue += quantity * getRarityPrice(rarity);
            });

            // Update estimated value
            document.getElementById('analysis-estimated-value').textContent = `¬•${totalValue.toLocaleString()}`;

            // Update recent cards history
            const recentCardsHistory = localStorage.getItem('recentCardsHistory');
            let recentCards = [];
            if (recentCardsHistory) {
                try {
                    recentCards = JSON.parse(recentCardsHistory);
                } catch(e) {
                    recentCards = [];
                }
            }

            const recentCardsHtml = recentCards
                .slice(0, 50)
                .map(item => {
                    const date = new Date(item.timestamp);
                    const formattedDate = date.toLocaleDateString('ja-JP', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    return `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">${escapeHtml(item.name)}</h6>
                                    <div class="small text-muted">
                                        ${item.setCode ? `<span class="badge bg-secondary me-1">${escapeHtml(item.setCode)}</span>` : ''}
                                        ${item.rarity ? `<span class="badge bg-info me-1">${escapeHtml(item.rarity)}</span>` : ''}
                                        <span class="badge bg-primary">${item.quantity}Êûö</span>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted">${formattedDate}</small>
                                    <div class="mt-1">
                                        <span class="badge ${item.listType === 'wishlist' ? 'bg-warning' : 'bg-success'} me-1">
                                            ${item.listType === 'wishlist' ? 'Ê¨≤„Åó„ÅÑ„Ç´„Éº„Éâ' : 'ÊâÄÊåÅ„Ç´„Éº„Éâ'}
                                        </span>
                                        <button class="btn btn-sm btn-outline-danger" onclick="undoRecentAddition('${escapeHtml(item.name)}', '${escapeHtml(item.setCode || '')}', '${escapeHtml(item.rarity || '')}', ${item.quantity}, '${item.listType}', '${item.timestamp}')" title="„Åì„ÅÆËøΩÂä†„ÇíÂèñ„ÇäÊ∂à„Åô">
                                            <i class="bi bi-arrow-counterclockwise"></i> ÂèñÊ∂à
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            document.getElementById('recent-cards-list').innerHTML = recentCardsHtml || '<p class="text-muted">„Åæ„Å†„Ç´„Éº„Éâ„ÅåËøΩÂä†„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>';

            // Update top cards by quantity
            const topCards = [...collection]
                .sort((a, b) => (parseInt(b.data['ÊûöÊï∞']) || 0) - (parseInt(a.data['ÊûöÊï∞']) || 0))
                .slice(0, 5);

            const topCardsHtml = topCards.map(card => `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${escapeHtml(card.data['ÂêçÂâç'])}</strong>
                            <small class="text-muted d-block">${escapeHtml(card.data['ÂûãÁï™'] || '')}</small>
                        </div>
                        <span class="badge bg-primary">${card.data['ÊûöÊï∞']}Êûö</span>
                    </div>
                </div>
            `).join('');
            document.getElementById('analysis-top-cards').innerHTML = topCardsHtml || '<p class="text-muted">„Ç´„Éº„Éâ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';

            // Update rarity ranking
            const rarityRankingHtml = Object.entries(rarityDistribution)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([rarity, count], index) => `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>${index + 1}. ${escapeHtml(rarity)}</span>
                            <span class="badge bg-secondary">${count}Êûö</span>
                        </div>
                    </div>
                `).join('');
            document.getElementById('analysis-rarity-ranking').innerHTML = rarityRankingHtml || '<p class="text-muted">„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
        };
        
        // Update user's ranking data in Firebase
        const updateUserRankingData = async () => {
            if (!currentUser) return;
            
            try {
                // Calculate stats
                const totalCards = cardCollection.reduce((sum, card) => sum + (card.data['ÊûöÊï∞'] || 0), 0);
                const uniqueCards = cardCollection.length;
                const currentStreak = gamificationData.registrationStreak?.count || 0;
                const totalPoints = gamificationData.profile?.totalPointsEarned || 0;
                
                // If user has no cards and no meaningful data, don't save to rankings
                if (totalCards === 0 && uniqueCards === 0 && currentStreak === 0 && totalPoints === 0) {
                    // Optionally delete existing ranking data if all values are 0
                    try {
                        const rankingRef = doc(db, 'rankings', currentUser.uid);
                        await deleteDoc(rankingRef);
                    } catch (error) {
                        // Ignore error if document doesn't exist
                    }
                    return;
                }
                
                // Prepare ranking data
                const rankingData = {
                    uid: currentUser.uid,
                    nickname: gamificationData.profile?.nickname || '',
                    icon: gamificationData.profile?.icon || 'üë§',
                    totalCards: totalCards,
                    uniqueCards: uniqueCards,
                    currentStreak: currentStreak,
                    totalPoints: totalPoints,
                    lastUpdated: new Date().toISOString()
                };
                
                // Save to rankings collection
                const rankingRef = doc(db, 'rankings', currentUser.uid);
                await setDoc(rankingRef, rankingData);
            } catch (error) {
                console.error('Error updating ranking data:', error);
            }
        };
        
        // Load and display rankings
        const loadRankings = async () => {
            try {
                const rankingsSnapshot = await getDocs(collection(db, 'rankings'));
                const rankings = [];
                
                rankingsSnapshot.forEach(doc => {
                    rankings.push(doc.data());
                });
                
                // Sort rankings for each category (filter out users with 0 for relevant categories)
                const totalCardsRanking = [...rankings]
                    .filter(user => user.totalCards > 0)
                    .sort((a, b) => b.totalCards - a.totalCards)
                    .slice(0, 50);
                const uniqueCardsRanking = [...rankings]
                    .filter(user => user.uniqueCards > 0)
                    .sort((a, b) => b.uniqueCards - a.uniqueCards)
                    .slice(0, 50);
                const streakRanking = [...rankings]
                    .filter(user => user.currentStreak > 0)
                    .sort((a, b) => b.currentStreak - a.currentStreak)
                    .slice(0, 50);
                const pointsRanking = [...rankings]
                    .filter(user => user.totalPoints > 0)
                    .sort((a, b) => b.totalPoints - a.totalPoints)
                    .slice(0, 50);
                
                // Display rankings
                displayRanking('total-cards-ranking-list', totalCardsRanking, 'totalCards', 'Êûö');
                displayRanking('unique-cards-ranking-list', uniqueCardsRanking, 'uniqueCards', 'Á®ÆÈ°û');
                displayRanking('streak-ranking-list', streakRanking, 'currentStreak', 'Êó•');
                displayRanking('points-ranking-list', pointsRanking, 'totalPoints', 'pt');
            } catch (error) {
                console.error('Error loading rankings:', error);
                document.querySelectorAll('[id$="-ranking-list"]').forEach(list => {
                    list.innerHTML = '<div class="alert alert-danger">„É©„É≥„Ç≠„É≥„Ç∞„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>';
                });
            }
        };
        
        // Display ranking list
        const displayRanking = (listId, rankings, valueKey, unit) => {
            const listElement = document.getElementById(listId);
            
            if (rankings.length === 0) {
                listElement.innerHTML = '<div class="alert alert-warning">„Åæ„Å†„É©„É≥„Ç≠„É≥„Ç∞„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }
            
            listElement.innerHTML = rankings.map((user, index) => {
                const rank = index + 1;
                const isCurrentUser = user.uid === currentUser?.uid;
                const displayName = user.nickname || 'ÂåøÂêç„É¶„Éº„Ç∂„Éº';
                const icon = user.icon || 'üë§';
                
                // Determine medal for top 3
                let medal = '';
                if (rank === 1) medal = 'ü•á';
                else if (rank === 2) medal = 'ü•à';
                else if (rank === 3) medal = 'ü•â';
                
                return `
                    <div class="list-group-item ${isCurrentUser ? 'bg-light border-primary' : ''}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <span class="me-3 fw-bold ${rank <= 3 ? 'fs-4' : ''}" style="min-width: 40px;">
                                    ${medal || rank + '.'}
                                </span>
                                <span class="fs-4 me-2">${icon}</span>
                                <div>
                                    <div class="fw-semibold ${isCurrentUser ? 'text-primary' : ''}">
                                        ${displayName}
                                        ${isCurrentUser ? ' („ÅÇ„Å™„Åü)' : ''}
                                    </div>
                                    <small class="text-muted">
                                        ÊúÄÁµÇÊõ¥Êñ∞: ${formatRelativeTime(user.lastUpdated)}
                                    </small>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="fs-5 fw-bold ${rank <= 3 ? 'text-warning' : ''}">
                                    ${user[valueKey].toLocaleString()} ${unit}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        };
        
        // Format relative time
        const formatRelativeTime = (dateString) => {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (minutes < 60) return `${minutes}ÂàÜÂâç`;
            if (hours < 24) return `${hours}ÊôÇÈñìÂâç`;
            if (days < 7) return `${days}Êó•Ââç`;
            return date.toLocaleDateString('ja-JP');
        };
        
        // Update profile display
        const updateProfileDisplay = () => {
            const profile = gamificationData.profile || {};
            
            // Basic info
            document.getElementById('profile-icon').textContent = profile.icon || 'üë§';
            document.getElementById('profile-nickname').textContent = profile.nickname || 'Êú™Ë®≠ÂÆö';
            document.getElementById('profile-user-id').textContent = currentUser?.email || '';
            
            // Usage stats
            const totalDays = profile.usageDays ? (profile.usageDays instanceof Set ? profile.usageDays.size : profile.usageDays.length) : 0;
            document.getElementById('profile-total-days').textContent = `${totalDays}Êó•`;
            
            // Format dates
            const formatDate = (dateStr) => {
                if (!dateStr) return '-';
                const date = new Date(dateStr);
                return `${date.getFullYear()}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
            };
            
            document.getElementById('profile-first-use').textContent = formatDate(profile.firstUseDate);
            document.getElementById('profile-last-use').textContent = formatDate(profile.lastUseDate);
            
            // Collection stats
            document.getElementById('profile-total-cards').textContent = `${cardCollection.reduce((sum, card) => sum + (card.data['ÊûöÊï∞'] || 0), 0)}Êûö`;
            
            // Streak info
            document.getElementById('profile-streak').textContent = `${gamificationData.registrationStreak?.count || 0}Êó•`;
            document.getElementById('profile-max-streak').textContent = `${profile.maxStreak || 0}Êó•`;
            
            // Points
            document.getElementById('profile-total-points').textContent = `${profile.totalPointsEarned || 0}pt`;
        };

        const handleUserLogout = () => {
            currentUser = null;
            mainApp.style.display = 'none';
            appLoader.style.display = 'none';
            authModal.show();
            cardCollection = [];
            wishlistCollection = [];
            renderTable([]);
            document.getElementById('delete-account-btn').style.display = 'block';
        };

        // „É°„Éº„É´Ë™çË®º„É™„É≥„ÇØ„ÅÆURL„Éë„É©„É°„Éº„Çø„ÇíÂá¶ÁêÜ
        const handleEmailVerificationLink = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            const oobCode = urlParams.get('oobCode');

            // „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„Çí„Ç≥„É≥„ÇΩ„Éº„É´„Å´Âá∫Âäõ
            console.log('=== „É°„Éº„É´Ë™çË®º„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†± ===');
            console.log('Current URL:', window.location.href);
            console.log('URL Parameters:', {
                mode: mode,
                oobCode: oobCode,
                allParams: Array.from(urlParams.entries())
            });

            if (mode === 'verifyEmail' && oobCode) {
                try {
                    console.log('Ë™çË®º„Ç≥„Éº„ÉâÊ§úË®º‰∏≠:', oobCode);
                    await applyActionCode(auth, oobCode);
                    alert('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅåÁ¢∫Ë™ç„Åï„Çå„Åæ„Åó„ÅüÔºÅ\n„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    // URL„Éë„É©„É°„Éº„Çø„Çí„ÇØ„É™„Ç¢
                    window.history.replaceState({}, document.title, window.location.pathname);
                } catch (error) {
                    console.error('„É°„Éº„É´Á¢∫Ë™ç„Ç®„É©„Éº„ÅÆË©≥Á¥∞:', {
                        code: error.code,
                        message: error.message,
                        fullError: error
                    });

                    let errorMessage = '';

                    if (error.code === 'auth/invalid-action-code') {
                        errorMessage = `Ë™çË®º„É™„É≥„ÇØ„ÅåÁÑ°Âäπ„Åß„Åô„ÄÇ

ËÄÉ„Åà„Çâ„Çå„ÇãÂéüÂõ†„Å®ÂØæÁ≠ñ:

1. „É™„É≥„ÇØ„ÅÆÊúâÂäπÊúüÈôêÂàá„ÇåÔºà24ÊôÇÈñì‰ª•ÂÜÖÔºâ
   ‚Üí Êñ∞„Åó„ÅÑÁ¢∫Ë™ç„É°„Éº„É´„Çí„É™„ÇØ„Ç®„Çπ„Éà„Åó„Å¶„Åè„Å†„Åï„ÅÑ

2. „Åô„Åß„Å´‰ΩøÁî®Ê∏à„Åø„ÅÆ„É™„É≥„ÇØ
   ‚Üí „É≠„Ç∞„Ç§„É≥„Åó„Å¶Ë™çË®ºÁä∂ÊÖã„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ

3. URL„Åå‰∏çÂÆåÂÖ®
   ‚Üí „É°„Éº„É´ÂÜÖ„ÅÆ„É™„É≥„ÇØ„ÇíÊúÄÂàù„Åã„ÇâÊúÄÂæå„Åæ„ÅßÂÆåÂÖ®„Å´„Ç≥„Éî„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ

4. „É≠„Éº„Ç´„É´„Éï„Ç°„Ç§„É´„ÅßÈñã„ÅÑ„Å¶„ÅÑ„ÇãÔºàfile://Ôºâ
   ‚Üí Web„Çµ„Éº„Éê„ÉºÁµåÁî±„Åß„Ç¢„ÇØ„Çª„Çπ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö
     python -m http.server 8000
     http://localhost:8000/card_list.html

5. FirebaseË®≠ÂÆö„ÅÆÂïèÈ°å
   ‚Üí „Ç≥„É≥„ÇΩ„Éº„É´„ÅßË©≥Á¥∞„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ`;
                    } else if (error.code === 'auth/expired-action-code') {
                        errorMessage = '„É™„É≥„ÇØ„ÅÆÊúâÂäπÊúüÈôêÔºà24ÊôÇÈñìÔºâ„ÅåÂàá„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ\nÊñ∞„Åó„ÅÑÁ¢∫Ë™ç„É°„Éº„É´„Çí„É™„ÇØ„Ç®„Çπ„Éà„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                    } else if (error.code === 'auth/user-disabled') {
                        errorMessage = '„Åì„ÅÆ„Ç¢„Ç´„Ç¶„É≥„Éà„ÅØÁÑ°ÂäπÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ';
                    } else if (error.code === 'auth/user-not-found') {
                        errorMessage = '„É¶„Éº„Ç∂„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇÂÖà„Å´„Ç¢„Ç´„Ç¶„É≥„Éà„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                    } else {
                        errorMessage = `„É°„Éº„É´Á¢∫Ë™ç„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ

„Ç®„É©„ÉºË©≥Á¥∞: ${error.message}
„Ç®„É©„Éº„Ç≥„Éº„Éâ: ${error.code}

Firebase Console„ÅßÁ¢∫Ë™ç„Åô„Åπ„ÅçÈ†ÖÁõÆ:
- Authentication > Settings > Authorized domains
- „É°„Éº„É´„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥URLË®≠ÂÆö`;
                    }

                    alert(errorMessage);
                }
            } else if (mode || oobCode) {
                console.warn('‰∏çÂÆåÂÖ®„Å™URL„Éë„É©„É°„Éº„Çø:', { mode, oobCode });
                if (!mode) console.warn('mode„Éë„É©„É°„Éº„Çø„ÅåÊ¨†ËêΩ„Åó„Å¶„ÅÑ„Åæ„Åô');
                if (!oobCode) console.warn('oobCode„Éë„É©„É°„Éº„Çø„ÅåÊ¨†ËêΩ„Åó„Å¶„ÅÑ„Åæ„Åô');
            }
        };

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´„É°„Éº„É´Ë™çË®º„É™„É≥„ÇØ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        handleEmailVerificationLink();

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // „É¶„Éº„Ç∂„Éº„Åå„É≠„Ç∞„Ç§„É≥„Åó„Åü„Çâ„ÄÅÊúÄÊñ∞„ÅÆË™çË®ºÁä∂ÊÖã„ÇíÂèñÂæó
                await user.reload();
                handleUserLogin(user);
            } else {
                handleUserLogout();
            }
        });

        // Fix mobile advanced search toggle
        setTimeout(() => {
            const advancedSearchBtn = document.getElementById('advanced-search-btn');
            const advancedSearchPanel = document.getElementById('advanced-search');

            if (advancedSearchBtn && advancedSearchPanel) {
                // Remove bootstrap collapse behavior and add manual toggle
                advancedSearchBtn.removeAttribute('data-bs-toggle');
                advancedSearchBtn.removeAttribute('data-bs-target');

                advancedSearchBtn.addEventListener('click', () => {
                    if (advancedSearchPanel.classList.contains('show')) {
                        advancedSearchPanel.classList.remove('show');
                        advancedSearchBtn.setAttribute('aria-expanded', 'false');
                    } else {
                        advancedSearchPanel.classList.add('show');
                        advancedSearchBtn.setAttribute('aria-expanded', 'true');
                    }
                });
            }
        }, 100);

        const updateBulkEditControls = () => {
            const bulkEditControls = document.getElementById('bulk-edit-controls');
            const selectedCount = document.getElementById('selected-count');
            
            if (selectedCardIds.size > 0) {
                bulkEditControls.style.display = 'block';
                selectedCount.textContent = `${selectedCardIds.size}‰ª∂ÈÅ∏Êäû`;
            } else {
                bulkEditControls.style.display = 'none';
            }
        };
        
        const handleBulkTagOperation = (operation) => {
            if (selectedCardIds.size === 0) {
                alert('„Ç´„Éº„Éâ„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
                return;
            }
            
            const modalTitle = document.getElementById('bulk-tag-modal-title');
            const modalDesc = document.getElementById('bulk-tag-modal-desc');
            const container = document.getElementById('bulk-tag-choices-container');
            
            modalTitle.textContent = operation === 'add' ? '„Çø„Ç∞„ÇíËøΩÂä†' : '„Çø„Ç∞„ÇíÂâäÈô§';
            modalDesc.textContent = `${selectedCardIds.size}Êûö„ÅÆ„Ç´„Éº„Éâ„Å´ÂØæ„Åó„Å¶${operation === 'add' ? 'ËøΩÂä†' : 'ÂâäÈô§'}„Åô„Çã„Çø„Ç∞„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;
            
            container.innerHTML = '';
            const selectedTags = new Set();
            
            allTags.forEach(tag => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn btn-outline-secondary btn-sm me-1 mb-1';
                btn.textContent = tag.name;
                btn.onclick = () => {
                    if (selectedTags.has(tag.name)) {
                        selectedTags.delete(tag.name);
                        btn.classList.remove('btn-primary');
                        btn.classList.add('btn-outline-secondary');
                    } else {
                        selectedTags.add(tag.name);
                        btn.classList.remove('btn-outline-secondary');
                        btn.classList.add('btn-primary');
                    }
                };
                container.appendChild(btn);
            });
            
            document.getElementById('bulk-tag-save-btn').onclick = async () => {
                if (selectedTags.size === 0) {
                    alert('„Çø„Ç∞„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
                    return;
                }
                
                showLoading(true);
                try {
                    for (const cardId of selectedCardIds) {
                        const collection = getCurrentCollection();
                        const card = collection.find(c => c.id === cardId);
                        if (!card) continue;
                        
                        let updatedTags = [...(card.data.tags || [])];
                        
                        if (operation === 'add') {
                            selectedTags.forEach(tag => {
                                if (!updatedTags.includes(tag)) {
                                    updatedTags.push(tag);
                                }
                            });
                        } else {
                            updatedTags = updatedTags.filter(tag => !selectedTags.has(tag));
                        }
                        
                        const collRef = getCollectionRef(currentListType);
                        if (collRef) {
                            await updateDoc(doc(collRef, cardId), { tags: updatedTags });
                        }
                        card.data.tags = updatedTags;
                    }
                    
                    bulkTagModal.hide();
                    selectedCardIds.clear();
                    updateBulkEditControls();
                    renderTable();
                    alert(`${selectedCardIds.size}Êûö„ÅÆ„Ç´„Éº„Éâ„ÅÆ„Çø„Ç∞„Çí${operation === 'add' ? 'ËøΩÂä†' : 'ÂâäÈô§'}„Åó„Åæ„Åó„Åü„ÄÇ`);
                } catch (error) {
                    alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
                } finally {
                    showLoading(false);
                }
            };
            
            bulkTagModal.show();
        };
        
        document.getElementById('tag-management-btn').addEventListener('click', () => tagManagementModal.show());
        
        document.getElementById('select-all-checkbox').addEventListener('change', (e) => {
            const checkboxes = document.querySelectorAll('.card-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = e.target.checked;
                const cardId = checkbox.dataset.id;
                if (e.target.checked) {
                    selectedCardIds.add(cardId);
                } else {
                    selectedCardIds.delete(cardId);
                }
            });
            updateBulkEditControls();
        });
        
        document.addEventListener('change', (e) => {
            if (e.target.classList.contains('card-checkbox')) {
                const cardId = e.target.dataset.id;
                if (e.target.checked) {
                    selectedCardIds.add(cardId);
                } else {
                    selectedCardIds.delete(cardId);
                }
                updateBulkEditControls();
                
                const allCheckboxes = document.querySelectorAll('.card-checkbox');
                const checkedBoxes = document.querySelectorAll('.card-checkbox:checked');
                const selectAllCheckbox = document.getElementById('select-all-checkbox');
                selectAllCheckbox.checked = allCheckboxes.length > 0 && allCheckboxes.length === checkedBoxes.length;
            }
        });
        
        document.getElementById('bulk-add-tags-btn').addEventListener('click', () => handleBulkTagOperation('add'));
        document.getElementById('bulk-remove-tags-btn').addEventListener('click', () => handleBulkTagOperation('remove'));
        
        document.getElementById('bulk-delete-btn').addEventListener('click', async () => {
            if (selectedCardIds.size === 0) {
                alert('„Ç´„Éº„Éâ„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
                return;
            }
            
            const listName = currentListType === 'collection' ? 'ÊâÄÊåÅ„Ç´„Éº„Éâ' : '„Ç¶„Ç£„ÉÉ„Ç∑„É•„É™„Çπ„Éà';
            if (!confirm(`${selectedCardIds.size}Êûö„ÅÆ„Ç´„Éº„Éâ„Çí${listName}„Åã„ÇâÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ`)) {
                return;
            }
            
            showLoading(true);
            try {
                const collRef = getCollectionRef(currentListType);
                const collection = getCurrentCollection();
                
                for (const cardId of selectedCardIds) {
                    if (collRef) {
                        await deleteDoc(doc(collRef, cardId));
                    }
                    const index = collection.findIndex(c => c.id === cardId);
                    if (index > -1) {
                        collection.splice(index, 1);
                    }
                }
                
                selectedCardIds.clear();
                updateBulkEditControls();
                updateTotalCounts(); // Update stats after bulk deletion
                applySearchAndFilter();
                alert(`${selectedCardIds.size}Êûö„ÅÆ„Ç´„Éº„Éâ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ`);
            } catch (error) {
                alert('ÂâäÈô§‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
            } finally {
                showLoading(false);
            }
        });
        
        document.getElementById('clear-selection-btn').addEventListener('click', () => {
            selectedCardIds.clear();
            document.querySelectorAll('.card-checkbox').forEach(checkbox => checkbox.checked = false);
            document.getElementById('select-all-checkbox').checked = false;
            updateBulkEditControls();
        });
        
        document.getElementById('collection-tab').addEventListener('click', (e) => {
            e.preventDefault();
            currentListType = 'collection';
            document.getElementById('collection-tab').classList.add('active');
            document.getElementById('wishlist-tab').classList.remove('active');
            applySearchAndFilter();
        });
        
        document.getElementById('wishlist-tab').addEventListener('click', (e) => {
            e.preventDefault();
            currentListType = 'wishlist';
            document.getElementById('wishlist-tab').classList.add('active');
            document.getElementById('collection-tab').classList.remove('active');
            applySearchAndFilter();
        });
        
        document.getElementById('login-btn').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (email === 'local') {
                currentUser = { uid: 'local_user', email: 'local@example.com' };
                handleUserLogin(currentUser);
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                authError.style.display = 'none';
            } catch (error) { authError.textContent = `„É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº: ${error.message}`; authError.style.display = 'block'; }
        });

        document.getElementById('signup-btn').addEventListener('click', async () => {
            try {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);

                // „É°„Éº„É´Á¢∫Ë™ç„ÇíÈÄÅ‰ø°
                await sendEmailVerification(userCredential.user);

                authError.style.display = 'none';
                alert('Á¢∫Ë™ç„É°„Éº„É´„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„ÅüÔºÅ\n\n„ÄêÈáçË¶Å„Äë\n‚úÖ „É°„Éº„É´„ÅåÂ±ä„Åã„Å™„ÅÑÂ†¥ÂêàÔºö\n„ÉªËø∑ÊÉë„É°„Éº„É´„Éï„Ç©„É´„ÉÄ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ\n„Éª„Éó„É≠„É¢„Éº„Ç∑„Éß„É≥„Éï„Ç©„É´„ÉÄ„ÇÇÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ\n„ÉªÈÄÅ‰ø°ÂÖÉ: noreply@ygoh-9bcf6.firebaseapp.com\n\n‚ö†Ô∏è „É™„É≥„ÇØ„ÅåÁÑ°Âäπ„ÅÆÂ†¥ÂêàÔºö\n„Éª„É°„Éº„É´„ÅåÂè§„ÅÑÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô\n„Éª„ÄåÁ¢∫Ë™ç„É°„Éº„É´„ÇíÂÜçÈÄÅ‰ø°„Äç„Éú„Çø„É≥„Çí‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            } catch (error) {
                authError.textContent = `Êñ∞Ë¶èÁôªÈå≤„Ç®„É©„Éº: ${error.message}`;
                authError.style.display = 'block';
            }
        });

        logoutBtn.addEventListener('click', () => {
            if (currentUser && currentUser.uid === 'local_user') {
                window.location.reload();
            } else {
                signOut(auth);
            }
        });

        addForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading(true);
            
            try {
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Operation timeout')), 30000); // 30 seconds timeout
                });
                
                const formData = new FormData(addForm);
                const addType = document.querySelector('input[name="add-type"]:checked').value;
                const newCard = {
                    'ÂêçÂâç': formData.get('name'),
                    'ÂûãÁï™': formData.get('set_code'),
                    '„É¨„Ç¢„É™„ÉÜ„Ç£': formData.get('rarity'),
                    'ÊûöÊï∞': parseInt(formData.get('quantity'), 10),
                    'tags': [...currentCardTags] // „Çø„Ç∞„ÇíËøΩÂä†
                };
            
            const setChoices = [];
            document.querySelectorAll('#set-rarity-choices .set-choice-btn').forEach(btn => {
                setChoices.push({
                    setCode: btn.dataset.setCode,
                    rarity: btn.dataset.rarity,
                    text: btn.textContent
                });
            });
            
            lastRegistrationData = {
                name: newCard['ÂêçÂâç'],
                setCode: newCard['ÂûãÁï™'],
                rarity: newCard['„É¨„Ç¢„É™„ÉÜ„Ç£'],
                quantity: newCard['ÊûöÊï∞'],
                tags: [...currentCardTags],
                addType: addType,
                setChoices: setChoices
            };
            updateRegistrationHistoryButton();

                const targetCollection = addType === 'collection' ? cardCollection : wishlistCollection;
                const collRef = getCollectionRef(addType);
                
                const dbOperation = async () => {
                    if (collRef) { // Firebase„É¢„Éº„Éâ
                        const constraints = [where("ÂêçÂâç", "==", newCard.ÂêçÂâç)];
                        if (newCard.ÂûãÁï™) {
                            constraints.push(where("ÂûãÁï™", "==", newCard.ÂûãÁï™));
                        }
                        if (newCard.„É¨„Ç¢„É™„ÉÜ„Ç£) {
                            constraints.push(where("„É¨„Ç¢„É™„ÉÜ„Ç£", "==", newCard.„É¨„Ç¢„É™„ÉÜ„Ç£));
                        }
                        const q = query(collRef, ...constraints);
                        const existingDocs = await getDocs(q);

                        // „Çø„Ç∞„ÇÇÂê´„ÇÅ„Å¶ÂÆåÂÖ®‰∏ÄËá¥„Åô„Çã„Ç´„Éº„Éâ„ÇíÊé¢„Åô
                        let exactMatch = null;
                        for (const doc of existingDocs.docs) {
                            const docData = doc.data();
                            const docTags = docData.tags || [];
                            const newCardTags = newCard.tags || [];
                            if (docTags.length === newCardTags.length &&
                                docTags.every(tag => newCardTags.includes(tag))) {
                                exactMatch = doc;
                                break;
                            }
                        }

                        if (!exactMatch) {
                            const docRef = await addDoc(collRef, newCard);
                            targetCollection.push({ id: docRef.id, data: newCard });
                            // Track card addition date
                            if (currentListType === 'collection') {
                                gamificationData.cardAdditionDates[docRef.id] = new Date().toISOString();
                                saveGamificationData();
                            }
                        } else {
                            await updateDoc(exactMatch.ref, { ÊûöÊï∞: increment(newCard.ÊûöÊï∞) });
                            const localCard = targetCollection.find(c => c.id === exactMatch.id);
                            if(localCard) localCard.data.ÊûöÊï∞ += newCard.ÊûöÊï∞;
                        }
                    } else { // „É≠„Éº„Ç´„É´„É¢„Éº„Éâ
                        const existingCard = targetCollection.find(c => {
                            if (c.data.ÂêçÂâç !== newCard.ÂêçÂâç) return false;
                            if (newCard.ÂûãÁï™ && c.data.ÂûãÁï™ !== newCard.ÂûãÁï™) return false;
                            if (newCard.„É¨„Ç¢„É™„ÉÜ„Ç£ && c.data.„É¨„Ç¢„É™„ÉÜ„Ç£ !== newCard.„É¨„Ç¢„É™„ÉÜ„Ç£) return false;
                            // „Çø„Ç∞„ÅåÁï∞„Å™„ÇãÂ†¥Âêà„ÅØÂà•„Ç´„Éº„Éâ„Å®„Åó„Å¶Êâ±„ÅÜ
                            const cardTags = c.data.tags || [];
                            const newCardTags = newCard.tags || [];
                            if (cardTags.length !== newCardTags.length) return false;
                            if (!cardTags.every(tag => newCardTags.includes(tag))) return false;
                            return true;
                        });
                        if (existingCard) {
                            existingCard.data.ÊûöÊï∞ += newCard.ÊûöÊï∞;
                        } else {
                            const localId = `local_${Date.now()}`;
                            targetCollection.push({ id: localId, data: newCard });
                            // Track card addition date for local mode
                            if (currentListType === 'collection') {
                                gamificationData.cardAdditionDates[localId] = new Date().toISOString();
                                saveGamificationData();
                            }
                        }
                    }
                };
                
                // Execute with timeout
                await Promise.race([dbOperation(), timeoutPromise]);
            
                // Track card addition for fun dashboard
                const hasTag = currentCardTags.length > 0;
                const isRare = newCard['„É¨„Ç¢„É™„ÉÜ„Ç£'] && (
                    newCard['„É¨„Ç¢„É™„ÉÜ„Ç£'].toLowerCase().includes('„É¨„Ç¢') ||
                    newCard['„É¨„Ç¢„É™„ÉÜ„Ç£'].toLowerCase().includes('rare') ||
                    newCard['„É¨„Ç¢„É™„ÉÜ„Ç£'].toUpperCase().includes('SR') ||
                    newCard['„É¨„Ç¢„É™„ÉÜ„Ç£'].toUpperCase().includes('UR')
                );
                trackCardAddition(newCard, hasTag, isRare);

                // Save to recent cards history
                let recentHistory = [];
                try {
                    const existingHistory = localStorage.getItem('recentCardsHistory');
                    if (existingHistory) {
                        recentHistory = JSON.parse(existingHistory);
                    }
                } catch(e) {
                    recentHistory = [];
                }

                // Add new card to history
                recentHistory.unshift({
                    name: newCard['ÂêçÂâç'],
                    setCode: newCard['ÂûãÁï™'],
                    rarity: newCard['„É¨„Ç¢„É™„ÉÜ„Ç£'],
                    quantity: newCard['ÊûöÊï∞'],
                    listType: addType,
                    timestamp: new Date().toISOString()
                });

                // Keep only the latest 100 entries
                recentHistory = recentHistory.slice(0, 100);
                localStorage.setItem('recentCardsHistory', JSON.stringify(recentHistory));

                // Add points for card addition (5 points per card)
                const cardQuantity = newCard.ÊûöÊï∞ || 1;
                const pointsToAdd = cardQuantity * 5;
                if (isRare) {
                    addPoints(pointsToAdd + (cardQuantity * 5), `„É¨„Ç¢„Ç´„Éº„Éâ ${cardQuantity}ÊûöËøΩÂä†`); // Bonus for rare
                } else {
                    addPoints(pointsToAdd, `„Ç´„Éº„Éâ ${cardQuantity}ÊûöËøΩÂä†`);
                }

                updateTotalCounts(); // Update stats after adding card
                applySearchAndFilter();
                addForm.reset();
                currentCardTags = [];
                renderTagChoices('tag-choices-container', currentCardTags);
                renderSelectedTags('card-tags-container', currentCardTags);
                document.getElementById('set-rarity-choices').innerHTML = '';
                showLoading(false);
                
            } catch (error) {
                showLoading(false);
                
                // Check error type
                if (error.message === 'Operation timeout') {
                    alert('Êìç‰Ωú„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü„ÄÇ„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                } else if (error.code === 'permission-denied' || error.code === 'unauthenticated') {
                    alert('„Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆÊúâÂäπÊúüÈôê„ÅåÂàá„Çå„Åæ„Åó„Åü„ÄÇÂÜçÂ∫¶„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    // Force re-authentication
                    if (currentUser && currentUser.uid !== 'local_user') {
                        signOut(auth);
                    } else {
                        window.location.reload();
                    }
                } else {
                    alert(`„Ç´„Éº„Éâ„ÅÆËøΩÂä†‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${error.message || 'Unknown error'}`);
                }
            }
        });

        cardTableBody.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            if (target.classList.contains('delete-btn')) {
                const cardId = target.dataset.id;
                const cardName = target.closest('tr').querySelector('td').textContent;
                const listName = currentListType === 'collection' ? 'ÊâÄÊåÅ„Ç´„Éº„Éâ' : '„Ç¶„Ç£„ÉÉ„Ç∑„É•„É™„Çπ„Éà';
                if (confirm(`„Äå${cardName}„Äç„Çí${listName}„Åã„ÇâÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                    const collRef = getCollectionRef(currentListType);
                    if (collRef) { // Firebase„É¢„Éº„Éâ
                        deleteDoc(doc(collRef, cardId));
                    }
                    if (currentListType === 'collection') {
                        cardCollection = cardCollection.filter(c => c.id !== cardId);
                    } else {
                        wishlistCollection = wishlistCollection.filter(c => c.id !== cardId);
                    }
                    updateTotalCounts(); // Update stats after deletion
                    applySearchAndFilter();
                }
            } else if (target.classList.contains('edit-btn')) {
                const cardId = target.dataset.id;
                const currentData = getCurrentCollection();
                const card = currentData.find(c => c.id === cardId);
                if (card) {
                    document.getElementById('edit-card-id').value = card.id;
                    document.getElementById('edit-name').value = card.data.ÂêçÂâç;
                    document.getElementById('edit-set-code').value = card.data.ÂûãÁï™;
                    document.getElementById('edit-rarity').value = card.data.„É¨„Ç¢„É™„ÉÜ„Ç£;
                    document.getElementById('edit-quantity').value = card.data.ÊûöÊï∞;
                    
                    currentCardTags = [...(card.data.tags || [])]; // Êó¢Â≠ò„Çø„Ç∞„Çí„Çª„ÉÉ„Éà
                    renderTagChoices('edit-tag-choices-container', currentCardTags);
                    renderSelectedTags('edit-card-tags-container', currentCardTags);

                    // Update quantity input mode for edit modal
                    updateQuantityInputMode();

                    editCardModal.show();
                }
            } else if (target.classList.contains('move-to-collection-btn')) {
                const cardId = target.dataset.id;
                const card = wishlistCollection.find(c => c.id === cardId);
                if (card && confirm(`„Äå${card.data.ÂêçÂâç}„Äç„ÇíÊâÄÊåÅ„Ç´„Éº„Éâ„Å´ÁßªÂãï„Åó„Åæ„Åô„ÅãÔºü`)) {
                    // Move from wishlist to collection
                    const wishlistRef = getCollectionRef('wishlist');
                    const collectionRef = getCollectionRef('collection');
                    
                    if (collectionRef && wishlistRef) {
                        // Add to collection
                        const docRef = await addDoc(collectionRef, card.data);
                        cardCollection.push({ id: docRef.id, data: card.data });
                        // Track card addition date
                        gamificationData.cardAdditionDates[docRef.id] = new Date().toISOString();
                        saveGamificationData();
                        
                        // Remove from wishlist
                        await deleteDoc(doc(wishlistRef, cardId));
                        wishlistCollection = wishlistCollection.filter(c => c.id !== cardId);
                    } else {
                        // Local mode
                        const newId = `local_${Date.now()}`;
                        cardCollection.push({ id: newId, data: card.data });
                        wishlistCollection = wishlistCollection.filter(c => c.id !== cardId);
                        // Track card addition date
                        gamificationData.cardAdditionDates[newId] = new Date().toISOString();
                        saveGamificationData();
                    }
                    
                    // Add points for moving card from wishlist to collection
                    const cardQuantity = card.data.ÊûöÊï∞ || 1;
                    const pointsToAdd = cardQuantity * 5;
                    addPoints(pointsToAdd, `„Ç¶„Ç£„ÉÉ„Ç∑„É•„É™„Çπ„Éà„Åã„Çâ ${cardQuantity}ÊûöËøΩÂä†`);
                    
                    // Track for daily missions
                    const isRare = card.data.„É¨„Ç¢„É™„ÉÜ„Ç£ && (
                        card.data.„É¨„Ç¢„É™„ÉÜ„Ç£.toLowerCase().includes('„É¨„Ç¢') ||
                        card.data.„É¨„Ç¢„É™„ÉÜ„Ç£.toLowerCase().includes('rare') ||
                        card.data.„É¨„Ç¢„É™„ÉÜ„Ç£.toUpperCase().includes('SR') ||
                        card.data.„É¨„Ç¢„É™„ÉÜ„Ç£.toUpperCase().includes('UR')
                    );
                    trackCardAddition(card.data, false, isRare);
                    
                    updateTotalCounts(); // Update stats after moving card
                    applySearchAndFilter();
                }
            }
        });

        document.getElementById('save-edit-btn').addEventListener('click', async () => {
            const cardId = document.getElementById('edit-card-id').value;
            const updatedData = {
                ÊûöÊï∞: parseInt(document.getElementById('edit-quantity').value, 10),
                tags: [...currentCardTags]
            };

            const collRef = getCollectionRef(currentListType);
            if (collRef) { // Firebase„É¢„Éº„Éâ
                await updateDoc(doc(collRef, cardId), updatedData);
            }

            const targetCollection = currentListType === 'collection' ? cardCollection : wishlistCollection;
            const localCard = targetCollection.find(c => c.id === cardId);
            if(localCard) {
                localCard.data.ÊûöÊï∞ = updatedData.ÊûöÊï∞;
                localCard.data.tags = updatedData.tags;
            }
            updateTotalCounts(); // Update stats after editing
            applySearchAndFilter();
            editCardModal.hide();
        });

        // Handle card type selection with tabs
        const mainTypeTabs = document.querySelectorAll('.main-type-tab');
        const subTypeGroups = document.querySelectorAll('.sub-type-group');
        const subTypeButtons = document.querySelectorAll('.sub-type-btn');

        // Handle main category tab clicks
        mainTypeTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                // Update active tab
                mainTypeTabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                // Show/hide sub-type groups
                const category = this.dataset.category;
                subTypeGroups.forEach(group => {
                    if (group.dataset.category === category) {
                        group.style.display = 'block';
                    } else {
                        group.style.display = 'none';
                    }
                });

                // Reset sub-type selections for this category
                if (category === 'all') {
                    // Clear all sub-type selections
                    subTypeButtons.forEach(btn => btn.classList.remove('active'));
                } else if (category === 'monster') {
                    // Activate "all-monster" by default
                    subTypeButtons.forEach(btn => {
                        if (btn.dataset.type === 'all-monster') {
                            btn.classList.add('active');
                        } else if (btn.parentElement.closest('[data-category="monster"]')) {
                            btn.classList.remove('active');
                        }
                    });
                    // Auto-apply search when monster tab is clicked
                    applySearchAndFilter();
                } else if (category === 'spell') {
                    // Activate spell button
                    subTypeButtons.forEach(btn => {
                        if (btn.dataset.type === 'È≠îÊ≥ï') {
                            btn.classList.add('active');
                        }
                    });
                } else if (category === 'trap') {
                    // Activate trap button
                    subTypeButtons.forEach(btn => {
                        if (btn.dataset.type === 'ÁΩ†') {
                            btn.classList.add('active');
                        }
                    });
                }

                applySearchAndFilter();
            });
        });

        // Handle sub-type button clicks
        subTypeButtons.forEach(button => {
            button.addEventListener('click', function() {
                const type = this.dataset.type;
                const parentGroup = this.closest('.sub-type-group');

                if (type === 'all-monster') {
                    // Clear all monster sub-type selections
                    parentGroup.querySelectorAll('.sub-type-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                } else if (parentGroup.dataset.category === 'monster') {
                    // Toggle selection for monster sub-types
                    const allMonsterBtn = parentGroup.querySelector('[data-type="all-monster"]');
                    allMonsterBtn.classList.remove('active');

                    this.classList.toggle('active');

                    // If no sub-types selected, activate "all-monster"
                    const activeButtons = parentGroup.querySelectorAll('.sub-type-btn.active');
                    if (activeButtons.length === 0) {
                        allMonsterBtn.classList.add('active');
                    }
                }

                applySearchAndFilter();
            });
        });

        // Handle race selection
        const raceButtons = document.querySelectorAll('.race-btn');
        const clearRaceBtn = document.querySelector('.clear-race-btn');

        // Handle race button clicks
        raceButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Toggle selection
                this.classList.toggle('active');
                applySearchAndFilter();
            });
        });

        // Handle clear all races button
        if (clearRaceBtn) {
            clearRaceBtn.addEventListener('click', function() {
                raceButtons.forEach(btn => btn.classList.remove('active'));
                applySearchAndFilter();
            });
        }

        // Debounce function for search
        let searchDebounceTimer = null;
        const debounceSearch = (callback, delay = 300) => {
            return function(...args) {
                clearTimeout(searchDebounceTimer);
                searchDebounceTimer = setTimeout(() => callback.apply(this, args), delay);
            };
        };

        // Apply debounced search on input change for mobile optimization
        const searchInputs = searchForm.querySelectorAll('input[type="text"]');
        const debouncedSearch = debounceSearch(() => {
            applySearchAndFilter();
        }, 500); // 500ms delay for mobile typing

        searchInputs.forEach(input => {
            input.addEventListener('input', debouncedSearch);
        });

        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            clearTimeout(searchDebounceTimer); // Cancel pending debounced search
            applySearchAndFilter();
        });

        // Search mode change handlers (AND/OR toggle)
        const searchModeRadios = document.querySelectorAll('input[name="search_mode"]');
        const searchModeDescription = document.getElementById('search-mode-description');

        searchModeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                const mode = e.target.value;
                if (mode === 'and') {
                    searchModeDescription.textContent = '„Åô„Åπ„Å¶„ÅÆÊù°‰ª∂„ÇíÊ∫Ä„Åü„Åô„Ç´„Éº„Éâ„ÇíÊ§úÁ¥¢';
                } else {
                    searchModeDescription.textContent = '„ÅÑ„Åö„Çå„Åã„ÅÆÊù°‰ª∂„ÇíÊ∫Ä„Åü„Åô„Ç´„Éº„Éâ„ÇíÊ§úÁ¥¢';
                }
                // Trigger search when mode changes
                applySearchAndFilter();
            });
        });

        document.getElementById('items-per-page').addEventListener('change', (e) => {
            itemsPerPage = parseInt(e.target.value, 10);
            currentPage = 1; // Ë°®Á§∫‰ª∂Êï∞Â§âÊõ¥ÊôÇ„ÅØ1„Éö„Éº„Ç∏ÁõÆ„Å´Êàª„Çã
            renderTable();
        });

        document.querySelectorAll('th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const key = th.dataset.sort;
                if (sortConfig.key === key) {
                    sortConfig.direction = sortConfig.direction === 'ascending' ? 'descending' : 'ascending';
                } else {
                    sortConfig.key = key;
                    sortConfig.direction = 'ascending';
                }
                renderTable();
            });
        });

        // --- Data Import / Export ---
        const exportAllData = () => {
            return {
                collection: cardCollection.map(c => c.data),
                wishlist: wishlistCollection.map(c => c.data)
            };
        };
        
        const parseCsv = (text) => {
            const lines = text.trim().replace(/\r/g, '').split('\n');
            const header = lines[0].split(',').map(h => h.trim());
            const cards = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                const values = lines[i].split(',');
                const card = {};
                header.forEach((col, index) => {
                    const value = values[index]?.trim() || '';
                    if (col === 'ÊûöÊï∞') {
                        card[col] = parseInt(value, 10) || 1;
                    } else {
                        card[col] = value.replace(/^"|"$/g, '');
                    }
                });
                cards.push(card);
            }
            return cards;
        };

        const handleImport = async (text, format) => {
            let importedData;
            try {
                if (format === 'json') {
                    const parsed = JSON.parse(text);
                    // Check if it's the new format with collection and wishlist
                    if (parsed.collection && parsed.wishlist) {
                        importedData = parsed;
                    } else if (Array.isArray(parsed)) {
                        // Old format - treat as collection only
                        importedData = { collection: parsed, wishlist: [] };
                    } else {
                        throw new Error('Invalid JSON format');
                    }
                } else if (format === 'csv') {
                    const cards = parseCsv(text);
                    // Check if CSV has list type column
                    const hasListType = cards.length > 0 && cards[0].„É™„Çπ„ÉàÁ®ÆÂà•;
                    if (hasListType) {
                        importedData = {
                            collection: cards.filter(c => c.„É™„Çπ„ÉàÁ®ÆÂà• === 'ÊâÄÊåÅ„Ç´„Éº„Éâ'),
                            wishlist: cards.filter(c => c.„É™„Çπ„ÉàÁ®ÆÂà• === '„Ç¶„Ç£„ÉÉ„Ç∑„É•„É™„Çπ„Éà')
                        };
                        // Remove the list type column from the data
                        [...importedData.collection, ...importedData.wishlist].forEach(c => delete c.„É™„Çπ„ÉàÁ®ÆÂà•);
                    } else {
                        // Old format - treat as collection only
                        importedData = { collection: cards, wishlist: [] };
                    }
                }

                const totalCards = importedData.collection.length + importedData.wishlist.length;
                if (!confirm(`„Ç§„É≥„Éù„Éº„ÉàÂÜÖÂÆπ:\nÊâÄÊåÅ„Ç´„Éº„Éâ: ${importedData.collection.length}Êûö\n„Ç¶„Ç£„ÉÉ„Ç∑„É•„É™„Çπ„Éà: ${importedData.wishlist.length}Êûö\nÂêàË®à: ${totalCards}Êûö\n\n„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åô„ÅãÔºü\n(ÈáçË§á„Åô„Çã„Ç´„Éº„Éâ„ÅØÊûöÊï∞„ÅåÂä†ÁÆó„Åï„Çå„Åæ„Åô)`)) return;
                
                showLoading(true);

                // Import collection
                if (importedData.collection.length > 0) {
                    const collRef = getCollectionRef('collection');
                    if (collRef) { // Firebase„É¢„Éº„Éâ
                        const batch = writeBatch(db);
                        for (const card of importedData.collection) {
                            // Parse tags if they're in semicolon format
                            if (card.„Çø„Ç∞ && typeof card.„Çø„Ç∞ === 'string') {
                                card.tags = card.„Çø„Ç∞.split(';').filter(t => t.trim());
                                delete card.„Çø„Ç∞;
                            }
                            const q = query(collRef, where("ÂêçÂâç", "==", card.ÂêçÂâç), where("ÂûãÁï™", "==", card.ÂûãÁï™), where("„É¨„Ç¢„É™„ÉÜ„Ç£", "==", card.„É¨„Ç¢„É™„ÉÜ„Ç£));
                            const existingDocs = await getDocs(q);

                            // „Çø„Ç∞„ÇÇÂê´„ÇÅ„Å¶ÂÆåÂÖ®‰∏ÄËá¥„Åô„Çã„Ç´„Éº„Éâ„ÇíÊé¢„Åô
                            let exactMatch = null;
                            for (const doc of existingDocs.docs) {
                                const docData = doc.data();
                                const docTags = docData.tags || [];
                                const cardTags = card.tags || [];
                                if (docTags.length === cardTags.length &&
                                    docTags.every(tag => cardTags.includes(tag))) {
                                    exactMatch = doc;
                                    break;
                                }
                            }

                            if (!exactMatch) {
                                batch.set(doc(collRef), card);
                            } else {
                                batch.update(exactMatch.ref, { ÊûöÊï∞: increment(card.ÊûöÊï∞ || 1) });
                            }
                        }
                        await batch.commit();
                    } else { // „É≠„Éº„Ç´„É´„É¢„Éº„Éâ
                        for (const card of importedData.collection) {
                            if (card.„Çø„Ç∞ && typeof card.„Çø„Ç∞ === 'string') {
                                card.tags = card.„Çø„Ç∞.split(';').filter(t => t.trim());
                                delete card.„Çø„Ç∞;
                            }
                            const existingCard = cardCollection.find(c => {
                                if (c.data.ÂêçÂâç !== card.ÂêçÂâç) return false;
                                if (c.data.ÂûãÁï™ !== card.ÂûãÁï™) return false;
                                if (c.data.„É¨„Ç¢„É™„ÉÜ„Ç£ !== card.„É¨„Ç¢„É™„ÉÜ„Ç£) return false;
                                // „Çø„Ç∞„ÇÇ‰∏ÄËá¥Á¢∫Ë™ç
                                const cTags = c.data.tags || [];
                                const cardTags = card.tags || [];
                                if (cTags.length !== cardTags.length) return false;
                                if (!cTags.every(tag => cardTags.includes(tag))) return false;
                                return true;
                            });
                            if (existingCard) {
                                existingCard.data.ÊûöÊï∞ += (card.ÊûöÊï∞ || 1);
                            } else {
                                cardCollection.push({ id: `local_${Date.now()}_${Math.random()}`, data: card });
                            }
                        }
                    }
                }

                // Import wishlist
                if (importedData.wishlist.length > 0) {
                    const wishRef = getCollectionRef('wishlist');
                    if (wishRef) { // Firebase„É¢„Éº„Éâ
                        const batch = writeBatch(db);
                        for (const card of importedData.wishlist) {
                            if (card.„Çø„Ç∞ && typeof card.„Çø„Ç∞ === 'string') {
                                card.tags = card.„Çø„Ç∞.split(';').filter(t => t.trim());
                                delete card.„Çø„Ç∞;
                            }
                            const q = query(wishRef, where("ÂêçÂâç", "==", card.ÂêçÂâç), where("ÂûãÁï™", "==", card.ÂûãÁï™), where("„É¨„Ç¢„É™„ÉÜ„Ç£", "==", card.„É¨„Ç¢„É™„ÉÜ„Ç£));
                            const existingDocs = await getDocs(q);

                            // „Çø„Ç∞„ÇÇÂê´„ÇÅ„Å¶ÂÆåÂÖ®‰∏ÄËá¥„Åô„Çã„Ç´„Éº„Éâ„ÇíÊé¢„Åô
                            let exactMatch = null;
                            for (const doc of existingDocs.docs) {
                                const docData = doc.data();
                                const docTags = docData.tags || [];
                                const cardTags = card.tags || [];
                                if (docTags.length === cardTags.length &&
                                    docTags.every(tag => cardTags.includes(tag))) {
                                    exactMatch = doc;
                                    break;
                                }
                            }

                            if (!exactMatch) {
                                batch.set(doc(wishRef), card);
                            } else {
                                batch.update(exactMatch.ref, { ÊûöÊï∞: increment(card.ÊûöÊï∞ || 1) });
                            }
                        }
                        await batch.commit();
                    } else { // „É≠„Éº„Ç´„É´„É¢„Éº„Éâ
                        for (const card of importedData.wishlist) {
                            if (card.„Çø„Ç∞ && typeof card.„Çø„Ç∞ === 'string') {
                                card.tags = card.„Çø„Ç∞.split(';').filter(t => t.trim());
                                delete card.„Çø„Ç∞;
                            }
                            const existingCard = wishlistCollection.find(c => {
                                if (c.data.ÂêçÂâç !== card.ÂêçÂâç) return false;
                                if (c.data.ÂûãÁï™ !== card.ÂûãÁï™) return false;
                                if (c.data.„É¨„Ç¢„É™„ÉÜ„Ç£ !== card.„É¨„Ç¢„É™„ÉÜ„Ç£) return false;
                                // „Çø„Ç∞„ÇÇ‰∏ÄËá¥Á¢∫Ë™ç
                                const cTags = c.data.tags || [];
                                const cardTags = card.tags || [];
                                if (cTags.length !== cardTags.length) return false;
                                if (!cTags.every(tag => cardTags.includes(tag))) return false;
                                return true;
                            });
                            if (existingCard) {
                                existingCard.data.ÊûöÊï∞ += (card.ÊûöÊï∞ || 1);
                            } else {
                                wishlistCollection.push({ id: `local_${Date.now()}_${Math.random()}`, data: card });
                            }
                        }
                    }
                }

                // Reload if using Firebase, otherwise just refresh display
                if (getCollectionRef()) {
                    await loadCollectionFromFirestore();
                } else {
                    applySearchAndFilter();
                }

                showLoading(false);
                alert('„Ç§„É≥„Éù„Éº„Éà„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ');
            } catch (err) { 
                showLoading(false); 
                alert(`„Ç§„É≥„Éù„Éº„Éà‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${err.message}`); 
                console.error(err); 
            }
        };

        document.getElementById('import-json-btn').addEventListener('click', () => importFileInput.click());
        document.getElementById('import-csv-btn').addEventListener('click', () => importFileInput.click());
        importFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            const format = file.name.endsWith('.csv') ? 'csv' : 'json';
            reader.onload = (event) => handleImport(event.target.result, format);
            reader.readAsText(file);
            e.target.value = '';
        });

        document.getElementById('export-json-btn').addEventListener('click', () => {
            const exportData = exportAllData();
            const dataStr = JSON.stringify(exportData, null, 4);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'yugioh_collection.json'; a.click(); URL.revokeObjectURL(url);
        });

        // Link with master data functionality
        document.getElementById('link-master-data-btn').addEventListener('click', async () => {
            if (!confirm('ÁèæÂú®„ÅÆ„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Çí„Éû„Çπ„Çø„Éº„Éá„Éº„Çø„Å®ÈÄ£Êê∫„Åó„Åæ„Åô„ÅãÔºü\n„Åì„ÅÆÂá¶ÁêÜ„Å´„Çà„Çä„ÄÅ„Ç´„Éº„ÉâË©≥Á¥∞ÊÉÖÂ†±Ôºà„É¨„Éô„É´„ÄÅÂ±ûÊÄß„ÄÅÁ®ÆÊóè„Å™„Å©Ôºâ„ÅåËá™ÂãïÁöÑ„Å´Ë£úÂÆå„Åï„Çå„Åæ„Åô„ÄÇ')) {
                return;
            }

            // Wait for master data to load if not loaded yet
            if (cardDetailsMap.size === 0) {
                alert('„Éû„Çπ„Çø„Éº„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô„ÄÇ„Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
                await loadCardReadingData();
                return;
            }

            console.log('Starting link process...');
            console.log('cardDetailsMap size:', cardDetailsMap.size);
            console.log('cardCollection length:', cardCollection.length);
            console.log('wishlistCollection length:', wishlistCollection.length);

            showLoading(true);
            let linkedCount = 0;
            let notFoundCards = [];

            try {
                // Process collection cards
                for (const card of cardCollection) {
                    const cardName = card.data['ÂêçÂâç'];

                    // Debug: Show first few card names
                    if (linkedCount < 3 || notFoundCards.length < 3) {
                        console.log('Checking card:', cardName);
                        console.log('Has in map:', cardDetailsMap.has(cardName));
                    }

                    if (cardName && cardDetailsMap.has(cardName)) {
                        const details = cardDetailsMap.get(cardName);

                        // Store the linked data in a special field
                        const updatedData = {
                            ...card.data,
                            linkedDetails: {
                                level: details.level,
                                attribute: details.attribute,
                                race: details.race,
                                cardType: details.cardType,
                                attack: details.attack,
                                defense: details.defense,
                                cardText: details.cardText
                            }
                        };

                        // Update the card in Firebase or local storage
                        if (currentUser?.uid !== 'local_user') {
                            const collRef = getCollectionRef();
                            await updateDoc(doc(collRef, card.id), updatedData);
                        } else {
                            card.data = updatedData;
                        }

                        linkedCount++;
                    } else if (cardName) {
                        notFoundCards.push(cardName);
                    }
                }

                // Process wishlist cards
                for (const card of wishlistCollection) {
                    const cardName = card.data['ÂêçÂâç'];
                    if (cardName && cardDetailsMap.has(cardName)) {
                        const details = cardDetailsMap.get(cardName);

                        const updatedData = {
                            ...card.data,
                            linkedDetails: {
                                level: details.level,
                                attribute: details.attribute,
                                race: details.race,
                                cardType: details.cardType,
                                attack: details.attack,
                                defense: details.defense,
                                cardText: details.cardText
                            }
                        };

                        if (currentUser?.uid !== 'local_user') {
                            const wishRef = getWishlistRef();
                            await updateDoc(doc(wishRef, card.id), updatedData);
                        } else {
                            card.data = updatedData;
                        }

                        linkedCount++;
                    } else if (cardName) {
                        notFoundCards.push(cardName);
                    }
                }

                // Save to local storage if local user
                if (currentUser?.uid === 'local_user') {
                    localStorage.setItem('cardCollection', JSON.stringify(cardCollection.map(c => c.data)));
                    localStorage.setItem('wishlistCollection', JSON.stringify(wishlistCollection.map(c => c.data)));
                }

                showLoading(false);

                let message = `${linkedCount}Êûö„ÅÆ„Ç´„Éº„Éâ„Çí„Éû„Çπ„Çø„Éº„Éá„Éº„Çø„Å®ÈÄ£Êê∫„Åó„Åæ„Åó„Åü„ÄÇ`;
                if (notFoundCards.length > 0) {
                    message += `\n\n„Éû„Çπ„Çø„Éº„Éá„Éº„Çø„Å´Ë¶ã„Å§„Åã„Çâ„Å™„Åã„Å£„Åü„Ç´„Éº„ÉâÔºà${notFoundCards.length}ÊûöÔºâ:\n${notFoundCards.slice(0, 10).join('\n')}`;
                    if (notFoundCards.length > 10) {
                        message += `\n... ‰ªñ${notFoundCards.length - 10}Êûö`;
                    }
                }

                alert(message);
                renderTable();

            } catch (error) {
                showLoading(false);
                alert(`ÈÄ£Êê∫‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${error.message}`);
                console.error('Error linking with master data:', error);
            }
        });

        document.getElementById('export-csv-btn').addEventListener('click', () => {
            const header = ['„É™„Çπ„ÉàÁ®ÆÂà•', 'ÂêçÂâç', 'ÂûãÁï™', '„É¨„Ç¢„É™„ÉÜ„Ç£', 'ÊûöÊï∞', '„Çø„Ç∞'];
            const collectionRows = cardCollection.map(c => {
                const row = ['ÊâÄÊåÅ„Ç´„Éº„Éâ', c.data['ÂêçÂâç'], c.data['ÂûãÁï™'], c.data['„É¨„Ç¢„É™„ÉÜ„Ç£'], c.data['ÊûöÊï∞'], (c.data.tags || []).join(';')];
                return row.map(value => {
                    const strValue = String(value || '');
                    return strValue.includes(',') ? `"${strValue}"` : strValue;
                }).join(',');
            });
            const wishlistRows = wishlistCollection.map(c => {
                const row = ['„Ç¶„Ç£„ÉÉ„Ç∑„É•„É™„Çπ„Éà', c.data['ÂêçÂâç'], c.data['ÂûãÁï™'], c.data['„É¨„Ç¢„É™„ÉÜ„Ç£'], c.data['ÊûöÊï∞'], (c.data.tags || []).join(';')];
                return row.map(value => {
                    const strValue = String(value || '');
                    return strValue.includes(',') ? `"${strValue}"` : strValue;
                }).join(',');
            });
            const csvContent = [header.join(','), ...collectionRows, ...wishlistRows].join('\r\n');
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'yugioh_collection.csv'; a.click(); URL.revokeObjectURL(url);
        });

        // --- Settings ---
        document.getElementById('how-to-use-btn').addEventListener('click', () => howToUseModal.show());
        document.getElementById('settings-btn').addEventListener('click', () => settingsModal.show());

        darkModeToggle.addEventListener('change', (e) => {
            const theme = e.target.checked ? 'dark' : 'light';
            document.documentElement.setAttribute('data-bs-theme', theme);
            localStorage.setItem('theme', theme);
            applyTheme(); // Ë®≠ÂÆöÂ§âÊõ¥ÊôÇ„Å´Âç≥ÊôÇÂèçÊò†
        });
        
        hideEmailToggle.addEventListener('change', (e) => {
            const hideEmail = e.target.checked;
            localStorage.setItem('hideEmail', hideEmail);
            if (currentUser) {
                userEmailSpan.textContent = hideEmail ? '' : currentUser.email;
            }
        });
        
        // Hide stats toggle
        const hideStatsToggle = document.getElementById('hide-stats-toggle');
        hideStatsToggle.addEventListener('change', (e) => {
            const hideStats = e.target.checked;
            localStorage.setItem('hideStats', hideStats);
            updateCollectionStats(); // Update immediately
        });
        
        // Daily challenges toggle
        const showDailyChallengesToggle = document.getElementById('show-daily-challenges-toggle');
        showDailyChallengesToggle.addEventListener('change', (e) => {
            const show = e.target.checked;
            localStorage.setItem('showDailyChallenges', show);
            const dailyChallengesCard = document.getElementById('daily-challenges-card');
            if (dailyChallengesCard) {
                dailyChallengesCard.style.display = show ? 'block' : 'none';
            }
        });

        // Auto save toggle
        const autoSaveToggle = document.getElementById('auto-save-toggle');
        let autoSaveInterval = null;
        autoSaveToggle.addEventListener('change', (e) => {
            const enable = e.target.checked;
            localStorage.setItem('autoSave', enable);

            if (enable) {
                // Set up auto save interval (5 minutes)
                autoSaveInterval = setInterval(() => {
                    if (currentUser && currentUser.uid !== 'local_user') {
                        // Auto save to Firebase
                        console.log('Auto saving...');
                        // The data is already being saved when cards are added/modified
                    } else {
                        // Save to localStorage
                        localStorage.setItem('cardCollection', JSON.stringify(cardCollection.map(c => c.data)));
                        localStorage.setItem('wishlistCollection', JSON.stringify(wishlistCollection.map(c => c.data)));
                    }
                }, 300000); // 5 minutes
            } else {
                if (autoSaveInterval) {
                    clearInterval(autoSaveInterval);
                    autoSaveInterval = null;
                }
            }
        });

        // Table rows per page
        const tableRowsPerPage = document.getElementById('table-rows-per-page');
        tableRowsPerPage.addEventListener('change', (e) => {
            localStorage.setItem('tableRowsPerPage', e.target.value);
            applySearchAndFilter(); // Re-render table with new row limit
        });

        // Initialize settings
        hideEmailToggle.checked = localStorage.getItem('hideEmail') === 'true';
        hideStatsToggle.checked = localStorage.getItem('hideStats') === 'true';
        showDailyChallengesToggle.checked = localStorage.getItem('showDailyChallenges') !== 'false'; // Default true
        autoSaveToggle.checked = localStorage.getItem('autoSave') === 'true';
        tableRowsPerPage.value = localStorage.getItem('tableRowsPerPage') || '100';

        // Apply initial settings
        if (localStorage.getItem('showDailyChallenges') === 'false') {
            const dailyChallengesCard = document.getElementById('daily-challenges-card');
            if (dailyChallengesCard) {
                dailyChallengesCard.style.display = 'none';
            }
        }

        if (autoSaveToggle.checked) {
            // Start auto save if enabled
            autoSaveToggle.dispatchEvent(new Event('change'));
        }
        
        // Stats info button
        document.getElementById('stats-info-btn').addEventListener('click', () => {
            const statsInfoModal = new bootstrap.Modal(document.getElementById('stats-info-modal'));
            statsInfoModal.show();
        });
        
        // Achievement toggle
        document.getElementById('achievement-toggle').addEventListener('click', () => {
            const section = document.getElementById('achievement-section');
            const icon = document.getElementById('achievement-toggle-icon');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                icon.className = 'bi bi-chevron-up';
            } else {
                section.style.display = 'none';
                icon.className = 'bi bi-chevron-down';
            }
        });
        
        // Tap quantity input functions
        const createTapQuantityInput = (containerId, inputId, initialValue = 1) => {
            const container = document.getElementById(containerId);
            const input = document.getElementById(inputId);

            const tapContainer = document.createElement('div');
            tapContainer.className = 'tap-quantity-container';
            tapContainer.innerHTML = `
                <button type="button" class="btn btn-outline-secondary tap-quantity-btn" data-action="decrease">
                    <i class="bi bi-dash-lg"></i>
                </button>
                <div class="tap-quantity-display">${initialValue}</div>
                <button type="button" class="btn btn-outline-secondary tap-quantity-btn" data-action="increase">
                    <i class="bi bi-plus-lg"></i>
                </button>
                <button type="button" class="btn btn-outline-danger tap-quantity-btn" data-action="reset" title="„É™„Çª„ÉÉ„Éà">
                    <i class="bi bi-arrow-counterclockwise"></i>
                </button>
            `;

            const display = tapContainer.querySelector('.tap-quantity-display');
            let value = initialValue;

            tapContainer.addEventListener('click', (e) => {
                const btn = e.target.closest('[data-action]');
                if (!btn) return;

                const action = btn.dataset.action;
                if (action === 'decrease' && value > 1) {
                    value--;
                } else if (action === 'increase' && value < 99) {
                    value++;
                } else if (action === 'reset') {
                    value = 1;
                }

                display.textContent = value;
                input.value = value;
            });

            container.innerHTML = '';
            container.appendChild(tapContainer);

            // Keep hidden input in sync
            input.type = 'hidden';
            container.appendChild(input);
        };

        const restoreNormalQuantityInput = (containerId, inputId) => {
            const container = document.getElementById(containerId);
            const input = document.getElementById(inputId);

            input.type = 'number';
            input.className = 'form-control';

            container.innerHTML = '';
            container.appendChild(input);
        };

        const updateQuantityInputMode = () => {
            const useTap = localStorage.getItem('useTapQuantity') === 'true';

            if (useTap) {
                // Enable tap mode for all devices (both mobile and PC)
                createTapQuantityInput('quantity-input-container', 'quantity',
                    parseInt(document.getElementById('quantity').value) || 1);
                createTapQuantityInput('edit-quantity-input-container', 'edit-quantity',
                    parseInt(document.getElementById('edit-quantity').value) || 1);
            } else {
                restoreNormalQuantityInput('quantity-input-container', 'quantity');
                restoreNormalQuantityInput('edit-quantity-input-container', 'edit-quantity');
            }
        };

        // Initialize history settings
        showSearchHistoryToggle.checked = localStorage.getItem('showSearchHistory') === 'true';
        showRegistrationHistoryToggle.checked = localStorage.getItem('showRegistrationHistory') === 'true';
        useTapQuantityToggle.checked = localStorage.getItem('useTapQuantity') === 'true';

        showSearchHistoryToggle.addEventListener('change', (e) => {
            localStorage.setItem('showSearchHistory', e.target.checked);
            updateSearchHistoryButton();
        });
        
        showRegistrationHistoryToggle.addEventListener('change', (e) => {
            localStorage.setItem('showRegistrationHistory', e.target.checked);
            updateRegistrationHistoryButton();
        });

        useTapQuantityToggle.addEventListener('change', (e) => {
            localStorage.setItem('useTapQuantity', e.target.checked);
            updateQuantityInputMode();
        });
        
        // Previous search button
        document.getElementById('prev-search-btn').addEventListener('click', () => {
            if (lastSearchKeyword) {
                document.getElementById('card-search').value = lastSearchKeyword;
                document.getElementById('search-db-btn').click();
            }
        });
        
        // Previous registration button
        document.getElementById('prev-registration-btn').addEventListener('click', () => {
            if (lastRegistrationData) {
                document.getElementById('name').value = lastRegistrationData.name;
                document.getElementById('set_code').value = lastRegistrationData.setCode;
                document.getElementById('rarity').value = lastRegistrationData.rarity;
                document.getElementById('quantity').value = lastRegistrationData.quantity;
                
                // Restore tags
                currentCardTags = [...lastRegistrationData.tags];
                renderTagChoices('tag-choices-container', currentCardTags);
                renderSelectedTags('card-tags-container', currentCardTags);
                
                // Restore add type
                if (lastRegistrationData.addType === 'collection') {
                    document.getElementById('add-to-collection').checked = true;
                } else {
                    document.getElementById('add-to-wishlist').checked = true;
                }
                
                // Restore set-rarity choices
                const choicesEl = document.getElementById('set-rarity-choices');
                choicesEl.innerHTML = '';
                if (lastRegistrationData.setChoices && lastRegistrationData.setChoices.length > 0) {
                    lastRegistrationData.setChoices.forEach(choice => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'btn btn-outline-primary btn-sm m-1 set-choice-btn';
                        btn.dataset.setCode = choice.setCode;
                        btn.dataset.rarity = choice.rarity;
                        btn.textContent = choice.text;
                        choicesEl.appendChild(btn);
                    });
                }
            }
        });
        
        // Initialize history buttons and quantity input mode on page load
        setTimeout(() => {
            updateSearchHistoryButton();
            updateRegistrationHistoryButton();
            updateQuantityInputMode();
        }, 100);

        const applyTheme = () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-bs-theme', savedTheme);
            darkModeToggle.checked = savedTheme === 'dark';

            const nav = document.querySelector('.navbar');
            if (nav) {
                if (savedTheme === 'dark') {
                    nav.classList.remove('navbar-light', 'bg-light');
                    nav.classList.add('navbar-dark', 'bg-dark');
                } else {
                    nav.classList.remove('navbar-dark', 'bg-dark');
                    nav.classList.add('navbar-light', 'bg-light');
                }
            }
        };
        applyTheme(); // Apply theme on initial load

        // Tag cleanup functionality
        document.getElementById('cleanup-tags-btn').addEventListener('click', async () => {
            if (!currentUser) {
                alert('„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ');
                return;
            }

            showLoading(true);
            try {
                const existingTagNames = allTags.map(t => t.name);
                let cleanupCount = 0;
                let updatedCards = [];

                // Check collection cards
                for (const card of cardCollection) {
                    if (card.data.tags && card.data.tags.length > 0) {
                        const validTags = card.data.tags.filter(tag => existingTagNames.includes(tag));
                        if (validTags.length !== card.data.tags.length) {
                            cleanupCount++;
                            card.data.tags = validTags;
                            updatedCards.push({ card, listType: 'collection' });
                        }
                    }
                }

                // Check wishlist cards
                for (const card of wishlistCollection) {
                    if (card.data.tags && card.data.tags.length > 0) {
                        const validTags = card.data.tags.filter(tag => existingTagNames.includes(tag));
                        if (validTags.length !== card.data.tags.length) {
                            cleanupCount++;
                            card.data.tags = validTags;
                            updatedCards.push({ card, listType: 'wishlist' });
                        }
                    }
                }

                if (cleanupCount > 0) {
                    if (!confirm(`${cleanupCount}Êûö„ÅÆ„Ç´„Éº„Éâ„Åã„ÇâÂ≠òÂú®„Åó„Å™„ÅÑ„Çø„Ç∞„ÇíÂâäÈô§„Åó„Åæ„Åô„ÄÇÁ∂öË°å„Åó„Åæ„Åô„ÅãÔºü`)) {
                        showLoading(false);
                        return;
                    }

                    // Update cards in Firebase
                    for (const { card, listType } of updatedCards) {
                        const collRef = getCollectionRef(listType);
                        if (collRef) {
                            await updateDoc(doc(collRef, card.id), { tags: card.data.tags });
                        }
                    }

                    // Save to localStorage if not using Firebase
                    if (!currentUser || currentUser.uid === 'local_user') {
                        localStorage.setItem('cardCollection', JSON.stringify(cardCollection));
                        localStorage.setItem('wishlistCollection', JSON.stringify(wishlistCollection));
                    }

                    alert(`${cleanupCount}Êûö„ÅÆ„Ç´„Éº„Éâ„Åã„ÇâÂ≠òÂú®„Åó„Å™„ÅÑ„Çø„Ç∞„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ`);
                    applySearchAndFilter();
                } else {
                    alert('„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó„ÅåÂøÖË¶Å„Å™„Çø„Ç∞„ÅØË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ');
                }
            } catch (error) {
                console.error('Error cleaning up tags:', error);
                alert('„Çø„Ç∞„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
            } finally {
                showLoading(false);
            }
        });

        // ============================================
        // VIP Membership System (Secured)
        // ============================================

        // SHA-256 hash of valid serial number
        // Serial number is not stored in source code for security
        const VALID_SERIAL_HASH = '1a0475ee08c7580c51f9492b1f26dbff0528c4754a023adb532e6a437b747216';

        let isVipMember = false;

        // SHA-256 hash function
        const sha256 = async (message) => {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        };

        // Check daily attempt limit
        const checkAttemptLimit = () => {
            const today = new Date().toISOString().split('T')[0];
            const attemptsData = localStorage.getItem('serial_attempts');

            let attempts = { date: today, count: 0 };
            if (attemptsData) {
                try {
                    attempts = JSON.parse(attemptsData);
                    // Reset counter if it's a new day
                    if (attempts.date !== today) {
                        attempts = { date: today, count: 0 };
                    }
                } catch (e) {
                    attempts = { date: today, count: 0 };
                }
            }

            return attempts;
        };

        // Update attempts counter
        const updateAttempts = (count) => {
            const today = new Date().toISOString().split('T')[0];
            const attemptsData = { date: today, count: count };
            localStorage.setItem('serial_attempts', JSON.stringify(attemptsData));

            // Update UI
            const remainingAttempts = Math.max(0, 3 - count);
            const attemptsText = document.getElementById('serial-attempts-text');
            if (attemptsText) {
                attemptsText.innerHTML = `<i class="bi bi-info-circle"></i> ÊÆã„ÇäË©¶Ë°åÂõûÊï∞: ${remainingAttempts}Âõû`;
                if (remainingAttempts === 0) {
                    attemptsText.innerHTML = `<i class="bi bi-exclamation-triangle text-danger"></i> Êú¨Êó•„ÅÆË©¶Ë°åÂõûÊï∞„ÇíË∂ÖÈÅé„Åó„Åæ„Åó„Åü`;
                }
            }
        };

        // Check VIP status on load
        const checkVipStatus = () => {
            // Show serial section only for logged-in users
            const serialSection = document.getElementById('serial-number-section');
            if (currentUser && currentUser.uid !== 'local_user') {
                if (serialSection) serialSection.style.display = 'block';
            } else {
                if (serialSection) serialSection.style.display = 'none';
                return; // Guest users cannot access
            }

            const vipData = localStorage.getItem('vip_membership');
            if (vipData) {
                try {
                    const parsed = JSON.parse(vipData);
                    if (parsed.active && parsed.verified) {
                        isVipMember = true;
                        updateVipUI(true);
                    }
                } catch (e) {
                    console.error('Error parsing VIP data:', e);
                }
            }

            // Update attempts display
            const attempts = checkAttemptLimit();
            updateAttempts(attempts.count);
        };

        // Update VIP UI
        const updateVipUI = (isVip) => {
            const inputSection = document.getElementById('vip-serial-input-section');
            const activeSection = document.getElementById('vip-active-section');
            const statusBadge = document.getElementById('vip-status-badge');
            const vipExportOption = document.getElementById('vip-export-option');
            const profileVipBadge = document.getElementById('profile-vip-badge');
            const vipGalleryBtnContainer = document.getElementById('vip-gallery-btn-container');

            if (isVip) {
                if (inputSection) inputSection.style.display = 'none';
                if (activeSection) activeSection.style.display = 'block';
                if (statusBadge) {
                    statusBadge.style.display = 'inline-block';
                    statusBadge.classList.remove('bg-secondary');
                    statusBadge.classList.add('bg-warning', 'text-dark');
                }

                // Show VIP features
                if (vipExportOption) vipExportOption.style.display = 'block';
                if (vipGalleryBtnContainer) vipGalleryBtnContainer.style.display = 'inline-block';

                // Show VIP badge on profile
                if (profileVipBadge) profileVipBadge.style.display = 'inline-block';
            } else {
                if (inputSection) inputSection.style.display = 'block';
                if (activeSection) activeSection.style.display = 'none';
                if (statusBadge) statusBadge.style.display = 'none';

                // Hide VIP features
                if (vipExportOption) vipExportOption.style.display = 'none';
                if (vipGalleryBtnContainer) vipGalleryBtnContainer.style.display = 'none';

                // Hide VIP badge on profile
                if (profileVipBadge) profileVipBadge.style.display = 'none';
            }
        };

        // VIP Activation
        document.getElementById('vip-activate-btn').addEventListener('click', async () => {
            const serialInput = document.getElementById('vip-serial-input');
            const serial = serialInput.value.trim();

            if (!serial) {
                alert('„Ç∑„É™„Ç¢„É´Áï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            // Check attempt limit
            const attempts = checkAttemptLimit();
            if (attempts.count >= 3) {
                alert('‚ùå Êú¨Êó•„ÅÆË©¶Ë°åÂõûÊï∞‰∏äÈôê„Å´ÈÅî„Åó„Åæ„Åó„Åü„ÄÇ\nÊòéÊó•ÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            // Increment attempts
            updateAttempts(attempts.count + 1);

            // Validate serial number by hashing
            const serialHash = await sha256(serial);

            if (serialHash === VALID_SERIAL_HASH) {
                // Save VIP status
                const vipData = {
                    active: true,
                    verified: true,
                    activatedAt: new Date().toISOString()
                };
                localStorage.setItem('vip_membership', JSON.stringify(vipData));
                isVipMember = true;
                updateVipUI(true);
                serialInput.value = '';

                // Reset attempts on success
                updateAttempts(0);

                // Show success message
                alert('‚úÖ Ë™çË®º„Å´ÊàêÂäü„Åó„Åæ„Åó„ÅüÔºÅ\nÁâπÂÖ∏Ê©üËÉΩ„ÅåÂà©Áî®ÂèØËÉΩ„Å´„Å™„Çä„Åæ„Åó„Åü„ÄÇ');
            } else {
                const remainingAttempts = Math.max(0, 3 - attempts.count - 1);
                alert(`‚ùå ÁÑ°Âäπ„Å™„Ç∑„É™„Ç¢„É´Áï™Âè∑„Åß„Åô„ÄÇ\n\nÊÆã„ÇäË©¶Ë°åÂõûÊï∞: ${remainingAttempts}Âõû`);
            }
        });

        // VIP Deactivation
        document.getElementById('vip-deactivate-btn').addEventListener('click', () => {
            if (confirm('Ë™çË®º„ÇíËß£Èô§„Åó„Åæ„Åô„ÅãÔºü\n\nÂÜçÂ∫¶Âà©Áî®„Åô„Çã„Å´„ÅØ„ÄÅ„Ç∑„É™„Ç¢„É´Áï™Âè∑„ÅÆÂÜçÂÖ•Âäõ„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ')) {
                localStorage.removeItem('vip_membership');
                isVipMember = false;
                updateVipUI(false);
                alert('Ë™çË®º„ÇíËß£Èô§„Åó„Åæ„Åó„Åü„ÄÇ');
            }
        });

        // VIP Features Button
        document.getElementById('vip-features-btn').addEventListener('click', () => {
            const features = `
‚ú® ÁâπÂÖ∏Ê©üËÉΩ‰∏ÄË¶ß

üìä ÁèæÂú®Âà©Áî®ÂèØËÉΩ„Å™Ê©üËÉΩ:
‚Ä¢ „Éó„É¨„Éü„Ç¢„É†CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà
  - „É¨„Éô„É´„ÄÅÂ±ûÊÄß„ÄÅÁ®ÆÊóè„Å™„Å©„ÅÆË©≥Á¥∞„Éá„Éº„Çø„ÇíÂê´„ÇÄ
‚Ä¢ ÂÑ™ÂÖà„Çµ„Éù„Éº„Éà

üöÄ ‰ªäÂæåËøΩÂä†‰∫àÂÆö„ÅÆÊ©üËÉΩ:
‚Ä¢ „Ç´„Çπ„Çø„É†„ÉÜ„Éº„Éû
‚Ä¢ „Éó„É¨„Éü„Ç¢„É†Áµ±Ë®àÂàÜÊûê
‚Ä¢ „Ç´„Éº„Éâ‰æ°Ê†ºÈÄ£Êê∫
‚Ä¢ Ëá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÊ©üËÉΩ
‚Ä¢ Â∫ÉÂëäÈùûË°®Á§∫

ÁâπÂÖ∏Ê©üËÉΩ„ÅØÈ†ÜÊ¨°ËøΩÂä†„Åï„Çå„Åæ„Åô„ÄÇ
„ÅäÊ•Ω„Åó„Åø„Å´ÔºÅ
            `.trim();

            alert(features);
        });

        // VIP Premium Export Function
        document.getElementById('export-premium-csv-btn').addEventListener('click', () => {
            if (!isVipMember) {
                alert('„Åì„ÅÆÊ©üËÉΩ„ÅØVIP„É°„É≥„Éê„ÉºÂ∞ÇÁî®„Åß„Åô„ÄÇ');
                return;
            }

            const collection = getCurrentCollection();
            if (collection.length === 0) {
                alert('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„Çã„Ç´„Éº„Éâ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                return;
            }

            // Premium CSV with extended data
            let csvContent = '\uFEFF'; // BOM for UTF-8
            csvContent += '„Ç´„Éº„ÉâÂêç,ÂûãÁï™,„É¨„Ç¢„É™„ÉÜ„Ç£,ÊûöÊï∞,„Çø„Ç∞,„É¨„Éô„É´,Â±ûÊÄß,Á®ÆÊóè,„Ç´„Éº„Éâ„Çø„Ç§„Éó,ÊîªÊíÉÂäõ,ÂÆàÂÇôÂäõ,ÁôªÈå≤Êó•,ÊúÄÁµÇÊõ¥Êñ∞Êó•\n';

            collection.forEach(card => {
                const d = card.data;
                const details = d.linkedDetails || cardDetailsMap.get(d['ÂêçÂâç'] || '');

                const row = [
                    d['ÂêçÂâç'] || '',
                    d['ÂûãÁï™'] || '',
                    d['„É¨„Ç¢„É™„ÉÜ„Ç£'] || '',
                    d['ÊûöÊï∞'] || 0,
                    (d.tags || []).join('|'),
                    details?.level || '',
                    details?.attribute || '',
                    details?.race || '',
                    details?.cardType || '',
                    details?.attack || '',
                    details?.defense || '',
                    d['ÁôªÈå≤Êó•'] || '',
                    d['ÊúÄÁµÇÊõ¥Êñ∞Êó•'] || ''
                ].map(val => `"${String(val).replace(/"/g, '""')}"`);

                csvContent += row.join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `premium_card_collection_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Bulk Import functionality
        let bulkImportCards = [];

        document.getElementById('bulk-import-btn').addEventListener('click', () => {
            const bulkImportModal = new bootstrap.Modal(document.getElementById('bulk-import-modal'));
            bulkImportModal.show();
        });

        document.getElementById('fetch-cards-btn').addEventListener('click', async () => {
            const url = document.getElementById('bulk-import-url').value.trim();

            if (!url) {
                alert('URL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            if (!url.includes('yugioh-card.com')) {
                alert('ÈÅäÊàØÁéãÂÖ¨ÂºèDB„ÅÆURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            const loadingDiv = document.getElementById('bulk-import-loading');
            const resultsDiv = document.getElementById('bulk-import-results');
            const registerBtn = document.getElementById('bulk-register-btn');

            loadingDiv.style.display = 'block';
            resultsDiv.style.display = 'none';
            registerBtn.disabled = true;

            try {
                const proxyUrl = `https://ygoh-list.onrender.com/card-list?url=${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl);

                if (!response.ok) {
                    throw new Error('„Ç´„Éº„ÉâÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
                }

                const data = await response.json();
                bulkImportCards = data.cards || [];

                // Debug: Log response data
                console.log('Proxy response:', data);
                if (data.debug) {
                    console.log('=== Debug Info ===');
                    console.log('HTML Sample (first 3000 chars):', data.debug.htmlSample);
                    console.log('Card Image Patterns:', data.debug.cardImagePatterns);
                    console.log('Name Patterns:', data.debug.namePatterns);
                    console.log('Strong Tags:', data.debug.strongTags);
                }

                if (bulkImportCards.length === 0) {
                    console.error('No cards found. Check debug info above.');
                    throw new Error('„Ç´„Éº„Éâ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇURL„ÅåÊ≠£„Åó„ÅÑ„Åã„ÄÅ„Åæ„Åü„ÅØÊ§úÁ¥¢ÁµêÊûú„Å´„Ç´„Éº„Éâ„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                }

                // Display results
                document.getElementById('bulk-import-count').textContent = bulkImportCards.length;
                const cardGrid = document.getElementById('bulk-import-card-grid');
                cardGrid.innerHTML = '';

                bulkImportCards.forEach((card, index) => {
                    const cardItem = document.createElement('div');
                    cardItem.className = 'bulk-card-item';

                    // Get card image URL
                    const imageUrl = `https://ygoh-list.onrender.com/image?cid=${card.id}`;

                    cardItem.innerHTML = `
                        <img src="${imageUrl}" alt="${card.name}" class="bulk-card-image"
                            onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22290%22><rect width=%22200%22 height=%22290%22 fill=%22%23ddd%22/><text x=%2250%%22 y=%2250%%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22>No Image</text></svg>'">
                        <div class="bulk-card-name" title="${card.name}">${card.name}</div>
                        ${card.number ? `<div class="bulk-card-number">${card.number}</div>` : ''}
                        <div class="bulk-card-controls">
                            <div>
                                <label>„É¨„Ç¢„É™„ÉÜ„Ç£</label>
                                <select class="form-select form-select-sm bulk-card-rarity" data-index="${index}">
                                    <option value="">-</option>
                                    <option value="„Éé„Éº„Éû„É´">„Éé„Éº„Éû„É´</option>
                                    <option value="„É¨„Ç¢">„É¨„Ç¢</option>
                                    <option value="„Çπ„Éº„Éë„Éº„É¨„Ç¢">„Çπ„Éº„Éë„Éº„É¨„Ç¢</option>
                                    <option value="„Ç¶„É´„Éà„É©„É¨„Ç¢">„Ç¶„É´„Éà„É©„É¨„Ç¢</option>
                                    <option value="„Ç∑„Éº„ÇØ„É¨„ÉÉ„Éà„É¨„Ç¢">„Ç∑„Éº„ÇØ„É¨„ÉÉ„Éà„É¨„Ç¢</option>
                                    <option value="„Éõ„É≠„Ç∞„É©„Éï„Ç£„ÉÉ„ÇØ„É¨„Ç¢">„Éõ„É≠„Ç∞„É©„Éï„Ç£„ÉÉ„ÇØ„É¨„Ç¢</option>
                                    <option value="20th„Ç∑„Éº„ÇØ„É¨„ÉÉ„Éà„É¨„Ç¢">20th„Ç∑„Éº„ÇØ„É¨„ÉÉ„Éà„É¨„Ç¢</option>
                                    <option value="„Éó„É™„Ç∫„Éû„ÉÜ„Ç£„ÉÉ„ÇØ„Ç∑„Éº„ÇØ„É¨„ÉÉ„Éà„É¨„Ç¢">„Éó„É™„Ç∫„Éû„ÉÜ„Ç£„ÉÉ„ÇØ„Ç∑„Éº„ÇØ„É¨„ÉÉ„Éà„É¨„Ç¢</option>
                                    <option value="„Éü„É¨„Éã„Ç¢„É†„É¨„Ç¢">„Éü„É¨„Éã„Ç¢„É†„É¨„Ç¢</option>
                                    <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
                                </select>
                            </div>
                            <div>
                                <label>ÊûöÊï∞</label>
                                <input type="number" class="form-control form-control-sm bulk-card-quantity"
                                    data-index="${index}" value="0" min="0" max="99">
                            </div>
                        </div>
                    `;
                    cardGrid.appendChild(cardItem);
                });

                loadingDiv.style.display = 'none';
                resultsDiv.style.display = 'block';
                registerBtn.disabled = false;

            } catch (error) {
                console.error('Error fetching cards:', error);
                alert(error.message || '„Ç´„Éº„ÉâÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
                loadingDiv.style.display = 'none';
            }
        });

        document.getElementById('bulk-register-btn').addEventListener('click', async () => {
            if (!currentUser) {
                alert('„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ');
                return;
            }

            const selectedCards = [];
            const quantityInputs = document.querySelectorAll('.bulk-card-quantity');

            quantityInputs.forEach(input => {
                const index = parseInt(input.dataset.index);
                const quantity = parseInt(input.value) || 0;
                const raritySelect = document.querySelector(`.bulk-card-rarity[data-index="${index}"]`);
                const rarity = raritySelect.value;

                if (quantity > 0) {
                    selectedCards.push({
                        ...bulkImportCards[index],
                        quantity: quantity,
                        rarity: rarity
                    });
                }
            });

            if (selectedCards.length === 0) {
                alert('ÊûöÊï∞„Åå1‰ª•‰∏ä„ÅÆ„Ç´„Éº„Éâ„ÇíÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            if (!confirm(`${selectedCards.length}‰ª∂„ÅÆ„Ç´„Éº„Éâ„ÇíÁôªÈå≤„Åó„Åæ„Åô„ÅãÔºü`)) {
                return;
            }

            showLoading(true);
            let successCount = 0;
            let failCount = 0;

            try {
                const cardsRef = collection(db, 'users', currentUser.uid, 'cards');

                for (const card of selectedCards) {
                    try {
                        // Check if card already exists
                        const q = query(cardsRef, where('ÂêçÂâç', '==', card.name));
                        const querySnapshot = await getDocs(q);

                        if (!querySnapshot.empty) {
                            // Update existing card quantity
                            const existingDoc = querySnapshot.docs[0];
                            const existingQuantity = existingDoc.data()['ÊûöÊï∞'] || 0;
                            const updateData = {
                                'ÊûöÊï∞': existingQuantity + card.quantity,
                                'ÊúÄÁµÇÊõ¥Êñ∞Êó•': new Date().toISOString().split('T')[0]
                            };
                            // Update rarity if provided
                            if (card.rarity) {
                                updateData['„É¨„Ç¢„É™„ÉÜ„Ç£'] = card.rarity;
                            }
                            // Update card number if provided
                            if (card.number) {
                                updateData['ÂûãÁï™'] = card.number;
                            }
                            await updateDoc(existingDoc.ref, updateData);
                        } else {
                            // Add new card
                            await addDoc(cardsRef, {
                                'ÂêçÂâç': card.name,
                                'ÂûãÁï™': card.number || '',
                                '„É¨„Ç¢„É™„ÉÜ„Ç£': card.rarity || '',
                                'ÊûöÊï∞': card.quantity,
                                'tags': [],
                                'ÁôªÈå≤Êó•': new Date().toISOString().split('T')[0],
                                'ÊúÄÁµÇÊõ¥Êñ∞Êó•': new Date().toISOString().split('T')[0]
                            });
                        }
                        successCount++;
                    } catch (error) {
                        console.error(`Failed to register ${card.name}:`, error);
                        failCount++;
                    }
                }

                alert(`ÁôªÈå≤ÂÆå‰∫Ü\nÊàêÂäü: ${successCount}‰ª∂\nÂ§±Êïó: ${failCount}‰ª∂`);

                // Close modal and reload data
                bootstrap.Modal.getInstance(document.getElementById('bulk-import-modal')).hide();
                await loadData(currentUser.uid);

            } catch (error) {
                console.error('Error during bulk registration:', error);
                alert('‰∏ÄÊã¨ÁôªÈå≤‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
            } finally {
                showLoading(false);
            }
        });

        // Note: checkVipStatus() is called in handleUserLogin() after authentication completes
        // Do not call it here as currentUser is still null at page load

        document.getElementById('delete-account-btn').addEventListener('click', async () => {
            if (!currentUser) return;
            if (!confirm('Êú¨ÂΩì„Å´„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ')) return;
            if (!confirm('ÊúÄÁµÇÁ¢∫Ë™ç„Åß„Åô„ÄÇ„Ç¢„Ç´„Ç¶„É≥„Éà„Å´Á¥ê„Å•„ÅèÂÖ®„Å¶„ÅÆ„Ç´„Éº„Éâ„Éá„Éº„Çø„ÄÅ„É©„É≥„Ç≠„É≥„Ç∞„ÄÅ„Éó„É≠„Éï„Ç£„Éº„É´ÊÉÖÂ†±„ÅåÊ∞∏‰πÖ„Å´ÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) return;
            
            showLoading(true);
            try {
                // 1. Delete all card data from Firestore
                const userCardCollectionRef = getCollectionRef();
                const snapshot = await getDocs(query(userCardCollectionRef));
                const batch = writeBatch(db);
                snapshot.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();

                // 2. Delete ranking data
                try {
                    const rankingRef = doc(db, 'rankings', currentUser.uid);
                    await deleteDoc(rankingRef);
                } catch (rankingError) {
                    console.error('Error deleting ranking data:', rankingError);
                }

                // 3. Delete gamification data (including profile)
                try {
                    const gamificationRef = doc(db, 'userGamification', currentUser.uid);
                    await deleteDoc(gamificationRef);
                } catch (gamificationError) {
                    console.error('Error deleting gamification data:', gamificationError);
                }

                // 4. Delete wishlist data if exists
                try {
                    const wishlistRef = collection(db, 'users', currentUser.uid, 'wishlist');
                    const wishlistSnapshot = await getDocs(wishlistRef);
                    const wishlistBatch = writeBatch(db);
                    wishlistSnapshot.docs.forEach(doc => wishlistBatch.delete(doc.ref));
                    await wishlistBatch.commit();
                } catch (wishlistError) {
                    console.error('Error deleting wishlist data:', wishlistError);
                }

                // 5. Delete tags data if exists
                try {
                    const tagsRef = collection(db, 'users', currentUser.uid, 'tags');
                    const tagsSnapshot = await getDocs(tagsRef);
                    const tagsBatch = writeBatch(db);
                    tagsSnapshot.docs.forEach(doc => tagsBatch.delete(doc.ref));
                    await tagsBatch.commit();
                } catch (tagsError) {
                    console.error('Error deleting tags data:', tagsError);
                }

                // 6. Delete the user account
                await deleteUser(currentUser);
                await signOut(auth);
                alert('„Ç¢„Ç´„Ç¶„É≥„Éà„Å®ÂÖ®„Å¶„ÅÆÈñ¢ÈÄ£„Éá„Éº„Çø„ÅåÊ≠£Â∏∏„Å´ÂâäÈô§„Åï„Çå„Åæ„Åó„Åü„ÄÇ');
                settingsModal.hide();
            } catch (error) {
                showLoading(false);
                if (error.code === 'auth/requires-recent-login') {
                    alert('„Ç¢„Ç´„Ç¶„É≥„ÉàÂâäÈô§„ÅÆÂâç„Å´„ÄÅÂÜç„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ‰∏ÄÂ∫¶„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Å¶„Åã„Çâ„ÄÅÂÜçÂ∫¶„É≠„Ç∞„Ç§„É≥„ÅóÁõ¥„Åó„Åü‰∏ä„Åß„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
                } else {
                    alert(`„Ç¢„Ç´„Ç¶„É≥„Éà„ÅÆÂâäÈô§‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${error.message}`);
                }
            }
        });

        // --- Search from Official DB ---
        let searchResultsData = { cards: [], currentPage: 1, itemsPerPage: 10 };
        let lastSearchKeyword = '';
        let lastRegistrationData = null;
        
        const renderSearchResults = (containerId = 'search-results') => {
            const container = document.getElementById(containerId);
            const startIndex = (searchResultsData.currentPage - 1) * searchResultsData.itemsPerPage;
            const endIndex = startIndex + searchResultsData.itemsPerPage;
            const paginatedCards = searchResultsData.cards.slice(startIndex, endIndex);
            const totalPages = Math.ceil(searchResultsData.cards.length / searchResultsData.itemsPerPage);
            
            container.innerHTML = '';
            
            if (searchResultsData.cards.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">Ê§úÁ¥¢ÁµêÊûú„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ</div>';
                return;
            }
            
            const header = document.createElement('div');
            header.className = containerId === 'search-results' ? 
                'alert alert-info mb-2 d-flex justify-content-between align-items-center flex-wrap gap-2' :
                'd-flex justify-content-between align-items-center mb-2';
            header.innerHTML = `
                <span>${containerId === 'search-results' ? 'Ê§úÁ¥¢ÁµêÊûúÔºö' : ''}${searchResultsData.cards.length}‰ª∂ (${searchResultsData.currentPage}/${totalPages}„Éö„Éº„Ç∏)</span>
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-primary" ${searchResultsData.currentPage <= 1 ? 'disabled' : ''} onclick="changeSearchPage(${searchResultsData.currentPage - 1})">Ââç„Å∏</button>
                    <button class="btn btn-outline-primary" ${searchResultsData.currentPage >= totalPages ? 'disabled' : ''} onclick="changeSearchPage(${searchResultsData.currentPage + 1})">Ê¨°„Å∏</button>
                </div>
            `;
            container.appendChild(header);
            
            const listGroup = document.createElement('div');
            listGroup.className = 'list-group';
            
            paginatedCards.forEach(card => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'list-group-item list-group-item-action';
                button.textContent = card.name;
                button.dataset.cardUrl = card.url;
                button.onclick = () => fetchCardDetails(button.dataset.cardUrl);
                listGroup.appendChild(button);
            });
            
            container.appendChild(listGroup);
            
            if (totalPages > 1 && containerId === 'search-results') {
                const bottomControls = document.createElement('div');
                bottomControls.className = 'mt-2 d-flex justify-content-center';
                bottomControls.innerHTML = `
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-primary" ${searchResultsData.currentPage <= 1 ? 'disabled' : ''} onclick="changeSearchPage(${searchResultsData.currentPage - 1})">Ââç„Å∏</button>
                        <button class="btn btn-outline-primary" ${searchResultsData.currentPage >= totalPages ? 'disabled' : ''} onclick="changeSearchPage(${searchResultsData.currentPage + 1})">Ê¨°„Å∏</button>
                    </div>
                `;
                container.appendChild(bottomControls);
            }
        };
        
        window.changeSearchPage = (page) => {
            searchResultsData.currentPage = page;
            renderSearchResults();
        };
        
        // Add Enter key support for card search
        document.getElementById('card-search').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('search-db-btn').click();
            }
        });
        
        document.getElementById('search-db-btn').addEventListener('click', async () => {
            const searchKeyword = document.getElementById('card-search').value.trim();
            if (!searchKeyword) {
                alert('Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            // Save search keyword
            lastSearchKeyword = searchKeyword;
            updateSearchHistoryButton();
            
            // Track search action for missions
            trackSearchAction();
            
            // First check if we have matching cards in our collection
            const normalizedSearchKeyword = normalizeForSearch(searchKeyword);
            const searchKeyLower = searchKeyword.toLowerCase();

            // Get possible card names from hiragana reading
            let possibleCardNames = [];
            if (cardReadingMap.has(searchKeyLower)) {
                possibleCardNames = cardReadingMap.get(searchKeyLower);
            }

            // Also check for partial matches in readings
            for (const [reading, cards] of cardReadingMap) {
                if (reading.includes(searchKeyLower)) {
                    possibleCardNames.push(...cards);
                }
            }

            // Remove duplicates
            possibleCardNames = [...new Set(possibleCardNames)];

            const matchingCards = cardCollection.filter(card => {
                const cardName = card.data['ÂêçÂâç'];
                if (!cardName) return false;

                // Check direct name match
                if (normalizeForSearch(cardName).includes(normalizedSearchKeyword)) {
                    return true;
                }

                // Check if card name is in the possible names from hiragana reading
                if (possibleCardNames.includes(cardName)) {
                    return true;
                }

                return false;
            });
            
            if (matchingCards.length > 0) {
                // Show local cards first
                const resultsDiv = document.getElementById('search-results');
                resultsDiv.innerHTML = '';
                
                const localHeader = document.createElement('div');
                localHeader.className = 'alert alert-success mb-2';
                localHeader.innerHTML = `<strong>ÊâÄÊåÅ„Ç´„Éº„Éâ„Åã„ÇâË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü (${matchingCards.length}‰ª∂)</strong>`;
                resultsDiv.appendChild(localHeader);
                
                const localListGroup = document.createElement('div');
                localListGroup.className = 'list-group mb-3';
                
                matchingCards.forEach(card => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                    button.innerHTML = `
                        <div>
                            <strong>${escapeHtml(card.data['ÂêçÂâç'])}</strong>
                            ${card.data['ÂûãÁï™'] ? `<small class="text-muted ms-2">${escapeHtml(card.data['ÂûãÁï™'])}</small>` : ''}
                            ${card.data['„É¨„Ç¢„É™„ÉÜ„Ç£'] ? `<span class="badge bg-secondary ms-2">${escapeHtml(card.data['„É¨„Ç¢„É™„ÉÜ„Ç£'])}</span>` : ''}
                        </div>
                        <span class="badge bg-primary">${card.data['ÊûöÊï∞']}Êûö</span>
                    `;
                    button.onclick = () => {
                        // Fill form with existing card data
                        document.getElementById('name').value = card.data['ÂêçÂâç'];
                        document.getElementById('set_code').value = card.data['ÂûãÁï™'] || '';
                        document.getElementById('rarity').value = card.data['„É¨„Ç¢„É™„ÉÜ„Ç£'] || '';
                        document.getElementById('quantity').value = 1;
                        // Clear search results
                        resultsDiv.innerHTML = '';
                    };
                    localListGroup.appendChild(button);
                });
                
                resultsDiv.appendChild(localListGroup);
                
                // Add separator
                const separator = document.createElement('div');
                separator.className = 'alert alert-info mb-2';
                separator.innerHTML = 'ÂÖ¨ÂºèDB„Åã„Çâ„ÇÇÊ§úÁ¥¢„Åó„Å¶„ÅÑ„Åæ„Åô...';
                resultsDiv.appendChild(separator);
            }
            
            showLoading(true);
            const searchUrl = `https://www.db.yugioh-card.com/yugiohdb/card_search.action?ope=1&sess=1&rp=100&mode=&sort=1&keyword=${encodeURIComponent(searchKeyword)}&stype=1&ctype=&othercon=2&starfr=&starto=&pscaleto=&linkmarkerfr=&linkmarkerto=&link_m=2&atkfr=&atkto=&deffr=&defto=&releaseDStart=1&releaseMStart=1&releaseYStart=1999&releaseDEnd=&releaseMEnd=&releaseYEnd=`;
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(searchUrl)}`;
            
            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const text = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                
                // Extract card names and URLs
                const cardNames = Array.from(doc.querySelectorAll('span.card_name')).map(span => span.textContent.trim());
                const cardLinks = Array.from(doc.querySelectorAll('input.link_value')).map(input => input.value);
                
                // Store search results
                searchResultsData.cards = [];
                cardNames.forEach((name, index) => {
                    if (cardLinks[index]) {
                        searchResultsData.cards.push({
                            name: name,
                            url: 'https://www.db.yugioh-card.com' + cardLinks[index]
                        });
                    }
                });
                searchResultsData.currentPage = 1;
                
                // Render paginated results - append to existing local results if any
                if (matchingCards.length > 0) {
                    // Remove the "searching" message
                    const resultsDiv = document.getElementById('search-results');
                    const lastChild = resultsDiv.lastElementChild;
                    if (lastChild && lastChild.classList.contains('alert-info') && lastChild.innerHTML.includes('Ê§úÁ¥¢„Åó„Å¶„ÅÑ„Åæ„Åô')) {
                        resultsDiv.removeChild(lastChild);
                    }
                    
                    // Add official DB results header
                    const dbHeader = document.createElement('div');
                    dbHeader.className = 'alert alert-info mb-2';
                    dbHeader.innerHTML = `<strong>ÂÖ¨ÂºèDB„ÅÆÊ§úÁ¥¢ÁµêÊûú</strong>`;
                    resultsDiv.appendChild(dbHeader);
                    
                    // Create a container for paginated results
                    const dbResultsContainer = document.createElement('div');
                    dbResultsContainer.id = 'db-search-results';
                    resultsDiv.appendChild(dbResultsContainer);
                    
                    renderSearchResultsToContainer('db-search-results');
                } else {
                    renderSearchResults();
                }
            } catch (err) {
                alert(`Ê§úÁ¥¢„Ç®„É©„Éº: ${err.message}`);
            } finally {
                showLoading(false);
            }
        });
        
        const renderSearchResultsToContainer = (containerId) => renderSearchResults(containerId);
        
        const fetchCardDetails = async (cardUrl) => {
            const url = cardUrl + (cardUrl.includes('request_locale=ja') ? '' : (cardUrl.includes('?') ? '&request_locale=ja' : '?request_locale=ja'));
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
            showLoading(true);
            
            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const text = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                
                const cardName = doc.querySelector('#card_image_1')?.alt || '';
                if (!cardName) throw new Error("„Ç´„Éº„ÉâÂêç„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ");
                
                document.getElementById('name').value = cardName;
                const setCodes = Array.from(doc.querySelectorAll('div.card_number')).map(div => div.textContent.trim());
                const rarities = Array.from(doc.querySelectorAll('div.rarity p')).map(p => p.textContent.trim());
                
                const choicesEl = document.getElementById('set-rarity-choices');
                choicesEl.innerHTML = '';
                
                if (setCodes.length > 0) {
                    // Create unique set-rarity combinations
                    const uniqueSetRarities = new Map();
                    setCodes.forEach((code, i) => {
                        const rarity = rarities[i] || '';
                        const key = `${code}_${rarity}`;
                        if (!uniqueSetRarities.has(key)) {
                            uniqueSetRarities.set(key, { set_code: code, rarity: rarity });
                        }
                    });
                    
                    // Create buttons for unique combinations
                    Array.from(uniqueSetRarities.values()).forEach(data => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'btn btn-outline-primary btn-sm m-1 set-choice-btn';
                        btn.dataset.setCode = data.set_code;
                        btn.dataset.rarity = data.rarity;
                        btn.textContent = `${data.set_code} (${data.rarity})`;
                        choicesEl.appendChild(btn);
                    });
                } else {
                    choicesEl.textContent = 'ÂèéÈå≤ÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ';
                }
                
                // Clear search results
                document.getElementById('search-results').innerHTML = '';
                document.getElementById('card-search').value = '';
            } catch (err) {
                alert(`„Ç®„É©„Éº: ${err.message}`);
            } finally {
                showLoading(false);
            }
        };
        
        // --- Fetch from URL ---
        document.getElementById('fetch-btn').addEventListener('click', async () => {
            let url = document.getElementById('url').value;
            if (!url) { alert('URL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'); return; }
            if (!url.includes('request_locale=ja')) { url += url.includes('?') ? '&request_locale=ja' : '?request_locale=ja'; }
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
            showLoading(true);
            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const text = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const cardName = doc.querySelector('#card_image_1')?.alt || '';
                if (!cardName) throw new Error("„Ç´„Éº„ÉâÂêç„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ");
                document.getElementById('name').value = cardName;
                const setCodes = Array.from(doc.querySelectorAll('div.card_number')).map(div => div.textContent.trim());
                const rarities = Array.from(doc.querySelectorAll('div.rarity p')).map(p => p.textContent.trim());
                const choicesEl = document.getElementById('set-rarity-choices');
                choicesEl.innerHTML = '';
                if (setCodes.length > 0) {
                    // Create unique set-rarity combinations
                    const uniqueSetRarities = new Map();
                    setCodes.forEach((code, i) => {
                        const rarity = rarities[i] || '';
                        const key = `${code}_${rarity}`;
                        if (!uniqueSetRarities.has(key)) {
                            uniqueSetRarities.set(key, { set_code: code, rarity: rarity });
                        }
                    });
                    
                    // Create buttons for unique combinations
                    Array.from(uniqueSetRarities.values()).forEach(data => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'btn btn-outline-primary btn-sm m-1 set-choice-btn';
                        btn.dataset.setCode = data.set_code; btn.dataset.rarity = data.rarity;
                        btn.textContent = `${data.set_code} (${data.rarity})`;
                        choicesEl.appendChild(btn);
                    });
                } else { choicesEl.textContent = 'ÂèéÈå≤ÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ'; }
                document.getElementById('url').value = '';
            } catch (err) { alert(`„Ç®„É©„Éº: ${err.message}`); } finally { showLoading(false); }
        });
        document.getElementById('set-rarity-choices').addEventListener('click', (e) => {
            if (e.target.classList.contains('set-choice-btn')) {
                document.getElementById('set_code').value = e.target.dataset.setCode;
                document.getElementById('rarity').value = e.target.dataset.rarity;
            }
        });
    </script>
</body>
</html>

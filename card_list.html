<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ã‚«ãƒ¼ãƒ‰ç®¡ç†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="mobile-responsive.css">
    <style>
        body { background-color: #f8f9fa; }
        [data-bs-theme="dark"] body { background-color: #212529; }
        .container-fluid { max-width: 1400px; }
        .card { margin-bottom: 1.5rem; }
        .table-responsive { max-height: 500px; }
        #loading-overlay, #app-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1060;
            color: white;
        }
        .set-choice-btn { cursor: pointer; }
        #main-app { display: none; } /* Hide app until logged in */
        
        /* Tag display optimization */
        .tag-cell {
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .tag-cell:hover {
            white-space: normal;
            word-wrap: break-word;
        }
        
        /* Draggable tags styles */
        .draggable-tag {
            cursor: move;
            transition: background-color 0.2s;
        }
        .draggable-tag:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }
        .draggable-tag.dragging {
            opacity: 0.5;
        }
        .drag-over {
            border-top: 2px solid #007bff;
        }
        
        /* Achievement badge styles */
        .achievement-summary {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .achievement-summary:hover {
            background: rgba(0, 123, 255, 0.1);
            transform: translateX(5px);
        }
        .achievement-progress {
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }
        .achievement-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #dee2e6;
            transition: all 0.3s;
        }
        .achievement-dot.unlocked {
            background: #28a745;
            box-shadow: 0 0 4px rgba(40, 167, 69, 0.5);
        }
        .achievement-details {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
        }
        .achievement-details.show {
            display: block;
            animation: slideDown 0.3s;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .achievement-badge {
            position: relative;
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 500;
            margin: 0.25rem;
            cursor: help;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .achievement-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .achievement-badge.locked {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: #adb5bd;
            opacity: 0.6;
        }
        .achievement-badge.bronze {
            background: linear-gradient(135deg, #cd7f32 0%, #a0522d 100%);
            color: white;
        }
        .achievement-badge.silver {
            background: linear-gradient(135deg, #c0c0c0 0%, #808080 100%);
            color: white;
        }
        .achievement-badge.gold {
            background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%);
            color: #333;
            animation: shine 3s infinite;
        }
        .achievement-badge.platinum {
            background: linear-gradient(135deg, #e5e4e2 0%, #bbb 100%);
            color: #333;
            animation: shine 2s infinite;
        }
        .achievement-badge.diamond {
            background: linear-gradient(135deg, #b9f2ff 0%, #00d4ff 100%);
            color: white;
            animation: sparkle 2s infinite;
        }
        .achievement-badge.mythic {
            background: linear-gradient(135deg, #ff00ff 0%, #00ffff 50%, #ffff00 100%);
            color: white;
            animation: rainbow 3s infinite;
        }
        @keyframes rainbow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
        @keyframes sparkle {
            0%, 100% { box-shadow: 0 0 10px rgba(185, 242, 255, 0.8); }
            50% { box-shadow: 0 0 20px rgba(0, 212, 255, 1); }
        }
        @keyframes shine {
            0% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
            100% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
        }
        
        /* Rarity bar styles */
        .rarity-bar {
            height: 100px;
            flex: 0 0 auto;
            min-width: 40px;
            background: linear-gradient(to top, var(--bar-color) 0%, var(--bar-color) var(--bar-height), transparent var(--bar-height));
            position: relative;
            border-radius: 4px 4px 0 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding: 4px;
        }
        .rarity-bar-label {
            font-size: 0.7rem;
            margin-top: 4px;
            text-align: center;
        }
        .rarity-bar-count {
            font-weight: bold;
            font-size: 0.9rem;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        /* Rarity bars container */
        #rarity-bars {
            display: flex;
            gap: 0.25rem;
            align-items: flex-end;
            justify-content: flex-start;
            min-height: 120px;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 5px;
            width: 100%;
            max-width: 100%;
        }
        
        /* Rarity chart container */
        #rarity-chart-container {
            width: 100%;
            overflow: hidden;
            position: relative;
        }
        
        /* Custom scrollbar for rarity bars */
        #rarity-bars::-webkit-scrollbar {
            height: 6px;
        }
        
        #rarity-bars::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }
        
        #rarity-bars::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
        }
        
        #rarity-bars::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.5);
        }
        
        /* Mobile responsive for rarity bars */
        @media (max-width: 768px) {
            #rarity-bars {
                gap: 0.15rem;
                -webkit-overflow-scrolling: touch;
                justify-content: flex-start;
                flex-wrap: nowrap;
            }
            
            .rarity-bar {
                min-width: 35px;
                height: 80px;
                padding: 2px;
            }
            
            .rarity-bar-label {
                font-size: 0.6rem;
                margin-top: 2px;
            }
            
            .rarity-bar-count {
                font-size: 0.75rem;
            }
        }
        
        @media (max-width: 576px) {
            #rarity-chart-container {
                margin-top: 0.5rem !important;
                padding: 0 5px;
                max-width: 100%;
            }
            
            #rarity-bars {
                gap: 0.1rem;
                min-height: 100px;
                padding: 0 2px 5px 2px;
                max-width: calc(100vw - 40px);
                margin: 0 auto;
            }
            
            .rarity-bar {
                min-width: 30px;
                height: 70px;
                padding: 1px;
                border-radius: 3px 3px 0 0;
            }
            
            .rarity-bar-label {
                font-size: 0.55rem;
                margin-top: 1px;
                line-height: 1;
            }
            
            .rarity-bar-count {
                font-size: 0.65rem;
                line-height: 1;
            }
        }
        
        @media (max-width: 400px) {
            #rarity-chart-container {
                padding: 0 3px;
            }
            
            #rarity-bars {
                gap: 2px;
                min-height: 90px;
                max-width: calc(100vw - 30px);
            }
            
            .rarity-bar {
                min-width: 25px;
                height: 60px;
            }
            
            .rarity-bar-label {
                font-size: 0.5rem;
                word-break: break-all;
            }
            
            .rarity-bar-count {
                font-size: 0.6rem;
            }
        }
        
        /* Milestone notification styles */
        .milestone-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1070;
            animation: slideIn 0.5s, slideOut 0.5s 4.5s;
            animation-fill-mode: forwards;
        }
        @keyframes slideIn {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }
        @keyframes slideOut {
            from { transform: translateX(0); }
            to { transform: translateX(400px); }
        }
        
        /* Fun dashboard styles */
        .mission-item {
            transition: all 0.3s;
            cursor: pointer;
        }
        .mission-item:hover {
            background: rgba(0, 123, 255, 0.1);
        }
        .mission-item.completed {
            background: rgba(40, 167, 69, 0.1);
            text-decoration: line-through;
        }
        .mission-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        /* Custom theme styles */
        body.theme-light-blue {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }
        body.theme-mint {
            background: linear-gradient(135deg, #c8e6c9 0%, #81c784 100%);
        }
        body.theme-peach {
            background: linear-gradient(135deg, #ffccbc 0%, #ffab91 100%);
        }
        body.theme-ocean {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        body.theme-forest {
            background: linear-gradient(135deg, #0ba360 0%, #3cba92 100%);
        }
        body.theme-sunset {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        body.theme-galaxy {
            background: linear-gradient(135deg, #4776E6 0%, #8E54E9 100%);
        }
        body.theme-cherry {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }
        body.theme-midnight {
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: #e0e0e0;
        }
        body.theme-sakura {
            background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);
        }
        body.theme-fire {
            background: linear-gradient(135deg, #ff9a56 0%, #ff6a88 50%, #ff2d55 100%);
        }
        body.theme-aurora {
            background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 50%, #00d2ff 100%);
        }
        body.theme-neon {
            background: linear-gradient(135deg, #f953c6 0%, #b91d73 100%);
            color: #fff;
        }
        body.theme-cosmic {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f953c6 100%);
        }
        body.theme-rainbow {
            background: linear-gradient(135deg, #ff0000 0%, #ff7f00 17%, #ffff00 33%, #00ff00 50%, #0000ff 67%, #4b0082 83%, #9400d3 100%);
        }
        body.theme-holographic {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 25%, #ffeaa7 50%, #dfe6e9 75%, #a8edea 100%);
            background-size: 400% 400%;
            animation: holographic-shift 8s ease infinite;
        }
        body.theme-dragon-soul {
            background: linear-gradient(135deg, #f83600 0%, #f9d423 50%, #f83600 100%);
            background-size: 200% 200%;
            animation: dragon-pulse 5s ease infinite;
        }
        body.theme-legendary {
            background: linear-gradient(135deg, #ffd700 0%, #ff6347 25%, #ff1493 50%, #00ced1 75%, #ffd700 100%);
            background-size: 300% 300%;
            animation: legendary-shift 10s ease infinite;
        }
        
        @keyframes holographic-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes dragon-pulse {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes legendary-shift {
            0% { background-position: 0% 50%; }
            33% { background-position: 100% 50%; }
            66% { background-position: 50% 100%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Frame Effects */
        body.frame-gold .card {
            border: 3px solid gold !important;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }
        body.frame-rainbow .card {
            border: 3px solid transparent !important;
            background: linear-gradient(white, white) padding-box,
                       linear-gradient(45deg, red, orange, yellow, green, blue, indigo, violet) border-box;
            animation: rainbow-border 3s linear infinite;
        }
        body.frame-diamond .card {
            border: 3px solid silver !important;
            box-shadow: 0 0 20px rgba(192, 192, 192, 0.8);
            position: relative;
        }
        body.frame-fire .card {
            border: 3px solid #ff4500 !important;
            box-shadow: 0 0 20px rgba(255, 69, 0, 0.6);
            animation: fire-glow 2s ease-in-out infinite;
        }
        body.frame-ice .card {
            border: 3px solid #00bfff !important;
            box-shadow: 0 0 20px rgba(0, 191, 255, 0.6);
        }
        body.frame-electric .card {
            border: 3px solid #ffff00 !important;
            box-shadow: 0 0 15px rgba(255, 255, 0, 0.8);
            animation: electric-pulse 1s linear infinite;
        }
        
        /* Additional Frame Styles */
        body.frame-simple .card {
            border: 2px solid #333 !important;
        }
        body.frame-bold .card {
            border: 4px solid #000 !important;
        }
        body.frame-dotted .card {
            border: 3px dotted #666 !important;
        }
        body.frame-silver .card {
            border: 3px solid #C0C0C0 !important;
            box-shadow: 0 0 10px rgba(192, 192, 192, 0.5);
        }
        body.frame-nature .card {
            border: 3px solid #228B22 !important;
            box-shadow: 0 0 15px rgba(34, 139, 34, 0.4);
        }
        body.frame-plasma .card {
            border: 3px solid #8A2BE2 !important;
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.6);
            animation: plasma-glow 2s ease-in-out infinite;
        }
        body.frame-crystal .card {
            border: 3px solid #87CEEB !important;
            box-shadow: 0 0 25px rgba(135, 206, 235, 0.7), inset 0 0 10px rgba(255, 255, 255, 0.3);
        }
        body.frame-legendary .card {
            border: 4px solid transparent !important;
            background: linear-gradient(white, white) padding-box,
                       linear-gradient(45deg, gold, #ff6347, #ff1493, gold) border-box;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            animation: legendary-shimmer 3s linear infinite;
        }
        body.frame-mythic .card {
            border: 4px solid transparent !important;
            background: linear-gradient(white, white) padding-box,
                       linear-gradient(90deg, #9400D3, #4B0082, #0000FF, #00FFFF, #0000FF, #4B0082, #9400D3) border-box;
            box-shadow: 0 0 35px rgba(148, 0, 211, 0.8);
            animation: mythic-pulse 4s ease-in-out infinite;
        }
        
        /* Background Patterns */
        body.bg-stars::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="10" cy="10" r="1" fill="white" opacity="0.5"/><circle cx="30" cy="20" r="1" fill="white" opacity="0.7"/><circle cx="50" cy="15" r="1.5" fill="white" opacity="0.6"/><circle cx="70" cy="25" r="1" fill="white" opacity="0.8"/><circle cx="90" cy="10" r="1" fill="white" opacity="0.5"/></svg>');
            background-repeat: repeat;
            pointer-events: none;
            z-index: -1;
            opacity: 0.3;
        }
        body.bg-clouds {
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 100"><ellipse cx="50" cy="50" rx="40" ry="20" fill="white" opacity="0.2"/><ellipse cx="150" cy="30" rx="50" ry="25" fill="white" opacity="0.15"/></svg>');
            background-size: 200px 100px;
            background-repeat: repeat;
        }
        body.bg-geometric::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255,255,255,.1) 35px, rgba(255,255,255,.1) 70px);
            pointer-events: none;
            z-index: -1;
        }
        body.bg-gradient {
            background: linear-gradient(270deg, #a8edea, #fed6e3, #ffd3b6, #ffaaa5);
            background-size: 800% 800%;
            animation: gradient-shift 15s ease infinite;
        }
        body.bg-particles {
            position: relative;
            overflow: hidden;
        }
        body.bg-waves::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%230099ff" fill-opacity="0.1" d="M0,32L48,53.3C96,75,192,117,288,122.7C384,128,480,96,576,90.7C672,85,768,107,864,128C960,149,1056,171,1152,165.3C1248,160,1344,128,1392,112L1440,96L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>');
            background-repeat: repeat-x;
            background-position: bottom;
            pointer-events: none;
            z-index: -1;
        }
        
        /* Animations */
        @keyframes rainbow-border {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
        @keyframes fire-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 69, 0, 0.6); }
            50% { box-shadow: 0 0 30px rgba(255, 140, 0, 0.8); }
        }
        @keyframes electric-pulse {
            0%, 100% { box-shadow: 0 0 15px rgba(255, 255, 0, 0.8); }
            50% { box-shadow: 0 0 25px rgba(255, 255, 0, 1); }
        }
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Additional Background Styles */
        body.bg-dots {
            background-image: radial-gradient(circle, #333 1px, transparent 1px);
            background-size: 20px 20px;
        }
        body.bg-stripes {
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255, 255, 255, 0.1) 10px,
                rgba(255, 255, 255, 0.1) 20px
            );
        }
        body.bg-checker {
            background-image: 
                linear-gradient(45deg, #ccc 25%, transparent 25%), 
                linear-gradient(-45deg, #ccc 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #ccc 75%), 
                linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        body.bg-hexagon {
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><polygon points="50,10 90,30 90,70 50,90 10,70 10,30" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></svg>');
            background-size: 100px 100px;
        }
        body.bg-circuit {
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M10,10 L30,10 L30,30 L50,30 M70,30 L90,30 L90,50 M10,70 L30,70 L30,90 L50,90" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/><circle cx="50" cy="30" r="3" fill="rgba(255,255,255,0.2)"/><circle cx="50" cy="90" r="3" fill="rgba(255,255,255,0.2)"/></svg>');
            background-size: 100px 100px;
        }
        body.bg-galaxy {
            background: radial-gradient(ellipse at center, #1e3c72 0%, #2a5298 50%, #0e1538 100%);
        }
        body.bg-aurora {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #667eea 75%, #764ba2 100%);
            background-size: 400% 400%;
            animation: aurora-shift 10s ease infinite;
        }
        body.bg-crystal {
            background: linear-gradient(135deg, #667eea 0%, rgba(118, 75, 162, 0.5) 50%, #667eea 100%),
                        repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255,255,255,.05) 35px, rgba(255,255,255,.05) 70px);
        }
        body.bg-matrix {
            background: #000;
            background-image: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                #0F0 2px,
                #0F0 3px
            );
            background-size: 100% 20px;
            animation: matrix-rain 5s linear infinite;
        }
        body.bg-nebula {
            background: radial-gradient(ellipse at top left, #ff00ff 0%, transparent 50%),
                        radial-gradient(ellipse at bottom right, #00ffff 0%, transparent 50%),
                        radial-gradient(ellipse at center, #1e3c72 0%, #0e1538 100%);
        }
        body.bg-dimension {
            background: linear-gradient(45deg, #1e3c72, #2a5298, #7e8aa2, #2a5298, #1e3c72);
            background-size: 500% 500%;
            animation: dimension-shift 20s ease infinite;
        }
        body.bg-void {
            background: radial-gradient(circle at center, #0a0a0a 0%, #000 50%, #000 100%);
        }
        body.bg-infinity {
            background: conic-gradient(from 0deg at 50% 50%, #667eea, #764ba2, #f093fb, #f5576c, #667eea);
            animation: infinity-rotate 10s linear infinite;
        }
        
        /* Additional animations for backgrounds and frames */
        @keyframes aurora-shift {
            0% { background-position: 0% 0%; }
            50% { background-position: 100% 100%; }
            100% { background-position: 0% 0%; }
        }
        @keyframes matrix-rain {
            0% { background-position: 0 0; }
            100% { background-position: 0 20px; }
        }
        @keyframes dimension-shift {
            0% { background-position: 0% 50%; }
            25% { background-position: 100% 50%; }
            50% { background-position: 100% 100%; }
            75% { background-position: 0% 100%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes infinity-rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes plasma-glow {
            0% { box-shadow: 0 0 20px rgba(138, 43, 226, 0.6); }
            50% { box-shadow: 0 0 30px rgba(138, 43, 226, 0.9), 0 0 50px rgba(138, 43, 226, 0.4); }
            100% { box-shadow: 0 0 20px rgba(138, 43, 226, 0.6); }
        }
        @keyframes legendary-shimmer {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }
        @keyframes mythic-pulse {
            0% { box-shadow: 0 0 35px rgba(148, 0, 211, 0.8); }
            50% { box-shadow: 0 0 50px rgba(148, 0, 211, 1), 0 0 70px rgba(0, 255, 255, 0.5); }
            100% { box-shadow: 0 0 35px rgba(148, 0, 211, 0.8); }
        }
        
        /* Icon Styles */
        body.icon-crown .collector-rank::after {
            content: 'ğŸ‘‘';
            margin-left: 5px;
        }
        body.icon-star .collector-rank::after {
            content: 'â­';
            margin-left: 5px;
        }
        body.icon-dragon .collector-rank::after {
            content: 'ğŸ‰';
            margin-left: 5px;
        }
        body.icon-phoenix .collector-rank::after {
            content: 'ğŸ”¥ğŸ¦…';
            margin-left: 5px;
        }
        body.icon-sword .collector-rank::after {
            content: 'âš”ï¸';
            margin-left: 5px;
        }
        
        /* Shop modal styles */
        .shop-item {
            border: 2px solid transparent;
            transition: all 0.3s;
            cursor: pointer;
        }
        .shop-item:hover {
            border-color: #ffc107;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .shop-item.purchased {
            background: #e8f5e9;
            border-color: #4caf50;
        }
        .shop-item.active {
            border-color: #007bff;
            background: #e3f2fd;
        }
        .shop-item.locked {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .shop-item.locked:hover {
            transform: none;
            border-color: transparent;
        }
        
        /* Point animation */
        @keyframes pointGain {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-30px) scale(1.5); opacity: 0; }
        }
        .point-animation {
            position: fixed;
            color: #ffc107;
            font-weight: bold;
            font-size: 1.5rem;
            z-index: 9999;
            pointer-events: none;
            animation: pointGain 1s ease-out;
        }
        
        /* Table header responsive styles */
        .table th {
            white-space: nowrap;
            min-width: fit-content;
        }
        
        /* Ensure navbar buttons have consistent height */
        .navbar-nav .btn,
        .navbar-nav .dropdown > .btn {
            height: 38px;
            display: inline-flex;
            align-items: center;
        }
        
        /* Pagination controls responsive */
        #pagination-controls,
        #pagination-controls-bottom {
            font-size: 0.9rem;
        }
        
        /* Mobile responsive styles */
        @media (max-width: 768px) {
            .navbar-brand { font-size: 1rem; }
            .navbar-text { display: none !important; }
            .btn-group-mobile { 
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }
            .table { font-size: 0.875rem; }
            .table th {
                padding: 0.5rem 0.25rem;
                font-size: 0.8rem;
            }
            .table th i {
                font-size: 0.7rem;
            }
            .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
            .modal-dialog { margin: 0.5rem; }
            .nav-tabs .nav-link { padding: 0.5rem 0.75rem; font-size: 0.875rem; }
            .dropdown-menu { font-size: 0.875rem; }
        }
        
        @media (max-width: 576px) {
            .container-fluid { padding: 0.5rem; }
            .card-body { padding: 1rem; }
            .table-responsive { 
                max-height: 400px;
                overflow-x: auto;
            }
            .table th {
                padding: 0.4rem 0.2rem;
                font-size: 0.75rem;
            }
            .table td {
                padding: 0.4rem 0.2rem;
                font-size: 0.8rem;
            }
            
            /* Mobile card list improvements */
            /* Card name column - allow wrapping */
            .table tbody td:nth-child(2) {
                max-width: 100px;
                word-wrap: break-word;
                word-break: break-word;
                white-space: normal;
                line-height: 1.3;
                font-size: 0.75rem;
            }
            
            /* Set code column */
            .table tbody td:nth-child(3) {
                font-size: 0.7rem;
                max-width: 70px;
                word-break: break-all;
            }
            
            /* Show rarity on mobile */
            .table thead th:nth-child(4),
            .table tbody td:nth-child(4) {
                display: table-cell !important;
                font-size: 0.65rem;
                max-width: 50px;
            }
            
            /* Quantity column */
            .table tbody td:nth-child(5) {
                font-size: 0.8rem;
                font-weight: bold;
                text-align: center;
                min-width: 30px;
            }
            
            /* Hide tags column on mobile */
            .table thead th:nth-child(6),
            .table tbody td:nth-child(6) {
                display: none !important;
            }
            
            /* Action buttons column */
            .table tbody td:last-child {
                min-width: 60px;
            }
            
            /* Make action buttons smaller */
            .table .btn-sm {
                font-size: 0.6rem;
                padding: 0.2rem 0.25rem;
                margin: 0 1px;
            }
            
            .table .btn-sm i {
                font-size: 0.7rem;
            }
            
            .navbar-toggler { padding: 0.25rem 0.5rem; }
            
            /* Pagination controls on small screens */
            #pagination-controls span,
            #pagination-controls-bottom span {
                font-size: 0.8rem;
            }
            #pagination-controls .btn-group,
            #pagination-controls-bottom .btn-group {
                flex-wrap: nowrap;
            }
            .d-flex.justify-content-between.align-items-center.mb-2 {
                flex-direction: column;
                gap: 0.5rem;
            }
            .d-flex.justify-content-between.align-items-center.mb-2 > * {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* Profile modal styles */
        .icon-select {
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            padding: 0;
            transition: all 0.2s;
        }
        
        .icon-select.active {
            background-color: var(--bs-primary);
            color: white;
            border-color: var(--bs-primary);
            transform: scale(1.1);
        }
        
        #profile-icon {
            font-size: 4rem;
            animation: bounce 2s ease-in-out infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
    </style>
</head>
<body>
    <!-- Full screen loader -->
    <div id="app-loader">
        <div class="spinner-border" style="width: 3rem; height: 3rem;" role="status"><span class="visually-hidden">Loading...</span></div>
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="auth-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">ãƒ­ã‚°ã‚¤ãƒ³ã¾ãŸã¯æ–°è¦ç™»éŒ²</h5></div>
            <div class="modal-body">
                <div id="auth-error" class="alert alert-danger" style="display: none;"></div>
                <form id="auth-form">
                    <div class="mb-3"><label for="email" class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label><input type="email" class="form-control" id="email" required></div>
                    <div class="mb-3"><label for="password" class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label><input type="password" class="form-control" id="password" required></div>
                    <div class="d-grid gap-2">
                        <button type="button" id="login-btn" class="btn btn-primary">ãƒ­ã‚°ã‚¤ãƒ³</button>
                        <button type="button" id="signup-btn" class="btn btn-secondary">æ–°è¦ç™»éŒ²</button>
                    </div>
                </form>
            </div>
        </div></div>
    </div>

    <!-- Edit Card Modal -->
    <div class="modal fade" id="edit-card-modal" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">ã‚«ãƒ¼ãƒ‰æƒ…å ±ã®ç·¨é›†</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="edit-form">
                    <input type="hidden" id="edit-card-id">
                    <div class="mb-3"><label class="form-label">åå‰</label><input type="text" id="edit-name" class="form-control" readonly disabled></div>
                    <div class="mb-3"><label class="form-label">å‹ç•ª</label><input type="text" id="edit-set-code" class="form-control" readonly disabled></div>
                    <div class="mb-3"><label class="form-label">ãƒ¬ã‚¢ãƒªãƒ†ã‚£</label><input type="text" id="edit-rarity" class="form-control" readonly disabled></div>
                    <div class="mb-3"><label for="edit-quantity" class="form-label">æšæ•°</label><input type="number" id="edit-quantity" class="form-control" min="1" required></div>
                    <div class="mb-3">
                        <label class="form-label">ã‚¿ã‚°</label>
                        <div id="edit-card-tags-container" class="mb-2"></div>
                        <div id="edit-tag-choices-container"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" id="save-edit-btn" class="btn btn-primary">å¤‰æ›´ã‚’ä¿å­˜</button>
            </div>
        </div></div>
    </div>

    <!-- How to Use Modal -->
    <div class="modal fade" id="how-to-use-modal" tabindex="-1">
        <div class="modal-dialog modal-xl"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> <strong>å…¬å¼ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</strong>ï¼š
                    <a href="https://www.db.yugioh-card.com/yugiohdb/card_search.action" target="_blank" class="alert-link">
                        éŠæˆ¯ç‹ã‚ªãƒ•ã‚£ã‚·ãƒ£ãƒ«ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’é–‹ã <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                </div>
                
                <h5 class="mt-4 mb-3"><i class="bi bi-1-circle-fill text-primary"></i> åˆã‚ã¦ã®æ–¹ã¸</h5>
                <div class="ms-3">
                    <h6><i class="bi bi-person-plus"></i> ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</h6>
                    <ol>
                        <li>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ã€Œæ–°è¦ç™»éŒ²ã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                        <li>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒä½œæˆã•ã‚Œã€è‡ªå‹•ã§ãƒ­ã‚°ã‚¤ãƒ³ã•ã‚Œã¾ã™</li>
                        <li>ãƒ‡ãƒ¼ã‚¿ã¯ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã•ã‚Œã€ã©ã®ç«¯æœ«ã‹ã‚‰ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™</li>
                    </ol>
                    <div class="alert alert-warning">
                        <small><i class="bi bi-exclamation-triangle"></i> ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ï¼šãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã€Œlocalã€ã¨å…¥åŠ›ã™ã‚‹ã¨ã€ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã›ãšãƒ–ãƒ©ã‚¦ã‚¶å†…ã§ã®ã¿ç®¡ç†ã§ãã¾ã™</small>
                    </div>
                </div>
                
                <h5 class="mt-4 mb-3"><i class="bi bi-2-circle-fill text-primary"></i> ã‚«ãƒ¼ãƒ‰ã®ç™»éŒ²æ–¹æ³•</h5>
                <div class="ms-3">
                    <h6><i class="bi bi-search"></i> æ–¹æ³•1ï¼šå…¬å¼DBã‹ã‚‰æ¤œç´¢</h6>
                    <ol>
                        <li>ã€Œã‚«ãƒ¼ãƒ‰åã§æ¤œç´¢ã€æ¬„ã«ã‚«ãƒ¼ãƒ‰åã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šã€Œã‚«ãƒ¡ãƒªã‚¢ã€ï¼‰</li>
                        <li>ã€Œæ¤œç´¢ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                        <li>æ¤œç´¢çµæœã‹ã‚‰ç›®çš„ã®ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠ</li>
                        <li>ã‚«ãƒ¼ãƒ‰æƒ…å ±ãŒè‡ªå‹•ã§å…¥åŠ›ã•ã‚Œã¾ã™</li>
                    </ol>
                    
                    <h6><i class="bi bi-link-45deg"></i> æ–¹æ³•2ï¼šURLã‹ã‚‰èª­ã¿è¾¼ã¿</h6>
                    <ol>
                        <li>å…¬å¼DBã§ã‚«ãƒ¼ãƒ‰ã‚’æ¤œç´¢ã—ã€ã‚«ãƒ¼ãƒ‰è©³ç´°ãƒšãƒ¼ã‚¸ã‚’é–‹ã</li>
                        <li>URLã‚’ã‚³ãƒ”ãƒ¼ï¼ˆä¾‹ï¼šhttps://www.db.yugioh-card.com/yugiohdb/card_search.action?ope=2&cid=...)</li>
                        <li>ã€Œå…¬å¼DB URLã€æ¬„ã«è²¼ã‚Šä»˜ã‘ã¦ã€Œèª­è¾¼ã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                        <li>è¤‡æ•°ã®å‹ç•ªãŒã‚ã‚‹å ´åˆã¯ã€è¡¨ç¤ºã•ã‚Œã‚‹ãƒœã‚¿ãƒ³ã‹ã‚‰é¸æŠ</li>
                    </ol>
                    
                    <h6><i class="bi bi-pencil"></i> æ–¹æ³•3ï¼šæ‰‹å‹•å…¥åŠ›</h6>
                    <p>ã‚«ãƒ¼ãƒ‰åã€å‹ç•ªã€ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã‚’ç›´æ¥å…¥åŠ›ã—ã¦ç™»éŒ²ã§ãã¾ã™</p>
                </div>
                
                <h5 class="mt-4 mb-3"><i class="bi bi-3-circle-fill text-primary"></i> ãƒªã‚¹ãƒˆã®ç¨®é¡</h5>
                <div class="ms-3">
                    <h6><i class="bi bi-collection"></i> æ‰€æŒã‚«ãƒ¼ãƒ‰</h6>
                    <p>å®Ÿéš›ã«æ‰€æŒã—ã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰ã‚’ç®¡ç†ã—ã¾ã™ã€‚æšæ•°ã‚’è¨˜éŒ²ã—ã€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å…¨ä½“ã‚’æŠŠæ¡ã§ãã¾ã™ã€‚</p>
                    
                    <h6><i class="bi bi-star"></i> ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆ</h6>
                    <p>ä»Šå¾Œå…¥æ‰‹ã—ãŸã„ã‚«ãƒ¼ãƒ‰ã‚’ç®¡ç†ã—ã¾ã™ã€‚å…¥æ‰‹ã—ãŸã‚‰ã€Œæ‰€æŒã‚«ãƒ¼ãƒ‰ã¸ç§»å‹•ã€ãƒœã‚¿ãƒ³ï¼ˆ<i class="bi bi-check-circle"></i>ï¼‰ã§ç°¡å˜ã«ç§»å‹•ã§ãã¾ã™ã€‚</p>
                </div>
                
                <h5 class="mt-4 mb-3"><i class="bi bi-4-circle-fill text-primary"></i> ã‚¿ã‚°æ©Ÿèƒ½</h5>
                <div class="ms-3">
                    <p>ã‚«ãƒ¼ãƒ‰ã«ã‚¿ã‚°ã‚’ä»˜ã‘ã¦åˆ†é¡ã§ãã¾ã™ã€‚ä¾‹ï¼šã€Œãƒ‡ãƒƒã‚­ç”¨ã€ã€Œãƒˆãƒ¬ãƒ¼ãƒ‰ç”¨ã€ã€Œã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã€ãªã©</p>
                    <ul>
                        <li>ã€Œã‚¿ã‚°ç®¡ç†ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã‚¿ã‚°ã‚’ä½œæˆï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°åŒæ™‚ä½œæˆå¯ï¼‰</li>
                        <li>ã‚«ãƒ¼ãƒ‰ç™»éŒ²ãƒ»ç·¨é›†æ™‚ã«ã‚¿ã‚°ã‚’é¸æŠ</li>
                        <li>ã‚¿ã‚°ã§æ¤œç´¢ã—ã¦çµã‚Šè¾¼ã¿å¯èƒ½</li>
                    </ul>
                </div>
                
                <h5 class="mt-4 mb-3"><i class="bi bi-5-circle-fill text-primary"></i> ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h5>
                <div class="ms-3">
                    <h6><i class="bi bi-download"></i> ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h6>
                    <ul>
                        <li><strong>JSONå½¢å¼</strong>ï¼šå…¨ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</li>
                        <li><strong>CSVå½¢å¼</strong>ï¼šExcelã§ç·¨é›†ãƒ»é–²è¦§å¯èƒ½</li>
                    </ul>
                    
                    <h6><i class="bi bi-upload"></i> ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h6>
                    <p>JSON/CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬ç™»éŒ²ã€‚é‡è¤‡ã™ã‚‹ã‚«ãƒ¼ãƒ‰ã¯æšæ•°ãŒåŠ ç®—ã•ã‚Œã¾ã™ã€‚</p>
                </div>
                
                <h5 class="mt-4 mb-3"><i class="bi bi-6-circle-fill text-primary"></i> ãã®ä»–ã®æ©Ÿèƒ½</h5>
                <div class="ms-3">
                    <h6><i class="bi bi-sort-down"></i> ä¸¦ã³æ›¿ãˆãƒ»æ¤œç´¢</h6>
                    <p>ã‚«ãƒ¼ãƒ‰ä¸€è¦§ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ä¸¦ã³æ›¿ãˆã€æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã§çµã‚Šè¾¼ã¿ãŒã§ãã¾ã™ã€‚</p>
                    
                    <h6><i class="bi bi-check2-square"></i> ä¸€æ‹¬ç·¨é›†</h6>
                    <p>è¤‡æ•°ã®ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ã€ã‚¿ã‚°ã®ä¸€æ‹¬è¿½åŠ ãƒ»å‰Šé™¤ã‚„ä¸€æ‹¬å‰Šé™¤ãŒå¯èƒ½ã§ã™ã€‚ã‚«ãƒ¼ãƒ‰ä¸€è¦§ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
                    
                    <h6><i class="bi bi-moon-stars"></i> ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</h6>
                    <p>ã€Œè¨­å®šã€ã‹ã‚‰ç”»é¢ã‚’ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚</p>
                    
                    <h6><i class="bi bi-phone"></i> ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ</h6>
                    <p>ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã‚„ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ã‚‚å¿«é©ã«åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã€ç”»é¢ã‚µã‚¤ã‚ºã«å¿œã˜ã¦è‡ªå‹•çš„ã«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãŒèª¿æ•´ã•ã‚Œã¾ã™ã€‚</p>
                </div>
            </div>
            <div class="modal-footer">
                <a href="https://www.db.yugioh-card.com/yugiohdb/card_search.action" target="_blank" class="btn btn-primary">
                    <i class="bi bi-box-arrow-up-right"></i> å…¬å¼DBã‚’é–‹ã
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
            </div>
        </div></div>
    </div>

    <!-- Ranking Modal -->
    <div class="modal fade" id="ranking-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-trophy"></i> ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Ranking Tabs -->
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#total-cards-ranking" type="button">
                                <i class="bi bi-stack"></i> ç·ã‚«ãƒ¼ãƒ‰æšæ•°
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#unique-cards-ranking" type="button">
                                <i class="bi bi-collection"></i> ç¨®é¡æ•°
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#streak-ranking" type="button">
                                <i class="bi bi-fire"></i> ã‚¹ãƒˆãƒªãƒ¼ã‚¯
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#points-ranking" type="button">
                                <i class="bi bi-coin"></i> ç²å¾—ãƒã‚¤ãƒ³ãƒˆ
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Ranking Tab Content -->
                    <div class="tab-content">
                        <!-- Total Cards Ranking -->
                        <div class="tab-pane fade show active" id="total-cards-ranking" role="tabpanel">
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle"></i> ç·ã‚«ãƒ¼ãƒ‰æšæ•°ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°
                            </div>
                            <div class="list-group" id="total-cards-ranking-list">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Unique Cards Ranking -->
                        <div class="tab-pane fade" id="unique-cards-ranking" role="tabpanel">
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle"></i> ã‚«ãƒ¼ãƒ‰ç¨®é¡æ•°ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°
                            </div>
                            <div class="list-group" id="unique-cards-ranking-list">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Streak Ranking -->
                        <div class="tab-pane fade" id="streak-ranking" role="tabpanel">
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle"></i> é€£ç¶šç™»éŒ²æ—¥æ•°ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°
                            </div>
                            <div class="list-group" id="streak-ranking-list">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Points Ranking -->
                        <div class="tab-pane fade" id="points-ranking" role="tabpanel">
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle"></i> ç´¯è¨ˆç²å¾—ãƒã‚¤ãƒ³ãƒˆã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°
                            </div>
                            <div class="list-group" id="points-ranking-list">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3 text-center">
                        <small class="text-muted">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¯1æ™‚é–“ã”ã¨ã«æ›´æ–°ã•ã‚Œã¾ã™</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Profile Modal -->
    <div class="modal fade" id="profile-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="bi bi-person-circle"></i> ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="profile-view" style="display: block;">
                        <div class="text-center mb-3">
                            <div class="display-1 mb-2" id="profile-icon">ğŸ‘¤</div>
                            <h4 id="profile-nickname">æœªè¨­å®š</h4>
                            <p class="text-muted" id="profile-user-id"></p>
                        </div>
                        
                        <div class="list-group">
                            <div class="list-group-item d-flex justify-content-between">
                                <span><i class="bi bi-calendar-check"></i> ç·åˆ©ç”¨æ—¥æ•°</span>
                                <strong id="profile-total-days">0æ—¥</strong>
                            </div>
                            <div class="list-group-item d-flex justify-content-between">
                                <span><i class="bi bi-clock-history"></i> åˆå›åˆ©ç”¨æ—¥</span>
                                <strong id="profile-first-use">-</strong>
                            </div>
                            <div class="list-group-item d-flex justify-content-between">
                                <span><i class="bi bi-clock"></i> æœ€çµ‚åˆ©ç”¨æ—¥</span>
                                <strong id="profile-last-use">-</strong>
                            </div>
                            <div class="list-group-item d-flex justify-content-between">
                                <span><i class="bi bi-collection"></i> ç·ã‚«ãƒ¼ãƒ‰æšæ•°</span>
                                <strong id="profile-total-cards">0æš</strong>
                            </div>
                            <div class="list-group-item d-flex justify-content-between">
                                <span><i class="bi bi-fire"></i> ç¾åœ¨ã®ã‚¹ãƒˆãƒªãƒ¼ã‚¯</span>
                                <strong id="profile-streak">0æ—¥</strong>
                            </div>
                            <div class="list-group-item d-flex justify-content-between">
                                <span><i class="bi bi-trophy"></i> æœ€é•·ã‚¹ãƒˆãƒªãƒ¼ã‚¯</span>
                                <strong id="profile-max-streak">0æ—¥</strong>
                            </div>
                            <div class="list-group-item d-flex justify-content-between">
                                <span><i class="bi bi-coin"></i> ç´¯è¨ˆç²å¾—ãƒã‚¤ãƒ³ãƒˆ</span>
                                <strong id="profile-total-points">0pt</strong>
                            </div>
                        </div>
                        
                        <div class="mt-3 text-center">
                            <button class="btn btn-primary" id="edit-profile-btn">
                                <i class="bi bi-pencil"></i> ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†
                            </button>
                        </div>
                    </div>
                    
                    <div id="profile-edit" style="display: none;">
                        <form id="profile-edit-form">
                            <div class="mb-3">
                                <label for="edit-nickname" class="form-label">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label>
                                <input type="text" class="form-control" id="edit-nickname" maxlength="20" required>
                                <small class="text-muted">æœ€å¤§20æ–‡å­—ã¾ã§</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">ã‚¢ã‚¤ã‚³ãƒ³é¸æŠ</label>
                                <div class="d-flex flex-wrap gap-2" id="profile-icon-selector">
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="ğŸ‘¤">ğŸ‘¤</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="ğŸ˜Š">ğŸ˜Š</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="ğŸ˜">ğŸ˜</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="ğŸ®">ğŸ®</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="ğŸ¯">ğŸ¯</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="â­">â­</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="ğŸ†">ğŸ†</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="ğŸ’">ğŸ’</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="ğŸ”¥">ğŸ”¥</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="âš¡">âš¡</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="ğŸŒŸ">ğŸŒŸ</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="ğŸ¨">ğŸ¨</button>
                                </div>
                            </div>
                            
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-success flex-grow-1">
                                    <i class="bi bi-check-circle"></i> ä¿å­˜
                                </button>
                                <button type="button" class="btn btn-secondary" id="cancel-edit-btn">
                                    <i class="bi bi-x-circle"></i> ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Point Shop Modal -->
    <div class="modal fade" id="point-shop-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="bi bi-shop"></i> ãƒã‚¤ãƒ³ãƒˆã‚·ãƒ§ãƒƒãƒ—</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-coin"></i> ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆ: <strong id="shop-current-points">0</strong> pt
                    </div>
                    
                    <!-- Shop Tabs -->
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#themes-tab" type="button">
                                <i class="bi bi-palette"></i> ãƒ†ãƒ¼ãƒ
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#frames-tab" type="button">
                                <i class="bi bi-border-all"></i> ãƒ•ãƒ¬ãƒ¼ãƒ 
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#backgrounds-tab" type="button">
                                <i class="bi bi-image"></i> èƒŒæ™¯
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#icons-tab" type="button">
                                <i class="bi bi-award"></i> ã‚¢ã‚¤ã‚³ãƒ³
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Shop Tab Content -->
                    <div class="tab-content">
                        <!-- Themes Tab -->
                        <div class="tab-pane fade show active" id="themes-tab" role="tabpanel">
                            <div class="row g-3" id="theme-shop-items">
                                <!-- Theme items will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Frames Tab -->
                        <div class="tab-pane fade" id="frames-tab" role="tabpanel">
                            <div class="row g-3" id="frame-shop-items">
                                <!-- Frame items will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Backgrounds Tab -->
                        <div class="tab-pane fade" id="backgrounds-tab" role="tabpanel">
                            <div class="row g-3" id="background-shop-items">
                                <!-- Background items will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Icons Tab -->
                        <div class="tab-pane fade" id="icons-tab" role="tabpanel">
                            <div class="row g-3" id="icon-shop-items">
                                <!-- Icon items will be populated here -->
                            </div>
                        </div>
                        
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Stats Info Modal -->
    <div class="modal fade" id="stats-info-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³çµ±è¨ˆã®èª¬æ˜</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6><i class="bi bi-trophy"></i> ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼ãƒ©ãƒ³ã‚¯</h6>
                    <ul>
                        <li><span class="badge bg-secondary">è¦‹ç¿’ã„</span> 0-9æš</li>
                        <li><span class="badge bg-secondary">åˆç´š</span> 10-49æš</li>
                        <li><span class="badge bg-primary">ä¸­ç´š</span> 50-99æš</li>
                        <li><span class="badge bg-success">ä¸Šç´š</span> 100-299æš</li>
                        <li><span class="badge bg-info">ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ</span> 300-499æš</li>
                        <li><span class="badge bg-warning">ãƒã‚¹ã‚¿ãƒ¼</span> 500-999æš</li>
                        <li><span class="badge bg-danger">ä¼èª¬</span> 1000-2499æš</li>
                        <li><span class="badge" style="background: linear-gradient(45deg, #51cf66, #12b886); color: white;">è³¢è€…</span> 2500-4999æš</li>
                        <li><span class="badge" style="background: linear-gradient(45deg, #ff6b6b, #ffd43b); color: white;">è‹±é›„</span> 5000-9999æš</li>
                        <li><span class="badge" style="background: linear-gradient(45deg, #845ef7, #5c7cfa); color: white;">è¦‡ç‹</span> 10000-24999æš</li>
                        <li><span class="badge" style="background: linear-gradient(45deg, #b9f2ff, #00d4ff); color: white;">å¤©å¸</span> 25000-49999æš</li>
                        <li><span class="badge" style="background: linear-gradient(45deg, #ffd700, #ff6b6b); color: white;">ç¥è©±</span> 50000-99999æš</li>
                        <li><span class="badge" style="background: linear-gradient(45deg, #ff00ff, #00ffff, #ffff00); color: white;">å‰µä¸–ç¥</span> 100000æšä»¥ä¸Š</li>
                    </ul>
                    
                    <h6><i class="bi bi-award"></i> å®Ÿç¸¾ãƒãƒƒã‚¸</h6>
                    <p>ã‚«ãƒ¼ãƒ‰ã®åé›†çŠ¶æ³ã«å¿œã˜ã¦æ§˜ã€…ãªå®Ÿç¸¾ãŒè§£é™¤ã•ã‚Œã¾ã™ï¼š</p>
                    <ul>
                        <li><strong>æšæ•°å®Ÿç¸¾</strong>: 10æšï½100,000æšã¾ã§13æ®µéš</li>
                        <li><strong>ç¨®é¡å®Ÿç¸¾</strong>: 5ç¨®é¡ï½1,000ç¨®é¡ã¾ã§8æ®µéš</li>
                        <li><strong>ãƒ¬ã‚¢ãƒªãƒ†ã‚£å®Ÿç¸¾</strong>: Rã€SRã€URã€SEã€ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã€ULã€QCSEåˆ¥</li>
                        <li><strong>ç¶™ç¶šå®Ÿç¸¾</strong>: 3æ—¥ï½730æ—¥ã¾ã§7æ®µéš</li>
                        <li><strong>ç‰¹æ®Šå®Ÿç¸¾</strong>: ä¸€æ—¥ã®è¿½åŠ æšæ•°ã€é€±é–“è¿½åŠ ã€ã‚¿ã‚°ç®¡ç†ãªã©</li>
                    </ul>
                    <p class="text-muted small">ã‚«ãƒ†ã‚´ãƒªã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©³ç´°ãªå®Ÿç¸¾ãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                    
                    <h6><i class="bi bi-bar-chart"></i> çµ±è¨ˆé …ç›®</h6>
                    <ul>
                        <li><strong>ç·ã‚«ãƒ¼ãƒ‰æšæ•°</strong>: æ‰€æŒã—ã¦ã„ã‚‹å…¨ã‚«ãƒ¼ãƒ‰ã®åˆè¨ˆæšæ•°</li>
                        <li><strong>ç¨®é¡æ•°</strong>: ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªã‚«ãƒ¼ãƒ‰ã®ç¨®é¡æ•°</li>
                        <li><strong>åé›†æ—¥æ•°</strong>: æœ€åˆã®ã‚«ãƒ¼ãƒ‰ç™»éŒ²ã‹ã‚‰ã®çµŒéæ—¥æ•°</li>
                        <li><strong>ä»Šé€±è¿½åŠ </strong>: éå»7æ—¥é–“ã«è¿½åŠ ã—ãŸã‚«ãƒ¼ãƒ‰æšæ•°</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Settings Modal -->
    <div class="modal fade" id="settings-modal" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">è¨­å®š</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="dark-mode-toggle">
                    <label class="form-check-label" for="dark-mode-toggle">ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</label>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="hide-email-toggle">
                    <label class="form-check-label" for="hide-email-toggle">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’éè¡¨ç¤º</label>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="hide-stats-toggle">
                    <label class="form-check-label" for="hide-stats-toggle">ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³çµ±è¨ˆã‚’éè¡¨ç¤º</label>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="show-search-history-toggle">
                    <label class="form-check-label" for="show-search-history-toggle">å‰å›ã®æ¤œç´¢å±¥æ­´ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º</label>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="show-registration-history-toggle">
                    <label class="form-check-label" for="show-registration-history-toggle">å‰å›ã®ç™»éŒ²å±¥æ­´ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º</label>
                </div>
                <hr>
                <h6>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤</h6>
                <p class="text-muted small">ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ç´ã¥ãå…¨ã¦ã®ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚</p>
                <button class="btn btn-danger" id="delete-account-btn">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã™ã‚‹</button>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button></div>
        </div></div>
    </div>

    <!-- Tag Management Modal -->
    <div class="modal fade" id="tag-management-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ã‚¿ã‚°ç®¡ç†</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>æ–°ã—ã„ã‚¿ã‚°ã‚’è¿½åŠ </h6>
                    <form id="add-tag-form" class="input-group mb-3">
                        <input type="text" id="new-tag-name" class="form-control" placeholder="æ–°ã—ã„ã‚¿ã‚°åï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°å…¥åŠ›å¯ï¼‰" required>
                        <button class="btn btn-primary" type="submit">è¿½åŠ </button>
                    </form>
                    <hr>
                    <h6>ç™»éŒ²æ¸ˆã¿ã‚¿ã‚°ä¸€è¦§</h6>
                    <small class="text-muted">â€»ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§é †ç•ªã‚’å¤‰æ›´ã§ãã¾ã™</small>
                    <div id="existing-tags-list" class="mt-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bulk Tag Edit Modal -->
    <div class="modal fade" id="bulk-tag-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bulk-tag-modal-title">ã‚¿ã‚°ä¸€æ‹¬ç·¨é›†</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="bulk-tag-modal-desc"></p>
                    <div id="bulk-tag-choices-container"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-primary" id="bulk-tag-save-btn">é©ç”¨</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app">
        <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4" data-bs-theme="light">
            <div class="container-fluid">
                <span class="navbar-brand"><i class="bi bi-layers-fill"></i> ã‚«ãƒ¼ãƒ‰ç®¡ç†</span>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarContent">
                    <div class="navbar-nav ms-auto d-flex flex-row flex-wrap gap-2 mt-2 mt-lg-0">
                        <button class="btn btn-outline-info btn-sm" id="how-to-use-btn">
                            <i class="bi bi-question-circle"></i>
                            <span class="d-none d-sm-inline"> ä½¿ã„æ–¹</span>
                        </button>
                        <div class="dropdown d-inline-block">
                            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-database"></i>
                                <span class="d-none d-sm-inline"> ãƒ‡ãƒ¼ã‚¿ç®¡ç†</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><button class="dropdown-item" id="import-json-btn">JSONã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button></li>
                                <li><button class="dropdown-item" id="import-csv-btn">CSVã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><button class="dropdown-item" id="export-json-btn">JSONå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button></li>
                                <li><button class="dropdown-item" id="export-csv-btn">CSVå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button></li>
                            </ul>
                        </div>
                        <input type="file" id="import-file-input" accept=".json,.csv" style="display: none;">
                        <button class="btn btn-outline-secondary btn-sm" id="tag-management-btn">
                            <i class="bi bi-tags"></i>
                            <span class="d-none d-sm-inline"> ã‚¿ã‚°</span>
                        </button>
                        <button class="btn btn-outline-primary btn-sm" id="ranking-btn">
                            <i class="bi bi-trophy"></i>
                            <span class="d-none d-sm-inline"> ãƒ©ãƒ³ã‚­ãƒ³ã‚°</span>
                        </button>
                        <button class="btn btn-outline-info btn-sm" id="profile-btn">
                            <i class="bi bi-person-circle"></i>
                            <span class="d-none d-sm-inline"> ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</span>
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" id="settings-btn">
                            <i class="bi bi-gear"></i>
                            <span class="d-none d-sm-inline"> è¨­å®š</span>
                        </button>
                        <span class="navbar-text d-none d-md-inline mx-2" id="user-email"></span>
                        <button id="logout-btn" class="btn btn-danger btn-sm">
                            <i class="bi bi-box-arrow-right"></i>
                            <span class="d-none d-sm-inline"> ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="container-fluid">
             <div id="loading-overlay" style="display: none;"><div class="spinner-border" role="status"></div></div>
            <div class="row">
                <!-- Left Column: Add Card -->
                <div class="col-lg-5">
                    <div class="card">
                        <div class="card-header">ã‚«ãƒ¼ãƒ‰ç™»éŒ²</div>
                        <div class="card-body">
                            <form id="add-form">
                                <div class="mb-3">
                                    <label for="card-search" class="form-label">ã‚«ãƒ¼ãƒ‰åã§æ¤œç´¢</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="card-search" placeholder="ã‚«ãƒ¼ãƒ‰åã‚’å…¥åŠ›">
                                        <button class="btn btn-success" type="button" id="search-db-btn">æ¤œç´¢</button>
                                        <button class="btn btn-outline-secondary" type="button" id="prev-search-btn" style="display: none;" title="å‰å›ã®æ¤œç´¢">
                                            <i class="bi bi-clock-history"></i>
                                        </button>
                                    </div>
                                    <div id="search-results" class="mt-2"></div>
                                </div>
                                <div class="mb-3">
                                    <label for="url" class="form-label">å…¬å¼DB URL</label>
                                    <div class="input-group">
                                        <input type="url" class="form-control" id="url" placeholder="URLã‚’ãƒšãƒ¼ã‚¹ãƒˆ (Ctrl+V)...">
                                        <button class="btn btn-primary" type="button" id="fetch-btn">èª­è¾¼</button>
                                    </div>
                                </div>
                                <div class="mb-3"><label for="name" class="form-label">åå‰</label><input type="text" class="form-control" id="name" name="name" required></div>
                                <div class="mb-3">
                                    <label for="set_code" class="form-label">å‹ç•ª <small class="text-muted">(ä»»æ„)</small></label>
                                    <input type="text" class="form-control" id="set_code" name="set_code">
                                    <div id="set-rarity-choices" class="mt-2"></div>
                                </div>
                                <div class="mb-3"><label for="rarity" class="form-label">ãƒ¬ã‚¢ãƒªãƒ†ã‚£</label><input type="text" class="form-control" id="rarity" name="rarity"></div>
                                <div class="mb-3"><label for="quantity" class="form-label">æšæ•°</label><input type="number" class="form-control" id="quantity" name="quantity" value="1" min="1" required></div>
                                <div class="mb-3">
                                    <label class="form-label">ç™»éŒ²å…ˆ</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="add-type" id="add-to-collection" value="collection" checked>
                                        <label class="btn btn-outline-primary" for="add-to-collection">æ‰€æŒã‚«ãƒ¼ãƒ‰</label>
                                        <input type="radio" class="btn-check" name="add-type" id="add-to-wishlist" value="wishlist">
                                        <label class="btn btn-outline-warning" for="add-to-wishlist">ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆ</label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">ã‚¿ã‚°</label>
                                    <div id="card-tags-container" class="mb-2"></div>
                                    <div id="tag-choices-container"></div>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-success flex-grow-1">ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ </button>
                                    <button type="button" class="btn btn-outline-secondary" id="prev-registration-btn" style="display: none;" title="å‰å›ã®ç™»éŒ²å†…å®¹">
                                        <i class="bi bi-arrow-counterclockwise"></i>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Fun Dashboard -->
                    <div class="card mt-3" id="daily-challenges-card">
                        <div class="card-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-stars"></i> ä»Šæ—¥ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <button class="btn btn-sm btn-light" onclick="toggleDailyChallenges()" title="è¡¨ç¤º/éè¡¨ç¤º">
                                        <i class="bi bi-eye-slash" id="daily-challenges-toggle-icon"></i>
                                    </button>
                                    <div id="current-time" class="small"></div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body" id="daily-challenges-body">
                            <!-- Daily Missions -->
                            <div class="mb-3">
                                <h6 class="d-flex align-items-center mb-2">
                                    <i class="bi bi-flag-fill text-primary me-2"></i>
                                    ãƒ‡ã‚¤ãƒªãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³
                                </h6>
                                <div id="daily-missions" class="list-group list-group-flush">
                                    <!-- Missions will be populated here -->
                                </div>
                            </div>
                            
                            <!-- Registration Streak -->
                            <div class="mb-3">
                                <h6 class="d-flex align-items-center mb-2">
                                    <i class="bi bi-fire text-danger me-2"></i>
                                    ç™»éŒ²ã‚¹ãƒˆãƒªãƒ¼ã‚¯
                                </h6>
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-baseline">
                                            <span class="fs-2 fw-bold text-warning" id="streak-count">0</span>
                                            <span class="ms-2 text-muted">æ—¥é€£ç¶š</span>
                                        </div>
                                        <div class="progress mt-2" style="height: 10px;">
                                            <div class="progress-bar bg-warning" id="streak-progress" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted" id="streak-message"></small>
                                    </div>
                                    <div class="ms-3" id="streak-badge" style="font-size: 3rem;"></div>
                                </div>
                            </div>
                            
                            <!-- Quick Stats -->
                            <div class="row g-2 text-center">
                                <div class="col-6">
                                    <div class="p-2 bg-light rounded">
                                        <div class="fs-4 fw-bold text-primary" id="today-added">0</div>
                                        <small class="text-muted">ä»Šæ—¥è¿½åŠ </small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-2 bg-light rounded">
                                        <div class="fs-4 fw-bold text-success" id="week-goal-progress">0%</div>
                                        <small class="text-muted">é€±é–“ç›®æ¨™</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Search/List and Stats -->
                <div class="col-lg-7">
                    <!-- Card List -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <ul class="nav nav-tabs card-header-tabs">
                                <li class="nav-item">
                                    <a class="nav-link active" id="collection-tab" data-list-type="collection" href="#">æ‰€æŒã‚«ãƒ¼ãƒ‰ (<span id="total-collection">0</span>)</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="wishlist-tab" data-list-type="wishlist" href="#">ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆ (<span id="total-wishlist">0</span>)</a>
                                </li>
                            </ul>
                        </div>
                        <div class="card-body">
                            <form id="search-form" class="row g-3 mb-4">
                                <div class="col-md-6"><input type="text" name="search_name" class="form-control" placeholder="åå‰..."></div>
                                <div class="col-md-6"><input type="text" name="search_set_code" class="form-control" placeholder="å‹ç•ª..."></div>
                                <div class="col-md-6"><input type="text" name="search_rarity" class="form-control" placeholder="ãƒ¬ã‚¢ãƒªãƒ†ã‚£..."></div>
                                <div class="col-md-6"><input type="text" name="search_tags" class="form-control" placeholder="ã‚¿ã‚°..."></div>
                                <div class="col-12 d-grid"><button type="submit" class="btn btn-info">æ¤œç´¢</button></div>
                            </form>
                            
                            <!-- Bulk edit controls -->
                            <div id="bulk-edit-controls" class="alert alert-info mb-2" style="display: none;">
                                <div class="d-flex flex-wrap align-items-center gap-2">
                                    <span id="selected-count">0ä»¶é¸æŠ</span>
                                    <button class="btn btn-sm btn-outline-primary" id="bulk-add-tags-btn">
                                        <i class="bi bi-tags"></i> ã‚¿ã‚°è¿½åŠ 
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning" id="bulk-remove-tags-btn">
                                        <i class="bi bi-tags"></i> ã‚¿ã‚°å‰Šé™¤
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" id="bulk-delete-btn">
                                        <i class="bi bi-trash"></i> ä¸€æ‹¬å‰Šé™¤
                                    </button>
                                    <button class="btn btn-sm btn-secondary" id="clear-selection-btn">
                                        <i class="bi bi-x-circle"></i> é¸æŠè§£é™¤
                                    </button>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="input-group w-auto">
                                    <label class="input-group-text" for="items-per-page">è¡¨ç¤ºä»¶æ•°</label>
                                    <select class="form-select" id="items-per-page">
                                        <option value="10">10</option>
                                        <option value="20">20</option>
                                        <option value="50" selected>50</option>
                                        <option value="100">100</option>
                                    </select>
                                </div>
                                <div id="pagination-controls"></div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th scope="col" style="width: 30px; min-width: 30px;">
                                                <input type="checkbox" id="select-all-checkbox" class="form-check-input">
                                            </th>
                                            <th scope="col" data-sort="åå‰" class="sortable">åå‰<i class="bi bi-arrow-down-up ms-1"></i></th>
                                            <th scope="col" data-sort="å‹ç•ª" class="sortable">å‹ç•ª<i class="bi bi-arrow-down-up ms-1"></i></th>
                                            <th scope="col" data-sort="ãƒ¬ã‚¢ãƒªãƒ†ã‚£" class="sortable">ãƒ¬ã‚¢<i class="bi bi-arrow-down-up ms-1"></i></th>
                                            <th scope="col" data-sort="æšæ•°" class="sortable" style="min-width: 50px;">æšæ•°<i class="bi bi-arrow-down-up ms-1"></i></th>
                                            <th scope="col" data-sort="tags" class="d-none d-sm-table-cell">ã‚¿ã‚°</th>
                                            <th scope="col" style="min-width: 80px;">æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="card-table-body"></tbody>
                                </table>
                            </div>
                            <div class="d-flex justify-content-center mt-2">
                                <div id="pagination-controls-bottom"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Points System -->
                    <div class="card mt-3">
                        <div class="card-body">
                            <div class="alert alert-light border-start border-5 border-warning mb-0" role="alert">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-coin text-warning me-2" style="font-size: 1.5rem;"></i>
                                        <div>
                                            <strong>ãƒã‚¤ãƒ³ãƒˆ</strong>
                                            <div class="d-flex align-items-baseline">
                                                <span class="fs-3 fw-bold text-warning" id="user-points">0</span>
                                                <span class="ms-2 text-muted">pt</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-warning btn-sm" id="point-shop-btn">
                                            <i class="bi bi-shop"></i> ã‚·ãƒ§ãƒƒãƒ—
                                        </button>
                                        <button class="btn btn-success btn-sm" onclick="window.location.href='game_center.html'">
                                            <i class="bi bi-joystick"></i> ã‚²ãƒ¼ãƒ 
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Collection Stats Dashboard -->
                    <div class="card mt-3" id="stats-dashboard">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-graph-up"></i> ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³çµ±è¨ˆ <span id="collector-rank" class="badge bg-warning ms-2"></span>
                            </div>
                            <button class="btn btn-sm btn-light" id="stats-info-btn" title="çµ±è¨ˆã®èª¬æ˜">
                                <i class="bi bi-info-circle"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-6 col-md-3">
                                    <div class="text-center">
                                        <div class="fs-2 fw-bold text-primary" id="total-cards">0</div>
                                        <small class="text-muted">ç·ã‚«ãƒ¼ãƒ‰æšæ•°</small>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="text-center">
                                        <div class="fs-2 fw-bold text-success" id="unique-cards">0</div>
                                        <small class="text-muted">ç¨®é¡æ•°</small>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="text-center">
                                        <div class="fs-2 fw-bold text-warning" id="collection-days">0</div>
                                        <small class="text-muted">åé›†æ—¥æ•°</small>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="text-center">
                                        <div class="fs-2 fw-bold text-info" id="recent-cards">0</div>
                                        <small class="text-muted">ä»Šé€±è¿½åŠ </small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Progress to next milestone -->
                            <div class="mt-3" id="milestone-progress" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="text-muted">æ¬¡ã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã¾ã§</small>
                                    <small class="text-primary fw-bold" id="milestone-text"></small>
                                </div>
                                <div class="progress" style="height: 25px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" id="milestone-bar" role="progressbar" style="width: 0%">
                                        <span id="milestone-percent">0%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Achievements Section -->
                            <div class="mt-3">
                                <div class="d-flex align-items-center justify-content-between mb-2" style="cursor: pointer;" id="achievement-toggle">
                                    <strong>å®Ÿç¸¾ä¸€è¦§</strong>
                                    <i class="bi bi-chevron-down" id="achievement-toggle-icon"></i>
                                </div>
                                <div id="achievement-section" style="display: none;">
                                    <div id="achievement-summary-container"></div>
                                    <div id="achievement-details" class="achievement-details"></div>
                                </div>
                            </div>
                            
                            <!-- Rarity Distribution Chart -->
                            <div class="mt-3" id="rarity-chart-container" style="display: none;">
                                <small class="text-muted d-block mb-2">ãƒ¬ã‚¢ãƒªãƒ†ã‚£åˆ†å¸ƒ</small>
                                <div class="d-flex gap-1" id="rarity-bars"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, deleteUser, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, query, where, updateDoc, increment, writeBatch, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAOYKalLUb2hbghrjQUS8AWzxpLExBT7aU",
            authDomain: "ygoh-9bcf6.firebaseapp.com",
            projectId: "ygoh-9bcf6",
            storageBucket: "ygoh-9bcf6.firebasestorage.app",
            messagingSenderId: "515041224138",
            appId: "1:515041224138:web:8de47b38ed9cc1bb8afd37",
            measurementId: "G-ZGSRE8MHZ2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        setPersistence(auth, browserLocalPersistence).catch((error) => {
        });

        let cardCollection = [];
        let wishlistCollection = [];
        let currentListType = 'collection'; // 'collection' or 'wishlist'
        let currentUser = null;
        let sortConfig = { key: 'åå‰', direction: 'ascending' };
        let currentPage = 1;
        let itemsPerPage = 50;
        let filteredCardCollection = [];
        let allTags = [];
        
        // Gamification data - will be synced with Firebase
        let gamificationData = {
            userPoints: 0,
            purchasedItems: {},
            activeTheme: 'default',
            activeFrame: '',
            activeBackground: '',
            activeIcon: '',
            registrationStreak: { count: 0, lastDate: null },
            weeklyGoalData: { weekStart: null, count: 0, goal: 50 },
            todayAdditions: { date: null, count: 0 },
            dailyMissionProgress: {},
            firstCollectionDate: null,
            lastMilestoneReached: 0,
            cardAdditionDates: {},
            hasReceivedFirstLoginBonus: false, // Track first login bonus in Firebase
            // Profile data
            profile: {
                nickname: '',
                icon: 'ğŸ‘¤',
                firstUseDate: null,
                lastUseDate: null,
                usageDays: new Set(),
                maxStreak: 0,
                totalPointsEarned: 0
            }
        };
        
        // Save gamification data to Firebase
        const saveGamificationData = async () => {
            if (!currentUser) return;
            
            try {
                const userDocRef = doc(db, 'userGamification', currentUser.uid);
                // Convert Set to Array for Firebase storage
                const dataToSave = {
                    ...gamificationData,
                    profile: {
                        ...gamificationData.profile,
                        usageDays: gamificationData.profile?.usageDays ? Array.from(gamificationData.profile.usageDays) : []
                    }
                };
                await setDoc(userDocRef, dataToSave, { merge: true });
            } catch (error) {
                console.error('Error saving gamification data:', error);
            }
        };
        
        // Load gamification data from Firebase
        const loadGamificationData = async () => {
            if (!currentUser) return;
            
            try {
                const userDocRef = doc(db, 'userGamification', currentUser.uid);
                const docSnap = await getDoc(userDocRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Convert Array back to Set for usageDays
                    if (data.profile?.usageDays) {
                        data.profile.usageDays = new Set(data.profile.usageDays);
                    }
                    // Merge with default values to ensure all properties exist
                    gamificationData = {
                        ...gamificationData,
                        ...data,
                        profile: {
                            ...gamificationData.profile,
                            ...data.profile
                        }
                    };
                } else {
                    // Initialize new user data
                    await saveGamificationData();
                }
                
                // Track today's usage
                trackDailyUsage();
            } catch (error) {
                console.error('Error loading gamification data:', error);
            }
        };
        let currentCardTags = [];
        let selectedCardIds = new Set();

        const mainApp = document.getElementById('main-app');
        const appLoader = document.getElementById('app-loader');
        const authModal = new bootstrap.Modal(document.getElementById('auth-modal'));
        const editCardModal = new bootstrap.Modal(document.getElementById('edit-card-modal'));
        const howToUseModal = new bootstrap.Modal(document.getElementById('how-to-use-modal'));
        const settingsModal = new bootstrap.Modal(document.getElementById('settings-modal'));
        const tagManagementModal = new bootstrap.Modal(document.getElementById('tag-management-modal'));
        const bulkTagModal = new bootstrap.Modal(document.getElementById('bulk-tag-modal'));
        const authError = document.getElementById('auth-error');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailSpan = document.getElementById('user-email');
        const cardTableBody = document.getElementById('card-table-body');
        const totalCollectionSpan = document.getElementById('total-collection');
        const totalWishlistSpan = document.getElementById('total-wishlist');
        const loadingOverlay = document.getElementById('loading-overlay');
        const addForm = document.getElementById('add-form');
        const searchForm = document.getElementById('search-form');
        const importFileInput = document.getElementById('import-file-input');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const hideEmailToggle = document.getElementById('hide-email-toggle');
        const showSearchHistoryToggle = document.getElementById('show-search-history-toggle');
        const showRegistrationHistoryToggle = document.getElementById('show-registration-history-toggle');

        const showLoading = (show) => { loadingOverlay.style.display = show ? 'flex' : 'none'; };
        
        const updateHistoryButton = (btnId, storageKey, data, titlePrefix) => {
            const btn = document.getElementById(btnId);
            const show = localStorage.getItem(storageKey) === 'true' && data;
            btn.style.display = show ? 'inline-block' : 'none';
            if (show) btn.title = `${titlePrefix}: ${typeof data === 'object' ? data.name : data}`;
        };
        const updateSearchHistoryButton = () => updateHistoryButton('prev-search-btn', 'showSearchHistory', lastSearchKeyword, 'å‰å›ã®æ¤œç´¢');
        const updateRegistrationHistoryButton = () => updateHistoryButton('prev-registration-btn', 'showRegistrationHistory', lastRegistrationData, 'å‰å›ã®ç™»éŒ²');
        
        const escapeHtml = (str) => str == null ? '' : String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
        
        const getCurrentCollection = () => currentListType === 'collection' ? cardCollection : wishlistCollection;
        
        const renderTable = () => {
            const currentData = getCurrentCollection();
            filteredCardCollection.sort((a, b) => {
                let [vA, vB] = [a.data[sortConfig.key], b.data[sortConfig.key]];
                if (sortConfig.key === 'æšæ•°') {
                    [vA, vB] = [parseInt(vA, 10) || 0, parseInt(vB, 10) || 0];
                } else {
                    [vA, vB] = [String(vA || '').toLowerCase(), String(vB || '').toLowerCase()];
                }
                return vA === vB ? 0 : (vA < vB ? -1 : 1) * (sortConfig.direction === 'ascending' ? 1 : -1);
            });

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedItems = filteredCardCollection.slice(startIndex, endIndex);

            cardTableBody.innerHTML = '';
            if (paginatedItems.length === 0) {
                cardTableBody.innerHTML = '<tr><td colspan="6" class="text-center">è©²å½“ã™ã‚‹ã‚«ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
            } else {
                paginatedItems.forEach(card => {
                    const tr = document.createElement('tr');
                    const tags = (card.data.tags || []).map(tag => escapeHtml(tag)).join(', ');
                    const isChecked = selectedCardIds.has(card.id) ? 'checked' : '';
                    tr.innerHTML = `
                        <td>
                            <input type="checkbox" class="form-check-input card-checkbox" data-id="${escapeHtml(card.id)}" ${isChecked}>
                        </td>
                        <td>${escapeHtml(card.data['åå‰'])}</td>
                        <td>${escapeHtml(card.data['å‹ç•ª'])}</td>
                        <td>${escapeHtml(card.data['ãƒ¬ã‚¢ãƒªãƒ†ã‚£'])}</td>
                        <td>${escapeHtml(card.data['æšæ•°'])}</td>
                        <td class="tag-cell d-none d-sm-table-cell" title="${escapeHtml(tags)}">${tags}</td>
                        <td>
                            <button class="btn btn-primary btn-sm edit-btn" data-id="${escapeHtml(card.id)}"><i class="bi bi-pencil"></i></button>
                            ${currentListType === 'wishlist' ? `<button class="btn btn-success btn-sm move-to-collection-btn" data-id="${escapeHtml(card.id)}" title="æ‰€æŒã‚«ãƒ¼ãƒ‰ã¸ç§»å‹•"><i class="bi bi-check-circle"></i></button>` : ''}
                            <button class="btn btn-danger btn-sm delete-btn" data-id="${escapeHtml(card.id)}"><i class="bi bi-trash"></i></button>
                        </td>
                    `;
                    cardTableBody.appendChild(tr);
                });
            }

            updatePaginationControls();
            updateSortIcons();
            updateTotalCounts();
            
            // Update ranking data when collection changes
            if (currentUser) {
                updateUserRankingData();
            }
        };

        const updatePaginationControls = () => {
            const totalPages = Math.ceil(filteredCardCollection.length / itemsPerPage);
            const controlsHtml = `
                <div class="d-flex flex-wrap align-items-center gap-1 gap-sm-2">
                    <span class="text-nowrap">${totalPages > 0 ? currentPage : 0}/${totalPages}ãƒšãƒ¼ã‚¸</span>
                    <span class="text-nowrap">(${filteredCardCollection.length}ä»¶)</span>
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-secondary" ${currentPage <= 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">å‰ã¸</button>
                        <button class="btn btn-outline-secondary" ${currentPage >= totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">æ¬¡ã¸</button>
                    </div>
                </div>
            `;
            document.getElementById('pagination-controls').innerHTML = controlsHtml;
            document.getElementById('pagination-controls-bottom').innerHTML = controlsHtml;
        };

        window.changePage = (page) => {
            currentPage = page;
            renderTable();
        };

        const renderTagChoices = (containerId, selectedTags) => {
            const container = document.getElementById(containerId);
            container.innerHTML = allTags.map(tag => 
                `<button type="button" class="btn btn-sm ${selectedTags.includes(tag.name) ? 'btn-primary' : 'btn-outline-secondary'} me-1 mb-1" onclick="toggleTag('${escapeHtml(tag.name)}', ${containerId.startsWith('edit')})">${escapeHtml(tag.name)}</button>`
            ).join('');
        };

        const renderSelectedTags = (containerId, tags) => document.getElementById(containerId).innerHTML = tags.map(tag => `<span class="badge bg-secondary me-1">${escapeHtml(tag)}</span>`).join(' ');

        window.toggleTag = (tagName, isEdit) => {
            const i = currentCardTags.indexOf(tagName);
            i > -1 ? currentCardTags.splice(i, 1) : currentCardTags.push(tagName);
            const [choices, tags] = isEdit ? ['edit-tag-choices-container', 'edit-card-tags-container'] : ['tag-choices-container', 'card-tags-container'];
            renderTagChoices(choices, currentCardTags);
            renderSelectedTags(tags, currentCardTags);
        };

        const updateSortIcons = () => {
            document.querySelectorAll('th.sortable').forEach(th => {
                const icon = th.querySelector('i');
                if (th.dataset.sort === sortConfig.key) {
                    icon.className = sortConfig.direction === 'ascending' ? 'bi bi-sort-down' : 'bi bi-sort-up';
                } else {
                    icon.className = 'bi bi-arrow-down-up';
                }
            });
        };

        const updateTotalCounts = () => {
            const totalCollection = cardCollection.reduce((sum, card) => sum + (card.data['æšæ•°'] || 0), 0);
            const totalWishlist = wishlistCollection.reduce((sum, card) => sum + (card.data['æšæ•°'] || 0), 0);
            totalCollectionSpan.textContent = totalCollection;
            totalWishlistSpan.textContent = totalWishlist;
            updateCollectionStats(); // Update gamification stats
        };
        
        // Gamification features - now loaded from Firebase
        
        // Achievement categories with expanded variety
        const ACHIEVEMENT_CATEGORIES = {
            'æšæ•°': [
                { id: 'cards10', name: 'ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã‚¹ãƒ†ãƒƒãƒ—', desc: '10æš', threshold: 10, class: 'bronze' },
                { id: 'cards25', name: 'ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼', desc: '25æš', threshold: 25, class: 'bronze' },
                { id: 'cards50', name: 'ç†Ÿç·´è€…', desc: '50æš', threshold: 50, class: 'silver' },
                { id: 'cards100', name: 'ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ', desc: '100æš', threshold: 100, class: 'silver' },
                { id: 'cards250', name: 'ãƒ™ãƒ†ãƒ©ãƒ³', desc: '250æš', threshold: 250, class: 'gold' },
                { id: 'cards500', name: 'ãƒã‚¹ã‚¿ãƒ¼', desc: '500æš', threshold: 500, class: 'gold' },
                { id: 'cards1000', name: 'ã‚°ãƒ©ãƒ³ãƒ‰ãƒã‚¹ã‚¿ãƒ¼', desc: '1000æš', threshold: 1000, class: 'platinum' },
                { id: 'cards2500', name: 'ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³', desc: '2500æš', threshold: 2500, class: 'platinum' },
                { id: 'cards5000', name: 'ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰', desc: '5000æš', threshold: 5000, class: 'diamond' },
                { id: 'cards10000', name: 'ãƒŸã‚·ãƒƒã‚¯', desc: '10000æš', threshold: 10000, class: 'diamond' },
                { id: 'cards25000', name: 'ã‚¤ãƒ¢ãƒ¼ã‚¿ãƒ«', desc: '25000æš', threshold: 25000, class: 'mythic' },
                { id: 'cards50000', name: 'ã‚¨ã‚¿ãƒ¼ãƒŠãƒ«', desc: '50000æš', threshold: 50000, class: 'mythic' },
                { id: 'cards100000', name: 'ã‚ªãƒ ãƒ‹', desc: '100000æš', threshold: 100000, class: 'mythic' }
            ],
            'ç¨®é¡': [
                { id: 'unique5', name: 'ãƒãƒ©ã‚¨ãƒ†ã‚£', desc: '5ç¨®é¡', threshold: 5, class: 'bronze', type: 'unique' },
                { id: 'unique10', name: 'ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼', desc: '10ç¨®é¡', threshold: 10, class: 'bronze', type: 'unique' },
                { id: 'unique25', name: 'æ¢æ±‚è€…', desc: '25ç¨®é¡', threshold: 25, class: 'silver', type: 'unique' },
                { id: 'unique50', name: 'ç ”ç©¶è€…', desc: '50ç¨®é¡', threshold: 50, class: 'silver', type: 'unique' },
                { id: 'unique100', name: 'å­¦è€…', desc: '100ç¨®é¡', threshold: 100, class: 'gold', type: 'unique' },
                { id: 'unique200', name: 'åšå£«', desc: '200ç¨®é¡', threshold: 200, class: 'gold', type: 'unique' },
                { id: 'unique500', name: 'ç™¾ç§‘äº‹å…¸', desc: '500ç¨®é¡', threshold: 500, class: 'platinum', type: 'unique' },
                { id: 'unique1000', name: 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–', desc: '1000ç¨®é¡', threshold: 1000, class: 'diamond', type: 'unique' }
            ],
            'ãƒ¬ã‚¢ãƒªãƒ†ã‚£': [
                { id: 'rare5', name: 'Rãƒãƒ³ã‚¿ãƒ¼', desc: 'Rä»¥ä¸Š5æš', threshold: 5, class: 'bronze', type: 'rarity' },
                { id: 'rare25', name: 'SRãƒãƒ³ã‚¿ãƒ¼', desc: 'SRä»¥ä¸Š25æš', threshold: 25, class: 'silver', type: 'sr' },
                { id: 'rare50', name: 'URãƒãƒ³ã‚¿ãƒ¼', desc: 'URä»¥ä¸Š50æš', threshold: 50, class: 'gold', type: 'ur' },
                { id: 'rare100', name: 'SEãƒãƒ³ã‚¿ãƒ¼', desc: 'SEç³»100æš', threshold: 100, class: 'platinum', type: 'se' },
                { id: 'premium10', name: 'ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ', desc: 'Pç³»10æš', threshold: 10, class: 'gold', type: 'premium' },
                { id: 'ul5', name: 'ULã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼', desc: 'UL5æš', threshold: 5, class: 'platinum', type: 'ul' },
                { id: 'qcse1', name: 'QCSEæ‰€æŒè€…', desc: 'QCSE1æš', threshold: 1, class: 'mythic', type: 'qcse' }
            ],
            'ç¶™ç¶š': [
                { id: 'days3', name: 'ãƒ“ã‚®ãƒŠãƒ¼', desc: '3æ—¥é–“', threshold: 3, class: 'bronze', type: 'days' },
                { id: 'days7', name: 'é€±é–“ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼', desc: '7æ—¥é–“', threshold: 7, class: 'bronze', type: 'days' },
                { id: 'days30', name: 'æœˆé–“ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼', desc: '30æ—¥é–“', threshold: 30, class: 'silver', type: 'days' },
                { id: 'days90', name: 'ã‚·ãƒ¼ã‚ºãƒ³ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼', desc: '90æ—¥é–“', threshold: 90, class: 'gold', type: 'days' },
                { id: 'days180', name: 'åŠå¹´ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼', desc: '180æ—¥é–“', threshold: 180, class: 'platinum', type: 'days' },
                { id: 'days365', name: 'å¹´é–“ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼', desc: '365æ—¥é–“', threshold: 365, class: 'diamond', type: 'days' },
                { id: 'days730', name: 'ãƒ™ãƒ†ãƒ©ãƒ³', desc: '730æ—¥é–“', threshold: 730, class: 'mythic', type: 'days' }
            ],
            'ç‰¹æ®Š': [
                { id: 'speed10', name: 'ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ©ãƒ³', desc: 'ä¸€æ—¥ã§10æšè¿½åŠ ', threshold: 10, class: 'silver', type: 'daily' },
                { id: 'speed50', name: 'ãƒãƒ©ã‚½ãƒ³ãƒ©ãƒ³ãƒŠãƒ¼', desc: 'ä¸€æ—¥ã§50æšè¿½åŠ ', threshold: 50, class: 'gold', type: 'daily' },
                { id: 'weekend100', name: 'é€±æœ«ãƒãƒ³ã‚¿ãƒ¼', desc: 'ä¸€é€±é–“ã§100æš', threshold: 100, class: 'gold', type: 'weekly' },
                { id: 'completionist', name: 'ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ', desc: 'ã‚¿ã‚°10å€‹ä»¥ä¸Šä½¿ç”¨', threshold: 10, class: 'platinum', type: 'tags' },
                { id: 'organizer', name: 'æ•´ç†é”äºº', desc: 'ã‚¿ã‚°20å€‹ä»¥ä¸Šä½œæˆ', threshold: 20, class: 'diamond', type: 'tags' }
            ]
        };
        
        // Flatten achievements for backward compatibility
        const ACHIEVEMENTS = Object.values(ACHIEVEMENT_CATEGORIES).flat();
        
        const MILESTONES = [10, 25, 50, 75, 100, 150, 200, 300, 500, 1000, 1500, 2000, 3000, 5000, 7500, 10000, 15000, 20000, 30000, 50000, 75000, 100000];
        
        const getRarityScore = (rarity) => {
            if (!rarity) return 1;
            const rarityLower = rarity.toLowerCase();
            if (rarityLower.includes('ã‚¦ãƒ«ãƒˆãƒ©') || rarityLower.includes('ultra')) return 5;
            if (rarityLower.includes('ã‚¹ãƒ¼ãƒ‘ãƒ¼') || rarityLower.includes('super')) return 4;
            if (rarityLower.includes('ãƒ¬ã‚¢') || rarityLower.includes('rare')) return 3;
            if (rarityLower.includes('ãƒãƒ¼ãƒãƒ«') || rarityLower.includes('normal')) return 2;
            return 1;
        };
        
        // Track card addition dates - now in gamificationData
        
        // Fun Dashboard Features
        const DAILY_MISSIONS = [
            { id: 'add3', text: '3æšã®ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ', target: 3, type: 'add' },
            { id: 'addRare', text: 'ãƒ¬ã‚¢ä»¥ä¸Šã®ã‚«ãƒ¼ãƒ‰ã‚’1æšè¿½åŠ ', target: 1, type: 'rare' },
            { id: 'addTag', text: 'ã‚¿ã‚°ä»˜ãã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ', target: 1, type: 'tag' },
            { id: 'search5', text: '5å›æ¤œç´¢ã‚’å®Ÿè¡Œ', target: 5, type: 'search' },
            { id: 'unique2', text: '2ç¨®é¡ã®ç•°ãªã‚‹ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ', target: 2, type: 'unique' }
        ];
        
        // Point System - now in gamificationData
        
        const POINT_REWARDS = {
            addCard: 5,          // ã‚«ãƒ¼ãƒ‰è¿½åŠ 
            addRareCard: 10,     // ãƒ¬ã‚¢ã‚«ãƒ¼ãƒ‰è¿½åŠ 
            completeMission: 20, // ãƒŸãƒƒã‚·ãƒ§ãƒ³å®Œäº†
            dailyLogin: 10,      // ãƒ‡ã‚¤ãƒªãƒ¼ãƒ­ã‚°ã‚¤ãƒ³
            weekStreak: 50,      // é€±é–“ã‚¹ãƒˆãƒªãƒ¼ã‚¯
        };
        
        const SHOP_ITEMS = {
            themes: [
                // Basic themes (50-100pt)
                { id: 'theme-light-blue', name: 'ãƒ©ã‚¤ãƒˆãƒ–ãƒ«ãƒ¼', class: 'theme-light-blue', cost: 50, preview: 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)' },
                { id: 'theme-mint', name: 'ãƒŸãƒ³ãƒˆ', class: 'theme-mint', cost: 80, preview: 'linear-gradient(135deg, #c8e6c9 0%, #81c784 100%)' },
                { id: 'theme-peach', name: 'ãƒ”ãƒ¼ãƒ', class: 'theme-peach', cost: 80, preview: 'linear-gradient(135deg, #ffccbc 0%, #ffab91 100%)' },
                
                // Mid-tier themes (100-200pt)
                { id: 'theme-ocean', name: 'ã‚ªãƒ¼ã‚·ãƒ£ãƒ³', class: 'theme-ocean', cost: 150, preview: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
                { id: 'theme-forest', name: 'ãƒ•ã‚©ãƒ¬ã‚¹ãƒˆ', class: 'theme-forest', cost: 120, preview: 'linear-gradient(135deg, #0ba360 0%, #3cba92 100%)' },
                { id: 'theme-sunset', name: 'ã‚µãƒ³ã‚»ãƒƒãƒˆ', class: 'theme-sunset', cost: 180, preview: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' },
                { id: 'theme-cherry', name: 'ãƒã‚§ãƒªãƒ¼', class: 'theme-cherry', cost: 150, preview: 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)' },
                { id: 'theme-sakura', name: 'æ¡œ', class: 'theme-sakura', cost: 200, preview: 'linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%)' },
                
                // Premium themes (250-500pt)
                { id: 'theme-galaxy', name: 'ã‚®ãƒ£ãƒ©ã‚¯ã‚·ãƒ¼', class: 'theme-galaxy', cost: 300, preview: 'linear-gradient(135deg, #4776E6 0%, #8E54E9 100%)' },
                { id: 'theme-midnight', name: 'ãƒŸãƒƒãƒ‰ãƒŠã‚¤ãƒˆ', class: 'theme-midnight', cost: 350, preview: 'linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%)' },
                { id: 'theme-fire', name: 'ãƒ•ã‚¡ã‚¤ã‚¢', class: 'theme-fire', cost: 400, preview: 'linear-gradient(135deg, #ff9a56 0%, #ff6a88 50%, #ff2d55 100%)' },
                { id: 'theme-aurora', name: 'ã‚ªãƒ¼ãƒ­ãƒ©', class: 'theme-aurora', cost: 450, preview: 'linear-gradient(135deg, #00d2ff 0%, #3a7bd5 50%, #00d2ff 100%)' },
                { id: 'theme-neon', name: 'ãƒã‚ªãƒ³', class: 'theme-neon', cost: 500, preview: 'linear-gradient(135deg, #f953c6 0%, #b91d73 100%)' },
                
                // Ultra premium themes (600-1000pt)
                { id: 'theme-cosmic', name: 'ã‚³ã‚ºãƒŸãƒƒã‚¯', class: 'theme-cosmic', cost: 600, preview: 'linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f953c6 100%)' },
                { id: 'theme-rainbow', name: 'ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼', class: 'theme-rainbow', cost: 800, preview: 'linear-gradient(135deg, #ff0000 0%, #ff7f00 17%, #ffff00 33%, #00ff00 50%, #0000ff 67%, #4b0082 83%, #9400d3 100%)' },
                { id: 'theme-holographic', name: 'ãƒ›ãƒ­ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯', class: 'theme-holographic', cost: 900, preview: 'linear-gradient(135deg, #a8edea 0%, #fed6e3 25%, #ffeaa7 50%, #dfe6e9 75%, #a8edea 100%)' },
                { id: 'theme-dragon-soul', name: 'ãƒ‰ãƒ©ã‚´ãƒ³ã‚½ã‚¦ãƒ«', class: 'theme-dragon-soul', cost: 1200, preview: 'linear-gradient(135deg, #f83600 0%, #f9d423 50%, #f83600 100%)' },
                { id: 'theme-legendary', name: 'ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼', class: 'theme-legendary', cost: 1500, preview: 'linear-gradient(135deg, #ffd700 0%, #ff6347 25%, #ff1493 50%, #00ced1 75%, #ffd700 100%)' },
            ],
            frames: [
                // Basic frames (50-100pt)
                { id: 'frame-simple', name: 'ã‚·ãƒ³ãƒ—ãƒ«', cost: 50, description: 'ã‚·ãƒ³ãƒ—ãƒ«ãªæ ç·š', class: 'frame-simple' },
                { id: 'frame-bold', name: 'ãƒœãƒ¼ãƒ«ãƒ‰', cost: 80, description: 'å¤ªã„æ ç·š', class: 'frame-bold' },
                { id: 'frame-dotted', name: 'ãƒ‰ãƒƒãƒˆ', cost: 60, description: 'ç‚¹ç·šã®æ ', class: 'frame-dotted' },
                
                // Mid-tier frames (120-250pt)
                { id: 'frame-silver', name: 'ã‚·ãƒ«ãƒãƒ¼', cost: 120, description: 'éŠ€è‰²ã®æ ç·š', class: 'frame-silver' },
                { id: 'frame-gold', name: 'ã‚´ãƒ¼ãƒ«ãƒ‰', cost: 200, description: 'ã‚«ãƒ¼ãƒ‰ã«é‡‘è‰²ã®æ ç·š', class: 'frame-gold' },
                { id: 'frame-fire', name: 'ç‚', cost: 250, description: 'ç‡ƒãˆä¸ŠãŒã‚‹ãƒ•ãƒ¬ãƒ¼ãƒ ', class: 'frame-fire' },
                { id: 'frame-ice', name: 'æ°·', cost: 250, description: 'å†·ãŸãè¼ããƒ•ãƒ¬ãƒ¼ãƒ ', class: 'frame-ice' },
                { id: 'frame-nature', name: 'è‡ªç„¶', cost: 180, description: 'è‘‰ã£ã±ã§é£¾ã‚‰ã‚ŒãŸæ ', class: 'frame-nature' },
                
                // Premium frames (300-500pt)
                { id: 'frame-rainbow', name: 'ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼', cost: 350, description: 'è™¹è‰²ã«è¼ãæ ç·š', class: 'frame-rainbow' },
                { id: 'frame-electric', name: 'é›»æ°—', cost: 320, description: 'é›»æ’ƒãŒèµ°ã‚‹ãƒ•ãƒ¬ãƒ¼ãƒ ', class: 'frame-electric' },
                { id: 'frame-diamond', name: 'ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰', cost: 400, description: 'ã‚­ãƒ©ã‚­ãƒ©å…‰ã‚‹é«˜ç´šãƒ•ãƒ¬ãƒ¼ãƒ ', class: 'frame-diamond' },
                { id: 'frame-plasma', name: 'ãƒ—ãƒ©ã‚ºãƒ', cost: 450, description: 'ãƒ—ãƒ©ã‚ºãƒãŒæµã‚Œã‚‹æ ', class: 'frame-plasma' },
                { id: 'frame-crystal', name: 'ã‚¯ãƒªã‚¹ã‚¿ãƒ«', cost: 500, description: 'æ°´æ™¶ã®ã‚ˆã†ãªé€æ˜æ„Ÿ', class: 'frame-crystal' },
                
                // Ultra premium frames (600-1500pt)
                { id: 'frame-legendary', name: 'ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼', cost: 700, description: 'ä¼èª¬ç´šã®è±ªè¯ãªæ ', class: 'frame-legendary' },
                { id: 'frame-mythic', name: 'ãƒŸã‚·ãƒƒã‚¯', cost: 900, description: 'ç¥è©±ç´šã®ç¥ç§˜çš„ãªæ ', class: 'frame-mythic' },
                { id: 'frame-ultimate', name: 'ã‚¢ãƒ«ãƒ†ã‚£ãƒ¡ãƒƒãƒˆ', cost: 1100, description: 'ç©¶æ¥µã®è£…é£¾æ ', class: 'frame-ultimate' },
                { id: 'frame-god', name: 'ã‚´ãƒƒãƒ‰', cost: 1500, description: 'ç¥ã€…ã—ã„å…‰ã®æ ', class: 'frame-god' },
            ],
            backgrounds: [
                // Basic backgrounds (50-100pt)
                { id: 'bg-gradient', name: 'ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³', cost: 50, description: 'ç¾ã—ã„è‰²ã®å¤‰åŒ–', class: 'bg-gradient' },
                { id: 'bg-dots', name: 'ãƒ‰ãƒƒãƒˆ', cost: 60, description: 'ã‹ã‚ã„ã„ãƒ‰ãƒƒãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³', class: 'bg-dots' },
                { id: 'bg-stripes', name: 'ã‚¹ãƒˆãƒ©ã‚¤ãƒ—', cost: 60, description: 'ç¸æ¨¡æ§˜ã®èƒŒæ™¯', class: 'bg-stripes' },
                { id: 'bg-checker', name: 'ãƒã‚§ãƒƒã‚«ãƒ¼', cost: 80, description: 'å¸‚æ¾æ¨¡æ§˜', class: 'bg-checker' },
                
                // Mid-tier backgrounds (120-250pt)
                { id: 'bg-clouds', name: 'é›²', cost: 120, description: 'ãµã‚ãµã‚é›²', class: 'bg-clouds' },
                { id: 'bg-waves', name: 'æ³¢', cost: 150, description: 'å„ªé›…ãªæ³¢ã®ãƒ‘ã‚¿ãƒ¼ãƒ³', class: 'bg-waves' },
                { id: 'bg-geometric', name: 'å¹¾ä½•å­¦', cost: 180, description: 'ãƒ¢ãƒ€ãƒ³ãªå¹¾ä½•å­¦ãƒ‘ã‚¿ãƒ¼ãƒ³', class: 'bg-geometric' },
                { id: 'bg-hexagon', name: 'ãƒ˜ã‚­ã‚µã‚´ãƒ³', cost: 200, description: 'å…­è§’å½¢ãƒ‘ã‚¿ãƒ¼ãƒ³', class: 'bg-hexagon' },
                { id: 'bg-circuit', name: 'å›è·¯', cost: 220, description: 'ã‚µã‚¤ãƒãƒ¼å›è·¯ãƒ‘ã‚¿ãƒ¼ãƒ³', class: 'bg-circuit' },
                
                // Premium backgrounds (250-500pt)
                { id: 'bg-stars', name: 'æ˜Ÿç©º', cost: 300, description: 'ãã‚‰ã‚ãæ˜Ÿç©º', class: 'bg-stars' },
                { id: 'bg-particles', name: 'ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«', cost: 350, description: 'å‹•ãç²’å­ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ', class: 'bg-particles' },
                { id: 'bg-galaxy', name: 'éŠ€æ²³', cost: 400, description: 'å£®å¤§ãªéŠ€æ²³ã®èƒŒæ™¯', class: 'bg-galaxy' },
                { id: 'bg-aurora', name: 'ã‚ªãƒ¼ãƒ­ãƒ©', cost: 450, description: 'ç¾ã—ã„ã‚ªãƒ¼ãƒ­ãƒ©ã®èƒŒæ™¯', class: 'bg-aurora' },
                { id: 'bg-crystal', name: 'ã‚¯ãƒªã‚¹ã‚¿ãƒ«', cost: 500, description: 'ã‚¯ãƒªã‚¹ã‚¿ãƒ«ã®è¼ã', class: 'bg-crystal' },
                
                // Ultra premium backgrounds (600-1500pt)
                { id: 'bg-matrix', name: 'ãƒãƒˆãƒªãƒƒã‚¯ã‚¹', cost: 600, description: 'ãƒ‡ã‚¸ã‚¿ãƒ«ãƒãƒˆãƒªãƒƒã‚¯ã‚¹', class: 'bg-matrix' },
                { id: 'bg-nebula', name: 'ãƒãƒ“ãƒ¥ãƒ©', cost: 800, description: 'å®‡å®™ã®æ˜Ÿé›²', class: 'bg-nebula' },
                { id: 'bg-dimension', name: 'æ¬¡å…ƒ', cost: 1000, description: 'å¤šæ¬¡å…ƒç©ºé–“ã®èƒŒæ™¯', class: 'bg-dimension' },
                { id: 'bg-void', name: 'ãƒ´ã‚©ã‚¤ãƒ‰', cost: 1200, description: 'è™šç©ºã®æ·±æ·µ', class: 'bg-void' },
                { id: 'bg-infinity', name: 'ã‚¤ãƒ³ãƒ•ã‚£ãƒ‹ãƒ†ã‚£', cost: 1500, description: 'ç„¡é™ã®å½¼æ–¹', class: 'bg-infinity' },
            ],
            icons: [
                // Basic icons (50-150pt)
                { id: 'icon-star', name: 'ã‚¹ã‚¿ãƒ¼', cost: 50, class: 'icon-star', emoji: 'âœ¨' },
                { id: 'icon-heart', name: 'ãƒãƒ¼ãƒˆ', cost: 60, class: 'icon-heart', emoji: 'â¤ï¸' },
                { id: 'icon-ghost', name: 'ã‚´ãƒ¼ã‚¹ãƒˆ', cost: 80, class: 'icon-ghost', emoji: 'ğŸ‘»' },
                { id: 'icon-crown', name: 'ç‹å† ', cost: 100, class: 'icon-crown', emoji: 'ğŸ‘‘' },
                { id: 'icon-robot', name: 'ãƒ­ãƒœãƒƒãƒˆ', cost: 120, class: 'icon-robot', emoji: 'ğŸ¤–' },
                { id: 'icon-alien', name: 'ã‚¨ã‚¤ãƒªã‚¢ãƒ³', cost: 150, class: 'icon-alien', emoji: 'ğŸ‘½' },
                { id: 'icon-devil', name: 'ãƒ‡ãƒ“ãƒ«', cost: 180, class: 'icon-devil', emoji: 'ğŸ˜ˆ' },
                { id: 'icon-sword', name: 'å‰£', cost: 200, class: 'icon-sword', emoji: 'âš”ï¸' },
                { id: 'icon-wizard', name: 'é­”æ³•ä½¿ã„', cost: 250, class: 'icon-wizard', emoji: 'ğŸ§™' },
                { id: 'icon-dragon', name: 'ãƒ‰ãƒ©ã‚´ãƒ³', cost: 300, class: 'icon-dragon', emoji: 'ğŸ‰' },
                { id: 'icon-phoenix', name: 'ä¸æ­»é³¥', cost: 350, class: 'icon-phoenix', emoji: 'ğŸ¦…' },
                { id: 'icon-unicorn', name: 'ãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ³', cost: 400, class: 'icon-unicorn', emoji: 'ğŸ¦„' },
                { id: 'icon-ninja', name: 'å¿è€…', cost: 450, class: 'icon-ninja', emoji: 'ğŸ¥·' },
                { id: 'icon-monster', name: 'ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼', cost: 600, class: 'icon-monster', emoji: 'ğŸ‘¹' },
                { id: 'icon-legendary', name: 'ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼', cost: 700, class: 'icon-legendary', emoji: 'ğŸ’«' },
                { id: 'icon-infinity', name: 'ã‚¤ãƒ³ãƒ•ã‚£ãƒ‹ãƒ†ã‚£', cost: 800, class: 'icon-infinity', emoji: 'â™¾ï¸' },
                
                // New emoji icons (300-800pt)
                { id: 'icon-fire', name: 'ç‚', cost: 350, class: 'icon-fire', emoji: 'ğŸ”¥' },
                { id: 'icon-skull', name: 'ãƒ‰ã‚¯ãƒ­', cost: 450, class: 'icon-skull', emoji: 'ğŸ’€' },
                { id: 'icon-newmoon', name: 'æ–°æœˆ', cost: 300, class: 'icon-newmoon', emoji: 'ğŸŒ‘' },
                { id: 'icon-moon', name: 'æœˆ', cost: 350, class: 'icon-moon', emoji: 'ğŸŒ™' },
                { id: 'icon-tornado', name: 'ç«œå·»', cost: 500, class: 'icon-tornado', emoji: 'ğŸŒªï¸' },
                { id: 'icon-star2', name: 'æ˜Ÿ', cost: 300, class: 'icon-star2', emoji: 'ğŸŒŸ' },
                { id: 'icon-swords', name: 'äº¤å·®å‰£', cost: 400, class: 'icon-swords', emoji: 'âš”ï¸' },
                { id: 'icon-dagger', name: 'çŸ­å‰£', cost: 350, class: 'icon-dagger', emoji: 'ğŸ—¡ï¸' },
                { id: 'icon-bat', name: 'ã‚³ã‚¦ãƒ¢ãƒª', cost: 400, class: 'icon-bat', emoji: 'ğŸ¦‡' },
                { id: 'icon-bone', name: 'éª¨', cost: 300, class: 'icon-bone', emoji: 'ğŸ¦´' },
                { id: 'icon-fox', name: 'ç‹', cost: 550, class: 'icon-fox', emoji: 'ğŸ¦Š' },
                
                // Special symbols (300-800pt)
                { id: 'icon-cross', name: 'ã‚¯ãƒ­ã‚¹', cost: 450, class: 'icon-cross', emoji: 'â€ ' },
                { id: 'icon-star3', name: 'ã‚¹ã‚¿ãƒ¼âœª', cost: 350, class: 'icon-star3', emoji: 'âœª' },
                { id: 'icon-star4', name: 'ã‚¹ã‚¿ãƒ¼âœ§', cost: 400, class: 'icon-star4', emoji: 'âœ§' },
                { id: 'icon-star5', name: 'ã‚¹ã‚¿ãƒ¼âœµ', cost: 450, class: 'icon-star5', emoji: 'âœµ' },
                { id: 'icon-star6', name: 'ã‚¹ã‚¿ãƒ¼âœ¯', cost: 500, class: 'icon-star6', emoji: 'âœ¯' },
                { id: 'icon-star7', name: 'ã‚¹ã‚¿ãƒ¼âœ¹', cost: 550, class: 'icon-star7', emoji: 'âœ¹' },
                { id: 'icon-star8', name: 'ã‚¹ã‚¿ãƒ¼â‚', cost: 600, class: 'icon-star8', emoji: 'â‚' },
                { id: 'icon-star9', name: 'ã‚¹ã‚¿ãƒ¼â‰', cost: 650, class: 'icon-star9', emoji: 'â‰' },
                { id: 'icon-cross2', name: 'åå­—æ¶', cost: 700, class: 'icon-cross2', emoji: 'â˜©' },
                { id: 'icon-star10', name: 'ã‚¹ã‚¿ãƒ¼âœ¦', cost: 350, class: 'icon-star10', emoji: 'âœ¦' },
                { id: 'icon-star11', name: 'ã‚¹ã‚¿ãƒ¼âœ¶', cost: 400, class: 'icon-star11', emoji: 'âœ¶' },
                { id: 'icon-star12', name: 'ã‚¹ã‚¿ãƒ¼âœ¸', cost: 450, class: 'icon-star12', emoji: 'âœ¸' },
                { id: 'icon-star13', name: 'ã‚¹ã‚¿ãƒ¼âœº', cost: 500, class: 'icon-star13', emoji: 'âœº' },
                { id: 'icon-star14', name: 'ã‚¹ã‚¿ãƒ¼âœ®', cost: 550, class: 'icon-star14', emoji: 'âœ®' },
                
                // Chess pieces (400-700pt)
                { id: 'icon-queen', name: 'ã‚¯ã‚¤ãƒ¼ãƒ³', cost: 700, class: 'icon-queen', emoji: 'â™›' },
                { id: 'icon-knight', name: 'ãƒŠã‚¤ãƒˆ', cost: 550, class: 'icon-knight', emoji: 'â™' },
                { id: 'icon-pawn', name: 'ãƒãƒ¼ãƒ³', cost: 400, class: 'icon-pawn', emoji: 'â™Ÿ' },
                { id: 'icon-spade', name: 'ã‚¹ãƒšãƒ¼ãƒ‰', cost: 450, class: 'icon-spade', emoji: 'â™¤' },
                { id: 'icon-club', name: 'ã‚¯ãƒ©ãƒ–', cost: 450, class: 'icon-club', emoji: 'â™§' },
                { id: 'icon-king', name: 'ã‚­ãƒ³ã‚°', cost: 750, class: 'icon-king', emoji: 'â™š' },
                { id: 'icon-queen2', name: 'ã‚¯ã‚¤ãƒ¼ãƒ³â™•', cost: 700, class: 'icon-queen2', emoji: 'â™•' },
                { id: 'icon-rook', name: 'ãƒ«ãƒ¼ã‚¯', cost: 600, class: 'icon-rook', emoji: 'â™–' },
                { id: 'icon-rookb', name: 'ãƒ«ãƒ¼ã‚¯â™œ', cost: 600, class: 'icon-rookb', emoji: 'â™œ' },
                { id: 'icon-bishop', name: 'ãƒ“ã‚·ãƒ§ãƒƒãƒ—', cost: 550, class: 'icon-bishop', emoji: 'â™—' },
                { id: 'icon-bishopb', name: 'ãƒ“ã‚·ãƒ§ãƒƒãƒ—â™', cost: 550, class: 'icon-bishopb', emoji: 'â™' },
                
                // Mystical symbols (500-800pt)
                { id: 'icon-ankh', name: 'ã‚¢ãƒ³ã‚¯', cost: 650, class: 'icon-ankh', emoji: 'â˜¥' },
                { id: 'icon-mercury', name: 'æ°´æ˜Ÿ', cost: 500, class: 'icon-mercury', emoji: 'â˜¿' },
                { id: 'icon-jupiter', name: 'æœ¨æ˜Ÿ', cost: 550, class: 'icon-jupiter', emoji: 'â™ƒ' },
                { id: 'icon-saturn', name: 'åœŸæ˜Ÿ', cost: 600, class: 'icon-saturn', emoji: 'â™„' },
                { id: 'icon-uranus', name: 'å¤©ç‹æ˜Ÿ', cost: 650, class: 'icon-uranus', emoji: 'â™…' },
                { id: 'icon-neptune', name: 'æµ·ç‹æ˜Ÿ', cost: 700, class: 'icon-neptune', emoji: 'â™†' },
                { id: 'icon-pluto', name: 'å†¥ç‹æ˜Ÿ', cost: 750, class: 'icon-pluto', emoji: 'â™‡' },
                { id: 'icon-sun', name: 'å¤ªé™½', cost: 800, class: 'icon-sun', emoji: 'â˜¼' },
                { id: 'icon-moon2', name: 'æœˆâ˜½', cost: 400, class: 'icon-moon2', emoji: 'â˜½' },
                { id: 'icon-constellation', name: 'æ˜Ÿåº§', cost: 450, class: 'icon-constellation', emoji: 'â˜¾' },
                { id: 'icon-cross3', name: 'åå­—âœ', cost: 500, class: 'icon-cross3', emoji: 'âœ' },
                { id: 'icon-cross4', name: 'åå­—âœŸ', cost: 550, class: 'icon-cross4', emoji: 'âœŸ' },
            ]
        };
        
        // Initialize daily mission progress
        const initializeDailyMissions = () => {
            const today = new Date().toDateString();
            
            // Reset missions if it's a new day
            if (!gamificationData.dailyMissionProgress || gamificationData.dailyMissionProgress.date !== today) {
                gamificationData.dailyMissionProgress = {
                    date: today,
                    missions: {},
                    searchCount: 0,
                    addedCards: [],
                    addedRare: 0,
                    addedWithTag: 0
                };
                saveGamificationData();
            }
        };
        
        // Update time display
        const updateTimeDisplay = () => {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            const dateStr = now.toLocaleDateString('ja-JP', { month: 'long', day: 'numeric', weekday: 'long' });
            const timeEl = document.getElementById('current-time');
            if (timeEl) {
                timeEl.textContent = `${dateStr} ${timeStr}`;
            }
        };
        
        // Update daily missions display
        const updateDailyMissions = () => {
            const container = document.getElementById('daily-missions');
            if (!container) return;
            
            container.innerHTML = '';
            DAILY_MISSIONS.forEach(mission => {
                const completed = gamificationData.dailyMissionProgress.missions[mission.id] || false;
                let progress = 0;
                
                switch (mission.type) {
                    case 'add':
                        progress = gamificationData.dailyMissionProgress.addedCards.length;
                        break;
                    case 'rare':
                        progress = gamificationData.dailyMissionProgress.addedRare;
                        break;
                    case 'tag':
                        progress = gamificationData.dailyMissionProgress.addedWithTag;
                        break;
                    case 'search':
                        progress = gamificationData.dailyMissionProgress.searchCount;
                        break;
                    case 'unique':
                        progress = new Set(gamificationData.dailyMissionProgress.addedCards.map(c => c.name)).size;
                        break;
                }
                
                const missionEl = document.createElement('div');
                missionEl.className = `list-group-item d-flex align-items-center mission-item ${completed ? 'completed' : ''}`;
                missionEl.innerHTML = `
                    <input type="checkbox" class="mission-checkbox me-3" ${completed ? 'checked' : ''} disabled>
                    <div class="flex-grow-1">
                        <div>${mission.text}</div>
                        <small class="text-muted">é€²æ—: ${Math.min(progress, mission.target)}/${mission.target}</small>
                    </div>
                    ${completed ? '<span class="badge bg-success">å®Œäº†!</span>' : '<span class="badge bg-secondary">æœªå®Œäº†</span>'}
                `;
                container.appendChild(missionEl);
                
                // Auto complete mission when target reached
                if (!completed && progress >= mission.target) {
                    gamificationData.dailyMissionProgress.missions[mission.id] = true;
                    saveGamificationData();
                    showMissionCompleteNotification(mission.text);
                    addPoints(POINT_REWARDS.completeMission, 'ãƒŸãƒƒã‚·ãƒ§ãƒ³å®Œäº†');
                }
            });
        };
        
        // Show mission complete notification
        const showMissionCompleteNotification = (missionText) => {
            const notification = document.createElement('div');
            notification.className = 'position-fixed top-0 start-50 translate-middle-x mt-3';
            notification.style.zIndex = '9999';
            notification.innerHTML = `
                <div class="alert alert-success shadow-lg">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <strong>ãƒŸãƒƒã‚·ãƒ§ãƒ³é”æˆï¼</strong> ${missionText}
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        };
        
        // Update registration streak
        const updateRegistrationStreak = () => {
            const streakData = gamificationData.registrationStreak;
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            
            const streakEl = document.getElementById('streak-count');
            const progressEl = document.getElementById('streak-progress');
            const messageEl = document.getElementById('streak-message');
            const badgeEl = document.getElementById('streak-badge');
            
            if (!streakEl) return;
            
            // Update streak display
            streakEl.textContent = streakData.count;
            
            // Calculate progress to next milestone (every 7 days)
            const progressPercent = ((streakData.count % 7) / 7) * 100;
            if (progressEl) progressEl.style.width = `${progressPercent}%`;
            
            // Set streak badge
            if (badgeEl) {
                if (streakData.count >= 30) badgeEl.textContent = 'ğŸ”¥';
                else if (streakData.count >= 14) badgeEl.textContent = 'â­';
                else if (streakData.count >= 7) badgeEl.textContent = 'âœ¨';
                else if (streakData.count >= 3) badgeEl.textContent = 'ğŸ‘';
                else badgeEl.textContent = '';
            }
            
            // Set message
            if (messageEl) {
                if (streakData.count === 0) {
                    messageEl.textContent = 'ä»Šæ—¥ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†ï¼';
                } else if (streakData.count % 7 === 0) {
                    messageEl.textContent = `${streakData.count / 7}é€±é–“é”æˆï¼ç´ æ™´ã‚‰ã—ã„ï¼`;
                } else {
                    const nextMilestone = Math.ceil(streakData.count / 7) * 7;
                    messageEl.textContent = `æ¬¡ã®ç›®æ¨™ã¾ã§ã‚ã¨${nextMilestone - streakData.count}æ—¥`;
                }
            }
        };
        
        // Update today's stats
        const updateTodayStats = () => {
            const today = new Date().toDateString();
            
            // Load today's additions from gamificationData
            let todayAdditions = gamificationData.todayAdditions;
            
            // Reset if it's a new day
            if (todayAdditions.date !== today) {
                todayAdditions = {
                    date: today,
                    count: 0
                };
                gamificationData.todayAdditions = todayAdditions;
                saveGamificationData();
            }
            
            const todayAddedEl = document.getElementById('today-added');
            if (todayAddedEl) todayAddedEl.textContent = todayAdditions.count;
            
            // Load and update weekly goal
            let weeklyGoalData = gamificationData.weeklyGoalData;
            const weekStart = getWeekStart();
            
            // Reset if it's a new week
            if (weeklyGoalData.weekStart !== weekStart) {
                weeklyGoalData = {
                    weekStart: weekStart,
                    count: 0,
                    goal: 50
                };
                gamificationData.weeklyGoalData = weeklyGoalData;
                saveGamificationData();
            }
            
            const weekProgress = Math.min(100, Math.round((weeklyGoalData.count / weeklyGoalData.goal) * 100));
            const weekGoalEl = document.getElementById('week-goal-progress');
            if (weekGoalEl) weekGoalEl.textContent = `${weekProgress}%`;
            
        };
        
        // Get start of current week (Monday)
        const getWeekStart = () => {
            const date = new Date();
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            date.setDate(diff);
            return date.toDateString();
        };
        
        // Update points display
        const updatePointsDisplay = () => {
            const pointsEl = document.getElementById('user-points');
            const shopPointsEl = document.getElementById('shop-current-points');
            if (pointsEl) pointsEl.textContent = gamificationData.userPoints.toLocaleString();
            if (shopPointsEl) shopPointsEl.textContent = gamificationData.userPoints.toLocaleString();
        };
        
        // Add points with animation
        const addPoints = (amount, reason) => {
            gamificationData.userPoints += amount;
            
            // Track total points earned
            if (!gamificationData.profile) {
                gamificationData.profile = {
                    nickname: '',
                    icon: 'ğŸ‘¤',
                    firstUseDate: null,
                    lastUseDate: null,
                    usageDays: new Set(),
                    maxStreak: 0,
                    totalPointsEarned: 0
                };
            }
            gamificationData.profile.totalPointsEarned = (gamificationData.profile.totalPointsEarned || 0) + amount;
            
            saveGamificationData();
            updatePointsDisplay();
            
            // Show point animation
            const animation = document.createElement('div');
            animation.className = 'point-animation';
            animation.textContent = `+${amount} pt`;
            animation.style.left = '50%';
            animation.style.top = '50%';
            document.body.appendChild(animation);
            
            setTimeout(() => animation.remove(), 1000);
            
            // Show notification
            if (reason) {
                const notification = document.createElement('div');
                notification.className = 'position-fixed bottom-0 end-0 p-3';
                notification.style.zIndex = '9999';
                notification.innerHTML = `
                    <div class="toast show" role="alert">
                        <div class="toast-body">
                            <i class="bi bi-coin text-warning me-2"></i>
                            <strong>+${amount} pt</strong> ${reason}
                        </div>
                    </div>
                `;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
            }
        };
        
        // Initialize shop
        const initializeShop = () => {
            // Populate themes
            const themeContainer = document.getElementById('theme-shop-items');
            if (themeContainer) {
                themeContainer.innerHTML = '';
                SHOP_ITEMS.themes.forEach(theme => {
                    const isPurchased = gamificationData.purchasedItems[theme.id];
                    const isActive = gamificationData.activeTheme === theme.class;
                    
                    const itemEl = document.createElement('div');
                    itemEl.className = 'col-md-6';
                    itemEl.innerHTML = `
                        <div class="card shop-item ${isPurchased ? 'purchased' : ''} ${isActive ? 'active' : ''} ${!isPurchased && gamificationData.userPoints < theme.cost ? 'locked' : ''}">
                            <div class="card-body">
                                <div style="height: 60px; background: ${theme.preview}; border-radius: 5px; margin-bottom: 10px;"></div>
                                <h6>${theme.name}</h6>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-warning">${theme.cost} pt</span>
                                    ${isPurchased ? 
                                        (isActive ? 
                                            '<div class="btn-group btn-group-sm">' +
                                            '<button class="btn btn-primary" disabled>é©ç”¨ä¸­</button>' +
                                            '<button class="btn btn-outline-secondary" onclick="applyTheme(\'default\')" title="å¤–ã™"><i class="bi bi-x"></i></button>' +
                                            '</div>' : 
                                            `<button class="btn btn-sm btn-success" onclick="applyTheme('${theme.class}')">é©ç”¨</button>`) :
                                        `<button class="btn btn-sm btn-warning" onclick="purchaseItem('${theme.id}', ${theme.cost}, 'theme')">è³¼å…¥</button>`
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                    themeContainer.appendChild(itemEl);
                });
            }
            
            // Populate frames
            const frameContainer = document.getElementById('frame-shop-items');
            if (frameContainer) {
                frameContainer.innerHTML = '';
                SHOP_ITEMS.frames.forEach(frame => {
                    const isPurchased = gamificationData.purchasedItems[frame.id];
                    const isActive = gamificationData.activeFrame === frame.class;
                    
                    const itemEl = document.createElement('div');
                    itemEl.className = 'col-md-6';
                    itemEl.innerHTML = `
                        <div class="card shop-item ${isPurchased ? 'purchased' : ''} ${isActive ? 'active' : ''} ${!isPurchased && gamificationData.userPoints < frame.cost ? 'locked' : ''}">
                            <div class="card-body">
                                <h6><i class="bi bi-border-all"></i> ${frame.name}</h6>
                                <p class="small text-muted">${frame.description}</p>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <span class="badge bg-warning">${frame.cost} pt</span>
                                    <div>
                                        ${!isPurchased && !isActive ? 
                                            `<button class="btn btn-sm btn-outline-info me-1" onclick="previewFrame('${frame.class}')" title="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
                                                <i class="bi bi-eye"></i> è©¦ã™
                                            </button>` : ''
                                        }
                                        ${isPurchased ? 
                                            (isActive ? 
                                                '<div class="btn-group btn-group-sm">' +
                                                '<button class="btn btn-primary" disabled>é©ç”¨ä¸­</button>' +
                                                '<button class="btn btn-outline-secondary" onclick="applyFrame(\'\')" title="å¤–ã™"><i class="bi bi-x"></i></button>' +
                                                '</div>' : 
                                                `<button class="btn btn-sm btn-success" onclick="applyFrame('${frame.class}')">é©ç”¨</button>`) :
                                            `<button class="btn btn-sm btn-warning" onclick="purchaseItem('${frame.id}', ${frame.cost}, 'frame')">è³¼å…¥</button>`
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    frameContainer.appendChild(itemEl);
                });
            }
            
            // Populate backgrounds
            const bgContainer = document.getElementById('background-shop-items');
            if (bgContainer) {
                bgContainer.innerHTML = '';
                SHOP_ITEMS.backgrounds.forEach(bg => {
                    const isPurchased = gamificationData.purchasedItems[bg.id];
                    const isActive = gamificationData.activeBackground === bg.class;
                    
                    const itemEl = document.createElement('div');
                    itemEl.className = 'col-md-6';
                    itemEl.innerHTML = `
                        <div class="card shop-item ${isPurchased ? 'purchased' : ''} ${isActive ? 'active' : ''} ${!isPurchased && gamificationData.userPoints < bg.cost ? 'locked' : ''}">
                            <div class="card-body">
                                <h6><i class="bi bi-image"></i> ${bg.name}</h6>
                                <p class="small text-muted">${bg.description}</p>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <span class="badge bg-warning">${bg.cost} pt</span>
                                    <div>
                                        ${!isPurchased && !isActive ? 
                                            `<button class="btn btn-sm btn-outline-info me-1" onclick="previewBackground('${bg.class}')" title="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
                                                <i class="bi bi-eye"></i> è©¦ã™
                                            </button>` : ''
                                        }
                                        ${isPurchased ? 
                                            (isActive ? 
                                                '<div class="btn-group btn-group-sm">' +
                                                '<button class="btn btn-primary" disabled>é©ç”¨ä¸­</button>' +
                                                '<button class="btn btn-outline-secondary" onclick="applyBackground(\'\')" title="å¤–ã™"><i class="bi bi-x"></i></button>' +
                                                '</div>' : 
                                                `<button class="btn btn-sm btn-success" onclick="applyBackground('${bg.class}')">é©ç”¨</button>`) :
                                            `<button class="btn btn-sm btn-warning" onclick="purchaseItem('${bg.id}', ${bg.cost}, 'background')">è³¼å…¥</button>`
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    bgContainer.appendChild(itemEl);
                });
            }
            
            // Populate icons
            const iconContainer = document.getElementById('icon-shop-items');
            if (iconContainer) {
                iconContainer.innerHTML = '';
                SHOP_ITEMS.icons.forEach(icon => {
                    const isPurchased = gamificationData.purchasedItems[icon.id];
                    
                    const itemEl = document.createElement('div');
                    itemEl.className = 'col-md-6';
                    itemEl.innerHTML = `
                        <div class="card shop-item ${isPurchased ? 'purchased' : ''} ${!isPurchased && gamificationData.userPoints < icon.cost ? 'locked' : ''}">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="fs-2 me-2">${icon.emoji}</span>
                                    <h6 class="mb-0">${icon.name}</h6>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-warning">${icon.cost} pt</span>
                                    ${isPurchased ? 
                                        '<span class="badge bg-success">è³¼å…¥æ¸ˆã¿</span>' :
                                        `<button class="btn btn-sm btn-warning" onclick="purchaseItem('${icon.id}', ${icon.cost}, 'icon')">è³¼å…¥</button>`
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                    iconContainer.appendChild(itemEl);
                });
            }
            
        };
        
        // Purchase item
        // Toggle daily challenges visibility
        window.toggleDailyChallenges = () => {
            const body = document.getElementById('daily-challenges-body');
            const icon = document.getElementById('daily-challenges-toggle-icon');
            const isHidden = body.style.display === 'none';
            
            if (isHidden) {
                body.style.display = '';
                icon.className = 'bi bi-eye-slash';
                localStorage.setItem('hideDailyChallenges', 'false');
            } else {
                body.style.display = 'none';
                icon.className = 'bi bi-eye';
                localStorage.setItem('hideDailyChallenges', 'true');
            }
        };
        
        window.purchaseItem = (itemId, cost, type) => {
            if (gamificationData.userPoints < cost) {
                alert('ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“ï¼');
                return;
            }
            
            if (confirm(`${cost}ptã‚’ä½¿ã£ã¦è³¼å…¥ã—ã¾ã™ã‹ï¼Ÿ`)) {
                gamificationData.userPoints -= cost;
                
                if (type === 'theme' || type === 'frame' || type === 'background' || type === 'icon' || type === 'effect') {
                    gamificationData.purchasedItems[itemId] = true;
                    saveGamificationData();
                    
                    // Apply effect immediately if it's an effect
                    if (type === 'effect') {
                        document.body.classList.add(itemId);
                    }
                }
                
                updatePointsDisplay();
                initializeShop();
                alert('è³¼å…¥ã—ã¾ã—ãŸï¼');
            }
        };
        
        // Apply theme
        window.applyTheme = (themeClass) => {
            // Remove all theme classes
            const allThemeClasses = SHOP_ITEMS.themes.map(t => t.class);
            document.body.classList.remove(...allThemeClasses);
            
            if (themeClass !== 'default') {
                document.body.classList.add(themeClass);
            }
            
            gamificationData.activeTheme = themeClass;
            saveGamificationData();
            initializeShop();
        };
        
        // Apply frame
        window.applyFrame = (frameClass) => {
            // Remove all frame classes
            const allFrameClasses = SHOP_ITEMS.frames.map(f => f.class);
            document.body.classList.remove(...allFrameClasses);
            
            if (frameClass && frameClass !== 'none') {
                document.body.classList.add(frameClass);
            }
            
            gamificationData.activeFrame = frameClass;
            saveGamificationData();
            initializeShop();
        };
        
        // Apply background
        window.applyBackground = (bgClass) => {
            // Remove all background classes
            const allBgClasses = SHOP_ITEMS.backgrounds.map(b => b.class);
            document.body.classList.remove(...allBgClasses);
            
            if (bgClass && bgClass !== 'none') {
                document.body.classList.add(bgClass);
            }
            
            gamificationData.activeBackground = bgClass;
            saveGamificationData();
            initializeShop();
        };
        
        // Apply icon
        window.applyIcon = (iconClass) => {
            // Remove all icon classes
            const allIconClasses = SHOP_ITEMS.icons.map(i => i.class);
            document.body.classList.remove(...allIconClasses);
            
            if (iconClass && iconClass !== 'none') {
                document.body.classList.add(iconClass);
            }
            
            gamificationData.activeIcon = iconClass;
            saveGamificationData();
            initializeShop();
        };
        
        // Apply effect (effects are permanent once purchased)
        window.applyEffect = (effectId) => {
            if (gamificationData.purchasedItems[effectId]) {
                document.body.classList.add(effectId);
            }
        };
        
        // Show notification function
        const showNotification = (message, type = 'info') => {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} position-fixed top-0 start-50 translate-middle-x mt-3`;
            notification.style.zIndex = '9999';
            notification.style.minWidth = '300px';
            notification.textContent = message;
            
            // Add to body
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        };
        
        // Preview frame (temporary application)
        window.previewFrame = (frameClass) => {
            // First store the current frame
            const currentFrame = gamificationData.activeFrame;
            
            // Apply the preview frame
            const allFrameClasses = SHOP_ITEMS.frames.map(f => f.class);
            document.body.classList.remove(...allFrameClasses);
            
            if (frameClass && frameClass !== 'none') {
                document.body.classList.add(frameClass);
            }
            
            // Show a notification
            showNotification('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­... 5ç§’å¾Œã«å…ƒã«æˆ»ã‚Šã¾ã™', 'info');
            
            // Revert after 5 seconds
            setTimeout(() => {
                document.body.classList.remove(...allFrameClasses);
                if (currentFrame && currentFrame !== 'none') {
                    document.body.classList.add(currentFrame);
                }
                showNotification('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼çµ‚äº†', 'secondary');
            }, 5000);
        };
        
        // Preview background (temporary application)
        window.previewBackground = (bgClass) => {
            // First store the current background
            const currentBg = gamificationData.activeBackground;
            
            // Apply the preview background
            const allBgClasses = SHOP_ITEMS.backgrounds.map(b => b.class);
            document.body.classList.remove(...allBgClasses);
            
            if (bgClass && bgClass !== 'none') {
                document.body.classList.add(bgClass);
            }
            
            // Show a notification
            showNotification('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­... 5ç§’å¾Œã«å…ƒã«æˆ»ã‚Šã¾ã™', 'info');
            
            // Revert after 5 seconds
            setTimeout(() => {
                document.body.classList.remove(...allBgClasses);
                if (currentBg && currentBg !== 'none') {
                    document.body.classList.add(currentBg);
                }
                showNotification('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼çµ‚äº†', 'secondary');
            }, 5000);
        };
        
        // Initialize fun dashboard
        const initializeFunDashboard = () => {
            updateTimeDisplay();
            updateDailyMissions();
            updateRegistrationStreak();
            updateTodayStats();
            updatePointsDisplay();
            
            // Update time every minute
            setInterval(updateTimeDisplay, 60000);
        };
        
        // Track when card is added
        const trackCardAddition = (cardData, hasTag, isRare) => {
            const today = new Date().toDateString();
            const cardCount = cardData.æšæ•° || 1;
            
            // Update daily mission progress
            gamificationData.dailyMissionProgress.addedCards.push({ name: cardData.åå‰, time: Date.now() });
            if (hasTag) gamificationData.dailyMissionProgress.addedWithTag++;
            if (isRare) gamificationData.dailyMissionProgress.addedRare++;
            
            saveGamificationData();
            
            // Update today's additions
            if (gamificationData.todayAdditions.date !== today) {
                gamificationData.todayAdditions = { date: today, count: 0 };
            }
            gamificationData.todayAdditions.count += cardCount;
            
            // Update weekly goal
            const weekStart = getWeekStart();
            if (gamificationData.weeklyGoalData.weekStart !== weekStart) {
                gamificationData.weeklyGoalData = { weekStart: weekStart, count: 0, goal: 50 };
            }
            gamificationData.weeklyGoalData.count += cardCount;
            
            // Update registration streak
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            
            if (gamificationData.registrationStreak.lastDate === today) {
                // Already added today, no change
            } else if (gamificationData.registrationStreak.lastDate === yesterday) {
                // Continue streak
                gamificationData.registrationStreak.count++;
                gamificationData.registrationStreak.lastDate = today;
            } else {
                // Start new streak
                gamificationData.registrationStreak.count = 1;
                gamificationData.registrationStreak.lastDate = today;
            }
            
            saveGamificationData();
            
            // Update displays
            updateDailyMissions();
            updateRegistrationStreak();
            updateTodayStats();
        };
        
        // Track search action
        const trackSearchAction = () => {
            gamificationData.dailyMissionProgress.searchCount++;
            saveGamificationData();
            updateDailyMissions();
        };
        
        // Reset first login bonus (for testing or special cases)
        window.resetFirstLoginBonus = async () => {
            gamificationData.hasReceivedFirstLoginBonus = false;
            await saveGamificationData();
            console.log('åˆå›ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚æ¬¡å›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«å†åº¦å—ã‘å–ã‚Œã¾ã™ã€‚');
        };
        
        // Check and grant first login bonus
        const checkFirstLoginBonus = (user) => {
            // Check if user has already received the bonus (using Firebase data)
            if (!gamificationData.hasReceivedFirstLoginBonus) {
                // First time login - grant 50 points
                addPoints(50, 'åˆå›ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹ï¼');
                
                // Mark as received in Firebase
                gamificationData.hasReceivedFirstLoginBonus = true;
                saveGamificationData();
                
                // Check if user already has cards and grant retroactive points
                setTimeout(() => {
                    let totalCards = 0;
                    cardCollection.forEach(card => {
                        totalCards += card.data.æšæ•° || 0;
                    });
                    
                    if (totalCards > 0) {
                        const retroactivePoints = totalCards * 5;
                        addPoints(retroactivePoints, `æ—¢å­˜ã‚«ãƒ¼ãƒ‰ ${totalCards}æšåˆ†ã®ãƒã‚¤ãƒ³ãƒˆ`);
                        
                        // Show special notification
                        const notification = document.createElement('div');
                        notification.className = 'position-fixed top-50 start-50 translate-middle';
                        notification.style.zIndex = '10000';
                        notification.innerHTML = `
                            <div class="card shadow-lg border-warning" style="min-width: 300px;">
                                <div class="card-body text-center">
                                    <h5 class="card-title text-warning">
                                        <i class="bi bi-gift-fill"></i> ç‰¹åˆ¥ãƒœãƒ¼ãƒŠã‚¹ï¼
                                    </h5>
                                    <p class="card-text">
                                        åˆå›ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹: 50pt<br>
                                        æ—¢å­˜ã‚«ãƒ¼ãƒ‰ãƒœãƒ¼ãƒŠã‚¹: ${retroactivePoints}pt<br>
                                        <strong>åˆè¨ˆ: ${50 + retroactivePoints}pt ç²å¾—ï¼</strong>
                                    </p>
                                    <button class="btn btn-warning" onclick="this.closest('.position-fixed').remove()">
                                        ã‚ã‚ŠãŒã¨ã†ï¼
                                    </button>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(notification);
                    } else {
                        // Show welcome notification for new users
                        const notification = document.createElement('div');
                        notification.className = 'position-fixed top-50 start-50 translate-middle';
                        notification.style.zIndex = '10000';
                        notification.innerHTML = `
                            <div class="card shadow-lg border-success" style="min-width: 300px;">
                                <div class="card-body text-center">
                                    <h5 class="card-title text-success">
                                        <i class="bi bi-star-fill"></i> ã‚ˆã†ã“ãï¼
                                    </h5>
                                    <p class="card-text">
                                        åˆå›ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹ã¨ã—ã¦<br>
                                        <strong>50ãƒã‚¤ãƒ³ãƒˆ</strong>ã‚’ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆï¼
                                    </p>
                                    <button class="btn btn-success" onclick="this.closest('.position-fixed').remove()">
                                        å§‹ã‚ã‚‹ï¼
                                    </button>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(notification);
                    }
                }, 1000); // Wait for cards to load
            }
        };
        
        const updateCollectionStats = () => {
            // Check if stats should be hidden
            const hideStats = localStorage.getItem('hideStats') === 'true';
            const statsDiv = document.getElementById('stats-dashboard');
            if (hideStats) {
                statsDiv.style.display = 'none';
                return;
            } else {
                statsDiv.style.display = 'block';
            }
            
            const totalCards = cardCollection.reduce((sum, card) => sum + (card.data['æšæ•°'] || 0), 0);
            const uniqueCards = cardCollection.length;
            
            // Set first collection date if not set
            if (totalCards > 0 && !gamificationData.firstCollectionDate) {
                gamificationData.firstCollectionDate = new Date().toISOString();
                saveGamificationData();
            }
            
            // Calculate collection days
            const collectionDays = gamificationData.firstCollectionDate ? 
                Math.floor((new Date() - new Date(gamificationData.firstCollectionDate)) / (1000 * 60 * 60 * 24)) + 1 : 0;
            
            // Calculate cards added this week
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            let recentCards = 0;
            
            Object.entries(gamificationData.cardAdditionDates).forEach(([cardId, dateAdded]) => {
                if (new Date(dateAdded) >= oneWeekAgo) {
                    const card = cardCollection.find(c => c.id === cardId);
                    if (card) {
                        recentCards += card.data['æšæ•°'] || 0;
                    }
                }
            });
            
            // Build rarity distribution
            let rarityDistribution = {};
            
            cardCollection.forEach(card => {
                const rarity = card.data['ãƒ¬ã‚¢ãƒªãƒ†ã‚£'] || 'N';
                const quantity = card.data['æšæ•°'] || 0;
                
                if (!rarityDistribution[rarity]) {
                    rarityDistribution[rarity] = 0;
                }
                rarityDistribution[rarity] += quantity;
            });
            
            // Update display
            document.getElementById('total-cards').textContent = totalCards.toLocaleString();
            document.getElementById('unique-cards').textContent = uniqueCards.toLocaleString();
            document.getElementById('collection-days').textContent = collectionDays.toLocaleString();
            document.getElementById('recent-cards').textContent = recentCards.toLocaleString();
            
            // Update collector rank
            updateCollectorRank(totalCards);
            
            // Update milestone progress
            updateMilestoneProgress(totalCards);
            
            // Update achievements
            updateAchievements(totalCards, uniqueCards, collectionDays, rarityDistribution);
            
            // Update rarity chart
            updateRarityChart(rarityDistribution, totalCards);
            
            // Check for new milestones
            checkMilestone(totalCards);
        };
        
        const updateCollectorRank = (totalCards) => {
            const rankEl = document.getElementById('collector-rank');
            let rank = '';
            let rankClass = '';
            let rankStyle = '';
            
            if (totalCards >= 100000) {
                rank = 'å‰µä¸–ç¥';
                rankClass = 'badge ms-2';
                rankStyle = 'background: linear-gradient(45deg, #ff00ff, #00ffff, #ffff00, #ff00ff); background-size: 400% 400%; animation: rainbow 3s ease infinite; color: white; font-weight: bold;';
            } else if (totalCards >= 50000) {
                rank = 'ç¥è©±';
                rankClass = 'badge ms-2';
                rankStyle = 'background: linear-gradient(45deg, #ffd700, #ff6b6b, #ffd700); animation: shine 2s infinite; color: white;';
            } else if (totalCards >= 25000) {
                rank = 'å¤©å¸';
                rankClass = 'badge ms-2';
                rankStyle = 'background: linear-gradient(45deg, #b9f2ff, #00d4ff); animation: sparkle 2s infinite; color: white;';
            } else if (totalCards >= 10000) {
                rank = 'è¦‡ç‹';
                rankClass = 'badge ms-2';
                rankStyle = 'background: linear-gradient(45deg, #845ef7, #5c7cfa); color: white;';
            } else if (totalCards >= 5000) {
                rank = 'è‹±é›„';
                rankClass = 'badge ms-2';
                rankStyle = 'background: linear-gradient(45deg, #ff6b6b, #ffd43b); color: white;';
            } else if (totalCards >= 2500) {
                rank = 'è³¢è€…';
                rankClass = 'badge ms-2';
                rankStyle = 'background: linear-gradient(45deg, #51cf66, #12b886); color: white;';
            } else if (totalCards >= 1000) {
                rank = 'ä¼èª¬';
                rankClass = 'bg-danger';
            } else if (totalCards >= 500) {
                rank = 'ãƒã‚¹ã‚¿ãƒ¼';
                rankClass = 'bg-warning';
            } else if (totalCards >= 300) {
                rank = 'ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ';
                rankClass = 'bg-info';
            } else if (totalCards >= 100) {
                rank = 'ä¸Šç´š';
                rankClass = 'bg-success';
            } else if (totalCards >= 50) {
                rank = 'ä¸­ç´š';
                rankClass = 'bg-primary';
            } else if (totalCards >= 10) {
                rank = 'åˆç´š';
                rankClass = 'bg-secondary';
            } else {
                rank = 'è¦‹ç¿’ã„';
                rankClass = 'bg-secondary';
            }
            
            rankEl.textContent = rank;
            rankEl.className = `badge ${rankClass} ms-2`;
            if (rankStyle) {
                rankEl.style = rankStyle;
            } else {
                rankEl.style = '';
            }
        };
        
        const updateMilestoneProgress = (totalCards) => {
            const progressContainer = document.getElementById('milestone-progress');
            const nextMilestone = MILESTONES.find(m => m > totalCards);
            
            if (nextMilestone) {
                const prevMilestone = MILESTONES[MILESTONES.indexOf(nextMilestone) - 1] || 0;
                const progress = ((totalCards - prevMilestone) / (nextMilestone - prevMilestone)) * 100;
                
                document.getElementById('milestone-text').textContent = `${nextMilestone}æš (æ®‹ã‚Š${nextMilestone - totalCards}æš)`;
                document.getElementById('milestone-bar').style.width = `${progress}%`;
                document.getElementById('milestone-percent').textContent = `${Math.floor(progress)}%`;
                progressContainer.style.display = 'block';
            } else {
                progressContainer.style.display = 'none';
            }
        };
        
        const updateAchievements = (totalCards, uniqueCards, collectionDays, rarityDistribution) => {
            const summaryContainer = document.getElementById('achievement-summary-container');
            const detailsContainer = document.getElementById('achievement-details');
            
            summaryContainer.innerHTML = '';
            detailsContainer.innerHTML = '';
            
            // Calculate special counts
            const rareCount = Object.entries(rarityDistribution)
                .filter(([rarity]) => rarity.toLowerCase().includes('ãƒ¬ã‚¢') || rarity.toLowerCase().includes('r'))
                .reduce((sum, [, count]) => sum + count, 0);
            
            const srCount = Object.entries(rarityDistribution)
                .filter(([rarity]) => rarity.toUpperCase().includes('SR'))
                .reduce((sum, [, count]) => sum + count, 0);
            
            const urCount = Object.entries(rarityDistribution)
                .filter(([rarity]) => rarity.toUpperCase().includes('UR'))
                .reduce((sum, [, count]) => sum + count, 0);
            
            const seCount = Object.entries(rarityDistribution)
                .filter(([rarity]) => rarity.toUpperCase().includes('SE'))
                .reduce((sum, [, count]) => sum + count, 0);
            
            const premiumCount = Object.entries(rarityDistribution)
                .filter(([rarity]) => rarity.toUpperCase().includes('P'))
                .reduce((sum, [, count]) => sum + count, 0);
            
            const ulCount = Object.entries(rarityDistribution)
                .filter(([rarity]) => rarity.toUpperCase().includes('UL'))
                .reduce((sum, [, count]) => sum + count, 0);
            
            const qcseCount = Object.entries(rarityDistribution)
                .filter(([rarity]) => rarity.toUpperCase().includes('QCSE'))
                .reduce((sum, [, count]) => sum + count, 0);
            
            // Track daily/weekly additions
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const weekAgo = new Date(today - 7 * 24 * 60 * 60 * 1000);
            
            let dailyAdditions = 0;
            let weeklyAdditions = 0;
            Object.entries(gamificationData.cardAdditionDates).forEach(([cardId, dateStr]) => {
                const date = new Date(dateStr);
                const dateOnly = dateStr.split('T')[0];
                if (dateOnly === todayStr) {
                    const card = cardCollection.find(c => c.id === cardId);
                    if (card) dailyAdditions += card.data['æšæ•°'] || 0;
                }
                if (date >= weekAgo) {
                    const card = cardCollection.find(c => c.id === cardId);
                    if (card) weeklyAdditions += card.data['æšæ•°'] || 0;
                }
            });
            
            // Count tags
            const allTags = new Set();
            cardCollection.forEach(card => {
                if (card.data.tags) {
                    card.data.tags.forEach(tag => allTags.add(tag));
                }
            });
            const tagCount = allTags.size;
            
            // Create summary for each category
            Object.entries(ACHIEVEMENT_CATEGORIES).forEach(([category, achievements]) => {
                const summary = document.createElement('div');
                summary.className = 'achievement-summary';
                
                // Calculate progress for this category
                let unlockedCount = 0;
                achievements.forEach(ach => {
                    let progress = 0;
                    if (ach.type === 'unique') progress = uniqueCards;
                    else if (ach.type === 'days') progress = collectionDays;
                    else if (ach.type === 'rarity') progress = rareCount;
                    else if (ach.type === 'sr') progress = srCount;
                    else if (ach.type === 'ur') progress = urCount;
                    else if (ach.type === 'se') progress = seCount;
                    else if (ach.type === 'premium') progress = premiumCount;
                    else if (ach.type === 'ul') progress = ulCount;
                    else if (ach.type === 'qcse') progress = qcseCount;
                    else if (ach.type === 'daily') progress = dailyAdditions;
                    else if (ach.type === 'weekly') progress = weeklyAdditions;
                    else if (ach.type === 'tags') progress = tagCount;
                    else progress = totalCards;
                    
                    if (progress >= ach.threshold) unlockedCount++;
                });
                
                const totalInCategory = achievements.length;
                const percentage = Math.round((unlockedCount / totalInCategory) * 100);
                
                summary.innerHTML = `
                    <div style="flex: 1;">
                        <strong>${category}</strong>
                        <small class="text-muted ms-2">${unlockedCount}/${totalInCategory} (${percentage}%)</small>
                    </div>
                    <div class="achievement-progress">
                        ${achievements.slice(0, 8).map(ach => {
                            let progress = 0;
                            if (ach.type === 'unique') progress = uniqueCards;
                            else if (ach.type === 'days') progress = collectionDays;
                            else if (ach.type === 'rarity') progress = rareCount;
                            else if (ach.type === 'sr') progress = srCount;
                            else if (ach.type === 'ur') progress = urCount;
                            else if (ach.type === 'se') progress = seCount;
                            else if (ach.type === 'premium') progress = premiumCount;
                            else if (ach.type === 'ul') progress = ulCount;
                            else if (ach.type === 'qcse') progress = qcseCount;
                            else if (ach.type === 'daily') progress = dailyAdditions;
                            else if (ach.type === 'weekly') progress = weeklyAdditions;
                            else if (ach.type === 'tags') progress = tagCount;
                            else progress = totalCards;
                            
                            const unlocked = progress >= ach.threshold;
                            return `<div class="achievement-dot ${unlocked ? 'unlocked' : ''}" title="${ach.desc}"></div>`;
                        }).join('')}
                        ${achievements.length > 8 ? `<small class="text-muted">+${achievements.length - 8}</small>` : ''}
                    </div>
                    <i class="bi bi-chevron-down"></i>
                `;
                
                // Add click handler
                summary.addEventListener('click', () => {
                    const isOpen = detailsContainer.classList.contains('show');
                    
                    if (isOpen && detailsContainer.dataset.category === category) {
                        detailsContainer.classList.remove('show');
                        detailsContainer.innerHTML = '';
                        summary.querySelector('i').className = 'bi bi-chevron-down';
                    } else {
                        // Close other categories
                        document.querySelectorAll('.achievement-summary i').forEach(icon => {
                            icon.className = 'bi bi-chevron-down';
                        });
                        
                        // Show details for this category
                        detailsContainer.innerHTML = `
                            <h6>${category} å®Ÿç¸¾è©³ç´°</h6>
                            <div class="d-flex flex-wrap gap-1">
                                ${achievements.map(ach => {
                                    let progress = 0;
                                    if (ach.type === 'unique') progress = uniqueCards;
                                    else if (ach.type === 'days') progress = collectionDays;
                                    else if (ach.type === 'rarity') progress = rareCount;
                                    else if (ach.type === 'sr') progress = srCount;
                                    else if (ach.type === 'ur') progress = urCount;
                                    else if (ach.type === 'se') progress = seCount;
                                    else if (ach.type === 'premium') progress = premiumCount;
                                    else if (ach.type === 'ul') progress = ulCount;
                                    else if (ach.type === 'qcse') progress = qcseCount;
                                    else if (ach.type === 'daily') progress = dailyAdditions;
                                    else if (ach.type === 'weekly') progress = weeklyAdditions;
                                    else if (ach.type === 'tags') progress = tagCount;
                                    else progress = totalCards;
                                    
                                    const unlocked = progress >= ach.threshold;
                                    return `
                                        <div class="achievement-badge ${unlocked ? ach.class : 'locked'}" 
                                             title="${ach.desc}${unlocked ? ' âœ“' : ` (${progress}/${ach.threshold})`}">
                                            ${unlocked ? 'ğŸ†' : 'ğŸ”’'} ${ach.name}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `;
                        detailsContainer.classList.add('show');
                        detailsContainer.dataset.category = category;
                        summary.querySelector('i').className = 'bi bi-chevron-up';
                    }
                });
                
                summaryContainer.appendChild(summary);
            });
        };
        
        const updateRarityChart = (distribution, total) => {
            const container = document.getElementById('rarity-chart-container');
            const barsContainer = document.getElementById('rarity-bars');
            
            if (Object.keys(distribution).length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            barsContainer.innerHTML = '';
            
            // Define rarity order and colors
            const rarityOrder = ['N', 'P', 'R', 'SR', 'P+SR', 'UR', 'P+UR', 'UL', 'GR', 'CR', 'HR', 'SE', 'EXSE', 'GSE', 'PSE', 'QCSE'];
            const rarityColors = {
                'N': '#868e96',
                'P': '#339af0',
                'R': '#51cf66',
                'SR': '#ffd43b',
                'P+SR': '#ff922b',
                'UR': '#ff6b6b',
                'P+UR': '#f06595',
                'UL': '#cc5de8',
                'GR': '#845ef7',
                'CR': '#5c7cfa',
                'HR': '#4c6ef5',
                'SE': '#748ffc',
                'EXSE': '#91a7ff',
                'GSE': '#dbe4ff',
                'PSE': '#e7f5ff',
                'QCSE': '#a5d8ff',
                'default': '#868e96'
            };
            
            // Get max count for percentage calculation
            const maxCount = Math.max(...Object.values(distribution));
            
            // Display in defined order
            rarityOrder.forEach(rarityKey => {
                // Check if this rarity exists in distribution
                let count = 0;
                Object.entries(distribution).forEach(([rarity, cardCount]) => {
                    if (rarity === rarityKey || rarity.toUpperCase().includes(rarityKey)) {
                        count += cardCount;
                    }
                });
                
                if (count > 0) {
                    const percentage = (count / maxCount) * 100;
                    const color = rarityColors[rarityKey] || rarityColors.default;
                    
                    const bar = document.createElement('div');
                    bar.className = 'rarity-bar';
                    bar.style.setProperty('--bar-height', `${percentage}%`);
                    bar.style.setProperty('--bar-color', color);
                    bar.innerHTML = `
                        <span class="rarity-bar-count">${count}</span>
                        <span class="rarity-bar-label">${rarityKey}</span>
                    `;
                    barsContainer.appendChild(bar);
                }
            });
            
            // Add any rarities not in the defined order
            Object.entries(distribution).forEach(([rarity, count]) => {
                const isInOrder = rarityOrder.some(key => 
                    rarity === key || rarity.toUpperCase().includes(key)
                );
                
                if (!isInOrder && count > 0) {
                    const percentage = (count / maxCount) * 100;
                    const bar = document.createElement('div');
                    bar.className = 'rarity-bar';
                    bar.style.setProperty('--bar-height', `${percentage}%`);
                    bar.style.setProperty('--bar-color', rarityColors.default);
                    bar.innerHTML = `
                        <span class="rarity-bar-count">${count}</span>
                        <span class="rarity-bar-label">${rarity.substring(0, 4)}</span>
                    `;
                    barsContainer.appendChild(bar);
                }
            });
        };
        
        const checkMilestone = (totalCards) => {
            const milestone = MILESTONES.find(m => m === totalCards);
            if (milestone && milestone > gamificationData.lastMilestoneReached) {
                gamificationData.lastMilestoneReached = milestone;
                saveGamificationData();
                showMilestoneNotification(milestone);
            }
        };
        
        const showMilestoneNotification = (milestone) => {
            const notification = document.createElement('div');
            notification.className = 'milestone-notification';
            notification.innerHTML = `
                <div class="alert alert-success shadow-lg">
                    <h5 class="alert-heading">ğŸ‰ ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é”æˆï¼</h5>
                    <p class="mb-0"><strong>${milestone}æš</strong>ã®ã‚«ãƒ¼ãƒ‰ã‚’åé›†ã—ã¾ã—ãŸï¼</p>
                    <hr>
                    <p class="mb-0 small">ç´ æ™´ã‚‰ã—ã„æˆæœã§ã™ï¼æ¬¡ã®ç›®æ¨™ã«å‘ã‹ã£ã¦é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼</p>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        };
        
        // Helper function to normalize text for search
        const normalizeForSearch = (text) => {
            if (!text) return '';
            
            // Convert to lowercase
            text = text.toLowerCase();
            
            // Convert katakana to hiragana
            text = text.replace(/[ã‚¡-ãƒ¶]/g, (match) => {
                const code = match.charCodeAt(0) - 0x60;
                return String.fromCharCode(code);
            });
            
            // Convert full-width alphanumeric to half-width
            text = text.replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, (match) => {
                return String.fromCharCode(match.charCodeAt(0) - 0xFEE0);
            });
            
            // Convert full-width space to half-width
            text = text.replace(/ã€€/g, ' ');
            
            return text;
        };
        
        const applySearchAndFilter = () => {
            const [sN,sC,sR,sT] = ['search_name','search_set_code','search_rarity','search_tags'].map(n=>normalizeForSearch(document.querySelector(`[name="${n}"]`).value));
            filteredCardCollection = getCurrentCollection().filter(c => {
                const d = c.data;
                return (!sN || normalizeForSearch(d['åå‰']||'').includes(sN)) && 
                       (!sC || normalizeForSearch(d['å‹ç•ª']||'').includes(sC)) && 
                       (!sR || normalizeForSearch(d['ãƒ¬ã‚¢ãƒªãƒ†ã‚£']||'').includes(sR)) && 
                       (!sT || normalizeForSearch((d.tags||[]).join(',')).includes(sT));
            });
            currentPage = 1;
            renderTable();
        };

        const getTagsCollectionRef = () => currentUser?.uid !== 'local_user' ? collection(db, "users", currentUser.uid, "tags") : null;

        const loadAllTags = async () => {
            const tagsCollRef = getTagsCollectionRef();
            if (tagsCollRef) {
                const snapshot = await getDocs(query(tagsCollRef));
                allTags = snapshot.docs.map((doc, index) => ({ 
                    id: doc.id, 
                    name: doc.data().name,
                    order: doc.data().order !== undefined ? doc.data().order : index
                }));
                
                let needsOrderUpdate = false;
                allTags.forEach((tag, index) => {
                    if (tag.order === undefined || tag.order === 999) {
                        tag.order = index;
                        needsOrderUpdate = true;
                    }
                });
                
                if (needsOrderUpdate) {
                    await saveTagsOrder();
                }
            } else {
                const savedTagsOrder = localStorage.getItem('tagsOrder');
                if (savedTagsOrder) {
                    try {
                        allTags = JSON.parse(savedTagsOrder);
                    } catch (e) {
                        if (allTags.length === 0) {
                            allTags = [
                                { id: 'local1', name: 'ãƒ‡ãƒƒã‚­ãƒ‘ãƒ¼ãƒ„', order: 0 }, 
                                { id: 'local2', name: 'ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³', order: 1 }
                            ];
                        }
                    }
                } else if (allTags.length === 0) {
                    allTags = [
                        { id: 'local1', name: 'ãƒ‡ãƒƒã‚­ãƒ‘ãƒ¼ãƒ„', order: 0 }, 
                        { id: 'local2', name: 'ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³', order: 1 }
                    ];
                }
            }
            allTags.sort((a, b) => (a.order !== undefined ? a.order : 999) - (b.order !== undefined ? b.order : 999));
            renderTagManagementList();
            if (addForm.offsetParent !== null) renderTagChoices('tag-choices-container', currentCardTags);
            if (editCardModal._element.classList.contains('show')) renderTagChoices('edit-tag-choices-container', currentCardTags);
        };

        const renderTagManagementList = () => {
            const container = document.getElementById('existing-tags-list');
            container.innerHTML = '';
            allTags.forEach((tag, index) => {
                const div = document.createElement('div');
                div.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border rounded draggable-tag';
                div.draggable = true;
                div.dataset.tagId = tag.id;
                div.dataset.tagIndex = index;
                div.innerHTML = `
                    <span><i class="bi bi-grip-vertical me-2"></i>${escapeHtml(tag.name)}</span>
                    <button class="btn btn-outline-danger btn-sm delete-tag-btn" data-id="${escapeHtml(tag.id)}" data-name="${escapeHtml(tag.name)}">å‰Šé™¤</button>
                `;
                
                div.addEventListener('dragstart', handleTagDragStart);
                div.addEventListener('dragend', handleTagDragEnd);
                div.addEventListener('dragover', handleTagDragOver);
                div.addEventListener('drop', handleTagDrop);
                div.addEventListener('dragenter', handleTagDragEnter);
                div.addEventListener('dragleave', handleTagDragLeave);
                
                container.appendChild(div);
            });
        };
        
        let draggedTag = null;
        
        const handleTagDragStart = (e) => {
            draggedTag = e.currentTarget;
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        };
        
        const handleTagDragEnd = (e) => {
            e.currentTarget.classList.remove('dragging');
            document.querySelectorAll('.draggable-tag').forEach(tag => {
                tag.classList.remove('drag-over');
            });
        };
        
        const handleTagDragOver = (e) => {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        };
        
        const handleTagDragEnter = (e) => {
            if (draggedTag && e.currentTarget !== draggedTag) {
                e.currentTarget.classList.add('drag-over');
            }
        };
        
        const handleTagDragLeave = (e) => {
            e.currentTarget.classList.remove('drag-over');
        };
        
        const handleTagDrop = async (e) => {
            if (e.stopPropagation) e.stopPropagation();
            e.currentTarget.classList.remove('drag-over');
            
            if (draggedTag && e.currentTarget !== draggedTag) {
                const draggedIndex = parseInt(draggedTag.dataset.tagIndex);
                const targetIndex = parseInt(e.currentTarget.dataset.tagIndex);
                
                const draggedItem = allTags[draggedIndex];
                allTags.splice(draggedIndex, 1);
                allTags.splice(targetIndex, 0, draggedItem);
                
                allTags.forEach((tag, index) => {
                    tag.order = index;
                });
                
                await saveTagsOrder();
                
                renderTagManagementList();
                renderTagChoices('tag-choices-container', currentCardTags);
                renderTagChoices('edit-tag-choices-container', currentCardTags);
            }
            
            return false;
        };
        
        const saveTagsOrder = async () => {
            const tagsCollRef = getTagsCollectionRef();
            if (tagsCollRef) {
                try {
                    const batch = writeBatch(db);
                    for (const tag of allTags) {
                        const tagDoc = doc(tagsCollRef, tag.id);
                        batch.set(tagDoc, { 
                            name: tag.name,
                            order: tag.order 
                        }, { merge: true });
                    }
                    await batch.commit();
                } catch (error) {
                }
            } else {
                localStorage.setItem('tagsOrder', JSON.stringify(allTags));
            }
        };

        document.getElementById('add-tag-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const inputValue = document.getElementById('new-tag-name').value.trim();
            if (!inputValue) return;
            
            const newTagNames = inputValue.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
            
            if (newTagNames.length === 0) {
                alert('æœ‰åŠ¹ãªã‚¿ã‚°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            const tagsCollRef = getTagsCollectionRef();
            const addedTags = [];
            const duplicateTags = [];
            
            for (const newTagName of newTagNames) {
                if (allTags.some(tag => tag.name === newTagName)) {
                    duplicateTags.push(newTagName);
                } else {
                    const maxOrder = allTags.reduce((max, tag) => Math.max(max, tag.order || 0), -1);
                    const newOrder = maxOrder + 1;
                    
                    if (tagsCollRef) {
                        const docRef = await addDoc(tagsCollRef, { name: newTagName, order: newOrder });
                        allTags.push({ id: docRef.id, name: newTagName, order: newOrder });
                    } else {
                        allTags.push({ id: `local_${Date.now()}_${Math.random()}`, name: newTagName, order: newOrder });
                    }
                    addedTags.push(newTagName);
                }
            }
            
            if (duplicateTags.length > 0) {
                alert(`ä»¥ä¸‹ã®ã‚¿ã‚°ã¯æ—¢ã«å­˜åœ¨ã™ã‚‹ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ: ${duplicateTags.join(', ')}`);
            }
            
            if (addedTags.length > 0) {
                document.getElementById('new-tag-name').value = '';
                if (!tagsCollRef) {
                    localStorage.setItem('tagsOrder', JSON.stringify(allTags));
                }
                allTags.sort((a, b) => (a.order !== undefined ? a.order : 999) - (b.order !== undefined ? b.order : 999));
                renderTagManagementList();
                renderTagChoices('tag-choices-container', currentCardTags);
                renderTagChoices('edit-tag-choices-container', currentCardTags);
            }
        });

        document.getElementById('existing-tags-list').addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-tag-btn')) {
                const tagId = e.target.dataset.id;
                const tagName = e.target.dataset.name;
                if (!confirm(`ã‚¿ã‚°ã€Œ${escapeHtml(tagName)}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ
ã“ã®ã‚¿ã‚°ã¯å…¨ã¦ã®ã‚«ãƒ¼ãƒ‰ã‹ã‚‰ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) return;

                const tagsCollRef = getTagsCollectionRef();
                if (tagsCollRef) {
                    await deleteDoc(doc(tagsCollRef, tagId));
                } 
                
                allTags = allTags.filter(t => t.id !== tagId);
                allTags.forEach((tag, index) => {
                    tag.order = index;
                });
                
                await saveTagsOrder();
                
                renderTagManagementList();
                renderTagChoices('tag-choices-container', currentCardTags);
                renderTagChoices('edit-tag-choices-container', currentCardTags);
            }
        });

        const getCollectionRef = (listType = 'collection') => {
            if (currentUser && currentUser.uid !== 'local_user') {
                const collectionName = listType === 'collection' ? "cards" : "wishlist";
                return collection(db, "users", currentUser.uid, collectionName);
            }
            return null;
        };

        const loadCollectionFromFirestore = async () => {
            if (!currentUser) return;
            showLoading(true);
            
            const cardSnapshot = await getDocs(query(getCollectionRef('collection')));
            cardCollection = cardSnapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
            
            const wishlistSnapshot = await getDocs(query(getCollectionRef('wishlist')));
            wishlistCollection = wishlistSnapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
            
            updateTotalCounts(); // Update stats
            applySearchAndFilter();
            showLoading(false);
        };

        const handleUserLogin = async (user) => {
            currentUser = user;
            const hideEmail = localStorage.getItem('hideEmail') === 'true';
            userEmailSpan.textContent = hideEmail ? '' : escapeHtml(user.email);
            mainApp.style.display = 'block';
            appLoader.style.display = 'none';
            authModal.hide();
            
            // Load gamification data from Firebase
            await loadGamificationData();
            
            if (user.uid !== 'local_user') {
                loadCollectionFromFirestore();
                loadAllTags();
            } else {
                cardCollection = [];
                wishlistCollection = [];
                updateTotalCounts(); // Update stats for local mode
                applySearchAndFilter();
                loadAllTags(); // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚ã‚¿ã‚°ã‚’ãƒ­ãƒ¼ãƒ‰ãƒ»åˆæœŸåŒ–
                document.getElementById('delete-account-btn').style.display = 'none';
            }
            applyTheme();
            
            // Initialize gamification features with loaded data
            initializeDailyMissions();
            initializeFunDashboard(); // Initialize fun features
            initializeShop(); // Initialize shop
            updatePointsDisplay();
            updateRegistrationStreak();
            updateTodayStats();
            updateDailyMissions();
            
            // Apply saved daily challenges visibility preference
            const hideDailyChallenges = localStorage.getItem('hideDailyChallenges') === 'true';
            if (hideDailyChallenges) {
                document.getElementById('daily-challenges-body').style.display = 'none';
                document.getElementById('daily-challenges-toggle-icon').className = 'bi bi-eye';
            }
            
            // Apply saved customizations from Firebase data
            if (gamificationData.activeTheme && gamificationData.activeTheme !== 'default') {
                window.applyTheme(gamificationData.activeTheme);
            }
            
            if (gamificationData.activeFrame) {
                window.applyFrame(gamificationData.activeFrame);
            }
            
            if (gamificationData.activeBackground) {
                window.applyBackground(gamificationData.activeBackground);
            }
            
            if (gamificationData.activeIcon) {
                window.applyIcon(gamificationData.activeIcon);
            }
            
            // Apply all purchased effects
            if (gamificationData.purchasedItems) {
                Object.keys(gamificationData.purchasedItems).forEach(itemId => {
                    if (itemId.startsWith('effect-') && gamificationData.purchasedItems[itemId]) {
                        document.body.classList.add(itemId);
                    }
                });
            }
            
            // Check for first login bonus
            checkFirstLoginBonus(user);
            
            // Add shop button event listener
            document.getElementById('point-shop-btn').addEventListener('click', () => {
                const shopModal = new bootstrap.Modal(document.getElementById('point-shop-modal'));
                shopModal.show();
            });
            
            // Add profile functionality
            initializeProfile();
            
            // Add ranking functionality
            initializeRanking();
        };
        
        // Track daily usage
        const trackDailyUsage = () => {
            const today = new Date().toISOString().split('T')[0];
            
            if (!gamificationData.profile) {
                gamificationData.profile = {
                    nickname: '',
                    icon: 'ğŸ‘¤',
                    firstUseDate: null,
                    lastUseDate: null,
                    usageDays: new Set(),
                    maxStreak: 0,
                    totalPointsEarned: 0
                };
            }
            
            // Initialize as Set if it's not
            if (!(gamificationData.profile.usageDays instanceof Set)) {
                gamificationData.profile.usageDays = new Set(gamificationData.profile.usageDays || []);
            }
            
            // Track first use date
            if (!gamificationData.profile.firstUseDate) {
                gamificationData.profile.firstUseDate = today;
            }
            
            // Add today to usage days
            gamificationData.profile.usageDays.add(today);
            
            // Update last use date
            gamificationData.profile.lastUseDate = today;
            
            // Update max streak
            if (gamificationData.registrationStreak.count > (gamificationData.profile.maxStreak || 0)) {
                gamificationData.profile.maxStreak = gamificationData.registrationStreak.count;
            }
            
            saveGamificationData();
        };
        
        // Variable to store selected icon
        let selectedIcon = 'ğŸ‘¤';
        
        // Update icon selector with all available icons
        const updateIconSelector = () => {
            const selectorContainer = document.getElementById('profile-icon-selector');
            selectorContainer.innerHTML = '';
            
            // Default icons (always available)
            const defaultIcons = [
                'ğŸ‘¤', 'ğŸ˜Š', 'ğŸ˜', 'ğŸ®', 'ğŸ¯', 'â­', 'ğŸ†', 'ğŸ’', 'ğŸ”¥', 'âš¡', 'ğŸŒŸ', 'ğŸ¨'
            ];
            
            // Add default icons
            defaultIcons.forEach(icon => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn btn-outline-secondary icon-select';
                btn.dataset.icon = icon;
                btn.textContent = icon;
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.icon-select').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedIcon = icon;
                });
                selectorContainer.appendChild(btn);
            });
            
            // Add purchased shop icons
            SHOP_ITEMS.icons.forEach(shopIcon => {
                if (gamificationData.purchasedItems[shopIcon.id]) {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'btn btn-outline-secondary icon-select';
                    btn.dataset.icon = shopIcon.emoji;
                    btn.innerHTML = `${shopIcon.emoji} <small class="d-block" style="font-size: 0.6rem;">è³¼å…¥æ¸ˆã¿</small>`;
                    btn.style.position = 'relative';
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.icon-select').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        selectedIcon = shopIcon.emoji;
                    });
                    selectorContainer.appendChild(btn);
                }
            });
        };
        
        // Initialize profile functionality
        const initializeProfile = () => {
            const profileBtn = document.getElementById('profile-btn');
            const profileModal = new bootstrap.Modal(document.getElementById('profile-modal'));
            const editProfileBtn = document.getElementById('edit-profile-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const profileEditForm = document.getElementById('profile-edit-form');
            const profileView = document.getElementById('profile-view');
            const profileEdit = document.getElementById('profile-edit');
            
            // Profile button click
            profileBtn.addEventListener('click', () => {
                updateProfileDisplay();
                profileModal.show();
            });
            
            // Edit profile button
            editProfileBtn.addEventListener('click', () => {
                profileView.style.display = 'none';
                profileEdit.style.display = 'block';
                
                // Pre-fill edit form
                document.getElementById('edit-nickname').value = gamificationData.profile?.nickname || '';
                
                // Update icon selector with purchased icons
                updateIconSelector();
                
                // Set active icon
                document.querySelectorAll('.icon-select').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.icon === (gamificationData.profile?.icon || 'ğŸ‘¤'));
                });
            });
            
            // Cancel edit button
            cancelEditBtn.addEventListener('click', () => {
                profileView.style.display = 'block';
                profileEdit.style.display = 'none';
            });
            
            // Initialize selectedIcon with current profile icon
            selectedIcon = gamificationData.profile?.icon || 'ğŸ‘¤';
            
            // Save profile form
            profileEditForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const nickname = document.getElementById('edit-nickname').value.trim();
                
                if (!gamificationData.profile) {
                    gamificationData.profile = {
                        nickname: '',
                        icon: 'ğŸ‘¤',
                        firstUseDate: null,
                        lastUseDate: null,
                        usageDays: new Set(),
                        maxStreak: 0,
                        totalPointsEarned: 0
                    };
                }
                
                gamificationData.profile.nickname = nickname;
                gamificationData.profile.icon = selectedIcon;
                
                await saveGamificationData();
                
                profileView.style.display = 'block';
                profileEdit.style.display = 'none';
                
                updateProfileDisplay();
                
                // Update ranking data with new profile info
                await updateUserRankingData();
                
                showNotification('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
            });
        };
        
        // Initialize ranking functionality
        const initializeRanking = () => {
            const rankingBtn = document.getElementById('ranking-btn');
            const rankingModal = new bootstrap.Modal(document.getElementById('ranking-modal'));
            
            rankingBtn.addEventListener('click', async () => {
                rankingModal.show();
                await loadRankings();
            });
            
            // Update user's ranking data when cards change
            updateUserRankingData();
        };
        
        // Update user's ranking data in Firebase
        const updateUserRankingData = async () => {
            if (!currentUser) return;
            
            try {
                // Calculate stats
                const totalCards = cardCollection.reduce((sum, card) => sum + (card.data['æšæ•°'] || 0), 0);
                const uniqueCards = cardCollection.length;
                const currentStreak = gamificationData.registrationStreak?.count || 0;
                const totalPoints = gamificationData.profile?.totalPointsEarned || 0;
                
                // If user has no cards and no meaningful data, don't save to rankings
                if (totalCards === 0 && uniqueCards === 0 && currentStreak === 0 && totalPoints === 0) {
                    // Optionally delete existing ranking data if all values are 0
                    try {
                        const rankingRef = doc(db, 'rankings', currentUser.uid);
                        await deleteDoc(rankingRef);
                    } catch (error) {
                        // Ignore error if document doesn't exist
                    }
                    return;
                }
                
                // Prepare ranking data
                const rankingData = {
                    uid: currentUser.uid,
                    nickname: gamificationData.profile?.nickname || '',
                    icon: gamificationData.profile?.icon || 'ğŸ‘¤',
                    totalCards: totalCards,
                    uniqueCards: uniqueCards,
                    currentStreak: currentStreak,
                    totalPoints: totalPoints,
                    lastUpdated: new Date().toISOString()
                };
                
                // Save to rankings collection
                const rankingRef = doc(db, 'rankings', currentUser.uid);
                await setDoc(rankingRef, rankingData);
            } catch (error) {
                console.error('Error updating ranking data:', error);
            }
        };
        
        // Load and display rankings
        const loadRankings = async () => {
            try {
                const rankingsSnapshot = await getDocs(collection(db, 'rankings'));
                const rankings = [];
                
                rankingsSnapshot.forEach(doc => {
                    rankings.push(doc.data());
                });
                
                // Sort rankings for each category (filter out users with 0 for relevant categories)
                const totalCardsRanking = [...rankings]
                    .filter(user => user.totalCards > 0)
                    .sort((a, b) => b.totalCards - a.totalCards)
                    .slice(0, 50);
                const uniqueCardsRanking = [...rankings]
                    .filter(user => user.uniqueCards > 0)
                    .sort((a, b) => b.uniqueCards - a.uniqueCards)
                    .slice(0, 50);
                const streakRanking = [...rankings]
                    .filter(user => user.currentStreak > 0)
                    .sort((a, b) => b.currentStreak - a.currentStreak)
                    .slice(0, 50);
                const pointsRanking = [...rankings]
                    .filter(user => user.totalPoints > 0)
                    .sort((a, b) => b.totalPoints - a.totalPoints)
                    .slice(0, 50);
                
                // Display rankings
                displayRanking('total-cards-ranking-list', totalCardsRanking, 'totalCards', 'æš');
                displayRanking('unique-cards-ranking-list', uniqueCardsRanking, 'uniqueCards', 'ç¨®é¡');
                displayRanking('streak-ranking-list', streakRanking, 'currentStreak', 'æ—¥');
                displayRanking('points-ranking-list', pointsRanking, 'totalPoints', 'pt');
            } catch (error) {
                console.error('Error loading rankings:', error);
                document.querySelectorAll('[id$="-ranking-list"]').forEach(list => {
                    list.innerHTML = '<div class="alert alert-danger">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
                });
            }
        };
        
        // Display ranking list
        const displayRanking = (listId, rankings, valueKey, unit) => {
            const listElement = document.getElementById(listId);
            
            if (rankings.length === 0) {
                listElement.innerHTML = '<div class="alert alert-warning">ã¾ã ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            listElement.innerHTML = rankings.map((user, index) => {
                const rank = index + 1;
                const isCurrentUser = user.uid === currentUser?.uid;
                const displayName = user.nickname || 'åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼';
                const icon = user.icon || 'ğŸ‘¤';
                
                // Determine medal for top 3
                let medal = '';
                if (rank === 1) medal = 'ğŸ¥‡';
                else if (rank === 2) medal = 'ğŸ¥ˆ';
                else if (rank === 3) medal = 'ğŸ¥‰';
                
                return `
                    <div class="list-group-item ${isCurrentUser ? 'bg-light border-primary' : ''}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <span class="me-3 fw-bold ${rank <= 3 ? 'fs-4' : ''}" style="min-width: 40px;">
                                    ${medal || rank + '.'}
                                </span>
                                <span class="fs-4 me-2">${icon}</span>
                                <div>
                                    <div class="fw-semibold ${isCurrentUser ? 'text-primary' : ''}">
                                        ${displayName}
                                        ${isCurrentUser ? ' (ã‚ãªãŸ)' : ''}
                                    </div>
                                    <small class="text-muted">
                                        æœ€çµ‚æ›´æ–°: ${formatRelativeTime(user.lastUpdated)}
                                    </small>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="fs-5 fw-bold ${rank <= 3 ? 'text-warning' : ''}">
                                    ${user[valueKey].toLocaleString()} ${unit}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        };
        
        // Format relative time
        const formatRelativeTime = (dateString) => {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (minutes < 60) return `${minutes}åˆ†å‰`;
            if (hours < 24) return `${hours}æ™‚é–“å‰`;
            if (days < 7) return `${days}æ—¥å‰`;
            return date.toLocaleDateString('ja-JP');
        };
        
        // Update profile display
        const updateProfileDisplay = () => {
            const profile = gamificationData.profile || {};
            
            // Basic info
            document.getElementById('profile-icon').textContent = profile.icon || 'ğŸ‘¤';
            document.getElementById('profile-nickname').textContent = profile.nickname || 'æœªè¨­å®š';
            document.getElementById('profile-user-id').textContent = currentUser?.email || '';
            
            // Usage stats
            const totalDays = profile.usageDays ? (profile.usageDays instanceof Set ? profile.usageDays.size : profile.usageDays.length) : 0;
            document.getElementById('profile-total-days').textContent = `${totalDays}æ—¥`;
            
            // Format dates
            const formatDate = (dateStr) => {
                if (!dateStr) return '-';
                const date = new Date(dateStr);
                return `${date.getFullYear()}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
            };
            
            document.getElementById('profile-first-use').textContent = formatDate(profile.firstUseDate);
            document.getElementById('profile-last-use').textContent = formatDate(profile.lastUseDate);
            
            // Collection stats
            document.getElementById('profile-total-cards').textContent = `${cardCollection.reduce((sum, card) => sum + (card.data['æšæ•°'] || 0), 0)}æš`;
            
            // Streak info
            document.getElementById('profile-streak').textContent = `${gamificationData.registrationStreak?.count || 0}æ—¥`;
            document.getElementById('profile-max-streak').textContent = `${profile.maxStreak || 0}æ—¥`;
            
            // Points
            document.getElementById('profile-total-points').textContent = `${profile.totalPointsEarned || 0}pt`;
        };

        const handleUserLogout = () => {
            currentUser = null;
            mainApp.style.display = 'none';
            appLoader.style.display = 'none';
            authModal.show();
            cardCollection = [];
            wishlistCollection = [];
            renderTable([]);
            document.getElementById('delete-account-btn').style.display = 'block';
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                handleUserLogin(user);
            } else {
                handleUserLogout();
            }
        });

        const updateBulkEditControls = () => {
            const bulkEditControls = document.getElementById('bulk-edit-controls');
            const selectedCount = document.getElementById('selected-count');
            
            if (selectedCardIds.size > 0) {
                bulkEditControls.style.display = 'block';
                selectedCount.textContent = `${selectedCardIds.size}ä»¶é¸æŠ`;
            } else {
                bulkEditControls.style.display = 'none';
            }
        };
        
        const handleBulkTagOperation = (operation) => {
            if (selectedCardIds.size === 0) {
                alert('ã‚«ãƒ¼ãƒ‰ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }
            
            const modalTitle = document.getElementById('bulk-tag-modal-title');
            const modalDesc = document.getElementById('bulk-tag-modal-desc');
            const container = document.getElementById('bulk-tag-choices-container');
            
            modalTitle.textContent = operation === 'add' ? 'ã‚¿ã‚°ã‚’è¿½åŠ ' : 'ã‚¿ã‚°ã‚’å‰Šé™¤';
            modalDesc.textContent = `${selectedCardIds.size}æšã®ã‚«ãƒ¼ãƒ‰ã«å¯¾ã—ã¦${operation === 'add' ? 'è¿½åŠ ' : 'å‰Šé™¤'}ã™ã‚‹ã‚¿ã‚°ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`;
            
            container.innerHTML = '';
            const selectedTags = new Set();
            
            allTags.forEach(tag => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn btn-outline-secondary btn-sm me-1 mb-1';
                btn.textContent = tag.name;
                btn.onclick = () => {
                    if (selectedTags.has(tag.name)) {
                        selectedTags.delete(tag.name);
                        btn.classList.remove('btn-primary');
                        btn.classList.add('btn-outline-secondary');
                    } else {
                        selectedTags.add(tag.name);
                        btn.classList.remove('btn-outline-secondary');
                        btn.classList.add('btn-primary');
                    }
                };
                container.appendChild(btn);
            });
            
            document.getElementById('bulk-tag-save-btn').onclick = async () => {
                if (selectedTags.size === 0) {
                    alert('ã‚¿ã‚°ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                    return;
                }
                
                showLoading(true);
                try {
                    for (const cardId of selectedCardIds) {
                        const collection = getCurrentCollection();
                        const card = collection.find(c => c.id === cardId);
                        if (!card) continue;
                        
                        let updatedTags = [...(card.data.tags || [])];
                        
                        if (operation === 'add') {
                            selectedTags.forEach(tag => {
                                if (!updatedTags.includes(tag)) {
                                    updatedTags.push(tag);
                                }
                            });
                        } else {
                            updatedTags = updatedTags.filter(tag => !selectedTags.has(tag));
                        }
                        
                        const collRef = getCollectionRef(currentListType);
                        if (collRef) {
                            await updateDoc(doc(collRef, cardId), { tags: updatedTags });
                        }
                        card.data.tags = updatedTags;
                    }
                    
                    bulkTagModal.hide();
                    selectedCardIds.clear();
                    updateBulkEditControls();
                    renderTable();
                    alert(`${selectedCardIds.size}æšã®ã‚«ãƒ¼ãƒ‰ã®ã‚¿ã‚°ã‚’${operation === 'add' ? 'è¿½åŠ ' : 'å‰Šé™¤'}ã—ã¾ã—ãŸã€‚`);
                } catch (error) {
                    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                } finally {
                    showLoading(false);
                }
            };
            
            bulkTagModal.show();
        };
        
        document.getElementById('tag-management-btn').addEventListener('click', () => tagManagementModal.show());
        
        document.getElementById('select-all-checkbox').addEventListener('change', (e) => {
            const checkboxes = document.querySelectorAll('.card-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = e.target.checked;
                const cardId = checkbox.dataset.id;
                if (e.target.checked) {
                    selectedCardIds.add(cardId);
                } else {
                    selectedCardIds.delete(cardId);
                }
            });
            updateBulkEditControls();
        });
        
        document.addEventListener('change', (e) => {
            if (e.target.classList.contains('card-checkbox')) {
                const cardId = e.target.dataset.id;
                if (e.target.checked) {
                    selectedCardIds.add(cardId);
                } else {
                    selectedCardIds.delete(cardId);
                }
                updateBulkEditControls();
                
                const allCheckboxes = document.querySelectorAll('.card-checkbox');
                const checkedBoxes = document.querySelectorAll('.card-checkbox:checked');
                const selectAllCheckbox = document.getElementById('select-all-checkbox');
                selectAllCheckbox.checked = allCheckboxes.length > 0 && allCheckboxes.length === checkedBoxes.length;
            }
        });
        
        document.getElementById('bulk-add-tags-btn').addEventListener('click', () => handleBulkTagOperation('add'));
        document.getElementById('bulk-remove-tags-btn').addEventListener('click', () => handleBulkTagOperation('remove'));
        
        document.getElementById('bulk-delete-btn').addEventListener('click', async () => {
            if (selectedCardIds.size === 0) {
                alert('ã‚«ãƒ¼ãƒ‰ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }
            
            const listName = currentListType === 'collection' ? 'æ‰€æŒã‚«ãƒ¼ãƒ‰' : 'ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆ';
            if (!confirm(`${selectedCardIds.size}æšã®ã‚«ãƒ¼ãƒ‰ã‚’${listName}ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
                return;
            }
            
            showLoading(true);
            try {
                const collRef = getCollectionRef(currentListType);
                const collection = getCurrentCollection();
                
                for (const cardId of selectedCardIds) {
                    if (collRef) {
                        await deleteDoc(doc(collRef, cardId));
                    }
                    const index = collection.findIndex(c => c.id === cardId);
                    if (index > -1) {
                        collection.splice(index, 1);
                    }
                }
                
                selectedCardIds.clear();
                updateBulkEditControls();
                updateTotalCounts(); // Update stats after bulk deletion
                applySearchAndFilter();
                alert(`${selectedCardIds.size}æšã®ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
            } catch (error) {
                alert('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            } finally {
                showLoading(false);
            }
        });
        
        document.getElementById('clear-selection-btn').addEventListener('click', () => {
            selectedCardIds.clear();
            document.querySelectorAll('.card-checkbox').forEach(checkbox => checkbox.checked = false);
            document.getElementById('select-all-checkbox').checked = false;
            updateBulkEditControls();
        });
        
        document.getElementById('collection-tab').addEventListener('click', (e) => {
            e.preventDefault();
            currentListType = 'collection';
            document.getElementById('collection-tab').classList.add('active');
            document.getElementById('wishlist-tab').classList.remove('active');
            applySearchAndFilter();
        });
        
        document.getElementById('wishlist-tab').addEventListener('click', (e) => {
            e.preventDefault();
            currentListType = 'wishlist';
            document.getElementById('wishlist-tab').classList.add('active');
            document.getElementById('collection-tab').classList.remove('active');
            applySearchAndFilter();
        });
        
        document.getElementById('login-btn').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (email === 'local') {
                currentUser = { uid: 'local_user', email: 'local@example.com' };
                handleUserLogin(currentUser);
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                authError.style.display = 'none';
            } catch (error) { authError.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ${error.message}`; authError.style.display = 'block'; }
        });

        document.getElementById('signup-btn').addEventListener('click', async () => {
            try {
                await createUserWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value);
                authError.style.display = 'none';
            } catch (error) { authError.textContent = `æ–°è¦ç™»éŒ²ã‚¨ãƒ©ãƒ¼: ${error.message}`; authError.style.display = 'block'; }
        });

        logoutBtn.addEventListener('click', () => {
            if (currentUser && currentUser.uid === 'local_user') {
                window.location.reload();
            } else {
                signOut(auth);
            }
        });

        addForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading(true);
            
            try {
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Operation timeout')), 30000); // 30 seconds timeout
                });
                
                const formData = new FormData(addForm);
                const addType = document.querySelector('input[name="add-type"]:checked').value;
                const newCard = {
                    'åå‰': formData.get('name'),
                    'å‹ç•ª': formData.get('set_code'),
                    'ãƒ¬ã‚¢ãƒªãƒ†ã‚£': formData.get('rarity'),
                    'æšæ•°': parseInt(formData.get('quantity'), 10),
                    'tags': [...currentCardTags] // ã‚¿ã‚°ã‚’è¿½åŠ 
                };
            
            const setChoices = [];
            document.querySelectorAll('#set-rarity-choices .set-choice-btn').forEach(btn => {
                setChoices.push({
                    setCode: btn.dataset.setCode,
                    rarity: btn.dataset.rarity,
                    text: btn.textContent
                });
            });
            
            lastRegistrationData = {
                name: newCard['åå‰'],
                setCode: newCard['å‹ç•ª'],
                rarity: newCard['ãƒ¬ã‚¢ãƒªãƒ†ã‚£'],
                quantity: newCard['æšæ•°'],
                tags: [...currentCardTags],
                addType: addType,
                setChoices: setChoices
            };
            updateRegistrationHistoryButton();

                const targetCollection = addType === 'collection' ? cardCollection : wishlistCollection;
                const collRef = getCollectionRef(addType);
                
                const dbOperation = async () => {
                    if (collRef) { // Firebaseãƒ¢ãƒ¼ãƒ‰
                        const constraints = [where("åå‰", "==", newCard.åå‰)];
                        if (newCard.å‹ç•ª) {
                            constraints.push(where("å‹ç•ª", "==", newCard.å‹ç•ª));
                        }
                        if (newCard.ãƒ¬ã‚¢ãƒªãƒ†ã‚£) {
                            constraints.push(where("ãƒ¬ã‚¢ãƒªãƒ†ã‚£", "==", newCard.ãƒ¬ã‚¢ãƒªãƒ†ã‚£));
                        }
                        const q = query(collRef, ...constraints);
                        const existingDocs = await getDocs(q);

                        if (existingDocs.empty) {
                            const docRef = await addDoc(collRef, newCard);
                            targetCollection.push({ id: docRef.id, data: newCard });
                            // Track card addition date
                            if (currentListType === 'collection') {
                                gamificationData.cardAdditionDates[docRef.id] = new Date().toISOString();
                                saveGamificationData();
                            }
                        } else {
                            const existingDoc = existingDocs.docs[0];
                            await updateDoc(existingDoc.ref, { æšæ•°: increment(newCard.æšæ•°) });
                            const localCard = targetCollection.find(c => c.id === existingDoc.id);
                            if(localCard) localCard.data.æšæ•° += newCard.æšæ•°;
                        }
                    } else { // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰
                        const existingCard = targetCollection.find(c => {
                            if (c.data.åå‰ !== newCard.åå‰) return false;
                            if (newCard.å‹ç•ª && c.data.å‹ç•ª !== newCard.å‹ç•ª) return false;
                            if (newCard.ãƒ¬ã‚¢ãƒªãƒ†ã‚£ && c.data.ãƒ¬ã‚¢ãƒªãƒ†ã‚£ !== newCard.ãƒ¬ã‚¢ãƒªãƒ†ã‚£) return false;
                            return true;
                        });
                        if (existingCard) {
                            existingCard.data.æšæ•° += newCard.æšæ•°;
                        } else {
                            const localId = `local_${Date.now()}`;
                            targetCollection.push({ id: localId, data: newCard });
                            // Track card addition date for local mode
                            if (currentListType === 'collection') {
                                gamificationData.cardAdditionDates[localId] = new Date().toISOString();
                                saveGamificationData();
                            }
                        }
                    }
                };
                
                // Execute with timeout
                await Promise.race([dbOperation(), timeoutPromise]);
            
                // Track card addition for fun dashboard
                const hasTag = currentCardTags.length > 0;
                const isRare = newCard['ãƒ¬ã‚¢ãƒªãƒ†ã‚£'] && (
                    newCard['ãƒ¬ã‚¢ãƒªãƒ†ã‚£'].toLowerCase().includes('ãƒ¬ã‚¢') ||
                    newCard['ãƒ¬ã‚¢ãƒªãƒ†ã‚£'].toLowerCase().includes('rare') ||
                    newCard['ãƒ¬ã‚¢ãƒªãƒ†ã‚£'].toUpperCase().includes('SR') ||
                    newCard['ãƒ¬ã‚¢ãƒªãƒ†ã‚£'].toUpperCase().includes('UR')
                );
                trackCardAddition(newCard, hasTag, isRare);
                
                // Add points for card addition (5 points per card)
                const cardQuantity = newCard.æšæ•° || 1;
                const pointsToAdd = cardQuantity * 5;
                if (isRare) {
                    addPoints(pointsToAdd + (cardQuantity * 5), `ãƒ¬ã‚¢ã‚«ãƒ¼ãƒ‰ ${cardQuantity}æšè¿½åŠ `); // Bonus for rare
                } else {
                    addPoints(pointsToAdd, `ã‚«ãƒ¼ãƒ‰ ${cardQuantity}æšè¿½åŠ `);
                }
            
                updateTotalCounts(); // Update stats after adding card
                applySearchAndFilter();
                addForm.reset();
                currentCardTags = [];
                renderTagChoices('tag-choices-container', currentCardTags);
                renderSelectedTags('card-tags-container', currentCardTags);
                document.getElementById('set-rarity-choices').innerHTML = '';
                showLoading(false);
                
            } catch (error) {
                showLoading(false);
                
                // Check error type
                if (error.message === 'Operation timeout') {
                    alert('æ“ä½œãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                } else if (error.code === 'permission-denied' || error.code === 'unauthenticated') {
                    alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                    // Force re-authentication
                    if (currentUser && currentUser.uid !== 'local_user') {
                        signOut(auth);
                    } else {
                        window.location.reload();
                    }
                } else {
                    alert(`ã‚«ãƒ¼ãƒ‰ã®è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message || 'Unknown error'}`);
                }
            }
        });

        cardTableBody.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            if (target.classList.contains('delete-btn')) {
                const cardId = target.dataset.id;
                const cardName = target.closest('tr').querySelector('td').textContent;
                const listName = currentListType === 'collection' ? 'æ‰€æŒã‚«ãƒ¼ãƒ‰' : 'ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆ';
                if (confirm(`ã€Œ${cardName}ã€ã‚’${listName}ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                    const collRef = getCollectionRef(currentListType);
                    if (collRef) { // Firebaseãƒ¢ãƒ¼ãƒ‰
                        deleteDoc(doc(collRef, cardId));
                    }
                    if (currentListType === 'collection') {
                        cardCollection = cardCollection.filter(c => c.id !== cardId);
                    } else {
                        wishlistCollection = wishlistCollection.filter(c => c.id !== cardId);
                    }
                    updateTotalCounts(); // Update stats after deletion
                    applySearchAndFilter();
                }
            } else if (target.classList.contains('edit-btn')) {
                const cardId = target.dataset.id;
                const currentData = getCurrentCollection();
                const card = currentData.find(c => c.id === cardId);
                if (card) {
                    document.getElementById('edit-card-id').value = card.id;
                    document.getElementById('edit-name').value = card.data.åå‰;
                    document.getElementById('edit-set-code').value = card.data.å‹ç•ª;
                    document.getElementById('edit-rarity').value = card.data.ãƒ¬ã‚¢ãƒªãƒ†ã‚£;
                    document.getElementById('edit-quantity').value = card.data.æšæ•°;
                    
                    currentCardTags = [...(card.data.tags || [])]; // æ—¢å­˜ã‚¿ã‚°ã‚’ã‚»ãƒƒãƒˆ
                    renderTagChoices('edit-tag-choices-container', currentCardTags);
                    renderSelectedTags('edit-card-tags-container', currentCardTags);

                    editCardModal.show();
                }
            } else if (target.classList.contains('move-to-collection-btn')) {
                const cardId = target.dataset.id;
                const card = wishlistCollection.find(c => c.id === cardId);
                if (card && confirm(`ã€Œ${card.data.åå‰}ã€ã‚’æ‰€æŒã‚«ãƒ¼ãƒ‰ã«ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ`)) {
                    // Move from wishlist to collection
                    const wishlistRef = getCollectionRef('wishlist');
                    const collectionRef = getCollectionRef('collection');
                    
                    if (collectionRef && wishlistRef) {
                        // Add to collection
                        const docRef = await addDoc(collectionRef, card.data);
                        cardCollection.push({ id: docRef.id, data: card.data });
                        // Track card addition date
                        gamificationData.cardAdditionDates[docRef.id] = new Date().toISOString();
                        saveGamificationData();
                        
                        // Remove from wishlist
                        await deleteDoc(doc(wishlistRef, cardId));
                        wishlistCollection = wishlistCollection.filter(c => c.id !== cardId);
                    } else {
                        // Local mode
                        const newId = `local_${Date.now()}`;
                        cardCollection.push({ id: newId, data: card.data });
                        wishlistCollection = wishlistCollection.filter(c => c.id !== cardId);
                        // Track card addition date
                        gamificationData.cardAdditionDates[newId] = new Date().toISOString();
                        saveGamificationData();
                    }
                    
                    // Add points for moving card from wishlist to collection
                    const cardQuantity = card.data.æšæ•° || 1;
                    const pointsToAdd = cardQuantity * 5;
                    addPoints(pointsToAdd, `ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆã‹ã‚‰ ${cardQuantity}æšè¿½åŠ `);
                    
                    // Track for daily missions
                    const isRare = card.data.ãƒ¬ã‚¢ãƒªãƒ†ã‚£ && (
                        card.data.ãƒ¬ã‚¢ãƒªãƒ†ã‚£.toLowerCase().includes('ãƒ¬ã‚¢') ||
                        card.data.ãƒ¬ã‚¢ãƒªãƒ†ã‚£.toLowerCase().includes('rare') ||
                        card.data.ãƒ¬ã‚¢ãƒªãƒ†ã‚£.toUpperCase().includes('SR') ||
                        card.data.ãƒ¬ã‚¢ãƒªãƒ†ã‚£.toUpperCase().includes('UR')
                    );
                    trackCardAddition(card.data, false, isRare);
                    
                    updateTotalCounts(); // Update stats after moving card
                    applySearchAndFilter();
                }
            }
        });

        document.getElementById('save-edit-btn').addEventListener('click', async () => {
            const cardId = document.getElementById('edit-card-id').value;
            const updatedData = {
                æšæ•°: parseInt(document.getElementById('edit-quantity').value, 10),
                tags: [...currentCardTags]
            };

            const collRef = getCollectionRef(currentListType);
            if (collRef) { // Firebaseãƒ¢ãƒ¼ãƒ‰
                await updateDoc(doc(collRef, cardId), updatedData);
            }

            const targetCollection = currentListType === 'collection' ? cardCollection : wishlistCollection;
            const localCard = targetCollection.find(c => c.id === cardId);
            if(localCard) {
                localCard.data.æšæ•° = updatedData.æšæ•°;
                localCard.data.tags = updatedData.tags;
            }
            updateTotalCounts(); // Update stats after editing
            applySearchAndFilter();
            editCardModal.hide();
        });

        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            applySearchAndFilter();
        });

        document.getElementById('items-per-page').addEventListener('change', (e) => {
            itemsPerPage = parseInt(e.target.value, 10);
            currentPage = 1; // è¡¨ç¤ºä»¶æ•°å¤‰æ›´æ™‚ã¯1ãƒšãƒ¼ã‚¸ç›®ã«æˆ»ã‚‹
            renderTable();
        });

        document.querySelectorAll('th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const key = th.dataset.sort;
                if (sortConfig.key === key) {
                    sortConfig.direction = sortConfig.direction === 'ascending' ? 'descending' : 'ascending';
                } else {
                    sortConfig.key = key;
                    sortConfig.direction = 'ascending';
                }
                renderTable();
            });
        });

        // --- Data Import / Export ---
        const exportAllData = () => {
            return {
                collection: cardCollection.map(c => c.data),
                wishlist: wishlistCollection.map(c => c.data)
            };
        };
        
        const parseCsv = (text) => {
            const lines = text.trim().replace(/\r/g, '').split('\n');
            const header = lines[0].split(',').map(h => h.trim());
            const cards = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                const values = lines[i].split(',');
                const card = {};
                header.forEach((col, index) => {
                    const value = values[index]?.trim() || '';
                    if (col === 'æšæ•°') {
                        card[col] = parseInt(value, 10) || 1;
                    } else {
                        card[col] = value.replace(/^"|"$/g, '');
                    }
                });
                cards.push(card);
            }
            return cards;
        };

        const handleImport = async (text, format) => {
            let importedData;
            try {
                if (format === 'json') {
                    const parsed = JSON.parse(text);
                    // Check if it's the new format with collection and wishlist
                    if (parsed.collection && parsed.wishlist) {
                        importedData = parsed;
                    } else if (Array.isArray(parsed)) {
                        // Old format - treat as collection only
                        importedData = { collection: parsed, wishlist: [] };
                    } else {
                        throw new Error('Invalid JSON format');
                    }
                } else if (format === 'csv') {
                    const cards = parseCsv(text);
                    // Check if CSV has list type column
                    const hasListType = cards.length > 0 && cards[0].ãƒªã‚¹ãƒˆç¨®åˆ¥;
                    if (hasListType) {
                        importedData = {
                            collection: cards.filter(c => c.ãƒªã‚¹ãƒˆç¨®åˆ¥ === 'æ‰€æŒã‚«ãƒ¼ãƒ‰'),
                            wishlist: cards.filter(c => c.ãƒªã‚¹ãƒˆç¨®åˆ¥ === 'ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆ')
                        };
                        // Remove the list type column from the data
                        [...importedData.collection, ...importedData.wishlist].forEach(c => delete c.ãƒªã‚¹ãƒˆç¨®åˆ¥);
                    } else {
                        // Old format - treat as collection only
                        importedData = { collection: cards, wishlist: [] };
                    }
                }

                const totalCards = importedData.collection.length + importedData.wishlist.length;
                if (!confirm(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆå†…å®¹:\næ‰€æŒã‚«ãƒ¼ãƒ‰: ${importedData.collection.length}æš\nã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆ: ${importedData.wishlist.length}æš\nåˆè¨ˆ: ${totalCards}æš\n\nã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ\n(é‡è¤‡ã™ã‚‹ã‚«ãƒ¼ãƒ‰ã¯æšæ•°ãŒåŠ ç®—ã•ã‚Œã¾ã™)`)) return;
                
                showLoading(true);

                // Import collection
                if (importedData.collection.length > 0) {
                    const collRef = getCollectionRef('collection');
                    if (collRef) { // Firebaseãƒ¢ãƒ¼ãƒ‰
                        const batch = writeBatch(db);
                        for (const card of importedData.collection) {
                            // Parse tags if they're in semicolon format
                            if (card.ã‚¿ã‚° && typeof card.ã‚¿ã‚° === 'string') {
                                card.tags = card.ã‚¿ã‚°.split(';').filter(t => t.trim());
                                delete card.ã‚¿ã‚°;
                            }
                            const q = query(collRef, where("åå‰", "==", card.åå‰), where("å‹ç•ª", "==", card.å‹ç•ª), where("ãƒ¬ã‚¢ãƒªãƒ†ã‚£", "==", card.ãƒ¬ã‚¢ãƒªãƒ†ã‚£));
                            const existingDocs = await getDocs(q);
                            if (existingDocs.empty) {
                                batch.set(doc(collRef), card);
                            } else {
                                batch.update(existingDocs.docs[0].ref, { æšæ•°: increment(card.æšæ•° || 1) });
                            }
                        }
                        await batch.commit();
                    } else { // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰
                        for (const card of importedData.collection) {
                            if (card.ã‚¿ã‚° && typeof card.ã‚¿ã‚° === 'string') {
                                card.tags = card.ã‚¿ã‚°.split(';').filter(t => t.trim());
                                delete card.ã‚¿ã‚°;
                            }
                            const existingCard = cardCollection.find(c => 
                                c.data.åå‰ === card.åå‰ && 
                                c.data.å‹ç•ª === card.å‹ç•ª && 
                                c.data.ãƒ¬ã‚¢ãƒªãƒ†ã‚£ === card.ãƒ¬ã‚¢ãƒªãƒ†ã‚£
                            );
                            if (existingCard) {
                                existingCard.data.æšæ•° += (card.æšæ•° || 1);
                            } else {
                                cardCollection.push({ id: `local_${Date.now()}_${Math.random()}`, data: card });
                            }
                        }
                    }
                }

                // Import wishlist
                if (importedData.wishlist.length > 0) {
                    const wishRef = getCollectionRef('wishlist');
                    if (wishRef) { // Firebaseãƒ¢ãƒ¼ãƒ‰
                        const batch = writeBatch(db);
                        for (const card of importedData.wishlist) {
                            if (card.ã‚¿ã‚° && typeof card.ã‚¿ã‚° === 'string') {
                                card.tags = card.ã‚¿ã‚°.split(';').filter(t => t.trim());
                                delete card.ã‚¿ã‚°;
                            }
                            const q = query(wishRef, where("åå‰", "==", card.åå‰), where("å‹ç•ª", "==", card.å‹ç•ª), where("ãƒ¬ã‚¢ãƒªãƒ†ã‚£", "==", card.ãƒ¬ã‚¢ãƒªãƒ†ã‚£));
                            const existingDocs = await getDocs(q);
                            if (existingDocs.empty) {
                                batch.set(doc(wishRef), card);
                            } else {
                                batch.update(existingDocs.docs[0].ref, { æšæ•°: increment(card.æšæ•° || 1) });
                            }
                        }
                        await batch.commit();
                    } else { // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰
                        for (const card of importedData.wishlist) {
                            if (card.ã‚¿ã‚° && typeof card.ã‚¿ã‚° === 'string') {
                                card.tags = card.ã‚¿ã‚°.split(';').filter(t => t.trim());
                                delete card.ã‚¿ã‚°;
                            }
                            const existingCard = wishlistCollection.find(c => 
                                c.data.åå‰ === card.åå‰ && 
                                c.data.å‹ç•ª === card.å‹ç•ª && 
                                c.data.ãƒ¬ã‚¢ãƒªãƒ†ã‚£ === card.ãƒ¬ã‚¢ãƒªãƒ†ã‚£
                            );
                            if (existingCard) {
                                existingCard.data.æšæ•° += (card.æšæ•° || 1);
                            } else {
                                wishlistCollection.push({ id: `local_${Date.now()}_${Math.random()}`, data: card });
                            }
                        }
                    }
                }

                // Reload if using Firebase, otherwise just refresh display
                if (getCollectionRef()) {
                    await loadCollectionFromFirestore();
                } else {
                    applySearchAndFilter();
                }

                showLoading(false);
                alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
            } catch (err) { 
                showLoading(false); 
                alert(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${err.message}`); 
                console.error(err); 
            }
        };

        document.getElementById('import-json-btn').addEventListener('click', () => importFileInput.click());
        document.getElementById('import-csv-btn').addEventListener('click', () => importFileInput.click());
        importFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            const format = file.name.endsWith('.csv') ? 'csv' : 'json';
            reader.onload = (event) => handleImport(event.target.result, format);
            reader.readAsText(file);
            e.target.value = '';
        });

        document.getElementById('export-json-btn').addEventListener('click', () => {
            const exportData = exportAllData();
            const dataStr = JSON.stringify(exportData, null, 4);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'yugioh_collection.json'; a.click(); URL.revokeObjectURL(url);
        });

        document.getElementById('export-csv-btn').addEventListener('click', () => {
            const header = ['ãƒªã‚¹ãƒˆç¨®åˆ¥', 'åå‰', 'å‹ç•ª', 'ãƒ¬ã‚¢ãƒªãƒ†ã‚£', 'æšæ•°', 'ã‚¿ã‚°'];
            const collectionRows = cardCollection.map(c => {
                const row = ['æ‰€æŒã‚«ãƒ¼ãƒ‰', c.data['åå‰'], c.data['å‹ç•ª'], c.data['ãƒ¬ã‚¢ãƒªãƒ†ã‚£'], c.data['æšæ•°'], (c.data.tags || []).join(';')];
                return row.map(value => {
                    const strValue = String(value || '');
                    return strValue.includes(',') ? `"${strValue}"` : strValue;
                }).join(',');
            });
            const wishlistRows = wishlistCollection.map(c => {
                const row = ['ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆ', c.data['åå‰'], c.data['å‹ç•ª'], c.data['ãƒ¬ã‚¢ãƒªãƒ†ã‚£'], c.data['æšæ•°'], (c.data.tags || []).join(';')];
                return row.map(value => {
                    const strValue = String(value || '');
                    return strValue.includes(',') ? `"${strValue}"` : strValue;
                }).join(',');
            });
            const csvContent = [header.join(','), ...collectionRows, ...wishlistRows].join('\r\n');
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'yugioh_collection.csv'; a.click(); URL.revokeObjectURL(url);
        });

        // --- Settings ---
        document.getElementById('how-to-use-btn').addEventListener('click', () => howToUseModal.show());
        document.getElementById('settings-btn').addEventListener('click', () => settingsModal.show());

        darkModeToggle.addEventListener('change', (e) => {
            const theme = e.target.checked ? 'dark' : 'light';
            document.documentElement.setAttribute('data-bs-theme', theme);
            localStorage.setItem('theme', theme);
            applyTheme(); // è¨­å®šå¤‰æ›´æ™‚ã«å³æ™‚åæ˜ 
        });
        
        hideEmailToggle.addEventListener('change', (e) => {
            const hideEmail = e.target.checked;
            localStorage.setItem('hideEmail', hideEmail);
            if (currentUser) {
                userEmailSpan.textContent = hideEmail ? '' : currentUser.email;
            }
        });
        
        // Hide stats toggle
        const hideStatsToggle = document.getElementById('hide-stats-toggle');
        hideStatsToggle.addEventListener('change', (e) => {
            const hideStats = e.target.checked;
            localStorage.setItem('hideStats', hideStats);
            updateCollectionStats(); // Update immediately
        });
        
        // Initialize settings
        hideEmailToggle.checked = localStorage.getItem('hideEmail') === 'true';
        hideStatsToggle.checked = localStorage.getItem('hideStats') === 'true';
        
        // Stats info button
        document.getElementById('stats-info-btn').addEventListener('click', () => {
            const statsInfoModal = new bootstrap.Modal(document.getElementById('stats-info-modal'));
            statsInfoModal.show();
        });
        
        // Achievement toggle
        document.getElementById('achievement-toggle').addEventListener('click', () => {
            const section = document.getElementById('achievement-section');
            const icon = document.getElementById('achievement-toggle-icon');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                icon.className = 'bi bi-chevron-up';
            } else {
                section.style.display = 'none';
                icon.className = 'bi bi-chevron-down';
            }
        });
        
        // Initialize history settings
        showSearchHistoryToggle.checked = localStorage.getItem('showSearchHistory') === 'true';
        showRegistrationHistoryToggle.checked = localStorage.getItem('showRegistrationHistory') === 'true';
        
        showSearchHistoryToggle.addEventListener('change', (e) => {
            localStorage.setItem('showSearchHistory', e.target.checked);
            updateSearchHistoryButton();
        });
        
        showRegistrationHistoryToggle.addEventListener('change', (e) => {
            localStorage.setItem('showRegistrationHistory', e.target.checked);
            updateRegistrationHistoryButton();
        });
        
        // Previous search button
        document.getElementById('prev-search-btn').addEventListener('click', () => {
            if (lastSearchKeyword) {
                document.getElementById('card-search').value = lastSearchKeyword;
                document.getElementById('search-db-btn').click();
            }
        });
        
        // Previous registration button
        document.getElementById('prev-registration-btn').addEventListener('click', () => {
            if (lastRegistrationData) {
                document.getElementById('name').value = lastRegistrationData.name;
                document.getElementById('set_code').value = lastRegistrationData.setCode;
                document.getElementById('rarity').value = lastRegistrationData.rarity;
                document.getElementById('quantity').value = lastRegistrationData.quantity;
                
                // Restore tags
                currentCardTags = [...lastRegistrationData.tags];
                renderTagChoices('tag-choices-container', currentCardTags);
                renderSelectedTags('card-tags-container', currentCardTags);
                
                // Restore add type
                if (lastRegistrationData.addType === 'collection') {
                    document.getElementById('add-to-collection').checked = true;
                } else {
                    document.getElementById('add-to-wishlist').checked = true;
                }
                
                // Restore set-rarity choices
                const choicesEl = document.getElementById('set-rarity-choices');
                choicesEl.innerHTML = '';
                if (lastRegistrationData.setChoices && lastRegistrationData.setChoices.length > 0) {
                    lastRegistrationData.setChoices.forEach(choice => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'btn btn-outline-primary btn-sm me-1 mb-1 set-choice-btn';
                        btn.dataset.setCode = choice.setCode;
                        btn.dataset.rarity = choice.rarity;
                        btn.textContent = choice.text;
                        choicesEl.appendChild(btn);
                    });
                }
            }
        });
        
        // Initialize history buttons on page load
        setTimeout(() => {
            updateSearchHistoryButton();
            updateRegistrationHistoryButton();
        }, 100);

        const applyTheme = () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-bs-theme', savedTheme);
            darkModeToggle.checked = savedTheme === 'dark';

            const nav = document.querySelector('.navbar');
            if (nav) {
                if (savedTheme === 'dark') {
                    nav.classList.remove('navbar-light', 'bg-light');
                    nav.classList.add('navbar-dark', 'bg-dark');
                } else {
                    nav.classList.remove('navbar-dark', 'bg-dark');
                    nav.classList.add('navbar-light', 'bg-light');
                }
            }
        };
        applyTheme(); // Apply theme on initial load

        document.getElementById('delete-account-btn').addEventListener('click', async () => {
            if (!currentUser) return;
            if (!confirm('æœ¬å½“ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) return;
            if (!confirm('æœ€çµ‚ç¢ºèªã§ã™ã€‚ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ç´ã¥ãå…¨ã¦ã®ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã€ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ãŒæ°¸ä¹…ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
            
            showLoading(true);
            try {
                // 1. Delete all card data from Firestore
                const userCardCollectionRef = getCollectionRef();
                const snapshot = await getDocs(query(userCardCollectionRef));
                const batch = writeBatch(db);
                snapshot.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();

                // 2. Delete ranking data
                try {
                    const rankingRef = doc(db, 'rankings', currentUser.uid);
                    await deleteDoc(rankingRef);
                } catch (rankingError) {
                    console.error('Error deleting ranking data:', rankingError);
                }

                // 3. Delete gamification data (including profile)
                try {
                    const gamificationRef = doc(db, 'userGamification', currentUser.uid);
                    await deleteDoc(gamificationRef);
                } catch (gamificationError) {
                    console.error('Error deleting gamification data:', gamificationError);
                }

                // 4. Delete wishlist data if exists
                try {
                    const wishlistRef = collection(db, 'users', currentUser.uid, 'wishlist');
                    const wishlistSnapshot = await getDocs(wishlistRef);
                    const wishlistBatch = writeBatch(db);
                    wishlistSnapshot.docs.forEach(doc => wishlistBatch.delete(doc.ref));
                    await wishlistBatch.commit();
                } catch (wishlistError) {
                    console.error('Error deleting wishlist data:', wishlistError);
                }

                // 5. Delete tags data if exists
                try {
                    const tagsRef = collection(db, 'users', currentUser.uid, 'tags');
                    const tagsSnapshot = await getDocs(tagsRef);
                    const tagsBatch = writeBatch(db);
                    tagsSnapshot.docs.forEach(doc => tagsBatch.delete(doc.ref));
                    await tagsBatch.commit();
                } catch (tagsError) {
                    console.error('Error deleting tags data:', tagsError);
                }

                // 6. Delete the user account
                await deleteUser(currentUser);
                await signOut(auth);
                alert('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨å…¨ã¦ã®é–¢é€£ãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚');
                settingsModal.hide();
            } catch (error) {
                showLoading(false);
                if (error.code === 'auth/requires-recent-login') {
                    alert('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ã®å‰ã«ã€å†ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚ä¸€åº¦ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ã‹ã‚‰ã€å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ãŸä¸Šã§ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                } else {
                    alert(`ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
                }
            }
        });

        // --- Search from Official DB ---
        let searchResultsData = { cards: [], currentPage: 1, itemsPerPage: 10 };
        let lastSearchKeyword = '';
        let lastRegistrationData = null;
        
        const renderSearchResults = (containerId = 'search-results') => {
            const container = document.getElementById(containerId);
            const startIndex = (searchResultsData.currentPage - 1) * searchResultsData.itemsPerPage;
            const endIndex = startIndex + searchResultsData.itemsPerPage;
            const paginatedCards = searchResultsData.cards.slice(startIndex, endIndex);
            const totalPages = Math.ceil(searchResultsData.cards.length / searchResultsData.itemsPerPage);
            
            container.innerHTML = '';
            
            if (searchResultsData.cards.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">æ¤œç´¢çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>';
                return;
            }
            
            const header = document.createElement('div');
            header.className = containerId === 'search-results' ? 
                'alert alert-info mb-2 d-flex justify-content-between align-items-center flex-wrap gap-2' :
                'd-flex justify-content-between align-items-center mb-2';
            header.innerHTML = `
                <span>${containerId === 'search-results' ? 'æ¤œç´¢çµæœï¼š' : ''}${searchResultsData.cards.length}ä»¶ (${searchResultsData.currentPage}/${totalPages}ãƒšãƒ¼ã‚¸)</span>
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-primary" ${searchResultsData.currentPage <= 1 ? 'disabled' : ''} onclick="changeSearchPage(${searchResultsData.currentPage - 1})">å‰ã¸</button>
                    <button class="btn btn-outline-primary" ${searchResultsData.currentPage >= totalPages ? 'disabled' : ''} onclick="changeSearchPage(${searchResultsData.currentPage + 1})">æ¬¡ã¸</button>
                </div>
            `;
            container.appendChild(header);
            
            const listGroup = document.createElement('div');
            listGroup.className = 'list-group';
            
            paginatedCards.forEach(card => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'list-group-item list-group-item-action';
                button.textContent = card.name;
                button.dataset.cardUrl = card.url;
                button.onclick = () => fetchCardDetails(button.dataset.cardUrl);
                listGroup.appendChild(button);
            });
            
            container.appendChild(listGroup);
            
            if (totalPages > 1 && containerId === 'search-results') {
                const bottomControls = document.createElement('div');
                bottomControls.className = 'mt-2 d-flex justify-content-center';
                bottomControls.innerHTML = `
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-primary" ${searchResultsData.currentPage <= 1 ? 'disabled' : ''} onclick="changeSearchPage(${searchResultsData.currentPage - 1})">å‰ã¸</button>
                        <button class="btn btn-outline-primary" ${searchResultsData.currentPage >= totalPages ? 'disabled' : ''} onclick="changeSearchPage(${searchResultsData.currentPage + 1})">æ¬¡ã¸</button>
                    </div>
                `;
                container.appendChild(bottomControls);
            }
        };
        
        window.changeSearchPage = (page) => {
            searchResultsData.currentPage = page;
            renderSearchResults();
        };
        
        // Add Enter key support for card search
        document.getElementById('card-search').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('search-db-btn').click();
            }
        });
        
        document.getElementById('search-db-btn').addEventListener('click', async () => {
            const searchKeyword = document.getElementById('card-search').value.trim();
            if (!searchKeyword) {
                alert('æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            // Save search keyword
            lastSearchKeyword = searchKeyword;
            updateSearchHistoryButton();
            
            // Track search action for missions
            trackSearchAction();
            
            // First check if we have matching cards in our collection
            const normalizedSearchKeyword = normalizeForSearch(searchKeyword);
            const matchingCards = cardCollection.filter(card => 
                card.data['åå‰'] && normalizeForSearch(card.data['åå‰']).includes(normalizedSearchKeyword)
            );
            
            if (matchingCards.length > 0) {
                // Show local cards first
                const resultsDiv = document.getElementById('search-results');
                resultsDiv.innerHTML = '';
                
                const localHeader = document.createElement('div');
                localHeader.className = 'alert alert-success mb-2';
                localHeader.innerHTML = `<strong>æ‰€æŒã‚«ãƒ¼ãƒ‰ã‹ã‚‰è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ (${matchingCards.length}ä»¶)</strong>`;
                resultsDiv.appendChild(localHeader);
                
                const localListGroup = document.createElement('div');
                localListGroup.className = 'list-group mb-3';
                
                matchingCards.forEach(card => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                    button.innerHTML = `
                        <div>
                            <strong>${escapeHtml(card.data['åå‰'])}</strong>
                            ${card.data['å‹ç•ª'] ? `<small class="text-muted ms-2">${escapeHtml(card.data['å‹ç•ª'])}</small>` : ''}
                            ${card.data['ãƒ¬ã‚¢ãƒªãƒ†ã‚£'] ? `<span class="badge bg-secondary ms-2">${escapeHtml(card.data['ãƒ¬ã‚¢ãƒªãƒ†ã‚£'])}</span>` : ''}
                        </div>
                        <span class="badge bg-primary">${card.data['æšæ•°']}æš</span>
                    `;
                    button.onclick = () => {
                        // Fill form with existing card data
                        document.getElementById('name').value = card.data['åå‰'];
                        document.getElementById('set_code').value = card.data['å‹ç•ª'] || '';
                        document.getElementById('rarity').value = card.data['ãƒ¬ã‚¢ãƒªãƒ†ã‚£'] || '';
                        document.getElementById('quantity').value = 1;
                        // Clear search results
                        resultsDiv.innerHTML = '';
                    };
                    localListGroup.appendChild(button);
                });
                
                resultsDiv.appendChild(localListGroup);
                
                // Add separator
                const separator = document.createElement('div');
                separator.className = 'alert alert-info mb-2';
                separator.innerHTML = 'å…¬å¼DBã‹ã‚‰ã‚‚æ¤œç´¢ã—ã¦ã„ã¾ã™...';
                resultsDiv.appendChild(separator);
            }
            
            showLoading(true);
            const searchUrl = `https://www.db.yugioh-card.com/yugiohdb/card_search.action?ope=1&sess=1&rp=100&mode=&sort=1&keyword=${encodeURIComponent(searchKeyword)}&stype=1&ctype=&othercon=2&starfr=&starto=&pscaleto=&linkmarkerfr=&linkmarkerto=&link_m=2&atkfr=&atkto=&deffr=&defto=&releaseDStart=1&releaseMStart=1&releaseYStart=1999&releaseDEnd=&releaseMEnd=&releaseYEnd=`;
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(searchUrl)}`;
            
            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const text = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                
                // Extract card names and URLs
                const cardNames = Array.from(doc.querySelectorAll('span.card_name')).map(span => span.textContent.trim());
                const cardLinks = Array.from(doc.querySelectorAll('input.link_value')).map(input => input.value);
                
                // Store search results
                searchResultsData.cards = [];
                cardNames.forEach((name, index) => {
                    if (cardLinks[index]) {
                        searchResultsData.cards.push({
                            name: name,
                            url: 'https://www.db.yugioh-card.com' + cardLinks[index]
                        });
                    }
                });
                searchResultsData.currentPage = 1;
                
                // Render paginated results - append to existing local results if any
                if (matchingCards.length > 0) {
                    // Remove the "searching" message
                    const resultsDiv = document.getElementById('search-results');
                    const lastChild = resultsDiv.lastElementChild;
                    if (lastChild && lastChild.classList.contains('alert-info') && lastChild.innerHTML.includes('æ¤œç´¢ã—ã¦ã„ã¾ã™')) {
                        resultsDiv.removeChild(lastChild);
                    }
                    
                    // Add official DB results header
                    const dbHeader = document.createElement('div');
                    dbHeader.className = 'alert alert-info mb-2';
                    dbHeader.innerHTML = `<strong>å…¬å¼DBã®æ¤œç´¢çµæœ</strong>`;
                    resultsDiv.appendChild(dbHeader);
                    
                    // Create a container for paginated results
                    const dbResultsContainer = document.createElement('div');
                    dbResultsContainer.id = 'db-search-results';
                    resultsDiv.appendChild(dbResultsContainer);
                    
                    renderSearchResultsToContainer('db-search-results');
                } else {
                    renderSearchResults();
                }
            } catch (err) {
                alert(`æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ${err.message}`);
            } finally {
                showLoading(false);
            }
        });
        
        const renderSearchResultsToContainer = (containerId) => renderSearchResults(containerId);
        
        const fetchCardDetails = async (cardUrl) => {
            const url = cardUrl + (cardUrl.includes('request_locale=ja') ? '' : (cardUrl.includes('?') ? '&request_locale=ja' : '?request_locale=ja'));
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
            showLoading(true);
            
            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const text = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                
                const cardName = doc.querySelector('#card_image_1')?.alt || '';
                if (!cardName) throw new Error("ã‚«ãƒ¼ãƒ‰åãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
                
                document.getElementById('name').value = cardName;
                const setCodes = Array.from(doc.querySelectorAll('div.card_number')).map(div => div.textContent.trim());
                const rarities = Array.from(doc.querySelectorAll('div.rarity p')).map(p => p.textContent.trim());
                
                const choicesEl = document.getElementById('set-rarity-choices');
                choicesEl.innerHTML = '';
                
                if (setCodes.length > 0) {
                    // Create unique set-rarity combinations
                    const uniqueSetRarities = new Map();
                    setCodes.forEach((code, i) => {
                        const rarity = rarities[i] || '';
                        const key = `${code}_${rarity}`;
                        if (!uniqueSetRarities.has(key)) {
                            uniqueSetRarities.set(key, { set_code: code, rarity: rarity });
                        }
                    });
                    
                    // Create buttons for unique combinations
                    Array.from(uniqueSetRarities.values()).forEach(data => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'btn btn-outline-primary btn-sm me-1 mb-1 set-choice-btn';
                        btn.dataset.setCode = data.set_code;
                        btn.dataset.rarity = data.rarity;
                        btn.textContent = `${data.set_code} (${data.rarity})`;
                        choicesEl.appendChild(btn);
                    });
                } else {
                    choicesEl.textContent = 'åéŒ²æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚';
                }
                
                // Clear search results
                document.getElementById('search-results').innerHTML = '';
                document.getElementById('card-search').value = '';
            } catch (err) {
                alert(`ã‚¨ãƒ©ãƒ¼: ${err.message}`);
            } finally {
                showLoading(false);
            }
        };
        
        // --- Fetch from URL ---
        document.getElementById('fetch-btn').addEventListener('click', async () => {
            let url = document.getElementById('url').value;
            if (!url) { alert('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
            if (!url.includes('request_locale=ja')) { url += url.includes('?') ? '&request_locale=ja' : '?request_locale=ja'; }
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
            showLoading(true);
            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const text = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const cardName = doc.querySelector('#card_image_1')?.alt || '';
                if (!cardName) throw new Error("ã‚«ãƒ¼ãƒ‰åãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
                document.getElementById('name').value = cardName;
                const setCodes = Array.from(doc.querySelectorAll('div.card_number')).map(div => div.textContent.trim());
                const rarities = Array.from(doc.querySelectorAll('div.rarity p')).map(p => p.textContent.trim());
                const choicesEl = document.getElementById('set-rarity-choices');
                choicesEl.innerHTML = '';
                if (setCodes.length > 0) {
                    // Create unique set-rarity combinations
                    const uniqueSetRarities = new Map();
                    setCodes.forEach((code, i) => {
                        const rarity = rarities[i] || '';
                        const key = `${code}_${rarity}`;
                        if (!uniqueSetRarities.has(key)) {
                            uniqueSetRarities.set(key, { set_code: code, rarity: rarity });
                        }
                    });
                    
                    // Create buttons for unique combinations
                    Array.from(uniqueSetRarities.values()).forEach(data => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'btn btn-outline-primary btn-sm me-1 mb-1 set-choice-btn';
                        btn.dataset.setCode = data.set_code; btn.dataset.rarity = data.rarity;
                        btn.textContent = `${data.set_code} (${data.rarity})`;
                        choicesEl.appendChild(btn);
                    });
                } else { choicesEl.textContent = 'åéŒ²æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'; }
                document.getElementById('url').value = '';
            } catch (err) { alert(`ã‚¨ãƒ©ãƒ¼: ${err.message}`); } finally { showLoading(false); }
        });
        document.getElementById('set-rarity-choices').addEventListener('click', (e) => {
            if (e.target.classList.contains('set-choice-btn')) {
                document.getElementById('set_code').value = e.target.dataset.setCode;
                document.getElementById('rarity').value = e.target.dataset.rarity;
            }
        });
    </script>
</body>
</html>

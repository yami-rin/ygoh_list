<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>カード管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="mobile-responsive.css">
    <script src="image_cache_manager.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        [data-bs-theme="dark"] body { background-color: #212529; }
        .container-fluid { max-width: 1400px; }
        .card { margin-bottom: 1.5rem; }
        .table-responsive { max-height: 500px; }
        #loading-overlay, #app-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1060;
            color: white;
        }
        .set-choice-btn { cursor: pointer; }
        #main-app { display: none; } /* Hide app until logged in */
        
        /* Tag display optimization */
        .tag-cell {
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
        }
        .tag-cell:hover {
            white-space: normal;
            word-wrap: break-word;
        }
        .tag-cell:hover .edit-tags-btn {
            display: inline-block !important;
        }

        /* Fix for mobile tag/rarity suggestions - Remove problematic CSS */
        
        /* Draggable tags styles */
        .draggable-tag {
            cursor: move;
            transition: background-color 0.2s;
        }
        .draggable-tag:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }
        .draggable-tag.dragging {
            opacity: 0.5;
        }
        .drag-over {
            border-top: 2px solid #007bff;
        }
        
        /* Achievement badge styles */
        .achievement-summary {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .achievement-summary:hover {
            background: rgba(0, 123, 255, 0.1);
            transform: translateX(5px);
        }
        .achievement-progress {
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }
        .achievement-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #dee2e6;
            transition: all 0.3s;
        }
        .achievement-dot.unlocked {
            background: #28a745;
            box-shadow: 0 0 4px rgba(40, 167, 69, 0.5);
        }
        .achievement-details {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
        }
        .achievement-details.show {
            display: block;
            animation: slideDown 0.3s;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .achievement-badge {
            position: relative;
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 500;
            margin: 0.25rem;
            cursor: help;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .achievement-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .achievement-badge.locked {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: #adb5bd;
            opacity: 0.6;
        }
        .achievement-badge.bronze {
            background: linear-gradient(135deg, #cd7f32 0%, #a0522d 100%);
            color: white;
        }
        .achievement-badge.silver {
            background: linear-gradient(135deg, #c0c0c0 0%, #808080 100%);
            color: white;
        }
        .achievement-badge.gold {
            background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%);
            color: #333;
            animation: shine 3s infinite;
        }
        .achievement-badge.platinum {
            background: linear-gradient(135deg, #e5e4e2 0%, #bbb 100%);
            color: #333;
            animation: shine 2s infinite;
        }
        .achievement-badge.diamond {
            background: linear-gradient(135deg, #b9f2ff 0%, #00d4ff 100%);
            color: white;
            animation: sparkle 2s infinite;
        }
        .achievement-badge.mythic {
            background: linear-gradient(135deg, #ff00ff 0%, #00ffff 50%, #ffff00 100%);
            color: white;
            animation: rainbow 3s infinite;
        }
        @keyframes rainbow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
        @keyframes sparkle {
            0%, 100% { box-shadow: 0 0 10px rgba(185, 242, 255, 0.8); }
            50% { box-shadow: 0 0 20px rgba(0, 212, 255, 1); }
        }
        @keyframes shine {
            0% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
            100% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
        }
        
        /* Rarity bar styles */
        .rarity-bar {
            height: 100px;
            flex: 0 0 auto;
            min-width: 40px;
            background: linear-gradient(to top, var(--bar-color) 0%, var(--bar-color) var(--bar-height), transparent var(--bar-height));
            position: relative;
            border-radius: 4px 4px 0 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding: 4px;
        }
        .rarity-bar-label {
            font-size: 0.7rem;
            margin-top: 4px;
            text-align: center;
        }
        .rarity-bar-count {
            font-weight: bold;
            font-size: 0.9rem;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        /* Rarity bars container */
        #rarity-bars {
            display: flex;
            gap: 0.25rem;
            align-items: flex-end;
            justify-content: flex-start;
            min-height: 120px;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 5px;
            width: 100%;
            max-width: 100%;
        }
        
        /* Rarity chart container */
        #rarity-chart-container {
            width: 100%;
            overflow: hidden;
            position: relative;
        }
        
        /* Custom scrollbar for rarity bars */
        #rarity-bars::-webkit-scrollbar {
            height: 6px;
        }
        
        #rarity-bars::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }
        
        #rarity-bars::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
        }
        
        #rarity-bars::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.5);
        }
        
        /* Performance optimizations for mobile */
        @media (max-width: 768px) {
            /* Optimize animations for mobile */
            * {
                -webkit-animation-duration: 0.2s !important;
                animation-duration: 0.2s !important;
                -webkit-transform: translateZ(0);
                transform: translateZ(0);
            }

            /* Reduce shadow complexity on mobile */
            .card, .modal-content, .btn {
                box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important;
            }

            /* Simplify table for performance */
            .table-responsive {
                -webkit-overflow-scrolling: touch;
            }

            .table td {
                padding: 0.25rem !important;
                font-size: 0.875rem;
            }

            /* Hide non-essential columns on mobile */
            .tag-cell {
                display: none !important;
            }
        }

        /* Mobile responsive for rarity bars */
        @media (max-width: 768px) {
            #rarity-bars {
                gap: 0.15rem;
                -webkit-overflow-scrolling: touch;
                justify-content: flex-start;
                flex-wrap: nowrap;
            }
            
            .rarity-bar {
                min-width: 35px;
                height: 80px;
                padding: 2px;
            }
            
            .rarity-bar-label {
                font-size: 0.6rem;
                margin-top: 2px;
            }
            
            .rarity-bar-count {
                font-size: 0.75rem;
            }
        }
        
        @media (max-width: 576px) {
            #rarity-chart-container {
                margin-top: 0.5rem !important;
                padding: 0 5px;
                max-width: 100%;
            }
            
            #rarity-bars {
                gap: 0.1rem;
                min-height: 100px;
                padding: 0 2px 5px 2px;
                max-width: calc(100vw - 40px);
                margin: 0 auto;
            }
            
            .rarity-bar {
                min-width: 30px;
                height: 70px;
                padding: 1px;
                border-radius: 3px 3px 0 0;
            }
            
            .rarity-bar-label {
                font-size: 0.55rem;
                margin-top: 1px;
                line-height: 1;
            }
            
            .rarity-bar-count {
                font-size: 0.65rem;
                line-height: 1;
            }
        }
        
        @media (max-width: 400px) {
            #rarity-chart-container {
                padding: 0 3px;
            }
            
            #rarity-bars {
                gap: 2px;
                min-height: 90px;
                max-width: calc(100vw - 30px);
            }
            
            .rarity-bar {
                min-width: 25px;
                height: 60px;
            }
            
            .rarity-bar-label {
                font-size: 0.5rem;
                word-break: break-all;
            }
            
            .rarity-bar-count {
                font-size: 0.6rem;
            }
        }
        
        /* Milestone notification styles */
        .milestone-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1070;
            animation: slideIn 0.5s, slideOut 0.5s 4.5s;
            animation-fill-mode: forwards;
        }
        @keyframes slideIn {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }
        @keyframes slideOut {
            from { transform: translateX(0); }
            to { transform: translateX(400px); }
        }
        
        /* Fun dashboard styles */
        .mission-item {
            transition: all 0.3s;
            cursor: pointer;
        }
        .mission-item:hover {
            background: rgba(0, 123, 255, 0.1);
        }
        .mission-item.completed {
            background: rgba(40, 167, 69, 0.1);
            text-decoration: line-through;
        }
        .mission-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* Icon Styles */
        body.icon-crown .collector-rank::after {
            content: '👑';
            margin-left: 5px;
        }
        body.icon-star .collector-rank::after {
            content: '⭐';
            margin-left: 5px;
        }
        body.icon-dragon .collector-rank::after {
            content: '🐉';
            margin-left: 5px;
        }
        body.icon-phoenix .collector-rank::after {
            content: '🔥🦅';
            margin-left: 5px;
        }
        body.icon-sword .collector-rank::after {
            content: '⚔️';
            margin-left: 5px;
        }
        
        /* Shop modal styles */
        .shop-item {
            border: 2px solid transparent;
            transition: all 0.3s;
            cursor: pointer;
        }
        .shop-item:hover {
            border-color: #ffc107;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .shop-item.purchased {
            background: #e8f5e9;
            border-color: #4caf50;
        }
        .shop-item.active {
            border-color: #007bff;
            background: #e3f2fd;
        }
        .shop-item.locked {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .shop-item.locked:hover {
            transform: none;
            border-color: transparent;
        }
        
        /* Point animation */
        @keyframes pointGain {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-30px) scale(1.5); opacity: 0; }
        }
        .point-animation {
            position: fixed;
            color: #ffc107;
            font-weight: bold;
            font-size: 1.5rem;
            z-index: 9999;
            pointer-events: none;
            animation: pointGain 1s ease-out;
        }
        
        /* Table header responsive styles */
        .table th {
            white-space: nowrap;
            min-width: fit-content;
        }

        /* Card name column - truncate with ellipsis */
        .table tbody td:nth-child(2) {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Ensure navbar buttons have consistent height */
        .navbar-nav .btn,
        .navbar-nav .dropdown > .btn {
            height: 38px;
            display: inline-flex;
            align-items: center;
        }
        
        /* Pagination controls responsive */
        #pagination-controls,
        #pagination-controls-bottom {
            font-size: 0.9rem;
        }

        /* Tap quantity input styles */
        .tap-quantity-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .tap-quantity-display {
            font-size: 1.5rem;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
            padding: 0.5rem;
            border: 2px solid #dee2e6;
            border-radius: 0.375rem;
            background: white;
        }
        [data-bs-theme="dark"] .tap-quantity-display {
            background: var(--bs-dark);
            border-color: var(--bs-gray-700);
        }
        .tap-quantity-btn {
            width: 44px;
            height: 44px;
            font-size: 1.25rem;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Mobile responsive styles */
        @media (max-width: 768px) {
            .navbar-brand { font-size: 1rem; }
            .navbar-text { display: none !important; }
            .btn-group-mobile {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }
            .table { font-size: 0.875rem; }

            /* Fix modal positioning on mobile - Always in viewport */
            .modal-dialog {
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                margin: 0 !important;
                max-width: calc(100% - 2rem);
                max-height: calc(100vh - 2rem);
                width: calc(100% - 2rem);
            }
            .modal-dialog-centered {
                min-height: auto !important;
                align-items: center !important;
            }
            .modal-dialog-centered::before {
                display: none !important;
            }
            .modal-dialog-scrollable {
                height: auto !important;
                max-height: calc(100vh - 2rem);
            }
            .modal-content {
                max-height: calc(100vh - 2rem);
                overflow-y: auto;
            }
            .modal {
                overflow-y: auto !important;
            }
            /* Ensure modals are visible */
            .modal.show {
                padding-right: 0 !important;
            }
            .modal-backdrop {
                position: fixed;
            }
            body.modal-open {
                position: fixed;
                width: 100%;
                overflow-y: scroll;
            }
            .table th {
                padding: 0.5rem 0.25rem;
                font-size: 0.8rem;
            }
            .table th i {
                font-size: 0.7rem;
            }
            .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
            .modal-dialog { margin: 0.5rem; }
            .nav-tabs .nav-link { padding: 0.5rem 0.75rem; font-size: 0.875rem; }
            .dropdown-menu { font-size: 0.875rem; }
        }
        
        @media (max-width: 576px) {
            .container-fluid { padding: 0.5rem; }
            .card-body { padding: 1rem; }
            .table-responsive { 
                max-height: 400px;
                overflow-x: auto;
            }
            .table th {
                padding: 0.4rem 0.2rem;
                font-size: 0.75rem;
            }
            .table td {
                padding: 0.4rem 0.2rem;
                font-size: 0.8rem;
            }
            
            /* Mobile card list improvements */
            /* Card name column - truncate with ellipsis */
            .table tbody td:nth-child(2) {
                max-width: 120px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                font-size: 0.75rem;
            }
            
            /* Set code column */
            .table tbody td:nth-child(3) {
                font-size: 0.7rem;
                max-width: 70px;
                word-break: break-all;
            }
            
            /* Show rarity on mobile */
            .table thead th:nth-child(4),
            .table tbody td:nth-child(4) {
                display: table-cell !important;
                font-size: 0.65rem;
                max-width: 50px;
            }
            
            /* Quantity column */
            .table tbody td:nth-child(5) {
                font-size: 0.8rem;
                font-weight: bold;
                text-align: center;
                min-width: 30px;
            }
            
            /* Hide tags column on mobile */
            .table thead th:nth-child(6),
            .table tbody td:nth-child(6) {
                display: none !important;
            }
            
            /* Action buttons column */
            .table tbody td:last-child {
                min-width: 60px;
            }
            
            /* Make action buttons smaller */
            .table .btn-sm {
                font-size: 0.6rem;
                padding: 0.2rem 0.25rem;
                margin: 0 1px;
            }
            
            .table .btn-sm i {
                font-size: 0.7rem;
            }
            
            .navbar-toggler { padding: 0.25rem 0.5rem; }
            
            /* Pagination controls on small screens */
            #pagination-controls span,
            #pagination-controls-bottom span {
                font-size: 0.8rem;
            }
            #pagination-controls .btn-group,
            #pagination-controls-bottom .btn-group {
                flex-wrap: nowrap;
            }
            .d-flex.justify-content-between.align-items-center.mb-2 {
                flex-direction: column;
                gap: 0.5rem;
            }
            .d-flex.justify-content-between.align-items-center.mb-2 > * {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* Profile modal styles */
        .icon-select {
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            padding: 0;
            transition: all 0.2s;
        }
        
        .icon-select.active {
            background-color: var(--bs-primary);
            color: white;
            border-color: var(--bs-primary);
            transform: scale(1.1);
        }
        
        #profile-icon {
            font-size: 4rem;
            animation: bounce 2s ease-in-out infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Card type selector styles */
        .card-type-selector {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 8px;
        }

        .main-type-tab {
            font-size: 0.85rem;
            font-weight: 500;
            border-radius: 20px !important;
            transition: all 0.3s ease;
        }

        .main-type-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .main-type-tab[data-category="monster"] {
            color: #6c757d;
        }

        .main-type-tab[data-category="monster"].active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
        }

        .main-type-tab[data-category="spell"] {
            color: #28a745;
        }

        .main-type-tab[data-category="spell"].active {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border-color: #28a745;
        }

        .main-type-tab[data-category="trap"] {
            color: #dc3545;
        }

        .main-type-tab[data-category="trap"].active {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            border-color: #fa709a;
        }

        .sub-type-container {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 6px;
            margin-top: 8px;
        }

        .sub-type-btn {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 15px;
            transition: all 0.2s ease;
        }

        .sub-type-btn:hover {
            transform: scale(1.05);
        }

        .sub-type-btn.active {
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .btn-outline-purple {
            color: #8b5cf6;
            border-color: #8b5cf6;
        }

        .btn-outline-purple:hover {
            color: #fff;
            background-color: #8b5cf6;
            border-color: #8b5cf6;
        }

        .btn-outline-purple.active {
            color: #fff;
            background-color: #8b5cf6;
            border-color: #8b5cf6;
        }

        /* Additional button styles for card types */
        .sub-type-btn.btn-outline-info.active {
            background-color: #17a2b8;
            border-color: #17a2b8;
            color: #fff;
        }

        .sub-type-btn.btn-outline-success.active {
            background-color: #28a745;
            border-color: #28a745;
            color: #fff;
        }

        .sub-type-btn.btn-outline-primary.active {
            background-color: #007bff;
            border-color: #007bff;
            color: #fff;
        }

        .sub-type-btn.btn-outline-dark.active {
            background-color: #343a40;
            border-color: #343a40;
            color: #fff;
        }

        .sub-type-btn.btn-outline-secondary.active {
            background-color: #6c757d;
            border-color: #6c757d;
            color: #fff;
        }

        .sub-type-btn.btn-outline-warning.active {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #212529;
        }

        .sub-type-btn.btn-outline-danger.active {
            background-color: #dc3545;
            border-color: #dc3545;
            color: #fff;
        }

        .sub-type-group {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Race selector styles */
        .race-selector {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 8px;
            margin-top: 5px;
        }

        .race-btn {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .race-btn:hover {
            transform: scale(1.05);
        }

        .race-btn.active {
            font-weight: bold;
            background-color: #007bff;
            border-color: #007bff;
            color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .clear-race-btn {
            margin-bottom: 5px;
        }

        /* Search mode (AND/OR) toggle styles */
        .btn-check:checked + .btn-outline-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
            color: #fff;
        }

        .btn-check:checked + .btn-outline-success {
            background-color: #198754;
            border-color: #198754;
            color: #fff;
        }

        /* Smooth transition for search mode buttons */
        .btn-group .btn-outline-primary,
        .btn-group .btn-outline-success {
            transition: all 0.2s ease-in-out;
        }

        /* Mobile responsive adjustments for search mode */
        @media (max-width: 768px) {
            #advanced-search .btn-group {
                width: 100%;
            }

            #advanced-search .btn-group .btn {
                flex: 1;
                font-size: 0.875rem;
            }

            #search-mode-description {
                display: block;
                margin-top: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Full screen loader -->
    <div id="app-loader">
        <div class="spinner-border" style="width: 3rem; height: 3rem;" role="status"><span class="visually-hidden">Loading...</span></div>
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="auth-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">ログインまたは新規登録</h5></div>
            <div class="modal-body">
                <div id="auth-error" class="alert alert-danger" style="display: none;"></div>
                <form id="auth-form">
                    <div class="mb-3"><label for="email" class="form-label">メールアドレス</label><input type="email" class="form-control" id="email" required></div>
                    <div class="mb-3"><label for="password" class="form-label">パスワード</label><input type="password" class="form-control" id="password" required></div>
                    <div class="alert alert-info small">
                        <i class="bi bi-info-circle"></i> <strong>新規登録について</strong><br>
                        ・メールアドレスの確認が必要です<br>
                        ・確認メールは<strong>迷惑メール</strong>に分類される場合があります<br>
                        ・送信元: <code>noreply@ygoh-9bcf6.firebaseapp.com</code>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="button" id="login-btn" class="btn btn-primary">ログイン</button>
                        <button type="button" id="signup-btn" class="btn btn-secondary">新規登録</button>
                    </div>
                </form>
            </div>
        </div></div>
    </div>

    <!-- Edit Card Modal -->
    <div class="modal fade" id="edit-card-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">カード情報の編集</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="edit-form">
                    <input type="hidden" id="edit-card-id">
                    <div class="mb-3"><label class="form-label">名前</label><input type="text" id="edit-name" class="form-control" readonly disabled></div>
                    <div class="mb-3"><label class="form-label">型番</label><input type="text" id="edit-set-code" class="form-control" readonly disabled></div>
                    <div class="mb-3"><label class="form-label">レアリティ</label><input type="text" id="edit-rarity" class="form-control" readonly disabled></div>
                    <div class="mb-3">
                        <label for="edit-quantity" class="form-label">枚数</label>
                        <div id="edit-quantity-input-container">
                            <input type="number" id="edit-quantity" class="form-control" min="1" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">タグ</label>
                        <div id="edit-card-tags-container" class="mb-2"></div>
                        <div id="edit-tag-choices-container"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" id="save-edit-btn" class="btn btn-primary">変更を保存</button>
            </div>
        </div></div>
    </div>

    <!-- Card Detail Modal -->
    <div class="modal fade" id="card-detail-modal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-info-circle"></i> カード詳細情報</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="card-detail-content">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                </div>
            </div>
        </div>
    </div>

    <!-- How to Use Modal -->
    <div class="modal fade" id="how-to-use-modal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">使い方ガイド</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> <strong>公式データベース</strong>：
                    <a href="https://www.db.yugioh-card.com/yugiohdb/card_search.action" target="_blank" class="alert-link">
                        遊戯王オフィシャルカードデータベースを開く <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                </div>

                <!-- クイックナビゲーション -->
                <div class="alert alert-light">
                    <h6 class="alert-heading"><i class="bi bi-compass"></i> クイックナビゲーション</h6>
                    <div class="d-flex flex-wrap gap-2">
                        <a href="#guide-start" class="btn btn-sm btn-outline-primary">初めての方へ</a>
                        <a href="#guide-register" class="btn btn-sm btn-outline-primary">カード登録</a>
                        <a href="#guide-lists" class="btn btn-sm btn-outline-primary">リスト管理</a>
                        <a href="#guide-tags" class="btn btn-sm btn-outline-primary">タグ機能</a>
                        <a href="#guide-gamification" class="btn btn-sm btn-outline-primary">ゲーミフィケーション</a>
                        <a href="#guide-data" class="btn btn-sm btn-outline-primary">データ管理</a>
                        <a href="#guide-advanced" class="btn btn-sm btn-outline-primary">便利機能</a>
                        <a href="#guide-mobile" class="btn btn-sm btn-outline-primary">モバイル</a>
                    </div>
                </div>

                <h5 class="mt-4 mb-3" id="guide-start"><i class="bi bi-1-circle-fill text-primary"></i> 初めての方へ</h5>
                <div class="ms-3">
                    <h6><i class="bi bi-person-plus"></i> アカウント作成</h6>
                    <ol>
                        <li>メールアドレスとパスワードを入力して「新規登録」をクリック</li>
                        <li>アカウントが作成され、自動でログインされます</li>
                        <li>データはクラウドに保存され、どの端末からでもアクセス可能です</li>
                    </ol>
                    <div class="alert alert-warning">
                        <small><i class="bi bi-exclamation-triangle"></i> <strong>ローカルモード</strong>：メールアドレスに「local」と入力すると、データをクラウドに保存せずブラウザ内でのみ管理できます</small>
                    </div>
                </div>

                <h5 class="mt-4 mb-3" id="guide-register"><i class="bi bi-2-circle-fill text-primary"></i> カードの登録方法</h5>
                <div class="ms-3">
                    <h6><i class="bi bi-search"></i> 方法1：公式DBから検索</h6>
                    <ol>
                        <li>「カード名で検索」欄にカード名を入力（例：「カメリア」）</li>
                        <li>「検索」ボタンをクリック（<i class="bi bi-clock-history"></i>ボタンで前回の検索も可能）</li>
                        <li>検索結果から目的のカードを選択</li>
                        <li>カード情報が自動で入力されます</li>
                        <li>枚数を設定（モバイルではタップ式入力も可能）</li>
                        <li>タグを選択（任意）</li>
                        <li>「カードを追加」をクリック</li>
                    </ol>

                    <h6><i class="bi bi-link-45deg"></i> 方法2：URLから読み込み</h6>
                    <ol>
                        <li>公式DBでカードを検索し、カード詳細ページを開く</li>
                        <li>URLをコピー（例：https://www.db.yugioh-card.com/yugiohdb/...)</li>
                        <li>「公式DB URL」欄に貼り付けて「読込」をクリック</li>
                        <li>複数の型番がある場合は、表示されるボタンから選択</li>
                    </ol>

                    <h6><i class="bi bi-pencil"></i> 方法3：手動入力</h6>
                    <p>カード名、型番、レアリティを直接入力して登録できます</p>

                    <div class="alert alert-success">
                        <small><i class="bi bi-lightbulb"></i> <strong>ヒント</strong>：「<i class="bi bi-arrow-counterclockwise"></i>」ボタンで前回の登録内容を復元できます</small>
                    </div>
                </div>

                <h5 class="mt-4 mb-3" id="guide-lists"><i class="bi bi-3-circle-fill text-primary"></i> リストの種類</h5>
                <div class="ms-3">
                    <h6><i class="bi bi-collection"></i> 所持カード</h6>
                    <ul>
                        <li>実際に所持しているカードを管理</li>
                        <li>枚数を記録し、コレクション全体を把握</li>
                        <li>統計情報（合計枚数、種類数、レアリティ分布）を表示</li>
                    </ul>

                    <h6><i class="bi bi-star"></i> ウィッシュリスト</h6>
                    <ul>
                        <li>今後入手したいカードを管理</li>
                        <li>入手したら「<i class="bi bi-check-circle"></i>」ボタンで所持カードへ移動</li>
                        <li>欲しいカードリストを作成して共有も可能</li>
                    </ul>

                    <h6><i class="bi bi-arrow-left-right"></i> リストの切り替え</h6>
                    <p>画面上部のタブで「所持カード」と「ウィッシュリスト」を簡単に切り替えられます</p>
                </div>

                <h5 class="mt-4 mb-3" id="guide-tags"><i class="bi bi-4-circle-fill text-primary"></i> タグ機能</h5>
                <div class="ms-3">
                    <h6><i class="bi bi-tags"></i> タグの作成・管理</h6>
                    <ul>
                        <li>「タグ」ボタンからタグ管理画面を開く</li>
                        <li>カンマ区切りで複数のタグを同時作成可能</li>
                        <li>ドラッグ&ドロップでタグの順番を変更可能</li>
                        <li>ペンアイコンでタグ名を編集可能</li>
                    </ul>

                    <h6><i class="bi bi-bookmark-plus"></i> タグの使い方</h6>
                    <ul>
                        <li>カード登録・編集時にタグを選択</li>
                        <li>カード一覧でタグをホバーするとペンアイコンが表示され、クリックで編集</li>
                        <li>複数カードを選択してタグを一括追加・削除</li>
                        <li>検索フォームでタグを指定して絞り込み</li>
                    </ul>

                    <div class="alert alert-info">
                        <small><i class="bi bi-info-circle"></i> 例：「デッキ用」「トレード用」「保管用」「高額カード」など</small>
                    </div>
                </div>

                <h5 class="mt-4 mb-3" id="guide-gamification"><i class="bi bi-5-circle-fill text-primary"></i> ゲーミフィケーション機能</h5>
                <div class="ms-3">
                    <h6><i class="bi bi-trophy"></i> ランキングシステム</h6>
                    <ul>
                        <li>所持カード数で他のユーザーと競争</li>
                        <li>リアルタイムランキング更新</li>
                        <li>TOP10ユーザーの表示</li>
                    </ul>

                    <h6><i class="bi bi-award"></i> 実績システム</h6>
                    <ul>
                        <li>様々な条件を達成してバッジを獲得</li>
                        <li>ブロンズからミシックまでのレア度</li>
                        <li>プロフィールで実績を公開</li>
                    </ul>

                    <h6><i class="bi bi-shop"></i> ポイントショップ</h6>
                    <ul>
                        <li>獲得したポイントでアイコンを購入</li>
                        <li>ガチャで限定アイコンを入手</li>
                    </ul>
                </div>

                <h5 class="mt-4 mb-3" id="guide-data"><i class="bi bi-6-circle-fill text-primary"></i> データ管理</h5>
                <div class="ms-3">
                    <h6><i class="bi bi-download"></i> エクスポート</h6>
                    <ul>
                        <li><strong>JSON形式</strong>：全データを完全にバックアップ（タグ情報も含む）</li>
                        <li><strong>CSV形式</strong>：Excelで編集・閲覧可能</li>
                        <li>「データ管理」ボタンから実行</li>
                    </ul>

                    <h6><i class="bi bi-upload"></i> インポート</h6>
                    <ul>
                        <li>JSON/CSVファイルからデータを一括登録</li>
                        <li>重複するカードは枚数が自動で加算</li>
                        <li>他のアプリからの移行も簡単</li>
                    </ul>

                    <h6><i class="bi bi-shield-check"></i> データの安全性</h6>
                    <ul>
                        <li>Firebaseによるセキュアなクラウド保存</li>
                        <li>定期的なバックアップを推奨</li>
                        <li>アカウント削除時は全データが削除されるので注意</li>
                    </ul>
                </div>

                <h5 class="mt-4 mb-3" id="guide-advanced"><i class="bi bi-7-circle-fill text-primary"></i> 便利な機能</h5>
                <div class="ms-3">
                    <h6><i class="bi bi-sort-down"></i> 並び替え・検索</h6>
                    <ul>
                        <li>カード一覧のヘッダーをクリックで並び替え</li>
                        <li>名前、型番、レアリティ、タグで検索</li>
                        <li>複数条件での絞り込みが可能</li>
                    </ul>

                    <h6><i class="bi bi-check2-square"></i> 一括編集</h6>
                    <ul>
                        <li>チェックボックスで複数カードを選択</li>
                        <li>「全て選択」ボタンで一括選択も可能</li>
                        <li>タグの一括追加・削除</li>
                        <li>複数カードの一括削除</li>
                    </ul>

                    <h6><i class="bi bi-clock-history"></i> 履歴機能</h6>
                    <ul>
                        <li>前回の検索キーワードを記憶</li>
                        <li>前回の登録内容を復元</li>
                        <li>設定で表示/非表示を切り替え</li>
                    </ul>

                    <h6><i class="bi bi-bar-chart"></i> 統計情報</h6>
                    <ul>
                        <li>コレクションの総枚数と種類数</li>
                        <li>レアリティ別の分布グラフ</li>
                        <li>今日の追加枚数</li>
                        <li>コレクション進捗率</li>
                    </ul>

                    <h6><i class="bi bi-moon-stars"></i> カスタマイズ</h6>
                    <ul>
                        <li>ダークモード対応</li>
                        <li>メールアドレスの表示/非表示</li>
                        <li>統計情報の表示/非表示</li>
                        <li>テーマやフレームのカスタマイズ（ポイントショップ）</li>
                    </ul>
                </div>

                <h5 class="mt-4 mb-3" id="guide-mobile"><i class="bi bi-8-circle-fill text-primary"></i> モバイル対応</h5>
                <div class="ms-3">
                    <h6><i class="bi bi-phone"></i> スマートフォン最適化</h6>
                    <ul>
                        <li>レスポンシブデザインでどの端末でも快適</li>
                        <li>タッチ操作に最適化されたボタンサイズ</li>
                        <li>スワイプでスクロール可能なテーブル</li>
                    </ul>

                    <h6><i class="bi bi-hand-index"></i> タップ式枚数入力</h6>
                    <ul>
                        <li>設定で「枚数入力をタップ式にする」をON</li>
                        <li>キーボードを使わずに枚数を設定</li>
                        <li>マイナス/プラスボタンで簡単調整</li>
                        <li>リセットボタンで1枚に戻る</li>
                    </ul>

                    <h6><i class="bi bi-tablet"></i> タブレット対応</h6>
                    <ul>
                        <li>iPadやAndroidタブレットに最適化</li>
                        <li>画面サイズに応じたレイアウト調整</li>
                        <li>横向きモードでも快適に利用可能</li>
                    </ul>

                    <div class="alert alert-success">
                        <small><i class="bi bi-check-circle"></i> <strong>PWA対応</strong>：ホーム画面に追加してアプリのように使用可能</small>
                    </div>
                </div>

                <div class="alert alert-primary mt-4">
                    <h6 class="alert-heading"><i class="bi bi-question-circle"></i> お困りの場合</h6>
                    <ul class="mb-0">
                        <li>ログインできない → パスワードを忘れた場合は再登録してください</li>
                        <li>データが消えた → 定期的にエクスポートでバックアップを取ることを推奨</li>
                        <li>カードが検索できない → 公式DBのURLを直接入力してください</li>
                        <li>エラーが発生する → ページを再読み込みしてください</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <a href="https://www.db.yugioh-card.com/yugiohdb/card_search.action" target="_blank" class="btn btn-primary">
                    <i class="bi bi-box-arrow-up-right"></i> 公式DBを開く
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
            </div>
        </div></div>
    </div>

    <!-- Ranking Modal -->
    <div class="modal fade" id="ranking-modal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-trophy"></i> ランキング</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Ranking Tabs -->
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#total-cards-ranking" type="button">
                                <i class="bi bi-stack"></i> 総カード枚数
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#unique-cards-ranking" type="button">
                                <i class="bi bi-collection"></i> 種類数
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#streak-ranking" type="button">
                                <i class="bi bi-fire"></i> ストリーク
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#points-ranking" type="button">
                                <i class="bi bi-coin"></i> 獲得ポイント
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Ranking Tab Content -->
                    <div class="tab-content">
                        <!-- Total Cards Ranking -->
                        <div class="tab-pane fade show active" id="total-cards-ranking" role="tabpanel">
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle"></i> 総カード枚数のランキング
                            </div>
                            <div class="list-group" id="total-cards-ranking-list">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">読み込み中...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Unique Cards Ranking -->
                        <div class="tab-pane fade" id="unique-cards-ranking" role="tabpanel">
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle"></i> カード種類数のランキング
                            </div>
                            <div class="list-group" id="unique-cards-ranking-list">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">読み込み中...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Streak Ranking -->
                        <div class="tab-pane fade" id="streak-ranking" role="tabpanel">
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle"></i> 連続登録日数のランキング
                            </div>
                            <div class="list-group" id="streak-ranking-list">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">読み込み中...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Points Ranking -->
                        <div class="tab-pane fade" id="points-ranking" role="tabpanel">
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle"></i> 累計獲得ポイントのランキング
                            </div>
                            <div class="list-group" id="points-ranking-list">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">読み込み中...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3 text-center">
                        <small class="text-muted">ランキングは1時間ごとに更新されます</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Profile Modal -->
    <div class="modal fade" id="profile-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="bi bi-person-circle"></i> プロフィール</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="profile-view" style="display: block;">
                        <div class="text-center mb-3">
                            <div class="display-1 mb-2" id="profile-icon">👤</div>
                            <h4>
                                <span id="profile-nickname">未設定</span>
                                <span id="profile-vip-badge" class="badge bg-warning text-dark ms-2" style="display: none; font-size: 0.6em; vertical-align: middle;">
                                    <i class="bi bi-star-fill"></i> VIP
                                </span>
                            </h4>
                            <p class="text-muted" id="profile-user-id"></p>
                        </div>
                        
                        <div class="list-group">
                            <div class="list-group-item d-flex justify-content-between">
                                <span><i class="bi bi-calendar-check"></i> 総利用日数</span>
                                <strong id="profile-total-days">0日</strong>
                            </div>
                            <div class="list-group-item d-flex justify-content-between">
                                <span><i class="bi bi-clock-history"></i> 初回利用日</span>
                                <strong id="profile-first-use">-</strong>
                            </div>
                            <div class="list-group-item d-flex justify-content-between">
                                <span><i class="bi bi-clock"></i> 最終利用日</span>
                                <strong id="profile-last-use">-</strong>
                            </div>
                            <div class="list-group-item d-flex justify-content-between">
                                <span><i class="bi bi-collection"></i> 総カード枚数</span>
                                <strong id="profile-total-cards">0枚</strong>
                            </div>
                            <div class="list-group-item d-flex justify-content-between">
                                <span><i class="bi bi-fire"></i> 現在のストリーク</span>
                                <strong id="profile-streak">0日</strong>
                            </div>
                            <div class="list-group-item d-flex justify-content-between">
                                <span><i class="bi bi-trophy"></i> 最長ストリーク</span>
                                <strong id="profile-max-streak">0日</strong>
                            </div>
                            <div class="list-group-item d-flex justify-content-between">
                                <span><i class="bi bi-coin"></i> 累計獲得ポイント</span>
                                <strong id="profile-total-points">0pt</strong>
                            </div>
                        </div>
                        
                        <div class="mt-3 text-center">
                            <button class="btn btn-primary" id="edit-profile-btn">
                                <i class="bi bi-pencil"></i> プロフィール編集
                            </button>
                        </div>
                    </div>
                    
                    <div id="profile-edit" style="display: none;">
                        <form id="profile-edit-form">
                            <div class="mb-3">
                                <label for="edit-nickname" class="form-label">ニックネーム</label>
                                <input type="text" class="form-control" id="edit-nickname" maxlength="20" required>
                                <small class="text-muted">最大20文字まで</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">アイコン選択</label>
                                <div class="d-flex flex-wrap gap-2" id="profile-icon-selector">
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="👤">👤</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="😊">😊</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="😎">😎</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="🎮">🎮</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="🎯">🎯</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="⭐">⭐</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="🏆">🏆</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="💎">💎</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="🔥">🔥</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="⚡">⚡</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="🌟">🌟</button>
                                    <button type="button" class="btn btn-outline-secondary icon-select" data-icon="🎨">🎨</button>
                                </div>
                            </div>
                            
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-success flex-grow-1">
                                    <i class="bi bi-check-circle"></i> 保存
                                </button>
                                <button type="button" class="btn btn-secondary" id="cancel-edit-btn">
                                    <i class="bi bi-x-circle"></i> キャンセル
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Point Shop Modal -->
    <div class="modal fade" id="point-shop-modal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="bi bi-shop"></i> ショップ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-coin"></i> 現在のポイント: <strong id="shop-current-points">0</strong> pt
                    </div>

                    <!-- Shop Tabs -->
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#icons-tab" type="button">
                                <i class="bi bi-award"></i> アイコン
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#gacha-tab" type="button">
                                <i class="bi bi-gift"></i> ガチャ
                            </button>
                        </li>
                    </ul>

                    <!-- Shop Tab Content -->
                    <div class="tab-content">
                        <!-- Icons Tab -->
                        <div class="tab-pane fade show active" id="icons-tab" role="tabpanel">
                            <div class="row g-3" id="icon-shop-items">
                                <!-- Icon items will be populated here -->
                            </div>
                        </div>

                        <!-- Gacha Tab -->
                        <div class="tab-pane fade" id="gacha-tab" role="tabpanel">
                            <div class="alert alert-warning">
                                <h5><i class="bi bi-gift"></i> ガチャで限定アイコンを手に入れよう！</h5>
                                <p>ショップで購入可能なアイコンや、<strong>ガチャ限定のレアアイコン</strong>が手に入るチャンス！</p>
                                <p class="mb-0"><small><i class="bi bi-info-circle"></i> 既に持っているアイコンが出た場合はポイントに変換されます</small></p>
                            </div>

                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h4>単発ガチャ</h4>
                                            <p class="text-muted">一回のガチャを引く</p>
                                            <div class="mb-3">
                                                <i class="bi bi-gift" style="font-size: 3rem; color: #ffa500;"></i>
                                            </div>
                                            <button class="btn btn-primary btn-lg" onclick="window.drawGacha(1)">
                                                <i class="bi bi-coin"></i> 100pt でガチャを引く
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h4>11連ガチャ</h4>
                                            <p class="text-muted">11回分ガチャを引く（1回分無料！）</p>
                                            <div class="mb-3">
                                                <i class="bi bi-gift-fill" style="font-size: 3rem; color: #ff6347;"></i>
                                            </div>
                                            <button class="btn btn-warning btn-lg" onclick="window.drawGacha(11)">
                                                <i class="bi bi-coin"></i> 1000pt で11回ガチャ
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion" id="gacha-info-accordion">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#gacha-rates">
                                            <i class="bi bi-info-circle me-2"></i> 排出率
                                        </button>
                                    </h2>
                                    <div id="gacha-rates" class="accordion-collapse collapse">
                                        <div class="accordion-body">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>レアリティ</th>
                                                        <th>排出率</th>
                                                        <th>説明</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td><span class="badge bg-secondary">Common</span></td>
                                                        <td>60%</td>
                                                        <td>50-200pt アイコン</td>
                                                    </tr>
                                                    <tr>
                                                        <td><span class="badge bg-primary">Uncommon</span></td>
                                                        <td>25%</td>
                                                        <td>250-500pt アイコン</td>
                                                    </tr>
                                                    <tr>
                                                        <td><span class="badge bg-success">Rare</span></td>
                                                        <td>10%</td>
                                                        <td>600-800pt アイコン</td>
                                                    </tr>
                                                    <tr>
                                                        <td><span class="badge bg-warning">Ultra Rare</span></td>
                                                        <td>4%</td>
                                                        <td>ガチャ限定アイコン</td>
                                                    </tr>
                                                    <tr>
                                                        <td><span class="badge bg-danger">Legendary</span></td>
                                                        <td>1%</td>
                                                        <td>ガチャ限定レジェンダリー</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#gacha-exclusive-icons">
                                            <i class="bi bi-star-fill me-2"></i> ガチャ限定アイコン
                                        </button>
                                    </h2>
                                    <div id="gacha-exclusive-icons" class="accordion-collapse collapse">
                                        <div class="accordion-body">
                                            <div id="exclusive-icons-display">
                                                <!-- Will be populated by JavaScript -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Gacha Result Modal -->
                            <div class="modal fade" id="gacha-result-modal" tabindex="-1" data-bs-backdrop="static">
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                        <div class="modal-body text-center text-white p-4">
                                            <div id="gacha-animation" style="min-height: 200px;">
                                                <!-- Animation will be shown here -->
                                            </div>
                                            <div id="gacha-results" class="mt-3" style="display: none;">
                                                <!-- Results will be shown here -->
                                            </div>
                                            <button type="button" class="btn btn-light mt-3" onclick="window.closeGachaResult()" style="display: none;" id="gacha-close-btn">
                                                閉じる
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Stats Info Modal -->
    <div class="modal fade" id="stats-info-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">コレクション統計の説明</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6><i class="bi bi-trophy"></i> コレクターランク</h6>
                    <ul>
                        <li><span class="badge bg-secondary">見習い</span> 0-9枚</li>
                        <li><span class="badge bg-secondary">初級</span> 10-49枚</li>
                        <li><span class="badge bg-primary">中級</span> 50-99枚</li>
                        <li><span class="badge bg-success">上級</span> 100-299枚</li>
                        <li><span class="badge bg-info">エキスパート</span> 300-499枚</li>
                        <li><span class="badge bg-warning">マスター</span> 500-999枚</li>
                        <li><span class="badge bg-danger">伝説</span> 1000-2499枚</li>
                        <li><span class="badge" style="background: linear-gradient(45deg, #51cf66, #12b886); color: white;">賢者</span> 2500-4999枚</li>
                        <li><span class="badge" style="background: linear-gradient(45deg, #ff6b6b, #ffd43b); color: white;">英雄</span> 5000-9999枚</li>
                        <li><span class="badge" style="background: linear-gradient(45deg, #845ef7, #5c7cfa); color: white;">覇王</span> 10000-24999枚</li>
                        <li><span class="badge" style="background: linear-gradient(45deg, #b9f2ff, #00d4ff); color: white;">天帝</span> 25000-49999枚</li>
                        <li><span class="badge" style="background: linear-gradient(45deg, #ffd700, #ff6b6b); color: white;">神話</span> 50000-99999枚</li>
                        <li><span class="badge" style="background: linear-gradient(45deg, #ff00ff, #00ffff, #ffff00); color: white;">創世神</span> 100000枚以上</li>
                    </ul>
                    
                    <h6><i class="bi bi-award"></i> 実績バッジ</h6>
                    <p>カードの収集状況に応じて様々な実績が解除されます：</p>
                    <ul>
                        <li><strong>枚数実績</strong>: 10枚～100,000枚まで13段階</li>
                        <li><strong>種類実績</strong>: 5種類～1,000種類まで8段階</li>
                        <li><strong>レアリティ実績</strong>: R、SR、UR、SE、プレミアム、UL、QCSE別</li>
                        <li><strong>継続実績</strong>: 3日～730日まで7段階</li>
                        <li><strong>特殊実績</strong>: 一日の追加枚数、週間追加、タグ管理など</li>
                    </ul>
                    <p class="text-muted small">カテゴリをクリックすると詳細な実績リストが表示されます。</p>
                    
                    <h6><i class="bi bi-bar-chart"></i> 統計項目</h6>
                    <ul>
                        <li><strong>総カード枚数</strong>: 所持している全カードの合計枚数</li>
                        <li><strong>種類数</strong>: ユニークなカードの種類数</li>
                        <li><strong>収集日数</strong>: 最初のカード登録からの経過日数</li>
                        <li><strong>今週追加</strong>: 過去7日間に追加したカード枚数</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Settings Modal -->
    <div class="modal fade" id="settings-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">設定</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <h6 class="mb-3"><i class="bi bi-display"></i> 表示設定</h6>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="dark-mode-toggle">
                    <label class="form-check-label" for="dark-mode-toggle">ダークモード</label>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="hide-email-toggle">
                    <label class="form-check-label" for="hide-email-toggle">メールアドレスを非表示</label>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="hide-stats-toggle">
                    <label class="form-check-label" for="hide-stats-toggle">コレクション統計を非表示</label>
                </div>
                <hr>
                <h6 class="mb-3"><i class="bi bi-clock-history"></i> 履歴・操作設定</h6>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="show-search-history-toggle">
                    <label class="form-check-label" for="show-search-history-toggle">前回の検索履歴ボタンを表示</label>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="show-registration-history-toggle">
                    <label class="form-check-label" for="show-registration-history-toggle">前回の登録履歴ボタンを表示</label>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="use-tap-quantity-toggle">
                    <label class="form-check-label" for="use-tap-quantity-toggle">枚数入力をタップ式にする</label>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="auto-save-toggle">
                    <label class="form-check-label" for="auto-save-toggle">データを自動保存する（5分ごと）</label>
                </div>

                <hr>
                <h6 class="mb-3"><i class="bi bi-speedometer2"></i> パフォーマンス設定</h6>
                <div class="mb-3">
                    <label for="table-rows-per-page" class="form-label">テーブルの表示行数</label>
                    <select class="form-select form-select-sm" id="table-rows-per-page">
                        <option value="50">50行</option>
                        <option value="100" selected>100行（デフォルト）</option>
                        <option value="200">200行</option>
                        <option value="500">500行</option>
                        <option value="all">全て表示</option>
                    </select>
                </div>

                <hr>
                <!-- Serial Number Section -->
                <div class="mb-4" id="serial-number-section" style="display: none;">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <h6 class="mb-0 small"><i class="bi bi-key-fill"></i> シリアル番号</h6>
                        <span id="vip-status-badge" class="badge bg-secondary small" style="display: none;">認証済</span>
                    </div>
                    <div id="vip-serial-input-section">
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control form-control-sm" id="vip-serial-input"
                                   placeholder="シリアル番号を入力" style="font-size: 0.8rem;" maxlength="20">
                            <button class="btn btn-outline-secondary btn-sm" type="button" id="vip-activate-btn">
                                <i class="bi bi-check-circle"></i> 認証
                            </button>
                        </div>
                        <p class="text-muted mt-1 mb-0" style="font-size: 0.7rem;" id="serial-attempts-text">
                            <i class="bi bi-info-circle"></i> 残り試行回数: 3回
                        </p>
                    </div>
                    <div id="vip-active-section" style="display: none;">
                        <p class="text-success mb-2" style="font-size: 0.85rem;">
                            <i class="bi bi-check-circle-fill"></i> 認証済み
                        </p>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-secondary btn-sm" type="button" id="vip-features-btn">
                                <i class="bi bi-star"></i> 特典を見る
                            </button>
                            <button class="btn btn-outline-danger btn-sm" type="button" id="vip-deactivate-btn">
                                <i class="bi bi-x-circle"></i> 解除
                            </button>
                        </div>
                    </div>
                </div>

                <hr>
                <h6>アカウント削除</h6>
                <p class="text-muted small">この操作は元に戻せません。アカウントに紐づく全てのカードデータが完全に削除されます。</p>
                <button class="btn btn-danger" id="delete-account-btn">アカウントを削除する</button>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button></div>
        </div></div>
    </div>

    <!-- Tag Management Modal -->
    <div class="modal fade" id="tag-management-modal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">タグ管理</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>新しいタグを追加</h6>
                    <form id="add-tag-form" class="input-group mb-3">
                        <input type="text" id="new-tag-name" class="form-control" placeholder="新しいタグ名（カンマ区切りで複数入力可）" required>
                        <button class="btn btn-primary" type="submit">追加</button>
                    </form>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <h6>登録済みタグ一覧</h6>
                            <small class="text-muted">※ドラッグ＆ドロップで順番を変更できます</small>
                        </div>
                        <button class="btn btn-warning btn-sm" id="cleanup-tags-btn">
                            <i class="bi bi-recycle"></i> 未使用タグをクリーンアップ
                        </button>
                    </div>
                    <div id="existing-tags-list" class="mt-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bulk Tag Edit Modal -->
    <!-- Bulk Import Modal -->
    <div class="modal fade" id="bulk-import-modal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-plus-square"></i> 一括登録</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="bulk-import-url" class="form-label">
                            <i class="bi bi-link-45deg"></i> 遊戯王DBの検索結果URL
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="bulk-import-url"
                                placeholder="https://www.db.yugioh-card.com/yugiohdb/card_search.action?ope=1&...">
                            <button class="btn btn-primary" type="button" id="fetch-cards-btn">
                                <i class="bi bi-download"></i> カード取得
                            </button>
                        </div>
                        <small class="text-body-secondary">
                            遊戯王公式DBで検索結果のURLを貼り付けてください。<br>
                            <span class="text-warning">⚠️ 初回アクセス時は、サーバー起動のため1分ほど時間がかかります。</span>
                        </small>
                    </div>

                    <div id="bulk-import-loading" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">読み込み中...</span>
                        </div>
                        <p class="mt-2 mb-1">カード情報を取得中...</p>
                        <small class="text-muted">
                            ※初回アクセス時は、サーバーの起動に1分ほどかかる場合があります
                        </small>
                    </div>

                    <div id="bulk-import-results" style="display: none;">
                        <div class="mb-3 d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <span id="bulk-import-count">0</span>件のカードが見つかりました
                            </h6>
                            <div class="d-flex align-items-center gap-2">
                                <label for="bulk-default-quantity" class="mb-0 small">初期枚数:</label>
                                <input type="number" class="form-control form-control-sm" id="bulk-default-quantity"
                                       min="0" max="99" value="0" style="width: 70px;">
                                <button class="btn btn-sm btn-outline-primary" id="apply-default-quantity-btn" title="すべてのカードに初期枚数を適用">
                                    <i class="bi bi-arrow-repeat"></i> 適用
                                </button>
                            </div>
                        </div>

                        <div id="bulk-import-card-grid" style="max-height: 600px; overflow-y: auto;">
                            <!-- Cards will be inserted here as grid -->
                        </div>
                    </div>

                    <style>
                        #bulk-import-card-grid {
                            display: grid;
                            grid-template-columns: repeat(4, 1fr);
                            gap: 1rem;
                            padding: 0.5rem;
                        }

                        .bulk-card-item {
                            display: flex;
                            flex-direction: column;
                            border: 1px solid #ddd;
                            border-radius: 8px;
                            padding: 0.75rem;
                            background: white;
                        }

                        .bulk-card-image {
                            width: 100%;
                            aspect-ratio: 59/86;
                            object-fit: contain;
                            border-radius: 4px;
                            margin-bottom: 0.5rem;
                            background: #f8f9fa;
                        }

                        .bulk-card-name {
                            font-size: 0.85rem;
                            font-weight: 600;
                            margin-bottom: 0.25rem;
                            min-height: 2.5rem;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            display: -webkit-box;
                            -webkit-line-clamp: 2;
                            -webkit-box-orient: vertical;
                            color: #000;
                        }

                        .bulk-card-number {
                            font-size: 0.75rem;
                            color: #000;
                            margin-bottom: 0.5rem;
                        }

                        .bulk-card-controls {
                            display: flex;
                            flex-direction: column;
                            gap: 0.5rem;
                        }

                        .bulk-card-controls label {
                            font-size: 0.75rem;
                            margin-bottom: 0.1rem;
                            font-weight: 500;
                            color: #000;
                        }

                        .bulk-card-controls input,
                        .bulk-card-controls select {
                            font-size: 0.85rem;
                        }

                        .bulk-card-rarities {
                            max-height: 150px;
                            overflow-y: auto;
                        }

                        .rarity-quantity-row {
                            display: flex;
                            align-items: center;
                            gap: 0.5rem;
                            margin-bottom: 0.5rem;
                        }

                        .rarity-label {
                            font-size: 0.8rem;
                            font-weight: 600;
                            min-width: 40px;
                            margin: 0;
                            color: #000;
                        }

                        .rarity-quantity-row input {
                            flex: 1;
                            max-width: 70px;
                        }

                        @media (max-width: 768px) {
                            #bulk-import-card-grid {
                                grid-template-columns: repeat(2, 1fr);
                                gap: 0.5rem;
                            }
                        }
                    </style>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-primary" id="bulk-register-btn" disabled>
                        <i class="bi bi-save" style="pointer-events: none;"></i> 登録
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom CSS Modal (VIP) -->
    <div class="modal fade" id="custom-css-modal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-palette"></i> カスタムCSS <span class="badge bg-warning text-dark">VIP</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> ここで入力したCSSは、このページのスタイルをカスタマイズします。
                    </div>
                    <div class="mb-3">
                        <label for="custom-css-input" class="form-label">CSS コード</label>
                        <textarea class="form-control font-monospace" id="custom-css-input" rows="12"
                                  placeholder="/* カスタムCSSをここに入力 */&#10;&#10;.card {&#10;    border-color: gold !important;&#10;}"></textarea>
                        <small class="text-muted">
                            例: .card { background-color: #f0f0f0; }
                        </small>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-primary" id="apply-custom-css-btn">
                            <i class="bi bi-check-circle"></i> 適用
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="preview-custom-css-btn">
                            <i class="bi bi-eye"></i> プレビュー
                        </button>
                        <button type="button" class="btn btn-outline-danger" id="reset-custom-css-btn">
                            <i class="bi bi-arrow-counterclockwise"></i> リセット
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="bulk-tag-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bulk-tag-modal-title">タグ一括編集</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="bulk-tag-modal-desc"></p>
                    <div id="bulk-tag-choices-container"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-primary" id="bulk-tag-save-btn">適用</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Modal -->
    <div class="modal fade" id="analysis-modal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-graph-up"></i> コレクション分析</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Analysis Tabs -->
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#overview-analysis" type="button">
                                <i class="bi bi-grid"></i> 概要
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#recent-history" type="button">
                                <i class="bi bi-clock-history"></i> 追加履歴
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#calendar-heatmap" type="button">
                                <i class="bi bi-calendar3"></i> カレンダー
                            </button>
                        </li>
                    </ul>

                    <!-- Tab Contents -->
                    <div class="tab-content">
                        <!-- Overview Tab -->
                        <div class="tab-pane fade show active" id="overview-analysis">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="card-title">総カード数</h5>
                                            <p class="card-text display-6" id="analysis-total-cards">0</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="card-title">ユニーク数</h5>
                                            <p class="card-text display-6" id="analysis-unique-cards">0</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="card-title">平均枚数</h5>
                                            <p class="card-text display-6" id="analysis-avg-cards">0</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="card-title">推定価値</h5>
                                            <p class="card-text display-6" id="analysis-estimated-value">¥0</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6><i class="bi bi-trophy"></i> 枚数トップ5</h6>
                                            <div class="list-group list-group-flush" id="analysis-top-cards">
                                                <p class="text-muted">データを読み込み中...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6><i class="bi bi-gem"></i> レアリティ分布</h6>
                                            <div class="list-group list-group-flush" id="analysis-rarity-ranking">
                                                <p class="text-muted">データを読み込み中...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent History Tab -->
                        <div class="tab-pane fade" id="recent-history">
                            <div class="card">
                                <div class="card-body">
                                    <h6><i class="bi bi-clock-history"></i> 直近で追加したカード（最新50件）</h6>
                                    <div id="recent-cards-list" class="list-group">
                                        <p class="text-muted">データを読み込み中...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Calendar Heatmap Tab -->
                        <div class="tab-pane fade" id="calendar-heatmap">
                            <div class="p-3">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6><i class="bi bi-calendar3"></i> カード追加カレンダー</h6>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="changeCalendarMonth(-1)">
                                            <i class="bi bi-chevron-left"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="calendar-month-label">
                                            2024年12月
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="changeCalendarMonth(1)">
                                            <i class="bi bi-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>
                                <div id="calendar-container" style="background: var(--bs-body-bg); padding: 15px; border-radius: 10px;">
                                    <!-- Calendar will be generated here -->
                                </div>
                                <div class="mt-3">
                                    <small class="text-muted">*色の濃さで追加枚数を表現</small>
                                    <div class="d-flex gap-2 mt-2">
                                        <span class="badge" style="background-color: #e0e0e0;">0枚</span>
                                        <span class="badge" style="background-color: #c6e48b;">1-5枚</span>
                                        <span class="badge" style="background-color: #7bc96f;">6-10枚</span>
                                        <span class="badge" style="background-color: #239a3b;">11-20枚</span>
                                        <span class="badge" style="background-color: #196127;">21枚以上</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="refresh-analysis-btn">
                        <i class="bi bi-arrow-clockwise"></i> データを更新
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app">
        <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4" data-bs-theme="light">
            <div class="container-fluid">
                <span class="navbar-brand"><i class="bi bi-layers-fill"></i> カード管理</span>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarContent">
                    <div class="navbar-nav ms-auto d-flex flex-row flex-wrap gap-2 mt-2 mt-lg-0">
                        <div class="d-inline-block">
                            <button class="btn btn-outline-info btn-sm" id="how-to-use-btn">
                                <i class="bi bi-question-circle"></i>
                                <span class="d-none d-sm-inline"> 使い方</span>
                            </button>
                        </div>
                        <!-- VIP Menu -->
                        <div class="dropdown d-none" id="vip-menu-container">
                            <button class="btn btn-warning btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-star-fill"></i>
                                <span class="d-none d-sm-inline"> VIP</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><button class="dropdown-item" id="vip-gallery-btn"><i class="bi bi-grid-3x3-gap"></i> カードギャラリー</button></li>
                                <li><button class="dropdown-item" id="vip-custom-css-btn"><i class="bi bi-palette"></i> カスタムCSS</button></li>
                                <li><button class="dropdown-item" id="vip-bulk-import-btn"><i class="bi bi-plus-square"></i> 一括登録</button></li>
                            </ul>
                        </div>
                        <div class="dropdown d-inline-block">
                            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-database"></i>
                                <span class="d-none d-sm-inline"> データ管理</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><button class="dropdown-item" id="import-json-btn">JSONからインポート</button></li>
                                <li><button class="dropdown-item" id="import-csv-btn">CSVからインポート</button></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><button class="dropdown-item" id="export-json-btn">JSON形式でエクスポート</button></li>
                                <li><button class="dropdown-item" id="export-csv-btn">CSV形式でエクスポート</button></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><button class="dropdown-item" id="link-master-data-btn"><i class="bi bi-link-45deg"></i> マスターデータと連携</button></li>
                            </ul>
                        </div>
                        <input type="file" id="import-file-input" accept=".json,.csv" style="display: none;">
                        <div class="d-inline-block">
                            <button class="btn btn-outline-secondary btn-sm" id="tag-management-btn">
                                <i class="bi bi-tags"></i>
                                <span class="d-none d-sm-inline"> タグ</span>
                            </button>
                        </div>
                        <div class="d-inline-block">
                            <button class="btn btn-outline-primary btn-sm" id="ranking-btn">
                                <i class="bi bi-trophy"></i>
                                <span class="d-none d-sm-inline"> ランキング</span>
                            </button>
                        </div>
                        <div class="d-inline-block">
                            <button class="btn btn-outline-warning btn-sm" id="analysis-btn">
                                <i class="bi bi-graph-up"></i>
                                <span class="d-none d-sm-inline"> 分析</span>
                            </button>
                        </div>
                        <div class="d-inline-block">
                            <button class="btn btn-outline-info btn-sm" id="profile-btn">
                                <i class="bi bi-person-circle"></i>
                                <span class="d-none d-sm-inline"> プロフィール</span>
                            </button>
                        </div>
                        <div class="d-inline-block">
                            <button class="btn btn-outline-success btn-sm" id="sync-btn" title="サーバーと同期">
                                <i class="bi bi-arrow-repeat"></i>
                                <span class="d-none d-sm-inline"> 同期</span>
                            </button>
                        </div>
                        <div class="d-inline-block">
                            <button class="btn btn-outline-secondary btn-sm" id="settings-btn">
                                <i class="bi bi-gear"></i>
                                <span class="d-none d-sm-inline"> 設定</span>
                            </button>
                        </div>
                        <span class="navbar-text d-none d-md-inline mx-2" id="user-email"></span>
                        <div class="d-inline-block">
                            <button id="logout-btn" class="btn btn-danger btn-sm">
                                <i class="bi bi-box-arrow-right"></i>
                                <span class="d-none d-sm-inline"> ログアウト</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <div class="container-fluid">
             <div id="loading-overlay" style="display: none;"><div class="spinner-border" role="status"></div></div>
            <div class="row">
                <!-- Left Column: Add Card -->
                <div class="col-lg-5">
                    <div class="card">
                        <div class="card-header">カード登録</div>
                        <div class="card-body">
                            <form id="add-form">
                                <div class="mb-3">
                                    <label for="card-search" class="form-label">カード名で検索</label>
                                    <div class="d-flex gap-2">
                                        <div class="input-group flex-grow-1">
                                            <input type="text" class="form-control" id="card-search" placeholder="カード名を入力">
                                            <button class="btn btn-success" type="button" id="search-db-btn">検索</button>
                                        </div>
                                        <button class="btn btn-outline-secondary" type="button" id="prev-search-btn" style="display: none; min-width: 44px;" title="前回の検索">
                                            <i class="bi bi-clock-history"></i>
                                        </button>
                                    </div>
                                    <div id="search-results" class="mt-2"></div>
                                </div>
                                <div class="mb-3">
                                    <label for="url" class="form-label">公式DB URL</label>
                                    <div class="input-group">
                                        <input type="url" class="form-control" id="url" placeholder="URLをペースト (Ctrl+V)...">
                                        <button class="btn btn-primary" type="button" id="fetch-btn">読込</button>
                                    </div>
                                </div>
                                <div class="mb-3"><label for="name" class="form-label">名前</label><input type="text" class="form-control" id="name" name="name" required></div>
                                <div class="mb-3">
                                    <label for="set_code" class="form-label">型番 <small class="text-muted">(任意)</small></label>
                                    <input type="text" class="form-control" id="set_code" name="set_code">
                                    <div id="set-rarity-choices" class="mt-2"></div>
                                </div>
                                <div class="mb-3"><label for="rarity" class="form-label">レアリティ</label><input type="text" class="form-control" id="rarity" name="rarity"></div>
                                <div class="mb-3">
                                    <label for="quantity" class="form-label">枚数</label>
                                    <div id="quantity-input-container" class="input-group">
                                        <button class="btn btn-outline-secondary" type="button" id="quantity-decrease">-</button>
                                        <input type="number" class="form-control" id="quantity" name="quantity" value="1" min="1" required style="text-align: center;">
                                        <button class="btn btn-outline-secondary" type="button" id="quantity-increase">+</button>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">登録先</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="add-type" id="add-to-collection" value="collection" checked>
                                        <label class="btn btn-outline-primary" for="add-to-collection">所持カード</label>
                                        <input type="radio" class="btn-check" name="add-type" id="add-to-wishlist" value="wishlist">
                                        <label class="btn btn-outline-warning" for="add-to-wishlist">ウィッシュリスト</label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">タグ</label>
                                    <div id="card-tags-container" class="mb-2"></div>
                                    <div id="tag-choices-container"></div>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-success flex-grow-1">カードを追加</button>
                                    <button type="button" class="btn btn-outline-secondary" id="prev-registration-btn" style="display: none;" title="前回の登録内容">
                                        <i class="bi bi-arrow-counterclockwise"></i>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Search/List and Stats -->
                <div class="col-lg-7">
                    <!-- Card List -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <ul class="nav nav-tabs card-header-tabs">
                                <li class="nav-item">
                                    <a class="nav-link active" id="collection-tab" data-list-type="collection" href="#">所持カード (<span id="total-collection">0</span>)</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="wishlist-tab" data-list-type="wishlist" href="#">ウィッシュリスト (<span id="total-wishlist">0</span>)</a>
                                </li>
                            </ul>
                        </div>
                        <div class="card-body">
                            <form id="search-form" class="row g-3 mb-4">
                                <div class="col-md-6"><input type="text" name="search_name" class="form-control" placeholder="名前..."></div>
                                <div class="col-md-6"><input type="text" name="search_set_code" class="form-control" placeholder="型番..."></div>
                                <div class="col-md-6"><input type="text" name="search_rarity" class="form-control" placeholder="レアリティ..."></div>
                                <div class="col-md-6"><input type="text" name="search_tags" class="form-control" placeholder="タグ..."></div>

                                <!-- Advanced Search Section -->
                                <div class="col-12">
                                    <button type="button" class="btn btn-sm btn-secondary" id="advanced-search-btn" data-bs-toggle="collapse" data-bs-target="#advanced-search" aria-expanded="false">
                                        <i class="bi bi-funnel"></i> 詳細検索
                                    </button>
                                </div>
                                <div class="collapse col-12 mt-2" id="advanced-search">
                                    <div class="card card-body bg-light">
                                        <!-- AND/OR Search Mode Selector -->
                                        <div class="row g-2 mb-3">
                                            <div class="col-12">
                                                <div class="d-flex align-items-center gap-2 flex-wrap">
                                                    <label class="form-label small mb-0 me-2">検索モード:</label>
                                                    <div class="btn-group btn-group-sm" role="group" aria-label="検索モード">
                                                        <input type="radio" class="btn-check" name="search_mode" id="search-mode-and" value="and" checked autocomplete="off">
                                                        <label class="btn btn-outline-primary" for="search-mode-and">
                                                            <i class="bi bi-intersect"></i> AND検索
                                                        </label>
                                                        <input type="radio" class="btn-check" name="search_mode" id="search-mode-or" value="or" autocomplete="off">
                                                        <label class="btn btn-outline-success" for="search-mode-or">
                                                            <i class="bi bi-union"></i> OR検索
                                                        </label>
                                                    </div>
                                                    <small class="text-muted ms-2">
                                                        <i class="bi bi-info-circle"></i>
                                                        <span id="search-mode-description">すべての条件を満たすカードを検索</span>
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Level/Rank/Link -->
                                        <div class="row g-2 mb-2">
                                            <div class="col-12">
                                                <label class="form-label small fw-bold">レベル・ランク・リンク</label>
                                                <div class="d-flex flex-wrap gap-1">
                                                    <button type="button" class="btn btn-sm btn-outline-secondary level-btn active" data-level="">すべて</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary level-btn" data-level="0">0</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary level-btn" data-level="1">1</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary level-btn" data-level="2">2</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary level-btn" data-level="3">3</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary level-btn" data-level="4">4</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary level-btn" data-level="5">5</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary level-btn" data-level="6">6</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary level-btn" data-level="7">7</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary level-btn" data-level="8">8</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary level-btn" data-level="9">9</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary level-btn" data-level="10">10</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary level-btn" data-level="11">11</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary level-btn" data-level="12">12</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary level-btn" data-level="13">13</button>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Attribute -->
                                        <div class="row g-2 mb-2">
                                            <div class="col-12">
                                                <label class="form-label small fw-bold">属性</label>
                                                <div class="d-flex flex-wrap gap-1">
                                                    <button type="button" class="btn btn-sm btn-outline-secondary attribute-btn active" data-attribute="">すべて</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary attribute-btn" data-attribute="闇">闇</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary attribute-btn" data-attribute="光">光</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary attribute-btn" data-attribute="地">地</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary attribute-btn" data-attribute="水">水</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary attribute-btn" data-attribute="炎">炎</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary attribute-btn" data-attribute="風">風</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary attribute-btn" data-attribute="神">神</button>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Card Type -->
                                        <div class="row g-2 mb-2">
                                            <div class="col-12">
                                                <label class="form-label small fw-bold">カードタイプ</label>
                                                <div class="d-flex flex-wrap gap-1 mb-1">
                                                    <button type="button" class="btn btn-sm btn-outline-primary card-type-btn" data-type="通常">通常</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary card-type-btn" data-type="効果">効果</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary card-type-btn" data-type="融合">融合</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary card-type-btn" data-type="シンクロ">シンクロ</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary card-type-btn" data-type="エクシーズ">エクシーズ</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary card-type-btn" data-type="リンク">リンク</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary card-type-btn" data-type="ペンデュラム">ペンデュラム</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary card-type-btn" data-type="儀式">儀式</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary card-type-btn" data-type="チューナー">チューナー</button>
                                                </div>
                                                <div class="d-flex flex-wrap gap-1 mb-1">
                                                    <button type="button" class="btn btn-sm btn-outline-success card-type-btn" data-type="魔法">魔法(全)</button>
                                                    <button type="button" class="btn btn-sm btn-outline-success card-type-btn" data-type="通常魔法">通常魔法</button>
                                                    <button type="button" class="btn btn-sm btn-outline-success card-type-btn" data-type="速攻魔法">速攻魔法</button>
                                                    <button type="button" class="btn btn-sm btn-outline-success card-type-btn" data-type="永続魔法">永続魔法</button>
                                                    <button type="button" class="btn btn-sm btn-outline-success card-type-btn" data-type="装備魔法">装備魔法</button>
                                                    <button type="button" class="btn btn-sm btn-outline-success card-type-btn" data-type="フィールド魔法">フィールド魔法</button>
                                                    <button type="button" class="btn btn-sm btn-outline-success card-type-btn" data-type="儀式魔法">儀式魔法</button>
                                                </div>
                                                <div class="d-flex flex-wrap gap-1">
                                                    <button type="button" class="btn btn-sm btn-outline-danger card-type-btn" data-type="罠">罠(全)</button>
                                                    <button type="button" class="btn btn-sm btn-outline-danger card-type-btn" data-type="通常罠">通常罠</button>
                                                    <button type="button" class="btn btn-sm btn-outline-danger card-type-btn" data-type="永続罠">永続罠</button>
                                                    <button type="button" class="btn btn-sm btn-outline-danger card-type-btn" data-type="カウンター罠">カウンター罠</button>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Race -->
                                        <div class="row g-2 mb-2">
                                            <div class="col-12">
                                                <label class="form-label small fw-bold">種族</label>
                                                <div class="d-flex flex-wrap gap-1">
                                                    <button type="button" class="btn btn-sm btn-outline-secondary race-btn active" data-race="">すべて</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="ドラゴン族">ドラゴン族</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="戦士族">戦士族</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="獣戦士族">獣戦士族</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="魔法使い族">魔法使い族</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="天使族">天使族</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="悪魔族">悪魔族</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="アンデット族">アンデット族</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="機械族">機械族</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="獣族">獣族</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="鳥獣族">鳥獣族</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="植物族">植物族</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="昆虫族">昆虫族</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="水族">水族</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="岩石族">岩石族</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="炎族">炎族</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="雷族">雷族</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="恐竜族">恐竜族</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="魚族">魚族</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="海竜族">海竜族</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="爬虫類族">爬虫類族</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="サイキック族">サイキック族</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="幻竜族">幻竜族</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="サイバース族">サイバース族</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="幻神獣族">幻神獣族</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="創造神族">創造神族</button>
                                                    <button type="button" class="btn btn-sm btn-outline-primary race-btn" data-race="幻想魔族">幻想魔族</button>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Attack/Defense -->
                                        <div class="row g-2 mb-2">
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">攻撃力</label>
                                                <input type="text" name="search_attack" class="form-control form-control-sm" placeholder="例: 2500, >=2000">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">守備力</label>
                                                <input type="text" name="search_defense" class="form-control form-control-sm" placeholder="例: 2000, <=1500">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-12 d-grid"><button type="submit" class="btn btn-info">検索</button></div>
                            </form>
                            
                            <!-- Bulk edit controls -->
                            <div id="bulk-edit-controls" class="alert alert-info mb-2" style="display: none;">
                                <div class="d-flex flex-wrap align-items-center gap-2">
                                    <span id="selected-count">0件選択</span>
                                    <button class="btn btn-sm btn-outline-primary" id="bulk-add-tags-btn">
                                        <i class="bi bi-tags"></i> タグ追加
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning" id="bulk-remove-tags-btn">
                                        <i class="bi bi-tags"></i> タグ削除
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" id="bulk-auto-setcode-btn">
                                        <i class="bi bi-hash"></i> 型番自動設定
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" id="bulk-delete-btn">
                                        <i class="bi bi-trash"></i> 一括削除
                                    </button>
                                    <button class="btn btn-sm btn-secondary" id="clear-selection-btn">
                                        <i class="bi bi-x-circle"></i> 選択解除
                                    </button>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="input-group w-auto">
                                    <label class="input-group-text" for="items-per-page">表示件数</label>
                                    <select class="form-select" id="items-per-page">
                                        <option value="10">10</option>
                                        <option value="20">20</option>
                                        <option value="50" selected>50</option>
                                        <option value="100">100</option>
                                    </select>
                                </div>
                                <div id="pagination-controls"></div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th scope="col" style="width: 30px; min-width: 30px;">
                                                <input type="checkbox" id="select-all-checkbox" class="form-check-input">
                                            </th>
                                            <th scope="col" data-sort="名前" class="sortable">名前<i class="bi bi-arrow-down-up ms-1"></i></th>
                                            <th scope="col" data-sort="型番" class="sortable">型番<i class="bi bi-arrow-down-up ms-1"></i></th>
                                            <th scope="col" data-sort="レアリティ" class="sortable">レア<i class="bi bi-arrow-down-up ms-1"></i></th>
                                            <th scope="col" data-sort="枚数" class="sortable" style="min-width: 50px;">枚数<i class="bi bi-arrow-down-up ms-1"></i></th>
                                            <th scope="col" data-sort="tags" class="d-none d-sm-table-cell">タグ</th>
                                            <th scope="col" style="min-width: 80px;">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="card-table-body"></tbody>
                                </table>
                            </div>
                            <div class="d-flex justify-content-center mt-2">
                                <div id="pagination-controls-bottom"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Points System -->
                    <div class="card mt-3">
                        <div class="card-body">
                            <div class="alert alert-light border-start border-5 border-warning mb-0" role="alert">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-coin text-warning me-2" style="font-size: 1.5rem;"></i>
                                        <div>
                                            <strong>ポイント</strong>
                                            <div class="d-flex align-items-baseline">
                                                <span class="fs-3 fw-bold text-warning" id="user-points">0</span>
                                                <span class="ms-2 text-muted">pt</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-warning btn-sm" id="point-shop-btn">
                                            <i class="bi bi-palette"></i> テーマ
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Collection Stats Dashboard -->
                    <div class="card mt-3" id="stats-dashboard">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-graph-up"></i> コレクション統計 <span id="collector-rank" class="badge bg-warning ms-2"></span>
                            </div>
                            <button class="btn btn-sm btn-light" id="stats-info-btn" title="統計の説明">
                                <i class="bi bi-info-circle"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-6 col-md-3">
                                    <div class="text-center">
                                        <div class="fs-2 fw-bold text-primary" id="total-cards">0</div>
                                        <small class="text-muted">総カード枚数</small>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="text-center">
                                        <div class="fs-2 fw-bold text-success" id="unique-cards">0</div>
                                        <small class="text-muted">種類数</small>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="text-center">
                                        <div class="fs-2 fw-bold text-warning" id="collection-days">0</div>
                                        <small class="text-muted">収集日数</small>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="text-center">
                                        <div class="fs-2 fw-bold text-info" id="recent-cards">0</div>
                                        <small class="text-muted">今週追加</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Progress to next milestone -->
                            <div class="mt-3" id="milestone-progress" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="text-muted">次のマイルストーンまで</small>
                                    <small class="text-primary fw-bold" id="milestone-text"></small>
                                </div>
                                <div class="progress" style="height: 25px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" id="milestone-bar" role="progressbar" style="width: 0%">
                                        <span id="milestone-percent">0%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Achievements Section -->
                            <div class="mt-3">
                                <div class="d-flex align-items-center justify-content-between mb-2" style="cursor: pointer;" id="achievement-toggle">
                                    <strong>実績一覧</strong>
                                    <i class="bi bi-chevron-down" id="achievement-toggle-icon"></i>
                                </div>
                                <div id="achievement-section" style="display: none;">
                                    <div id="achievement-summary-container"></div>
                                    <div id="achievement-details" class="achievement-details"></div>
                                </div>
                            </div>
                            
                            <!-- Rarity Distribution Chart -->
                            <div class="mt-3" id="rarity-chart-container" style="display: none;">
                                <small class="text-muted d-block mb-2">レアリティ分布</small>
                                <div class="d-flex gap-1" id="rarity-bars"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, deleteUser, setPersistence, browserLocalPersistence, sendEmailVerification, applyActionCode } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, query, where, updateDoc, increment, writeBatch, getDoc, setDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAOYKalLUb2hbghrjQUS8AWzxpLExBT7aU",
            authDomain: "ygoh-9bcf6.firebaseapp.com",
            projectId: "ygoh-9bcf6",
            storageBucket: "ygoh-9bcf6.firebasestorage.app",
            messagingSenderId: "515041224138",
            appId: "1:515041224138:web:8de47b38ed9cc1bb8afd37",
            measurementId: "G-ZGSRE8MHZ2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        setPersistence(auth, browserLocalPersistence).catch((error) => {
        });

        let cardCollection = [];
        let wishlistCollection = [];
        let currentListType = 'collection'; // 'collection' or 'wishlist'
        let currentUser = null;
        let sortConfig = { key: '名前', direction: 'ascending' };
        let currentPage = 1;
        let cardReadingMap = new Map(); // Map for hiragana -> card names
        let cardDetailsMap = new Map(); // Map for card details (level, attribute, etc.)
        // Set smaller initial page size for mobile devices
        let itemsPerPage = window.innerWidth <= 768 ? 20 : 50;
        let filteredCardCollection = [];
        let allTags = [];
        
        // Gamification data - will be synced with Firebase
        let gamificationData = {
            userPoints: 0,
            purchasedItems: {},
            activeIcon: '',
            registrationStreak: { count: 0, lastDate: null },
            weeklyGoalData: { weekStart: null, count: 0, goal: 50 },
            todayAdditions: { date: null, count: 0 },
            firstCollectionDate: null,
            lastMilestoneReached: 0,
            cardAdditionDates: {},
            cardAdditionHeatmap: {}, // { 'YYYY-MM-DD': count } for calendar heatmap
            hasReceivedFirstLoginBonus: false, // Track first login bonus in Firebase
            recentCardsHistory: [], // Recent card addition history for analysis
            // Profile data
            profile: {
                nickname: '',
                icon: '👤',
                firstUseDate: null,
                lastUseDate: null,
                usageDays: new Set(),
                maxStreak: 0,
                totalPointsEarned: 0
            }
        };
        
        // Save gamification data to Firebase (debounced to reduce writes)
        let _saveGamificationTimer = null;
        const _doSaveGamification = async () => {
            if (!currentUser) return;
            try {
                const userDocRef = doc(db, 'userGamification', currentUser.uid);
                const dataToSave = {
                    ...gamificationData,
                    profile: {
                        ...gamificationData.profile,
                        usageDays: gamificationData.profile?.usageDays ? Array.from(gamificationData.profile.usageDays) : []
                    }
                };
                await setDoc(userDocRef, dataToSave, { merge: true });
            } catch (error) {
                console.error('Error saving gamification data:', error);
            }
        };
        const saveGamificationData = async (immediate = false) => {
            if (!currentUser) return;
            if (_saveGamificationTimer) {
                clearTimeout(_saveGamificationTimer);
                _saveGamificationTimer = null;
            }
            if (immediate) {
                await _doSaveGamification();
            } else {
                _saveGamificationTimer = setTimeout(_doSaveGamification, 300);
            }
        };
        
        // Load gamification data from Firebase
        const loadGamificationData = async () => {
            if (!currentUser) return;
            
            try {
                const userDocRef = doc(db, 'userGamification', currentUser.uid);
                const docSnap = await getDoc(userDocRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Convert Array back to Set for usageDays
                    if (data.profile?.usageDays) {
                        data.profile.usageDays = new Set(data.profile.usageDays);
                    }
                    // Merge with default values to ensure all properties exist
                    gamificationData = {
                        ...gamificationData,
                        ...data,
                        profile: {
                            ...gamificationData.profile,
                            ...data.profile
                        }
                    };
                } else {
                    // Initialize new user data
                    await saveGamificationData();
                }
                
                // Sync recentCardsHistory from Firebase to localStorage
                if (gamificationData.recentCardsHistory && gamificationData.recentCardsHistory.length > 0) {
                    localStorage.setItem('recentCardsHistory', JSON.stringify(gamificationData.recentCardsHistory));
                    console.log('📥 Synced recentCardsHistory from Firebase:', gamificationData.recentCardsHistory.length, 'entries');
                }
                
                // Track today's usage
                trackDailyUsage();
            } catch (error) {
                console.error('Error loading gamification data:', error);
            }
        };
        let currentCardTags = [];
        let selectedCardIds = new Set();

        // Load Yu-Gi-Oh card reading data from CSV
        const loadCardReadingData = async () => {
            try {
                // Try loading master CSV file first, then fall back to the old file
                let response = await fetch('yugioh_cards_master.csv');
                if (!response.ok) {
                    response = await fetch('yugioh_cards_all_20250914_104808.csv');
                }
                let csvText = await response.text();

                // Remove BOM if present
                if (csvText.charCodeAt(0) === 0xFEFF) {
                    csvText = csvText.substring(1);
                }

                // Parse CSV
                const lines = csvText.split('\n');

                // Check if first column is カードID (new format) or 名前 (old format)
                const headers = lines[0].split(',');
                const hasCardId = headers[0].includes('カードID') || headers[0].includes('ID');

                // CSV columns: [カードID,]名前,読み方,レベル,属性,種族,カードタイプ,攻撃力,守備力,カードテキスト

                // Process each line (skip header)
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    // Parse CSV line (handle commas in quotes)
                    const values = [];
                    let current = '';
                    let inQuotes = false;

                    for (let j = 0; j < line.length; j++) {
                        const char = line[j];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            values.push(current);
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    values.push(current);

                    // Get card data
                    // Handle both formats (with and without カードID)
                    let cardId, cardName, cardReading, level, attribute, race, cardType, attack, defense, cardText;

                    if (hasCardId) {
                        cardId = values[0]?.replace(/^"|"$/g, '').trim();
                        cardName = values[1]?.replace(/^"|"$/g, '').trim();
                        cardReading = values[2]?.replace(/^"|"$/g, '').trim();
                        level = values[3]?.replace(/^"|"$/g, '').trim();
                        attribute = values[4]?.replace(/^"|"$/g, '').trim();
                        race = values[5]?.replace(/^"|"$/g, '').trim();
                        cardType = values[6]?.replace(/^"|"$/g, '').trim();
                        attack = values[7]?.replace(/^"|"$/g, '').trim();
                        defense = values[8]?.replace(/^"|"$/g, '').trim();
                        cardText = values[9]?.replace(/^"|"$/g, '').trim();
                    } else {
                        cardName = values[0]?.replace(/^"|"$/g, '').trim();
                        cardReading = values[1]?.replace(/^"|"$/g, '').trim();
                        level = values[2]?.replace(/^"|"$/g, '').trim();
                        attribute = values[3]?.replace(/^"|"$/g, '').trim();
                        race = values[4]?.replace(/^"|"$/g, '').trim();
                        cardType = values[5]?.replace(/^"|"$/g, '').trim();
                        attack = values[6]?.replace(/^"|"$/g, '').trim();
                        defense = values[7]?.replace(/^"|"$/g, '').trim();
                        cardText = values[8]?.replace(/^"|"$/g, '').trim();
                    }

                    if (cardName) {
                        // Store card details
                        cardDetailsMap.set(cardName, {
                            cardId: cardId || '',
                            reading: cardReading,
                            level: level,
                            attribute: attribute,
                            race: race,
                            cardType: cardType,
                            attack: attack,
                            defense: defense,
                            cardText: cardText
                        });

                        // Store reading mappings
                        if (cardReading) {
                            // Store the reading in lowercase for case-insensitive search
                            const readingKey = cardReading.toLowerCase();

                            // Store multiple cards with same reading
                            if (!cardReadingMap.has(readingKey)) {
                                cardReadingMap.set(readingKey, []);
                            }
                            cardReadingMap.get(readingKey).push(cardName);

                            // Also store hiragana version of the reading if it's in katakana
                            const hiraganaReading = readingKey.replace(/[\u30A1-\u30F6]/g, function(match) {
                                const code = match.charCodeAt(0) - 0x60;
                                return String.fromCharCode(code);
                            });

                            if (hiraganaReading !== readingKey) {
                                if (!cardReadingMap.has(hiraganaReading)) {
                                    cardReadingMap.set(hiraganaReading, []);
                                }
                                cardReadingMap.get(hiraganaReading).push(cardName);
                            }
                        }
                    }
                }

                console.log(`Loaded ${cardReadingMap.size} card readings and ${cardDetailsMap.size} card details from CSV`);

                // Debug: Show first few entries
                let count = 0;
                for (const [name, details] of cardDetailsMap) {
                    if (count++ < 5) {
                        console.log('Sample card in master data:', name);
                    } else {
                        break;
                    }
                }
            } catch (error) {
                console.error('Failed to load card reading data:', error);
            }
        };

        // Load card reading data on page load
        loadCardReadingData();

        const mainApp = document.getElementById('main-app');
        const appLoader = document.getElementById('app-loader');
        const authModal = new bootstrap.Modal(document.getElementById('auth-modal'));
        const editCardModal = new bootstrap.Modal(document.getElementById('edit-card-modal'));
        const cardDetailModal = new bootstrap.Modal(document.getElementById('card-detail-modal'));
        const howToUseModal = new bootstrap.Modal(document.getElementById('how-to-use-modal'));
        const settingsModal = new bootstrap.Modal(document.getElementById('settings-modal'));
        const tagManagementModal = new bootstrap.Modal(document.getElementById('tag-management-modal'));
        const bulkTagModal = new bootstrap.Modal(document.getElementById('bulk-tag-modal'));
        const analysisModal = new bootstrap.Modal(document.getElementById('analysis-modal'));

        // Ensure modals are always visible when opened
        const ensureModalVisible = (modalElement) => {
            if (!modalElement) return;

            // For mobile devices, scroll to top and reset any scroll position
            if (window.innerWidth <= 768) {
                // Reset scroll position to top
                window.scrollTo(0, 0);
                document.body.scrollTop = 0;
                document.documentElement.scrollTop = 0;

                // Ensure modal dialog is properly positioned
                const modalDialog = modalElement.querySelector('.modal-dialog');
                if (modalDialog) {
                    modalDialog.scrollIntoView({ behavior: 'instant', block: 'center' });
                }
            }
        };

        // モーダル表示時の背景スクロール制御
        const disableBodyScroll = () => {
            // スマートフォンでのスクロールを無効化
            document.body.style.overflow = 'hidden';
            document.body.style.position = 'fixed';
            document.body.style.width = '100%';
            // 現在のスクロール位置を保存
            document.body.dataset.scrollY = window.scrollY.toString();
            document.body.style.top = `-${window.scrollY}px`;
        };

        const enableBodyScroll = () => {
            // スクロールを再度有効化
            const scrollY = document.body.dataset.scrollY || '0';
            document.body.style.overflow = '';
            document.body.style.position = '';
            document.body.style.width = '';
            document.body.style.top = '';
            // 保存していたスクロール位置に戻す
            window.scrollTo(0, parseInt(scrollY));
            delete document.body.dataset.scrollY;
        };

        // Add show event listeners for all modals
        const modalElements = [
            'auth-modal', 'edit-card-modal', 'card-detail-modal',
            'how-to-use-modal', 'settings-modal', 'tag-management-modal',
            'bulk-tag-modal', 'analysis-modal', 'point-shop-modal',
            'profile-modal', 'ranking-modal', 'stats-info-modal',
            'gacha-result-modal'
        ];

        modalElements.forEach(modalId => {
            const modalEl = document.getElementById(modalId);
            if (modalEl) {
                modalEl.addEventListener('show.bs.modal', () => {
                    ensureModalVisible(modalEl);
                    // モバイルデバイスでのみ背景スクロールを無効化
                    if (window.innerWidth <= 768) {
                        disableBodyScroll();
                    }
                });

                // Also ensure visibility after modal is fully shown
                modalEl.addEventListener('shown.bs.modal', () => {
                    ensureModalVisible(modalEl);
                });

                // モーダルを閉じる時にスクロールを再度有効化
                modalEl.addEventListener('hidden.bs.modal', () => {
                    // モバイルデバイスでのみ
                    if (window.innerWidth <= 768) {
                        enableBodyScroll();
                    }
                });
            }
        });
        const authError = document.getElementById('auth-error');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailSpan = document.getElementById('user-email');
        const cardTableBody = document.getElementById('card-table-body');
        const totalCollectionSpan = document.getElementById('total-collection');
        const totalWishlistSpan = document.getElementById('total-wishlist');
        const loadingOverlay = document.getElementById('loading-overlay');
        const addForm = document.getElementById('add-form');
        const searchForm = document.getElementById('search-form');
        const importFileInput = document.getElementById('import-file-input');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const hideEmailToggle = document.getElementById('hide-email-toggle');
        const showSearchHistoryToggle = document.getElementById('show-search-history-toggle');
        const showRegistrationHistoryToggle = document.getElementById('show-registration-history-toggle');
        const useTapQuantityToggle = document.getElementById('use-tap-quantity-toggle');

        const showLoading = (show) => { loadingOverlay.style.display = show ? 'flex' : 'none'; };
        
        const updateHistoryButton = (btnId, storageKey, data, titlePrefix) => {
            const btn = document.getElementById(btnId);
            const show = localStorage.getItem(storageKey) === 'true' && data;
            btn.style.display = show ? 'inline-block' : 'none';
            if (show) btn.title = `${titlePrefix}: ${typeof data === 'object' ? data.name : data}`;
        };
        const updateSearchHistoryButton = () => updateHistoryButton('prev-search-btn', 'showSearchHistory', lastSearchKeyword, '前回の検索');
        const updateRegistrationHistoryButton = () => updateHistoryButton('prev-registration-btn', 'showRegistrationHistory', lastRegistrationData, '前回の登録');
        
        const decodeHtmlEntities = (str) => {
            if (str == null) return '';
            const textarea = document.createElement('textarea');
            textarea.innerHTML = str;
            return textarea.value;
        };

        const escapeHtml = (str) => str == null ? '' : String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
        
        const getCurrentCollection = () => currentListType === 'collection' ? cardCollection : wishlistCollection;
        
        const renderTable = () => {
            const currentData = getCurrentCollection();
            filteredCardCollection.sort((a, b) => {
                let [vA, vB] = [a.data[sortConfig.key], b.data[sortConfig.key]];
                if (sortConfig.key === '枚数') {
                    [vA, vB] = [parseInt(vA, 10) || 0, parseInt(vB, 10) || 0];
                } else {
                    [vA, vB] = [String(vA || '').toLowerCase(), String(vB || '').toLowerCase()];
                }
                return vA === vB ? 0 : (vA < vB ? -1 : 1) * (sortConfig.direction === 'ascending' ? 1 : -1);
            });

            // Get table rows setting
            const rowsPerPage = localStorage.getItem('tableRowsPerPage') || '100';
            const actualItemsPerPage = rowsPerPage === 'all' ? filteredCardCollection.length : parseInt(rowsPerPage, 10);

            const startIndex = (currentPage - 1) * actualItemsPerPage;
            const endIndex = startIndex + actualItemsPerPage;
            const paginatedItems = filteredCardCollection.slice(startIndex, endIndex);

            // Use DocumentFragment for better performance
            const fragment = document.createDocumentFragment();

            if (paginatedItems.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="6" class="text-center">該当するカードはありません。</td>';
                fragment.appendChild(tr);
            } else {
                // Check if mobile for simplified view
                const isMobile = window.innerWidth <= 768;

                paginatedItems.forEach(card => {
                    const tr = document.createElement('tr');
                    const tags = (card.data.tags || []).map(tag => escapeHtml(tag)).join(', ');
                    const isChecked = selectedCardIds.has(card.id) ? 'checked' : '';
                    const decodedName = decodeHtmlEntities(card.data['名前']);

                    if (isMobile) {
                        // Simplified mobile view without tags column
                        tr.innerHTML = `
                            <td>
                                <input type="checkbox" class="form-check-input card-checkbox" data-id="${escapeHtml(card.id)}" ${isChecked}>
                            </td>
                            <td>${escapeHtml(decodedName)}</td>
                            <td>${escapeHtml(card.data['型番'])}</td>
                            <td>${escapeHtml(card.data['レアリティ'])}</td>
                            <td>${escapeHtml(card.data['枚数'])}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-info view-detail-btn" data-id="${escapeHtml(card.id)}" data-card-data='${JSON.stringify(card.data).replace(/'/g, "&#39;")}'>詳細</button>
                                <button class="btn btn-sm btn-outline-secondary edit-tags-btn" data-id="${escapeHtml(card.id)}" data-current-tags='${JSON.stringify(card.data.tags || []).replace(/'/g, "&#39;")}'>タグ</button>
                            </td>
                        `;
                    } else {
                        tr.innerHTML = `
                            <td>
                                <input type="checkbox" class="form-check-input card-checkbox" data-id="${escapeHtml(card.id)}" ${isChecked}>
                            </td>
                            <td>${escapeHtml(decodedName)}</td>
                            <td>${escapeHtml(card.data['型番'])}</td>
                            <td>${escapeHtml(card.data['レアリティ'])}</td>
                            <td>${escapeHtml(card.data['枚数'])}</td>
                            <td class="tag-cell d-none d-sm-table-cell" title="${escapeHtml(tags)}">
                                <span class="tags-display" data-card-id="${escapeHtml(card.id)}">${tags}</span>
                                <button class="btn btn-sm btn-link edit-tags-btn" data-id="${escapeHtml(card.id)}" style="padding: 0 0.25rem; display: none;" title="タグを編集"><i class="bi bi-pencil-square"></i></button>
                            </td>
                            <td>
                                <button class="btn btn-info btn-sm view-detail-btn" data-name="${escapeHtml(decodedName)}" title="詳細表示"><i class="bi bi-eye"></i></button>
                                <button class="btn btn-primary btn-sm edit-btn" data-id="${escapeHtml(card.id)}"><i class="bi bi-pencil"></i></button>
                                ${currentListType === 'wishlist' ? `<button class="btn btn-success btn-sm move-to-collection-btn" data-id="${escapeHtml(card.id)}" title="所持カードへ移動"><i class="bi bi-check-circle"></i></button>` : ''}
                                <button class="btn btn-danger btn-sm delete-btn" data-id="${escapeHtml(card.id)}"><i class="bi bi-trash"></i></button>
                            </td>
                        `;
                    }
                    fragment.appendChild(tr);
                });
            }

            // Clear and append all at once for better performance
            cardTableBody.innerHTML = '';
            cardTableBody.appendChild(fragment);

            updatePaginationControls();
            updateSortIcons();
            updateTotalCounts();
        };

        const updatePaginationControls = () => {
            const rowsPerPage = localStorage.getItem('tableRowsPerPage') || '100';
            const actualItemsPerPage = rowsPerPage === 'all' ? filteredCardCollection.length : parseInt(rowsPerPage, 10);
            const totalPages = Math.ceil(filteredCardCollection.length / actualItemsPerPage);
            const controlsHtml = `
                <div class="d-flex flex-wrap align-items-center gap-1 gap-sm-2">
                    <span class="text-nowrap">${totalPages > 0 ? currentPage : 0}/${totalPages}ページ</span>
                    <span class="text-nowrap">(${filteredCardCollection.length}件)</span>
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-secondary" ${currentPage <= 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">前へ</button>
                        <button class="btn btn-outline-secondary" ${currentPage >= totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">次へ</button>
                    </div>
                </div>
            `;
            document.getElementById('pagination-controls').innerHTML = controlsHtml;
            document.getElementById('pagination-controls-bottom').innerHTML = controlsHtml;
        };

        window.changePage = (page) => {
            currentPage = page;
            renderTable();
        };

        const renderTagChoices = (containerId, selectedTags) => {
            const container = document.getElementById(containerId);
            container.innerHTML = allTags.map(tag =>
                `<button type="button" class="btn btn-sm ${selectedTags.includes(tag.name) ? 'btn-primary' : 'btn-outline-secondary'} m-1" onclick="toggleTag('${escapeHtml(tag.name)}', ${containerId.startsWith('edit')})">${escapeHtml(tag.name)}</button>`
            ).join('');
        };

        const renderSelectedTags = (containerId, tags) => document.getElementById(containerId).innerHTML = tags.map(tag => `<span class="badge bg-secondary me-1">${escapeHtml(tag)}</span>`).join(' ');

        window.toggleTag = (tagName, isEdit) => {
            const i = currentCardTags.indexOf(tagName);
            i > -1 ? currentCardTags.splice(i, 1) : currentCardTags.push(tagName);
            const [choices, tags] = isEdit ? ['edit-tag-choices-container', 'edit-card-tags-container'] : ['tag-choices-container', 'card-tags-container'];
            renderTagChoices(choices, currentCardTags);
            renderSelectedTags(tags, currentCardTags);
        };

        // Card detail view functionality
        const showCardDetail = (cardName) => {
            const detailContent = document.getElementById('card-detail-content');

            // Check if we have the card details
            if (!cardDetailsMap.has(cardName)) {
                detailContent.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> カード「${escapeHtml(cardName)}」の詳細情報が見つかりません。
                    </div>
                `;
                return;
            }

            const details = cardDetailsMap.get(cardName);

            // Create detailed card view
            detailContent.innerHTML = `
                <div class="card">
                    <div class="card-header bg-light">
                        <h4 class="mb-0">${escapeHtml(cardName)}</h4>
                        ${details.reading ? `<small class="text-muted">${escapeHtml(details.reading)}</small>` : ''}
                    </div>
                    <div class="card-body">
                        <div class="row">
                            ${details.cardId ? `
                            <div class="col-md-6 mb-3">
                                <strong>カードID:</strong> ${escapeHtml(details.cardId)}
                            </div>` : ''}
                            ${details.cardType ? `
                            <div class="col-md-6 mb-3">
                                <strong>カードタイプ:</strong> ${escapeHtml(details.cardType)}
                            </div>` : ''}
                            ${details.level ? `
                            <div class="col-md-6 mb-3">
                                <strong>レベル/ランク/リンク:</strong> ${escapeHtml(details.level)}
                            </div>` : ''}
                            ${details.attribute ? `
                            <div class="col-md-6 mb-3">
                                <strong>属性:</strong> ${escapeHtml(details.attribute)}
                            </div>` : ''}
                            ${details.race ? `
                            <div class="col-md-6 mb-3">
                                <strong>種族:</strong> ${escapeHtml(details.race)}
                            </div>` : ''}
                            ${details.attack ? `
                            <div class="col-md-6 mb-3">
                                <strong>攻撃力:</strong> ${escapeHtml(details.attack)}
                            </div>` : ''}
                            ${details.defense ? `
                            <div class="col-md-6 mb-3">
                                <strong>守備力:</strong> ${escapeHtml(details.defense)}
                            </div>` : ''}
                        </div>
                        ${details.cardText ? `
                        <div class="mt-3">
                            <strong>カードテキスト:</strong>
                            <div class="card bg-light p-3 mt-2">
                                <p class="mb-0" style="white-space: pre-line;">${escapeHtml(details.cardText)}</p>
                            </div>
                        </div>` : ''}
                        ${details.cardId ? `
                        <div class="mt-3">
                            <a href="https://www.db.yugioh-card.com/yugiohdb/card_search.action?ope=2&cid=${escapeHtml(details.cardId)}"
                               target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-box-arrow-up-right"></i> 公式データベースで見る
                            </a>
                        </div>` : ''}
                    </div>
                </div>
            `;
        };

        // Quick tag edit functionality
        document.addEventListener('click', async (e) => {
            // Handle view detail button
            if (e.target.closest('.view-detail-btn')) {
                e.preventDefault();
                const btn = e.target.closest('.view-detail-btn');
                const cardName = btn.dataset.name;
                if (cardName) {
                    showCardDetail(cardName);
                    cardDetailModal.show();
                }
            }

            if (e.target.closest('.edit-tags-btn')) {
                e.preventDefault();
                e.stopPropagation();
                const cardId = e.target.closest('.edit-tags-btn').dataset.id;
                const card = getCurrentCollection().find(c => c.id === cardId);
                if (!card) return;

                // Show edit modal with tags focused
                currentCardTags = [...(card.data.tags || [])];
                document.getElementById('edit-card-id').value = cardId;
                document.getElementById('edit-name').value = card.data['名前'];
                document.getElementById('edit-set-code').value = card.data['型番'] || '';
                document.getElementById('edit-rarity').value = card.data['レアリティ'] || '';
                document.getElementById('edit-quantity').value = card.data['枚数'];

                renderTagChoices('edit-tag-choices-container', currentCardTags);
                renderSelectedTags('edit-card-tags-container', currentCardTags);

                editCardModal.show();

                // Focus on tags section
                setTimeout(() => {
                    const tagsContainer = document.getElementById('edit-tag-choices-container');
                    if (tagsContainer) {
                        tagsContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 300);
            }
        });

        const updateSortIcons = () => {
            document.querySelectorAll('th.sortable').forEach(th => {
                const icon = th.querySelector('i');
                if (th.dataset.sort === sortConfig.key) {
                    icon.className = sortConfig.direction === 'ascending' ? 'bi bi-sort-down' : 'bi bi-sort-up';
                } else {
                    icon.className = 'bi bi-arrow-down-up';
                }
            });
        };

        const updateTotalCounts = () => {
            const totalCollection = cardCollection.reduce((sum, card) => sum + (card.data['枚数'] || 0), 0);
            const totalWishlist = wishlistCollection.reduce((sum, card) => sum + (card.data['枚数'] || 0), 0);
            totalCollectionSpan.textContent = totalCollection;
            totalWishlistSpan.textContent = totalWishlist;
            updateCollectionStats(); // Update gamification stats
        };
        
        // Gamification features - now loaded from Firebase
        
        // Achievement categories with expanded variety
        const ACHIEVEMENT_CATEGORIES = {
            '枚数': [
                { id: 'cards10', name: 'ファーストステップ', desc: '10枚', threshold: 10, class: 'bronze' },
                { id: 'cards25', name: 'コレクター', desc: '25枚', threshold: 25, class: 'bronze' },
                { id: 'cards50', name: '熟練者', desc: '50枚', threshold: 50, class: 'silver' },
                { id: 'cards100', name: 'エキスパート', desc: '100枚', threshold: 100, class: 'silver' },
                { id: 'cards250', name: 'ベテラン', desc: '250枚', threshold: 250, class: 'gold' },
                { id: 'cards500', name: 'マスター', desc: '500枚', threshold: 500, class: 'gold' },
                { id: 'cards1000', name: 'グランドマスター', desc: '1000枚', threshold: 1000, class: 'platinum' },
                { id: 'cards2500', name: 'チャンピオン', desc: '2500枚', threshold: 2500, class: 'platinum' },
                { id: 'cards5000', name: 'レジェンド', desc: '5000枚', threshold: 5000, class: 'diamond' },
                { id: 'cards10000', name: 'ミシック', desc: '10000枚', threshold: 10000, class: 'diamond' },
                { id: 'cards25000', name: 'イモータル', desc: '25000枚', threshold: 25000, class: 'mythic' },
                { id: 'cards50000', name: 'エターナル', desc: '50000枚', threshold: 50000, class: 'mythic' },
                { id: 'cards100000', name: 'オムニ', desc: '100000枚', threshold: 100000, class: 'mythic' }
            ],
            '種類': [
                { id: 'unique5', name: 'バラエティ', desc: '5種類', threshold: 5, class: 'bronze', type: 'unique' },
                { id: 'unique10', name: 'コレクター', desc: '10種類', threshold: 10, class: 'bronze', type: 'unique' },
                { id: 'unique25', name: '探求者', desc: '25種類', threshold: 25, class: 'silver', type: 'unique' },
                { id: 'unique50', name: '研究者', desc: '50種類', threshold: 50, class: 'silver', type: 'unique' },
                { id: 'unique100', name: '学者', desc: '100種類', threshold: 100, class: 'gold', type: 'unique' },
                { id: 'unique200', name: '博士', desc: '200種類', threshold: 200, class: 'gold', type: 'unique' },
                { id: 'unique500', name: '百科事典', desc: '500種類', threshold: 500, class: 'platinum', type: 'unique' },
                { id: 'unique1000', name: 'アーカイブ', desc: '1000種類', threshold: 1000, class: 'diamond', type: 'unique' }
            ],
            'レアリティ': [
                { id: 'rare5', name: 'Rハンター', desc: 'R以上5枚', threshold: 5, class: 'bronze', type: 'rarity' },
                { id: 'rare25', name: 'SRハンター', desc: 'SR以上25枚', threshold: 25, class: 'silver', type: 'sr' },
                { id: 'rare50', name: 'URハンター', desc: 'UR以上50枚', threshold: 50, class: 'gold', type: 'ur' },
                { id: 'rare100', name: 'SEハンター', desc: 'SE系100枚', threshold: 100, class: 'platinum', type: 'se' },
                { id: 'premium10', name: 'プレミアム', desc: 'P系10枚', threshold: 10, class: 'gold', type: 'premium' },
                { id: 'ul5', name: 'ULコレクター', desc: 'UL5枚', threshold: 5, class: 'platinum', type: 'ul' },
                { id: 'qcse1', name: 'QCSE所持者', desc: 'QCSE1枚', threshold: 1, class: 'mythic', type: 'qcse' }
            ],
            '継続': [
                { id: 'days3', name: 'ビギナー', desc: '3日間', threshold: 3, class: 'bronze', type: 'days' },
                { id: 'days7', name: '週間プレイヤー', desc: '7日間', threshold: 7, class: 'bronze', type: 'days' },
                { id: 'days30', name: '月間プレイヤー', desc: '30日間', threshold: 30, class: 'silver', type: 'days' },
                { id: 'days90', name: 'シーズンプレイヤー', desc: '90日間', threshold: 90, class: 'gold', type: 'days' },
                { id: 'days180', name: '半年プレイヤー', desc: '180日間', threshold: 180, class: 'platinum', type: 'days' },
                { id: 'days365', name: '年間プレイヤー', desc: '365日間', threshold: 365, class: 'diamond', type: 'days' },
                { id: 'days730', name: 'ベテラン', desc: '730日間', threshold: 730, class: 'mythic', type: 'days' }
            ],
            '特殊': [
                { id: 'speed10', name: 'スピードラン', desc: '一日で10枚追加', threshold: 10, class: 'silver', type: 'daily' },
                { id: 'speed50', name: 'マラソンランナー', desc: '一日で50枚追加', threshold: 50, class: 'gold', type: 'daily' },
                { id: 'weekend100', name: '週末ハンター', desc: '一週間で100枚', threshold: 100, class: 'gold', type: 'weekly' },
                { id: 'completionist', name: 'コンプリート', desc: 'タグ10個以上使用', threshold: 10, class: 'platinum', type: 'tags' },
                { id: 'organizer', name: '整理達人', desc: 'タグ20個以上作成', threshold: 20, class: 'diamond', type: 'tags' }
            ]
        };
        
        // Flatten achievements for backward compatibility
        const ACHIEVEMENTS = Object.values(ACHIEVEMENT_CATEGORIES).flat();
        
        const MILESTONES = [10, 25, 50, 75, 100, 150, 200, 300, 500, 1000, 1500, 2000, 3000, 5000, 7500, 10000, 15000, 20000, 30000, 50000, 75000, 100000];
        
        const getRarityScore = (rarity) => {
            if (!rarity) return 1;
            const rarityLower = rarity.toLowerCase();
            if (rarityLower.includes('ウルトラ') || rarityLower.includes('ultra')) return 5;
            if (rarityLower.includes('スーパー') || rarityLower.includes('super')) return 4;
            if (rarityLower.includes('レア') || rarityLower.includes('rare')) return 3;
            if (rarityLower.includes('ノーマル') || rarityLower.includes('normal')) return 2;
            return 1;
        };
        
        // Point System - now in gamificationData
        
        const POINT_REWARDS = {
            addCard: 5,          // カード追加
            addRareCard: 10,     // レアカード追加
            completeMission: 20, // ミッション完了
            dailyLogin: 10,      // デイリーログイン
            weekStreak: 50,      // 週間ストリーク
        };
        
        const SHOP_ITEMS = {
            icons: [
                // Basic icons (50-150pt)
                { id: 'icon-star', name: 'スター', cost: 50, class: 'icon-star', emoji: '✨' },
                { id: 'icon-heart', name: 'ハート', cost: 60, class: 'icon-heart', emoji: '❤️' },
                { id: 'icon-ghost', name: 'ゴースト', cost: 80, class: 'icon-ghost', emoji: '👻' },
                { id: 'icon-crown', name: '王冠', cost: 100, class: 'icon-crown', emoji: '👑' },
                { id: 'icon-robot', name: 'ロボット', cost: 120, class: 'icon-robot', emoji: '🤖' },
                { id: 'icon-alien', name: 'エイリアン', cost: 150, class: 'icon-alien', emoji: '👽' },
                { id: 'icon-devil', name: 'デビル', cost: 180, class: 'icon-devil', emoji: '😈' },
                { id: 'icon-sword', name: '剣', cost: 200, class: 'icon-sword', emoji: '⚔️' },
                { id: 'icon-wizard', name: '魔法使い', cost: 250, class: 'icon-wizard', emoji: '🧙' },
                { id: 'icon-dragon', name: 'ドラゴン', cost: 300, class: 'icon-dragon', emoji: '🐉' },
                { id: 'icon-phoenix', name: '不死鳥', cost: 350, class: 'icon-phoenix', emoji: '🦅' },
                { id: 'icon-unicorn', name: 'ユニコーン', cost: 400, class: 'icon-unicorn', emoji: '🦄' },
                { id: 'icon-ninja', name: '忍者', cost: 450, class: 'icon-ninja', emoji: '🥷' },
                { id: 'icon-monster', name: 'モンスター', cost: 600, class: 'icon-monster', emoji: '👹' },
                { id: 'icon-legendary', name: 'レジェンダリー', cost: 700, class: 'icon-legendary', emoji: '💫' },
                { id: 'icon-infinity', name: 'インフィニティ', cost: 800, class: 'icon-infinity', emoji: '♾️' },
                
                // New emoji icons (300-800pt)
                { id: 'icon-fire', name: '炎', cost: 350, class: 'icon-fire', emoji: '🔥' },
                { id: 'icon-skull', name: 'ドクロ', cost: 450, class: 'icon-skull', emoji: '💀' },
                { id: 'icon-newmoon', name: '新月', cost: 300, class: 'icon-newmoon', emoji: '🌑' },
                { id: 'icon-moon', name: '月', cost: 350, class: 'icon-moon', emoji: '🌙' },
                { id: 'icon-tornado', name: '竜巻', cost: 500, class: 'icon-tornado', emoji: '🌪️' },
                { id: 'icon-star2', name: '星', cost: 300, class: 'icon-star2', emoji: '🌟' },
                { id: 'icon-swords', name: '交差剣', cost: 400, class: 'icon-swords', emoji: '⚔️' },
                { id: 'icon-dagger', name: '短剣', cost: 350, class: 'icon-dagger', emoji: '🗡️' },
                { id: 'icon-bat', name: 'コウモリ', cost: 400, class: 'icon-bat', emoji: '🦇' },
                { id: 'icon-bone', name: '骨', cost: 300, class: 'icon-bone', emoji: '🦴' },
                { id: 'icon-fox', name: '狐', cost: 550, class: 'icon-fox', emoji: '🦊' },
                
                // Special symbols (300-800pt)
                { id: 'icon-cross', name: 'クロス', cost: 450, class: 'icon-cross', emoji: '†' },
                { id: 'icon-star3', name: 'スター✪', cost: 350, class: 'icon-star3', emoji: '✪' },
                { id: 'icon-star4', name: 'スター✧', cost: 400, class: 'icon-star4', emoji: '✧' },
                { id: 'icon-star5', name: 'スター✵', cost: 450, class: 'icon-star5', emoji: '✵' },
                { id: 'icon-star6', name: 'スター✯', cost: 500, class: 'icon-star6', emoji: '✯' },
                { id: 'icon-star7', name: 'スター✹', cost: 550, class: 'icon-star7', emoji: '✹' },
                { id: 'icon-star8', name: 'スター❂', cost: 600, class: 'icon-star8', emoji: '❂' },
                { id: 'icon-star9', name: 'スター❉', cost: 650, class: 'icon-star9', emoji: '❉' },
                { id: 'icon-cross2', name: '十字架', cost: 700, class: 'icon-cross2', emoji: '☩' },
                { id: 'icon-star10', name: 'スター✦', cost: 350, class: 'icon-star10', emoji: '✦' },
                { id: 'icon-star11', name: 'スター✶', cost: 400, class: 'icon-star11', emoji: '✶' },
                { id: 'icon-star12', name: 'スター✸', cost: 450, class: 'icon-star12', emoji: '✸' },
                { id: 'icon-star13', name: 'スター✺', cost: 500, class: 'icon-star13', emoji: '✺' },
                { id: 'icon-star14', name: 'スター✮', cost: 550, class: 'icon-star14', emoji: '✮' },
                
                // Chess pieces (400-700pt)
                { id: 'icon-queen', name: 'クイーン', cost: 700, class: 'icon-queen', emoji: '♛' },
                { id: 'icon-knight', name: 'ナイト', cost: 550, class: 'icon-knight', emoji: '♞' },
                { id: 'icon-pawn', name: 'ポーン', cost: 400, class: 'icon-pawn', emoji: '♟' },
                { id: 'icon-spade', name: 'スペード', cost: 450, class: 'icon-spade', emoji: '♤' },
                { id: 'icon-club', name: 'クラブ', cost: 450, class: 'icon-club', emoji: '♧' },
                { id: 'icon-king', name: 'キング', cost: 750, class: 'icon-king', emoji: '♚' },
                { id: 'icon-queen2', name: 'クイーン♕', cost: 700, class: 'icon-queen2', emoji: '♕' },
                { id: 'icon-rook', name: 'ルーク', cost: 600, class: 'icon-rook', emoji: '♖' },
                { id: 'icon-rookb', name: 'ルーク♜', cost: 600, class: 'icon-rookb', emoji: '♜' },
                { id: 'icon-bishop', name: 'ビショップ', cost: 550, class: 'icon-bishop', emoji: '♗' },
                { id: 'icon-bishopb', name: 'ビショップ♝', cost: 550, class: 'icon-bishopb', emoji: '♝' },
                
                // Mystical symbols (500-800pt)
                { id: 'icon-ankh', name: 'アンク', cost: 650, class: 'icon-ankh', emoji: '☥' },
                { id: 'icon-mercury', name: '水星', cost: 500, class: 'icon-mercury', emoji: '☿' },
                { id: 'icon-jupiter', name: '木星', cost: 550, class: 'icon-jupiter', emoji: '♃' },
                { id: 'icon-saturn', name: '土星', cost: 600, class: 'icon-saturn', emoji: '♄' },
                { id: 'icon-uranus', name: '天王星', cost: 650, class: 'icon-uranus', emoji: '♅' },
                { id: 'icon-neptune', name: '海王星', cost: 700, class: 'icon-neptune', emoji: '♆' },
                { id: 'icon-pluto', name: '冥王星', cost: 750, class: 'icon-pluto', emoji: '♇' },
                { id: 'icon-sun', name: '太陽', cost: 800, class: 'icon-sun', emoji: '☼' },
                { id: 'icon-moon2', name: '月☽', cost: 400, class: 'icon-moon2', emoji: '☽' },
                { id: 'icon-constellation', name: '星座', cost: 450, class: 'icon-constellation', emoji: '☾' },
                { id: 'icon-cross3', name: '十字✞', cost: 500, class: 'icon-cross3', emoji: '✞' },
                { id: 'icon-cross4', name: '十字✟', cost: 550, class: 'icon-cross4', emoji: '✟' },
            ],
            // ガチャ限定アイコン (入手不可能)
            exclusiveIcons: [
                // Ultra Rare アイコン
                { id: 'icon-shield', name: '盾', class: 'icon-shield', emoji: '🛡️', rarity: 'ultra-rare', type: 'icon' },
                { id: 'icon-dragon-face', name: 'ドラゴン', class: 'icon-dragon-face', emoji: '🐲', rarity: 'ultra-rare', type: 'icon' },
                { id: 'icon-parrot', name: 'オウム', class: 'icon-parrot', emoji: '🦜', rarity: 'ultra-rare', type: 'icon' },
                { id: 'icon-detective', name: '探偵', class: 'icon-detective', emoji: '🕴️', rarity: 'ultra-rare', type: 'icon' },
                { id: 'icon-lightning', name: '雷', class: 'icon-lightning', emoji: '⚡', rarity: 'ultra-rare', type: 'icon' },
                { id: 'icon-ice-cube', name: '氷', class: 'icon-ice-cube', emoji: '🧊', rarity: 'ultra-rare', type: 'icon' },
                { id: 'icon-ogre', name: '鬼', class: 'icon-ogre', emoji: '👺', rarity: 'ultra-rare', type: 'icon' },
                { id: 'icon-ambulance', name: '救急車', class: 'icon-ambulance', emoji: '🚑', rarity: 'ultra-rare', type: 'icon' },
                { id: 'icon-cherry-blossom', name: '桜', class: 'icon-cherry-blossom', emoji: '🌸', rarity: 'ultra-rare', type: 'icon' },
                { id: 'icon-angel-face', name: '天使', class: 'icon-angel-face', emoji: '😇', rarity: 'ultra-rare', type: 'icon' },
                { id: 'icon-rabbit', name: 'うさぎ', class: 'icon-rabbit', emoji: '🐰', rarity: 'ultra-rare', type: 'icon' },
                { id: 'icon-fairy', name: '妖精', class: 'icon-fairy', emoji: '🧚', rarity: 'ultra-rare', type: 'icon' },
                { id: 'icon-blue-heart', name: '青いハート', class: 'icon-blue-heart', emoji: '💙', rarity: 'ultra-rare', type: 'icon' },
                { id: 'icon-princess', name: 'プリンセス', class: 'icon-princess', emoji: '👸', rarity: 'ultra-rare', type: 'icon' },
                { id: 'icon-cat-face', name: 'ネコ', class: 'icon-cat-face', emoji: '🐱', rarity: 'ultra-rare', type: 'icon' },
                { id: 'icon-hibiscus', name: 'ハイビスカス', class: 'icon-hibiscus', emoji: '🌺', rarity: 'ultra-rare', type: 'icon' },

                // Legendary アイコン
                { id: 'icon-cyclone', name: 'サイクロン', class: 'icon-cyclone', emoji: '🌀', rarity: 'legendary', type: 'icon' },
                { id: 'icon-milky-way', name: '天の川', class: 'icon-milky-way', emoji: '🌌', rarity: 'legendary', type: 'icon' },
                { id: 'icon-flamingo', name: 'フラミンゴ', class: 'icon-flamingo', emoji: '🦩', rarity: 'legendary', type: 'icon' },
                { id: 'icon-crocodile', name: 'ワニ', class: 'icon-crocodile', emoji: '🐊', rarity: 'legendary', type: 'icon' },
                { id: 'icon-butterfly-ex', name: '蝶', class: 'icon-butterfly-ex', emoji: '🦋', rarity: 'legendary', type: 'icon' },
                { id: 'icon-sparkle-heart', name: 'キラキラハート', class: 'icon-sparkle-heart', emoji: '💖', rarity: 'legendary', type: 'icon' }
            ]
        };
        
        // ガチャシステムの定義
        const GACHA_COST = 100; // ガチャ1回のコスト
        const GACHA_10X_COST = 1000; // 11連ガチャのコスト（1回分おまけ）

        // ガチャの排出率設定
        const GACHA_RATES = {
            common: 60,      // 60% - 安いアイテム (50-200pt)
            uncommon: 25,    // 25% - 中価格アイテム (250-500pt)
            rare: 10,        // 10% - 高価格アイテム (600-1000pt)
            ultraRare: 4,    // 4% - ウルトラレア（ガチャ限定）
            legendary: 1     // 1% - レジェンダリー（ガチャ限定）
        };

        // Update registration streak
        const updateRegistrationStreak = () => {
            const streakData = gamificationData.registrationStreak;
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            
            const streakEl = document.getElementById('streak-count');
            const progressEl = document.getElementById('streak-progress');
            const messageEl = document.getElementById('streak-message');
            const badgeEl = document.getElementById('streak-badge');
            
            if (!streakEl) return;
            
            // Update streak display
            streakEl.textContent = streakData.count;
            
            // Calculate progress to next milestone (every 7 days)
            const progressPercent = ((streakData.count % 7) / 7) * 100;
            if (progressEl) progressEl.style.width = `${progressPercent}%`;
            
            // Set streak badge
            if (badgeEl) {
                if (streakData.count >= 30) badgeEl.textContent = '🔥';
                else if (streakData.count >= 14) badgeEl.textContent = '⭐';
                else if (streakData.count >= 7) badgeEl.textContent = '✨';
                else if (streakData.count >= 3) badgeEl.textContent = '👍';
                else badgeEl.textContent = '';
            }
            
            // Set message
            if (messageEl) {
                if (streakData.count === 0) {
                    messageEl.textContent = '今日から始めましょう！';
                } else if (streakData.count % 7 === 0) {
                    messageEl.textContent = `${streakData.count / 7}週間達成！素晴らしい！`;
                } else {
                    const nextMilestone = Math.ceil(streakData.count / 7) * 7;
                    messageEl.textContent = `次の目標まであと${nextMilestone - streakData.count}日`;
                }
            }
        };
        
        // Update today's stats
        const updateTodayStats = () => {
            const today = new Date().toDateString();
            
            // Load today's additions from gamificationData
            let todayAdditions = gamificationData.todayAdditions;
            
            // Reset if it's a new day
            if (todayAdditions.date !== today) {
                todayAdditions = {
                    date: today,
                    count: 0
                };
                gamificationData.todayAdditions = todayAdditions;
                saveGamificationData();
            }
            
            const todayAddedEl = document.getElementById('today-added');
            if (todayAddedEl) todayAddedEl.textContent = todayAdditions.count;
            
            // Load and update weekly goal
            let weeklyGoalData = gamificationData.weeklyGoalData;
            const weekStart = getWeekStart();
            
            // Reset if it's a new week
            if (weeklyGoalData.weekStart !== weekStart) {
                weeklyGoalData = {
                    weekStart: weekStart,
                    count: 0,
                    goal: 50
                };
                gamificationData.weeklyGoalData = weeklyGoalData;
                saveGamificationData();
            }
            
            const weekProgress = Math.min(100, Math.round((weeklyGoalData.count / weeklyGoalData.goal) * 100));
            const weekGoalEl = document.getElementById('week-goal-progress');
            if (weekGoalEl) weekGoalEl.textContent = `${weekProgress}%`;
            const weekGoalTargetEl = document.getElementById('week-goal-target');
            if (weekGoalTargetEl) weekGoalTargetEl.textContent = weeklyGoalData.goal;
            
        };
        
        // Get start of current week (Monday)
        const getWeekStart = () => {
            const date = new Date();
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            date.setDate(diff);
            return date.toDateString();
        };
        
        // Update points display
        const updatePointsDisplay = () => {
            const pointsEl = document.getElementById('user-points');
            const shopPointsEl = document.getElementById('shop-current-points');
            if (pointsEl) pointsEl.textContent = gamificationData.userPoints.toLocaleString();
            if (shopPointsEl) shopPointsEl.textContent = gamificationData.userPoints.toLocaleString();
        };
        
        // Add points with animation
        const addPoints = (amount, reason) => {
            gamificationData.userPoints += amount;
            
            // Track total points earned
            if (!gamificationData.profile) {
                gamificationData.profile = {
                    nickname: '',
                    icon: '👤',
                    firstUseDate: null,
                    lastUseDate: null,
                    usageDays: new Set(),
                    maxStreak: 0,
                    totalPointsEarned: 0
                };
            }
            gamificationData.profile.totalPointsEarned = (gamificationData.profile.totalPointsEarned || 0) + amount;
            
            saveGamificationData();
            updatePointsDisplay();
            
            // Show point animation
            const animation = document.createElement('div');
            animation.className = 'point-animation';
            animation.textContent = `+${amount} pt`;
            animation.style.left = '50%';
            animation.style.top = '50%';
            document.body.appendChild(animation);
            
            setTimeout(() => animation.remove(), 1000);
            
            // Show notification
            if (reason) {
                const notification = document.createElement('div');
                notification.className = 'position-fixed bottom-0 end-0 p-3';
                notification.style.zIndex = '9999';
                notification.innerHTML = `
                    <div class="toast show" role="alert">
                        <div class="toast-body">
                            <i class="bi bi-coin text-warning me-2"></i>
                            <strong>+${amount} pt</strong> ${reason}
                        </div>
                    </div>
                `;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
            }
        };
        
        // Initialize shop
        const initializeShop = () => {
            // Display exclusive icons in gacha info with ownership status
            const exclusiveIconsDisplay = document.getElementById('exclusive-icons-display');
            if (exclusiveIconsDisplay) {
                let html = '<h6><span class="badge bg-warning">Ultra Rare (4%)</span></h6><div class="row g-2 mb-3">';

                SHOP_ITEMS.exclusiveIcons.filter(i => i.rarity === 'ultra-rare').forEach(icon => {
                    const isOwned = gamificationData.purchasedItems[icon.id];
                    html += `
                        <div class="col-4 col-md-3 text-center">
                            <div class="card ${isOwned ? 'border-success' : ''}" style="${!isOwned ? 'opacity: 0.5;' : ''}">
                                <div class="card-body p-2">
                                    <div style="font-size: 2rem;">${icon.emoji}</div>
                                    <small>${icon.name}</small>
                                    ${isOwned ? '<div><span class="badge bg-success" style="font-size: 0.6rem;">所持</span></div>' : '<div><span class="badge bg-secondary" style="font-size: 0.6rem;">未所持</span></div>'}
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div><h6><span class="badge bg-danger">Legendary (1%)</span></h6><div class="row g-2">';

                SHOP_ITEMS.exclusiveIcons.filter(i => i.rarity === 'legendary').forEach(icon => {
                    const isOwned = gamificationData.purchasedItems[icon.id];
                    html += `
                        <div class="col-4 col-md-3 text-center">
                            <div class="card ${isOwned ? 'border-success' : ''}" style="background: linear-gradient(135deg, #ffd700, #ff6347); ${!isOwned ? 'opacity: 0.5;' : ''}">
                                <div class="card-body p-2 text-white">
                                    <div style="font-size: 2rem;">${icon.emoji}</div>
                                    <small>${icon.name}</small>
                                    ${isOwned ? '<div><span class="badge bg-success" style="font-size: 0.6rem;">所持</span></div>' : '<div><span class="badge bg-dark" style="font-size: 0.6rem;">未所持</span></div>'}
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                exclusiveIconsDisplay.innerHTML = html;
            }

            // Populate icons
            const iconContainer = document.getElementById('icon-shop-items');
            if (iconContainer) {
                iconContainer.innerHTML = '';
                SHOP_ITEMS.icons.forEach(icon => {
                    const isPurchased = gamificationData.purchasedItems[icon.id];
                    
                    const itemEl = document.createElement('div');
                    itemEl.className = 'col-md-6';
                    itemEl.innerHTML = `
                        <div class="card shop-item ${isPurchased ? 'purchased' : ''} ${!isPurchased && gamificationData.userPoints < icon.cost ? 'locked' : ''}">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="fs-2 me-2">${icon.emoji}</span>
                                    <h6 class="mb-0">${icon.name}</h6>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-warning">${icon.cost} pt</span>
                                    ${isPurchased ? 
                                        '<span class="badge bg-success">購入済み</span>' :
                                        `<button class="btn btn-sm btn-warning" onclick="purchaseItem('${icon.id}', ${icon.cost}, 'icon')">購入</button>`
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                    iconContainer.appendChild(itemEl);
                });
            }
            
        };
        
        // Purchase item
        // Toggle daily challenges visibility
        // Show weekly goal setting dialog
        window.showWeeklyGoalSetting = () => {
            const currentGoal = gamificationData.weeklyGoalData.goal || 50;
            const newGoal = prompt(`週間目標を設定してください (現在: ${currentGoal}枚)\n\n何枚のカードを週に追加したいですか？`, currentGoal);

            if (newGoal !== null) {
                const goalNumber = parseInt(newGoal, 10);
                if (!isNaN(goalNumber) && goalNumber > 0 && goalNumber <= 1000) {
                    gamificationData.weeklyGoalData.goal = goalNumber;
                    saveGamificationData();
                    updateTodayStats();
                    alert(`週間目標を${goalNumber}枚に設定しました！`);
                } else {
                    alert('有効な数値を入力してください（1〜1000）');
                }
            }
        };

        // Undo recent card addition
        window.undoRecentAddition = async (name, setCode, rarity, quantity, listType, timestamp) => {
            if (!confirm(`「${name}」の追加を取り消しますか？\n\n注意: この操作により、該当するカードがリストから削除されます。`)) {
                return;
            }

            showLoading(true);
            try {
                const collection = listType === 'wishlist' ? wishlistCollection : cardCollection;
                const collRef = getCollectionRef(listType);

                // Find the matching card(s) to remove
                let removedCount = 0;
                const cardsToRemove = [];

                // Find cards that match the criteria
                for (const card of collection) {
                    if (card.data['名前'] === name &&
                        (!setCode || card.data['型番'] === setCode) &&
                        (!rarity || card.data['レアリティ'] === rarity)) {

                        const cardQuantity = parseInt(card.data['枚数']) || 0;

                        if (cardQuantity > quantity) {
                            // Reduce quantity
                            card.data['枚数'] = cardQuantity - quantity;

                            if (collRef) {
                                await updateDoc(doc(collRef, card.id), { '枚数': card.data['枚数'], updatedAt: Date.now() });
                            }
                            removedCount = quantity;
                            break;
                        } else if (cardQuantity === quantity) {
                            // Remove the card entirely
                            cardsToRemove.push(card);
                            removedCount = quantity;
                            break;
                        } else {
                            // Card has less quantity than we're trying to remove
                            cardsToRemove.push(card);
                            removedCount += cardQuantity;
                            quantity -= cardQuantity;

                            if (removedCount >= quantity) {
                                break;
                            }
                        }
                    }
                }

                // Remove cards that need to be deleted
                for (const card of cardsToRemove) {
                    if (collRef) {
                        await deleteDoc(doc(collRef, card.id));
                        await trackDeletedId(card.id, currentListType === 'collection' ? 'cards' : 'wishlist');
                    }

                    // Remove from local collection
                    const index = collection.indexOf(card);
                    if (index > -1) {
                        collection.splice(index, 1);
                    }
                }

                // Update recent history in localStorage
                let recentHistory = [];
                const recentCardsHistory = localStorage.getItem('recentCardsHistory');
                if (recentCardsHistory) {
                    try {
                        recentHistory = JSON.parse(recentCardsHistory);
                        // Remove the item from history
                        recentHistory = recentHistory.filter(item =>
                            !(item.timestamp === timestamp &&
                              item.name === name &&
                              item.listType === listType));
                        localStorage.setItem('recentCardsHistory', JSON.stringify(recentHistory));
                        
                        // Save to Firebase for logged-in users
                        if (currentUser && currentUser.uid !== 'local_user') {
                            gamificationData.recentCardsHistory = recentHistory;
                            saveGamificationData();
                        }
                    } catch(e) {
                        console.error('Error updating recent history:', e);
                    }
                }

                // Save to localStorage if local user
                if (!currentUser || currentUser.uid === 'local_user') {
                    if (listType === 'wishlist') {
                        localStorage.setItem('wishlistCollection', JSON.stringify(wishlistCollection.map(c => c.data)));
                    } else {
                        localStorage.setItem('cardCollection', JSON.stringify(cardCollection.map(c => c.data)));
                    }
                }

                // Refresh the display
                updateTotalCounts();
                applySearchAndFilter();

                // Refresh analysis modal if it's open
                const analysisModal = bootstrap.Modal.getInstance(document.getElementById('analysis-modal'));
                if (analysisModal && analysisModal._isShown) {
                    updateAnalysisData();
                }

                showLoading(false);
                alert(`「${name}」の追加を取り消しました（${removedCount}枚削除）`);

            } catch (error) {
                showLoading(false);
                console.error('Error undoing addition:', error);
                alert('取り消し中にエラーが発生しました: ' + error.message);
            }
        };

        window.purchaseItem = (itemId, cost, type) => {
            if (gamificationData.userPoints < cost) {
                alert('ポイントが足りません！');
                return;
            }
            
            if (confirm(`${cost}ptを使って購入しますか？`)) {
                gamificationData.userPoints -= cost;
                
                if (type === 'theme' || type === 'frame' || type === 'background' || type === 'icon' || type === 'effect') {
                    gamificationData.purchasedItems[itemId] = true;
                    saveGamificationData();
                    
                    // Apply effect immediately if it's an effect
                    if (type === 'effect') {
                        document.body.classList.add(itemId);
                    }
                }
                
                updatePointsDisplay();
                initializeShop();
                alert('購入しました！');
            }
        };

        // メール確認メールを再送信
        window.resendVerificationEmail = async () => {
            if (currentUser && !currentUser.emailVerified) {
                try {
                    await sendEmailVerification(currentUser);
                    alert('確認メールを再送信しました！\n\n【確認事項】\n✅ 受信ボックスを確認\n✅ 迷惑メールフォルダを確認\n✅ プロモーション/ソーシャルフォルダも確認\n\n送信元: noreply@ygoh-9bcf6.firebaseapp.com\n\n※リンクの有効期限は1時間です');
                } catch (error) {
                    if (error.code === 'auth/too-many-requests') {
                        alert('送信回数の上限に達しました。しばらく待ってから再度お試しください。');
                    } else {
                        alert('メール送信に失敗しました: ' + error.message);
                    }
                }
            }
        };

        // ガチャシステムの実装
        window.drawGacha = async (count) => {
            const cost = count === 1 ? GACHA_COST : GACHA_10X_COST;

            if (gamificationData.userPoints < cost) {
                alert('ポイントが足りません！');
                return;
            }

            if (!confirm(`${cost}ptを使って${count}回ガチャを引きますか？`)) {
                return;
            }

            // ポイントを減らす
            gamificationData.userPoints -= cost;
            saveGamificationData();
            updatePointsDisplay();

            // ガチャ結果モーダルを表示
            const gachaResultModal = new bootstrap.Modal(document.getElementById('gacha-result-modal'));
            gachaResultModal.show();

            // アニメーションを表示
            const animationEl = document.getElementById('gacha-animation');
            const resultsEl = document.getElementById('gacha-results');
            const closeBtn = document.getElementById('gacha-close-btn');

            // アニメーションを表示状態にリセット
            animationEl.style.display = 'block';
            animationEl.innerHTML = '<div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status"></div><h3 class="mt-3">ガチャを回しています...</h3>';
            resultsEl.style.display = 'none';
            closeBtn.style.display = 'none';

            // ガチャを引く
            const results = [];
            for (let i = 0; i < count; i++) {
                results.push(performGachaDraw());
            }

            // アニメーション後に結果を表示
            setTimeout(() => {
                animationEl.style.display = 'none';
                resultsEl.style.display = 'block';
                closeBtn.style.display = 'inline-block';

                let resultsHTML = '<h3>ガチャ結果</h3><div class="row g-2">';
                let hasNewItem = false;
                let duplicatePoints = 0;

                // 重複アイテムのポイント変換率
                const duplicateConversion = {
                    'common': 10,
                    'uncommon': 15,
                    'rare': 20,
                    'ultra-rare': 0,  // Ultra Rareは重複してもポイント変換なし（そのまま獲得）
                    'legendary': 0     // Legendaryも重複してもポイント変換なし（そのまま獲得）
                };

                results.forEach(result => {
                    const isNew = !gamificationData.purchasedItems[result.id];
                    let convertedToPoints = false;
                    let pointsAwarded = 0;

                    if (isNew) {
                        hasNewItem = true;
                        gamificationData.purchasedItems[result.id] = true;
                    } else if (duplicateConversion[result.rarity] > 0) {
                        // 通常レアリティの重複アイテムはポイントに変換
                        convertedToPoints = true;
                        pointsAwarded = duplicateConversion[result.rarity];
                        duplicatePoints += pointsAwarded;
                    }

                    const rarityBadge = getRarityBadge(result.rarity);

                    // 絵文字を設定
                    const displayEmoji = result.emoji || '🎆';

                    // 特殊レアリティの場合のテキスト色
                    const textColorClass = (result.rarity === 'legendary' || result.rarity === 'ultra-rare') ? 'text-white' : '';

                    resultsHTML += `
                        <div class="col-6 col-md-4">
                            <div class="card ${convertedToPoints ? 'border-info' : ''}" style="${result.rarity === 'legendary' ? 'background: linear-gradient(135deg, #ffd700, #ff6347);' : result.rarity === 'ultra-rare' ? 'background: linear-gradient(135deg, #f093fb, #f5576c);' : ''}">
                                <div class="card-body text-center p-2 ${textColorClass}">
                                    ${convertedToPoints ? `<span class="badge bg-info position-absolute top-0 start-0">+${pointsAwarded}pt</span>` : ''}
                                    <div style="font-size: 2rem;">${displayEmoji}</div>
                                    <small class="d-block">${result.name}</small>
                                    ${rarityBadge}
                                    ${convertedToPoints ? '<small class="d-block mt-1" style="opacity: 0.8;">重複→ポイント変換</small>' : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });

                resultsHTML += '</div>';

                if (hasNewItem) {
                    resultsHTML += '<div class="alert alert-success mt-3"><i class="bi bi-check-circle"></i> 新しいアイコンを獲得しました！</div>';
                }

                if (duplicatePoints > 0) {
                    // 重複ポイントを追加
                    gamificationData.userPoints += duplicatePoints;
                    resultsHTML += `<div class="alert alert-info mt-3"><i class="bi bi-coin"></i> 重複アイコンが <strong>${duplicatePoints}pt</strong> に変換されました！</div>`;
                }

                // データを保存
                saveGamificationData();
                updatePointsDisplay();

                resultsEl.innerHTML = resultsHTML;
            }, 2000);
        };

        // ガチャを実行
        const performGachaDraw = () => {
            const random = Math.random() * 100;
            let accumulated = 0;
            let rarity = 'common';

            // レアリティを決定
            if (random < GACHA_RATES.legendary) {
                rarity = 'legendary';
            } else if (random < GACHA_RATES.legendary + GACHA_RATES.ultraRare) {
                rarity = 'ultra-rare';
            } else if (random < GACHA_RATES.legendary + GACHA_RATES.ultraRare + GACHA_RATES.rare) {
                rarity = 'rare';
            } else if (random < GACHA_RATES.legendary + GACHA_RATES.ultraRare + GACHA_RATES.rare + GACHA_RATES.uncommon) {
                rarity = 'uncommon';
            } else {
                rarity = 'common';
            }

            // レアリティに基づいてアイテムを選択
            let item;
            if (rarity === 'legendary' || rarity === 'ultra-rare') {
                // ガチャ限定アイコンから選択
                const exclusiveItems = SHOP_ITEMS.exclusiveIcons.filter(i => i.rarity === rarity);
                item = exclusiveItems[Math.floor(Math.random() * exclusiveItems.length)];
            } else {
                // 通常アイコンから選択
                const costRange = {
                    common: [50, 200],
                    uncommon: [250, 500],
                    rare: [600, 800]
                };

                const range = costRange[rarity];
                const filteredIcons = SHOP_ITEMS.icons.filter(i => i.cost >= range[0] && i.cost <= range[1]);
                const selectedIcon = filteredIcons[Math.floor(Math.random() * filteredIcons.length)];
                item = {...selectedIcon, type: 'icon', rarity};
            }

            return item;
        };

        // レアリティバッジを取得
        const getRarityBadge = (rarity) => {
            switch(rarity) {
                case 'legendary':
                    return '<span class="badge bg-danger">レジェンダリー</span>';
                case 'ultra-rare':
                    return '<span class="badge bg-warning">ウルトラレア</span>';
                case 'rare':
                    return '<span class="badge bg-success">レア</span>';
                case 'uncommon':
                    return '<span class="badge bg-primary">アンコモン</span>';
                default:
                    return '<span class="badge bg-secondary">コモン</span>';
            }
        };

        // ガチャ結果モーダルを閉じる
        window.closeGachaResult = () => {
            const modal = bootstrap.Modal.getInstance(document.getElementById('gacha-result-modal'));
            if (modal) {
                modal.hide();
            }
            initializeShop();
        };

        // Apply icon
        window.applyIcon = (iconClass) => {
            // Remove all icon classes
            const allIconClasses = SHOP_ITEMS.icons.map(i => i.class);
            document.body.classList.remove(...allIconClasses);
            
            if (iconClass && iconClass !== 'none') {
                document.body.classList.add(iconClass);
            }
            
            gamificationData.activeIcon = iconClass;
            saveGamificationData();
            initializeShop();
        };
        
        // Apply effect (effects are permanent once purchased)
        window.applyEffect = (effectId) => {
            if (gamificationData.purchasedItems[effectId]) {
                document.body.classList.add(effectId);
            }
        };
        
        // Show notification function
        const showNotification = (message, type = 'info') => {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} position-fixed top-0 start-50 translate-middle-x mt-3`;
            notification.style.zIndex = '9999';
            notification.style.minWidth = '300px';
            notification.textContent = message;
            
            // Add to body
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        };

        // Initialize fun dashboard
        const initializeFunDashboard = () => {
            updateRegistrationStreak();
            updateTodayStats();
            updatePointsDisplay();
        };
        
        // Track when card is added
        const trackCardAddition = (cardData, hasTag, isRare) => {
            const today = new Date().toDateString();
            const cardCount = cardData.枚数 || 1;

            // Update today's additions
            if (gamificationData.todayAdditions.date !== today) {
                gamificationData.todayAdditions = { date: today, count: 0 };
            }
            gamificationData.todayAdditions.count += cardCount;
            
            // Update weekly goal
            const weekStart = getWeekStart();
            if (gamificationData.weeklyGoalData.weekStart !== weekStart) {
                gamificationData.weeklyGoalData = { weekStart: weekStart, count: 0, goal: 50 };
            }
            gamificationData.weeklyGoalData.count += cardCount;
            
            // Update registration streak
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            
            if (gamificationData.registrationStreak.lastDate === today) {
                // Already added today, no change
            } else if (gamificationData.registrationStreak.lastDate === yesterday) {
                // Continue streak
                gamificationData.registrationStreak.count++;
                gamificationData.registrationStreak.lastDate = today;
            } else {
                // Start new streak
                gamificationData.registrationStreak.count = 1;
                gamificationData.registrationStreak.lastDate = today;
            }
            
            saveGamificationData();

            // Update displays
            updateRegistrationStreak();
            updateTodayStats();
        };
        
        // Reset first login bonus (for testing or special cases)
        window.resetFirstLoginBonus = async () => {
            gamificationData.hasReceivedFirstLoginBonus = false;
            await saveGamificationData();
            console.log('初回ログインボーナスをリセットしました。次回ログイン時に再度受け取れます。');
        };
        
        // Check and grant first login bonus
        const checkFirstLoginBonus = (user) => {
            // Check if user has already received the bonus (using Firebase data)
            if (!gamificationData.hasReceivedFirstLoginBonus) {
                // First time login - grant 50 points
                addPoints(50, '初回ログインボーナス！');
                
                // Mark as received in Firebase
                gamificationData.hasReceivedFirstLoginBonus = true;
                saveGamificationData();
                
                // Check if user already has cards and grant retroactive points
                setTimeout(() => {
                    let totalCards = 0;
                    cardCollection.forEach(card => {
                        totalCards += card.data.枚数 || 0;
                    });
                    
                    if (totalCards > 0) {
                        const retroactivePoints = totalCards * 5;
                        addPoints(retroactivePoints, `既存カード ${totalCards}枚分のポイント`);
                        
                        // Show special notification
                        const notification = document.createElement('div');
                        notification.className = 'position-fixed top-50 start-50 translate-middle';
                        notification.style.zIndex = '10000';
                        notification.innerHTML = `
                            <div class="card shadow-lg border-warning" style="min-width: 300px;">
                                <div class="card-body text-center">
                                    <h5 class="card-title text-warning">
                                        <i class="bi bi-gift-fill"></i> 特別ボーナス！
                                    </h5>
                                    <p class="card-text">
                                        初回ログインボーナス: 50pt<br>
                                        既存カードボーナス: ${retroactivePoints}pt<br>
                                        <strong>合計: ${50 + retroactivePoints}pt 獲得！</strong>
                                    </p>
                                    <button class="btn btn-warning" onclick="this.closest('.position-fixed').remove()">
                                        ありがとう！
                                    </button>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(notification);
                    } else {
                        // Show welcome notification for new users
                        const notification = document.createElement('div');
                        notification.className = 'position-fixed top-50 start-50 translate-middle';
                        notification.style.zIndex = '10000';
                        notification.innerHTML = `
                            <div class="card shadow-lg border-success" style="min-width: 300px;">
                                <div class="card-body text-center">
                                    <h5 class="card-title text-success">
                                        <i class="bi bi-star-fill"></i> ようこそ！
                                    </h5>
                                    <p class="card-text">
                                        初回ログインボーナスとして<br>
                                        <strong>50ポイント</strong>をプレゼント！
                                    </p>
                                    <button class="btn btn-success" onclick="this.closest('.position-fixed').remove()">
                                        始める！
                                    </button>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(notification);
                    }
                }, 1000); // Wait for cards to load
            }
        };
        
        const updateCollectionStats = () => {
            // Check if stats should be hidden
            const hideStats = localStorage.getItem('hideStats') === 'true';
            const statsDiv = document.getElementById('stats-dashboard');
            if (hideStats) {
                statsDiv.style.display = 'none';
                return;
            } else {
                statsDiv.style.display = 'block';
            }
            
            const totalCards = cardCollection.reduce((sum, card) => sum + (card.data['枚数'] || 0), 0);
            const uniqueCards = cardCollection.length;
            
            // Set first collection date if not set
            if (totalCards > 0 && !gamificationData.firstCollectionDate) {
                gamificationData.firstCollectionDate = new Date().toISOString();
                saveGamificationData();
            }
            
            // Calculate collection days
            const collectionDays = gamificationData.firstCollectionDate ? 
                Math.floor((new Date() - new Date(gamificationData.firstCollectionDate)) / (1000 * 60 * 60 * 24)) + 1 : 0;
            
            // Calculate cards added this week
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            let recentCards = 0;
            
            Object.entries(gamificationData.cardAdditionDates || {}).forEach(([cardId, dateAdded]) => {
                // Skip invalid entries (e.g., heatmap data that was incorrectly stored here)
                if (typeof dateAdded !== 'string' || !dateAdded.includes('T')) return;

                if (new Date(dateAdded) >= oneWeekAgo) {
                    const card = cardCollection.find(c => c.id === cardId);
                    if (card) {
                        recentCards += card.data['枚数'] || 0;
                    }
                }
            });
            
            // Build rarity distribution
            let rarityDistribution = {};
            
            cardCollection.forEach(card => {
                const rarity = card.data['レアリティ'] || 'N';
                const quantity = card.data['枚数'] || 0;
                
                if (!rarityDistribution[rarity]) {
                    rarityDistribution[rarity] = 0;
                }
                rarityDistribution[rarity] += quantity;
            });
            
            // Update display
            document.getElementById('total-cards').textContent = totalCards.toLocaleString();
            document.getElementById('unique-cards').textContent = uniqueCards.toLocaleString();
            document.getElementById('collection-days').textContent = collectionDays.toLocaleString();
            document.getElementById('recent-cards').textContent = recentCards.toLocaleString();
            
            // Update collector rank
            updateCollectorRank(totalCards);
            
            // Update milestone progress
            updateMilestoneProgress(totalCards);
            
            // Update achievements
            updateAchievements(totalCards, uniqueCards, collectionDays, rarityDistribution);
            
            // Update rarity chart
            updateRarityChart(rarityDistribution, totalCards);
            
            // Check for new milestones
            checkMilestone(totalCards);
        };
        
        const updateCollectorRank = (totalCards) => {
            const rankEl = document.getElementById('collector-rank');
            let rank = '';
            let rankClass = '';
            let rankStyle = '';
            
            if (totalCards >= 100000) {
                rank = '創世神';
                rankClass = 'badge ms-2';
                rankStyle = 'background: linear-gradient(45deg, #ff00ff, #00ffff, #ffff00, #ff00ff); background-size: 400% 400%; animation: rainbow 3s ease infinite; color: white; font-weight: bold;';
            } else if (totalCards >= 50000) {
                rank = '神話';
                rankClass = 'badge ms-2';
                rankStyle = 'background: linear-gradient(45deg, #ffd700, #ff6b6b, #ffd700); animation: shine 2s infinite; color: white;';
            } else if (totalCards >= 25000) {
                rank = '天帝';
                rankClass = 'badge ms-2';
                rankStyle = 'background: linear-gradient(45deg, #b9f2ff, #00d4ff); animation: sparkle 2s infinite; color: white;';
            } else if (totalCards >= 10000) {
                rank = '覇王';
                rankClass = 'badge ms-2';
                rankStyle = 'background: linear-gradient(45deg, #845ef7, #5c7cfa); color: white;';
            } else if (totalCards >= 5000) {
                rank = '英雄';
                rankClass = 'badge ms-2';
                rankStyle = 'background: linear-gradient(45deg, #ff6b6b, #ffd43b); color: white;';
            } else if (totalCards >= 2500) {
                rank = '賢者';
                rankClass = 'badge ms-2';
                rankStyle = 'background: linear-gradient(45deg, #51cf66, #12b886); color: white;';
            } else if (totalCards >= 1000) {
                rank = '伝説';
                rankClass = 'bg-danger';
            } else if (totalCards >= 500) {
                rank = 'マスター';
                rankClass = 'bg-warning';
            } else if (totalCards >= 300) {
                rank = 'エキスパート';
                rankClass = 'bg-info';
            } else if (totalCards >= 100) {
                rank = '上級';
                rankClass = 'bg-success';
            } else if (totalCards >= 50) {
                rank = '中級';
                rankClass = 'bg-primary';
            } else if (totalCards >= 10) {
                rank = '初級';
                rankClass = 'bg-secondary';
            } else {
                rank = '見習い';
                rankClass = 'bg-secondary';
            }
            
            rankEl.textContent = rank;
            rankEl.className = `badge ${rankClass} ms-2`;
            if (rankStyle) {
                rankEl.style = rankStyle;
            } else {
                rankEl.style = '';
            }
        };
        
        const updateMilestoneProgress = (totalCards) => {
            const progressContainer = document.getElementById('milestone-progress');
            const nextMilestone = MILESTONES.find(m => m > totalCards);
            
            if (nextMilestone) {
                const prevMilestone = MILESTONES[MILESTONES.indexOf(nextMilestone) - 1] || 0;
                const progress = ((totalCards - prevMilestone) / (nextMilestone - prevMilestone)) * 100;
                
                document.getElementById('milestone-text').textContent = `${nextMilestone}枚 (残り${nextMilestone - totalCards}枚)`;
                document.getElementById('milestone-bar').style.width = `${progress}%`;
                document.getElementById('milestone-percent').textContent = `${Math.floor(progress)}%`;
                progressContainer.style.display = 'block';
            } else {
                progressContainer.style.display = 'none';
            }
        };
        
        const updateAchievements = (totalCards, uniqueCards, collectionDays, rarityDistribution) => {
            const summaryContainer = document.getElementById('achievement-summary-container');
            const detailsContainer = document.getElementById('achievement-details');
            
            summaryContainer.innerHTML = '';
            detailsContainer.innerHTML = '';
            
            // Calculate special counts
            const rareCount = Object.entries(rarityDistribution)
                .filter(([rarity]) => rarity.toLowerCase().includes('レア') || rarity.toLowerCase().includes('r'))
                .reduce((sum, [, count]) => sum + count, 0);
            
            const srCount = Object.entries(rarityDistribution)
                .filter(([rarity]) => rarity.toUpperCase().includes('SR'))
                .reduce((sum, [, count]) => sum + count, 0);
            
            const urCount = Object.entries(rarityDistribution)
                .filter(([rarity]) => rarity.toUpperCase().includes('UR'))
                .reduce((sum, [, count]) => sum + count, 0);
            
            const seCount = Object.entries(rarityDistribution)
                .filter(([rarity]) => rarity.toUpperCase().includes('SE'))
                .reduce((sum, [, count]) => sum + count, 0);
            
            const premiumCount = Object.entries(rarityDistribution)
                .filter(([rarity]) => rarity.toUpperCase().includes('P'))
                .reduce((sum, [, count]) => sum + count, 0);
            
            const ulCount = Object.entries(rarityDistribution)
                .filter(([rarity]) => rarity.toUpperCase().includes('UL'))
                .reduce((sum, [, count]) => sum + count, 0);
            
            const qcseCount = Object.entries(rarityDistribution)
                .filter(([rarity]) => rarity.toUpperCase().includes('QCSE'))
                .reduce((sum, [, count]) => sum + count, 0);
            
            // Track daily/weekly additions
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const weekAgo = new Date(today - 7 * 24 * 60 * 60 * 1000);
            
            let dailyAdditions = 0;
            let weeklyAdditions = 0;
            Object.entries(gamificationData.cardAdditionDates || {}).forEach(([cardId, dateStr]) => {
                // Skip invalid entries (e.g., heatmap data that was incorrectly stored here)
                if (typeof dateStr !== 'string' || !dateStr.includes('T')) return;

                const date = new Date(dateStr);
                const dateOnly = dateStr.split('T')[0];
                if (dateOnly === todayStr) {
                    const card = cardCollection.find(c => c.id === cardId);
                    if (card) dailyAdditions += card.data['枚数'] || 0;
                }
                if (date >= weekAgo) {
                    const card = cardCollection.find(c => c.id === cardId);
                    if (card) weeklyAdditions += card.data['枚数'] || 0;
                }
            });
            
            // Count tags
            const allTags = new Set();
            cardCollection.forEach(card => {
                if (card.data.tags) {
                    card.data.tags.forEach(tag => allTags.add(tag));
                }
            });
            const tagCount = allTags.size;
            
            // Create summary for each category
            Object.entries(ACHIEVEMENT_CATEGORIES).forEach(([category, achievements]) => {
                const summary = document.createElement('div');
                summary.className = 'achievement-summary';
                
                // Calculate progress for this category
                let unlockedCount = 0;
                achievements.forEach(ach => {
                    let progress = 0;
                    if (ach.type === 'unique') progress = uniqueCards;
                    else if (ach.type === 'days') progress = collectionDays;
                    else if (ach.type === 'rarity') progress = rareCount;
                    else if (ach.type === 'sr') progress = srCount;
                    else if (ach.type === 'ur') progress = urCount;
                    else if (ach.type === 'se') progress = seCount;
                    else if (ach.type === 'premium') progress = premiumCount;
                    else if (ach.type === 'ul') progress = ulCount;
                    else if (ach.type === 'qcse') progress = qcseCount;
                    else if (ach.type === 'daily') progress = dailyAdditions;
                    else if (ach.type === 'weekly') progress = weeklyAdditions;
                    else if (ach.type === 'tags') progress = tagCount;
                    else progress = totalCards;
                    
                    if (progress >= ach.threshold) unlockedCount++;
                });
                
                const totalInCategory = achievements.length;
                const percentage = Math.round((unlockedCount / totalInCategory) * 100);
                
                summary.innerHTML = `
                    <div style="flex: 1;">
                        <strong>${category}</strong>
                        <small class="text-muted ms-2">${unlockedCount}/${totalInCategory} (${percentage}%)</small>
                    </div>
                    <div class="achievement-progress">
                        ${achievements.slice(0, 8).map(ach => {
                            let progress = 0;
                            if (ach.type === 'unique') progress = uniqueCards;
                            else if (ach.type === 'days') progress = collectionDays;
                            else if (ach.type === 'rarity') progress = rareCount;
                            else if (ach.type === 'sr') progress = srCount;
                            else if (ach.type === 'ur') progress = urCount;
                            else if (ach.type === 'se') progress = seCount;
                            else if (ach.type === 'premium') progress = premiumCount;
                            else if (ach.type === 'ul') progress = ulCount;
                            else if (ach.type === 'qcse') progress = qcseCount;
                            else if (ach.type === 'daily') progress = dailyAdditions;
                            else if (ach.type === 'weekly') progress = weeklyAdditions;
                            else if (ach.type === 'tags') progress = tagCount;
                            else progress = totalCards;
                            
                            const unlocked = progress >= ach.threshold;
                            return `<div class="achievement-dot ${unlocked ? 'unlocked' : ''}" title="${ach.desc}"></div>`;
                        }).join('')}
                        ${achievements.length > 8 ? `<small class="text-muted">+${achievements.length - 8}</small>` : ''}
                    </div>
                    <i class="bi bi-chevron-down"></i>
                `;
                
                // Add click handler
                summary.addEventListener('click', () => {
                    const isOpen = detailsContainer.classList.contains('show');
                    
                    if (isOpen && detailsContainer.dataset.category === category) {
                        detailsContainer.classList.remove('show');
                        detailsContainer.innerHTML = '';
                        summary.querySelector('i').className = 'bi bi-chevron-down';
                    } else {
                        // Close other categories
                        document.querySelectorAll('.achievement-summary i').forEach(icon => {
                            icon.className = 'bi bi-chevron-down';
                        });
                        
                        // Show details for this category
                        detailsContainer.innerHTML = `
                            <h6>${category} 実績詳細</h6>
                            <div class="d-flex flex-wrap gap-1">
                                ${achievements.map(ach => {
                                    let progress = 0;
                                    if (ach.type === 'unique') progress = uniqueCards;
                                    else if (ach.type === 'days') progress = collectionDays;
                                    else if (ach.type === 'rarity') progress = rareCount;
                                    else if (ach.type === 'sr') progress = srCount;
                                    else if (ach.type === 'ur') progress = urCount;
                                    else if (ach.type === 'se') progress = seCount;
                                    else if (ach.type === 'premium') progress = premiumCount;
                                    else if (ach.type === 'ul') progress = ulCount;
                                    else if (ach.type === 'qcse') progress = qcseCount;
                                    else if (ach.type === 'daily') progress = dailyAdditions;
                                    else if (ach.type === 'weekly') progress = weeklyAdditions;
                                    else if (ach.type === 'tags') progress = tagCount;
                                    else progress = totalCards;
                                    
                                    const unlocked = progress >= ach.threshold;
                                    return `
                                        <div class="achievement-badge ${unlocked ? ach.class : 'locked'}" 
                                             title="${ach.desc}${unlocked ? ' ✓' : ` (${progress}/${ach.threshold})`}">
                                            ${unlocked ? '🏆' : '🔒'} ${ach.name}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `;
                        detailsContainer.classList.add('show');
                        detailsContainer.dataset.category = category;
                        summary.querySelector('i').className = 'bi bi-chevron-up';
                    }
                });
                
                summaryContainer.appendChild(summary);
            });
        };
        
        const updateRarityChart = (distribution, total) => {
            const container = document.getElementById('rarity-chart-container');
            const barsContainer = document.getElementById('rarity-bars');
            
            if (Object.keys(distribution).length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            barsContainer.innerHTML = '';
            
            // Define rarity order and colors (拡張可能)
            const rarityOrder = ['N', 'NR', 'P', 'R', 'SR', 'P+SR', 'UR', 'P+UR', 'UL', 'GR', 'CR', 'HR', 'SE', 'EXSE', 'GSE', 'PSE', 'QCSE', '20SE', '25SE'];
            const rarityColors = {
                'N': '#868e96',
                'NR': '#95a8b1',
                'P': '#339af0',
                'R': '#51cf66',
                'SR': '#ffd43b',
                'P+SR': '#ff922b',
                'UR': '#ff6b6b',
                'P+UR': '#f06595',
                'UL': '#cc5de8',
                'GR': '#845ef7',
                'CR': '#5c7cfa',
                'HR': '#4c6ef5',
                'SE': '#748ffc',
                'EXSE': '#91a7ff',
                'GSE': '#dbe4ff',
                'PSE': '#e7f5ff',
                'QCSE': '#a5d8ff',
                '20SE': '#b197fc',  // 20周年SE
                '25SE': '#ffa94d',  // 25周年SE
                'default': '#868e96'
            };
            
            // Get max count for percentage calculation
            const maxCount = Math.max(...Object.values(distribution));

            // Track which rarities have been displayed
            const displayedRarities = new Set();

            // Display in defined order (既知のレアリティ)
            rarityOrder.forEach(rarityKey => {
                // Check if this rarity exists in distribution
                Object.entries(distribution).forEach(([rarity, count]) => {
                    if (!displayedRarities.has(rarity) &&
                        (rarity === rarityKey || rarity.toUpperCase() === rarityKey.toUpperCase())) {

                        displayedRarities.add(rarity);
                        const percentage = (count / maxCount) * 100;
                        const color = rarityColors[rarityKey] || rarityColors.default;

                        const bar = document.createElement('div');
                        bar.className = 'rarity-bar';
                        bar.style.setProperty('--bar-height', `${percentage}%`);
                        bar.style.setProperty('--bar-color', color);
                        bar.innerHTML = `
                            <span class="rarity-bar-count">${count}</span>
                            <span class="rarity-bar-label" title="${escapeHtml(rarity)}">${escapeHtml(rarity)}</span>
                        `;
                        barsContainer.appendChild(bar);
                    }
                });
            });
            
            // Add any rarities not in the defined order
            const newRarityColors = [
                '#22b8cf', // シアン
                '#15aabf', // ダークシアン
                '#1098ad', // ディープシアン
                '#0c8599', // ネイビーシアン
                '#94d82d', // ライム
                '#82c91e', // グリーンライム
                '#74b816', // ダークライム
                '#66a80f', // ディープライム
                '#fab005', // ゴールド
                '#fd7e14', // オレンジ
                '#f76707', // ダークオレンジ
                '#e8590c', // ディープオレンジ
            ];
            let newColorIndex = 0;
            const assignedColors = {};  // 新規レアリティの色を記憶

            Object.entries(distribution).forEach(([rarity, count]) => {
                // 既に表示済みのレアリティはスキップ
                if (displayedRarities.has(rarity)) {
                    return;
                }

                if (count > 0) {
                    // 新規レアリティに色を割り当て（一度割り当てたら同じ色を使う）
                    if (!assignedColors[rarity]) {
                        assignedColors[rarity] = newRarityColors[newColorIndex % newRarityColors.length];
                        newColorIndex++;
                    }

                    const percentage = (count / maxCount) * 100;
                    const bar = document.createElement('div');
                    bar.className = 'rarity-bar';
                    bar.style.setProperty('--bar-height', `${percentage}%`);
                    bar.style.setProperty('--bar-color', assignedColors[rarity]);
                    bar.innerHTML = `
                        <span class="rarity-bar-count">${count}</span>
                        <span class="rarity-bar-label" title="${escapeHtml(rarity)}">${escapeHtml(rarity.substring(0, 4))}</span>
                    `;
                    barsContainer.appendChild(bar);

                    // 新規レアリティをコンソールに記録（デバッグ用）
                    console.log(`新規レアリティ検出: ${rarity} (${count}枚)`);
                }
            });
        };
        
        const checkMilestone = (totalCards) => {
            const milestone = MILESTONES.find(m => m === totalCards);
            if (milestone && milestone > gamificationData.lastMilestoneReached) {
                gamificationData.lastMilestoneReached = milestone;
                saveGamificationData();
                showMilestoneNotification(milestone);
            }
        };
        
        const showMilestoneNotification = (milestone) => {
            const notification = document.createElement('div');
            notification.className = 'milestone-notification';
            notification.innerHTML = `
                <div class="alert alert-success shadow-lg">
                    <h5 class="alert-heading">🎉 マイルストーン達成！</h5>
                    <p class="mb-0"><strong>${milestone}枚</strong>のカードを収集しました！</p>
                    <hr>
                    <p class="mb-0 small">素晴らしい成果です！次の目標に向かって頑張りましょう！</p>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        };
        
        // Helper function to normalize text for search
        const normalizeForSearch = (text) => {
            if (!text) return '';

            // Convert to lowercase
            text = text.toLowerCase();

            // Convert katakana to hiragana
            text = text.replace(/[ァ-ヶ]/g, (match) => {
                const code = match.charCodeAt(0) - 0x60;
                return String.fromCharCode(code);
            });

            // Convert full-width alphanumeric to half-width
            text = text.replace(/[Ａ-Ｚａ-ｚ０-９]/g, (match) => {
                return String.fromCharCode(match.charCodeAt(0) - 0xFEE0);
            });

            // Convert full-width space to half-width
            text = text.replace(/　/g, ' ');

            // Remove middle dots (・) for more flexible search
            text = text.replace(/・/g, '');

            return text;
        };

        // Helper for card type matching in search
        const matchCardType = (det, type) => {
            if (type === '魔法') return det.race === '魔法' || det.cardType === '魔法';
            if (type === '罠') return det.race === '罠' || det.cardType === '罠';
            return det.cardType && det.cardType.includes(type);
        };

        const applySearchAndFilter = () => {
            // Get basic search parameters
            const [sN,sC,sR,sT] = ['search_name','search_set_code','search_rarity','search_tags'].map(n=>normalizeForSearch(document.querySelector(`[name="${n}"]`).value));

            // Get search mode (AND/OR)
            const searchMode = document.querySelector('input[name="search_mode"]:checked')?.value || 'and';

            // Get advanced search parameters from buttons
            const sLevel = document.querySelector('.level-btn.active')?.dataset.level || '';
            const sAttribute = document.querySelector('.attribute-btn.active')?.dataset.attribute || '';

            // Get selected races from active race buttons
            const sRaces = Array.from(document.querySelectorAll('.race-btn.active'))
                .map(btn => btn.dataset.race)
                .filter(race => race); // 空の値を除外

            // Get selected card types from active card-type buttons
            const sCardTypes = Array.from(document.querySelectorAll('.card-type-btn.active'))
                .map(btn => btn.dataset.type);

            const sAttack = document.querySelector('[name="search_attack"]')?.value?.trim();
            const sDefense = document.querySelector('[name="search_defense"]')?.value?.trim();

            // Get possible card names from hiragana reading
            let possibleCardNames = [];
            if (sN) {
                // Check if the search term matches any reading in our map
                const searchKey = sN.toLowerCase();
                if (cardReadingMap.has(searchKey)) {
                    possibleCardNames = cardReadingMap.get(searchKey);
                }

                // Also check for partial matches
                for (const [reading, cards] of cardReadingMap) {
                    if (reading.includes(searchKey)) {
                        possibleCardNames.push(...cards);
                    }
                }
            }

            // Helper function to check range values (e.g., "2000-3000" or "2500")
            const checkRange = (value, rangeStr) => {
                // 検索条件がない場合は常にtrue
                if (!rangeStr) return true;

                // カードにデータがない場合（検索条件があるのにカードにデータがない）
                if (value === null || value === undefined || value === '') return false;

                // Handle range (e.g., "2000-3000")
                if (rangeStr.includes('-')) {
                    const [min, max] = rangeStr.split('-').map(v => parseInt(v.trim()));
                    const numValue = parseInt(value);
                    return !isNaN(numValue) && numValue >= min && numValue <= max;
                }

                // Handle single value
                return value.toString() === rangeStr;
            };

            filteredCardCollection = getCurrentCollection().filter(c => {
                const d = c.data;
                const cardName = d['名前'] || '';

                // Check name with both direct match and reading-based match
                let nameMatch = false;
                if (sN) {
                    // Direct match
                    nameMatch = normalizeForSearch(cardName).includes(sN);

                    // Reading-based match
                    if (!nameMatch && possibleCardNames.length > 0) {
                        const normalizedCardName = normalizeForSearch(cardName);
                        for (const possibleName of possibleCardNames) {
                            if (normalizedCardName.includes(normalizeForSearch(possibleName)) ||
                                normalizeForSearch(possibleName).includes(normalizedCardName)) {
                                nameMatch = true;
                                break;
                            }
                        }
                    }
                } else {
                    nameMatch = true;
                }

                // Check against card details from CSV or linked details
                let advancedMatch = true;
                let details = null;

                // Always use cardDetailsMap for latest data (CSV may have been updated)
                if (cardDetailsMap.has(cardName)) {
                    details = cardDetailsMap.get(cardName);
                } else if (d.linkedDetails) {
                    details = d.linkedDetails;
                }

                if (details) {
                    // Check if any advanced search criteria is specified
                    const hasAdvancedCriteria = sLevel || sAttribute || sRaces.length > 0 || sCardTypes.length > 0 || sAttack || sDefense;

                    // Only apply advanced filtering if criteria is specified
                    if (hasAdvancedCriteria) {
                        const results = [];
                        if (sLevel) results.push(checkRange(details.level, sLevel));
                        if (sAttribute) results.push(details.attribute === sAttribute);
                        if (sRaces.length > 0) results.push(sRaces.some(race => race && details.race === race));
                        if (sCardTypes.length > 0) {
                            // OR: いずれかのタイプに一致, AND: すべてのタイプに一致
                            const typeFn = searchMode === 'or' ? 'some' : 'every';
                            results.push(sCardTypes[typeFn](type => matchCardType(details, type)));
                        }
                        if (sAttack) results.push(checkRange(details.attack, sAttack));
                        if (sDefense) results.push(checkRange(details.defense, sDefense));

                        advancedMatch = results.length > 0
                            ? (searchMode === 'or' ? results.some(r => r) : results.every(r => r))
                            : true;
                    }

                } else if (sLevel || sAttribute || sRaces.length > 0 || sCardTypes.length > 0 || sAttack || sDefense) {
                    // If advanced search is used but no details available, don't show it
                    advancedMatch = false;
                }

                return nameMatch &&
                       (!sC || normalizeForSearch(d['型番']||'').includes(sC)) &&
                       (!sR || normalizeForSearch(d['レアリティ']||'').includes(sR)) &&
                       (!sT || normalizeForSearch((d.tags||[]).join(',')).includes(sT)) &&
                       advancedMatch;
            });

            currentPage = 1;
            renderTable();
        };

        const getTagsCollectionRef = () => currentUser?.uid !== 'local_user' ? collection(db, "users", currentUser.uid, "tags") : null;

        const loadAllTags = async () => {
            const tagsCollRef = getTagsCollectionRef();
            if (tagsCollRef) {
                const snapshot = await getDocs(query(tagsCollRef));
                allTags = snapshot.docs.map((doc, index) => ({ 
                    id: doc.id, 
                    name: doc.data().name,
                    order: doc.data().order !== undefined ? doc.data().order : index
                }));
                
                let needsOrderUpdate = false;
                allTags.forEach((tag, index) => {
                    if (tag.order === undefined || tag.order === 999) {
                        tag.order = index;
                        needsOrderUpdate = true;
                    }
                });
                
                if (needsOrderUpdate) {
                    await saveTagsOrder();
                }
            } else {
                const savedTagsOrder = localStorage.getItem('tagsOrder');
                if (savedTagsOrder) {
                    try {
                        allTags = JSON.parse(savedTagsOrder);
                    } catch (e) {
                        if (allTags.length === 0) {
                            allTags = [
                                { id: 'local1', name: 'デッキパーツ', order: 0 }, 
                                { id: 'local2', name: 'コレクション', order: 1 }
                            ];
                        }
                    }
                } else if (allTags.length === 0) {
                    allTags = [
                        { id: 'local1', name: 'デッキパーツ', order: 0 }, 
                        { id: 'local2', name: 'コレクション', order: 1 }
                    ];
                }
            }
            allTags.sort((a, b) => (a.order !== undefined ? a.order : 999) - (b.order !== undefined ? b.order : 999));
            renderTagManagementList();
            if (addForm.offsetParent !== null) renderTagChoices('tag-choices-container', currentCardTags);
            if (editCardModal._element.classList.contains('show')) renderTagChoices('edit-tag-choices-container', currentCardTags);
        };

        const renderTagManagementList = () => {
            const container = document.getElementById('existing-tags-list');
            container.innerHTML = '';
            allTags.forEach((tag, index) => {
                const div = document.createElement('div');
                div.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border rounded draggable-tag';
                div.draggable = true;
                div.dataset.tagId = tag.id;
                div.dataset.tagIndex = index;
                div.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="bi bi-grip-vertical me-2"></i>
                        <span class="tag-name-display" data-tag-id="${escapeHtml(tag.id)}">${escapeHtml(tag.name)}</span>
                        <button class="btn btn-sm btn-link edit-tag-name-btn ms-2" data-id="${escapeHtml(tag.id)}" data-name="${escapeHtml(tag.name)}" title="タグ名を編集">
                            <i class="bi bi-pencil-square"></i>
                        </button>
                    </div>
                    <button class="btn btn-outline-danger btn-sm delete-tag-btn" data-id="${escapeHtml(tag.id)}" data-name="${escapeHtml(tag.name)}">削除</button>
                `;
                
                div.addEventListener('dragstart', handleTagDragStart);
                div.addEventListener('dragend', handleTagDragEnd);
                div.addEventListener('dragover', handleTagDragOver);
                div.addEventListener('drop', handleTagDrop);
                div.addEventListener('dragenter', handleTagDragEnter);
                div.addEventListener('dragleave', handleTagDragLeave);
                
                container.appendChild(div);
            });
        };
        
        let draggedTag = null;
        
        const handleTagDragStart = (e) => {
            draggedTag = e.currentTarget;
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        };
        
        const handleTagDragEnd = (e) => {
            e.currentTarget.classList.remove('dragging');
            document.querySelectorAll('.draggable-tag').forEach(tag => {
                tag.classList.remove('drag-over');
            });
        };
        
        const handleTagDragOver = (e) => {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        };
        
        const handleTagDragEnter = (e) => {
            if (draggedTag && e.currentTarget !== draggedTag) {
                e.currentTarget.classList.add('drag-over');
            }
        };
        
        const handleTagDragLeave = (e) => {
            e.currentTarget.classList.remove('drag-over');
        };
        
        const handleTagDrop = async (e) => {
            if (e.stopPropagation) e.stopPropagation();
            e.currentTarget.classList.remove('drag-over');
            
            if (draggedTag && e.currentTarget !== draggedTag) {
                const draggedIndex = parseInt(draggedTag.dataset.tagIndex);
                const targetIndex = parseInt(e.currentTarget.dataset.tagIndex);
                
                const draggedItem = allTags[draggedIndex];
                allTags.splice(draggedIndex, 1);
                allTags.splice(targetIndex, 0, draggedItem);
                
                allTags.forEach((tag, index) => {
                    tag.order = index;
                });
                
                await saveTagsOrder();
                
                renderTagManagementList();
                renderTagChoices('tag-choices-container', currentCardTags);
                renderTagChoices('edit-tag-choices-container', currentCardTags);
            }
            
            return false;
        };
        
        const saveTagsOrder = async () => {
            const tagsCollRef = getTagsCollectionRef();
            if (tagsCollRef) {
                try {
                    const batch = writeBatch(db);
                    for (const tag of allTags) {
                        const tagDoc = doc(tagsCollRef, tag.id);
                        batch.set(tagDoc, { 
                            name: tag.name,
                            order: tag.order 
                        }, { merge: true });
                    }
                    await batch.commit();
                } catch (error) {
                }
            } else {
                localStorage.setItem('tagsOrder', JSON.stringify(allTags));
            }
        };

        document.getElementById('add-tag-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const inputValue = document.getElementById('new-tag-name').value.trim();
            if (!inputValue) return;
            
            const newTagNames = inputValue.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
            
            if (newTagNames.length === 0) {
                alert('有効なタグ名を入力してください。');
                return;
            }
            
            const tagsCollRef = getTagsCollectionRef();
            const addedTags = [];
            const duplicateTags = [];
            
            for (const newTagName of newTagNames) {
                if (allTags.some(tag => tag.name === newTagName)) {
                    duplicateTags.push(newTagName);
                } else {
                    const maxOrder = allTags.reduce((max, tag) => Math.max(max, tag.order || 0), -1);
                    const newOrder = maxOrder + 1;
                    
                    if (tagsCollRef) {
                        const docRef = await addDoc(tagsCollRef, { name: newTagName, order: newOrder });
                        allTags.push({ id: docRef.id, name: newTagName, order: newOrder });
                    } else {
                        allTags.push({ id: `local_${Date.now()}_${Math.random()}`, name: newTagName, order: newOrder });
                    }
                    addedTags.push(newTagName);
                }
            }
            
            if (duplicateTags.length > 0) {
                alert(`以下のタグは既に存在するためスキップされました: ${duplicateTags.join(', ')}`);
            }
            
            if (addedTags.length > 0) {
                document.getElementById('new-tag-name').value = '';
                if (!tagsCollRef) {
                    localStorage.setItem('tagsOrder', JSON.stringify(allTags));
                }
                allTags.sort((a, b) => (a.order !== undefined ? a.order : 999) - (b.order !== undefined ? b.order : 999));
                renderTagManagementList();
                renderTagChoices('tag-choices-container', currentCardTags);
                renderTagChoices('edit-tag-choices-container', currentCardTags);
            }
        });

        document.getElementById('existing-tags-list').addEventListener('click', async (e) => {
            // Edit tag name
            if (e.target.closest('.edit-tag-name-btn')) {
                const btn = e.target.closest('.edit-tag-name-btn');
                const tagId = btn.dataset.id;
                const oldName = btn.dataset.name;
                const newName = prompt('新しいタグ名を入力してください:', oldName);

                if (newName && newName.trim() && newName !== oldName) {
                    const trimmedName = newName.trim();

                    // Check for duplicates
                    if (allTags.some(t => t.name === trimmedName && t.id !== tagId)) {
                        alert('このタグ名は既に存在します。');
                        return;
                    }

                    // Update tag name
                    const tagIndex = allTags.findIndex(t => t.id === tagId);
                    if (tagIndex !== -1) {
                        allTags[tagIndex].name = trimmedName;

                        // Save to Firebase or localStorage
                        const tagsCollRef = getTagsCollectionRef();
                        if (tagsCollRef) {
                            await updateDoc(doc(tagsCollRef, tagId), { name: trimmedName });
                        } else {
                            localStorage.setItem('tagsOrder', JSON.stringify(allTags));
                        }

                        // Update all cards with this tag (batched)
                        const currentColl = getCurrentCollection();
                        const collRef = getCollectionRef(currentListType);
                        if (collRef) {
                            let batch = writeBatch(db);
                            let batchCount = 0;
                            for (const card of currentColl) {
                                if (card.data.tags && card.data.tags.includes(oldName)) {
                                    const tIdx = card.data.tags.indexOf(oldName);
                                    card.data.tags[tIdx] = trimmedName;
                                    batch.update(doc(collRef, card.id), { tags: card.data.tags, updatedAt: Date.now() });
                                    batchCount++;
                                    if (batchCount >= 499) {
                                        await batch.commit();
                                        batch = writeBatch(db);
                                        batchCount = 0;
                                    }
                                }
                            }
                            if (batchCount > 0) await batch.commit();
                        } else {
                            for (const card of currentColl) {
                                if (card.data.tags && card.data.tags.includes(oldName)) {
                                    const tIdx = card.data.tags.indexOf(oldName);
                                    card.data.tags[tIdx] = trimmedName;
                                }
                            }
                        }

                        // Refresh UI
                        renderTagManagementList();
                        renderTagChoices('tag-choices-container', currentCardTags);
                        renderTagChoices('edit-tag-choices-container', currentCardTags);
                        renderTable();
                    }
                }
                return;
            }

            if (e.target.classList.contains('delete-tag-btn')) {
                const tagId = e.target.dataset.id;
                const tagName = e.target.dataset.name;
                if (!confirm(`タグ「${escapeHtml(tagName)}」を削除しますか？
このタグは全てのカードからも削除されます。`)) return;

                showLoading(true);
                try {
                    // Delete tag from all cards (batched)
                    const collectionRef = getCollectionRef('collection');
                    const wishlistRef = getCollectionRef('wishlist');

                    if (collectionRef || wishlistRef) {
                        let batch = writeBatch(db);
                        let batchCount = 0;

                        const batchUpdateCards = async (cards, ref) => {
                            for (const card of cards) {
                                if (card.data.tags && card.data.tags.includes(tagName)) {
                                    card.data.tags = card.data.tags.filter(t => t !== tagName);
                                    if (ref) {
                                        batch.update(doc(ref, card.id), { tags: card.data.tags, updatedAt: Date.now() });
                                        batchCount++;
                                        if (batchCount >= 499) {
                                            await batch.commit();
                                            batch = writeBatch(db);
                                            batchCount = 0;
                                        }
                                    }
                                }
                            }
                        };

                        await batchUpdateCards(cardCollection, collectionRef);
                        await batchUpdateCards(wishlistCollection, wishlistRef);
                        if (batchCount > 0) await batch.commit();
                    } else {
                        // Local mode
                        for (const card of cardCollection) {
                            if (card.data.tags && card.data.tags.includes(tagName)) {
                                card.data.tags = card.data.tags.filter(t => t !== tagName);
                            }
                        }
                        for (const card of wishlistCollection) {
                            if (card.data.tags && card.data.tags.includes(tagName)) {
                                card.data.tags = card.data.tags.filter(t => t !== tagName);
                            }
                        }
                    }

                    // Delete tag from tags collection
                    const tagsCollRef = getTagsCollectionRef();
                    if (tagsCollRef) {
                        await deleteDoc(doc(tagsCollRef, tagId));
                    }

                    allTags = allTags.filter(t => t.id !== tagId);
                    allTags.forEach((tag, index) => {
                        tag.order = index;
                    });

                    await saveTagsOrder();

                    renderTagManagementList();
                    renderTagChoices('tag-choices-container', currentCardTags);
                    renderTagChoices('edit-tag-choices-container', currentCardTags);

                    // Re-render the table if tag filter is active
                    if (document.querySelector('[name="search_tags"]').value) {
                        applySearchAndFilter();
                    }

                    alert(`タグ「${tagName}」を削除し、全てのカードから削除しました。`);
                } catch (error) {
                    console.error('Error deleting tag:', error);
                    alert('タグの削除中にエラーが発生しました。');
                } finally {
                    showLoading(false);
                }
            }
        });

        const getCollectionRef = (listType = 'collection') => {
            if (currentUser && currentUser.uid !== 'local_user') {
                const collectionName = listType === 'collection' ? "cards" : "wishlist";
                return collection(db, "users", currentUser.uid, collectionName);
            }
            return null;
        };

        // ==================== LOCAL CACHE SYSTEM ====================

        // Get cache key for current user
        const getCacheKey = (type) => `cardCache_${currentUser?.uid}_${type}`;

        // Save collection data to localStorage cache
        const saveToCache = () => {
            if (!currentUser || currentUser.uid === 'local_user') return;

            try {
                const cacheData = {
                    collection: cardCollection,
                    wishlist: wishlistCollection,
                    cachedAt: Date.now()
                };
                localStorage.setItem(getCacheKey('data'), JSON.stringify(cacheData));
                console.log('💾 Saved to local cache:', cardCollection.length, 'cards,', wishlistCollection.length, 'wishlist');
            } catch (e) {
                console.error('Failed to save cache:', e);
                // If storage is full, clear old cache
                if (e.name === 'QuotaExceededError') {
                    localStorage.removeItem(getCacheKey('data'));
                }
            }
        };

        // Load collection data from localStorage cache
        const loadFromCache = () => {
            if (!currentUser || currentUser.uid === 'local_user') return null;

            try {
                const cached = localStorage.getItem(getCacheKey('data'));
                if (cached) {
                    const data = JSON.parse(cached);
                    console.log('📂 Loaded from cache:', data.collection?.length, 'cards,', data.wishlist?.length, 'wishlist');
                    return data;
                }
            } catch (e) {
                console.error('Failed to load cache:', e);
            }
            return null;
        };

        // Update metadata timestamp in Firebase (called after any data change)
        const updateMetadataTimestamp = async () => {
            if (!currentUser || currentUser.uid === 'local_user') return;

            try {
                const metadataRef = doc(db, 'users', currentUser.uid, 'metadata', 'sync');
                await setDoc(metadataRef, { updatedAt: Date.now() }, { merge: true });
            } catch (e) {
                console.error('Failed to update metadata:', e);
            }
        };

        // Track deleted card IDs in metadata for delta sync
        const trackDeletedId = async (cardId, colName) => {
            if (!currentUser || currentUser.uid === 'local_user') return;
            try {
                const metadataRef = doc(db, 'users', currentUser.uid, 'metadata', 'sync');
                await setDoc(metadataRef, {
                    deletedIds: arrayUnion({ id: cardId, col: colName, at: Date.now() })
                }, { merge: true });
            } catch (e) {
                console.error('Failed to track deleted ID:', e);
            }
        };

        // Check if remote data is newer than cache (1 Firebase read)
        const isRemoteNewer = async (cachedAt) => {
            if (!currentUser || currentUser.uid === 'local_user') return true;

            try {
                const metadataRef = doc(db, 'users', currentUser.uid, 'metadata', 'sync');
                const metadataSnap = await getDoc(metadataRef);

                if (!metadataSnap.exists()) {
                    // No metadata yet, create it and return true to fetch data
                    await setDoc(metadataRef, { updatedAt: Date.now() });
                    return true;
                }

                const remoteUpdatedAt = metadataSnap.data().updatedAt || 0;
                const isNewer = remoteUpdatedAt > cachedAt;
                console.log(`🔍 Cache check: cached=${new Date(cachedAt).toLocaleString()}, remote=${new Date(remoteUpdatedAt).toLocaleString()}, needsSync=${isNewer}`);
                return isNewer;
            } catch (e) {
                console.error('Failed to check metadata:', e);
                return true; // On error, fetch from Firebase to be safe
            }
        };

        // Force sync from Firebase (ignores cache)
        const forceSyncFromFirebase = async () => {
            if (!currentUser || currentUser.uid === 'local_user') return;

            showLoading(true);
            console.log('🔄 Force syncing from Firebase...');

            try {
                const cardSnapshot = await getDocs(query(getCollectionRef('collection')));
                cardCollection = cardSnapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));

                const wishlistSnapshot = await getDocs(query(getCollectionRef('wishlist')));
                wishlistCollection = wishlistSnapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));

                // Save to cache
                saveToCache();

                updateTotalCounts();
                applySearchAndFilter();
                console.log('✅ Sync complete:', cardCollection.length, 'cards,', wishlistCollection.length, 'wishlist');
            } catch (error) {
                console.error('Sync failed:', error);
                alert('同期に失敗しました。');
            } finally {
                showLoading(false);
            }
        };

        // Expose for manual sync button
        window.forceSyncFromFirebase = forceSyncFromFirebase;

        // ==================== END LOCAL CACHE SYSTEM ====================

        const loadCollectionFromFirestore = async () => {
            if (!currentUser) return;
            showLoading(true);

            // Try to load from cache first
            const cached = loadFromCache();

            if (cached && cached.cachedAt) {
                // Check if remote data is newer (only 1 Firebase read)
                const needsSync = await isRemoteNewer(cached.cachedAt);

                if (!needsSync) {
                    // Use cached data
                    cardCollection = cached.collection || [];
                    wishlistCollection = cached.wishlist || [];
                    updateTotalCounts();
                    applySearchAndFilter();
                    showLoading(false);
                    console.log('✅ Using cached data (no sync needed)');
                    return;
                }
                console.log('⚠️ Remote data is newer, fetching from Firebase...');
            }

            // Fetch from Firebase
            const cardSnapshot = await getDocs(query(getCollectionRef('collection')));
            cardCollection = cardSnapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));

            const wishlistSnapshot = await getDocs(query(getCollectionRef('wishlist')));
            wishlistCollection = wishlistSnapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));

            // Save to cache for next time
            saveToCache();

            updateTotalCounts();
            applySearchAndFilter();
            showLoading(false);
        };

        const handleUserLogin = async (user) => {
            currentUser = user;
            const hideEmail = localStorage.getItem('hideEmail') === 'true';

            // メール認証状態を確認
            if (user.uid !== 'local_user' && !user.emailVerified) {
                const verificationWarning = `
                    <span class="text-warning">
                        <i class="bi bi-exclamation-triangle"></i> メール未確認
                        <button class="btn btn-sm btn-outline-warning ms-2" onclick="resendVerificationEmail()">
                            確認メールを再送信
                        </button>
                    </span>
                `;
                userEmailSpan.innerHTML = hideEmail ? verificationWarning : escapeHtml(user.email) + ' ' + verificationWarning;
            } else {
                userEmailSpan.textContent = hideEmail ? '' : escapeHtml(user.email);
            }

            mainApp.style.display = 'block';
            appLoader.style.display = 'none';
            authModal.hide();
            
            // Load gamification data from Firebase
            await loadGamificationData();
            
            if (user.uid !== 'local_user') {
                loadCollectionFromFirestore();
                loadAllTags();

                // Initialize publicProfiles for community feature (if not exists)
                try {
                    const profileRef = doc(db, 'publicProfiles', user.uid);
                    const profileSnap = await getDoc(profileRef);
                    if (!profileSnap.exists()) {
                        const defaultDisplayName = user.email?.split('@')[0] || 'Anonymous';
                        await setDoc(profileRef, {
                            isPublic: false,
                            displayName: defaultDisplayName,
                            shareToken: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(36),
                            userId: user.uid,
                            updatedAt: new Date().toISOString()
                        });
                        console.log('Initialized publicProfile for community feature');
                    }
                } catch (e) {
                    console.warn('Failed to initialize publicProfile:', e);
                }
            } else {
                cardCollection = [];
                wishlistCollection = [];
                updateTotalCounts(); // Update stats for local mode
                applySearchAndFilter();
                loadAllTags(); // ローカルモードでもタグをロード・初期化
                document.getElementById('delete-account-btn').style.display = 'none';

                // Hide VIP menu for guest users using Bootstrap classes
                const vipMenuContainer = document.getElementById('vip-menu-container');
                if (vipMenuContainer) {
                    vipMenuContainer.classList.remove('d-inline-block');
                    vipMenuContainer.classList.add('d-none');
                }
            }
            // Initialize gamification features with loaded data
            initializeFunDashboard(); // Initialize fun features
            initializeShop(); // Initialize shop
            updatePointsDisplay();
            updateRegistrationStreak();
            updateTodayStats();
            
            // Apply saved icon customization
            if (gamificationData.activeIcon) {
                window.applyIcon(gamificationData.activeIcon);
            }

            // Apply all purchased effects
            if (gamificationData.purchasedItems) {
                Object.keys(gamificationData.purchasedItems).forEach(itemId => {
                    if (itemId.startsWith('effect-') && gamificationData.purchasedItems[itemId]) {
                        document.body.classList.add(itemId);
                    }
                });
            }
            
            // Check for first login bonus
            checkFirstLoginBonus(user);
            
            // Add shop button event listener
            document.getElementById('point-shop-btn').addEventListener('click', () => {
                const shopModal = new bootstrap.Modal(document.getElementById('point-shop-modal'));
                shopModal.show();
            });
            
            // Add profile functionality
            initializeProfile();

            // Add ranking functionality
            initializeRanking();

            // Add analysis functionality
            initializeAnalysis();

            // Check VIP status after login
            checkVipStatus();
        };

        // Track daily usage
        const trackDailyUsage = () => {
            const today = new Date().toISOString().split('T')[0];
            
            if (!gamificationData.profile) {
                gamificationData.profile = {
                    nickname: '',
                    icon: '👤',
                    firstUseDate: null,
                    lastUseDate: null,
                    usageDays: new Set(),
                    maxStreak: 0,
                    totalPointsEarned: 0
                };
            }
            
            // Initialize as Set if it's not
            if (!(gamificationData.profile.usageDays instanceof Set)) {
                gamificationData.profile.usageDays = new Set(gamificationData.profile.usageDays || []);
            }
            
            // Track first use date
            if (!gamificationData.profile.firstUseDate) {
                gamificationData.profile.firstUseDate = today;
            }
            
            // Add today to usage days
            gamificationData.profile.usageDays.add(today);
            
            // Update last use date
            gamificationData.profile.lastUseDate = today;
            
            // Update max streak
            if (gamificationData.registrationStreak.count > (gamificationData.profile.maxStreak || 0)) {
                gamificationData.profile.maxStreak = gamificationData.registrationStreak.count;
            }
            
            saveGamificationData();
        };
        
        // Variable to store selected icon
        let selectedIcon = '👤';
        
        // Update icon selector with all available icons
        const updateIconSelector = () => {
            const selectorContainer = document.getElementById('profile-icon-selector');
            selectorContainer.innerHTML = '';
            
            // Default icons (always available)
            const defaultIcons = [
                '👤', '😊', '😎', '🎮', '🎯', '⭐', '🏆', '💎', '🔥', '⚡', '🌟', '🎨'
            ];
            
            // Add default icons
            defaultIcons.forEach(icon => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn btn-outline-secondary icon-select';
                btn.dataset.icon = icon;
                btn.textContent = icon;
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.icon-select').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedIcon = icon;
                });
                selectorContainer.appendChild(btn);
            });
            
            // Add purchased shop icons
            SHOP_ITEMS.icons.forEach(shopIcon => {
                if (gamificationData.purchasedItems[shopIcon.id]) {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'btn btn-outline-secondary icon-select';
                    btn.dataset.icon = shopIcon.emoji;
                    btn.innerHTML = `${shopIcon.emoji} <small class="d-block" style="font-size: 0.6rem;">購入済み</small>`;
                    btn.style.position = 'relative';
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.icon-select').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        selectedIcon = shopIcon.emoji;
                    });
                    selectorContainer.appendChild(btn);
                }
            });

            // Add gacha exclusive icons that have been obtained
            SHOP_ITEMS.exclusiveIcons.forEach(exclusiveIcon => {
                if (gamificationData.purchasedItems[exclusiveIcon.id]) {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'btn btn-outline-secondary icon-select';
                    btn.dataset.icon = exclusiveIcon.emoji;

                    // Add special badge based on rarity
                    const rarityLabel = exclusiveIcon.rarity === 'legendary' ?
                        '<span class="badge bg-danger" style="font-size: 0.5rem;">LEGENDARY</span>' :
                        '<span class="badge bg-warning" style="font-size: 0.5rem;">ULTRA RARE</span>';

                    btn.innerHTML = `${exclusiveIcon.emoji} <small class="d-block" style="font-size: 0.6rem;">${rarityLabel}</small>`;
                    btn.style.position = 'relative';

                    // Add special border for legendary items
                    if (exclusiveIcon.rarity === 'legendary') {
                        btn.style.border = '2px solid #ffd700';
                        btn.style.boxShadow = '0 0 10px rgba(255, 215, 0, 0.3)';
                    }

                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.icon-select').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        selectedIcon = exclusiveIcon.emoji;
                    });
                    selectorContainer.appendChild(btn);
                }
            });
        };
        
        // Initialize profile functionality
        const initializeProfile = () => {
            const profileBtn = document.getElementById('profile-btn');
            const profileModal = new bootstrap.Modal(document.getElementById('profile-modal'));
            const editProfileBtn = document.getElementById('edit-profile-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const profileEditForm = document.getElementById('profile-edit-form');
            const profileView = document.getElementById('profile-view');
            const profileEdit = document.getElementById('profile-edit');
            
            // Profile button click
            profileBtn.addEventListener('click', () => {
                updateProfileDisplay();
                profileModal.show();
            });
            
            // Edit profile button
            editProfileBtn.addEventListener('click', () => {
                profileView.style.display = 'none';
                profileEdit.style.display = 'block';
                
                // Pre-fill edit form
                document.getElementById('edit-nickname').value = gamificationData.profile?.nickname || '';
                
                // Update icon selector with purchased icons
                updateIconSelector();
                
                // Set active icon
                document.querySelectorAll('.icon-select').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.icon === (gamificationData.profile?.icon || '👤'));
                });
            });
            
            // Cancel edit button
            cancelEditBtn.addEventListener('click', () => {
                profileView.style.display = 'block';
                profileEdit.style.display = 'none';
            });
            
            // Initialize selectedIcon with current profile icon
            selectedIcon = gamificationData.profile?.icon || '👤';
            
            // Save profile form
            profileEditForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const nickname = document.getElementById('edit-nickname').value.trim();
                
                if (!gamificationData.profile) {
                    gamificationData.profile = {
                        nickname: '',
                        icon: '👤',
                        firstUseDate: null,
                        lastUseDate: null,
                        usageDays: new Set(),
                        maxStreak: 0,
                        totalPointsEarned: 0
                    };
                }
                
                gamificationData.profile.nickname = nickname;
                gamificationData.profile.icon = selectedIcon;
                
                await saveGamificationData();
                
                profileView.style.display = 'block';
                profileEdit.style.display = 'none';
                
                updateProfileDisplay();
                
                // Update ranking data with new profile info
                await updateUserRankingData();
                
                showNotification('プロフィールを更新しました', 'success');
            });
        };
        
        // Initialize ranking functionality
        const initializeRanking = () => {
            const rankingBtn = document.getElementById('ranking-btn');
            const rankingModal = new bootstrap.Modal(document.getElementById('ranking-modal'));

            rankingBtn.addEventListener('click', async () => {
                rankingModal.show();
                await loadRankings();
            });

            // Update user's ranking data when cards change
            updateUserRankingData();
        };

        // Initialize analysis functionality
        const initializeAnalysis = () => {
            const analysisBtn = document.getElementById('analysis-btn');
            const refreshBtn = document.getElementById('refresh-analysis-btn');

            analysisBtn.addEventListener('click', async () => {
                analysisModal.show();
                await buildCardAdditionHistory();
                updateAnalysisData();
                updateCalendarDisplay();
            });

            // Add refresh button handler
            refreshBtn.addEventListener('click', async () => {
                await buildCardAdditionHistory();
                updateAnalysisData();
                updateCalendarDisplay();
            });
        };

        // Calendar heatmap functionality
        let currentCalendarDate = new Date();
        let cardAdditionHistory = {}; // Store as { 'YYYY-MM-DD': count }

        // Generate calendar heatmap
        const generateCalendarHeatmap = (year, month) => {
            const container = document.getElementById('calendar-container');
            if (!container) return;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startPadding = firstDay.getDay();
            const daysInMonth = lastDay.getDate();

            // Always show 6 rows (42 day cells) for consistent height
            const totalDayCells = 42;
            const endPadding = totalDayCells - startPadding - daysInMonth;

            // Days of week header
            const weekDays = ['日', '月', '火', '水', '木', '金', '土'];
            let html = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); grid-template-rows: auto repeat(6, 1fr); gap: 3px; max-width: 400px; margin: 0 auto;">';

            // Add weekday headers
            weekDays.forEach(day => {
                html += `<div style="text-align: center; font-size: 0.8rem; font-weight: bold; padding: 5px;">${day}</div>`;
            });

            // Add empty cells for start padding
            for (let i = 0; i < startPadding; i++) {
                html += '<div style="aspect-ratio: 1;"></div>';
            }

            // Add days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const count = cardAdditionHistory[dateStr] || 0;
                const color = getHeatmapColor(count);
                const isToday = dateStr === new Date().toISOString().split('T')[0];

                html += `
                    <div style="
                        background-color: ${color};
                        aspect-ratio: 1;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 4px;
                        cursor: pointer;
                        position: relative;
                        border: ${isToday ? '2px solid #007bff' : 'none'};
                    "
                    data-bs-toggle="tooltip"
                    title="${year}年${month + 1}月${day}日: ${count}枚追加">
                        <span style="font-size: 0.75rem; font-weight: ${count > 0 ? 'bold' : 'normal'};">${day}</span>
                    </div>
                `;
            }

            // Add empty cells for end padding to fill 6 rows
            for (let i = 0; i < endPadding; i++) {
                html += '<div style="aspect-ratio: 1;"></div>';
            }

            html += '</div>';
            container.innerHTML = html;

            // Initialize tooltips
            const tooltipTriggerList = container.querySelectorAll('[data-bs-toggle="tooltip"]');
            tooltipTriggerList.forEach(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
        };

        // Get color based on card count
        const getHeatmapColor = (count) => {
            if (count === 0) return '#e0e0e0';
            if (count <= 5) return '#c6e48b';
            if (count <= 10) return '#7bc96f';
            if (count <= 20) return '#239a3b';
            return '#196127';
        };

        // Change calendar month
        window.changeCalendarMonth = (direction) => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            updateCalendarDisplay();
        };

        // Update calendar display
        const updateCalendarDisplay = () => {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const label = document.getElementById('calendar-month-label');
            if (label) {
                label.textContent = `${year}年${month + 1}月`;
            }
            generateCalendarHeatmap(year, month);
        };

        // Build card addition history from gamificationData (Firebase) with localStorage fallback
        const buildCardAdditionHistory = async () => {
            // Primary source: gamificationData.cardAdditionHeatmap (synced with Firebase)
            if (gamificationData.cardAdditionHeatmap && Object.keys(gamificationData.cardAdditionHeatmap).length > 0) {
                cardAdditionHistory = { ...gamificationData.cardAdditionHeatmap };
                console.log('📅 Loaded cardAdditionHistory from gamificationData:', Object.keys(cardAdditionHistory).length, 'dates');
                return;
            }

            // Fallback: Build from recentCardsHistory and collection
            cardAdditionHistory = {};

            // Get recent history from localStorage
            const recentCardsHistory = localStorage.getItem('recentCardsHistory');
            if (recentCardsHistory) {
                try {
                    const history = JSON.parse(recentCardsHistory);
                    history.forEach(item => {
                        if (item.timestamp) {
                            const date = new Date(item.timestamp).toISOString().split('T')[0];
                            const quantity = parseInt(item.quantity) || 1;
                            cardAdditionHistory[date] = (cardAdditionHistory[date] || 0) + quantity;
                        }
                    });
                } catch (e) {
                    console.error('Error parsing recent history:', e);
                }
            }

            // Also check current collection for created timestamps if available
            const collection = getCurrentCollection();
            collection.forEach(card => {
                if (card.createdAt) {
                    const date = new Date(card.createdAt).toISOString().split('T')[0];
                    const quantity = parseInt(card.data['枚数']) || 1;
                    cardAdditionHistory[date] = (cardAdditionHistory[date] || 0) + quantity;
                }
            });

            // Save rebuilt data to gamificationData for future persistence
            if (Object.keys(cardAdditionHistory).length > 0) {
                gamificationData.cardAdditionHeatmap = { ...cardAdditionHistory };
                if (currentUser && currentUser.uid !== 'local_user') {
                    saveGamificationData();
                    console.log('📅 Saved rebuilt cardAdditionHistory to Firebase');
                }
            }
        };

        // Get estimated price for rarity
        const getRarityPrice = (rarity) => {
            if (!rarity) return 0.1;

            // Define rarity prices based on provided list
            const rarityPrices = {
                'N': 0.1,
                'P': 0.1,
                'R': 0.5,
                'SR': 1,
                'P+SR': 1,
                'UR': 10,
                'P+UR': 10,
                'UL': 10,
                'GR': 1,
                'CR': 10,
                'HR': 100,
                'SE': 30,
                'P+SE': 100,
                'EXSE': 100,
                'GSE': 100,
                'PSE': 300,
                '20th': 500,
                'QCSE': 500
            };

            // Check exact match first
            if (rarityPrices[rarity]) {
                return rarityPrices[rarity];
            }

            // Check partial matches
            const rarityUpper = rarity.toUpperCase();
            for (const [key, value] of Object.entries(rarityPrices)) {
                if (rarityUpper.includes(key)) {
                    return value;
                }
            }

            // Default values for common patterns
            if (rarityUpper.includes('QCSE')) return 500;
            if (rarityUpper.includes('20TH') || rarityUpper.includes('20シク')) return 500;
            if (rarityUpper.includes('PSE')) return 300;
            if (rarityUpper.includes('GSE') || rarityUpper.includes('EXSE')) return 100;
            if (rarityUpper.includes('P+SE')) return 100;
            if (rarityUpper.includes('HR')) return 100;
            if (rarityUpper.includes('SE')) return 30;
            if (rarityUpper.includes('P+UR')) return 10;
            if (rarityUpper.includes('UR') || rarityUpper.includes('UL') || rarityUpper.includes('CR')) return 10;
            if (rarityUpper.includes('P+SR')) return 1;
            if (rarityUpper.includes('SR') || rarityUpper.includes('GR')) return 1;
            if (rarityUpper.includes('R')) return 0.5;
            if (rarityUpper.includes('P')) return 0.1;
            if (rarityUpper.includes('N')) return 0.1;

            // Default for unknown
            return 0.1;
        };

        // Update analysis data
        const updateAnalysisData = () => {
            const collection = getCurrentCollection();
            const totalCards = collection.reduce((sum, card) => sum + (parseInt(card.data['枚数']) || 0), 0);
            const uniqueCards = collection.length;

            // Update overview
            document.getElementById('analysis-total-cards').textContent = totalCards.toLocaleString();
            document.getElementById('analysis-unique-cards').textContent = uniqueCards.toLocaleString();
            document.getElementById('analysis-avg-cards').textContent = uniqueCards > 0 ? (totalCards / uniqueCards).toFixed(1) : '0';

            // Calculate rarity distribution
            const rarityDistribution = {};
            const attributeDistribution = {};
            const raceDistribution = {};
            const levelDistribution = {};
            const typeDistribution = {};
            let totalValue = 0;

            collection.forEach(card => {
                const quantity = parseInt(card.data['枚数']) || 0;
                const rarity = card.data['レアリティ'] || '不明';

                // Rarity distribution
                rarityDistribution[rarity] = (rarityDistribution[rarity] || 0) + quantity;

                // Get card details for attribute, race, level, type
                const cardName = card.data['名前'];
                let details = null;

                // First check if card has linkedDetails
                if (card.data.linkedDetails) {
                    details = card.data.linkedDetails;
                } else if (cardDetailsMap.has(cardName)) {
                    // Otherwise check master data
                    details = cardDetailsMap.get(cardName);
                }

                if (details) {
                    // Attribute distribution
                    if (details.attribute) {
                        attributeDistribution[details.attribute] = (attributeDistribution[details.attribute] || 0) + quantity;
                    }

                    // Race distribution
                    if (details.race) {
                        raceDistribution[details.race] = (raceDistribution[details.race] || 0) + quantity;
                    }

                    // Level distribution
                    if (details.level) {
                        const levelKey = `レベル${details.level}`;
                        levelDistribution[levelKey] = (levelDistribution[levelKey] || 0) + quantity;
                    }

                    // Type distribution
                    if (details.cardType) {
                        typeDistribution[details.cardType] = (typeDistribution[details.cardType] || 0) + quantity;
                    }
                }

                // Calculate estimated value based on rarity
                totalValue += quantity * getRarityPrice(rarity);
            });

            // Update estimated value
            document.getElementById('analysis-estimated-value').textContent = `¥${totalValue.toLocaleString()}`;

            // Update recent cards history
            const recentCardsHistory = localStorage.getItem('recentCardsHistory');
            let recentCards = [];
            if (recentCardsHistory) {
                try {
                    recentCards = JSON.parse(recentCardsHistory);
                } catch(e) {
                    recentCards = [];
                }
            }

            const recentCardsHtml = recentCards
                .slice(0, 50)
                .map(item => {
                    const date = new Date(item.timestamp);
                    const formattedDate = date.toLocaleDateString('ja-JP', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    return `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">${escapeHtml(item.name)}</h6>
                                    <div class="small text-muted">
                                        ${item.setCode ? `<span class="badge bg-secondary me-1">${escapeHtml(item.setCode)}</span>` : ''}
                                        ${item.rarity ? `<span class="badge bg-info me-1">${escapeHtml(item.rarity)}</span>` : ''}
                                        <span class="badge bg-primary">${item.quantity}枚</span>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted">${formattedDate}</small>
                                    <div class="mt-1">
                                        <span class="badge ${item.listType === 'wishlist' ? 'bg-warning' : 'bg-success'} me-1">
                                            ${item.listType === 'wishlist' ? '欲しいカード' : '所持カード'}
                                        </span>
                                        <button class="btn btn-sm btn-outline-danger" onclick="undoRecentAddition('${escapeHtml(item.name)}', '${escapeHtml(item.setCode || '')}', '${escapeHtml(item.rarity || '')}', ${item.quantity}, '${item.listType}', '${item.timestamp}')" title="この追加を取り消す">
                                            <i class="bi bi-arrow-counterclockwise"></i> 取消
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            document.getElementById('recent-cards-list').innerHTML = recentCardsHtml || '<p class="text-muted">まだカードが追加されていません</p>';

            // Update top cards by quantity
            const topCards = [...collection]
                .sort((a, b) => (parseInt(b.data['枚数']) || 0) - (parseInt(a.data['枚数']) || 0))
                .slice(0, 5);

            const topCardsHtml = topCards.map(card => `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${escapeHtml(card.data['名前'])}</strong>
                            <small class="text-muted d-block">${escapeHtml(card.data['型番'] || '')}</small>
                        </div>
                        <span class="badge bg-primary">${card.data['枚数']}枚</span>
                    </div>
                </div>
            `).join('');
            document.getElementById('analysis-top-cards').innerHTML = topCardsHtml || '<p class="text-muted">カードがありません</p>';

            // Update rarity ranking
            const rarityRankingHtml = Object.entries(rarityDistribution)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([rarity, count], index) => `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>${index + 1}. ${escapeHtml(rarity)}</span>
                            <span class="badge bg-secondary">${count}枚</span>
                        </div>
                    </div>
                `).join('');
            document.getElementById('analysis-rarity-ranking').innerHTML = rarityRankingHtml || '<p class="text-muted">データがありません</p>';
        };
        
        // Update user's ranking data in Firebase
        const updateUserRankingData = async () => {
            if (!currentUser) return;
            
            try {
                // Calculate stats
                const totalCards = cardCollection.reduce((sum, card) => sum + (card.data['枚数'] || 0), 0);
                const uniqueCards = cardCollection.length;
                const currentStreak = gamificationData.registrationStreak?.count || 0;
                const totalPoints = gamificationData.profile?.totalPointsEarned || 0;
                
                // If user has no cards and no meaningful data, don't save to rankings
                if (totalCards === 0 && uniqueCards === 0 && currentStreak === 0 && totalPoints === 0) {
                    // Optionally delete existing ranking data if all values are 0
                    try {
                        const rankingRef = doc(db, 'rankings', currentUser.uid);
                        await deleteDoc(rankingRef);
                    } catch (error) {
                        // Ignore error if document doesn't exist
                    }
                    return;
                }
                
                // Prepare ranking data
                const rankingData = {
                    uid: currentUser.uid,
                    nickname: gamificationData.profile?.nickname || '',
                    icon: gamificationData.profile?.icon || '👤',
                    totalCards: totalCards,
                    uniqueCards: uniqueCards,
                    currentStreak: currentStreak,
                    totalPoints: totalPoints,
                    lastUpdated: new Date().toISOString()
                };
                
                // Save to rankings collection
                const rankingRef = doc(db, 'rankings', currentUser.uid);
                await setDoc(rankingRef, rankingData);
            } catch (error) {
                console.error('Error updating ranking data:', error);
            }
        };
        
        // Load and display rankings
        const loadRankings = async () => {
            try {
                const rankingsSnapshot = await getDocs(collection(db, 'rankings'));
                const rankings = [];
                
                rankingsSnapshot.forEach(doc => {
                    rankings.push(doc.data());
                });
                
                // Sort rankings for each category (filter out users with 0 for relevant categories)
                const totalCardsRanking = [...rankings]
                    .filter(user => user.totalCards > 0)
                    .sort((a, b) => b.totalCards - a.totalCards)
                    .slice(0, 50);
                const uniqueCardsRanking = [...rankings]
                    .filter(user => user.uniqueCards > 0)
                    .sort((a, b) => b.uniqueCards - a.uniqueCards)
                    .slice(0, 50);
                const streakRanking = [...rankings]
                    .filter(user => user.currentStreak > 0)
                    .sort((a, b) => b.currentStreak - a.currentStreak)
                    .slice(0, 50);
                const pointsRanking = [...rankings]
                    .filter(user => user.totalPoints > 0)
                    .sort((a, b) => b.totalPoints - a.totalPoints)
                    .slice(0, 50);
                
                // Display rankings
                displayRanking('total-cards-ranking-list', totalCardsRanking, 'totalCards', '枚');
                displayRanking('unique-cards-ranking-list', uniqueCardsRanking, 'uniqueCards', '種類');
                displayRanking('streak-ranking-list', streakRanking, 'currentStreak', '日');
                displayRanking('points-ranking-list', pointsRanking, 'totalPoints', 'pt');
            } catch (error) {
                console.error('Error loading rankings:', error);
                document.querySelectorAll('[id$="-ranking-list"]').forEach(list => {
                    list.innerHTML = '<div class="alert alert-danger">ランキングの読み込みに失敗しました</div>';
                });
            }
        };
        
        // Display ranking list
        const displayRanking = (listId, rankings, valueKey, unit) => {
            const listElement = document.getElementById(listId);
            
            if (rankings.length === 0) {
                listElement.innerHTML = '<div class="alert alert-warning">まだランキングデータがありません</div>';
                return;
            }
            
            listElement.innerHTML = rankings.map((user, index) => {
                const rank = index + 1;
                const isCurrentUser = user.uid === currentUser?.uid;
                const displayName = user.nickname || '匿名ユーザー';
                const icon = user.icon || '👤';
                
                // Determine medal for top 3
                let medal = '';
                if (rank === 1) medal = '🥇';
                else if (rank === 2) medal = '🥈';
                else if (rank === 3) medal = '🥉';
                
                return `
                    <div class="list-group-item ${isCurrentUser ? 'bg-light border-primary' : ''}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <span class="me-3 fw-bold ${rank <= 3 ? 'fs-4' : ''}" style="min-width: 40px;">
                                    ${medal || rank + '.'}
                                </span>
                                <span class="fs-4 me-2">${icon}</span>
                                <div>
                                    <div class="fw-semibold ${isCurrentUser ? 'text-primary' : ''}">
                                        ${displayName}
                                        ${isCurrentUser ? ' (あなた)' : ''}
                                    </div>
                                    <small class="text-muted">
                                        最終更新: ${formatRelativeTime(user.lastUpdated)}
                                    </small>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="fs-5 fw-bold ${rank <= 3 ? 'text-warning' : ''}">
                                    ${user[valueKey].toLocaleString()} ${unit}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        };
        
        // Format relative time
        const formatRelativeTime = (dateString) => {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (minutes < 60) return `${minutes}分前`;
            if (hours < 24) return `${hours}時間前`;
            if (days < 7) return `${days}日前`;
            return date.toLocaleDateString('ja-JP');
        };
        
        // Update profile display
        const updateProfileDisplay = () => {
            const profile = gamificationData.profile || {};
            
            // Basic info
            document.getElementById('profile-icon').textContent = profile.icon || '👤';
            document.getElementById('profile-nickname').textContent = profile.nickname || '未設定';
            document.getElementById('profile-user-id').textContent = currentUser?.email || '';
            
            // Usage stats
            const totalDays = profile.usageDays ? (profile.usageDays instanceof Set ? profile.usageDays.size : profile.usageDays.length) : 0;
            document.getElementById('profile-total-days').textContent = `${totalDays}日`;
            
            // Format dates
            const formatDate = (dateStr) => {
                if (!dateStr) return '-';
                const date = new Date(dateStr);
                return `${date.getFullYear()}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
            };
            
            document.getElementById('profile-first-use').textContent = formatDate(profile.firstUseDate);
            document.getElementById('profile-last-use').textContent = formatDate(profile.lastUseDate);
            
            // Collection stats
            document.getElementById('profile-total-cards').textContent = `${cardCollection.reduce((sum, card) => sum + (card.data['枚数'] || 0), 0)}枚`;
            
            // Streak info
            document.getElementById('profile-streak').textContent = `${gamificationData.registrationStreak?.count || 0}日`;
            document.getElementById('profile-max-streak').textContent = `${profile.maxStreak || 0}日`;
            
            // Points
            document.getElementById('profile-total-points').textContent = `${profile.totalPointsEarned || 0}pt`;
        };

        const handleUserLogout = () => {
            currentUser = null;
            mainApp.style.display = 'none';
            appLoader.style.display = 'none';
            authModal.show();
            cardCollection = [];
            wishlistCollection = [];
            renderTable([]);
            document.getElementById('delete-account-btn').style.display = 'block';

            // Hide VIP menu on logout
            isVipMember = false;
            updateVipUI(false);
        };

        // メール認証リンクのURLパラメータを処理
        const handleEmailVerificationLink = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            const oobCode = urlParams.get('oobCode');

            // デバッグ情報をコンソールに出力
            console.log('=== メール認証デバッグ情報 ===');
            console.log('Current URL:', window.location.href);
            console.log('URL Parameters:', {
                mode: mode,
                oobCode: oobCode,
                allParams: Array.from(urlParams.entries())
            });

            if (mode === 'verifyEmail' && oobCode) {
                try {
                    console.log('認証コード検証中:', oobCode);
                    await applyActionCode(auth, oobCode);
                    alert('メールアドレスが確認されました！\nログインしてください。');
                    // URLパラメータをクリア
                    window.history.replaceState({}, document.title, window.location.pathname);
                } catch (error) {
                    console.error('メール確認エラーの詳細:', {
                        code: error.code,
                        message: error.message,
                        fullError: error
                    });

                    let errorMessage = '';

                    if (error.code === 'auth/invalid-action-code') {
                        errorMessage = `認証リンクが無効です。

考えられる原因と対策:

1. リンクの有効期限切れ（24時間以内）
   → 新しい確認メールをリクエストしてください

2. すでに使用済みのリンク
   → ログインして認証状態を確認してください

3. URLが不完全
   → メール内のリンクを最初から最後まで完全にコピーしてください

4. ローカルファイルで開いている（file://）
   → Webサーバー経由でアクセスしてください：
     python -m http.server 8000
     http://localhost:8000/card_list.html

5. Firebase設定の問題
   → コンソールで詳細を確認してください`;
                    } else if (error.code === 'auth/expired-action-code') {
                        errorMessage = 'リンクの有効期限（24時間）が切れています。\n新しい確認メールをリクエストしてください。';
                    } else if (error.code === 'auth/user-disabled') {
                        errorMessage = 'このアカウントは無効化されています。';
                    } else if (error.code === 'auth/user-not-found') {
                        errorMessage = 'ユーザーが見つかりません。先にアカウントを作成してください。';
                    } else {
                        errorMessage = `メール確認に失敗しました。

エラー詳細: ${error.message}
エラーコード: ${error.code}

Firebase Consoleで確認すべき項目:
- Authentication > Settings > Authorized domains
- メールテンプレートのアクションURL設定`;
                    }

                    alert(errorMessage);
                }
            } else if (mode || oobCode) {
                console.warn('不完全なURLパラメータ:', { mode, oobCode });
                if (!mode) console.warn('modeパラメータが欠落しています');
                if (!oobCode) console.warn('oobCodeパラメータが欠落しています');
            }
        };

        // ページ読み込み時にメール認証リンクをチェック
        handleEmailVerificationLink();

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // ユーザーがログインしたら、最新の認証状態を取得
                await user.reload();
                handleUserLogin(user);
            } else {
                handleUserLogout();
            }
        });

        // Fix mobile advanced search toggle
        setTimeout(() => {
            const advancedSearchBtn = document.getElementById('advanced-search-btn');
            const advancedSearchPanel = document.getElementById('advanced-search');

            if (advancedSearchBtn && advancedSearchPanel) {
                // Remove bootstrap collapse behavior and add manual toggle
                advancedSearchBtn.removeAttribute('data-bs-toggle');
                advancedSearchBtn.removeAttribute('data-bs-target');

                advancedSearchBtn.addEventListener('click', () => {
                    if (advancedSearchPanel.classList.contains('show')) {
                        advancedSearchPanel.classList.remove('show');
                        advancedSearchBtn.setAttribute('aria-expanded', 'false');
                    } else {
                        advancedSearchPanel.classList.add('show');
                        advancedSearchBtn.setAttribute('aria-expanded', 'true');
                    }
                });
            }
        }, 100);

        const updateBulkEditControls = () => {
            const bulkEditControls = document.getElementById('bulk-edit-controls');
            const selectedCount = document.getElementById('selected-count');
            
            if (selectedCardIds.size > 0) {
                bulkEditControls.style.display = 'block';
                selectedCount.textContent = `${selectedCardIds.size}件選択`;
            } else {
                bulkEditControls.style.display = 'none';
            }
        };
        
        const handleBulkTagOperation = (operation) => {
            if (selectedCardIds.size === 0) {
                alert('カードが選択されていません。');
                return;
            }
            
            const modalTitle = document.getElementById('bulk-tag-modal-title');
            const modalDesc = document.getElementById('bulk-tag-modal-desc');
            const container = document.getElementById('bulk-tag-choices-container');
            
            modalTitle.textContent = operation === 'add' ? 'タグを追加' : 'タグを削除';
            modalDesc.textContent = `${selectedCardIds.size}枚のカードに対して${operation === 'add' ? '追加' : '削除'}するタグを選択してください。`;
            
            container.innerHTML = '';
            const selectedTags = new Set();
            
            allTags.forEach(tag => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn btn-outline-secondary btn-sm me-1 mb-1';
                btn.textContent = tag.name;
                btn.onclick = () => {
                    if (selectedTags.has(tag.name)) {
                        selectedTags.delete(tag.name);
                        btn.classList.remove('btn-primary');
                        btn.classList.add('btn-outline-secondary');
                    } else {
                        selectedTags.add(tag.name);
                        btn.classList.remove('btn-outline-secondary');
                        btn.classList.add('btn-primary');
                    }
                };
                container.appendChild(btn);
            });
            
            document.getElementById('bulk-tag-save-btn').onclick = async () => {
                if (selectedTags.size === 0) {
                    alert('タグが選択されていません。');
                    return;
                }
                
                showLoading(true);
                try {
                    for (const cardId of selectedCardIds) {
                        const collection = getCurrentCollection();
                        const card = collection.find(c => c.id === cardId);
                        if (!card) continue;
                        
                        let updatedTags = [...(card.data.tags || [])];
                        
                        if (operation === 'add') {
                            selectedTags.forEach(tag => {
                                if (!updatedTags.includes(tag)) {
                                    updatedTags.push(tag);
                                }
                            });
                        } else {
                            updatedTags = updatedTags.filter(tag => !selectedTags.has(tag));
                        }
                        
                        const collRef = getCollectionRef(currentListType);
                        if (collRef) {
                            await updateDoc(doc(collRef, cardId), { tags: updatedTags, updatedAt: Date.now() });
                        }
                        card.data.tags = updatedTags;
                    }

                    bulkTagModal.hide();
                    selectedCardIds.clear();
                    updateBulkEditControls();
                    renderTable();
                    alert(`${selectedCardIds.size}枚のカードのタグを${operation === 'add' ? '追加' : '削除'}しました。`);
                } catch (error) {
                    alert('エラーが発生しました。');
                } finally {
                    showLoading(false);
                }
            };
            
            bulkTagModal.show();
        };
        
        document.getElementById('tag-management-btn').addEventListener('click', () => tagManagementModal.show());
        
        document.getElementById('select-all-checkbox').addEventListener('change', (e) => {
            const checkboxes = document.querySelectorAll('.card-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = e.target.checked;
                const cardId = checkbox.dataset.id;
                if (e.target.checked) {
                    selectedCardIds.add(cardId);
                } else {
                    selectedCardIds.delete(cardId);
                }
            });
            updateBulkEditControls();
        });
        
        document.addEventListener('change', (e) => {
            if (e.target.classList.contains('card-checkbox')) {
                const cardId = e.target.dataset.id;
                if (e.target.checked) {
                    selectedCardIds.add(cardId);
                } else {
                    selectedCardIds.delete(cardId);
                }
                updateBulkEditControls();
                
                const allCheckboxes = document.querySelectorAll('.card-checkbox');
                const checkedBoxes = document.querySelectorAll('.card-checkbox:checked');
                const selectAllCheckbox = document.getElementById('select-all-checkbox');
                selectAllCheckbox.checked = allCheckboxes.length > 0 && allCheckboxes.length === checkedBoxes.length;
            }
        });
        
        document.getElementById('bulk-add-tags-btn').addEventListener('click', () => handleBulkTagOperation('add'));
        document.getElementById('bulk-remove-tags-btn').addEventListener('click', () => handleBulkTagOperation('remove'));
        
        document.getElementById('bulk-delete-btn').addEventListener('click', async () => {
            if (selectedCardIds.size === 0) {
                alert('カードが選択されていません。');
                return;
            }
            
            const listName = currentListType === 'collection' ? '所持カード' : 'ウィッシュリスト';
            if (!confirm(`${selectedCardIds.size}枚のカードを${listName}から削除しますか？\nこの操作は元に戻せません。`)) {
                return;
            }
            
            showLoading(true);
            try {
                const collRef = getCollectionRef(currentListType);
                const collection = getCurrentCollection();
                
                for (const cardId of selectedCardIds) {
                    if (collRef) {
                        await deleteDoc(doc(collRef, cardId));
                        await trackDeletedId(cardId, currentListType === 'collection' ? 'cards' : 'wishlist');
                    }
                    const index = collection.findIndex(c => c.id === cardId);
                    if (index > -1) {
                        collection.splice(index, 1);
                    }
                }
                
                selectedCardIds.clear();
                updateBulkEditControls();
                updateTotalCounts(); // Update stats after bulk deletion
                applySearchAndFilter();
                alert(`${selectedCardIds.size}枚のカードを削除しました。`);
            } catch (error) {
                alert('削除中にエラーが発生しました。');
            } finally {
                showLoading(false);
            }
        });
        
        // CSV master data cache
        let csvCardMap = null; // Map: cardName → cardId

        const loadCsvMaster = async () => {
            if (csvCardMap) return csvCardMap;
            const csvUrl = 'https://raw.githubusercontent.com/yami-rin/ygoh_list/main/yugioh_cards_master.csv';
            const response = await fetch(csvUrl);
            if (!response.ok) throw new Error('CSVマスターデータの取得に失敗しました');
            const text = await response.text();
            csvCardMap = new Map();
            const lines = text.split('\n');
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                // CSV parse: カードID,名前,... (名前 may be quoted)
                let cardId, name;
                if (line.startsWith('"') || line.indexOf(',"') !== -1) {
                    // Handle quoted fields
                    const match = line.match(/^(\d+),("(?:[^"]|"")*"|[^,]*)/);
                    if (match) {
                        cardId = match[1];
                        name = match[2].replace(/^"|"$/g, '').replace(/""/g, '"');
                    }
                } else {
                    const parts = line.split(',');
                    cardId = parts[0];
                    name = parts[1];
                }
                if (cardId && name) {
                    csvCardMap.set(name, cardId);
                }
            }
            console.log(`CSVマスターデータ読み込み完了: ${csvCardMap.size}件`);
            return csvCardMap;
        };

        document.getElementById('bulk-auto-setcode-btn').addEventListener('click', async () => {
            if (selectedCardIds.size === 0) {
                alert('カードが選択されていません。');
                return;
            }

            const btn = document.getElementById('bulk-auto-setcode-btn');
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 処理中...';

            try {
                // Load CSV master
                const masterMap = await loadCsvMaster();

                const collection = getCurrentCollection();
                let updated = 0;
                let skipped = 0;
                let notFound = 0;
                const collRef = getCollectionRef(currentListType);

                for (const cardId of selectedCardIds) {
                    const card = collection.find(c => c.id === cardId);
                    if (!card) { skipped++; continue; }

                    const cardName = card.data['名前'];
                    const cardRarity = card.data['レアリティ'] || '';

                    // Look up cid from CSV
                    const cid = masterMap.get(cardName);
                    if (!cid) {
                        console.log(`CSV未検出: ${cardName}`);
                        notFound++;
                        continue;
                    }

                    // Fetch card detail for reprints
                    try {
                        const detailResp = await fetch(`https://ygoh-list.onrender.com/card-detail?cid=${cid}`);
                        if (!detailResp.ok) { skipped++; continue; }
                        const detail = await detailResp.json();
                        const reprints = detail.reprints || [];

                        if (reprints.length === 0) { skipped++; continue; }

                        // Match by rarity
                        let setCode = '';
                        if (cardRarity) {
                            const match = reprints.find(r => r.rarity === cardRarity);
                            if (match) {
                                setCode = match.setCode;
                            }
                        }
                        // Fallback: first reprint
                        if (!setCode) {
                            setCode = reprints[0].setCode;
                        }

                        // Update Firestore
                        if (collRef) {
                            await updateDoc(doc(collRef, cardId), { '型番': setCode, updatedAt: Date.now() });
                        }
                        // Update local data
                        card.data['型番'] = setCode;
                        updated++;
                    } catch (e) {
                        console.error(`型番取得エラー (${cardName}):`, e);
                        skipped++;
                    }
                }

                // Refresh UI
                applySearchAndFilter();
                saveToCache();
                updateMetadataTimestamp();

                let msg = `型番自動設定完了:\n  設定: ${updated}件`;
                if (notFound > 0) msg += `\n  CSV未検出: ${notFound}件`;
                if (skipped > 0) msg += `\n  スキップ: ${skipped}件`;
                alert(msg);
            } catch (error) {
                console.error('型番自動設定エラー:', error);
                alert('型番自動設定中にエラーが発生しました: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        });

        document.getElementById('clear-selection-btn').addEventListener('click', () => {
            selectedCardIds.clear();
            document.querySelectorAll('.card-checkbox').forEach(checkbox => checkbox.checked = false);
            document.getElementById('select-all-checkbox').checked = false;
            updateBulkEditControls();
        });
        
        document.getElementById('collection-tab').addEventListener('click', (e) => {
            e.preventDefault();
            currentListType = 'collection';
            document.getElementById('collection-tab').classList.add('active');
            document.getElementById('wishlist-tab').classList.remove('active');
            applySearchAndFilter();
        });
        
        document.getElementById('wishlist-tab').addEventListener('click', (e) => {
            e.preventDefault();
            currentListType = 'wishlist';
            document.getElementById('wishlist-tab').classList.add('active');
            document.getElementById('collection-tab').classList.remove('active');
            applySearchAndFilter();
        });
        
        document.getElementById('login-btn').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (email === 'local') {
                currentUser = { uid: 'local_user', email: 'local@example.com' };
                handleUserLogin(currentUser);
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                authError.style.display = 'none';
            } catch (error) { authError.textContent = `ログインエラー: ${error.message}`; authError.style.display = 'block'; }
        });

        document.getElementById('signup-btn').addEventListener('click', async () => {
            try {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);

                // メール確認を送信
                await sendEmailVerification(userCredential.user);

                authError.style.display = 'none';
                alert('確認メールを送信しました！\n\n【重要】\n✅ メールが届かない場合：\n・迷惑メールフォルダを確認してください\n・プロモーションフォルダも確認してください\n・送信元: noreply@ygoh-9bcf6.firebaseapp.com\n\n⚠️ リンクが無効の場合：\n・メールが古い可能性があります\n・「確認メールを再送信」ボタンを使用してください');
            } catch (error) {
                authError.textContent = `新規登録エラー: ${error.message}`;
                authError.style.display = 'block';
            }
        });

        logoutBtn.addEventListener('click', async () => {
            if (currentUser && currentUser.uid === 'local_user') {
                window.location.reload();
            } else {
                await saveGamificationData(true);
                signOut(auth);
            }
        });

        addForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading(true);
            
            try {
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Operation timeout')), 30000); // 30 seconds timeout
                });
                
                const formData = new FormData(addForm);
                const addType = document.querySelector('input[name="add-type"]:checked').value;
                const newCard = {
                    '名前': formData.get('name'),
                    '型番': formData.get('set_code'),
                    'レアリティ': formData.get('rarity'),
                    '枚数': parseInt(formData.get('quantity'), 10),
                    'tags': [...currentCardTags], // タグを追加
                    updatedAt: Date.now()
                };
            
            const setChoices = [];
            document.querySelectorAll('#set-rarity-choices .set-choice-btn').forEach(btn => {
                setChoices.push({
                    setCode: btn.dataset.setCode,
                    rarity: btn.dataset.rarity,
                    text: btn.textContent
                });
            });
            
            lastRegistrationData = {
                name: newCard['名前'],
                setCode: newCard['型番'],
                rarity: newCard['レアリティ'],
                quantity: newCard['枚数'],
                tags: [...currentCardTags],
                addType: addType,
                setChoices: setChoices
            };
            updateRegistrationHistoryButton();

                const targetCollection = addType === 'collection' ? cardCollection : wishlistCollection;
                const collRef = getCollectionRef(addType);
                
                const dbOperation = async () => {
                    if (collRef) { // Firebaseモード
                        const constraints = [where("名前", "==", newCard.名前)];
                        if (newCard.型番) {
                            constraints.push(where("型番", "==", newCard.型番));
                        }
                        if (newCard.レアリティ) {
                            constraints.push(where("レアリティ", "==", newCard.レアリティ));
                        }
                        const q = query(collRef, ...constraints);
                        const existingDocs = await getDocs(q);

                        // タグも含めて完全一致するカードを探す
                        let exactMatch = null;
                        for (const doc of existingDocs.docs) {
                            const docData = doc.data();
                            const docTags = docData.tags || [];
                            const newCardTags = newCard.tags || [];
                            if (docTags.length === newCardTags.length &&
                                docTags.every(tag => newCardTags.includes(tag))) {
                                exactMatch = doc;
                                break;
                            }
                        }

                        if (!exactMatch) {
                            const docRef = await addDoc(collRef, newCard);
                            targetCollection.push({ id: docRef.id, data: newCard });
                            // Track card addition date
                            if (currentListType === 'collection') {
                                gamificationData.cardAdditionDates[docRef.id] = new Date().toISOString();
                                saveGamificationData();
                            }
                        } else {
                            await updateDoc(exactMatch.ref, { 枚数: increment(newCard.枚数), updatedAt: Date.now() });
                            const localCard = targetCollection.find(c => c.id === exactMatch.id);
                            if(localCard) localCard.data.枚数 += newCard.枚数;
                        }
                    } else { // ローカルモード
                        const existingCard = targetCollection.find(c => {
                            if (c.data.名前 !== newCard.名前) return false;
                            if (newCard.型番 && c.data.型番 !== newCard.型番) return false;
                            if (newCard.レアリティ && c.data.レアリティ !== newCard.レアリティ) return false;
                            // タグが異なる場合は別カードとして扱う
                            const cardTags = c.data.tags || [];
                            const newCardTags = newCard.tags || [];
                            if (cardTags.length !== newCardTags.length) return false;
                            if (!cardTags.every(tag => newCardTags.includes(tag))) return false;
                            return true;
                        });
                        if (existingCard) {
                            existingCard.data.枚数 += newCard.枚数;
                        } else {
                            const localId = `local_${Date.now()}`;
                            targetCollection.push({ id: localId, data: newCard });
                            // Track card addition date for local mode
                            if (currentListType === 'collection') {
                                gamificationData.cardAdditionDates[localId] = new Date().toISOString();
                                saveGamificationData();
                            }
                        }
                    }
                };
                
                // Execute with timeout
                await Promise.race([dbOperation(), timeoutPromise]);
            
                // Track card addition for fun dashboard
                const hasTag = currentCardTags.length > 0;
                const isRare = newCard['レアリティ'] && (
                    newCard['レアリティ'].toLowerCase().includes('レア') ||
                    newCard['レアリティ'].toLowerCase().includes('rare') ||
                    newCard['レアリティ'].toUpperCase().includes('SR') ||
                    newCard['レアリティ'].toUpperCase().includes('UR')
                );
                trackCardAddition(newCard, hasTag, isRare);

                // Save to recent cards history
                let recentHistory = [];
                try {
                    const existingHistory = localStorage.getItem('recentCardsHistory');
                    if (existingHistory) {
                        recentHistory = JSON.parse(existingHistory);
                    }
                } catch(e) {
                    recentHistory = [];
                }

                // Add new card to history
                recentHistory.unshift({
                    name: newCard['名前'],
                    setCode: newCard['型番'],
                    rarity: newCard['レアリティ'],
                    quantity: newCard['枚数'],
                    listType: addType,
                    timestamp: new Date().toISOString()
                });

                // Keep only the latest 100 entries
                recentHistory = recentHistory.slice(0, 100);
                localStorage.setItem('recentCardsHistory', JSON.stringify(recentHistory));
                
                // Update cardAdditionHeatmap for calendar heatmap (today's date with quantity)
                const today = new Date().toISOString().split('T')[0];
                const addedQuantity = parseInt(newCard['枚数']) || 1;
                cardAdditionHistory[today] = (cardAdditionHistory[today] || 0) + addedQuantity;
                gamificationData.cardAdditionHeatmap = gamificationData.cardAdditionHeatmap || {};
                gamificationData.cardAdditionHeatmap[today] = (gamificationData.cardAdditionHeatmap[today] || 0) + addedQuantity;

                // Save to Firebase for logged-in users
                if (currentUser && currentUser.uid !== 'local_user') {
                    gamificationData.recentCardsHistory = recentHistory;
                    saveGamificationData();
                }

                // Add points for card addition (5 points per card)
                const cardQuantity = newCard.枚数 || 1;
                const pointsToAdd = cardQuantity * 5;
                if (isRare) {
                    addPoints(pointsToAdd + (cardQuantity * 5), `レアカード ${cardQuantity}枚追加`); // Bonus for rare
                } else {
                    addPoints(pointsToAdd, `カード ${cardQuantity}枚追加`);
                }

                updateTotalCounts(); // Update stats after adding card
                applySearchAndFilter();
                addForm.reset();
                currentCardTags = [];
                renderTagChoices('tag-choices-container', currentCardTags);
                renderSelectedTags('card-tags-container', currentCardTags);
                document.getElementById('set-rarity-choices').innerHTML = '';
                showLoading(false);

                // Update cache and metadata
                saveToCache();
                updateMetadataTimestamp();
                updateUserRankingData();

            } catch (error) {
                showLoading(false);

                // Check error type
                if (error.message === 'Operation timeout') {
                    alert('操作がタイムアウトしました。ネットワーク接続を確認してください。');
                } else if (error.code === 'permission-denied' || error.code === 'unauthenticated') {
                    alert('セッションの有効期限が切れました。再度ログインしてください。');
                    // Force re-authentication
                    if (currentUser && currentUser.uid !== 'local_user') {
                        signOut(auth);
                    } else {
                        window.location.reload();
                    }
                } else {
                    alert(`カードの追加中にエラーが発生しました: ${error.message || 'Unknown error'}`);
                }
            }
        });

        cardTableBody.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            if (target.classList.contains('delete-btn')) {
                const cardId = target.dataset.id;
                const cardName = target.closest('tr').querySelector('td:nth-child(2)').textContent;
                const listName = currentListType === 'collection' ? '所持カード' : 'ウィッシュリスト';
                if (confirm(`「${cardName}」を${listName}から削除しますか？`)) {
                    const collRef = getCollectionRef(currentListType);
                    if (collRef) { // Firebaseモード
                        await deleteDoc(doc(collRef, cardId));
                    }
                    if (currentListType === 'collection') {
                        cardCollection = cardCollection.filter(c => c.id !== cardId);
                    } else {
                        wishlistCollection = wishlistCollection.filter(c => c.id !== cardId);
                    }
                    updateTotalCounts(); // Update stats after deletion
                    applySearchAndFilter();

                    // Update cache and metadata
                    saveToCache();
                    updateMetadataTimestamp();
                    updateUserRankingData();
                }
            } else if (target.classList.contains('edit-btn')) {
                const cardId = target.dataset.id;
                const currentData = getCurrentCollection();
                const card = currentData.find(c => c.id === cardId);
                if (card) {
                    document.getElementById('edit-card-id').value = card.id;
                    document.getElementById('edit-name').value = card.data.名前;
                    document.getElementById('edit-set-code').value = card.data.型番;
                    document.getElementById('edit-rarity').value = card.data.レアリティ;
                    document.getElementById('edit-quantity').value = card.data.枚数;
                    
                    currentCardTags = [...(card.data.tags || [])]; // 既存タグをセット
                    renderTagChoices('edit-tag-choices-container', currentCardTags);
                    renderSelectedTags('edit-card-tags-container', currentCardTags);

                    // Update quantity input mode for edit modal
                    updateQuantityInputMode();

                    editCardModal.show();
                }
            } else if (target.classList.contains('move-to-collection-btn')) {
                const cardId = target.dataset.id;
                const card = wishlistCollection.find(c => c.id === cardId);
                if (card && confirm(`「${card.data.名前}」を所持カードに移動しますか？`)) {
                    // Move from wishlist to collection
                    const wishlistRef = getCollectionRef('wishlist');
                    const collectionRef = getCollectionRef('collection');
                    
                    if (collectionRef && wishlistRef) {
                        // Add to collection
                        card.data.updatedAt = Date.now();
                        const docRef = await addDoc(collectionRef, card.data);
                        cardCollection.push({ id: docRef.id, data: card.data });
                        // Track card addition date
                        gamificationData.cardAdditionDates[docRef.id] = new Date().toISOString();
                        saveGamificationData();
                        
                        // Remove from wishlist
                        await deleteDoc(doc(wishlistRef, cardId));
                        await trackDeletedId(cardId, 'wishlist');
                        wishlistCollection = wishlistCollection.filter(c => c.id !== cardId);
                    } else {
                        // Local mode
                        const newId = `local_${Date.now()}`;
                        cardCollection.push({ id: newId, data: card.data });
                        wishlistCollection = wishlistCollection.filter(c => c.id !== cardId);
                        // Track card addition date
                        gamificationData.cardAdditionDates[newId] = new Date().toISOString();
                        saveGamificationData();
                    }
                    
                    // Add points for moving card from wishlist to collection
                    const cardQuantity = card.data.枚数 || 1;
                    const pointsToAdd = cardQuantity * 5;
                    addPoints(pointsToAdd, `ウィッシュリストから ${cardQuantity}枚追加`);
                    
                    // Track for daily missions
                    const isRare = card.data.レアリティ && (
                        card.data.レアリティ.toLowerCase().includes('レア') ||
                        card.data.レアリティ.toLowerCase().includes('rare') ||
                        card.data.レアリティ.toUpperCase().includes('SR') ||
                        card.data.レアリティ.toUpperCase().includes('UR')
                    );
                    trackCardAddition(card.data, false, isRare);

                    updateTotalCounts(); // Update stats after moving card
                    applySearchAndFilter();

                    // Update cache and metadata
                    saveToCache();
                    updateMetadataTimestamp();
                    updateUserRankingData();
                }
            }
        });

        document.getElementById('save-edit-btn').addEventListener('click', async () => {
            const cardId = document.getElementById('edit-card-id').value;
            const updatedData = {
                枚数: parseInt(document.getElementById('edit-quantity').value, 10),
                tags: [...currentCardTags],
                updatedAt: Date.now()
            };

            const collRef = getCollectionRef(currentListType);
            if (collRef) { // Firebaseモード
                await updateDoc(doc(collRef, cardId), updatedData);
            }

            const targetCollection = currentListType === 'collection' ? cardCollection : wishlistCollection;
            const localCard = targetCollection.find(c => c.id === cardId);
            if(localCard) {
                localCard.data.枚数 = updatedData.枚数;
                localCard.data.tags = updatedData.tags;
            }
            updateTotalCounts(); // Update stats after editing
            applySearchAndFilter();
            editCardModal.hide();

            // Update cache and metadata
            saveToCache();
            updateMetadataTimestamp();
            updateUserRankingData();
        });

        // Handle level button clicks
        document.querySelectorAll('.level-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                applySearchAndFilter();
            });
        });

        // Handle attribute button clicks
        document.querySelectorAll('.attribute-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.attribute-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                applySearchAndFilter();
            });
        });

        // Handle card type button clicks
        document.querySelectorAll('.card-type-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                this.classList.toggle('active');
                applySearchAndFilter();
            });
        });

        // Handle race selection
        const raceButtons = document.querySelectorAll('.race-btn');

        // Handle race button clicks
        raceButtons.forEach(button => {
            button.addEventListener('click', function() {
                const race = this.dataset.race;
                if (race === '') {
                    // 「すべて」ボタンがクリックされた場合
                    raceButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                } else {
                    // 他のボタンがクリックされた場合、「すべて」ボタンを非アクティブに
                    document.querySelector('.race-btn[data-race=""]')?.classList.remove('active');
                    this.classList.toggle('active');
                    // もしすべてのボタンが非アクティブなら「すべて」をアクティブに
                    const activeRaces = document.querySelectorAll('.race-btn.active');
                    if (activeRaces.length === 0) {
                        document.querySelector('.race-btn[data-race=""]')?.classList.add('active');
                    }
                }
                applySearchAndFilter();
            });
        });

        // Debounce function for search
        let searchDebounceTimer = null;
        const debounceSearch = (callback, delay = 300) => {
            return function(...args) {
                clearTimeout(searchDebounceTimer);
                searchDebounceTimer = setTimeout(() => callback.apply(this, args), delay);
            };
        };

        // Apply debounced search on input change for mobile optimization
        const searchInputs = searchForm.querySelectorAll('input[type="text"]');
        const debouncedSearch = debounceSearch(() => {
            applySearchAndFilter();
        }, 500); // 500ms delay for mobile typing

        searchInputs.forEach(input => {
            input.addEventListener('input', debouncedSearch);
        });

        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            clearTimeout(searchDebounceTimer); // Cancel pending debounced search
            applySearchAndFilter();
        });

        // Search mode change handlers (AND/OR toggle)
        const searchModeRadios = document.querySelectorAll('input[name="search_mode"]');
        const searchModeDescription = document.getElementById('search-mode-description');

        searchModeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                const mode = e.target.value;
                if (mode === 'and') {
                    searchModeDescription.textContent = 'すべての条件を満たすカードを検索';
                } else {
                    searchModeDescription.textContent = 'いずれかの条件を満たすカードを検索';
                }
                // Trigger search when mode changes
                applySearchAndFilter();
            });
        });

        document.getElementById('items-per-page').addEventListener('change', (e) => {
            itemsPerPage = parseInt(e.target.value, 10);
            currentPage = 1; // 表示件数変更時は1ページ目に戻る
            renderTable();
        });

        document.querySelectorAll('th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const key = th.dataset.sort;
                if (sortConfig.key === key) {
                    sortConfig.direction = sortConfig.direction === 'ascending' ? 'descending' : 'ascending';
                } else {
                    sortConfig.key = key;
                    sortConfig.direction = 'ascending';
                }
                renderTable();
            });
        });

        // --- Data Import / Export ---
        const exportAllData = () => {
            // 必要な項目のみエクスポート: 名前, 型番, レアリティ, 枚数, タグ
            const extractFields = (card) => ({
                名前: card.data['名前'] || '',
                型番: card.data['型番'] || '',
                レアリティ: card.data['レアリティ'] || '',
                枚数: card.data['枚数'] || 1,
                tags: card.data.tags || []
            });
            return {
                collection: cardCollection.map(extractFields),
                wishlist: wishlistCollection.map(extractFields)
            };
        };
        
        const parseCsv = (text) => {
            const lines = text.trim().replace(/\r/g, '').split('\n');
            const header = lines[0].split(',').map(h => h.trim());
            const cards = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                const values = lines[i].split(',');
                const card = {};
                header.forEach((col, index) => {
                    const value = values[index]?.trim() || '';
                    if (col === '枚数') {
                        card[col] = parseInt(value, 10) || 1;
                    } else {
                        card[col] = value.replace(/^"|"$/g, '');
                    }
                });
                cards.push(card);
            }
            return cards;
        };

        const handleImport = async (text, format) => {
            let importedData;
            try {
                if (format === 'json') {
                    const parsed = JSON.parse(text);
                    // Check if it's the new format with collection and wishlist
                    if (parsed.collection && parsed.wishlist) {
                        importedData = parsed;
                    } else if (Array.isArray(parsed)) {
                        // Old format - treat as collection only
                        importedData = { collection: parsed, wishlist: [] };
                    } else {
                        throw new Error('Invalid JSON format');
                    }
                } else if (format === 'csv') {
                    const cards = parseCsv(text);
                    // Check if CSV has list type column
                    const hasListType = cards.length > 0 && cards[0].リスト種別;
                    if (hasListType) {
                        importedData = {
                            collection: cards.filter(c => c.リスト種別 === '所持カード'),
                            wishlist: cards.filter(c => c.リスト種別 === 'ウィッシュリスト')
                        };
                        // Remove the list type column from the data
                        [...importedData.collection, ...importedData.wishlist].forEach(c => delete c.リスト種別);
                    } else {
                        // Old format - treat as collection only
                        importedData = { collection: cards, wishlist: [] };
                    }
                }

                const totalCards = importedData.collection.length + importedData.wishlist.length;
                if (!confirm(`インポート内容:\n所持カード: ${importedData.collection.length}枚\nウィッシュリスト: ${importedData.wishlist.length}枚\n合計: ${totalCards}枚\n\nインポートしますか？\n(重複するカードは枚数が加算されます)`)) return;
                
                showLoading(true);

                // Import collection
                if (importedData.collection.length > 0) {
                    const collRef = getCollectionRef('collection');
                    if (collRef) { // Firebaseモード
                        const batch = writeBatch(db);
                        for (const card of importedData.collection) {
                            // Parse tags if they're in semicolon format
                            if (card.タグ && typeof card.タグ === 'string') {
                                card.tags = card.タグ.split(';').filter(t => t.trim());
                                delete card.タグ;
                            }
                            const q = query(collRef, where("名前", "==", card.名前), where("型番", "==", card.型番), where("レアリティ", "==", card.レアリティ));
                            const existingDocs = await getDocs(q);

                            // タグも含めて完全一致するカードを探す
                            let exactMatch = null;
                            for (const doc of existingDocs.docs) {
                                const docData = doc.data();
                                const docTags = docData.tags || [];
                                const cardTags = card.tags || [];
                                if (docTags.length === cardTags.length &&
                                    docTags.every(tag => cardTags.includes(tag))) {
                                    exactMatch = doc;
                                    break;
                                }
                            }

                            if (!exactMatch) {
                                card.updatedAt = Date.now();
                                batch.set(doc(collRef), card);
                            } else {
                                batch.update(exactMatch.ref, { 枚数: increment(card.枚数 || 1), updatedAt: Date.now() });
                            }
                        }
                        await batch.commit();
                    } else { // ローカルモード
                        for (const card of importedData.collection) {
                            if (card.タグ && typeof card.タグ === 'string') {
                                card.tags = card.タグ.split(';').filter(t => t.trim());
                                delete card.タグ;
                            }
                            const existingCard = cardCollection.find(c => {
                                if (c.data.名前 !== card.名前) return false;
                                if (c.data.型番 !== card.型番) return false;
                                if (c.data.レアリティ !== card.レアリティ) return false;
                                // タグも一致確認
                                const cTags = c.data.tags || [];
                                const cardTags = card.tags || [];
                                if (cTags.length !== cardTags.length) return false;
                                if (!cTags.every(tag => cardTags.includes(tag))) return false;
                                return true;
                            });
                            if (existingCard) {
                                existingCard.data.枚数 += (card.枚数 || 1);
                            } else {
                                cardCollection.push({ id: `local_${Date.now()}_${Math.random()}`, data: card });
                            }
                        }
                    }
                }

                // Import wishlist
                if (importedData.wishlist.length > 0) {
                    const wishRef = getCollectionRef('wishlist');
                    if (wishRef) { // Firebaseモード
                        const batch = writeBatch(db);
                        for (const card of importedData.wishlist) {
                            if (card.タグ && typeof card.タグ === 'string') {
                                card.tags = card.タグ.split(';').filter(t => t.trim());
                                delete card.タグ;
                            }
                            const q = query(wishRef, where("名前", "==", card.名前), where("型番", "==", card.型番), where("レアリティ", "==", card.レアリティ));
                            const existingDocs = await getDocs(q);

                            // タグも含めて完全一致するカードを探す
                            let exactMatch = null;
                            for (const doc of existingDocs.docs) {
                                const docData = doc.data();
                                const docTags = docData.tags || [];
                                const cardTags = card.tags || [];
                                if (docTags.length === cardTags.length &&
                                    docTags.every(tag => cardTags.includes(tag))) {
                                    exactMatch = doc;
                                    break;
                                }
                            }

                            if (!exactMatch) {
                                card.updatedAt = Date.now();
                                batch.set(doc(wishRef), card);
                            } else {
                                batch.update(exactMatch.ref, { 枚数: increment(card.枚数 || 1), updatedAt: Date.now() });
                            }
                        }
                        await batch.commit();
                    } else { // ローカルモード
                        for (const card of importedData.wishlist) {
                            if (card.タグ && typeof card.タグ === 'string') {
                                card.tags = card.タグ.split(';').filter(t => t.trim());
                                delete card.タグ;
                            }
                            const existingCard = wishlistCollection.find(c => {
                                if (c.data.名前 !== card.名前) return false;
                                if (c.data.型番 !== card.型番) return false;
                                if (c.data.レアリティ !== card.レアリティ) return false;
                                // タグも一致確認
                                const cTags = c.data.tags || [];
                                const cardTags = card.tags || [];
                                if (cTags.length !== cardTags.length) return false;
                                if (!cTags.every(tag => cardTags.includes(tag))) return false;
                                return true;
                            });
                            if (existingCard) {
                                existingCard.data.枚数 += (card.枚数 || 1);
                            } else {
                                wishlistCollection.push({ id: `local_${Date.now()}_${Math.random()}`, data: card });
                            }
                        }
                    }
                }

                // Reload if using Firebase, otherwise just refresh display
                if (getCollectionRef()) {
                    await loadCollectionFromFirestore();
                    // Update metadata timestamp after import
                    updateMetadataTimestamp();
                    updateUserRankingData();
                } else {
                    applySearchAndFilter();
                }

                // Update heatmap data for imported cards (count total imported quantity)
                const totalImported = importedData.collection.reduce((sum, c) => sum + (c.枚数 || 1), 0) +
                                      importedData.wishlist.reduce((sum, c) => sum + (c.枚数 || 1), 0);
                if (totalImported > 0) {
                    const today = new Date().toISOString().split('T')[0];
                    cardAdditionHistory[today] = (cardAdditionHistory[today] || 0) + totalImported;
                    gamificationData.cardAdditionHeatmap = gamificationData.cardAdditionHeatmap || {};
                    gamificationData.cardAdditionHeatmap[today] = (gamificationData.cardAdditionHeatmap[today] || 0) + totalImported;
                    if (currentUser && currentUser.uid !== 'local_user') {
                        saveGamificationData();
                    }
                }

                showLoading(false);
                alert('インポートが完了しました。');
            } catch (err) {
                showLoading(false);
                alert(`インポート中にエラーが発生しました: ${err.message}`);
                console.error(err);
            }
        };

        document.getElementById('import-json-btn').addEventListener('click', () => importFileInput.click());
        document.getElementById('import-csv-btn').addEventListener('click', () => importFileInput.click());
        importFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            const format = file.name.endsWith('.csv') ? 'csv' : 'json';
            reader.onload = (event) => handleImport(event.target.result, format);
            reader.readAsText(file);
            e.target.value = '';
        });

        document.getElementById('export-json-btn').addEventListener('click', () => {
            const exportData = exportAllData();
            const dataStr = JSON.stringify(exportData, null, 4);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'yugioh_collection.json'; a.click(); URL.revokeObjectURL(url);
        });

        // Link with master data functionality
        document.getElementById('link-master-data-btn').addEventListener('click', async () => {
            if (!confirm('現在のコレクションをマスターデータと連携しますか？\nこの処理により、カード詳細情報（レベル、属性、種族など）が自動的に補完されます。')) {
                return;
            }

            // Wait for master data to load if not loaded yet
            if (cardDetailsMap.size === 0) {
                alert('マスターデータを読み込んでいます。しばらく待ってから再度お試しください。');
                await loadCardReadingData();
                return;
            }

            console.log('Starting link process...');
            console.log('cardDetailsMap size:', cardDetailsMap.size);
            console.log('cardCollection length:', cardCollection.length);
            console.log('wishlistCollection length:', wishlistCollection.length);

            showLoading(true);
            let linkedCount = 0;
            let notFoundCards = [];

            // Helper function to decode HTML entities (e.g., &Sigma; -> Σ)
            const decodeHtmlEntities = (text) => {
                if (!text) return text;
                const textarea = document.createElement('textarea');
                textarea.innerHTML = text;
                return textarea.value;
            };

            // Helper function to find card in master data (tries decoded name first, then original)
            const findCardInMaster = (cardName) => {
                if (!cardName) return null;
                // Try original name first
                if (cardDetailsMap.has(cardName)) {
                    return { details: cardDetailsMap.get(cardName), matchedName: cardName };
                }
                // Try decoded name (for HTML entities like &Sigma; -> Σ)
                const decodedName = decodeHtmlEntities(cardName);
                if (decodedName !== cardName && cardDetailsMap.has(decodedName)) {
                    return { details: cardDetailsMap.get(decodedName), matchedName: decodedName };
                }
                return null;
            };

            try {
                // Process collection cards
                for (const card of cardCollection) {
                    const cardName = card.data['名前'];

                    // Debug: Show first few card names
                    if (linkedCount < 3 || notFoundCards.length < 3) {
                        console.log('Checking card:', cardName);
                        const decoded = decodeHtmlEntities(cardName);
                        console.log('Decoded name:', decoded);
                        console.log('Has in map:', cardDetailsMap.has(cardName) || cardDetailsMap.has(decoded));
                    }

                    const match = findCardInMaster(cardName);
                    if (match) {
                        const details = match.details;

                        // Store the linked data in a special field
                        const updatedData = {
                            ...card.data,
                            linkedDetails: {
                                level: details.level,
                                attribute: details.attribute,
                                race: details.race,
                                cardType: details.cardType,
                                attack: details.attack,
                                defense: details.defense,
                                cardText: details.cardText
                            },
                            updatedAt: Date.now()
                        };

                        // Update the card in Firebase or local storage
                        if (currentUser?.uid !== 'local_user') {
                            const collRef = getCollectionRef();
                            await updateDoc(doc(collRef, card.id), updatedData);
                        } else {
                            card.data = updatedData;
                        }

                        linkedCount++;
                    } else if (cardName) {
                        notFoundCards.push(cardName);
                    }
                }

                // Process wishlist cards
                for (const card of wishlistCollection) {
                    const cardName = card.data['名前'];
                    const wishlistMatch = findCardInMaster(cardName);
                    if (wishlistMatch) {
                        const details = wishlistMatch.details;

                        const updatedData = {
                            ...card.data,
                            linkedDetails: {
                                level: details.level,
                                attribute: details.attribute,
                                race: details.race,
                                cardType: details.cardType,
                                attack: details.attack,
                                defense: details.defense,
                                cardText: details.cardText
                            },
                            updatedAt: Date.now()
                        };

                        if (currentUser?.uid !== 'local_user') {
                            const wishRef = getCollectionRef('wishlist');
                            await updateDoc(doc(wishRef, card.id), updatedData);
                        } else {
                            card.data = updatedData;
                        }

                        linkedCount++;
                    } else if (cardName) {
                        notFoundCards.push(cardName);
                    }
                }

                // Save to local storage if local user
                if (currentUser?.uid === 'local_user') {
                    localStorage.setItem('cardCollection', JSON.stringify(cardCollection.map(c => c.data)));
                    localStorage.setItem('wishlistCollection', JSON.stringify(wishlistCollection.map(c => c.data)));
                }

                showLoading(false);

                let message = `${linkedCount}枚のカードをマスターデータと連携しました。`;
                if (notFoundCards.length > 0) {
                    message += `\n\nマスターデータに見つからなかったカード（${notFoundCards.length}枚）:\n${notFoundCards.slice(0, 10).join('\n')}`;
                    if (notFoundCards.length > 10) {
                        message += `\n... 他${notFoundCards.length - 10}枚`;
                    }
                }

                alert(message);
                renderTable();

            } catch (error) {
                showLoading(false);
                alert(`連携中にエラーが発生しました: ${error.message}`);
                console.error('Error linking with master data:', error);
            }
        });

        document.getElementById('export-csv-btn').addEventListener('click', () => {
            const header = ['リスト種別', '名前', '型番', 'レアリティ', '枚数', 'タグ'];
            const collectionRows = cardCollection.map(c => {
                const row = ['所持カード', c.data['名前'], c.data['型番'], c.data['レアリティ'], c.data['枚数'], (c.data.tags || []).join(';')];
                return row.map(value => {
                    const strValue = String(value || '');
                    return strValue.includes(',') ? `"${strValue}"` : strValue;
                }).join(',');
            });
            const wishlistRows = wishlistCollection.map(c => {
                const row = ['ウィッシュリスト', c.data['名前'], c.data['型番'], c.data['レアリティ'], c.data['枚数'], (c.data.tags || []).join(';')];
                return row.map(value => {
                    const strValue = String(value || '');
                    return strValue.includes(',') ? `"${strValue}"` : strValue;
                }).join(',');
            });
            const csvContent = [header.join(','), ...collectionRows, ...wishlistRows].join('\r\n');
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'yugioh_collection.csv'; a.click(); URL.revokeObjectURL(url);
        });

        // --- Settings ---
        document.getElementById('how-to-use-btn').addEventListener('click', () => howToUseModal.show());
        document.getElementById('settings-btn').addEventListener('click', () => settingsModal.show());

        // Sync button
        document.getElementById('sync-btn').addEventListener('click', async () => {
            if (confirm('サーバーからデータを再取得しますか？\n（通常はページ読み込み時に自動で最新データを取得します）')) {
                await forceSyncFromFirebase();
                alert('同期が完了しました。');
            }
        });

        darkModeToggle.addEventListener('change', (e) => {
            const theme = e.target.checked ? 'dark' : 'light';
            document.documentElement.setAttribute('data-bs-theme', theme);
            localStorage.setItem('theme', theme);
            applyTheme(); // 設定変更時に即時反映
        });
        
        hideEmailToggle.addEventListener('change', (e) => {
            const hideEmail = e.target.checked;
            localStorage.setItem('hideEmail', hideEmail);
            if (currentUser) {
                userEmailSpan.textContent = hideEmail ? '' : currentUser.email;
            }
        });
        
        // Hide stats toggle
        const hideStatsToggle = document.getElementById('hide-stats-toggle');
        hideStatsToggle.addEventListener('change', (e) => {
            const hideStats = e.target.checked;
            localStorage.setItem('hideStats', hideStats);
            updateCollectionStats(); // Update immediately
        });
        
        // Auto save toggle
        const autoSaveToggle = document.getElementById('auto-save-toggle');
        let autoSaveInterval = null;
        autoSaveToggle.addEventListener('change', (e) => {
            const enable = e.target.checked;
            localStorage.setItem('autoSave', enable);

            if (enable) {
                // Set up auto save interval (5 minutes)
                autoSaveInterval = setInterval(() => {
                    if (currentUser && currentUser.uid !== 'local_user') {
                        // Auto save to Firebase
                        console.log('Auto saving...');
                        // The data is already being saved when cards are added/modified
                    } else {
                        // Save to localStorage
                        localStorage.setItem('cardCollection', JSON.stringify(cardCollection.map(c => c.data)));
                        localStorage.setItem('wishlistCollection', JSON.stringify(wishlistCollection.map(c => c.data)));
                    }
                }, 300000); // 5 minutes
            } else {
                if (autoSaveInterval) {
                    clearInterval(autoSaveInterval);
                    autoSaveInterval = null;
                }
            }
        });

        // Table rows per page
        const tableRowsPerPage = document.getElementById('table-rows-per-page');
        tableRowsPerPage.addEventListener('change', (e) => {
            localStorage.setItem('tableRowsPerPage', e.target.value);
            applySearchAndFilter(); // Re-render table with new row limit
        });

        // Initialize settings
        hideEmailToggle.checked = localStorage.getItem('hideEmail') === 'true';
        hideStatsToggle.checked = localStorage.getItem('hideStats') === 'true';
        autoSaveToggle.checked = localStorage.getItem('autoSave') === 'true';
        tableRowsPerPage.value = localStorage.getItem('tableRowsPerPage') || '100';

        if (autoSaveToggle.checked) {
            // Start auto save if enabled
            autoSaveToggle.dispatchEvent(new Event('change'));
        }
        
        // Stats info button
        document.getElementById('stats-info-btn').addEventListener('click', () => {
            const statsInfoModal = new bootstrap.Modal(document.getElementById('stats-info-modal'));
            statsInfoModal.show();
        });
        
        // Achievement toggle
        document.getElementById('achievement-toggle').addEventListener('click', () => {
            const section = document.getElementById('achievement-section');
            const icon = document.getElementById('achievement-toggle-icon');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                icon.className = 'bi bi-chevron-up';
            } else {
                section.style.display = 'none';
                icon.className = 'bi bi-chevron-down';
            }
        });
        
        // Tap quantity input functions
        const createTapQuantityInput = (containerId, inputId, initialValue = 1) => {
            const container = document.getElementById(containerId);
            const input = document.getElementById(inputId);

            const tapContainer = document.createElement('div');
            tapContainer.className = 'tap-quantity-container';
            tapContainer.innerHTML = `
                <button type="button" class="btn btn-outline-secondary tap-quantity-btn" data-action="decrease">
                    <i class="bi bi-dash-lg"></i>
                </button>
                <div class="tap-quantity-display">${initialValue}</div>
                <button type="button" class="btn btn-outline-secondary tap-quantity-btn" data-action="increase">
                    <i class="bi bi-plus-lg"></i>
                </button>
                <button type="button" class="btn btn-outline-danger tap-quantity-btn" data-action="reset" title="リセット">
                    <i class="bi bi-arrow-counterclockwise"></i>
                </button>
            `;

            const display = tapContainer.querySelector('.tap-quantity-display');
            let value = initialValue;

            tapContainer.addEventListener('click', (e) => {
                const btn = e.target.closest('[data-action]');
                if (!btn) return;

                const action = btn.dataset.action;
                if (action === 'decrease' && value > 1) {
                    value--;
                } else if (action === 'increase' && value < 99) {
                    value++;
                } else if (action === 'reset') {
                    value = 1;
                }

                display.textContent = value;
                input.value = value;
            });

            container.innerHTML = '';
            container.appendChild(tapContainer);

            // Keep hidden input in sync
            input.type = 'hidden';
            container.appendChild(input);
        };

        const restoreNormalQuantityInput = (containerId, inputId) => {
            const container = document.getElementById(containerId);
            const input = document.getElementById(inputId);

            input.type = 'number';
            input.className = 'form-control';

            container.innerHTML = '';
            container.appendChild(input);
        };

        const updateQuantityInputMode = () => {
            const useTap = localStorage.getItem('useTapQuantity') === 'true';

            if (useTap) {
                // Enable tap mode for all devices (both mobile and PC)
                createTapQuantityInput('quantity-input-container', 'quantity',
                    parseInt(document.getElementById('quantity').value) || 1);
                createTapQuantityInput('edit-quantity-input-container', 'edit-quantity',
                    parseInt(document.getElementById('edit-quantity').value) || 1);
            } else {
                restoreNormalQuantityInput('quantity-input-container', 'quantity');
                restoreNormalQuantityInput('edit-quantity-input-container', 'edit-quantity');
            }
        };

        // Initialize history settings
        showSearchHistoryToggle.checked = localStorage.getItem('showSearchHistory') === 'true';
        showRegistrationHistoryToggle.checked = localStorage.getItem('showRegistrationHistory') === 'true';
        useTapQuantityToggle.checked = localStorage.getItem('useTapQuantity') === 'true';

        showSearchHistoryToggle.addEventListener('change', (e) => {
            localStorage.setItem('showSearchHistory', e.target.checked);
            updateSearchHistoryButton();
        });
        
        showRegistrationHistoryToggle.addEventListener('change', (e) => {
            localStorage.setItem('showRegistrationHistory', e.target.checked);
            updateRegistrationHistoryButton();
        });

        useTapQuantityToggle.addEventListener('change', (e) => {
            localStorage.setItem('useTapQuantity', e.target.checked);
            updateQuantityInputMode();
        });
        
        // Previous search button
        document.getElementById('prev-search-btn').addEventListener('click', () => {
            if (lastSearchKeyword) {
                document.getElementById('card-search').value = lastSearchKeyword;
                document.getElementById('search-db-btn').click();
            }
        });
        
        // Previous registration button
        document.getElementById('prev-registration-btn').addEventListener('click', () => {
            if (lastRegistrationData) {
                document.getElementById('name').value = lastRegistrationData.name;
                document.getElementById('set_code').value = lastRegistrationData.setCode;
                document.getElementById('rarity').value = lastRegistrationData.rarity;
                document.getElementById('quantity').value = lastRegistrationData.quantity;
                
                // Restore tags
                currentCardTags = [...lastRegistrationData.tags];
                renderTagChoices('tag-choices-container', currentCardTags);
                renderSelectedTags('card-tags-container', currentCardTags);
                
                // Restore add type
                if (lastRegistrationData.addType === 'collection') {
                    document.getElementById('add-to-collection').checked = true;
                } else {
                    document.getElementById('add-to-wishlist').checked = true;
                }
                
                // Restore set-rarity choices
                const choicesEl = document.getElementById('set-rarity-choices');
                choicesEl.innerHTML = '';
                if (lastRegistrationData.setChoices && lastRegistrationData.setChoices.length > 0) {
                    lastRegistrationData.setChoices.forEach(choice => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'btn btn-outline-primary btn-sm m-1 set-choice-btn';
                        btn.dataset.setCode = choice.setCode;
                        btn.dataset.rarity = choice.rarity;
                        btn.textContent = choice.text;
                        choicesEl.appendChild(btn);
                    });
                }
            }
        });
        
        // Initialize history buttons and quantity input mode on page load
        setTimeout(() => {
            updateSearchHistoryButton();
            updateRegistrationHistoryButton();
            updateQuantityInputMode();
        }, 100);

        const applyTheme = () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-bs-theme', savedTheme);
            darkModeToggle.checked = savedTheme === 'dark';

            const nav = document.querySelector('.navbar');
            if (nav) {
                if (savedTheme === 'dark') {
                    nav.classList.remove('navbar-light', 'bg-light');
                    nav.classList.add('navbar-dark', 'bg-dark');
                } else {
                    nav.classList.remove('navbar-dark', 'bg-dark');
                    nav.classList.add('navbar-light', 'bg-light');
                }
            }
        };
        applyTheme(); // Apply theme on initial load

        // Tag cleanup functionality
        document.getElementById('cleanup-tags-btn').addEventListener('click', async () => {
            if (!currentUser) {
                alert('ログインが必要です。');
                return;
            }

            showLoading(true);
            try {
                const existingTagNames = allTags.map(t => t.name);
                let cleanupCount = 0;
                let updatedCards = [];

                // Check collection cards
                for (const card of cardCollection) {
                    if (card.data.tags && card.data.tags.length > 0) {
                        const validTags = card.data.tags.filter(tag => existingTagNames.includes(tag));
                        if (validTags.length !== card.data.tags.length) {
                            cleanupCount++;
                            card.data.tags = validTags;
                            updatedCards.push({ card, listType: 'collection' });
                        }
                    }
                }

                // Check wishlist cards
                for (const card of wishlistCollection) {
                    if (card.data.tags && card.data.tags.length > 0) {
                        const validTags = card.data.tags.filter(tag => existingTagNames.includes(tag));
                        if (validTags.length !== card.data.tags.length) {
                            cleanupCount++;
                            card.data.tags = validTags;
                            updatedCards.push({ card, listType: 'wishlist' });
                        }
                    }
                }

                if (cleanupCount > 0) {
                    if (!confirm(`${cleanupCount}枚のカードから存在しないタグを削除します。続行しますか？`)) {
                        showLoading(false);
                        return;
                    }

                    // Update cards in Firebase
                    for (const { card, listType } of updatedCards) {
                        const collRef = getCollectionRef(listType);
                        if (collRef) {
                            await updateDoc(doc(collRef, card.id), { tags: card.data.tags, updatedAt: Date.now() });
                        }
                    }

                    // Save to localStorage if not using Firebase
                    if (!currentUser || currentUser.uid === 'local_user') {
                        localStorage.setItem('cardCollection', JSON.stringify(cardCollection));
                        localStorage.setItem('wishlistCollection', JSON.stringify(wishlistCollection));
                    }

                    alert(`${cleanupCount}枚のカードから存在しないタグを削除しました。`);
                    applySearchAndFilter();
                } else {
                    alert('クリーンアップが必要なタグは見つかりませんでした。');
                }
            } catch (error) {
                console.error('Error cleaning up tags:', error);
                alert('タグのクリーンアップ中にエラーが発生しました。');
            } finally {
                showLoading(false);
            }
        });

        // ============================================
        // VIP Membership System (Secured)
        // ============================================

        // SHA-256 hashes of valid serial numbers
        // Serial numbers are not stored in source code for security
        const VALID_SERIAL_HASHES = [
            '1a0475ee08c7580c51f9492b1f26dbff0528c4754a023adb532e6a437b747216', // Original serial
            '4abe6d8174c8939aa058f78639c49b3ff7c51898c9386dcf007d06d3dc8537d6'  // 0P3NC48DG411ERY
        ];

        let isVipMember = false;

        // SHA-256 hash function
        const sha256 = async (message) => {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        };

        // Check daily attempt limit
        const checkAttemptLimit = () => {
            const today = new Date().toISOString().split('T')[0];
            const attemptsData = localStorage.getItem('serial_attempts');

            let attempts = { date: today, count: 0 };
            if (attemptsData) {
                try {
                    attempts = JSON.parse(attemptsData);
                    // Reset counter if it's a new day
                    if (attempts.date !== today) {
                        attempts = { date: today, count: 0 };
                    }
                } catch (e) {
                    attempts = { date: today, count: 0 };
                }
            }

            return attempts;
        };

        // Update attempts counter
        const updateAttempts = (count) => {
            const today = new Date().toISOString().split('T')[0];
            const attemptsData = { date: today, count: count };
            localStorage.setItem('serial_attempts', JSON.stringify(attemptsData));

            // Update UI
            const remainingAttempts = Math.max(0, 3 - count);
            const attemptsText = document.getElementById('serial-attempts-text');
            if (attemptsText) {
                attemptsText.innerHTML = `<i class="bi bi-info-circle"></i> 残り試行回数: ${remainingAttempts}回`;
                if (remainingAttempts === 0) {
                    attemptsText.innerHTML = `<i class="bi bi-exclamation-triangle text-danger"></i> 本日の試行回数を超過しました`;
                }
            }
        };

        // Check VIP status on load
        const checkVipStatus = () => {
            const serialSection = document.getElementById('serial-number-section');
            const vipMenuContainer = document.getElementById('vip-menu-container');

            // Guest users cannot access VIP features
            if (!currentUser || currentUser.uid === 'local_user') {
                console.log('[DEBUG] checkVipStatus: Guest user detected, hiding VIP features');
                if (serialSection) serialSection.style.display = 'none';
                // Explicitly hide VIP menu for guest users using Bootstrap classes
                if (vipMenuContainer) {
                    vipMenuContainer.classList.remove('d-inline-block');
                    vipMenuContainer.classList.add('d-none');
                }
                console.log('[DEBUG] checkVipStatus: VIP menu classes after hiding:', vipMenuContainer ? vipMenuContainer.className : 'not found');
                updateVipUI(false); // Hide VIP menu for guest users
                return;
            }

            const vipData = localStorage.getItem('vip_membership');
            if (vipData) {
                try {
                    const parsed = JSON.parse(vipData);
                    if (parsed.active && parsed.verified) {
                        isVipMember = true;
                        updateVipUI(true);
                        // Show serial section only for VIP users
                        if (serialSection) serialSection.style.display = 'block';
                    } else {
                        isVipMember = false;
                        updateVipUI(false);
                        // Hide serial section for non-VIP users
                        if (serialSection) serialSection.style.display = 'none';
                    }
                } catch (e) {
                    console.error('Error parsing VIP data:', e);
                    isVipMember = false;
                    updateVipUI(false);
                    if (serialSection) serialSection.style.display = 'none';
                }
            } else {
                isVipMember = false;
                updateVipUI(false);
                // Hide serial section for non-VIP users
                if (serialSection) serialSection.style.display = 'none';
            }

            // Update attempts display (only if VIP)
            if (isVipMember) {
                const attempts = checkAttemptLimit();
                updateAttempts(attempts.count);
            }
        };

        // Update VIP UI
        const updateVipUI = (isVip) => {
            const inputSection = document.getElementById('vip-serial-input-section');
            const activeSection = document.getElementById('vip-active-section');
            const statusBadge = document.getElementById('vip-status-badge');
            const profileVipBadge = document.getElementById('profile-vip-badge');
            const vipMenuContainer = document.getElementById('vip-menu-container');

            // For guest users, hide everything including input section
            const isGuest = !currentUser || currentUser.uid === 'local_user';

            // Guest users can never be VIP
            if (isGuest) {
                console.log('[DEBUG] Guest user detected in updateVipUI, hiding all VIP elements');
                if (inputSection) inputSection.style.display = 'none';
                if (activeSection) activeSection.style.display = 'none';
                if (statusBadge) statusBadge.style.display = 'none';
                if (vipMenuContainer) {
                    vipMenuContainer.classList.remove('d-inline-block');
                    vipMenuContainer.classList.add('d-none');
                }
                if (profileVipBadge) profileVipBadge.style.display = 'none';
                return;
            }

            if (isVip) {
                if (inputSection) inputSection.style.display = 'none';
                if (activeSection) activeSection.style.display = 'block';
                if (statusBadge) {
                    statusBadge.style.display = 'inline-block';
                    statusBadge.classList.remove('bg-secondary');
                    statusBadge.classList.add('bg-warning', 'text-dark');
                }

                // Show VIP menu using Bootstrap classes
                if (vipMenuContainer) {
                    vipMenuContainer.classList.remove('d-none');
                    vipMenuContainer.classList.add('d-inline-block');
                }

                // Show VIP badge on profile
                if (profileVipBadge) profileVipBadge.style.display = 'inline-block';
            } else {
                if (inputSection) inputSection.style.display = 'block';
                if (activeSection) activeSection.style.display = 'none';
                if (statusBadge) statusBadge.style.display = 'none';

                // Hide VIP menu using Bootstrap classes
                if (vipMenuContainer) {
                    vipMenuContainer.classList.remove('d-inline-block');
                    vipMenuContainer.classList.add('d-none');
                }

                // Hide VIP badge on profile
                if (profileVipBadge) profileVipBadge.style.display = 'none';
            }
        };

        // VIP Activation
        document.getElementById('vip-activate-btn').addEventListener('click', async () => {
            const serialInput = document.getElementById('vip-serial-input');
            const serial = serialInput.value.trim();

            if (!serial) {
                alert('シリアル番号を入力してください。');
                return;
            }

            // Check attempt limit
            const attempts = checkAttemptLimit();
            if (attempts.count >= 3) {
                alert('❌ 本日の試行回数上限に達しました。\n明日再度お試しください。');
                return;
            }

            // Increment attempts
            updateAttempts(attempts.count + 1);

            // Validate serial number by hashing
            const serialHash = await sha256(serial);

            if (VALID_SERIAL_HASHES.includes(serialHash)) {
                // Save VIP status
                const vipData = {
                    active: true,
                    verified: true,
                    activatedAt: new Date().toISOString()
                };
                localStorage.setItem('vip_membership', JSON.stringify(vipData));
                isVipMember = true;
                updateVipUI(true);
                serialInput.value = '';

                // Reset attempts on success
                updateAttempts(0);

                // Show success message
                alert('✅ 認証に成功しました！\n特典機能が利用可能になりました。');
            } else {
                const remainingAttempts = Math.max(0, 3 - attempts.count - 1);
                alert(`❌ 無効なシリアル番号です。\n\n残り試行回数: ${remainingAttempts}回`);
            }
        });

        // VIP Deactivation
        document.getElementById('vip-deactivate-btn').addEventListener('click', () => {
            if (confirm('認証を解除しますか？\n\n再度利用するには、シリアル番号の再入力が必要です。')) {
                localStorage.removeItem('vip_membership');
                isVipMember = false;
                updateVipUI(false);
                alert('認証を解除しました。');
            }
        });

        // Console command to show serial input section
        window.enableSerialInput = () => {
            if (!currentUser || currentUser.uid === 'local_user') {
                console.log('%c[ERROR] ログインが必要です。', 'color: red; font-weight: bold;');
                return;
            }
            const serialSection = document.getElementById('serial-number-section');
            const inputSection = document.getElementById('vip-serial-input-section');
            if (serialSection) serialSection.style.display = 'block';
            if (inputSection) inputSection.style.display = 'block';
            const attempts = checkAttemptLimit();
            updateAttempts(attempts.count);
            console.log('%c[OK] シリアル入力が有効になりました。設定画面のシリアル番号欄から入力してください。', 'color: green; font-weight: bold;');
        };

        // VIP Features Button
        document.getElementById('vip-features-btn').addEventListener('click', () => {
            const features = `
✨ 特典機能一覧

📊 現在利用可能な機能:
• カードギャラリー
• カスタムCSS
• 一括登録

🚀 今後追加予定の機能:
• 未定
            `.trim();

            alert(features);
        });

        // VIP Menu Items Event Handlers
        // Gallery
        document.getElementById('vip-gallery-btn').addEventListener('click', () => {
            if (!isVipMember) {
                alert('この機能はVIPメンバー専用です。');
                return;
            }
            window.location.href = 'card_gallery.html';
        });

        // Custom CSS
        document.getElementById('vip-custom-css-btn').addEventListener('click', () => {
            if (!isVipMember) {
                alert('この機能はVIPメンバー専用です。');
                return;
            }
            const customCssModal = new bootstrap.Modal(document.getElementById('custom-css-modal'));
            customCssModal.show();

            // Load saved CSS
            const savedCss = localStorage.getItem('vip_custom_css');
            if (savedCss) {
                document.getElementById('custom-css-input').value = savedCss;
            }
        });

        // Bulk Import (VIP)
        document.getElementById('vip-bulk-import-btn').addEventListener('click', () => {
            if (!isVipMember) {
                alert('この機能はVIPメンバー専用です。');
                return;
            }
            const bulkImportModal = new bootstrap.Modal(document.getElementById('bulk-import-modal'));
            bulkImportModal.show();
        });

        // Custom CSS Functionality
        let customStyleElement = null;

        // Apply Custom CSS
        document.getElementById('apply-custom-css-btn').addEventListener('click', () => {
            if (!isVipMember) {
                alert('この機能はVIPメンバー専用です。');
                return;
            }

            const cssCode = document.getElementById('custom-css-input').value;

            // Save to localStorage
            localStorage.setItem('vip_custom_css', cssCode);

            // Apply CSS
            applyCustomCss(cssCode);

            alert('✅ カスタムCSSを適用しました。');
        });

        // Preview Custom CSS (temporary)
        document.getElementById('preview-custom-css-btn').addEventListener('click', () => {
            if (!isVipMember) {
                alert('この機能はVIPメンバー専用です。');
                return;
            }

            const cssCode = document.getElementById('custom-css-input').value;
            applyCustomCss(cssCode);
            alert('👁️ プレビュー中です。保存するには「適用」を押してください。');
        });

        // Reset Custom CSS
        document.getElementById('reset-custom-css-btn').addEventListener('click', () => {
            if (!isVipMember) {
                alert('この機能はVIPメンバー専用です。');
                return;
            }

            if (confirm('カスタムCSSをリセットしますか？')) {
                localStorage.removeItem('vip_custom_css');
                document.getElementById('custom-css-input').value = '';

                // Remove custom style element
                if (customStyleElement) {
                    customStyleElement.remove();
                    customStyleElement = null;
                }

                alert('✅ カスタムCSSをリセットしました。');
            }
        });

        // Function to apply custom CSS
        const applyCustomCss = (cssCode) => {
            // Remove existing custom style
            if (customStyleElement) {
                customStyleElement.remove();
            }

            // Create new style element
            customStyleElement = document.createElement('style');
            customStyleElement.id = 'vip-custom-css';
            customStyleElement.textContent = cssCode;
            document.head.appendChild(customStyleElement);
        };

        // Load custom CSS on page load
        const loadCustomCss = () => {
            if (!isVipMember) return;

            const savedCss = localStorage.getItem('vip_custom_css');
            if (savedCss) {
                applyCustomCss(savedCss);
            }
        };

        // Call loadCustomCss after VIP check
        setTimeout(loadCustomCss, 100);

        // VIP Premium Export Function (Removed - button no longer exists)
        /*
        document.getElementById('export-premium-csv-btn').addEventListener('click', () => {
            if (!isVipMember) {
                alert('この機能はVIPメンバー専用です。');
                return;
            }

            const collection = getCurrentCollection();
            if (collection.length === 0) {
                alert('エクスポートするカードがありません。');
                return;
            }

            // Premium CSV with extended data
            let csvContent = '\uFEFF'; // BOM for UTF-8
            csvContent += 'カード名,型番,レアリティ,枚数,タグ,レベル,属性,種族,カードタイプ,攻撃力,守備力,登録日,最終更新日\n';

            collection.forEach(card => {
                const d = card.data;
                const details = d.linkedDetails || cardDetailsMap.get(d['名前'] || '');

                const row = [
                    d['名前'] || '',
                    d['型番'] || '',
                    d['レアリティ'] || '',
                    d['枚数'] || 0,
                    (d.tags || []).join('|'),
                    details?.level || '',
                    details?.attribute || '',
                    details?.race || '',
                    details?.cardType || '',
                    details?.attack || '',
                    details?.defense || '',
                    d['登録日'] || '',
                    d['最終更新日'] || ''
                ].map(val => `"${String(val).replace(/"/g, '""')}"`);

                csvContent += row.join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `premium_card_collection_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        */

        // Bulk Import functionality
        let bulkImportCards = [];

        // Note: Bulk import button is now in VIP menu (vip-bulk-import-btn)

        document.getElementById('fetch-cards-btn').addEventListener('click', async () => {
            // VIP check for bulk import
            if (!isVipMember) {
                alert('この機能はVIPメンバー専用です。');
                return;
            }

            const url = document.getElementById('bulk-import-url').value.trim();

            if (!url) {
                alert('URLを入力してください。');
                return;
            }

            if (!url.includes('yugioh-card.com')) {
                alert('遊戯王公式DBのURLを入力してください。');
                return;
            }

            const loadingDiv = document.getElementById('bulk-import-loading');
            const resultsDiv = document.getElementById('bulk-import-results');
            const registerBtn = document.getElementById('bulk-register-btn');

            loadingDiv.style.display = 'block';
            resultsDiv.style.display = 'none';
            registerBtn.disabled = true;

            try {
                const proxyUrl = `https://ygoh-list.onrender.com/card-list?url=${encodeURIComponent(url)}`;

                // Fetch with timeout (60 seconds for server startup)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);

                const response = await fetch(proxyUrl, {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    // Check if it's a server error that might indicate startup
                    if (response.status >= 500 && response.status < 600) {
                        throw new Error('SERVER_STARTING');
                    }
                    throw new Error('カード情報の取得に失敗しました。');
                }

                const data = await response.json();
                bulkImportCards = data.cards || [];

                // Debug: Log response data
                console.log('Proxy response:', data);
                if (data.debug) {
                    console.log('=== Debug Info ===');
                    console.log('HTML Sample (first 3000 chars):', data.debug.htmlSample);
                    console.log('Card Image Patterns:', data.debug.cardImagePatterns);
                    console.log('Name Patterns:', data.debug.namePatterns);
                    console.log('Strong Tags:', data.debug.strongTags);
                }

                if (bulkImportCards.length === 0) {
                    console.error('No cards found. Check debug info above.');
                    throw new Error('カードが見つかりませんでした。URLが正しいか、または検索結果にカードが含まれているか確認してください。');
                }

                // Display results
                document.getElementById('bulk-import-count').textContent = bulkImportCards.length;
                const cardGrid = document.getElementById('bulk-import-card-grid');
                cardGrid.innerHTML = '';

                // Load images asynchronously with fetch to avoid CORS issues
                // Returns detailData including reprints (setCode + rarity)
                const loadCardImage = async (cardId, imgElement) => {
                    try {
                        console.log(`Loading image for card ${cardId}...`);

                        // First, get card details to obtain the enc token
                        const detailUrl = `https://ygoh-list.onrender.com/card-detail?cid=${cardId}`;
                        const detailResponse = await fetch(detailUrl);

                        if (!detailResponse.ok) {
                            throw new Error(`Failed to get card details: HTTP ${detailResponse.status}`);
                        }

                        const detailData = await detailResponse.json();
                        console.log(`Card detail for ${cardId}:`, detailData);

                        // Use the imageUrl from card details (which includes enc token)
                        const imageUrl = detailData.imageUrl;
                        if (!imageUrl) {
                            throw new Error('No image URL in card details');
                        }

                        console.log(`Fetching image from: ${imageUrl}`);
                        const imageResponse = await fetch(imageUrl);
                        console.log(`Image response for card ${cardId}: status=${imageResponse.status}, ok=${imageResponse.ok}`);

                        if (imageResponse.ok) {
                            const blob = await imageResponse.blob();
                            console.log(`Blob created for card ${cardId}: type=${blob.type}, size=${blob.size}`);
                            const blobUrl = URL.createObjectURL(blob);
                            imgElement.src = blobUrl;
                            console.log(`Image loaded successfully for card ${cardId}`);
                        } else {
                            throw new Error(`Failed to load image: HTTP ${imageResponse.status}`);
                        }

                        return detailData;
                    } catch (error) {
                        console.error(`Error loading image for card ${cardId}:`, error);
                        imgElement.src = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='200' height='290'><rect width='200' height='290' fill='%23ddd'/><text x='50%' y='50%' text-anchor='middle' dy='.3em' fill='%23999' font-size='14'>No Image</text></svg>";
                        throw error; // Re-throw for retry logic
                    }
                };

                const defaultQuantity = parseInt(document.getElementById('bulk-default-quantity').value) || 0;

                bulkImportCards.forEach((card, index) => {
                    const cardItem = document.createElement('div');
                    cardItem.className = 'bulk-card-item';

                    // Display all rarities for this card with quantity input for each
                    let rarityDisplay = '';
                    if (card.rarities && card.rarities.length > 0) {
                        rarityDisplay = card.rarities.map((rarity, rIdx) => `
                            <div class="rarity-quantity-row">
                                <label class="rarity-label">${rarity}</label>
                                <div class="input-group input-group-sm" style="max-width: 130px;">
                                    <button class="btn btn-outline-secondary quantity-decrease" type="button" data-index="${index}" data-rarity="${rarity}">-</button>
                                    <input type="number" class="form-control form-control-sm bulk-card-rarity-quantity"
                                           data-index="${index}" data-rarity="${rarity}"
                                           min="0" max="99" value="${defaultQuantity}" style="text-align: center;">
                                    <button class="btn btn-outline-secondary quantity-increase" type="button" data-index="${index}" data-rarity="${rarity}">+</button>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        rarityDisplay = '<div class="text-muted" style="font-size: 0.85rem;">-</div>';
                    }

                    cardItem.innerHTML = `
                        <img class="bulk-card-image" data-card-id="${card.id}" alt="${card.name}"
                            src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='200' height='290'><rect width='200' height='290' fill='%23f0f0f0'/><text x='50%' y='50%' text-anchor='middle' dy='.3em' fill='%23999' font-size='14'>読込中...</text></svg>">
                        <div class="bulk-card-name" title="${card.name}">${card.name}</div>
                        ${card.number ? `<div class="bulk-card-number">${card.number}</div>` : ''}
                        <div class="bulk-card-controls">
                            <div class="bulk-card-rarities">
                                <label style="font-weight: 600; margin-bottom: 0.5rem; display: block; color: #000;">レアリティ別枚数</label>
                                ${rarityDisplay}
                            </div>
                        </div>
                    `;
                    cardGrid.appendChild(cardItem);

                    // Load image asynchronously with retry
                    const imgElement = cardItem.querySelector('.bulk-card-image');

                    // Retry up to 3 times with 2 second delay
                    const loadWithRetry = async (retries = 3, delay = 2000) => {
                        for (let i = 0; i < retries; i++) {
                            try {
                                const detailData = await loadCardImage(card.id, imgElement);
                                // Store reprints for set code lookup during registration
                                if (detailData && detailData.reprints) {
                                    bulkImportCards[index].reprints = detailData.reprints;
                                }
                                return; // Success
                            } catch (error) {
                                console.log(`Retry ${i + 1}/${retries} for card ${card.id}`);
                                if (i < retries - 1) {
                                    await new Promise(resolve => setTimeout(resolve, delay));
                                } else {
                                    // Final failure - show error message
                                    imgElement.src = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='200' height='290'><rect width='200' height='290' fill='%23ffe6e6'/><text x='50%' y='45%' text-anchor='middle' fill='%23999' font-size='12'>画像読込失敗</text><text x='50%' y='55%' text-anchor='middle' fill='%23999' font-size='10'>サーバー起動中の</text><text x='50%' y='60%' text-anchor='middle' fill='%23999' font-size='10'>可能性があります</text></svg>";
                                }
                            }
                        }
                    };

                    loadWithRetry();
                });

                // Add event listeners for +/- buttons
                document.querySelectorAll('.quantity-decrease').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const index = e.target.dataset.index;
                        const rarity = e.target.dataset.rarity;
                        const input = document.querySelector(`.bulk-card-rarity-quantity[data-index="${index}"][data-rarity="${rarity}"]`);
                        if (input) {
                            const currentValue = parseInt(input.value) || 0;
                            if (currentValue > 0) {
                                input.value = currentValue - 1;
                            }
                        }
                    });
                });

                document.querySelectorAll('.quantity-increase').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const index = e.target.dataset.index;
                        const rarity = e.target.dataset.rarity;
                        const input = document.querySelector(`.bulk-card-rarity-quantity[data-index="${index}"][data-rarity="${rarity}"]`);
                        if (input) {
                            const currentValue = parseInt(input.value) || 0;
                            const maxValue = parseInt(input.max) || 99;
                            if (currentValue < maxValue) {
                                input.value = currentValue + 1;
                            }
                        }
                    });
                });

                loadingDiv.style.display = 'none';
                resultsDiv.style.display = 'block';
                registerBtn.disabled = false;

            } catch (error) {
                console.error('Error fetching cards:', error);
                loadingDiv.style.display = 'none';

                // Handle different error types
                if (error.name === 'AbortError') {
                    // Timeout error
                    if (confirm('⏱️ サーバーの起動に時間がかかっています。\n\nRenderの無料プランのため、初回アクセス時はサーバーが起動するまで1分ほどかかる場合があります。\n\nもう一度試しますか？')) {
                        document.getElementById('fetch-cards-btn').click();
                    }
                } else if (error.message === 'SERVER_STARTING') {
                    // Server error (likely starting up)
                    if (confirm('🚀 サーバーを起動中です...\n\nRenderの無料プランのため、しばらく時間がかかります。\n少し待ってから、もう一度試しますか？（推奨: 30秒後）')) {
                        setTimeout(() => {
                            document.getElementById('fetch-cards-btn').click();
                        }, 2000);
                    }
                } else {
                    // Other errors
                    const errorMsg = error.message || 'カード情報の取得に失敗しました。';
                    alert(`❌ エラー: ${errorMsg}\n\nURLが正しいか確認してください。`);
                }
            }
        });

        // Apply default quantity to all rarity inputs
        document.getElementById('apply-default-quantity-btn').addEventListener('click', () => {
            const defaultQuantity = parseInt(document.getElementById('bulk-default-quantity').value) || 0;
            const allQuantityInputs = document.querySelectorAll('.bulk-card-rarity-quantity');
            allQuantityInputs.forEach(input => {
                input.value = defaultQuantity;
            });
        });

        const bulkRegisterBtn = document.getElementById('bulk-register-btn');
        console.log('Setting up bulk-register-btn event listener. Button element:', bulkRegisterBtn);

        if (!bulkRegisterBtn) {
            console.error('ERROR: bulk-register-btn element not found!');
        } else {
            console.log('Button found. Attaching event listener...');
        }

        bulkRegisterBtn.addEventListener('click', async (event) => {
            console.log('=== BULK REGISTER BUTTON CLICKED ===');
            console.log('Event:', event);
            console.log('Event target:', event.target);
            console.log('Event currentTarget:', event.currentTarget);
            console.log('Button disabled:', event.currentTarget.disabled);
            console.log('isVipMember:', isVipMember);
            console.log('currentUser:', currentUser);

            // VIP check for bulk import
            if (!isVipMember) {
                console.log('VIP check failed!');
                alert('この機能はVIPメンバー専用です。');
                return;
            }

            if (!currentUser) {
                console.log('User not logged in!');
                alert('ログインが必要です。');
                return;
            }

            console.log('Checks passed. Starting bulk registration...');

            const selectedCards = [];

            // Get all rarity quantity inputs
            const rarityQuantityInputs = document.querySelectorAll('.bulk-card-rarity-quantity');
            console.log('Found rarity quantity inputs:', rarityQuantityInputs.length);

            for (const input of rarityQuantityInputs) {
                try {
                    const index = parseInt(input.dataset.index);
                    const rarity = input.dataset.rarity;
                    const quantity = parseInt(input.value) || 0;

                    if (quantity > 0) {
                        const cardData = bulkImportCards[index];

                        // If reprints not loaded yet, fetch card detail now
                        if (!cardData.reprints) {
                            try {
                                const detailUrl = `https://ygoh-list.onrender.com/card-detail?cid=${cardData.id}`;
                                const resp = await fetch(detailUrl);
                                if (resp.ok) {
                                    const detail = await resp.json();
                                    cardData.reprints = detail.reprints || [];
                                }
                            } catch (e) {
                                console.error(`Failed to fetch reprints for card ${cardData.id}:`, e);
                            }
                        }

                        // Look up set code from reprints matching the selected rarity
                        let number = '';
                        if (cardData.reprints && cardData.reprints.length > 0) {
                            const matchingReprint = cardData.reprints.find(r => r.rarity === rarity);
                            if (matchingReprint) {
                                number = matchingReprint.setCode;
                            } else if (cardData.reprints.length > 0) {
                                // Fallback: use first reprint's setCode
                                number = cardData.reprints[0].setCode;
                            }
                        }

                        selectedCards.push({
                            ...cardData,
                            quantity: quantity,
                            rarity: rarity,
                            number: number
                        });
                    }
                } catch (error) {
                    console.error(`Error processing input for index ${input.dataset.index}:`, error);
                }
            }

            console.log('Selected cards:', selectedCards);
            console.log('Selected cards count:', selectedCards.length);

            if (selectedCards.length === 0) {
                console.log('No cards selected, showing alert');
                alert('枚数が1以上のカードを登録してください。');
                return;
            }

            // Note: confirm() doesn't work inside Bootstrap modal due to z-index/backdrop issues
            // User already clicked the register button, so we can proceed directly
            console.log(`Proceeding with registration of ${selectedCards.length} cards...`);

            showLoading(true);
            let successCount = 0;
            let failCount = 0;
            let totalAddedQuantity = 0;

            try {
                const cardsRef = getCollectionRef('collection');

                for (const card of selectedCards) {
                    try {
                        const cardNumber = card.number || '';
                        const cardRarity = card.rarity || '';
                        const cardTags = card.tags || [];

                        // Query with name, number, rarity constraints (matching normal registration)
                        const constraints = [where('名前', '==', card.name)];
                        if (cardNumber) {
                            constraints.push(where('型番', '==', cardNumber));
                        }
                        if (cardRarity) {
                            constraints.push(where('レアリティ', '==', cardRarity));
                        }
                        const q = query(cardsRef, ...constraints);
                        const querySnapshot = await getDocs(q);

                        // Find exact match including tags
                        let exactMatch = null;
                        for (const docSnap of querySnapshot.docs) {
                            const data = docSnap.data();
                            const docTags = data.tags || [];
                            if (docTags.length === cardTags.length &&
                                docTags.every(tag => cardTags.includes(tag)) &&
                                cardTags.every(tag => docTags.includes(tag))) {
                                exactMatch = docSnap;
                                break;
                            }
                        }

                        if (exactMatch) {
                            // Found exact match - use atomic increment (matching normal registration)
                            await updateDoc(exactMatch.ref, {
                                '枚数': increment(card.quantity),
                                updatedAt: Date.now()
                            });
                        } else {
                            // No exact match - add as new card
                            const newCard = {
                                '名前': card.name,
                                '型番': cardNumber,
                                'レアリティ': cardRarity,
                                '枚数': card.quantity,
                                'tags': cardTags,
                                updatedAt: Date.now()
                            };
                            const docRef = await addDoc(cardsRef, newCard);
                            // Track card addition date
                            gamificationData.cardAdditionDates[docRef.id] = new Date().toISOString();
                        }

                        // Track gamification (matching normal registration)
                        const isRare = cardRarity && (
                            cardRarity.toLowerCase().includes('レア') ||
                            cardRarity.toLowerCase().includes('rare') ||
                            cardRarity.toUpperCase().includes('SR') ||
                            cardRarity.toUpperCase().includes('UR')
                        );
                        const cardDataForTracking = { '枚数': card.quantity };
                        trackCardAddition(cardDataForTracking, cardTags.length > 0, isRare);

                        // Add points (matching normal registration)
                        const pointsToAdd = card.quantity * 5;
                        if (isRare) {
                            addPoints(pointsToAdd + (card.quantity * 5), `レアカード ${card.quantity}枚追加`);
                        } else {
                            addPoints(pointsToAdd, `カード ${card.quantity}枚追加`);
                        }

                        totalAddedQuantity += card.quantity;

                        // Add to recent history for analysis
                        try {
                            const recentHistory = JSON.parse(localStorage.getItem('recentCardsHistory') || '[]');
                            recentHistory.unshift({
                                name: card.name,
                                setCode: cardNumber,
                                rarity: cardRarity,
                                quantity: card.quantity,
                                timestamp: new Date().toISOString()
                            });
                            // Keep only last 1000 entries
                            if (recentHistory.length > 1000) {
                                recentHistory.splice(1000);
                            }
                            localStorage.setItem('recentCardsHistory', JSON.stringify(recentHistory));
                        } catch (e) {
                            console.error('Error updating recent history:', e);
                        }

                        successCount++;
                    } catch (error) {
                        console.error(`Failed to register ${card.name}:`, error);
                        failCount++;
                    }
                }

                // Update card addition heatmap (matching normal registration)
                const today = new Date().toISOString().split('T')[0];
                cardAdditionHistory[today] = (cardAdditionHistory[today] || 0) + totalAddedQuantity;
                gamificationData.cardAdditionHeatmap = gamificationData.cardAdditionHeatmap || {};
                gamificationData.cardAdditionHeatmap[today] = (gamificationData.cardAdditionHeatmap[today] || 0) + totalAddedQuantity;

                // Save recentCardsHistory and gamification to Firebase
                if (currentUser && currentUser.uid !== 'local_user') {
                    try {
                        const currentHistory = localStorage.getItem('recentCardsHistory');
                        if (currentHistory) {
                            gamificationData.recentCardsHistory = JSON.parse(currentHistory);
                        }
                        await saveGamificationData();
                    } catch (e) {
                        console.error('Error saving gamification data to Firebase:', e);
                    }
                }

                alert(`登録完了\n成功: ${successCount}件\n失敗: ${failCount}件`);

                // Close modal and reload data
                bootstrap.Modal.getInstance(document.getElementById('bulk-import-modal')).hide();
                // Update metadata timestamp so cache system knows data changed
                await updateMetadataTimestamp();
                await loadCollectionFromFirestore();

            } catch (error) {
                console.error('Error during bulk registration:', error);
                alert('一括登録中にエラーが発生しました。');
            } finally {
                showLoading(false);
            }
        });

        // Note: checkVipStatus() is called in handleUserLogin() after authentication completes
        // Do not call it here as currentUser is still null at page load

        document.getElementById('delete-account-btn').addEventListener('click', async () => {
            if (!currentUser) return;
            if (!confirm('本当にアカウントを削除しますか？この操作は元に戻せません。')) return;
            if (!confirm('最終確認です。アカウントに紐づく全てのカードデータ、ランキング、プロフィール情報が永久に削除されます。よろしいですか？')) return;
            
            showLoading(true);
            try {
                // 1. Delete all card data from Firestore
                const userCardCollectionRef = getCollectionRef();
                const snapshot = await getDocs(query(userCardCollectionRef));
                const batch = writeBatch(db);
                snapshot.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();

                // 2. Delete ranking data
                try {
                    const rankingRef = doc(db, 'rankings', currentUser.uid);
                    await deleteDoc(rankingRef);
                } catch (rankingError) {
                    console.error('Error deleting ranking data:', rankingError);
                }

                // 3. Delete gamification data (including profile)
                try {
                    const gamificationRef = doc(db, 'userGamification', currentUser.uid);
                    await deleteDoc(gamificationRef);
                } catch (gamificationError) {
                    console.error('Error deleting gamification data:', gamificationError);
                }

                // 4. Delete wishlist data if exists
                try {
                    const wishlistRef = collection(db, 'users', currentUser.uid, 'wishlist');
                    const wishlistSnapshot = await getDocs(wishlistRef);
                    const wishlistBatch = writeBatch(db);
                    wishlistSnapshot.docs.forEach(doc => wishlistBatch.delete(doc.ref));
                    await wishlistBatch.commit();
                } catch (wishlistError) {
                    console.error('Error deleting wishlist data:', wishlistError);
                }

                // 5. Delete tags data if exists
                try {
                    const tagsRef = collection(db, 'users', currentUser.uid, 'tags');
                    const tagsSnapshot = await getDocs(tagsRef);
                    const tagsBatch = writeBatch(db);
                    tagsSnapshot.docs.forEach(doc => tagsBatch.delete(doc.ref));
                    await tagsBatch.commit();
                } catch (tagsError) {
                    console.error('Error deleting tags data:', tagsError);
                }

                // 6. Delete the user account
                await deleteUser(currentUser);
                await signOut(auth);
                alert('アカウントと全ての関連データが正常に削除されました。');
                settingsModal.hide();
            } catch (error) {
                showLoading(false);
                if (error.code === 'auth/requires-recent-login') {
                    alert('アカウント削除の前に、再ログインが必要です。一度ログアウトしてから、再度ログインし直した上でもう一度お試しください。');
                } else {
                    alert(`アカウントの削除中にエラーが発生しました: ${error.message}`);
                }
            }
        });

        // --- Search from Official DB ---
        let searchResultsData = { cards: [], currentPage: 1, itemsPerPage: 10 };
        let lastSearchKeyword = '';
        let lastRegistrationData = null;
        
        const renderSearchResults = (containerId = 'search-results') => {
            const container = document.getElementById(containerId);
            const startIndex = (searchResultsData.currentPage - 1) * searchResultsData.itemsPerPage;
            const endIndex = startIndex + searchResultsData.itemsPerPage;
            const paginatedCards = searchResultsData.cards.slice(startIndex, endIndex);
            const totalPages = Math.ceil(searchResultsData.cards.length / searchResultsData.itemsPerPage);
            
            container.innerHTML = '';
            
            if (searchResultsData.cards.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">検索結果が見つかりませんでした。</div>';
                return;
            }
            
            const header = document.createElement('div');
            header.className = containerId === 'search-results' ? 
                'alert alert-info mb-2 d-flex justify-content-between align-items-center flex-wrap gap-2' :
                'd-flex justify-content-between align-items-center mb-2';
            header.innerHTML = `
                <span>${containerId === 'search-results' ? '検索結果：' : ''}${searchResultsData.cards.length}件 (${searchResultsData.currentPage}/${totalPages}ページ)</span>
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-primary" ${searchResultsData.currentPage <= 1 ? 'disabled' : ''} onclick="changeSearchPage(${searchResultsData.currentPage - 1})">前へ</button>
                    <button class="btn btn-outline-primary" ${searchResultsData.currentPage >= totalPages ? 'disabled' : ''} onclick="changeSearchPage(${searchResultsData.currentPage + 1})">次へ</button>
                </div>
            `;
            container.appendChild(header);
            
            const listGroup = document.createElement('div');
            listGroup.className = 'list-group';
            
            paginatedCards.forEach(card => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'list-group-item list-group-item-action';
                button.textContent = card.name;
                button.dataset.cardUrl = card.url;
                button.onclick = () => fetchCardDetails(button.dataset.cardUrl);
                listGroup.appendChild(button);
            });
            
            container.appendChild(listGroup);
            
            if (totalPages > 1 && containerId === 'search-results') {
                const bottomControls = document.createElement('div');
                bottomControls.className = 'mt-2 d-flex justify-content-center';
                bottomControls.innerHTML = `
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-primary" ${searchResultsData.currentPage <= 1 ? 'disabled' : ''} onclick="changeSearchPage(${searchResultsData.currentPage - 1})">前へ</button>
                        <button class="btn btn-outline-primary" ${searchResultsData.currentPage >= totalPages ? 'disabled' : ''} onclick="changeSearchPage(${searchResultsData.currentPage + 1})">次へ</button>
                    </div>
                `;
                container.appendChild(bottomControls);
            }
        };
        
        window.changeSearchPage = (page) => {
            searchResultsData.currentPage = page;
            renderSearchResults();
        };
        
        // Add Enter key support for card search
        document.getElementById('card-search').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('search-db-btn').click();
            }
        });
        
        document.getElementById('search-db-btn').addEventListener('click', async () => {
            const searchKeyword = document.getElementById('card-search').value.trim();
            if (!searchKeyword) {
                alert('検索キーワードを入力してください。');
                return;
            }
            
            // Save search keyword
            lastSearchKeyword = searchKeyword;
            updateSearchHistoryButton();

            // First check if we have matching cards in our collection
            const normalizedSearchKeyword = normalizeForSearch(searchKeyword);
            const searchKeyLower = searchKeyword.toLowerCase();

            // Get possible card names from hiragana reading
            let possibleCardNames = [];
            if (cardReadingMap.has(searchKeyLower)) {
                possibleCardNames = cardReadingMap.get(searchKeyLower);
            }

            // Also check for partial matches in readings
            for (const [reading, cards] of cardReadingMap) {
                if (reading.includes(searchKeyLower)) {
                    possibleCardNames.push(...cards);
                }
            }

            // Remove duplicates
            possibleCardNames = [...new Set(possibleCardNames)];

            const matchingCards = cardCollection.filter(card => {
                const cardName = card.data['名前'];
                if (!cardName) return false;

                // Check direct name match
                if (normalizeForSearch(cardName).includes(normalizedSearchKeyword)) {
                    return true;
                }

                // Check if card name is in the possible names from hiragana reading
                if (possibleCardNames.includes(cardName)) {
                    return true;
                }

                return false;
            });
            
            if (matchingCards.length > 0) {
                // Show local cards first
                const resultsDiv = document.getElementById('search-results');
                resultsDiv.innerHTML = '';

                const localHeader = document.createElement('div');
                localHeader.className = 'alert alert-success mb-2';
                localHeader.innerHTML = `<strong>所持カードから見つかりました (${matchingCards.length}件)</strong>`;
                resultsDiv.appendChild(localHeader);

                const localListGroup = document.createElement('div');
                localListGroup.className = 'list-group mb-3';

                // Sort by name (50音順)
                matchingCards.sort((a, b) => (a.data['名前'] || '').localeCompare(b.data['名前'] || '', 'ja'));

                const ITEMS_PER_PAGE = 10;
                let localCardPage = 1;
                const totalPages = Math.ceil(matchingCards.length / ITEMS_PER_PAGE);

                const renderLocalPage = (page) => {
                    localListGroup.innerHTML = '';
                    const start = (page - 1) * ITEMS_PER_PAGE;
                    const end = Math.min(start + ITEMS_PER_PAGE, matchingCards.length);
                    const pageCards = matchingCards.slice(start, end);

                    pageCards.forEach(card => {
                        const tags = card.data.tags || [];
                        const tagsHtml = tags.map(t => `<span class="badge bg-info text-dark me-1" style="font-size:0.7rem;">${escapeHtml(t)}</span>`).join('');

                        const button = document.createElement('button');
                        button.type = 'button';
                        button.className = 'list-group-item list-group-item-action';
                        button.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${escapeHtml(card.data['名前'])}</strong>
                                    ${card.data['型番'] ? `<small class="text-muted ms-2">${escapeHtml(card.data['型番'])}</small>` : ''}
                                    ${card.data['レアリティ'] ? `<span class="badge bg-secondary ms-2">${escapeHtml(card.data['レアリティ'])}</span>` : ''}
                                    ${tagsHtml}
                                </div>
                                <span class="badge bg-primary">${card.data['枚数']}枚</span>
                            </div>
                        `;
                        button.onclick = () => {
                            document.getElementById('name').value = card.data['名前'];
                            document.getElementById('set_code').value = card.data['型番'] || '';
                            document.getElementById('rarity').value = card.data['レアリティ'] || '';
                            document.getElementById('quantity').value = 1;
                            resultsDiv.innerHTML = '';
                        };
                        localListGroup.appendChild(button);
                    });

                    // Pagination controls
                    if (totalPages > 1) {
                        const paginationDiv = document.createElement('div');
                        paginationDiv.className = 'd-flex justify-content-center align-items-center gap-2 mt-2';
                        paginationDiv.innerHTML = `
                            <button class="btn btn-sm btn-outline-secondary local-page-prev" ${page <= 1 ? 'disabled' : ''}>&laquo; 前</button>
                            <span class="text-muted" style="font-size:0.85rem;">${page} / ${totalPages}</span>
                            <button class="btn btn-sm btn-outline-secondary local-page-next" ${page >= totalPages ? 'disabled' : ''}>次 &raquo;</button>
                        `;
                        localListGroup.appendChild(paginationDiv);
                        paginationDiv.querySelector('.local-page-prev')?.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (localCardPage > 1) { localCardPage--; renderLocalPage(localCardPage); }
                        });
                        paginationDiv.querySelector('.local-page-next')?.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (localCardPage < totalPages) { localCardPage++; renderLocalPage(localCardPage); }
                        });
                    }
                };

                renderLocalPage(1);
                resultsDiv.appendChild(localListGroup);

                // Add separator
                const separator = document.createElement('div');
                separator.className = 'alert alert-info mb-2';
                separator.innerHTML = '公式DBからも検索しています...';
                resultsDiv.appendChild(separator);
            }
            
            showLoading(true);
            const searchUrl = `https://www.db.yugioh-card.com/yugiohdb/card_search.action?ope=1&sess=1&rp=100&mode=&sort=1&keyword=${encodeURIComponent(searchKeyword)}&stype=1&ctype=&othercon=2&starfr=&starto=&pscaleto=&linkmarkerfr=&linkmarkerto=&link_m=2&atkfr=&atkto=&deffr=&defto=&releaseDStart=1&releaseMStart=1&releaseYStart=1999&releaseDEnd=&releaseMEnd=&releaseYEnd=`;
            const proxyUrl = `${window.PROXY_URL}/card-list?url=${encodeURIComponent(searchUrl)}`;
            
            try {
                console.log('Fetching from proxy:', proxyUrl);
                const response = await fetch(proxyUrl);
                console.log('Proxy response:', response);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                console.log('Parsed JSON data:', data);
                
                // Store search results
                searchResultsData.cards = [];
                if (data.cards) {
                    data.cards.forEach(card => {
                        searchResultsData.cards.push({
                            name: card.name,
                            url: `https://www.db.yugioh-card.com/yugiohdb/card_search.action?ope=2&cid=${card.id}`
                        });
                    });
                }
                searchResultsData.currentPage = 1;
                
                // Render paginated results - append to existing local results if any
                if (matchingCards.length > 0) {
                    // Remove the "searching" message
                    const resultsDiv = document.getElementById('search-results');
                    const lastChild = resultsDiv.lastElementChild;
                    if (lastChild && lastChild.classList.contains('alert-info') && lastChild.innerHTML.includes('検索しています')) {
                        resultsDiv.removeChild(lastChild);
                    }
                    
                    // Add official DB results header
                    const dbHeader = document.createElement('div');
                    dbHeader.className = 'alert alert-info mb-2';
                    dbHeader.innerHTML = `<strong>公式DBの検索結果</strong>`;
                    resultsDiv.appendChild(dbHeader);
                    
                    // Create a container for paginated results
                    const dbResultsContainer = document.createElement('div');
                    dbResultsContainer.id = 'db-search-results';
                    resultsDiv.appendChild(dbResultsContainer);
                    
                    renderSearchResultsToContainer('db-search-results');
                } else {
                    renderSearchResults();
                }
            } catch (err) {
                console.error('Search error:', err);
                alert(`検索エラー: ${err.message}`);
            } finally {
                showLoading(false);
            }
        });
        
        const renderSearchResultsToContainer = (containerId) => renderSearchResults(containerId);
        
        const fetchCardDetails = async (cardUrl) => {
            showLoading(true);
            try {
                const url = new URL(cardUrl);
                const cid = url.searchParams.get('cid');
                if (!cid) throw new Error('Card ID (cid) not found in URL');

                const proxyUrl = `${window.PROXY_URL}/card-detail?cid=${cid}`;
                
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                if (!data.cardName || data.cardName === 'Unknown Card') {
                    throw new Error("カード名が見つかりません。");
                }

                document.getElementById('name').value = data.cardName;

                const choicesEl = document.getElementById('set-rarity-choices');
                choicesEl.innerHTML = '';

                if (data.reprints && data.reprints.length > 0) {
                    const uniqueReprints = new Map();
                    data.reprints.forEach(reprint => {
                        const key = `${reprint.setCode}_${reprint.rarity}`;
                        if (!uniqueReprints.has(key)) {
                            uniqueReprints.set(key, reprint);
                        }
                    });

                    uniqueReprints.forEach(reprint => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'btn btn-outline-primary btn-sm m-1 set-choice-btn';
                        btn.dataset.setCode = reprint.setCode;
                        btn.dataset.rarity = reprint.rarity;
                        btn.textContent = `${reprint.setCode} (${reprint.rarity})`;
                        choicesEl.appendChild(btn);
                    });
                } else {
                    choicesEl.textContent = '収録情報が見つかりません。';
                }

                // Clear search results
                document.getElementById('search-results').innerHTML = '';
                document.getElementById('card-search').value = '';
            } catch (err) {
                console.error('Fetch card details error:', err);
                alert(`エラー: ${err.message}`);
            } finally {
                showLoading(false);
            }
        };
        
        // --- Fetch from URL ---
        document.getElementById('fetch-btn').addEventListener('click', async () => {
            const urlInput = document.getElementById('url-input').value.trim();
            if (!urlInput) {
                alert('URLを入力してください。');
                return;
            }
            showLoading(true);
            try {
                const url = new URL(urlInput);
                const cid = url.searchParams.get('cid');
                if (!cid) throw new Error('Card ID (cid) not found in URL');

                const proxyUrl = `${window.PROXY_URL}/card-detail?cid=${cid}`;

                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                if (!data.cardName || data.cardName === 'Unknown Card') {
                    throw new Error("カード名が見つかりません。");
                }

                document.getElementById('name').value = data.cardName;

                const choicesEl = document.getElementById('set-rarity-choices');
                choicesEl.innerHTML = '';

                if (data.reprints && data.reprints.length > 0) {
                    const uniqueReprints = new Map();
                    data.reprints.forEach(reprint => {
                        const key = `${reprint.setCode}_${reprint.rarity}`;
                        if (!uniqueReprints.has(key)) {
                            uniqueReprints.set(key, reprint);
                        }
                    });

                    uniqueReprints.forEach(reprint => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'btn btn-outline-primary btn-sm m-1 set-choice-btn';
                        btn.dataset.setCode = reprint.setCode;
                        btn.dataset.rarity = reprint.rarity;
                        btn.textContent = `${reprint.setCode} (${reprint.rarity})`;
                        choicesEl.appendChild(btn);
                    });
                } else {
                    choicesEl.textContent = '収録情報が見つかりません。';
                }
            } catch (err) {
                console.error('Fetch from URL error:', err);
                alert(`エラー: ${err.message}`);
            } finally {
                showLoading(false);
            }
        });
        document.getElementById('set-rarity-choices').addEventListener('click', (e) => {
            if (e.target.classList.contains('set-choice-btn')) {
                document.getElementById('set_code').value = e.target.dataset.setCode;
                document.getElementById('rarity').value = e.target.dataset.rarity;
            }
        });

        // Quantity +/- buttons for card registration
        document.getElementById('quantity-decrease').addEventListener('click', () => {
            const quantityInput = document.getElementById('quantity');
            const currentValue = parseInt(quantityInput.value) || 1;
            const minValue = parseInt(quantityInput.min) || 1;
            if (currentValue > minValue) {
                quantityInput.value = currentValue - 1;
            }
        });

        document.getElementById('quantity-increase').addEventListener('click', () => {
            const quantityInput = document.getElementById('quantity');
            const currentValue = parseInt(quantityInput.value) || 1;
            quantityInput.value = currentValue + 1;
        });
    </script>
</body>
</html>

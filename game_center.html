<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>遊戯王カードゲームセンター</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
        }

        .game-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .game-header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .game-title {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .game-menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .game-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: transform 0.3s;
            cursor: pointer;
        }

        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        .game-area {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
        }

        .game-area.active {
            display: block;
        }

        /* Memory Game Styles */
        .memory-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        .memory-card {
            aspect-ratio: 59/86;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .memory-card.flip {
            transform: rotateY(180deg);
        }

        .memory-card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 10px;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .memory-card-back {
            background: linear-gradient(135deg, #8B4513, #D2691E);
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255,255,255,.05) 10px,
                rgba(255,255,255,.05) 20px
            );
        }

        .memory-card-front {
            transform: rotateY(180deg);
            background: linear-gradient(135deg, #4CAF50, #45a049);
            flex-direction: column;
            padding: 10px;
            text-align: center;
            font-size: 0.9rem;
        }

        .memory-card-front .card-name {
            font-size: 0.8rem;
            margin-bottom: 5px;
        }

        .memory-card-front .card-stats {
            font-size: 0.7rem;
            opacity: 0.9;
        }

        .memory-card.matched {
            animation: matchPulse 0.5s;
            pointer-events: none;
            opacity: 0.8;
        }

        @keyframes matchPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Quiz Game Styles */
        .quiz-card {
            background: linear-gradient(135deg, #f5f5f5, #e0e0e0);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .quiz-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .quiz-option {
            padding: 15px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quiz-option:hover {
            background: #f0f0f0;
            border-color: #4CAF50;
        }

        .quiz-option.correct {
            background: #d4edda;
            border-color: #28a745;
            animation: correctPulse 0.5s;
        }

        .quiz-option.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
            animation: shake 0.5s;
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Battle Game Styles */
        .battle-field {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .battle-player {
            padding: 20px;
            background: linear-gradient(135deg, #f5f5f5, #e0e0e0);
            border-radius: 15px;
            text-align: center;
        }

        .battle-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .battle-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }

        .stat-badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            color: white;
        }

        .stat-atk {
            background: #dc3545;
        }

        .stat-def {
            background: #007bff;
        }

        .life-bar {
            width: 100%;
            height: 30px;
            background: #ddd;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }

        .life-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.5s;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }

        .score-display {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            display: inline-block;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .memory-board {
                grid-template-columns: repeat(3, 1fr);
            }

            .quiz-options {
                grid-template-columns: 1fr;
            }

            .battle-field {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <a href="index.html" class="btn btn-light back-btn">
        <i class="bi bi-arrow-left"></i> 戻る
    </a>

    <div class="game-container">
        <div class="game-header">
            <h1 class="game-title">
                <i class="bi bi-controller"></i> 遊戯王カードゲームセンター
            </h1>
            <p class="text-muted">カードを使った楽しいミニゲームで遊ぼう！</p>
        </div>

        <!-- Game Menu -->
        <div class="game-menu" id="gameMenu">
            <div class="game-card" onclick="startMemoryGame()">
                <h3><i class="bi bi-grid-3x3"></i> 神経衰弱</h3>
                <p>同じカードのペアを見つけよう！</p>
                <div class="text-warning">
                    <i class="bi bi-star-fill"></i> 難易度: ★★☆
                </div>
            </div>

            <div class="game-card" onclick="startQuizGame()">
                <h3><i class="bi bi-question-circle"></i> カードクイズ</h3>
                <p>カードの知識を試そう！</p>
                <div class="text-warning">
                    <i class="bi bi-star-fill"></i> 難易度: ★☆☆
                </div>
            </div>

            <div class="game-card" onclick="startBattleGame()">
                <h3><i class="bi bi-lightning"></i> カードバトル</h3>
                <p>簡単なカードバトルを楽しもう！</p>
                <div class="text-warning">
                    <i class="bi bi-star-fill"></i> 難易度: ★★★
                </div>
            </div>

            <div class="game-card" onclick="startSlotGame()">
                <h3><i class="bi bi-dice-3"></i> カードスロット</h3>
                <p>3枚のカードを揃えよう！</p>
                <div class="text-warning">
                    <i class="bi bi-star-fill"></i> 難易度: ★☆☆
                </div>
            </div>

            <div class="game-card" onclick="startAttributeGame()">
                <h3><i class="bi bi-gem"></i> 属性当てゲーム</h3>
                <p>カードの属性を当てよう！</p>
                <div class="text-warning">
                    <i class="bi bi-star-fill"></i> 難易度: ★★☆
                </div>
            </div>

            <div class="game-card" onclick="startHighLowGame()">
                <h3><i class="bi bi-arrow-up-down"></i> ハイ&ロー</h3>
                <p>次のカードの攻撃力は高い？低い？</p>
                <div class="text-warning">
                    <i class="bi bi-star-fill"></i> 難易度: ★☆☆
                </div>
            </div>
        </div>

        <!-- Memory Game Area -->
        <div class="game-area" id="memoryGame">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2><i class="bi bi-grid-3x3"></i> 神経衰弱</h2>
                <button class="btn btn-secondary" onclick="backToMenu()">
                    <i class="bi bi-arrow-left"></i> メニューに戻る
                </button>
            </div>
            <div class="text-center mb-3">
                <div class="score-display">
                    <i class="bi bi-trophy"></i> スコア: <span id="memoryScore">0</span>
                </div>
                <div class="score-display ms-2">
                    <i class="bi bi-clock"></i> 時間: <span id="memoryTime">0</span>秒
                </div>
                <div class="score-display ms-2">
                    <i class="bi bi-hand-index"></i> 試行回数: <span id="memoryTries">0</span>
                </div>
            </div>
            <div class="memory-board" id="memoryBoard"></div>
            <div class="text-center mt-3">
                <button class="btn btn-primary" onclick="resetMemoryGame()">
                    <i class="bi bi-arrow-clockwise"></i> リセット
                </button>
            </div>
        </div>

        <!-- Quiz Game Area -->
        <div class="game-area" id="quizGame">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2><i class="bi bi-question-circle"></i> カードクイズ</h2>
                <button class="btn btn-secondary" onclick="backToMenu()">
                    <i class="bi bi-arrow-left"></i> メニューに戻る
                </button>
            </div>
            <div class="text-center mb-3">
                <div class="score-display">
                    <i class="bi bi-check-circle"></i> 正解: <span id="quizCorrect">0</span>
                </div>
                <div class="score-display ms-2">
                    <i class="bi bi-x-circle"></i> 不正解: <span id="quizWrong">0</span>
                </div>
                <div class="score-display ms-2">
                    <i class="bi bi-percent"></i> 正答率: <span id="quizRate">0</span>%
                </div>
            </div>
            <div class="quiz-card">
                <h4 id="quizQuestion">問題を読み込んでいます...</h4>
                <div class="quiz-options" id="quizOptions"></div>
            </div>
            <div class="text-center mt-3">
                <button class="btn btn-primary" onclick="nextQuizQuestion()">
                    <i class="bi bi-arrow-right"></i> 次の問題
                </button>
            </div>
        </div>

        <!-- Slot Game Area -->
        <div class="game-area" id="slotGame">
            <h2>カードスロット</h2>
            <div class="text-center">
                <div class="slot-machine" style="display: flex; justify-content: center; gap: 20px; margin: 30px 0;">
                    <div class="slot-reel" id="slot1" style="width: 150px; height: 200px; border: 3px solid gold; border-radius: 10px; display: flex; align-items: center; justify-content: center; background: white; font-size: 1.2rem;">
                        <div>?</div>
                    </div>
                    <div class="slot-reel" id="slot2" style="width: 150px; height: 200px; border: 3px solid gold; border-radius: 10px; display: flex; align-items: center; justify-content: center; background: white; font-size: 1.2rem;">
                        <div>?</div>
                    </div>
                    <div class="slot-reel" id="slot3" style="width: 150px; height: 200px; border: 3px solid gold; border-radius: 10px; display: flex; align-items: center; justify-content: center; background: white; font-size: 1.2rem;">
                        <div>?</div>
                    </div>
                </div>
                <button class="btn btn-lg btn-success" onclick="spinSlot()">スピン！</button>
                <div class="mt-3">
                    <div class="score-display">スコア: <span id="slotScore">0</span></div>
                    <div id="slotResult" class="mt-3"></div>
                </div>
            </div>
            <button class="btn btn-secondary mt-3" onclick="exitSlotGame()">戻る</button>
        </div>

        <!-- Attribute Game Area -->
        <div class="game-area" id="attributeGame">
            <h2>属性当てゲーム</h2>
            <div class="text-center">
                <div id="attributeCard" style="background: white; border-radius: 10px; padding: 20px; margin: 20px auto; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                    <h3 id="attributeCardName">カード名</h3>
                    <div class="mt-3" style="font-size: 1.2rem;">
                        <div>攻撃力: <span id="attributeAttack">?</span></div>
                        <div>守備力: <span id="attributeDefense">?</span></div>
                    </div>
                </div>
                <div class="quiz-options">
                    <button class="quiz-option" onclick="checkAttribute('光')">光</button>
                    <button class="quiz-option" onclick="checkAttribute('闇')">闇</button>
                    <button class="quiz-option" onclick="checkAttribute('炎')">炎</button>
                    <button class="quiz-option" onclick="checkAttribute('水')">水</button>
                    <button class="quiz-option" onclick="checkAttribute('風')">風</button>
                    <button class="quiz-option" onclick="checkAttribute('地')">地</button>
                </div>
                <div class="mt-3">
                    <div class="score-display">正解: <span id="attributeCorrect">0</span> / <span id="attributeTotal">0</span></div>
                </div>
            </div>
            <button class="btn btn-secondary mt-3" onclick="exitAttributeGame()">戻る</button>
        </div>

        <!-- High Low Game Area -->
        <div class="game-area" id="highLowGame">
            <h2>ハイ&ローゲーム</h2>
            <div class="text-center">
                <div style="display: flex; justify-content: center; gap: 30px; margin: 30px 0;">
                    <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                        <h4>現在のカード</h4>
                        <div id="currentHighLowCard">
                            <h5 id="hlCurrentName">カード名</h5>
                            <div class="stat-badge stat-atk">攻撃力: <span id="hlCurrentAtk">?</span></div>
                        </div>
                    </div>
                    <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                        <h4>次のカード</h4>
                        <div id="nextHighLowCard">
                            <h5 id="hlNextName">???</h5>
                            <div class="stat-badge stat-atk">攻撃力: ???</div>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-lg btn-danger" onclick="guessHighLow('high')">高い ↑</button>
                    <button class="btn btn-lg btn-primary" onclick="guessHighLow('low')">低い ↓</button>
                </div>
                <div class="mt-3">
                    <div class="score-display">連続正解: <span id="hlStreak">0</span></div>
                    <div class="score-display">最高記録: <span id="hlBest">0</span></div>
                </div>
            </div>
            <button class="btn btn-secondary mt-3" onclick="exitHighLowGame()">戻る</button>
        </div>

        <!-- Battle Game Area -->
        <div class="game-area" id="battleGame">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2><i class="bi bi-lightning"></i> カードバトル</h2>
                <button class="btn btn-secondary" onclick="backToMenu()">
                    <i class="bi bi-arrow-left"></i> メニューに戻る
                </button>
            </div>
            <div class="battle-field">
                <div class="battle-player">
                    <h4>プレイヤー</h4>
                    <div class="score-display">LP: <span id="playerLP">8000</span></div>
                    <div class="life-bar">
                        <div class="life-fill" id="playerLifeBar" style="width: 100%"></div>
                    </div>
                    <div class="battle-card" id="playerCard">
                        <h5>カードを選択</h5>
                    </div>
                    <button class="btn btn-primary w-100" onclick="drawPlayerCard()">
                        <i class="bi bi-stack"></i> カードを引く
                    </button>
                </div>
                <div class="battle-player">
                    <h4>CPU</h4>
                    <div class="score-display">LP: <span id="cpuLP">8000</span></div>
                    <div class="life-bar">
                        <div class="life-fill" id="cpuLifeBar" style="width: 100%"></div>
                    </div>
                    <div class="battle-card" id="cpuCard">
                        <h5>待機中...</h5>
                    </div>
                </div>
            </div>
            <div class="text-center mt-3">
                <button class="btn btn-danger btn-lg" onclick="battleAttack()" id="attackBtn" disabled>
                    <i class="bi bi-lightning-fill"></i> 攻撃！
                </button>
                <button class="btn btn-warning btn-lg ms-2" onclick="resetBattleGame()">
                    <i class="bi bi-arrow-clockwise"></i> リセット
                </button>
            </div>
        </div>
    </div>

    <script>
        // Sample card data (will be replaced with actual data from CSV)
        let cardDatabase = [
            { name: "ブラック・マジシャン", reading: "ブラックマジシャン", attack: 2500, defense: 2100, level: 7, attribute: "闇", type: "魔法使い族" },
            { name: "青眼の白龍", reading: "ブルーアイズホワイトドラゴン", attack: 3000, defense: 2500, level: 8, attribute: "光", type: "ドラゴン族" },
            { name: "真紅眼の黒竜", reading: "レッドアイズブラックドラゴン", attack: 2400, defense: 2000, level: 7, attribute: "闇", type: "ドラゴン族" },
            { name: "エレメンタルヒーロー ネオス", reading: "エレメンタルヒーロー ネオス", attack: 2500, defense: 2000, level: 7, attribute: "光", type: "戦士族" },
            { name: "スターダスト・ドラゴン", reading: "スターダストドラゴン", attack: 2500, defense: 2000, level: 8, attribute: "風", type: "ドラゴン族" },
            { name: "ホープ", reading: "ホープ", attack: 2500, defense: 2000, level: 4, attribute: "光", type: "戦士族" },
            { name: "オッドアイズ・ペンデュラム・ドラゴン", reading: "オッドアイズペンデュラムドラゴン", attack: 2500, defense: 2000, level: 7, attribute: "闇", type: "ドラゴン族" },
            { name: "デコード・トーカー", reading: "デコードトーカー", attack: 2300, defense: 0, level: 3, attribute: "闇", type: "サイバース族" }
        ];

        // Load card data from CSV if available
        async function loadCardDatabase() {
            try {
                const response = await fetch('yugioh_cards_master.csv');
                if (!response.ok) {
                    throw new Error('CSV file not found');
                }

                let csvText = await response.text();

                // Remove BOM if present
                if (csvText.charCodeAt(0) === 0xFEFF) {
                    csvText = csvText.substring(1);
                }

                const lines = csvText.split('\n');
                const headers = lines[0].split(',');
                const hasCardId = headers[0].includes('カードID') || headers[0].includes('ID');

                const loadedCards = [];

                // Load all cards for better randomization
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    const values = [];
                    let current = '';
                    let inQuotes = false;

                    for (let j = 0; j < line.length; j++) {
                        const char = line[j];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            values.push(current);
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    values.push(current);

                    let name, reading, level, attribute, race, attack, defense;

                    if (hasCardId) {
                        [, name, reading, level, attribute, race, , attack, defense] = values;
                    } else {
                        [name, reading, level, attribute, race, , attack, defense] = values;
                    }

                    // Include all cards, even without attack/defense
                    if (name) {
                        loadedCards.push({
                            name: name?.replace(/^"|"$/g, '').trim(),
                            reading: reading?.replace(/^"|"$/g, '').trim() || name,
                            attack: parseInt(attack?.replace(/^"|"$/g, '').trim()) || 0,
                            defense: parseInt(defense?.replace(/^"|"$/g, '').trim()) || 0,
                            level: parseInt(level?.replace(/^"|"$/g, '').trim()) || 1,
                            attribute: attribute?.replace(/^"|"$/g, '').trim() || '無',
                            race: race?.replace(/^"|"$/g, '').trim() || '不明',
                            type: race?.replace(/^"|"$/g, '').trim() || '不明'
                        });
                    }
                }

                if (loadedCards.length > 0) {
                    cardDatabase = loadedCards.slice(0, 20); // Use first 20 cards for games
                    console.log(`Loaded ${cardDatabase.length} cards from CSV`);
                }
            } catch (error) {
                console.log('Using default card database:', error);
            }
        }

        // Initialize
        loadCardDatabase();

        // Memory Game Logic
        let memoryCards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let memoryScore = 0;
        let memoryTries = 0;
        let memoryTimer = null;
        let memorySeconds = 0;

        function startMemoryGame() {
            document.getElementById('gameMenu').style.display = 'none';
            document.getElementById('memoryGame').classList.add('active');
            resetMemoryGame();
        }

        function getRandomCards(count) {
            // Better randomization: shuffle entire database then pick
            const shuffled = [...cardDatabase];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            // Filter out cards without required data for games
            const validCards = shuffled.filter(card => card.attack && card.defense);
            return validCards.slice(0, Math.min(count, validCards.length));
        }

        function resetMemoryGame() {
            // Select 6 random cards and duplicate them for pairs
            const selectedCards = getRandomCards(6);
            memoryCards = [...selectedCards, ...selectedCards].sort(() => 0.5 - Math.random());

            flippedCards = [];
            matchedPairs = 0;
            memoryScore = 0;
            memoryTries = 0;
            memorySeconds = 0;

            updateMemoryDisplay();
            renderMemoryBoard();

            // Start timer
            clearInterval(memoryTimer);
            memoryTimer = setInterval(() => {
                memorySeconds++;
                document.getElementById('memoryTime').textContent = memorySeconds;
            }, 1000);
        }

        function renderMemoryBoard() {
            const board = document.getElementById('memoryBoard');
            board.innerHTML = '';

            memoryCards.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.className = 'memory-card';
                cardElement.dataset.index = index;
                cardElement.innerHTML = `
                    <div class="memory-card-face memory-card-back">
                        <i class="bi bi-star-fill" style="font-size: 2rem;"></i>
                    </div>
                    <div class="memory-card-face memory-card-front">
                        <div class="card-name">${card.name}</div>
                        <div class="card-stats">ATK: ${card.attack}</div>
                    </div>
                `;
                cardElement.addEventListener('click', () => flipMemoryCard(index));
                board.appendChild(cardElement);
            });
        }

        function flipMemoryCard(index) {
            if (flippedCards.length >= 2) return;

            const card = document.querySelector(`.memory-card[data-index="${index}"]`);
            if (card.classList.contains('flip') || card.classList.contains('matched')) return;

            card.classList.add('flip');
            flippedCards.push(index);

            if (flippedCards.length === 2) {
                memoryTries++;
                checkMemoryMatch();
            }
        }

        function checkMemoryMatch() {
            const [first, second] = flippedCards;
            const firstCard = memoryCards[first];
            const secondCard = memoryCards[second];

            if (firstCard.name === secondCard.name) {
                // Match found!
                setTimeout(() => {
                    document.querySelector(`.memory-card[data-index="${first}"]`).classList.add('matched');
                    document.querySelector(`.memory-card[data-index="${second}"]`).classList.add('matched');
                    matchedPairs++;
                    memoryScore += 100;

                    if (matchedPairs === 6) {
                        clearInterval(memoryTimer);
                        const bonus = Math.max(0, 1000 - memorySeconds * 10);
                        memoryScore += bonus;
                        alert(`完成！\nスコア: ${memoryScore}\n時間: ${memorySeconds}秒\n試行回数: ${memoryTries}`);
                    }

                    updateMemoryDisplay();
                    flippedCards = [];
                }, 500);
            } else {
                // No match
                setTimeout(() => {
                    document.querySelector(`.memory-card[data-index="${first}"]`).classList.remove('flip');
                    document.querySelector(`.memory-card[data-index="${second}"]`).classList.remove('flip');
                    flippedCards = [];
                }, 1000);
            }
        }

        function updateMemoryDisplay() {
            document.getElementById('memoryScore').textContent = memoryScore;
            document.getElementById('memoryTries').textContent = memoryTries;
        }

        // Quiz Game Logic
        let quizCorrect = 0;
        let quizWrong = 0;
        let currentQuizCard = null;

        function startQuizGame() {
            document.getElementById('gameMenu').style.display = 'none';
            document.getElementById('quizGame').classList.add('active');
            quizCorrect = 0;
            quizWrong = 0;
            updateQuizDisplay();
            nextQuizQuestion();
        }

        function nextQuizQuestion() {
            currentQuizCard = getRandomCards(1)[0];
            const questionTypes = [
                {
                    question: `「${currentQuizCard.name}」の攻撃力は？`,
                    correct: currentQuizCard.attack,
                    generator: () => parseInt(currentQuizCard.attack) + (Math.floor(Math.random() * 4) - 2) * 100
                },
                {
                    question: `「${currentQuizCard.name}」の守備力は？`,
                    correct: currentQuizCard.defense,
                    generator: () => parseInt(currentQuizCard.defense) + (Math.floor(Math.random() * 4) - 2) * 100
                },
                {
                    question: `「${currentQuizCard.name}」の属性は？`,
                    correct: currentQuizCard.attribute,
                    options: ["光", "闇", "炎", "水", "風", "地"]
                },
                {
                    question: `攻撃力${currentQuizCard.attack}のカードは？`,
                    correct: currentQuizCard.name,
                    options: cardDatabase.map(c => c.name)
                }
            ];

            const questionType = questionTypes[Math.floor(Math.random() * questionTypes.length)];
            document.getElementById('quizQuestion').textContent = questionType.question;

            const options = new Set([questionType.correct]);

            if (questionType.options) {
                while (options.size < 4 && options.size < questionType.options.length) {
                    options.add(questionType.options[Math.floor(Math.random() * questionType.options.length)]);
                }
            } else {
                while (options.size < 4) {
                    const wrong = questionType.generator();
                    if (wrong >= 0) options.add(wrong);
                }
            }

            const optionsArray = Array.from(options).sort(() => 0.5 - Math.random());
            const optionsContainer = document.getElementById('quizOptions');
            optionsContainer.innerHTML = '';

            optionsArray.forEach(option => {
                const btn = document.createElement('div');
                btn.className = 'quiz-option';
                btn.textContent = option;
                btn.onclick = () => checkQuizAnswer(option, questionType.correct);
                optionsContainer.appendChild(btn);
            });
        }

        function checkQuizAnswer(selected, correct) {
            const options = document.querySelectorAll('.quiz-option');
            options.forEach(opt => {
                opt.onclick = null;
                if (opt.textContent == correct) {
                    opt.classList.add('correct');
                } else if (opt.textContent == selected) {
                    opt.classList.add('incorrect');
                }
            });

            if (selected == correct) {
                quizCorrect++;
            } else {
                quizWrong++;
            }

            updateQuizDisplay();
        }

        function updateQuizDisplay() {
            document.getElementById('quizCorrect').textContent = quizCorrect;
            document.getElementById('quizWrong').textContent = quizWrong;
            const rate = quizCorrect + quizWrong > 0
                ? Math.round(quizCorrect / (quizCorrect + quizWrong) * 100)
                : 0;
            document.getElementById('quizRate').textContent = rate;
        }

        // Battle Game Logic
        let playerLP = 8000;
        let cpuLP = 8000;
        let playerCurrentCard = null;
        let cpuCurrentCard = null;

        function startBattleGame() {
            document.getElementById('gameMenu').style.display = 'none';
            document.getElementById('battleGame').classList.add('active');
            resetBattleGame();
        }

        function resetBattleGame() {
            playerLP = 8000;
            cpuLP = 8000;
            playerCurrentCard = null;
            cpuCurrentCard = null;
            updateBattleDisplay();
            document.getElementById('playerCard').innerHTML = '<h5>カードを選択</h5>';
            document.getElementById('cpuCard').innerHTML = '<h5>待機中...</h5>';
            document.getElementById('attackBtn').disabled = true;
        }

        function drawPlayerCard() {
            playerCurrentCard = getRandomCards(1)[0];
            renderBattleCard('playerCard', playerCurrentCard);

            // CPU also draws a card
            cpuCurrentCard = getRandomCards(1)[0];
            renderBattleCard('cpuCard', cpuCurrentCard);

            document.getElementById('attackBtn').disabled = false;
        }

        function renderBattleCard(elementId, card) {
            document.getElementById(elementId).innerHTML = `
                <h5>${card.name}</h5>
                <small class="text-muted">${card.type} / ${card.attribute}</small>
                <div class="battle-stats">
                    <span class="stat-badge stat-atk">ATK: ${card.attack}</span>
                    <span class="stat-badge stat-def">DEF: ${card.defense}</span>
                </div>
            `;
        }

        function battleAttack() {
            if (!playerCurrentCard || !cpuCurrentCard) return;

            const damage = playerCurrentCard.attack - cpuCurrentCard.defense;

            if (damage > 0) {
                cpuLP = Math.max(0, cpuLP - damage);
                alert(`攻撃成功！${damage}ダメージ！`);
            } else {
                playerLP = Math.max(0, playerLP - Math.abs(damage));
                alert(`攻撃失敗！${Math.abs(damage)}ダメージを受けた！`);
            }

            updateBattleDisplay();

            if (playerLP === 0) {
                alert('敗北...');
                resetBattleGame();
            } else if (cpuLP === 0) {
                alert('勝利！');
                resetBattleGame();
            } else {
                // Draw new cards
                drawPlayerCard();
            }
        }

        function updateBattleDisplay() {
            document.getElementById('playerLP').textContent = playerLP;
            document.getElementById('cpuLP').textContent = cpuLP;
            document.getElementById('playerLifeBar').style.width = (playerLP / 8000 * 100) + '%';
            document.getElementById('cpuLifeBar').style.width = (cpuLP / 8000 * 100) + '%';
        }

        // Navigation
        function backToMenu() {
            document.querySelectorAll('.game-area').forEach(area => {
                area.classList.remove('active');
            });
            document.getElementById('gameMenu').style.display = 'grid';

            // Clear timers
            clearInterval(memoryTimer);
        }

        // Slot Game Logic
        let slotScore = 0;
        let isSpinning = false;

        function startSlotGame() {
            document.getElementById('gameMenu').style.display = 'none';
            document.getElementById('slotGame').classList.add('active');
            slotScore = 0;
            document.getElementById('slotScore').textContent = slotScore;
            document.getElementById('slotResult').innerHTML = '';
        }

        function spinSlot() {
            if (isSpinning) return;
            isSpinning = true;

            const slots = ['slot1', 'slot2', 'slot3'];
            const results = [];

            // Animate spinning
            slots.forEach((slotId, index) => {
                const slot = document.getElementById(slotId);
                slot.style.animation = 'pulse 0.1s infinite';

                setTimeout(() => {
                    const randomCard = getRandomCards(1)[0];
                    results.push(randomCard);
                    slot.innerHTML = `
                        <div style="text-align: center; padding: 10px;">
                            <div style="font-weight: bold;">${randomCard.name}</div>
                            <div style="font-size: 0.9rem;">ATK: ${randomCard.attack}</div>
                        </div>
                    `;
                    slot.style.animation = '';

                    if (index === 2) {
                        checkSlotResult(results);
                        isSpinning = false;
                    }
                }, 1000 + (index * 500));
            });
        }

        function checkSlotResult(cards) {
            const resultDiv = document.getElementById('slotResult');
            let points = 0;
            let message = '';

            // Check for matching attributes
            if (cards[0].attribute === cards[1].attribute && cards[1].attribute === cards[2].attribute) {
                points = 1000;
                message = `<div class="alert alert-success">属性一致！ +${points}点</div>`;
            }
            // Check for matching races
            else if (cards[0].race === cards[1].race && cards[1].race === cards[2].race) {
                points = 500;
                message = `<div class="alert alert-warning">種族一致！ +${points}点</div>`;
            }
            // Check for matching attack power
            else if (cards[0].attack === cards[1].attack && cards[1].attack === cards[2].attack) {
                points = 2000;
                message = `<div class="alert alert-success">攻撃力完全一致！ +${points}点</div>`;
            }
            // Partial matches
            else if (cards[0].attribute === cards[1].attribute || cards[1].attribute === cards[2].attribute || cards[0].attribute === cards[2].attribute) {
                points = 100;
                message = `<div class="alert alert-info">属性2枚一致 +${points}点</div>`;
            } else {
                message = `<div class="alert alert-secondary">残念...</div>`;
            }

            slotScore += points;
            document.getElementById('slotScore').textContent = slotScore;
            resultDiv.innerHTML = message;
        }

        function exitSlotGame() {
            document.getElementById('slotGame').classList.remove('active');
            document.getElementById('gameMenu').style.display = 'grid';
        }

        // Attribute Game Logic
        let currentAttributeCard = null;
        let attributeCorrect = 0;
        let attributeTotal = 0;

        function startAttributeGame() {
            document.getElementById('gameMenu').style.display = 'none';
            document.getElementById('attributeGame').classList.add('active');
            attributeCorrect = 0;
            attributeTotal = 0;
            updateAttributeScore();
            nextAttributeCard();
        }

        function nextAttributeCard() {
            currentAttributeCard = getRandomCards(1)[0];
            document.getElementById('attributeCardName').textContent = currentAttributeCard.name;
            document.getElementById('attributeAttack').textContent = currentAttributeCard.attack;
            document.getElementById('attributeDefense').textContent = currentAttributeCard.defense;
        }

        function checkAttribute(guess) {
            attributeTotal++;
            const buttons = document.querySelectorAll('#attributeGame .quiz-option');

            if (guess === currentAttributeCard.attribute) {
                attributeCorrect++;
                buttons.forEach(btn => {
                    if (btn.textContent === guess) {
                        btn.classList.add('btn-success');
                    }
                });
            } else {
                buttons.forEach(btn => {
                    if (btn.textContent === guess) {
                        btn.classList.add('btn-danger');
                    }
                    if (btn.textContent === currentAttributeCard.attribute) {
                        btn.classList.add('btn-success');
                    }
                });
            }

            updateAttributeScore();

            setTimeout(() => {
                buttons.forEach(btn => {
                    btn.classList.remove('btn-success', 'btn-danger');
                });
                nextAttributeCard();
            }, 1500);
        }

        function updateAttributeScore() {
            document.getElementById('attributeCorrect').textContent = attributeCorrect;
            document.getElementById('attributeTotal').textContent = attributeTotal;
        }

        function exitAttributeGame() {
            document.getElementById('attributeGame').classList.remove('active');
            document.getElementById('gameMenu').style.display = 'grid';
        }

        // High Low Game Logic
        let currentHLCard = null;
        let nextHLCard = null;
        let hlStreak = 0;
        let hlBest = 0;

        function startHighLowGame() {
            document.getElementById('gameMenu').style.display = 'none');
            document.getElementById('highLowGame').classList.add('active');
            hlStreak = 0;
            initHighLow();
        }

        function initHighLow() {
            currentHLCard = getRandomCards(1)[0];
            nextHLCard = getRandomCards(1)[0];

            document.getElementById('hlCurrentName').textContent = currentHLCard.name;
            document.getElementById('hlCurrentAtk').textContent = currentHLCard.attack;
            document.getElementById('hlNextName').textContent = '???';

            updateHLScore();
        }

        function guessHighLow(guess) {
            const currentAtk = parseInt(currentHLCard.attack) || 0;
            const nextAtk = parseInt(nextHLCard.attack) || 0;

            document.getElementById('hlNextName').textContent = nextHLCard.name;
            document.getElementById('nextHighLowCard').querySelector('.stat-badge').innerHTML = `攻撃力: ${nextHLCard.attack}`;

            let correct = false;
            if ((guess === 'high' && nextAtk >= currentAtk) || (guess === 'low' && nextAtk <= currentAtk)) {
                correct = true;
                hlStreak++;
                if (hlStreak > hlBest) {
                    hlBest = hlStreak;
                }
            } else {
                hlStreak = 0;
            }

            updateHLScore();

            setTimeout(() => {
                currentHLCard = nextHLCard;
                nextHLCard = getRandomCards(1)[0];

                document.getElementById('hlCurrentName').textContent = currentHLCard.name;
                document.getElementById('hlCurrentAtk').textContent = currentHLCard.attack;
                document.getElementById('hlNextName').textContent = '???';
                document.getElementById('nextHighLowCard').querySelector('.stat-badge').innerHTML = `攻撃力: ???`;
            }, 2000);
        }

        function updateHLScore() {
            document.getElementById('hlStreak').textContent = hlStreak;
            document.getElementById('hlBest').textContent = hlBest;
        }

        function exitHighLowGame() {
            document.getElementById('highLowGame').classList.remove('active');
            document.getElementById('gameMenu').style.display = 'grid';
        }
    </script>
</body>
</html>
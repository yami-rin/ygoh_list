<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>遊戯王ダンジョン攻略</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Arial', sans-serif;
        }

        .game-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .stats-bar {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .stat-item i {
            font-size: 1.3rem;
        }

        .points { color: #f39c12; }
        .deck-count { color: #3498db; }
        .level { color: #e74c3c; }
        .wins { color: #27ae60; }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .panel-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        /* ショップパネル */
        .shop-panel {
            max-height: 600px;
            overflow-y: auto;
        }

        .card-shop-item {
            background: linear-gradient(145deg, #f3f3f3, #e6e6e6);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card-shop-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .card-shop-item.rare {
            background: linear-gradient(145deg, #fffef0, #fff9c4);
            border: 2px solid #ffd700;
        }

        .card-shop-item.super-rare {
            background: linear-gradient(145deg, #f0f4ff, #e3f2fd);
            border: 2px solid #2196f3;
        }

        .card-shop-item.ultra-rare {
            background: linear-gradient(145deg, #fff0ff, #fce4ec);
            border: 2px solid #e91e63;
        }

        .card-price {
            position: absolute;
            top: 5px;
            right: 10px;
            background: #f39c12;
            color: white;
            padding: 3px 8px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .card-stats {
            display: flex;
            gap: 10px;
            margin-top: 5px;
            font-size: 0.9rem;
        }

        .atk { color: #e74c3c; }
        .def { color: #3498db; }

        /* ダンジョンパネル */
        .dungeon-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .dungeon-item {
            background: linear-gradient(145deg, #2c3e50, #34495e);
            color: white;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .dungeon-item:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .dungeon-item.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .difficulty-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .difficulty-easy { background: #27ae60; }
        .difficulty-normal { background: #f39c12; }
        .difficulty-hard { background: #e74c3c; }
        .difficulty-expert { background: #8e44ad; }

        /* デッキパネル */
        .deck-panel {
            max-height: 600px;
            overflow-y: auto;
        }

        .deck-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            position: relative;
        }

        .deck-card:hover {
            background: #e9ecef;
        }

        .deck-card.selected {
            background: #d4edda;
            border: 2px solid #28a745;
        }

        .deck-card.in-battle {
            background: #cfe8ff;
            border: 2px solid #007bff;
        }

        /* 属性アイコン */
        .attribute-icon {
            width: 20px;
            height: 20px;
            display: inline-block;
            border-radius: 50%;
            margin-left: 5px;
        }

        .attr-light { background: linear-gradient(135deg, #ffeb3b, #ffc107); }
        .attr-dark { background: linear-gradient(135deg, #424242, #212121); }
        .attr-fire { background: linear-gradient(135deg, #ff5722, #d84315); }
        .attr-water { background: linear-gradient(135deg, #2196f3, #1565c0); }
        .attr-earth { background: linear-gradient(135deg, #8d6e63, #5d4037); }
        .attr-wind { background: linear-gradient(135deg, #4caf50, #2e7d32); }

        /* バトル画面 */
        .battle-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .battle-modal.active {
            display: flex;
        }

        .battle-arena {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .battle-phase {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
            text-align: center;
            color: white;
        }

        .battle-hands {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .hand-area {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
        }

        .hand-title {
            color: white;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .hand-cards {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .hand-card {
            background: white;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
            text-align: center;
            position: relative;
        }

        .hand-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .hand-card.selected {
            border: 3px solid #ffc107;
            box-shadow: 0 0 15px rgba(255,193,7,0.5);
        }

        .hand-card.used {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .hand-card.enemy {
            cursor: default;
        }

        .card-hp-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .card-hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            transition: width 0.5s ease;
        }

        .battle-field {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
        }

        .active-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            position: relative;
            transition: all 0.3s ease;
        }

        .vs-text {
            color: white;
            font-size: 2rem;
            font-weight: bold;
        }

        .battle-card.damage {
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .battle-card.defeated {
            opacity: 0.3;
            transform: scale(0.9);
        }

        .hp-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            transition: width 0.5s ease;
        }

        .battle-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .battle-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .battle-btn:hover {
            transform: scale(1.05);
        }

        .battle-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: scale(1);
        }

        .attack-btn {
            background: linear-gradient(145deg, #e74c3c, #c0392b);
            color: white;
        }

        .switch-btn {
            background: linear-gradient(145deg, #3498db, #2980b9);
            color: white;
        }

        .skill-btn {
            background: linear-gradient(145deg, #9b59b6, #8e44ad);
            color: white;
        }

        .end-turn-btn {
            background: linear-gradient(145deg, #95a5a6, #7f8c8d);
            color: white;
        }

        /* 属性相性表示 */
        .attribute-matchup {
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
        }

        .advantage { color: #27ae60; font-weight: bold; }
        .disadvantage { color: #e74c3c; font-weight: bold; }
        .neutral { color: #7f8c8d; }

        /* バトルログ */
        .battle-log {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
            color: white;
            font-size: 0.9rem;
        }

        .log-entry {
            padding: 3px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .log-damage { color: #ff6b6b; }
        .log-heal { color: #51cf66; }
        .log-special { color: #ffd43b; }

        /* リザルト画面 */
        .result-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            z-index: 1100;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .result-modal.active {
            display: block;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                transform: translate(-50%, -60%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%);
                opacity: 1;
            }
        }

        .result-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .victory { color: #27ae60; }
        .defeat { color: #e74c3c; }

        .reward-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }

        /* セーブ・ロード */
        .save-load-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .save-btn, .load-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.9);
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
        }

        .save-btn:hover, .load-btn:hover {
            transform: scale(1.05);
        }

        /* レスポンシブ対応 */
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .stats-bar {
                flex-direction: column;
            }

            .battle-hands {
                grid-template-columns: 1fr;
            }

            .battle-field {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- ヘッダー -->
        <div class="header-panel">
            <div class="stats-bar">
                <div class="stat-item points">
                    <i class="bi bi-coin"></i>
                    <span id="player-points">0</span> pts
                </div>
                <div class="stat-item deck-count">
                    <i class="bi bi-stack"></i>
                    <span id="deck-count">0</span> 枚
                </div>
                <div class="stat-item level">
                    <i class="bi bi-trophy"></i>
                    Lv.<span id="player-level">1</span>
                </div>
                <div class="stat-item wins">
                    <i class="bi bi-star-fill"></i>
                    <span id="total-wins">0</span> 勝
                </div>
            </div>
        </div>

        <!-- メインコンテンツ -->
        <div class="main-content">
            <!-- カードショップ -->
            <div class="panel shop-panel">
                <div class="panel-title">
                    <i class="bi bi-shop"></i> カードショップ
                </div>
                <div class="shop-filters mb-3">
                    <select id="shop-filter" class="form-select form-select-sm">
                        <option value="all">すべて</option>
                        <option value="low-cost">低コスト (～500pts)</option>
                        <option value="mid-cost">中コスト (500-1500pts)</option>
                        <option value="high-cost">高コスト (1500pts～)</option>
                    </select>
                </div>
                <div id="shop-cards" class="shop-cards-container">
                    <!-- カードがここに動的に追加される -->
                </div>
            </div>

            <!-- ダンジョン選択 -->
            <div class="panel dungeon-panel">
                <div class="panel-title">
                    <i class="bi bi-map"></i> ダンジョン選択
                </div>
                <div class="dungeon-list" id="dungeon-list">
                    <div class="dungeon-item" data-dungeon-id="1" data-difficulty="easy">
                        <h5>初心者の洞窟</h5>
                        <p class="mb-1">推奨デッキ: 3枚以上</p>
                        <span class="difficulty-badge difficulty-easy">EASY</span>
                        <small>報酬: 100-300pts + カード1枚</small>
                    </div>
                    <div class="dungeon-item" data-dungeon-id="2" data-difficulty="normal">
                        <h5>古代の遺跡</h5>
                        <p class="mb-1">推奨デッキ: 5枚以上</p>
                        <span class="difficulty-badge difficulty-normal">NORMAL</span>
                        <small>報酬: 300-700pts + カード1-2枚</small>
                    </div>
                    <div class="dungeon-item" data-dungeon-id="3" data-difficulty="hard">
                        <h5>魔王の城</h5>
                        <p class="mb-1">推奨デッキ: 7枚以上</p>
                        <span class="difficulty-badge difficulty-hard">HARD</span>
                        <small>報酬: 700-1500pts + カード2-3枚</small>
                    </div>
                    <div class="dungeon-item locked" data-dungeon-id="4" data-difficulty="expert">
                        <h5>神々の領域</h5>
                        <p class="mb-1">推奨デッキ: 10枚以上</p>
                        <span class="difficulty-badge difficulty-expert">EXPERT</span>
                        <small>要求: Lv.10以上</small>
                    </div>
                </div>
                <div class="mt-3">
                    <button id="select-deck-btn" class="btn btn-warning w-100 mb-2">
                        <i class="bi bi-collection"></i> バトルデッキ選択 <span id="battle-deck-count">(0/3)</span>
                    </button>
                    <button id="start-battle-btn" class="btn btn-primary w-100" disabled>
                        <i class="bi bi-play-fill"></i> バトル開始
                    </button>
                </div>
            </div>

            <!-- マイデッキ -->
            <div class="panel deck-panel">
                <div class="panel-title">
                    <i class="bi bi-collection"></i> マイデッキ
                </div>
                <div class="deck-actions mb-3">
                    <button id="sell-selected-btn" class="btn btn-sm btn-warning">
                        <i class="bi bi-cash"></i> 選択売却
                    </button>
                    <button id="select-all-btn" class="btn btn-sm btn-secondary">
                        <i class="bi bi-check-all"></i> 全選択
                    </button>
                    <button id="clear-selection-btn" class="btn btn-sm btn-light">
                        <i class="bi bi-x-circle"></i> 選択解除
                    </button>
                </div>
                <div id="my-deck" class="my-deck-container">
                    <!-- デッキカードがここに動的に追加される -->
                </div>
            </div>
        </div>

        <!-- バトル画面（モーダル） -->
        <div id="battle-modal" class="battle-modal">
            <div class="battle-arena">
                <h2 class="text-white text-center mb-3">BATTLE!</h2>

                <div class="battle-phase">
                    <h5 id="phase-text">プレイヤーターン</h5>
                </div>

                <!-- 属性相性表示（削除） -->

                <!-- 手札エリア -->
                <div class="battle-hands">
                    <div class="hand-area">
                        <div class="hand-title">自分の手札</div>
                        <div class="hand-cards" id="player-hand">
                            <!-- プレイヤーの手札 -->
                        </div>
                    </div>
                    <div class="hand-area">
                        <div class="hand-title">敵の手札</div>
                        <div class="hand-cards" id="enemy-hand">
                            <!-- 敵の手札 -->
                        </div>
                    </div>
                </div>

                <!-- バトルフィールド -->
                <div class="battle-field">
                    <div class="active-card" id="player-active">
                        <h5>アクティブカードなし</h5>
                    </div>
                    <div class="vs-text">VS</div>
                    <div class="active-card" id="enemy-active">
                        <h5>アクティブカードなし</h5>
                    </div>
                </div>

                <!-- アクション -->
                <div class="battle-actions">
                    <button class="battle-btn attack-btn" id="attack-btn" disabled>
                        <i class="bi bi-lightning"></i> 攻撃
                    </button>
                    <button class="battle-btn switch-btn" id="switch-btn">
                        <i class="bi bi-arrow-repeat"></i> 交代
                    </button>
                    <button class="battle-btn skill-btn" id="skill-btn" disabled>
                        <i class="bi bi-magic"></i> 特殊効果
                    </button>
                    <button class="battle-btn end-turn-btn" id="end-turn-btn">
                        <i class="bi bi-skip-forward"></i> ターン終了
                    </button>
                </div>

                <!-- バトルログ -->
                <div class="battle-log mt-3" id="battle-log">
                    <!-- バトルログ -->
                </div>
            </div>
        </div>

        <!-- リザルト画面 -->
        <div id="result-modal" class="result-modal">
            <h2 id="result-title" class="result-title">-</h2>
            <div id="result-message"></div>
            <div class="reward-list" id="reward-list">
                <!-- 報酬リスト -->
            </div>
            <button class="btn btn-primary" onclick="closeResult()">
                <i class="bi bi-check"></i> OK
            </button>
        </div>

        <!-- セーブ・ロード -->
        <div class="save-load-panel">
            <button class="save-btn" onclick="saveGame()">
                <i class="bi bi-save"></i> セーブ
            </button>
            <button class="load-btn" onclick="loadGame()">
                <i class="bi bi-arrow-clockwise"></i> ロード
            </button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase設定
        const firebaseConfig = {
            apiKey: "AIzaSyDpPRDVVaJu47mc5mViplae3tuFSUsoUTU",
            authDomain: "ygocollection-f5c2e.firebaseapp.com",
            projectId: "ygocollection-f5c2e",
            storageBucket: "ygocollection-f5c2e.firebasestorage.app",
            messagingSenderId: "720355401822",
            appId: "1:720355401822:web:b4c032e1e92c2f97f7ca41"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ゲームデータ
        let gameData = {
            points: 0,
            level: 1,
            totalWins: 0,
            deck: [],
            battleDeck: [], // バトル用に選択したカード
            unlockedDungeons: [1, 2, 3],
            cardDatabase: [],
            currentBattle: null,
            selectedDungeon: null,
            currentUser: null
        };

        // 属性相性テーブル（削除）
        // const attributeMatchup = {};

        // 種族による特殊効果
        const raceAbilities = {
            'ドラゴン族': { type: 'attack_boost', value: 1.1, description: '攻撃力10%アップ' },
            '戦士族': { type: 'defense_boost', value: 1.1, description: '防御力10%アップ' },
            '魔法使い族': { type: 'skill_damage', value: 200, description: '特殊効果: 200ダメージ' },
            '悪魔族': { type: 'life_drain', value: 0.2, description: 'ダメージの20%回復' },
            '天使族': { type: 'heal', value: 300, description: '毎ターン300回復' },
            '機械族': { type: 'counter', value: 0.3, description: '30%の確率で反撃' },
            '岩石族': { type: 'damage_reduction', value: 0.9, description: '受けるダメージ10%軽減' },
            '獣族': { type: 'speed', value: 1.2, description: '20%の確率で連続攻撃' },
            '植物族': { type: 'regenerate', value: 200, description: '毎ターン200回復' }
        };

        // カードデータベースの読み込み
        async function loadCardDatabase() {
            try {
                const response = await fetch('yugioh_cards_master.csv');
                const csvText = await response.text();
                const lines = csvText.split('\n');

                gameData.cardDatabase = [];

                for (let i = 1; i < lines.length && i < 1000; i++) {
                    const line = lines[i];
                    if (!line.trim()) continue;

                    const values = parseCSVLine(line);
                    if (values.length >= 9) {
                        const card = {
                            id: values[0]?.replace(/^"|"$/g, '').trim() || `card_${i}`,
                            name: values[1]?.replace(/^"|"$/g, '').trim() || `カード${i}`,
                            level: parseInt(values[3]?.replace(/^"|"$/g, '').trim()) || 1,
                            attribute: values[4]?.replace(/^"|"$/g, '').trim() || '闇',
                            race: values[5]?.replace(/^"|"$/g, '').trim() || '戦士族',
                            type: values[6]?.replace(/^"|"$/g, '').trim() || 'モンスター',
                            attack: parseInt(values[7]?.replace(/^"|"$/g, '').trim()) || 100,
                            defense: parseInt(values[8]?.replace(/^"|"$/g, '').trim()) || 100
                        };

                        // モンスターカードのみ（魔法・罠除外）
                        const cardType = card.type?.toLowerCase() || '';
                        const race = card.race?.toLowerCase() || '';
                        const isSpellOrTrap = cardType.includes('魔法') || cardType.includes('罠') ||
                                             race.includes('魔法') || race.includes('罠');

                        if (card.attack > 0 && !isNaN(card.attack) && !isSpellOrTrap) {
                            // 価格計算
                            card.price = Math.floor((card.attack + card.defense) / 4);
                            card.sellPrice = Math.floor(card.price * 0.5);

                            // レアリティ判定
                            if (card.attack >= 3000) {
                                card.rarity = 'ultra-rare';
                            } else if (card.attack >= 2000) {
                                card.rarity = 'super-rare';
                            } else if (card.attack >= 1500) {
                                card.rarity = 'rare';
                            } else {
                                card.rarity = 'common';
                            }

                            gameData.cardDatabase.push(card);
                        }
                    }
                }

                console.log(`Loaded ${gameData.cardDatabase.length} cards`);
                renderShop();
            } catch (error) {
                console.error('Failed to load card database:', error);
                generateFallbackCards();
            }
        }

        // CSV行のパース
        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            values.push(current);

            return values;
        }

        // フォールバックカード生成
        function generateFallbackCards() {
            const fallbackCards = [
                { id: 'f1', name: '炎の剣士', attack: 1800, defense: 1600, level: 4, attribute: '炎', race: '戦士族', type: 'モンスター', price: 850, sellPrice: 425, rarity: 'rare' },
                { id: 'f2', name: '水の魔導師', attack: 1400, defense: 1000, level: 4, attribute: '水', race: '魔法使い族', type: 'モンスター', price: 600, sellPrice: 300, rarity: 'common' },
                { id: 'f3', name: '風の守護者', attack: 1000, defense: 1800, level: 4, attribute: '風', race: '戦士族', type: 'モンスター', price: 700, sellPrice: 350, rarity: 'common' },
                { id: 'f4', name: '地の巨人', attack: 2100, defense: 1700, level: 5, attribute: '地', race: '岩石族', type: 'モンスター', price: 950, sellPrice: 475, rarity: 'super-rare' },
                { id: 'f5', name: '雷の竜', attack: 2400, defense: 2000, level: 6, attribute: '光', race: 'ドラゴン族', type: 'モンスター', price: 1100, sellPrice: 550, rarity: 'super-rare' }
            ];
            gameData.cardDatabase = fallbackCards;
            renderShop();
        }

        // ショップ表示
        function renderShop() {
            const shopContainer = document.getElementById('shop-cards');
            const filter = document.getElementById('shop-filter').value;

            let filteredCards = [...gameData.cardDatabase];

            // フィルタリング
            switch(filter) {
                case 'low-cost':
                    filteredCards = filteredCards.filter(c => c.price <= 500);
                    break;
                case 'mid-cost':
                    filteredCards = filteredCards.filter(c => c.price > 500 && c.price <= 1500);
                    break;
                case 'high-cost':
                    filteredCards = filteredCards.filter(c => c.price > 1500);
                    break;
            }

            // ランダムシャッフル
            for (let i = filteredCards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [filteredCards[i], filteredCards[j]] = [filteredCards[j], filteredCards[i]];
            }

            // 最大30枚表示
            filteredCards = filteredCards.slice(0, 30);

            shopContainer.innerHTML = '';
            filteredCards.forEach(card => {
                const cardElement = document.createElement('div');
                cardElement.className = `card-shop-item ${card.rarity}`;
                cardElement.onclick = () => buyCard(card);

                const attrClass = `attr-${card.attribute?.toLowerCase() || 'dark'}`;

                cardElement.innerHTML = `
                    <div class="card-price">${card.price} pts</div>
                    <h6>${card.name}</h6>
                    <div class="card-stats">
                        <span class="atk"><i class="bi bi-sword"></i> ${card.attack}</span>
                        <span class="def"><i class="bi bi-shield"></i> ${card.defense}</span>
                        <span>Lv.${card.level}</span>
                        <span class="attribute-icon ${attrClass}"></span>
                    </div>
                    <small>${card.race} / ${card.attribute}</small>
                    ${raceAbilities[card.race] ? `<br><small class="text-muted">${raceAbilities[card.race].description}</small>` : ''}
                `;

                shopContainer.appendChild(cardElement);
            });
        }

        // カード購入
        async function buyCard(card) {
            if (gameData.points >= card.price) {
                if (confirm(`${card.name}を${card.price}ptsで購入しますか？`)) {
                    gameData.points -= card.price;
                    gameData.deck.push({...card, uid: Date.now() + Math.random()});

                    // Firebaseポイント更新
                    if (gameData.currentUser) {
                        await updateFirebasePoints(gameData.points);
                    }

                    updateStats();
                    renderDeck();
                    saveGameToFirebase();
                    showNotification(`${card.name}を購入しました！`, 'success');
                }
            } else {
                showNotification('ポイントが不足しています！', 'error');
            }
        }

        // デッキ表示
        function renderDeck() {
            const deckContainer = document.getElementById('my-deck');
            deckContainer.innerHTML = '';

            gameData.deck.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.className = 'deck-card';
                if (gameData.battleDeck.some(c => c.uid === card.uid)) {
                    cardElement.className += ' in-battle';
                }
                cardElement.dataset.index = index;

                const attrClass = `attr-${card.attribute?.toLowerCase() || 'dark'}`;

                cardElement.innerHTML = `
                    <div>
                        <strong>${card.name}</strong>
                        <span class="attribute-icon ${attrClass}"></span>
                        <div class="small">
                            ATK:${card.attack} DEF:${card.defense} Lv.${card.level}
                        </div>
                    </div>
                    <div>
                        <span class="badge bg-info">${card.sellPrice} pts</span>
                    </div>
                `;

                cardElement.onclick = () => toggleCardSelection(index);
                deckContainer.appendChild(cardElement);
            });

            document.getElementById('deck-count').textContent = gameData.deck.length;
        }

        // バトルデッキ選択
        document.getElementById('select-deck-btn').onclick = () => {
            if (gameData.deck.length < 3) {
                showNotification('デッキに最低3枚のカードが必要です', 'error');
                return;
            }

            // 選択モードに切り替え
            const selectedIndexes = [];
            gameData.deck.forEach((card, index) => {
                const elem = document.querySelector(`.deck-card[data-index="${index}"]`);
                elem.onclick = () => {
                    if (selectedIndexes.includes(index)) {
                        selectedIndexes.splice(selectedIndexes.indexOf(index), 1);
                        elem.classList.remove('in-battle');
                    } else if (selectedIndexes.length < 5) {  // 最大5枚まで
                        selectedIndexes.push(index);
                        elem.classList.add('in-battle');
                    }

                    gameData.battleDeck = selectedIndexes.map(i => gameData.deck[i]);
                    document.getElementById('battle-deck-count').textContent = `(${gameData.battleDeck.length}/3)`;
                    document.getElementById('start-battle-btn').disabled = gameData.battleDeck.length < 3;
                };
            });

            showNotification('バトルに使用するカードを3～5枚選択してください', 'info');
        };

        // カード選択切り替え
        function toggleCardSelection(index) {
            const cardElement = document.querySelector(`.deck-card[data-index="${index}"]`);
            cardElement.classList.toggle('selected');
        }

        // 選択カード売却
        document.getElementById('sell-selected-btn').onclick = async () => {
            const selectedCards = document.querySelectorAll('.deck-card.selected');
            if (selectedCards.length === 0) {
                showNotification('売却するカードを選択してください', 'warning');
                return;
            }

            if (confirm(`選択した${selectedCards.length}枚のカードを売却しますか？`)) {
                let totalSellPrice = 0;
                const indicesToRemove = [];

                selectedCards.forEach(elem => {
                    const index = parseInt(elem.dataset.index);
                    totalSellPrice += gameData.deck[index].sellPrice;
                    indicesToRemove.push(index);
                });

                indicesToRemove.sort((a, b) => b - a);
                indicesToRemove.forEach(index => {
                    gameData.deck.splice(index, 1);
                });

                gameData.points += totalSellPrice;

                // Firebaseポイント更新
                if (gameData.currentUser) {
                    await updateFirebasePoints(gameData.points);
                }

                updateStats();
                renderDeck();
                saveGameToFirebase();
                showNotification(`${selectedCards.length}枚のカードを${totalSellPrice}ptsで売却しました！`, 'success');
            }
        };

        // 全選択
        document.getElementById('select-all-btn').onclick = () => {
            document.querySelectorAll('.deck-card').forEach(card => {
                card.classList.add('selected');
            });
        };

        // 選択解除
        document.getElementById('clear-selection-btn').onclick = () => {
            document.querySelectorAll('.deck-card').forEach(card => {
                card.classList.remove('selected');
            });
        };

        // ダンジョン選択
        document.querySelectorAll('.dungeon-item').forEach(dungeon => {
            dungeon.onclick = function() {
                if (this.classList.contains('locked')) {
                    showNotification('このダンジョンはまだ解放されていません', 'warning');
                    return;
                }

                document.querySelectorAll('.dungeon-item').forEach(d => d.classList.remove('selected'));
                this.classList.add('selected');

                gameData.selectedDungeon = {
                    id: parseInt(this.dataset.dungeonId),
                    difficulty: this.dataset.difficulty
                };

                document.getElementById('start-battle-btn').disabled = gameData.battleDeck.length < 3;
            };
        });

        // バトル開始
        document.getElementById('start-battle-btn').onclick = () => {
            if (gameData.battleDeck.length < 3) {
                showNotification('バトルデッキを選択してください', 'error');
                return;
            }

            if (!gameData.selectedDungeon) {
                showNotification('ダンジョンを選択してください', 'warning');
                return;
            }

            startBattle();
        };

        // バトル開始処理
        function startBattle() {
            const difficulty = gameData.selectedDungeon.difficulty;

            // 敵の手札生成
            const enemyHand = [];
            const enemyCount = difficulty === 'easy' ? 3 : difficulty === 'normal' ? 4 : difficulty === 'hard' ? 5 : 6;

            for (let i = 0; i < enemyCount; i++) {
                enemyHand.push(generateEnemy(difficulty));
            }

            // プレイヤーの手札を複製（HPを個別管理）
            const playerHand = gameData.battleDeck.map(card => ({
                ...card,
                currentHp: card.defense,
                maxHp: card.defense,
                used: false
            }));

            // 敵の最初のカードをアクティブに設定
            const enemyHandProcessed = enemyHand.map(card => ({
                ...card,
                currentHp: card.defense,
                maxHp: card.defense,
                used: false
            }));

            gameData.currentBattle = {
                playerHand: playerHand,
                enemyHand: enemyHandProcessed,
                playerActive: null,
                enemyActive: 0,  // 敵の最初のカードをアクティブに
                turn: 'player',
                turnCount: 0,
                log: [],
                phase: 'selection' // selection, battle, end
            };

            updateBattleUI();
            document.getElementById('battle-modal').classList.add('active');
            addBattleLog('バトル開始！', 'special');
            addBattleLog(`敵は${enemyHandProcessed[0].name}を場に出した！`, 'special');
            addBattleLog('カードを選択してください', 'special');
        }

        // 敵生成
        function generateEnemy(difficulty) {
            let atkRange, defRange, levelRange;

            switch(difficulty) {
                case 'easy':
                    atkRange = [300, 1200];
                    defRange = [200, 1000];
                    levelRange = [1, 3];
                    break;
                case 'normal':
                    atkRange = [1000, 2000];
                    defRange = [800, 1800];
                    levelRange = [3, 5];
                    break;
                case 'hard':
                    atkRange = [1800, 3000];
                    defRange = [1500, 2800];
                    levelRange = [5, 7];
                    break;
                case 'expert':
                    atkRange = [2500, 4000];
                    defRange = [2200, 3800];
                    levelRange = [7, 10];
                    break;
                default:
                    atkRange = [500, 1500];
                    defRange = [400, 1200];
                    levelRange = [1, 4];
            }

            // データベースから適切な敵を選択（難易度に応じて弱めのカードを優先）
            const validEnemies = gameData.cardDatabase.filter(card =>
                card.attack >= atkRange[0] && card.attack <= atkRange[1] &&
                card.defense >= defRange[0] && card.defense <= defRange[1]
            );

            // 攻撃力と守備力の合計でソート（弱い順）
            validEnemies.sort((a, b) => (a.attack + a.defense) - (b.attack + b.defense));

            // 難易度に応じて選択範囲を調整
            let selectRange;
            switch(difficulty) {
                case 'easy':
                    // 下位30%から選択
                    selectRange = Math.ceil(validEnemies.length * 0.3);
                    break;
                case 'normal':
                    // 下位60%から選択
                    selectRange = Math.ceil(validEnemies.length * 0.6);
                    break;
                case 'hard':
                    // 全体の80%から選択
                    selectRange = Math.ceil(validEnemies.length * 0.8);
                    break;
                case 'expert':
                    // 全体から選択
                    selectRange = validEnemies.length;
                    break;
                default:
                    selectRange = Math.ceil(validEnemies.length * 0.5);
            }

            if (validEnemies.length > 0) {
                const candidates = validEnemies.slice(0, selectRange);
                return {...candidates[Math.floor(Math.random() * candidates.length)]};
            }

            // フォールバック
            return {
                name: `${difficulty}モンスター`,
                attack: Math.floor(Math.random() * (atkRange[1] - atkRange[0]) + atkRange[0]),
                defense: Math.floor(Math.random() * (defRange[1] - defRange[0]) + defRange[0]),
                level: Math.floor(Math.random() * (levelRange[1] - levelRange[0]) + levelRange[0]),
                attribute: ['光', '闇', '炎', '水', '地', '風'][Math.floor(Math.random() * 6)],
                race: '戦士族',
                price: 0,
                sellPrice: 0
            };
        }

        // バトルUI更新
        function updateBattleUI() {
            if (!gameData.currentBattle) return;

            const battle = gameData.currentBattle;

            // フェーズテキスト
            document.getElementById('phase-text').textContent =
                battle.turn === 'player' ? 'プレイヤーターン' : '敵ターン';

            // プレイヤー手札表示
            const playerHandDiv = document.getElementById('player-hand');
            playerHandDiv.innerHTML = '';
            battle.playerHand.forEach((card, index) => {
                const cardDiv = createHandCard(card, index, 'player');
                playerHandDiv.appendChild(cardDiv);
            });

            // 敵手札表示
            const enemyHandDiv = document.getElementById('enemy-hand');
            enemyHandDiv.innerHTML = '';
            battle.enemyHand.forEach((card, index) => {
                const cardDiv = createHandCard(card, index, 'enemy');
                enemyHandDiv.appendChild(cardDiv);
            });

            // アクティブカード表示
            updateActiveCards();

            // 属性相性表示（削除）
            // updateAttributeMatchup();

            // ボタン状態更新
            updateBattleButtons();

            // 勝敗チェック
            checkBattleEnd();
        }

        // 手札カード生成
        function createHandCard(card, index, owner) {
            const div = document.createElement('div');
            div.className = `hand-card ${owner === 'enemy' ? 'enemy' : ''}`;

            if (card.used) {
                div.className += ' used';
            }

            if (owner === 'player' && gameData.currentBattle.playerActive === index) {
                div.className += ' selected';
            } else if (owner === 'enemy' && gameData.currentBattle.enemyActive === index) {
                div.className += ' selected';
            }

            const hpPercent = (card.currentHp / card.maxHp) * 100;
            const attrClass = `attr-${card.attribute?.toLowerCase() || 'dark'}`;

            div.innerHTML = `
                <h6>${card.name}</h6>
                <div class="small">
                    ATK:${card.attack} DEF:${card.defense}
                    <span class="attribute-icon ${attrClass}"></span>
                </div>
                <div class="card-hp-bar">
                    <div class="card-hp-fill" style="width: ${hpPercent}%"></div>
                </div>
                <small>HP: ${card.currentHp}/${card.maxHp}</small>
            `;

            if (owner === 'player' && !card.used) {
                div.onclick = () => selectPlayerCard(index);
            }

            return div;
        }

        // プレイヤーカード選択
        function selectPlayerCard(index) {
            const battle = gameData.currentBattle;
            if (battle.turn !== 'player' || battle.playerHand[index].used) return;

            battle.playerActive = index;
            updateBattleUI();
        }

        // アクティブカード表示更新
        function updateActiveCards() {
            const battle = gameData.currentBattle;

            // プレイヤー側
            const playerActiveDiv = document.getElementById('player-active');
            if (battle.playerActive !== null && battle.playerActive < battle.playerHand.length) {
                const card = battle.playerHand[battle.playerActive];
                const attrClass = `attr-${card.attribute?.toLowerCase() || 'dark'}`;
                playerActiveDiv.innerHTML = `
                    <h5>${card.name} <span class="attribute-icon ${attrClass}"></span></h5>
                    <div>ATK: ${card.attack} / DEF: ${card.defense}</div>
                    <div class="hp-bar">
                        <div class="hp-fill" style="width: ${(card.currentHp / card.maxHp) * 100}%"></div>
                    </div>
                    <small>HP: ${card.currentHp}/${card.maxHp}</small>
                    ${raceAbilities[card.race] ? `<br><small class="text-muted">${raceAbilities[card.race].description}</small>` : ''}
                `;
            } else {
                playerActiveDiv.innerHTML = '<h5>アクティブカードなし</h5>';
            }

            // 敵側
            const enemyActiveDiv = document.getElementById('enemy-active');
            if (battle.enemyActive !== null && battle.enemyActive < battle.enemyHand.length) {
                const card = battle.enemyHand[battle.enemyActive];
                const attrClass = `attr-${card.attribute?.toLowerCase() || 'dark'}`;
                enemyActiveDiv.innerHTML = `
                    <h5>${card.name} <span class="attribute-icon ${attrClass}"></span></h5>
                    <div>ATK: ${card.attack} / DEF: ${card.defense}</div>
                    <div class="hp-bar">
                        <div class="hp-fill" style="width: ${(card.currentHp / card.maxHp) * 100}%"></div>
                    </div>
                    <small>HP: ${card.currentHp}/${card.maxHp}</small>
                `;
            } else {
                enemyActiveDiv.innerHTML = '<h5>アクティブカードなし</h5>';
            }
        }

        // 属性相性更新（削除）
        // function updateAttributeMatchup() { }

        // バトルボタン更新
        function updateBattleButtons() {
            const battle = gameData.currentBattle;
            const attackBtn = document.getElementById('attack-btn');
            const switchBtn = document.getElementById('switch-btn');
            const skillBtn = document.getElementById('skill-btn');
            const endTurnBtn = document.getElementById('end-turn-btn');

            if (battle.turn === 'player') {
                attackBtn.disabled = battle.playerActive === null || battle.enemyActive === null;
                switchBtn.disabled = false;
                endTurnBtn.disabled = false;

                // スキルボタン（特定種族のみ）
                if (battle.playerActive !== null) {
                    const card = battle.playerHand[battle.playerActive];
                    const ability = raceAbilities[card.race];
                    skillBtn.disabled = !ability || ability.type === 'passive';
                } else {
                    skillBtn.disabled = true;
                }
            } else {
                attackBtn.disabled = true;
                switchBtn.disabled = true;
                skillBtn.disabled = true;
                endTurnBtn.disabled = true;
            }
        }

        // 攻撃処理
        document.getElementById('attack-btn').onclick = () => {
            const battle = gameData.currentBattle;
            if (battle.turn !== 'player' || battle.playerActive === null || battle.enemyActive === null) return;

            const playerCard = battle.playerHand[battle.playerActive];
            const enemyCard = battle.enemyHand[battle.enemyActive];

            // 基本ダメージ計算
            let damage = playerCard.attack;

            // 種族能力
            const ability = raceAbilities[playerCard.race];
            if (ability && ability.type === 'attack_boost') {
                damage = Math.floor(damage * ability.value);
            }

            // ダメージ適用
            enemyCard.currentHp = Math.max(0, enemyCard.currentHp - damage);
            addBattleLog(`${playerCard.name}の攻撃！${enemyCard.name}に${damage}ダメージ！`, 'damage');

            // 吸血効果
            if (ability && ability.type === 'life_drain') {
                const heal = Math.floor(damage * ability.value);
                playerCard.currentHp = Math.min(playerCard.maxHp, playerCard.currentHp + heal);
                addBattleLog(`${playerCard.name}はHPを${heal}回復した！`, 'heal');
            }

            // 連続攻撃
            if (ability && ability.type === 'speed' && Math.random() < 0.2) {
                const extraDamage = Math.floor(damage * 0.5);
                enemyCard.currentHp = Math.max(0, enemyCard.currentHp - extraDamage);
                addBattleLog(`連続攻撃！追加で${extraDamage}ダメージ！`, 'damage');
            }

            updateBattleUI();

            // 敵が倒れたらカード使用済みに
            if (enemyCard.currentHp <= 0) {
                enemyCard.used = true;
                addBattleLog(`${enemyCard.name}を撃破！`, 'special');
                battle.enemyActive = null;
            }

            // ターン終了
            endPlayerTurn();
        };

        // 交代処理
        document.getElementById('switch-btn').onclick = () => {
            const battle = gameData.currentBattle;
            if (battle.turn !== 'player') return;

            battle.playerActive = null;
            updateBattleUI();
            showNotification('別のカードを選択してください', 'info');
        };

        // 特殊効果
        document.getElementById('skill-btn').onclick = () => {
            const battle = gameData.currentBattle;
            if (battle.turn !== 'player' || battle.playerActive === null) return;

            const playerCard = battle.playerHand[battle.playerActive];
            const ability = raceAbilities[playerCard.race];

            if (ability && ability.type === 'skill_damage' && battle.enemyActive !== null) {
                const enemyCard = battle.enemyHand[battle.enemyActive];
                enemyCard.currentHp = Math.max(0, enemyCard.currentHp - ability.value);
                addBattleLog(`${playerCard.name}の特殊効果！${ability.value}ダメージ！`, 'special');

                if (enemyCard.currentHp <= 0) {
                    enemyCard.used = true;
                    battle.enemyActive = null;
                }
            } else if (ability && ability.type === 'heal') {
                playerCard.currentHp = Math.min(playerCard.maxHp, playerCard.currentHp + ability.value);
                addBattleLog(`${playerCard.name}の回復効果！${ability.value}HP回復！`, 'heal');
            }

            updateBattleUI();
            endPlayerTurn();
        };

        // ターン終了
        document.getElementById('end-turn-btn').onclick = () => {
            endPlayerTurn();
        };

        function endPlayerTurn() {
            const battle = gameData.currentBattle;

            // 継続効果処理
            if (battle.playerActive !== null) {
                const card = battle.playerHand[battle.playerActive];
                const ability = raceAbilities[card.race];
                if (ability && (ability.type === 'regenerate' || ability.type === 'heal')) {
                    const heal = ability.type === 'heal' ? ability.value : 200;
                    card.currentHp = Math.min(card.maxHp, card.currentHp + heal);
                    addBattleLog(`${card.name}は${heal}HP回復した`, 'heal');
                }
            }

            battle.turn = 'enemy';
            updateBattleUI();
            setTimeout(enemyTurn, 1500);
        }

        // 敵のターン
        function enemyTurn() {
            const battle = gameData.currentBattle;

            // 敵のアクティブカード選択
            if (battle.enemyActive === null || battle.enemyHand[battle.enemyActive].used) {
                const availableCards = battle.enemyHand.filter(c => !c.used);
                if (availableCards.length > 0) {
                    battle.enemyActive = battle.enemyHand.indexOf(availableCards[Math.floor(Math.random() * availableCards.length)]);
                    addBattleLog(`敵は${battle.enemyHand[battle.enemyActive].name}を場に出した！`, 'special');
                }
            }

            // プレイヤーのアクティブカード選択（ランダム）
            if (battle.playerActive === null || battle.playerHand[battle.playerActive].used) {
                const availableCards = battle.playerHand.filter(c => !c.used);
                if (availableCards.length > 0) {
                    const targetIndex = Math.floor(Math.random() * availableCards.length);
                    battle.playerActive = battle.playerHand.indexOf(availableCards[targetIndex]);
                }
            }

            // 攻撃
            if (battle.enemyActive !== null && battle.playerActive !== null) {
                const enemyCard = battle.enemyHand[battle.enemyActive];
                const playerCard = battle.playerHand[battle.playerActive];

                let damage = enemyCard.attack;

                // プレイヤーの防御能力
                const playerAbility = raceAbilities[playerCard.race];
                if (playerAbility && playerAbility.type === 'damage_reduction') {
                    damage = Math.floor(damage * playerAbility.value);
                }

                playerCard.currentHp = Math.max(0, playerCard.currentHp - damage);
                addBattleLog(`${enemyCard.name}の攻撃！${playerCard.name}に${damage}ダメージ！`, 'damage');

                // 反撃
                if (playerAbility && playerAbility.type === 'counter' && Math.random() < playerAbility.value) {
                    const counterDamage = Math.floor(playerCard.attack * 0.5);
                    enemyCard.currentHp = Math.max(0, enemyCard.currentHp - counterDamage);
                    addBattleLog(`${playerCard.name}の反撃！${counterDamage}ダメージ！`, 'special');
                }

                if (playerCard.currentHp <= 0) {
                    playerCard.used = true;
                    addBattleLog(`${playerCard.name}が倒された！`, 'damage');
                    battle.playerActive = null;
                }

                if (enemyCard.currentHp <= 0) {
                    enemyCard.used = true;
                    battle.enemyActive = null;
                }
            }

            battle.turn = 'player';
            battle.turnCount++;
            updateBattleUI();
        }

        // バトルログ追加
        function addBattleLog(message, type = '') {
            const logDiv = document.getElementById('battle-log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type ? 'log-' + type : ''}`;
            entry.textContent = message;
            logDiv.insertBefore(entry, logDiv.firstChild);

            // 古いログを削除
            while (logDiv.children.length > 10) {
                logDiv.removeChild(logDiv.lastChild);
            }
        }

        // バトル終了チェック
        function checkBattleEnd() {
            const battle = gameData.currentBattle;
            if (!battle) return;

            const playerAlive = battle.playerHand.some(c => !c.used);
            const enemyAlive = battle.enemyHand.some(c => !c.used);

            if (!playerAlive) {
                endBattle(false);
            } else if (!enemyAlive) {
                endBattle(true);
            }
        }

        // バトル終了
        async function endBattle(victory) {
            setTimeout(async () => {
                document.getElementById('battle-modal').classList.remove('active');

                if (victory) {
                    // 報酬計算
                    const difficulty = gameData.selectedDungeon.difficulty;
                    let pointReward, cardReward = [];

                    switch(difficulty) {
                        case 'easy':
                            pointReward = 100 + Math.floor(Math.random() * 200);
                            if (Math.random() > 0.5) {
                                cardReward.push(gameData.currentBattle.enemyHand[0]);
                            }
                            break;
                        case 'normal':
                            pointReward = 300 + Math.floor(Math.random() * 400);
                            cardReward.push(gameData.currentBattle.enemyHand[0]);
                            if (Math.random() > 0.3) {
                                cardReward.push(gameData.currentBattle.enemyHand[1]);
                            }
                            break;
                        case 'hard':
                            pointReward = 700 + Math.floor(Math.random() * 800);
                            cardReward = gameData.currentBattle.enemyHand.slice(0, 2);
                            if (Math.random() > 0.3) {
                                cardReward.push(gameData.currentBattle.enemyHand[2]);
                            }
                            break;
                        case 'expert':
                            pointReward = 1500 + Math.floor(Math.random() * 1500);
                            cardReward = gameData.currentBattle.enemyHand.slice(0, 3);
                            break;
                    }

                    // 報酬付与
                    gameData.points += pointReward;
                    gameData.totalWins++;

                    // Firebaseポイント更新
                    if (gameData.currentUser) {
                        await updateFirebasePoints(gameData.points);
                    }

                    cardReward.forEach(card => {
                        if (card) {
                            delete card.currentHp;
                            delete card.maxHp;
                            delete card.used;
                            gameData.deck.push({...card, uid: Date.now() + Math.random()});
                        }
                    });

                    // レベルアップ
                    if (gameData.totalWins >= gameData.level * 5) {
                        gameData.level++;
                        showNotification(`レベルアップ！ Lv.${gameData.level}になりました！`, 'success');

                        if (gameData.level >= 10 && !gameData.unlockedDungeons.includes(4)) {
                            gameData.unlockedDungeons.push(4);
                            document.querySelector('[data-dungeon-id="4"]').classList.remove('locked');
                            showNotification('「神々の領域」が解放されました！', 'success');
                        }
                    }

                    showResult(true, pointReward, cardReward);
                } else {
                    showResult(false, 0, []);
                }

                updateStats();
                renderDeck();
                saveGameToFirebase();
                gameData.currentBattle = null;
                gameData.battleDeck = [];
                document.getElementById('battle-deck-count').textContent = '(0/3)';
            }, 1000);
        }

        // リザルト表示
        function showResult(victory, points, cards) {
            const modal = document.getElementById('result-modal');
            const title = document.getElementById('result-title');
            const message = document.getElementById('result-message');
            const rewardList = document.getElementById('reward-list');

            if (victory) {
                title.textContent = 'VICTORY!';
                title.className = 'result-title victory';
                message.innerHTML = `<p>ダンジョンをクリアしました！</p>`;

                let rewardHtml = `<p><i class="bi bi-coin"></i> ${points} pts 獲得</p>`;
                if (cards.length > 0) {
                    rewardHtml += '<p><strong>獲得カード:</strong></p>';
                    cards.forEach(card => {
                        if (card) {
                            rewardHtml += `<p>・${card.name} (ATK:${card.attack}/DEF:${card.defense})</p>`;
                        }
                    });
                }
                rewardList.innerHTML = rewardHtml;
            } else {
                title.textContent = 'DEFEAT';
                title.className = 'result-title defeat';
                message.innerHTML = `<p>ダンジョン攻略に失敗しました...</p>`;
                rewardList.innerHTML = '';
            }

            modal.classList.add('active');
        }

        // リザルトを閉じる
        function closeResult() {
            document.getElementById('result-modal').classList.remove('active');
        }

        // ステータス更新
        function updateStats() {
            document.getElementById('player-points').textContent = gameData.points;
            document.getElementById('deck-count').textContent = gameData.deck.length;
            document.getElementById('player-level').textContent = gameData.level;
            document.getElementById('total-wins').textContent = gameData.totalWins;
        }

        // 通知表示
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : type === 'info' ? 'info' : 'warning'} position-fixed top-0 start-50 translate-middle-x mt-3`;
            notification.style.zIndex = '9999';
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Firebase関連
        async function updateFirebasePoints(newPoints) {
            if (!gameData.currentUser) return;

            try {
                // dungeon_dataコレクションを使用
                const userRef = db.collection('dungeon_data').doc(gameData.currentUser.uid);
                await userRef.set({
                    points: newPoints,
                    level: gameData.level,
                    totalWins: gameData.totalWins,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            } catch (error) {
                console.error('Failed to update points:', error);
            }
        }

        async function loadFirebaseUserData() {
            if (!gameData.currentUser) return;

            try {
                // dungeon_dataから読み込み
                const dungeonDoc = await db.collection('dungeon_data').doc(gameData.currentUser.uid).get();

                if (dungeonDoc.exists) {
                    const data = dungeonDoc.data();
                    gameData.points = data.points || 1000;
                    gameData.level = data.level || 1;
                    gameData.totalWins = data.totalWins || 0;
                } else {
                    // 初回プレイ
                    gameData.points = 1000;
                    await updateFirebasePoints(gameData.points);
                }

                // セーブデータ読み込み
                const saveDoc = await db.collection('dungeon_saves').doc(gameData.currentUser.uid).get();
                if (saveDoc.exists) {
                    const saveData = saveDoc.data();
                    gameData.deck = saveData.deck || [];
                    gameData.unlockedDungeons = saveData.unlockedDungeons || [1, 2, 3];

                    if (gameData.level >= 10) {
                        document.querySelector('[data-dungeon-id="4"]')?.classList.remove('locked');
                    }
                }

                updateStats();
                renderDeck();
            } catch (error) {
                console.error('Failed to load user data:', error);
                gameData.points = 1000;
            }
        }

        async function saveGameToFirebase() {
            if (!gameData.currentUser) return;

            try {
                await db.collection('dungeon_saves').doc(gameData.currentUser.uid).set({
                    deck: gameData.deck,
                    unlockedDungeons: gameData.unlockedDungeons,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            } catch (error) {
                console.error('Failed to save game:', error);
            }
        }

        // セーブ・ロード
        function saveGame() {
            if (gameData.currentUser) {
                saveGameToFirebase();
                updateFirebasePoints(gameData.points);
                showNotification('ゲームをクラウドにセーブしました！', 'success');
            } else {
                const saveData = {
                    points: gameData.points,
                    level: gameData.level,
                    totalWins: gameData.totalWins,
                    deck: gameData.deck,
                    unlockedDungeons: gameData.unlockedDungeons
                };
                localStorage.setItem('dungeonGameSave', JSON.stringify(saveData));
                showNotification('ゲームをローカルにセーブしました！', 'success');
            }
        }

        async function loadGame() {
            if (gameData.currentUser) {
                await loadFirebaseUserData();
                showNotification('クラウドからゲームをロードしました！', 'success');
            } else {
                const savedData = localStorage.getItem('dungeonGameSave');
                if (savedData) {
                    const loadedData = JSON.parse(savedData);
                    gameData.points = loadedData.points || 1000;
                    gameData.level = loadedData.level || 1;
                    gameData.totalWins = loadedData.totalWins || 0;
                    gameData.deck = loadedData.deck || [];
                    gameData.unlockedDungeons = loadedData.unlockedDungeons || [1, 2, 3];

                    if (gameData.level >= 10) {
                        document.querySelector('[data-dungeon-id="4"]')?.classList.remove('locked');
                    }

                    updateStats();
                    renderDeck();
                    renderShop();
                    showNotification('ローカルからゲームをロードしました！', 'success');
                } else {
                    showNotification('セーブデータが見つかりません', 'warning');
                }
            }
        }

        // フィルター変更
        document.getElementById('shop-filter').addEventListener('change', renderShop);

        // 初期化
        window.onload = async () => {
            // Firebase認証状態確認
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    gameData.currentUser = user;
                    showNotification(`${user.displayName || user.email}でログイン中`, 'success');
                    await loadFirebaseUserData();
                } else {
                    gameData.currentUser = null;
                    gameData.points = 1000;
                    showNotification('ローカルモードで開始', 'info');
                }

                await loadCardDatabase();
                updateStats();
                renderDeck();
            });

            // 自動セーブ
            setInterval(saveGame, 300000);
        };
    </script>
</body>
</html>
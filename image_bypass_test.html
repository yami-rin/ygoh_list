<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”»åƒå–å¾—å›é¿æ–¹æ³•ãƒ†ã‚¹ãƒˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f5f5f5; padding: 20px; }
        .test-method {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid #007bff;
        }
        .test-method.success {
            border-left-color: #28a745;
        }
        .test-method.error {
            border-left-color: #dc3545;
        }
        .image-container {
            border: 2px solid #ddd;
            padding: 10px;
            min-height: 200px;
            background: #f8f9fa;
            margin: 10px 0;
        }
        .image-container img {
            max-width: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">ğŸ”“ ç”»åƒå–å¾—å›é¿æ–¹æ³•ãƒ†ã‚¹ãƒˆ</h1>

        <div class="card mb-4">
            <div class="card-body">
                <label class="form-label">ã‚«ãƒ¼ãƒ‰ID</label>
                <input type="text" class="form-control mb-2" id="card-id" value="7315">
                <button class="btn btn-primary" onclick="testAllMethods()">å…¨ã¦ã®æ–¹æ³•ã§ãƒ†ã‚¹ãƒˆ</button>
            </div>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const PROXY_SERVICES = [
            { name: 'corsproxy.io', url: (target) => `https://corsproxy.io/?${encodeURIComponent(target)}` },
            { name: 'allorigins.win', url: (target) => `https://api.allorigins.win/raw?url=${encodeURIComponent(target)}` },
            { name: 'cors-anywhere (herokuapp)', url: (target) => `https://cors-anywhere.herokuapp.com/${target}` },
            { name: 'thingproxy', url: (target) => `https://thingproxy.freeboard.io/fetch/${target}` }
        ];

        async function testAllMethods() {
            const cardId = document.getElementById('card-id').value;
            const results = document.getElementById('results');
            results.innerHTML = '<div class="alert alert-info">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</div>';

            const baseImageUrl = `https://www.db.yugioh-card.com/yugiohdb/card_image.action?cid=${cardId}&request_locale=ja`;
            const getImageUrl = `https://www.db.yugioh-card.com/yugiohdb/get_image.action?type=2&cid=${cardId}&ciid=1`;

            const methods = [
                // Method 1: Direct img tag
                {
                    name: 'æ–¹æ³•1: ç›´æ¥imgè¦ç´ ',
                    test: async () => {
                        return new Promise((resolve) => {
                            const img = new Image();
                            img.crossOrigin = 'anonymous';
                            img.onload = () => resolve({ success: true, img, method: 'direct' });
                            img.onerror = () => resolve({ success: false, error: 'CORS/403ã‚¨ãƒ©ãƒ¼' });
                            img.src = baseImageUrl;
                            setTimeout(() => resolve({ success: false, error: 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ' }), 5000);
                        });
                    }
                },

                // Method 2: Proxy services
                ...PROXY_SERVICES.map(proxy => ({
                    name: `æ–¹æ³•2: ${proxy.name} ãƒ—ãƒ­ã‚­ã‚·`,
                    test: async () => {
                        return new Promise((resolve) => {
                            const img = new Image();
                            img.onload = () => resolve({ success: true, img, method: 'proxy' });
                            img.onerror = () => resolve({ success: false, error: 'ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã§ã‚‚å¤±æ•—' });
                            img.src = proxy.url(baseImageUrl);
                            setTimeout(() => resolve({ success: false, error: 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ' }), 10000);
                        });
                    }
                })),

                // Method 3: Fetch with blob
                {
                    name: 'æ–¹æ³•3: Fetch â†’ Blob â†’ ObjectURL',
                    test: async () => {
                        try {
                            const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(baseImageUrl)}`);
                            if (!response.ok) throw new Error('Fetch failed');
                            const blob = await response.blob();
                            const objectUrl = URL.createObjectURL(blob);
                            const img = new Image();
                            img.src = objectUrl;
                            return { success: true, img, method: 'blob' };
                        } catch (error) {
                            return { success: false, error: error.message };
                        }
                    }
                },

                // Method 4: Base64 conversion
                {
                    name: 'æ–¹æ³•4: Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰',
                    test: async () => {
                        try {
                            const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(baseImageUrl)}`);
                            if (!response.ok) throw new Error('Fetch failed');
                            const blob = await response.blob();
                            const base64 = await blobToBase64(blob);
                            const img = new Image();
                            img.src = base64;
                            return { success: true, img, method: 'base64' };
                        } catch (error) {
                            return { success: false, error: error.message };
                        }
                    }
                },

                // Method 5: iframe approach
                {
                    name: 'æ–¹æ³•5: iframeåŸ‹ã‚è¾¼ã¿',
                    test: async () => {
                        return new Promise((resolve) => {
                            const iframe = document.createElement('iframe');
                            iframe.style.width = '300px';
                            iframe.style.height = '400px';
                            iframe.src = `https://www.db.yugioh-card.com/yugiohdb/card_search.action?ope=2&cid=${cardId}`;
                            iframe.onload = () => resolve({ success: true, iframe, method: 'iframe' });
                            iframe.onerror = () => resolve({ success: false, error: 'iframeãƒ­ãƒ¼ãƒ‰å¤±æ•—' });
                            setTimeout(() => resolve({ success: false, error: 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ' }), 10000);
                        });
                    }
                },

                // Method 6: Canvas proxy
                {
                    name: 'æ–¹æ³•6: CanvasçµŒç”±',
                    test: async () => {
                        try {
                            const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(baseImageUrl)}`);
                            const blob = await response.blob();
                            const bitmap = await createImageBitmap(blob);

                            const canvas = document.createElement('canvas');
                            canvas.width = bitmap.width;
                            canvas.height = bitmap.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(bitmap, 0, 0);

                            return { success: true, canvas, method: 'canvas' };
                        } catch (error) {
                            return { success: false, error: error.message };
                        }
                    }
                },

                // Method 7: Background image with proxy
                {
                    name: 'æ–¹æ³•7: CSS background-image',
                    test: async () => {
                        return new Promise((resolve) => {
                            const div = document.createElement('div');
                            div.style.width = '200px';
                            div.style.height = '290px';
                            div.style.backgroundImage = `url('https://corsproxy.io/?${encodeURIComponent(baseImageUrl)}')`;
                            div.style.backgroundSize = 'contain';
                            div.style.backgroundRepeat = 'no-repeat';

                            // Check if background loaded
                            const checkImage = new Image();
                            checkImage.onload = () => resolve({ success: true, div, method: 'css-bg' });
                            checkImage.onerror = () => resolve({ success: false, error: 'CSS background failed' });
                            checkImage.src = `https://corsproxy.io/?${encodeURIComponent(baseImageUrl)}`;
                        });
                    }
                },

                // Method 8: SVG with foreignObject
                {
                    name: 'æ–¹æ³•8: SVG foreignObject',
                    test: async () => {
                        try {
                            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                            svg.setAttribute('width', '200');
                            svg.setAttribute('height', '290');

                            const foreignObject = document.createElementNS('http://www.w3.org/2000/svg', 'foreignObject');
                            foreignObject.setAttribute('width', '200');
                            foreignObject.setAttribute('height', '290');

                            const img = document.createElement('img');
                            img.src = `https://corsproxy.io/?${encodeURIComponent(baseImageUrl)}`;

                            foreignObject.appendChild(img);
                            svg.appendChild(foreignObject);

                            return new Promise((resolve) => {
                                img.onload = () => resolve({ success: true, svg, method: 'svg' });
                                img.onerror = () => resolve({ success: false, error: 'SVG method failed' });
                                setTimeout(() => resolve({ success: false, error: 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ' }), 5000);
                            });
                        } catch (error) {
                            return { success: false, error: error.message };
                        }
                    }
                }
            ];

            results.innerHTML = '';

            for (let i = 0; i < methods.length; i++) {
                const method = methods[i];
                const methodDiv = document.createElement('div');
                methodDiv.className = 'test-method';
                methodDiv.innerHTML = `
                    <h5>${method.name}</h5>
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">ãƒ†ã‚¹ãƒˆä¸­...</span>
                    </div>
                    <span class="ms-2">ãƒ†ã‚¹ãƒˆä¸­...</span>
                `;
                results.appendChild(methodDiv);

                try {
                    const result = await method.test();

                    if (result.success) {
                        methodDiv.className = 'test-method success';
                        const container = document.createElement('div');
                        container.className = 'image-container';

                        if (result.img) {
                            container.appendChild(result.img);
                        } else if (result.canvas) {
                            container.appendChild(result.canvas);
                        } else if (result.div) {
                            container.appendChild(result.div);
                        } else if (result.iframe) {
                            container.appendChild(result.iframe);
                        } else if (result.svg) {
                            container.appendChild(result.svg);
                        }

                        methodDiv.innerHTML = `
                            <h5>âœ… ${method.name}</h5>
                            <p class="mb-2"><span class="badge bg-success">æˆåŠŸ</span> ä½¿ç”¨æ–¹æ³•: ${result.method}</p>
                        `;
                        methodDiv.appendChild(container);
                    } else {
                        methodDiv.className = 'test-method error';
                        methodDiv.innerHTML = `
                            <h5>âŒ ${method.name}</h5>
                            <p class="mb-0"><span class="badge bg-danger">å¤±æ•—</span> ${result.error}</p>
                        `;
                    }
                } catch (error) {
                    methodDiv.className = 'test-method error';
                    methodDiv.innerHTML = `
                        <h5>âŒ ${method.name}</h5>
                        <p class="mb-0"><span class="badge bg-danger">ã‚¨ãƒ©ãƒ¼</span> ${error.message}</p>
                    `;
                }

                // Add delay between tests
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            // Add summary
            const successCount = document.querySelectorAll('.test-method.success').length;
            const summaryDiv = document.createElement('div');
            summaryDiv.className = `alert ${successCount > 0 ? 'alert-success' : 'alert-danger'} mt-4`;
            summaryDiv.innerHTML = `
                <h5>ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼</h5>
                <p class="mb-0">æˆåŠŸ: ${successCount} / ${methods.length} æ–¹æ³•</p>
            `;
            results.insertBefore(summaryDiv, results.firstChild);
        }

        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // Auto-run on load
        window.addEventListener('load', () => {
            setTimeout(() => testAllMethods(), 500);
        });
    </script>
</body>
</html>

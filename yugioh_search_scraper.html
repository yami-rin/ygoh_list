<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŠæˆ¯ç‹æ¤œç´¢çµæœã‚¹ã‚¯ãƒ¬ã‚¤ãƒ‘ãƒ¼</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body {
            background: #f5f5f5;
        }
        .card-preview {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: white;
        }
        .card-preview img {
            max-width: 150px;
            border-radius: 4px;
        }
        .code-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 1rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 400px;
            overflow-y: auto;
        }
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1 class="mb-4">ğŸ´ éŠæˆ¯ç‹æ¤œç´¢çµæœã‚¹ã‚¯ãƒ¬ã‚¤ãƒ‘ãƒ¼</h1>

        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">æ¤œç´¢URLå…¥åŠ›</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">æ¤œç´¢çµæœãƒšãƒ¼ã‚¸URL</label>
                    <input type="text" class="form-control" id="search-url"
                           value="https://www.db.yugioh-card.com/yugiohdb/card_search.action?ope=1&sess=1&rp=10&mode=&sort=1&keyword=&stype=1&ctype=&othercon=2&starfr=&starto=&pscalefr=&pscaleto=&linkmarkerfr=&linkmarkerto=&link_m=2&atkfr=&atkto=&deffr=&defto=&releaseDStart=1&releaseMStart=1&releaseYStart=1999&releaseDEnd=&releaseMEnd=&releaseYEnd=">
                    <small class="text-muted">éŠæˆ¯ç‹å…¬å¼DBã®æ¤œç´¢çµæœãƒšãƒ¼ã‚¸URL</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">å–å¾—æ–¹æ³•</label>
                    <select class="form-select" id="scrape-method">
                        <option value="proxy">CORSãƒ—ãƒ­ã‚­ã‚·çµŒç”±</option>
                        <option value="direct">ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆCORSã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ï¼‰</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="scrapeSearchResults()">
                    <i class="bi bi-search"></i> ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–‹å§‹
                </button>
                <button class="btn btn-secondary" onclick="testKnownCards()">
                    <i class="bi bi-lightning"></i> æ—¢çŸ¥ã®ã‚«ãƒ¼ãƒ‰IDã§ãƒ†ã‚¹ãƒˆ
                </button>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">æŠ½å‡ºã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰æƒ…å ±</h5>
            </div>
            <div class="card-body">
                <div id="status-message" class="alert alert-info" style="display: none;">
                    <span class="loading-spinner"></span> å‡¦ç†ä¸­...
                </div>
                <div id="cards-result"></div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">å®Ÿè£…ã‚³ãƒ¼ãƒ‰</h5>
            </div>
            <div class="card-body">
                <div id="code-output" class="code-output"></div>
            </div>
        </div>
    </div>

    <script>
        let extractedCards = [];

        // æ¤œç´¢çµæœãƒšãƒ¼ã‚¸ã‚’ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°
        async function scrapeSearchResults() {
            const url = document.getElementById('search-url').value;
            const method = document.getElementById('scrape-method').value;
            const statusMsg = document.getElementById('status-message');
            const cardsResult = document.getElementById('cards-result');

            statusMsg.style.display = 'block';
            cardsResult.innerHTML = '';

            try {
                let fetchUrl = url;
                if (method === 'proxy') {
                    fetchUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
                }

                const response = await fetch(fetchUrl);
                const html = await response.text();

                // HTMLã‚’ãƒ‘ãƒ¼ã‚¹
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // ã‚«ãƒ¼ãƒ‰IDã‚’æŠ½å‡ºã™ã‚‹è¤‡æ•°ã®æ–¹æ³•ã‚’è©¦è¡Œ
                const cards = extractCardIdsFromHTML(html, doc);

                if (cards.length > 0) {
                    extractedCards = cards;
                    displayCards(cards);
                    generateCode(cards);
                    statusMsg.innerHTML = `<i class="bi bi-check-circle"></i> ${cards.length}æšã®ã‚«ãƒ¼ãƒ‰ã‚’æŠ½å‡ºã—ã¾ã—ãŸ`;
                    statusMsg.className = 'alert alert-success';
                } else {
                    statusMsg.innerHTML = '<i class="bi bi-exclamation-triangle"></i> ã‚«ãƒ¼ãƒ‰IDã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ';
                    statusMsg.className = 'alert alert-warning';

                    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
                    cardsResult.innerHTML = `
                        <div class="alert alert-info">
                            <h6>ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</h6>
                            <p>HTMLã‚µã‚¤ã‚º: ${html.length} bytes</p>
                            <p>æ¤œç´¢æ–¹æ³•ã‚’å¤‰æ›´ã™ã‚‹ã‹ã€æ—¢çŸ¥ã®ã‚«ãƒ¼ãƒ‰IDã§ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚</p>
                        </div>
                    `;
                }
            } catch (error) {
                statusMsg.innerHTML = `<i class="bi bi-x-circle"></i> ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                statusMsg.className = 'alert alert-danger';
                console.error('Scraping error:', error);
            }
        }

        // HTMLã‹ã‚‰ã‚«ãƒ¼ãƒ‰IDã‚’æŠ½å‡º
        function extractCardIdsFromHTML(html, doc) {
            const cards = [];

            // æ–¹æ³•1: JavaScriptå†…ã®get_image.actionã‹ã‚‰cidã‚’æŠ½å‡º
            const imageUrlRegex = /get_image\.action\?[^'"]*(cid=(\d+))[^'"]*/g;
            let match;
            const foundCids = new Set();

            while ((match = imageUrlRegex.exec(html)) !== null) {
                const cid = match[2];
                if (!foundCids.has(cid)) {
                    foundCids.add(cid);

                    // ã‚«ãƒ¼ãƒ‰åã‚’æ¢ã™ï¼ˆè¿‘ãã®ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ï¼‰
                    const cidIndex = match.index;
                    const contextStart = Math.max(0, cidIndex - 500);
                    const contextEnd = Math.min(html.length, cidIndex + 500);
                    const context = html.substring(contextStart, contextEnd);

                    // ã‚«ãƒ¼ãƒ‰åã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¢ã™
                    const nameMatch = context.match(/card_name['"]\s*>\s*([^<]+)</i) ||
                                     context.match(/"cardName":"([^"]+)"/i);

                    cards.push({
                        cid: cid,
                        name: nameMatch ? nameMatch[1].trim() : `ã‚«ãƒ¼ãƒ‰ID: ${cid}`,
                        imageUrl: `https://www.db.yugioh-card.com/yugiohdb/card_image.action?cid=${cid}&request_locale=ja`
                    });
                }
            }

            // æ–¹æ³•2: ã‚«ãƒ¼ãƒ‰è©³ç´°ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯ã‹ã‚‰cidã‚’æŠ½å‡º
            const detailLinkRegex = /card_search\.action\?ope=2[^'"]*cid=(\d+)/g;
            while ((match = detailLinkRegex.exec(html)) !== null) {
                const cid = match[1];
                if (!foundCids.has(cid)) {
                    foundCids.add(cid);
                    cards.push({
                        cid: cid,
                        name: `ã‚«ãƒ¼ãƒ‰ID: ${cid}`,
                        imageUrl: `https://www.db.yugioh-card.com/yugiohdb/card_image.action?cid=${cid}&request_locale=ja`
                    });
                }
            }

            return cards;
        }

        // æ—¢çŸ¥ã®ã‚«ãƒ¼ãƒ‰IDã§ãƒ†ã‚¹ãƒˆ
        async function testKnownCards() {
            const knownCards = [
                { cid: '4001', name: 'ãƒ–ãƒ©ãƒƒã‚¯ãƒ»ãƒã‚¸ã‚·ãƒ£ãƒ³' },
                { cid: '5318', name: 'é’çœ¼ã®ç™½é¾' },
                { cid: '7315', name: 'ãŠã‚ã‹ãªåŸ‹è‘¬' },
                { cid: '12206', name: 'æ­»è€…è˜‡ç”Ÿ' }
            ];

            const statusMsg = document.getElementById('status-message');
            statusMsg.style.display = 'block';
            statusMsg.innerHTML = '<span class="loading-spinner"></span> ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’å–å¾—ä¸­...';
            statusMsg.className = 'alert alert-info';

            extractedCards = [];

            for (const card of knownCards) {
                try {
                    const cardData = await fetchCardDetail(card.cid);
                    extractedCards.push({
                        cid: card.cid,
                        name: cardData.name || card.name,
                        imageUrl: cardData.imageUrlWithEnc || cardData.imageUrl,
                        encToken: cardData.encToken
                    });
                } catch (error) {
                    console.error(`Failed to fetch card ${card.cid}:`, error);
                    extractedCards.push({
                        cid: card.cid,
                        name: card.name,
                        imageUrl: `https://www.db.yugioh-card.com/yugiohdb/card_image.action?cid=${card.cid}&request_locale=ja`,
                        encToken: null
                    });
                }
            }

            displayCards(extractedCards);
            generateCode(extractedCards);

            statusMsg.innerHTML = `<i class="bi bi-check-circle"></i> ${extractedCards.length}æšã®ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸ`;
            statusMsg.className = 'alert alert-success';
        }

        // ã‚«ãƒ¼ãƒ‰è©³ç´°ãƒšãƒ¼ã‚¸ã‹ã‚‰æƒ…å ±ã‚’å–å¾—
        async function fetchCardDetail(cardId) {
            const detailUrl = `https://www.db.yugioh-card.com/yugiohdb/card_search.action?ope=2&cid=${cardId}`;
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(detailUrl)}`;

            const response = await fetch(proxyUrl);
            const html = await response.text();

            return extractCardDataFromDetail(html, cardId);
        }

        function extractCardDataFromDetail(html, cardId) {
            const data = {
                cid: cardId,
                name: null,
                imageUrlWithEnc: null,
                imageUrl: `https://www.db.yugioh-card.com/yugiohdb/card_image.action?cid=${cardId}&request_locale=ja`,
                encToken: null
            };

            // Extract enc token from get_image.action
            const imageRegex = /get_image\.action\?type=2&cid=\d+&ciid=1&enc=([a-zA-Z0-9_-]+)/;
            const match = html.match(imageRegex);
            if (match) {
                data.encToken = match[1];
                data.imageUrlWithEnc = `https://www.db.yugioh-card.com/yugiohdb/get_image.action?type=2&cid=${cardId}&ciid=1&enc=${data.encToken}`;
            }

            // Extract card name
            const nameRegex = /<h1[^>]*>([^<]+)<\/h1>/i;
            const nameMatch = html.match(nameRegex);
            if (nameMatch) {
                data.name = nameMatch[1].trim();
            }

            return data;
        }

        // ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’è¡¨ç¤º
        function displayCards(cards) {
            const container = document.getElementById('cards-result');
            container.innerHTML = '';

            cards.forEach((card, index) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card-preview';
                cardDiv.innerHTML = `
                    <div class="row align-items-center">
                        <div class="col-md-2 text-center">
                            <img src="${card.imageUrl}" alt="${card.name}"
                                 onerror="this.parentElement.innerHTML='<div class=\\'text-danger\\'><i class=\\'bi bi-x-circle\\'></i> ç”»åƒã‚¨ãƒ©ãƒ¼</div>'">
                        </div>
                        <div class="col-md-10">
                            <h6>${card.name}</h6>
                            <p class="mb-1"><strong>ã‚«ãƒ¼ãƒ‰ID:</strong> <code>${card.cid}</code></p>
                            ${card.encToken ? `<p class="mb-1"><strong>encãƒˆãƒ¼ã‚¯ãƒ³:</strong> <code>${card.encToken}</code></p>` : ''}
                            <p class="mb-1"><strong>ç”»åƒURL:</strong></p>
                            <input type="text" class="form-control form-control-sm" value="${card.imageUrl}" readonly onclick="this.select()">
                        </div>
                    </div>
                `;
                container.appendChild(cardDiv);
            });
        }

        // å®Ÿè£…ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
        function generateCode(cards) {
            const codeOutput = document.getElementById('code-output');

            const code = `
// éŠæˆ¯ç‹ã‚«ãƒ¼ãƒ‰ç”»åƒå–å¾—ã®å®Ÿè£…ï¼ˆencãƒˆãƒ¼ã‚¯ãƒ³å¯¾å¿œï¼‰

// ===== é‡è¦ãªç™ºè¦‹ =====
// 1. ç”»åƒURLã«ã¯2ç¨®é¡ã‚ã‚‹:
//    - get_image.action (encãƒˆãƒ¼ã‚¯ãƒ³å¿…é ˆã€ç¢ºå®Ÿã«å‹•ä½œ)
//    - card_image.action (encãªã—ã€ä¸€éƒ¨ã®ã‚«ãƒ¼ãƒ‰ã®ã¿å‹•ä½œ)
// 2. encãƒˆãƒ¼ã‚¯ãƒ³ã¯ã‚«ãƒ¼ãƒ‰ã”ã¨ã«ç•°ãªã‚‹
// 3. encãƒˆãƒ¼ã‚¯ãƒ³ã¯ã‚«ãƒ¼ãƒ‰è©³ç´°ãƒšãƒ¼ã‚¸ã‹ã‚‰å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹

// 1. ã‚«ãƒ¼ãƒ‰è©³ç´°ãƒšãƒ¼ã‚¸ã‹ã‚‰æƒ…å ±ã‚’å–å¾—
async function fetchCardDetail(cardId) {
    const detailUrl = \`https://www.db.yugioh-card.com/yugiohdb/card_search.action?ope=2&cid=\${cardId}\`;
    const proxyUrl = \`https://corsproxy.io/?\${encodeURIComponent(detailUrl)}\`;

    const response = await fetch(proxyUrl);
    const html = await response.text();

    // encãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŠ½å‡º
    const imageRegex = /get_image\\.action\\?type=2&cid=\\d+&ciid=1&enc=([a-zA-Z0-9_-]+)/;
    const match = html.match(imageRegex);

    if (match) {
        const encToken = match[1];
        return {
            cid: cardId,
            encToken: encToken,
            imageUrlWithEnc: \`https://www.db.yugioh-card.com/yugiohdb/get_image.action?type=2&cid=\${cardId}&ciid=1&enc=\${encToken}\`,
            imageUrl: \`https://www.db.yugioh-card.com/yugiohdb/card_image.action?cid=\${cardId}&request_locale=ja\`
        };
    }

    return null;
}

// 2. æ¤œç´¢çµæœãƒšãƒ¼ã‚¸ã‹ã‚‰ã‚«ãƒ¼ãƒ‰IDã‚’æŠ½å‡º
async function fetchCardIdsFromSearch(searchUrl) {
    const proxyUrl = \`https://corsproxy.io/?\${encodeURIComponent(searchUrl)}\`;
    const response = await fetch(proxyUrl);
    const html = await response.text();

    const cardIds = new Set();
    const regex = /cid=(\\d+)/g;
    let match;

    while ((match = regex.exec(html)) !== null) {
        cardIds.add(match[1]);
    }

    return Array.from(cardIds);
}

// 3. å®Œå…¨ãªå®Ÿè£…ä¾‹
async function getCardsWithImages(searchUrl) {
    // Step 1: æ¤œç´¢çµæœã‹ã‚‰ã‚«ãƒ¼ãƒ‰IDã‚’æŠ½å‡º
    const cardIds = await fetchCardIdsFromSearch(searchUrl);

    // Step 2: å„ã‚«ãƒ¼ãƒ‰ã®è©³ç´°æƒ…å ±ã‚’å–å¾—
    const cards = [];
    for (const cid of cardIds) {
        try {
            const cardDetail = await fetchCardDetail(cid);
            if (cardDetail) {
                cards.push(cardDetail);
            }
            // ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–: å°‘ã—å¾…ã¤
            await new Promise(resolve => setTimeout(resolve, 200));
        } catch (error) {
            console.error(\`Failed to fetch card \${cid}:\`, error);
        }
    }

    return cards;
}

// ä½¿ç”¨ä¾‹
const searchUrl = 'https://www.db.yugioh-card.com/yugiohdb/card_search.action?ope=1&sess=1&rp=10...';
const cards = await getCardsWithImages(searchUrl);
console.log(\`\${cards.length}æšã®ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’å–å¾—\`);

// å–å¾—ã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ (æœ€åˆã®3æš)
${JSON.stringify(cards.slice(0, 3), null, 2)}
`;

            codeOutput.textContent = code;
        }

        // åˆæœŸè¡¨ç¤º
        window.addEventListener('load', () => {
            testKnownCards();
        });
    </script>
</body>
</html>

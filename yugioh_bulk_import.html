<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŠæˆ¯ç‹ã‚«ãƒ¼ãƒ‰ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body { background: #f5f5f5; }
        .import-step {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .import-step.active {
            border-left: 4px solid #007bff;
        }
        .card-item {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: white;
        }
        .card-item:hover {
            background: #f8f9fa;
        }
        .progress-container {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 300px;
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }
        .progress-container.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1 class="mb-4">ğŸ“¦ éŠæˆ¯ç‹ã‚«ãƒ¼ãƒ‰ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h1>

        <!-- Progress tracker -->
        <div class="progress-container" id="progress-container">
            <h6 class="mb-3">ã‚¤ãƒ³ãƒãƒ¼ãƒˆé€²æ—</h6>
            <div class="progress mb-2" style="height: 20px;">
                <div class="progress-bar" id="progress-bar" role="progressbar" style="width: 0%">0%</div>
            </div>
            <small id="progress-text">æº–å‚™ä¸­...</small>
        </div>

        <!-- Step 1: URLå…¥åŠ› -->
        <div class="import-step active">
            <h4><span class="badge bg-primary">STEP 1</span> æ¤œç´¢URLã‚’å…¥åŠ›</h4>
            <p class="text-muted">éŠæˆ¯ç‹å…¬å¼DBã§æ¤œç´¢ã—ãŸçµæœãƒšãƒ¼ã‚¸ã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>

            <div class="mb-3">
                <label class="form-label">æ¤œç´¢çµæœURL</label>
                <input type="text" class="form-control" id="search-url"
                       placeholder="https://www.db.yugioh-card.com/yugiohdb/card_search.action?...">
            </div>

            <div class="mb-3">
                <label class="form-label">ã‚¯ã‚¤ãƒƒã‚¯æ¤œç´¢</label>
                <div class="btn-group-vertical d-block">
                    <button class="btn btn-outline-secondary btn-sm mb-1" onclick="loadQuickSearch('recent')">
                        æœ€æ–°ã‚«ãƒ¼ãƒ‰ (1999å¹´ä»¥é™)
                    </button>
                    <button class="btn btn-outline-secondary btn-sm mb-1" onclick="loadQuickSearch('monsters')">
                        ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚«ãƒ¼ãƒ‰ã®ã¿
                    </button>
                    <button class="btn btn-outline-secondary btn-sm mb-1" onclick="loadQuickSearch('spells')">
                        é­”æ³•ã‚«ãƒ¼ãƒ‰ã®ã¿
                    </button>
                    <button class="btn btn-outline-secondary btn-sm mb-1" onclick="loadQuickSearch('traps')">
                        ç½ ã‚«ãƒ¼ãƒ‰ã®ã¿
                    </button>
                </div>
            </div>

            <button class="btn btn-primary btn-lg" onclick="fetchCardsFromURL()">
                <i class="bi bi-download"></i> ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’å–å¾—
            </button>
        </div>

        <!-- Step 2: ã‚«ãƒ¼ãƒ‰é¸æŠ -->
        <div class="import-step" id="step2" style="display: none;">
            <h4><span class="badge bg-primary">STEP 2</span> ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠ</h4>
            <p class="text-muted">æ¤œå‡ºã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰: <strong id="detected-count">0</strong>æš</p>

            <div class="mb-3">
                <button class="btn btn-sm btn-outline-primary" onclick="selectAllCards()">
                    <i class="bi bi-check-square"></i> å…¨ã¦é¸æŠ
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="deselectAllCards()">
                    <i class="bi bi-square"></i> å…¨ã¦è§£é™¤
                </button>
            </div>

            <div id="cards-list" style="max-height: 400px; overflow-y: auto;"></div>

            <div class="mt-3">
                <button class="btn btn-success btn-lg" onclick="importSelectedCards()">
                    <i class="bi bi-upload"></i> é¸æŠã—ãŸã‚«ãƒ¼ãƒ‰ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                </button>
            </div>
        </div>

        <!-- Step 3: ã‚¤ãƒ³ãƒãƒ¼ãƒˆçµæœ -->
        <div class="import-step" id="step3" style="display: none;">
            <h4><span class="badge bg-success">å®Œäº†</span> ã‚¤ãƒ³ãƒãƒ¼ãƒˆçµæœ</h4>
            <div id="import-results"></div>
            <button class="btn btn-primary mt-3" onclick="window.location.href='card_list.html'">
                <i class="bi bi-arrow-left"></i> ã‚«ãƒ¼ãƒ‰ä¸€è¦§ã«æˆ»ã‚‹
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAOYKalLUb2hbghrjQUS8AWzxpLExBT7aU",
            authDomain: "ygoh-9bcf6.firebaseapp.com",
            projectId: "ygoh-9bcf6",
            storageBucket: "ygoh-9bcf6.firebasestorage.app",
            messagingSenderId: "515041224138",
            appId: "1:515041224138:web:8de47b38ed9cc1bb8afd37"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let detectedCards = [];
        let cardDetailsMap = new Map();

        // Load card master data
        async function loadCardMasterData() {
            try {
                const response = await fetch('yugioh_cards_master.csv');
                const csvText = await response.text();
                const lines = csvText.split('\\n');

                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    const values = line.split(',');
                    const cardId = values[0]?.replace(/"/g, '');
                    const cardName = values[1]?.replace(/"/g, '');

                    if (cardId && cardName) {
                        cardDetailsMap.set(cardId, {
                            name: cardName,
                            reading: values[2]?.replace(/"/g, ''),
                            cardType: values[3]?.replace(/"/g, ''),
                            level: values[4]?.replace(/"/g, ''),
                            attribute: values[5]?.replace(/"/g, ''),
                            race: values[6]?.replace(/"/g, '')
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading master data:', error);
            }
        }

        // Quick search templates
        window.loadQuickSearch = (type) => {
            const baseUrl = 'https://www.db.yugioh-card.com/yugiohdb/card_search.action?ope=1&sess=1&rp=100&sort=1';
            let url = baseUrl;

            switch (type) {
                case 'recent':
                    url += '&releaseDStart=1&releaseMStart=1&releaseYStart=1999';
                    break;
                case 'monsters':
                    url += '&ctype=1';
                    break;
                case 'spells':
                    url += '&ctype=2';
                    break;
                case 'traps':
                    url += '&ctype=3';
                    break;
            }

            document.getElementById('search-url').value = url;
        };

        // Fetch cards from URL
        window.fetchCardsFromURL = async () => {
            const url = document.getElementById('search-url').value;
            if (!url) {
                alert('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');

            progressContainer.classList.add('active');
            progressText.textContent = 'ãƒšãƒ¼ã‚¸ã‚’å–å¾—ä¸­...';
            progressBar.style.width = '30%';
            progressBar.textContent = '30%';

            try {
                const proxyUrl = \`https://corsproxy.io/?\${encodeURIComponent(url)}\`;
                const response = await fetch(proxyUrl);
                const html = await response.text();

                progressText.textContent = 'ã‚«ãƒ¼ãƒ‰IDã‚’æŠ½å‡ºä¸­...';
                progressBar.style.width = '60%';
                progressBar.textContent = '60%';

                // Extract card IDs
                const cards = extractCardIds(html);

                progressText.textContent = 'ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’ç…§åˆä¸­...';
                progressBar.style.width = '90%';
                progressBar.textContent = '90%';

                // Match with master data
                detectedCards = cards.map(card => {
                    const details = cardDetailsMap.get(card.cid);
                    return {
                        cid: card.cid,
                        name: details?.name || \`ã‚«ãƒ¼ãƒ‰ID: \${card.cid}\`,
                        cardType: details?.cardType || '',
                        selected: true
                    };
                });

                document.getElementById('detected-count').textContent = detectedCards.length;
                displayCardsList();

                document.getElementById('step2').style.display = 'block';
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';
                progressText.textContent = \`\${detectedCards.length}æšã®ã‚«ãƒ¼ãƒ‰ã‚’æ¤œå‡ºã—ã¾ã—ãŸ\`;

                setTimeout(() => {
                    progressContainer.classList.remove('active');
                }, 2000);

            } catch (error) {
                alert(\`ã‚¨ãƒ©ãƒ¼: \${error.message}\`);
                progressContainer.classList.remove('active');
            }
        };

        function extractCardIds(html) {
            const cards = [];
            const imageUrlRegex = /(?:get_image|card_image)\\.action\\?[^'"]*cid=(\\d+)/g;
            const foundCids = new Set();
            let match;

            while ((match = imageUrlRegex.exec(html)) !== null) {
                const cid = match[1];
                if (!foundCids.has(cid)) {
                    foundCids.add(cid);
                    cards.push({ cid });
                }
            }

            return cards;
        }

        function displayCardsList() {
            const container = document.getElementById('cards-list');
            container.innerHTML = detectedCards.map((card, index) => \`
                <div class="card-item">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="card-\${index}"
                               \${card.selected ? 'checked' : ''}
                               onchange="toggleCard(\${index})">
                        <label class="form-check-label" for="card-\${index}">
                            <strong>\${card.name}</strong>
                            <small class="text-muted ms-2">CID: \${card.cid}</small>
                            \${card.cardType ? \`<span class="badge bg-secondary ms-2">\${card.cardType}</span>\` : ''}
                        </label>
                    </div>
                </div>
            \`).join('');
        }

        window.toggleCard = (index) => {
            detectedCards[index].selected = !detectedCards[index].selected;
        };

        window.selectAllCards = () => {
            detectedCards.forEach(card => card.selected = true);
            displayCardsList();
        };

        window.deselectAllCards = () => {
            detectedCards.forEach(card => card.selected = false);
            displayCardsList();
        };

        window.importSelectedCards = async () => {
            if (!currentUser) {
                alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
                return;
            }

            const selectedCards = detectedCards.filter(card => card.selected);
            if (selectedCards.length === 0) {
                alert('ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');

            progressContainer.classList.add('active');

            const results = { success: 0, failed: 0, errors: [] };

            for (let i = 0; i < selectedCards.length; i++) {
                const card = selectedCards[i];
                const progress = ((i + 1) / selectedCards.length * 100).toFixed(0);

                progressBar.style.width = progress + '%';
                progressBar.textContent = progress + '%';
                progressText.textContent = \`\${i + 1}/\${selectedCards.length} ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...\`;

                try {
                    const collectionRef = collection(db, 'users', currentUser.uid, 'cards');
                    await addDoc(collectionRef, {
                        'åå‰': card.name,
                        'å‹ç•ª': '',
                        'ãƒ¬ã‚¢ãƒªãƒ†ã‚£': '',
                        'æšæ•°': '1',
                        'tags': []
                    });
                    results.success++;
                } catch (error) {
                    results.failed++;
                    results.errors.push(\`\${card.name}: \${error.message}\`);
                }

                await new Promise(resolve => setTimeout(resolve, 100));
            }

            progressContainer.classList.remove('active');

            const resultsDiv = document.getElementById('import-results');
            resultsDiv.innerHTML = \`
                <div class="alert alert-success">
                    <h5>âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†</h5>
                    <p>æˆåŠŸ: <strong>\${results.success}</strong>æš</p>
                    \${results.failed > 0 ? \`<p>å¤±æ•—: <strong>\${results.failed}</strong>æš</p>\` : ''}
                </div>
            \`;

            document.getElementById('step3').style.display = 'block';
        };

        // Initialize
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadCardMasterData();
            } else {
                alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
                window.location.href = 'card_list.html';
            }
        });
    </script>
</body>
</html>
